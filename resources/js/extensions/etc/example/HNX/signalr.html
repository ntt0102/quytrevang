<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
    </head>
    <body>
        <h1>Get datafeed of HNX</h1>
        <script>
            function loadPage() {
                let connectionData = JSON.stringify([{ name: "pushhub" }]);
                let negotiations = fetch(
                    `https://banggia.hnx.vn/signalr/negotiate?clientProtocol=1.5&connectionData=${connectionData}`
                )
                    .then(res => res.json())
                    .then(json => {
                        let token = encodeURIComponent(json.ConnectionToken);
                        var sourceUri = `https://banggia.hnx.vn/signalr/connect?transport=serverSentEvents&clientProtocol=1.5&connectionToken=${token}&connectionData=${connectionData}`;
                        var source = new EventSource(sourceUri);
                        source.onmessage = function(e) {
                            if (e.lastEventId === "close") source.close();
                            else {
                                try {
                                    var data = JSON.parse(e.data);
                                    // console.log(data);
                                    if (data.M) {
                                        data.M.forEach(i1 => {
                                            if (i1.M == "marketInfoUpdate") {
                                                // console.log(i1.A[0]);
                                                i1.A[0].forEach(i2 => {
                                                    // console.log(i2.Msg);
                                                    if (
                                                        i2.Msg.includes(
                                                            "VN30F2302"
                                                        )
                                                    ) {
                                                        console.log(i2.Msg);
                                                    }
                                                });
                                            }
                                            // // console.log(item);
                                            // switch (item.M) {
                                            //     case "updateTopStock":
                                            //         // console.log(
                                            //         //     "updateTopStock",
                                            //         //     item.A[0]
                                            //         // );
                                            //         var stocks = item.A[0].Msg.split(
                                            //             ":"
                                            //         );
                                            //         stocks.forEach(stock => {
                                            //             var infos = stock.split(
                                            //                 "$"
                                            //             );
                                            //             var arrFinal = new Array();
                                            //             infos.forEach(info => {
                                            //                 arrFinal.push(info);
                                            //             });
                                            //         });
                                            //         break;
                                            //     case "updateOdersDeal":
                                            //         // console.log(
                                            //         //     "updateOdersDeal",
                                            //         //     item.A[0]
                                            //         // );
                                            //         break;
                                            //     case "marketInfoUpdate":
                                            //         // console.log(
                                            //         //     "marketInfoUpdate",
                                            //         //     item.A
                                            //         // );
                                            //         break;
                                            // }
                                        });
                                    }
                                } catch (err) {
                                    console.log(err.message);
                                }
                            }
                        };
                    });
            }
            window.addEventListener("load", loadPage, false);
        </script>
    </body>
</html>
