import{A as nt,B as st,C as rt,r as B,y as Me,E as qe,o as z,b as j,d as F,G as le,c as ae,H as xe,I as Ce,J as ot,K as at,F as Fe,L as Ve,t as Te,h as ve,u as Pe,e as te,g as Ue,k as me,w as fe,M as ct,m as lt,N as pt,z as Xe,x as se,l as Oe,a as dt,O as ut,Q as ft,j as mt,R as vt}from"./app-be6150b8.js";import{_ as ht}from"./button-group-9e27b21b.js";import{_ as gt}from"./text-box-7feaaa91.js";import{g as Q}from"./getUnixTime-b6dac4fe.js";import{c as St}from"./lightweight-charts.esm.development-03366bac.js";function Qe(A,I,T){return nt((T==null?void 0:T.in)||A,+st(A)+I)}function ke(A,I,T){return Qe(A,I*rt,T)}function yt(A,I,T){return Qe(A,I*1e3,T)}function Tt(A,I,T){return yt(A,-I,T)}const xt=["title"],kt={__name:"FullscreenTool",props:["chartContainerRef"],setup(A){const I=A,T=B(!1);Me(()=>{document.addEventListener("fullscreenchange",t)}),qe(()=>{document.removeEventListener("fullscreenchange",t)});function f(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function t(){I.chartContainerRef&&(document.fullscreenElement?(T.value=!0,I.chartContainerRef.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(T.value=!1,I.chartContainerRef.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}return(s,y)=>(z(),j("div",{class:"command",title:s.$t("trading.derivative.fullscreen"),onClick:f},[F("i",{class:le(["far",{"fa-compress":T.value,"fa-expand":!T.value}])},null,2)],8,xt))}},Ct=["title"],_t=["src"],wt={__name:"TradingviewTool",props:["vpsUser","vpsSession","chartContainerRef"],setup(A){const I=A,T=B(null),f=B(!1),t=ae(()=>`https://chart.vps.com.vn/tv/?u=${I.vpsUser}&s=${I.vpsSession}&symbol=VN30F1M&resolution=1&lang=vi`);function s(k){f.value=!f.value,y(),k.stopPropagation()}function y(){if(I.chartContainerRef&&T.value){const{offsetWidth:k,offsetHeight:P}=I.chartContainerRef,{top:d,left:h}=T.value.getBoundingClientRect();T.value.style.top=`${d-2}px`,T.value.style.left=`${h+32}px`,T.value.style.width=`${k-34}px`,T.value.style.height=`${P}px`}}return(k,P)=>(z(),j("div",{class:"tradingview command far fa-chart-candlestick",title:k.$t("trading.derivative.tradingview"),onClick:s},[xe(F("iframe",{ref_key:"tradingviewRef",ref:T,class:"chart",src:t.value},null,8,_t),[[Ce,f.value]])],8,Ct))}};const Rt=F("div",{class:"triangle-shadow"},null,-1),Dt=F("div",{class:"triangle"},null,-1),bt={class:"container"},Et={class:"conditions"},Lt={__name:"ProgressContext",props:["progress"],setup(A){const I=B([]);Me(()=>{T()});function T(){ot(Object.assign({"../../../../../lang/vi/derivative.js":()=>at(()=>import("./derivative-7a854992.js"),[])}),`../../../../../lang/${window.lang}/derivative.js`).then(t=>{I.value=t.default||[]})}function f(t){t.stopPropagation()}return(t,s)=>(z(),j("div",{class:"pattern-context",onClick:f},[Rt,Dt,F("div",bt,[(z(!0),j(Fe,null,Ve(I.value,(y,k)=>(z(),j("div",{key:k,class:le(["step"])},[F("div",{class:le(["step-header",[A.progress.steps?A.progress.steps[k].every(Boolean)?"success":"fail":""]])},Te(k+1)+". "+Te(y.name),3),F("div",Et,[(z(!0),j(Fe,null,Ve(y.conds,(P,d)=>(z(),j("div",{key:d,class:le(["condition",[A.progress.steps?A.progress.steps[k][d]?"success":"fail":""]])},Te(d+1)+". "+Te(P),3))),128))])]))),128))])]))}},Ot=["title"],Pt={__name:"ProgressTool",emits:["refreshPattern","hideContext"],setup(A,{expose:I,emit:T}){const f=ve(),{t}=Pe(),s=T,y=B({}),k=B(!1),P=ae(()=>f.state.tradingDerivative.config.autoRefresh);I({hide:h,set:u});function d(){const b=k.value;s("hideContext"),k.value=!b,k.value&&s("refreshPattern")}function h(b){k.value=b}function u(b){W(b,y.value),y.value=b}function M(b){const R=b??!R.value;f.dispatch("tradingDerivative/setAutoRefresh",R)}function W(b,R){if(P.value&&(b.step>R.step||b.step===R.step&&b.result>R.result)){let g="";b.result?[2,4].includes(b.step)?g=t("trading.derivative.progressOrder",b):g=t("trading.derivative.progressSuccess",b):g=t("trading.derivative.progressFail",b),Z(g)}}function Z(b){const R=new SpeechSynthesisUtterance(b);R.lang="vi-VN",speechSynthesis.speak(R)}return(b,R)=>(z(),j("div",{class:le(["context command",{green:y.value.result===!0,red:y.value.result===!1}]),title:b.$t("trading.derivative.progressTool"),onClick:d,onContextmenu:M},[F("i",{class:le(["far",{"fa-badge-check":!y.value.step,[`fa-circle-${y.value.step}`]:y.value.step,blink:P.value}])},null,2),xe(te(Lt,{class:"contextmenu",progress:y.value},null,8,["progress"]),[[Ce,k.value]])],42,Ot))}};const $t=F("div",{class:"triangle-shadow"},null,-1),It=F("div",{class:"triangle"},null,-1),Nt={__name:"ScanContext",props:["modelValue"],emits:["update:modelValue"],setup(A,{emit:I}){const{t:T}=Pe(),f=[{icon:"chevrondoubleleft",side:"left",text:T("trading.derivative.scanContext.leftScan")},{icon:"chevrondoubleright",side:"right",text:T("trading.derivative.scanContext.rightScan")}],t=A,s=I;function y({itemData:{side:P}}){s("update:modelValue",P)}function k(P){P.stopPropagation()}return(P,d)=>(z(),j("div",{class:"scan-context",onClick:k},[$t,It,te(Ue(ht),{items:f,"selected-item-keys":[t.modelValue],"key-expr":"side","styling-mode":"outlined",onItemClick:y},null,8,["selected-item-keys"])]))}},At=["title"],Bt={__name:"ScanTool",props:["prices","timeToIndex"],emits:["scaned","removePattern","hideContext"],setup(A,{expose:I,emit:T}){const f=me("mf"),t=A,s=T,y=B(null),k=B(!1),P=B("left");I({isSelected:d,hide:h,draw:W});function d(){return y.value.classList.contains("selected")}function h(g){k.value=g}function u(g){s("hideContext");const l=g.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(S=>S.classList.remove("selected")),l||(g.target.classList.add("selected"),s("removePattern"))}function M(){const g=k.value;s("hideContext"),k.value=!g}function W({time:g}){const l=P.value==="left",S=g?t.prices.filter(o=>!f.cmp(o.time,l,g)):t.prices;let i=l?Z(S):b(S);f.isSet(i)&&s("scaned",R(i)),y.value.classList.remove("selected")}function Z(g){let l,[S,i,o,v]=Array(4).fill({});for(let m=g.length-1;m>=0;m--){const _=g[m].value,x=g[m].time,e=t.timeToIndex(x);if(e===-1)break;if(m===g.length-1&&(o={index:e,time:x,price:_},[i,S,v]=Array(3).fill(null).map(()=>f.cloneDeep(o))),l===void 0){if(_===o.price)continue;l=_>o.price}if(f.cmp(_,l,i.price)&&(f.cmp(S.price,!l,o.price)?([o,i]=[i,S].map(p=>f.cloneDeep(p)),S={index:e,time:x,price:_},v=f.cloneDeep(S),l=!l):i={index:e,time:x,price:_}),f.cmp(_,!l,S.price)?(S={index:e,time:x,price:_},v=f.cloneDeep(S)):v.index=e,f.cmp(_,l,v.price)&&(v={index:e,time:x,price:_}),o.index>S.index){const p=f.fmtNum(i.price-o.price,1,!0);if(p>=1.5&&(S.index-v.index>o.index-i.index||f.fmtNum(S.price-v.price,1,!0)>p))break}}return{A:S,B:i,C:o}}function b(g){let l,[S,i,o]=Array(3).fill({});for(let v=0;v<g.length;v++){const m=g[v].value,_=g[v].time,x=t.timeToIndex(_);if(x===-1)break;if(v===0&&(S={index:x,time:_,price:m},i=f.cloneDeep(S),o=f.cloneDeep(S)),l===void 0){if(m===S.price)continue;l=m>S.price}f.cmp(m,l,i.price)&&(i={index:x,time:_,price:m},o=f.cloneDeep(i)),f.cmp(i.price,l,S.price)&&f.cmp(m,!l,o.price)&&(f.cmp(m,l,S.price)?o={index:x,time:_,price:m}:(S=f.cloneDeep(i),i={index:x,time:_,price:m},o=f.cloneDeep(i),l=!l))}return{A:S,B:i,C:o}}function R(g){const l={};return Object.entries(g).forEach(([S,i])=>{const{index:o,...v}=i;l[S]=v}),l}return(g,l)=>(z(),j("div",{ref_key:"scanToolRef",ref:y,class:"context command",title:g.$t("trading.derivative.scanTool"),onClick:u,onContextmenu:M},[F("i",{class:le(["far",{[`fa-angles-${P.value}`]:!0}])},null,2),xe(te(Nt,{class:"contextmenu",modelValue:P.value,"onUpdate:modelValue":l[0]||(l[0]=S=>P.value=S)},null,8,["modelValue"]),[[Ce,k.value]])],40,At))}},Ft=["title"],Vt=F("i",{class:"far fa-heart-rate"},null,-1),Mt=[Vt],Wt={__name:"PatternTool",props:["prices","priceSeries","timeMarkSeries","pickTimeToolRef","timeToIndex","indexToTime"],emits:["setProgress","hideContext"],setup(A,{expose:I,emit:T}){const f=ve(),t=me("mf"),s=A,y=T,k=B(null),P=ae(()=>f.state.tradingDerivative.tools.pattern);let d={},h={};I({isSelected:u,draw:Z,load:b,refresh:g,remove:_,drag:p}),fe(P,r=>{r&&b(r,{isCheck:!0})});function u(){return k.value.classList.contains("selected")}function M(r){y("hideContext");const n=r.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(C=>C.classList.remove("selected")),n||(r.target.classList.add("selected"),s.pickTimeToolRef.remove())}function W(r){r.target.classList.remove("selected"),_()}function Z({time:r,price:n}){let a={lineType:"pattern",price:n,lineWidth:1,lineStyle:1,draggable:!0};if(t.isSet(h.A))if(t.isSet(h.B)){let N,E;if(t.isSet(h.C)){let L,w;d.A={time:r,price:n};const{progress:$,timeMark:V,info:{rEpr1:H,rEpr2:U,rEpr3:ie,entry:ne,pStatus:G,x:re,X:J,y:ee,Y}}=l();E=$,N=V,L="A",w={price:n,title:`A ${H}`},h[L].applyOptions(w),L="B",w={title:`B ${U}`},h[L].applyOptions(w),L="C",w={title:`C ${ie}`},h[L].applyOptions(w),L="D",w={price:ne,title:"Entry "+G},h[L].applyOptions(w),L="X",w={price:t.fmtNum(re),title:`X ${t.fmtNum(J)}`},h[L].applyOptions(w),L="Y",w={price:t.fmtNum(ee),title:`Y ${t.fmtNum(Y)}`},h[L].applyOptions(w)}else{d.C={price:n};const{progress:L,timeMark:w,info:{rEpr1:$,rEpr2:V,rEpr3:H,entry:U,pStatus:ie,x:ne,X:G,y:re,Y:J}}=l();E=L,N=w;let ee="A";h[ee].applyOptions({title:`A ${$}`}),ee="B",h[ee].applyOptions({title:`B ${V}`}),a.point="C",a.title=`C ${H}`,a.color="#FFEB3B",h[a.point]=s.priceSeries.createPriceLine(a),a.point="D",a.price=U,a.title="Entry "+ie,a.color="#9C27B0",a.draggable=!1,h[a.point]=s.priceSeries.createPriceLine(a),a.point="Y",a.price=t.fmtNum(re),a.title=`Y ${t.fmtNum(J)}`,a.color="#E91E63",a.draggable=!1,h[a.point]=s.priceSeries.createPriceLine(a),a.point="X",a.price=t.fmtNum(ne),a.title=`X ${t.fmtNum(G)}`,a.color="#2196F3",a.draggable=!1,h[a.point]=s.priceSeries.createPriceLine(a)}m(),y("setProgress",E),e(N),k.value.classList.remove("selected")}else a.point="B",a.title="B 0",a.color="#4CAF50",h[a.point]=s.priceSeries.createPriceLine(a),d.B={price:n};else a.point="A",a.title="A 0",a.color="#F44336",h[a.point]=s.priceSeries.createPriceLine(a),d={A:{time:r,price:n}}}function b(r,{isSave:n=!1,isCheck:C=!1}){d=t.cloneDeep(r),n&&m(),(C?i(d):!0)&&(x(),R())}function R(){let n={lineType:"pattern",lineWidth:1,lineStyle:1,draggable:!0};const{A:C,B:a,C:N}=d,{progress:E,timeMark:L,info:{rEpr1:w,rEpr2:$,rEpr3:V,entry:H,pStatus:U,x:ie,X:ne,y:G,Y:re}}=l();y("setProgress",E),e(L),n.point="A",n.title=`A ${w}`,n.color="#F44336",n.price=C.price,h[n.point]=s.priceSeries.createPriceLine(n),n.point="B",n.title=`B ${$}`,n.color="#4CAF50",n.price=a.price,h[n.point]=s.priceSeries.createPriceLine(n),n.point="C",n.price=N.price,n.title=`C ${V}`,n.color="#FFEB3B",h[n.point]=s.priceSeries.createPriceLine(n),n.point="D",n.price=H,n.title="Entry "+U,n.color="#9C27B0",n.draggable=!1,h[n.point]=s.priceSeries.createPriceLine(n),n.point="Y",n.price=t.fmtNum(G),n.title=`Y ${t.fmtNum(re)}`,n.color="#E91E63",n.draggable=!1,h[n.point]=s.priceSeries.createPriceLine(n),n.point="X",n.price=t.fmtNum(ie),n.title=`X ${t.fmtNum(ne)}`,n.color="#2196F3",n.draggable=!1,h[n.point]=s.priceSeries.createPriceLine(n)}function g(r=!1){t.isSet(h.C)&&(r&&v(),x(),R())}function l(){const{A:r,B:n,C}=d,a=n.price-C.price,N=a>0,E=S({phase:1,start:r,end:n,retracementPrice:C.price});let L=S({phase:2,start:E.R,end:C});const w=S({phase:3,start:L.R,end:{price:n.price+(N?1:-1)*E.rEp},breakPrices:[L.S1.price,n.price]});E.xBox.tr>=L.tr&&(L.tr=E.xBox.tr),console.log("calculatePattern",[E,L,w]);const $=t.fmtNum(a,1,!0)>=E.pr,V=t.fmtNum(C.price-w.xBox.R.price,1,!0)>=L.pr,H=t.fmtNum(w.xBox.pr)>=w.pr,U=!t.cmp(C.price,!N,E.S1.price),ie=!t.cmp(w.xBox.R.price,N,L.S1.price),ne=!t.cmp(w.xBox.S.price,!N,w.S1.price),G=E.R.index+E.tr,re=E.R.index+5*E.tr,J=L.R.index+L.tr,ee=w.xBox.R.index+w.tr,Y=w.xBox.R.index+5*w.tr,oe=w.xBox.R.index+L.tr,he=[G,re,J,ee,Y,oe],ce=w.xBox.S.index;let ge,q={};const _e=[L.R.index>G,E.rEpr<3,L.rEpr<E.rEpr];q.steps=[[$||E.rEt<E.tr&&E.rEp>=E.sEp,U,!w.breakIndexs[1]||G<w.breakIndexs[1],ce>G,ce<re],[..._e,J>G,ce<Y,ce<J],[L.R.index-E.R.index>.5*E.tr,V,ce>J],[H,ne,ce>ee,_e.every(Boolean)||ce>oe]],q.step=1,q.result=q.steps[0].every(Boolean),ge=E.R1.price,q.result&&(ce<=J?(q.step=2,q.result=q.steps[1].every(Boolean),ge=L.S1.price):(q.step=3,q.result=q.steps[2].every(Boolean),ge=w.R1.price,q.result&&(q.step=4,q.result=q.steps[3].every(Boolean),q.result&&(ge=w.xBox.R.price))));const pe=`${U?$?1:0:2}${ie?V?1:0:2}${ne?H?1:0:2}`,ye=E.rEp,we=o(n.price,ye,N),Ie=w.breakIndexs[1]??ce,Re=parseInt((Ie-E.R.index)/E.tr),De=Re>1?ye*Re:ye,Ne=o(n.price,De,N);return{progress:q,timeMark:he,info:{rEpr1:E.rEpr,rEpr2:L.rEpr,rEpr3:w.rEpr,entry:ge,pStatus:pe,x:we,X:ye,y:Ne,Y:De}}}function S({phase:r,start:n,end:C,breakPrices:a,retracementPrice:N}){let E=t.cloneDeep(n),L=t.cloneDeep(C);const w=L.price>E.price;let $={},V={},H={},U=[null,null],ie,ne,G;const re=s.pickTimeToolRef.get();return s.prices.filter(J=>{let ee=J.time>=E.time;return re&&(ee&=J.time<=re),ee}).every((J,ee)=>{const Y=J.value,oe=s.timeToIndex(J.time);return oe===-1?!1:((ee===0||Y===E.price)&&($={R:{index:oe,price:Y},S:{index:oe,price:Y},pr:0,tr:0},V=t.cloneDeep($),H=t.cloneDeep($)),t.cmp(Y,w,$.R.price)?($.pr>=V.pr&&(V.pr=$.pr,V.R=t.cloneDeep($.R),V.S=t.cloneDeep($.S)),$.tr>V.tr&&(V.tr=$.tr),r===1&&N&&!t.cmp($.S.price,!w,N)&&$.tr>=H.tr&&$.pr>=H.pr&&(H=t.cloneDeep($)),$={R:{index:oe,price:Y},S:{index:oe,price:Y},pr:0,tr:0},r===3&&a&&(!U[0]&&t.cmp(Y,w,a[0])&&(U[0]=oe),!U[1]&&t.cmp(Y,w,a[1])&&(U[1]=oe))):($.S.index=oe,$.tr=$.S.index-$.R.index,t.cmp(Y,!w,$.S.price)&&($.S.price=Y,$.pr=t.fmtNum($.S.price-$.R.price,1,!0))),t.cmp(Y,!w,E.price)?($.S.price=E.price,!1):!!t.cmp(Y,!w,L.price))}),t.isSet($)&&(E.index=s.timeToIndex(E.time),L.index=$.S.index,L.time=s.indexToTime($.S.index),ie=t.fmtNum(L.price-V.R.price,1,!0),ne=t.fmtNum(E.price-V.S.price,1,!0),G=L.index-V.S.index,r===3&&(H=$)),{tr:V.tr,pr:V.pr,rEp:ie,sEp:ne,rEpr:V.pr?t.fmtNum(ie/V.pr):0,rEt:G,S1:V.S,R1:V.R,xBox:H,S:E,R:L,breakIndexs:U}}function i({A:{time:r}}){return r>=s.prices[0].time&&r<s.prices.at(-1).time}function o(r,n,C){const a=r+(C?1:-1)*n;let N=t.fmtNum(a%1);if(C){if(N>=.1&&N<=.2)return Math.floor(a);if(N>=.6&&N<=.7)return Math.floor(a)+.5}else{if(N>=.8&&N<=.9)return Math.ceil(a);if(N>=.3&&N<=.4)return Math.floor(a)+.5}return a}function v(){if(!s.pickTime)return!1;const r=d.B.price-d.A.price>0,n=s.prices.at(-1).value;if(t.cmp(n,!r,d.C.price)){let C=n;for(let a=s.prices.length-1;a>=0;a--){const N=s.prices[a].value;if(N===d.B.price)break;C=r?Math.min(C,N):Math.max(C,N)}d.C.price=C,m()}}function m(r=!1){let n={isRemove:r,name:"pattern",points:[],data:[]};r?d={}:Object.entries(d).forEach(([C,a])=>{n.points.push(C),n.data.push(a)}),f.dispatch("tradingDerivative/drawTools",n)}function _(){m(!0),s.pickTimeToolRef.remove(),x(),y("setProgress",{})}function x(){t.isSet(h.A)&&(s.priceSeries.removePriceLine(h.A),t.isSet(h.B)&&(s.priceSeries.removePriceLine(h.B),t.isSet(h.C)&&(s.priceSeries.removePriceLine(h.C),s.priceSeries.removePriceLine(h.D),s.priceSeries.removePriceLine(h.X),s.priceSeries.removePriceLine(h.Y)))),h={},e([])}function e(r){const n=["#F44336","#F44336","#4CAF50","#FFEB3B","#FFEB3B","#2196F3"];let C=[];for(let a=0;a<r.length;a++){let N=s.indexToTime(r[a]);N&&(r.indexOf(r[a])!==r.lastIndexOf(r[a])&&(N+=a),C.push({time:N,value:1,color:n[a]}))}C.length&&C.sort((a,N)=>a.time-N.time),s.timeMarkSeries.setData(C)}function p({lineOptions:r}){if(t.isSet(h.C)){let n,C;d={A:{time:d.A.time,price:+h.A.options().price},B:{price:+h.B.options().price},C:{price:+h.C.options().price}},m();const{progress:a,timeMark:N,info:{rEpr1:E,rEpr2:L,rEpr3:w,entry:$,pStatus:V,x:H,X:U,y:ie,Y:ne}}=l();y("setProgress",a),e(N),n="A",C={title:`A ${E}`},h[n].applyOptions(C),n="B",C={title:`B ${L}`},h[n].applyOptions(C),n="C",C={title:`C ${w}`},h[n].applyOptions(C),n="D",C={price:$,title:"Entry "+V},r.point===n&&delete C.price,h[n].applyOptions(C),n="X",C={price:t.fmtNum(H),title:`X ${t.fmtNum(U)}`},h[n].applyOptions(C),n="Y",C={price:t.fmtNum(ie),title:`Y ${t.fmtNum(ne)}`},h[n].applyOptions(C)}}return(r,n)=>(z(),j("div",{ref_key:"patternToolRef",ref:k,class:"command",title:r.$t("trading.derivative.patternTool"),onClick:M,onContextmenu:W},Mt,40,Ft))}},Zt=["title"],Yt=F("i",{class:"far fa-pipe"},null,-1),Ht=[Yt],Jt={__name:"PickTimeTool",props:["pickTimeSeries"],emits:["refreshPattern","hideContext"],setup(A,{expose:I,emit:T}){const f=ve(),t=A,s=T,y=B(null),k=ae(()=>f.state.tradingDerivative.tools.pickTime);let P=null;I({isSelected:d,draw:W,remove:b,get:h}),fe(k,R=>{R&&Z(R[0])});function d(){return y.value.classList.contains("selected")}function h(){return P}function u(R){s("hideContext");const g=R.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(l=>l.classList.remove("selected")),g||R.target.classList.add("selected")}function M(R){R.target.classList.remove("selected"),b(),s("refreshPattern")}function W({time:R}){f.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"pickTime",points:[0],data:[R]}),Z(R),s("refreshPattern"),y.value.classList.remove("selected")}function Z(R){P=R,t.pickTimeSeries.setData([{time:R,value:1,color:"#9C27B0"}])}function b(R=!0){R&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"pickTime"}),t.pickTimeSeries.setData([]),P=null}return(R,g)=>(z(),j("div",{ref_key:"pickTimeToolRef",ref:y,class:"command",title:R.$t("trading.derivative.pickTimeTool"),onClick:u,onContextmenu:M},Ht,40,Zt))}};const Xt=F("div",{class:"triangle-shadow"},null,-1),zt=F("div",{class:"triangle"},null,-1),jt={class:"input"},qt={class:"color"},Ut=["onClick"],Qt={__name:"LineContext",props:["enable","title","color"],emits:["update:title","update:color"],setup(A,{emit:I}){const T=A,f=I,t=B(null),s=B(["#F44336","#FF9800","#FFEB3B","#4CAF50","#009688","#00BCD4","#2196F3","#673AB7","#9C27B0","#E91E63"]);fe(()=>T.enable,h=>{h&&ct().then(()=>t.value.instance.focus())});function y({value:h}){f("update:title",h)}function k(h){f("update:color",h)}function P(){f("deleteAllLine")}function d(h){h.stopPropagation()}return(h,u)=>{const M=lt("DxButton");return z(),j("div",{class:"line-context",onClick:d},[Xt,zt,F("div",jt,[te(Ue(gt),{ref_key:"titleRef",ref:t,value:T.title,"show-clear-button":!0,"input-attr":{style:`color:${T.color}`},onValueChanged:y},null,8,["value","input-attr"]),te(M,{icon:"trash",type:"danger",onClick:u[0]||(u[0]=W=>P())})]),F("div",qt,[(z(!0),j(Fe,null,Ve(s.value,(W,Z)=>(z(),j("div",{class:"color-swatch",style:pt({background:W,boxShadow:`0 0 4px ${W}`}),key:Z,onClick:b=>k(W)},null,12,Ut))),128))])])}}},Gt=["title"],Kt=F("i",{class:"far fa-horizontal-rule"},null,-1),ei={__name:"LineTool",props:["priceSeries"],emits:["hideContext"],setup(A,{expose:I,emit:T}){const f=ve(),t=A,s=T,y=B(null),k=B(!1),P=ae(()=>f.state.tradingDerivative.tools.line),d=B(""),h=B("#F44336");let u=[];I({isSelected:M,hide:W,draw:R,drag:i}),fe(P,o=>{o&&g(o)});function M(){return y.value.classList.contains("selected")}function W(o){k.value=o}function Z(o){s("hideContext");const v=o.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(m=>m.classList.remove("selected")),v||o.target.classList.add("selected")}function b(o){const v=k.value;s("hideContext"),k.value=!v}function R({price:o}){const v="line",m=u.length;if(u=u.filter(_=>{const x=_.options(),e=x.type=o===+x.price;return e&&(t.priceSeries.removePriceLine(_),f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:v,point:o})),!e}),u.length===m){const _=h.value,x=d.value,e={lineType:v,price:o,color:_,title:x,lineWidth:1,lineStyle:1,draggable:!0};u.push(t.priceSeries.createPriceLine(e)),f.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:v,points:[o],data:[{color:_,title:x}]})}y.value.classList.remove("selected")}function g(o){S(!1),l(o)}function l(o){const m={lineType:"line",lineWidth:1,lineStyle:1,draggable:!0};Object.entries(o).forEach(([_,{color:x,title:e}])=>{m.price=+_,m.color=x,m.title=e,u.push(t.priceSeries.createPriceLine(m))})}function S(o=!0){u.length>0&&(o&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line"}),u.forEach(v=>t.priceSeries.removePriceLine(v)),u=[])}function i({lineOptions:o,oldPrice:v,newPrice:m}){f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line",point:v});const _=o.color,x=o.title;f.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"line",points:[m],data:[{color:_,title:x}]}),y.value.classList.remove("selected")}return(o,v)=>(z(),j("div",{ref_key:"lineToolRef",ref:y,class:"context command",title:o.$t("trading.derivative.lineTool"),onClick:Z,onContextmenu:b},[Kt,xe(te(Qt,{class:"contextmenu",enable:k.value,title:d.value,"onUpdate:title":v[0]||(v[0]=m=>d.value=m),color:h.value,"onUpdate:color":v[1]||(v[1]=m=>h.value=m),onDeleteAllLine:S},null,8,["enable","title","color"]),[[Ce,k.value]])],40,Gt))}},ti=["title"],ii=F("i",{class:"far fa-grip-lines-vertical"},null,-1),ni=[ii],si={__name:"TimeRangeTool",props:["timeRangeSeries","timeToIndex","indexToTime"],emits:["hideContext"],setup(A,{expose:I,emit:T}){const f=ve(),t=me("mf"),s=A,y=T,k=B(null),P=ae(()=>f.state.tradingDerivative.tools.timeRange);let d=[];I({isSelected:h,draw:W}),fe(P,g=>{g&&Z(g)});function h(){return k.value.classList.contains("selected")}function u(g){y("hideContext");const l=g.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(S=>S.classList.remove("selected")),l||g.target.classList.add("selected")}function M(g){R(),g.target.classList.remove("selected")}function W({time:g}){let l={isRemove:!1,name:"timeRange",points:[],data:[]},S={time:g,value:1};switch(d.length){case 0:S.color="OrangeRed",d[0]=S,l.points.push(0),l.data.push(g);break;case 1:S.color="lime",d[1]=S,l.points.push(1),l.data.push(g),k.value.classList.remove("selected");break;default:const i=s.timeToIndex(d[0].time),o=s.timeToIndex(d[1].time),m=s.timeToIndex(g)+(o-i),_=s.indexToTime(m);S.color="OrangeRed",d[0]=t.cloneDeep(S),l.points.push(0),l.data.push(g),S.time=_,S.color="lime",d[1]=S,l.points.push(1),l.data.push(_),k.value.classList.remove("selected");break}s.timeRangeSeries.setData(d),f.dispatch("tradingDerivative/drawTools",l)}function Z(g){R(!1),b(g)}function b(g){let l,S;if(g.length===2)l=g[0],S=g[1];else if(g.length===3){const o=s.timeToIndex(g[0]),v=s.timeToIndex(g[1]),_=s.timeToIndex(g[2])+(v-o);l=g[2],S=s.indexToTime(_)}else return!1;let i=[{time:l,value:1,color:"OrangeRed"},{time:S,value:1,color:"lime"}];d=i,s.timeRangeSeries.setData(i)}function R(g=!0){g&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"timeRange"}),s.timeRangeSeries.setData([]),d=[]}return(g,l)=>(z(),j("div",{ref_key:"timeRangeToolRef",ref:k,class:"command",title:g.$t("trading.derivative.timeRangeTool"),onClick:u,onContextmenu:M},ni,40,ti))}},ri=["title"],oi=F("i",{class:"far fa-line-height"},null,-1),ai=[oi],ci={__name:"TargetTool",props:["priceSeries"],emits:["hideContext"],setup(A,{expose:I,emit:T}){const f=ve(),t=me("mf"),s=A,y=T,k=B(null),P=ae(()=>f.state.tradingDerivative.tools.target);let d={};I({isSelected:h,draw:W,drag:g}),fe(P,l=>{l&&Z(l)});function h(){return k.value.classList.contains("selected")}function u(l){y("hideContext");const S=l.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),S||(l.target.classList.add("selected"),R())}function M(l){R(),l.target.classList.remove("selected")}function W({price:l}){const S="target";let i={lineType:S,price:l,lineWidth:1,lineStyle:1,draggable:!0},o={isRemove:!1,name:S,points:[],data:[l]};if(t.isSet(d.A)){const v=+d.A.options().price,m=l-v;i.point="B",i.title=t.fmtNum(m),i.color="#F44336",d[i.point]=s.priceSeries.createPriceLine(i),o.points.push(i.point),i.point="X",i.price=t.fmtNum(v-.5*m),i.title=t.fmtNum(-.5*m),i.color="#2196F3",d[i.point]=s.priceSeries.createPriceLine(i),i.point="Y",i.price=t.fmtNum(v-m),i.title=t.fmtNum(-m),i.color="#673AB7",d[i.point]=s.priceSeries.createPriceLine(i),i.point="Z",i.price=t.fmtNum(v-2*m),i.title=t.fmtNum(-2*m),i.color="#9C27B0",d[i.point]=s.priceSeries.createPriceLine(i),i.point="W",i.price=t.fmtNum(v-4*m),i.title=t.fmtNum(-4*m),i.color="#E91E63",d[i.point]=s.priceSeries.createPriceLine(i),k.value.classList.remove("selected")}else i.point="A",i.title="0",i.color="#FF9800",d[i.point]=s.priceSeries.createPriceLine(i),o.points.push(i.point);f.dispatch("tradingDerivative/drawTools",o)}function Z(l){R(!1),b(l)}function b(l){let i={lineType:"target",lineWidth:1,lineStyle:1,draggable:!0};const o=l.A,v=l.B,m=v-o;i.point="A",i.price=o,i.title="0",i.color="#FF9800",d[i.point]=s.priceSeries.createPriceLine(i),i.point="B",i.price=v,i.title=t.fmtNum(m),i.color="#F44336",d[i.point]=s.priceSeries.createPriceLine(i),i.point="X",i.price=t.fmtNum(o-.5*m),i.title=t.fmtNum(-.5*m),i.color="#2196F3",d[i.point]=s.priceSeries.createPriceLine(i),i.point="Y",i.price=t.fmtNum(o-m),i.title=t.fmtNum(-m),i.color="#673AB7",d[i.point]=s.priceSeries.createPriceLine(i),i.point="Z",i.price=t.fmtNum(o-2*m),i.title=t.fmtNum(-2*m),i.color="#9C27B0",d[i.point]=s.priceSeries.createPriceLine(i),i.point="W",i.price=t.fmtNum(o-4*m),i.title=t.fmtNum(-4*m),i.color="#E91E63",d[i.point]=s.priceSeries.createPriceLine(i)}function R(l=!0){l&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"target"}),t.isSet(d.A)&&(s.priceSeries.removePriceLine(d.A),t.isSet(d.B)&&(s.priceSeries.removePriceLine(d.B),s.priceSeries.removePriceLine(d.X),s.priceSeries.removePriceLine(d.Y),s.priceSeries.removePriceLine(d.Z),s.priceSeries.removePriceLine(d.W))),d={}}function g({lineOptions:l,newPrice:S}){if(t.isSet(d.B)){let i={isRemove:!1,name:"target",points:[],data:[]},o,v,m=+d.A.options().price,_=+d.B.options().price,x=_-m;if(o="A",l.point==="A")x=+d.B.options().title,_=m+x;else if(l.point!=="B"){let e=0;switch(l.point){case"X":e=1.5;break;case"Y":e=2;break;case"Z":e=3;break;case"W":e=5;break}x=t.fmtNum((_-S)/e),m=_-x,v={price:m},d[o].applyOptions(v)}i.points.push(o),i.data.push(m),o="B",v={price:_,title:t.fmtNum(x)},l.point===o&&delete v.price,d[o].applyOptions(v),i.points.push(o),i.data.push(_),o="X",v={price:t.fmtNum(m-.5*x),title:t.fmtNum(-.5*x)},l.point===o&&delete v.price,d[o].applyOptions(v),o="Y",v={price:t.fmtNum(m-x),title:t.fmtNum(-x)},l.point===o&&delete v.price,d[o].applyOptions(v),o="Z",v={price:t.fmtNum(m-2*x),title:t.fmtNum(-2*x)},l.point===o&&delete v.price,d[o].applyOptions(v),o="W",v={price:t.fmtNum(m-4*x),title:t.fmtNum(-4*x)},l.point===o&&delete v.price,d[o].applyOptions(v),f.dispatch("tradingDerivative/drawTools",i)}}return(l,S)=>(z(),j("div",{ref_key:"targetToolRef",ref:k,class:"command",title:l.$t("trading.derivative.targetTool"),onClick:u,onContextmenu:M},ai,40,ri))}},li=["title"],ze=3,je=2,pi={__name:"OrderTool",props:["position","prices","priceSeries","inSession","TIME"],emits:["getTools","showEntry","showTpSl","hideContext"],setup(A,{expose:I,emit:T}){const f=ve(),{t}=Pe(),s=me("mf"),y=A,k=T,P=B(null),d=B(!1),h=ae(()=>f.state.tradingDerivative.tools.order);let u={entry:{},tp:{},sl:{}},M=!1;I({has:W,show:Z,entry:b,tpsl:R,cancel:g,cancelWithoutClose:l,scan:S,drag:_}),fe(h,e=>{e&&o(e)});function W(){return s.isSet(u.entry.line)||s.isSet(u.tp.line)}function Z({price:e}){if(y.inSession()){const p=Q(ke(new Date,7));if(s.isSet(u.entry.line))!s.isSet(u.tp.line)&&y.position&&p>y.TIME.ATO&&p<y.TIME.ATC&&k("showTpSl");else{let r=null,n=0;y.position?(p<y.TIME.ATO?r="ATO":p>y.TIME.ATC&&(r="ATC"),r&&(u.entry.price=r,n=-y.position)):p>y.TIME.ATO&&p<y.TIME.ATC&&(r=e,n=r>=y.prices.at(-1).value?1:-1,u.side=n,u.entry.price=r),n&&k("showEntry")}}}function b(){if(y.inSession()){const e=Q(ke(new Date,7));e<y.TIME.ATO?Xe(t("trading.derivative.atoOrder"),t("titles.confirm")).then(r=>{r&&f.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(n=>{n.isOk?se.success(t("trading.derivative.atoOrderSuccess")):x(n.message)})}):e>y.TIME.ATC?Xe(t("trading.derivative.atcOrder"),t("titles.confirm")).then(r=>{r&&f.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(n=>{n.isOk?se.success(t("trading.derivative.atcOrderSuccess")):x(n.message)})}):f.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"new",side:u.side,price:u.entry.price}}).then(p=>{p.isOk?(i(["entry"]),se.success(t("trading.derivative.newEntrySuccess"))):x(p.message)})}}function R(){u.tp.price=u.entry.price+u.side*ze,u.sl.price=u.entry.price-u.side*je,f.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:u.tp.price},slData:{cmd:"new",price:u.sl.price}}).then(e=>{e.isOk?(u.entry.line.applyOptions({draggable:!1}),i(["entry","tp","sl"]),se.success(t("trading.derivative.newTpSlSuccess"))):x(e.message)})}function g(){s.isSet(u.entry.line)?s.isSet(u.tp.line)?f.dispatch("tradingDerivative/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(e=>{e.isOk?(m(["entry","tp","sl"]),se.success(t("trading.derivative.exitSuccess"))):x(e.message)}):f.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"delete"}}).then(e=>{e.isOk?(m(["entry"]),se.success(t("trading.derivative.deleteEntrySuccess"))):x(e.message)}):k("getTools")}function l(){if(y.inSession()&&y.position){const e=Q(ke(new Date,7));e>y.TIME.ATC-5*60&&(d.value=!0,e>y.TIME.ATC-15&&s.isSet(u.tp.line)&&f.dispatch("tradingDerivative/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(p=>{p.isOk?(m(["entry","tp","sl"]),se.success(t("trading.derivative.autoCancelTpSlSuccess"))):x(p.message)}))}}function S(e){if(s.isSet(u.entry.line)){const p=u.side>0;s.isSet(u.tp.line)?(s.cmd(e,p,u.tp.price,!0)&&(M||(M=!0,f.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"delete"}}).then(r=>{r.isOk?(m(["entry","tp","sl"]),se.success(t("trading.derivative.deleteTpSuccess")),toggleOrderButton(!1)):x(r.message),M=!1}))),s.cmd(e,!p,u.sl.price,!0)&&(M||(M=!0,f.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"cancel"}}).then(r=>{r.isOk?(m(["entry","tp","sl"]),se.success(t("trading.derivative.deleteSlSuccess")),toggleOrderButton(!1)):x(r.message),M=!1})))):s.cmd(e,p,u.entry.price,!0)&&(M||(M=!0,setTimeout(()=>{u.tp.price=u.entry.price+u.side*ze,u.sl.price=u.entry.price-u.side*je,f.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:u.tp.price},slData:{cmd:"new",price:u.sl.price}}).then(r=>{r.isOk?(u.entry.line.applyOptions({draggable:!1}),i(["entry","tp","sl"]),se.success(t("trading.derivative.autoNewTpSlSuccess"))):x(r.message),M=!1})},1e3)))}}function i(e){const p="order";let r={isRemove:!1,name:p,points:[],data:[]},n,C;e.forEach(a=>{const N=u.entry.price,E=u.tp.price,L=u.sl.price;switch(a){case"entry":n="yellow",C=u.side>0?"LONG":"SHORT";break;case"tp":n="lime",C=s.fmtNum(E-N,1,!0);break;case"sl":n="red",C=s.fmtNum(L-N,1,!0);break}if(r.points.push(a),s.isSet(u[a].line))u[a].line.applyOptions({price:u[a].price,title:C}),r.data.push(u[a].line.options());else{const w={lineType:p,kind:a,side:u.side,price:u[a].price,color:n,lineWidth:1,lineStyle:0,title:C,draggable:!0};u[a].line=y.priceSeries.createPriceLine(w),r.data.push(w)}}),f.dispatch("tradingDerivative/drawTools",r)}function o(e){m(["entry","tp","sl"],!1),v(e)}function v(e){Object.entries(e).forEach(([p,r])=>{p==="entry"&&(u.side=r.side),u[p].price=r.price,u[p].line=y.priceSeries.createPriceLine(r)})}function m(e,p=!0){p&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"order"}),e.forEach(r=>{s.isSet(u[r].line)&&(y.priceSeries.removePriceLine(u[r].line),delete u[r].line)})}function _({line:e,lineOptions:p,oldPrice:r,newPrice:n}){if(n!==r){let C=!1;p.kind==="entry"?y.position||(C=!0,u[p.kind].price=n,f.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"change",price:u.entry.price}}).then(a=>{a.isOk?(i([p.kind]),se.success(t("trading.derivative.changeEntrySuccess"))):(e.applyOptions({price:r}),x(a.message))})):(C=!0,u[p.kind].price=n,p.kind==="tp"?f.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"change",price:u.tp.price}}).then(a=>{a.isOk?(i([p.kind]),se.success(t("trading.derivative.changeTpSuccess"))):(e.applyOptions({price:r}),x(a.message))}):f.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"change",price:u.sl.price}}).then(a=>{a.isOk?(i([p.kind]),se.success(t("trading.derivative.changeSlSuccess"))):(e.applyOptions({price:r}),x(a.message))})),C||(e.applyOptions({price:r}),se.show(t("trading.derivative.noChangeOrderLine")))}}function x(e){e||(e="unknown"),se.error(t(`trading.derivative.${e}`))}return(e,p)=>(z(),j("div",{ref_key:"orderToolRef",ref:P,class:"cancel-order command",title:e.$t("trading.derivative.orderTool"),onClick:g},[F("i",{class:le(["far fa-trash-alt",{blink:d.value}])},null,2)],8,li))}};const di=["title"],ui=["title"],fi=["title"],mi=["title"],vi="wss://tradestation.fireant.vn/quote?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",hi="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",ki={__name:"Chart",setup(A,{expose:I}){const T=ve(),f=mt(),{t}=Pe(),s=me("devices"),y=me("mf"),k=me("filters"),P=B(null),d=B(null),h=B(null),u=B(null),M=B(null),W=B(null),Z=B(null),b=B(null),R=B(null),g=B(null),l=B(null),S=B(null),i=B(null),o=B(null),v=B(null),m={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.25,bottom:.25}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:1e3,minBarSpacing:.01,barSpacing:.05}},_=Oe(new Date,"yyyy-MM-dd"),x={START:Q(new Date(`${_}T08:45:00Z`)),ATO:Q(new Date(`${_}T09:00:00Z`)),ATC:Q(new Date(`${_}T14:30:00Z`)),END:Q(new Date(`${_}T14:45:00Z`))};let e={chart:{},whitespaces:[],crosshair:{},interval:null,interval60:null,websocket:null,socketStop:!1,vpsUpdatedAt:Tt(new Date,61)};const p=dt({prices:[],series:{},chartDate:f.query.date??_,clock:Oe(new Date,"HH:mm:ss"),isSocketWarning:!1,TIME:x}),r=ae(()=>T.state.tradingDerivative.status),n=ae(()=>T.state.tradingDerivative.config),C=ae(()=>T.state.tradingDerivative.tools),a=ae(()=>T.state.tradingDerivative.isLoading),N=ae(()=>r.value.position||r.value.pending||i.value&&i.value.has());e.interval=setInterval(()=>{i.value&&i.value.cancelWithoutClose(),p.clock=Oe(new Date,"HH:mm:ss")},1e3),e.interval60=setInterval(()=>{be()?(Ye(),n.value.autoRefresh&&b.value.refresh(!0)):clearInterval(e.interval60)},6e4),tt(),Me(()=>{E(),new ResizeObserver(ne).observe(P.value),document.addEventListener("keydown",G)}),qe(()=>{L(),document.removeEventListener("keydown",G),clearInterval(e.interval),clearInterval(e.interval60),ce(),e.socketStop=!0}),fe(()=>T.state.tradingDerivative.chartData,re),fe(C,oe),I({connectSocket:he});function E(){e.chart=St(d.value,m),e.chart.subscribeCrosshairMove(U),e.chart.subscribeCustomPriceLineDragged(ie),p.series.whitespace=e.chart.addHistogramSeries({priceScaleId:"whitespace",scaleMargins:{top:0,bottom:0},color:"#808080",lastValueVisible:!1,priceLineVisible:!1}),p.series.timeRange=e.chart.addHistogramSeries({priceScaleId:"timeRange",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),p.series.pickTime=e.chart.addHistogramSeries({priceScaleId:"pickTime",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),p.series.timeMark=e.chart.addHistogramSeries({priceScaleId:"timeMark",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),p.series.price=e.chart.addLineSeries({color:"#F5F5F5",priceFormat:{minMove:.1}})}function L(){e.chart&&(e.chart.remove(),e.chart=null)}function w(c){pe(),we(!1),S.value.isSelected()?S.value.draw({time:e.crosshair.time}):b.value.isSelected()?b.value.draw({time:e.crosshair.time,price:Le(e.crosshair.y)}):R.value.isSelected()?R.value.draw({time:e.crosshair.time}):Z.value.isSelected()?Z.value.draw({price:Le(e.crosshair.y)}):l.value.isSelected()?l.value.draw({time:e.crosshair.time}):g.value.isSelected()&&g.value.draw({price:Le(e.crosshair.y)})}function $(c){we(!0),c.preventDefault()}function V(c){c.stopPropagation()}function H(c){c.preventDefault(),c.stopPropagation()}function U(c){if(c.time){let O=c.seriesPrices.get(p.series.price);e.crosshair.time=c.time,e.crosshair.price=O}else s.phone||(e.crosshair.time=null,e.crosshair.price=null);c.point!==void 0&&(e.crosshair.x=c.point.x,e.crosshair.y=c.point.y)}function ie(c){let O=c.customPriceLine,D=O.options();D.price=y.fmtNum(D.price);const X=+c.fromPriceString,K=D.price;switch(D.lineType){case"order":i.value.drag({line:O,lineOptions:D,oldPrice:X,newPrice:K});break;case"line":Z.value.drag({lineOptions:D,oldPrice:X,newPrice:K});break;case"target":g.value.drag({lineOptions:D,newPrice:K});break;case"pattern":b.value.drag({lineOptions:D});break}}function ne(){P.value&&(e.chart.resize(P.value.offsetWidth,P.value.offsetHeight),P.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function G(c){if(c.ctrlKey)switch(c.keyCode){case 219:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing-.01});break;case 221:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing+.01});break}if(c.altKey)switch(c.keyCode){case 219:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()-50);break;case 221:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()+50);break}}function re(c){p.chartDate===_&&be()||(c.price.length>0&&(e.whitespaces=Y(e.whitespaces,ee(p.chartDate))),p.series.whitespace.setData(e.whitespaces),p.prices=Y(p.prices,c.price),p.series.price.setData(p.prices))}function J(c,O=null){const D=O??n.value.source;let X=[];c.forEach(K=>{let de,ue;D==="FireAnt"?(de=Q(ke(new Date(K.date),7)),ue=K.price):(de=Q(new Date(`${_}T${K.time}Z`)),ue=K.lastPrice),X.push({time:de,value:ue})}),X.length>1?(p.prices=Y(p.prices,X),p.series.price.setData(p.prices)):(p.prices.push(X[0]),p.series.price.update(X[0]))}function ee(c){const O=Q(new Date(`${c}T09:00:00Z`)),D=Q(new Date(`${c}T11:30:00Z`)),X=Q(new Date(`${c}T13:00:00Z`)),K=Q(new Date(`${c}T14:30:00Z`)),de=Q(new Date(`${c}T14:00:00Z`));let ue=[];for(let Se=O;Se<=K;Se++){if(Se>D&&Se<X)continue;let Je={time:Se};(Se===de||Se===K)&&(Je.value=1),ue.push(Je)}return ue}function Y(c,O){return Array.from(new Map([...c,...O].sort((D,X)=>D.time-X.time).map(D=>[D.time,D])).values())}function oe(c){Object.entries(c).forEach(([O,D])=>{})}async function he(){if(be()){await ce();const c=n.value.source==="FireAnt",O=c?vi:hi;e.websocket=new WebSocket(O),e.websocket.onclose=D=>{e.socketStop||(p.isSocketWarning=!0,he())},c?ge():(We(),_e())}}async function ce(){e.websocket&&e.websocket.readyState===WebSocket.OPEN&&(e.websocket.close(),await new Promise(c=>{const O=setInterval(()=>{(!e.websocket||e.websocket.readyState===WebSocket.CLOSED)&&(e.websocket=null,clearInterval(O),c())},100)}))}function ge(){T.dispatch("tradingDerivative/setLoading",!0),e.websocket.onopen=c=>{if(e.websocket.readyState===WebSocket.OPEN){let O='{"protocol":"json","version":1}';e.websocket.send(O),O='{"arguments":["VN30F1M"],"invocationId":"0","target":"SubscribeTrades","type":1}',e.websocket.send(O)}},e.websocket.onmessage=c=>{p.isSocketWarning=!1,q(c.data).forEach(D=>{if(!D)return!1;D.type===3?(D.result[0].date.slice(0,10)===_&&(Ee(),e.whitespaces=Y(e.whitespaces,ee(_)),p.series.whitespace.setData(e.whitespaces),J(D.result)),T.dispatch("tradingDerivative/setLoading",!1)):D.type===1&&D.target==="UpdateTrades"&&D.arguments[0]==="VN30F1M"&&(console.log("FireAnt",D.arguments[1]),i.value.scan(D.arguments[1].at(-1).price),J(D.arguments[1]))})}}function q(c){let O=[];return c.split("").forEach(D=>{const X=D.indexOf("{"),K=D.lastIndexOf("}");let de=null;if(X!==-1&&K!==-1&&K>X){const ue=D.substring(X,K+1);ue!=="{}"&&(de=JSON.parse(ue))}O.push(de)}),O}function _e(){e.websocket.onopen=c=>{if(e.websocket.readyState===WebSocket.OPEN){const O={action:"join",list:n.value.vn30f1m},D=`42${JSON.stringify(["regs",JSON.stringify(O)])}`;e.websocket.send(D)}},e.websocket.onmessage=c=>{if(p.isSocketWarning=!1,c.data.substr(0,1)==="4"&&c.data.substr(1,1)==="2"){const O=JSON.parse(c.data.substr(2));if(O[0]==="stockps"){const D=O[1].data;D.id===3220&&(console.log("VPS",D),i.value.scan(D.lastPrice),J([D]))}}}}function We(){ut(new Date,new Date(e.vpsUpdatedAt))>60&&(fetch("https://bddatafeed.vps.com.vn/getpschartintraday/VN30F1M").then(c=>c.json()).then(c=>{console.log(c),J(c,"VPS")}),e.vpsUpdatedAt=new Date)}function $e(){b.value.refresh()}function Ze(c){b.value.load(c,{isSave:!0})}function pe(){W.value.hide(),S.value.hide(),Z.value.hide()}function ye(c){W.value.set(c)}function we(c){c?i.value.show({price:Le(e.crosshair.y)}):(o.value.style.display="none",v.value.style.display="none")}function Ie(){o.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-71?-71:1))+"px",o.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-61?-61:1))+"px",o.value.style.background=side>0?"green":"red",o.value.innerText=`${side>0?"LONG":"SHORT"} ${price}`,o.value.style.display="block"}function Re(){v.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-61?-61:1))+"px",v.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-51?-51:1))+"px",v.value.style.display="block"}function De(){i.value.entry()}function Ne(){i.value.tpsl()}function Ge(){e.chart.timeScale().scrollToRealTime()}function be(){const c=Q(ke(new Date,7));return n.value.openingMarket&&c>=x.START&&c<=x.END}function Ke(){if(!p.chartDate)return!1;Ae()}function et(){e.whitespaces=[],p.prices=[],he(),Ae()}function tt(){T.dispatch("tradingDerivative/initChart").then(()=>{he(),!f.query.date&&n.value.lastOpeningDate&&(p.chartDate=n.value.lastOpeningDate),Ae()})}function Ae(){T.dispatch("tradingDerivative/getChartData",p.chartDate).then(c=>{c&&Ee()})}function Ye(){T.dispatch("tradingDerivative/getStatus")}function Ee(){T.dispatch("tradingDerivative/getTools")}function it(){T.dispatch("tradingDerivative/getAccountInfo").then(c=>{let O="";O+='<div style="width: 200px;">',O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.nav")}</div><div>: ${k.currency(c.nav)}</div></div>`,O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.maxVol")}</div><div>: ${k.numberVnFormat(c.maxVol)}</div></div>`,O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.vm")}</div><div>: ${k.currency(c.vm)}</div></div>`,O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.fee")}</div><div>: ${k.currency(c.fee)}</div></div>`,O+="</div>",vt(O,t("trading.derivative.accountInfo"))})}function Le(c){return y.fmtNum(p.series.price.coordinateToPrice(c))}function Be(c){let O=e.whitespaces.findIndex(D=>D.time===c);if(O===-1){const D=Oe(new Date(c*1e3),"yyyy-MM-dd"),X=Q(new Date(`${D}T11:30:00Z`)),K=Q(new Date(`${D}T13:00:00Z`)),de=Q(new Date(`${D}T14:30:00Z`));c>X&&c<K?c=X:c>de&&(c=de),O=e.whitespaces.findIndex(ue=>ue.time===c)}return O}function He(c){return c<e.whitespaces.length?e.whitespaces[c].time:!1}return(c,O)=>(z(),j("div",{class:"derivative-chart",ref_key:"chartContainerRef",ref:P,onClick:w,onContextmenu:$},[F("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:d},[F("div",{class:"area data-area",onClick:V,onContextmenu:H},[F("div",{ref_key:"connectionRef",ref:h,class:le(["command",{yellow:r.value.pending,red:n.value.volInValid}]),title:c.$t("trading.derivative.connection"),onClick:Ye},[F("i",{class:le(["far",{"fa-link-simple":r.value.connection,"fa-link-simple-slash":!r.value.connection,blink:p.isSocketWarning}])},null,2)],10,di),F("div",{class:le(["command status",{green:r.value.position>0,red:r.value.position<0}]),title:c.$t("trading.derivative.position"),onClick:it},Te(r.value.position),11,ui),F("div",{class:"command clock",onClick:he},Te(p.clock),1),xe(F("input",{type:"date",class:"chart-date command",title:c.$t("trading.derivative.date"),"onUpdate:modelValue":O[0]||(O[0]=D=>p.chartDate=D),onChange:Ke},null,40,fi),[[ft,p.chartDate]]),F("div",{ref_key:"reloadToolRef",ref:u,class:"command",title:c.$t("trading.derivative.reload"),onClick:et,onContextmenu:Ee},[F("i",{class:le(["far fa-sync-alt",{"fa-spin":a.value}])},null,2)],40,mi)],32),F("div",{class:"area tool-area",onClick:V,onContextmenu:H},[te(kt,{chartContainerRef:P.value},null,8,["chartContainerRef"]),te(wt,{ref_key:"tradingviewRef",ref:M,vpsUser:n.value.vpsUser,vpsSession:n.value.vpsSession,chartContainerRef:P.value},null,8,["vpsUser","vpsSession","chartContainerRef"]),te(Pt,{ref_key:"progressToolRef",ref:W,onRefreshPattern:$e,onHideContext:pe},null,512),te(Bt,{ref_key:"scanToolRef",ref:S,prices:p.prices,timeToIndex:Be,onScaned:Ze,onRemovePattern:O[1]||(O[1]=()=>b.value.remove()),onHideContext:pe},null,8,["prices"]),te(Wt,{ref_key:"patternToolRef",ref:b,prices:p.prices,priceSeries:p.series.price,timeMarkSeries:p.series.timeMark,pickTimeToolRef:R.value,timeToIndex:Be,indexToTime:He,onSetProgress:ye,onHideContext:pe},null,8,["prices","priceSeries","timeMarkSeries","pickTimeToolRef"]),te(Jt,{ref_key:"pickTimeToolRef",ref:R,pickTimeSeries:p.series.pickTime,onRefreshPattern:$e,onHideContext:pe},null,8,["pickTimeSeries"]),te(ei,{ref_key:"lineToolRef",ref:Z,priceSeries:p.series.price,onHideContext:pe},null,8,["priceSeries"]),te(si,{ref_key:"timeRangeToolRef",ref:l,timeRangeSeries:p.series.timeRange,timeToIndex:Be,indexToTime:He,onHideContext:pe},null,8,["timeRangeSeries"]),te(ci,{ref_key:"targetToolRef",ref:g,priceSeries:p.series.price,onHideContext:pe},null,8,["priceSeries"]),xe(te(pi,{ref_key:"orderToolRef",ref:i,position:r.value.position,prices:p.prices,priceSeries:p.series.price,inSession:be,TIME:p.TIME,onGetTools:Ee,onShowEntry:Ie,onShowTpSl:Re,onHideContext:pe},null,8,["position","prices","priceSeries","TIME"]),[[Ce,N.value]])],32),F("div",null,[F("div",{ref_key:"entryOrderRef",ref:o,class:"order-button entry",onClick:De}," Entry ",512),F("div",{ref_key:"tpslOrderRef",ref:v,class:"order-button tpsl",onClick:Ne}," TP/SL ",512),F("div",{class:"chart-top command far fa-angle-double-right",onClick:Ge})])],512)],544))}};export{ki as default};
