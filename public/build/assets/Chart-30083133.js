import{z as vt,A as ht,B as gt,r as B,y as Ye,C as nt,o as H,b as K,d as M,E as ae,c as le,G as xe,H as _e,I as St,J as yt,K as Tt,m as st,p as He,f as ze,e as ee,F as We,L as Ze,t as Te,h as me,u as Pe,k as fe,M as xt,N as Ct,O as Ke,Q as rt,g as ot,w as ve,R as kt,S as _t,T as et,x as oe,l as $e,a as wt,U as Me,V as bt,j as Dt,W as Rt}from"./app-08cba552.js";import{_ as Et}from"./text-box-a5449974.js";import{g as G}from"./getUnixTime-aa85449a.js";import{c as Lt}from"./lightweight-charts.esm.development-03366bac.js";function at(E,N,x){return vt((x==null?void 0:x.in)||E,+ht(E)+N)}function ke(E,N,x){return at(E,N*gt,x)}function Ot(E,N,x){return at(E,N*1e3,x)}function Ve(E,N,x){return Ot(E,-N,x)}const $t=["title"],Pt={__name:"FullscreenTool",props:["chartContainerRef"],setup(E,{expose:N}){const x=E,u=B(!1);N({setFullscreen:y}),Ye(()=>{document.addEventListener("fullscreenchange",s),window.addEventListener("keydown",P)}),nt(()=>{document.removeEventListener("fullscreenchange",s),window.removeEventListener("keydown",P)});function e(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function s(){x.chartContainerRef&&(document.fullscreenElement?(u.value=!0,x.chartContainerRef.classList.add("fullscreen"),y()):(u.value=!1,x.chartContainerRef.classList.remove("fullscreen"),k()))}function y(){document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"}function k(){document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"}function P(a){a.key==="F11"&&(e(),a.preventDefault())}return(a,v)=>(H(),K("div",{class:"command",title:a.$t("trading.derivative.fullscreen"),onClick:e},[M("i",{class:ae(["far",{"fa-compress":u.value,"fa-expand":!u.value}])},null,2)],8,$t))}},It=["title"],At=["src"],Nt={__name:"TradingviewTool",props:["vpsUser","vpsSession","chartContainerRef"],setup(E){const N=E,x=B(null),u=B(!1),e=le(()=>`https://chart.vps.com.vn/tv/?u=${N.vpsUser}&s=${N.vpsSession}&symbol=VN30F1M&resolution=1&lang=vi`);function s(k){u.value=!u.value,y(),k.stopPropagation()}function y(){if(N.chartContainerRef&&x.value){const{offsetWidth:k,offsetHeight:P}=N.chartContainerRef,{top:a,left:v}=x.value.getBoundingClientRect();x.value.style.top=`${a-2}px`,x.value.style.left=`${v+32}px`,x.value.style.width=`${k-34}px`,x.value.style.height=`${P}px`}}return(k,P)=>(H(),K("div",{class:"tradingview command far fa-chart-candlestick",title:k.$t("trading.derivative.tradingview"),onClick:s},[xe(M("iframe",{ref_key:"tradingviewRef",ref:x,class:"chart",src:e.value},null,8,At),[[_e,u.value]])],8,It))}};const Bt=M("div",{class:"triangle-shadow"},null,-1),Ft=M("div",{class:"triangle"},null,-1),Je={__name:"CoreContext",setup(E){function N(x){x.stopPropagation()}return(x,u)=>(H(),K("div",{class:"core-context",onClick:N},[Bt,Ft,St(x.$slots,"default")]))}};const Mt={__name:"ProgressContext",props:["progress","chartHeightEnough"],emits:["refreshPattern"],setup(E,{emit:N}){const x=N,u=B([]);Ye(()=>{e()});function e(){yt(Object.assign({"../../../../../lang/vi/derivative.js":()=>Tt(()=>import("./derivative-0a1a41d1.js"),[])}),`../../../../../lang/${window.lang}/derivative.js`).then(y=>{u.value=y.default||[]})}function s(){x("refreshPattern")}return(y,k)=>{const P=st("DxButton");return H(),He(Je,{class:"pattern-context"},{default:ze(()=>[ee(P,{icon:"refresh",type:"success",text:y.$t("trading.derivative.progressContext.refreshPattern"),onClick:s},null,8,["text"]),M("div",{class:ae(["steps",{portrait:E.chartHeightEnough}])},[(H(!0),K(We,null,Ze(u.value,(a,v)=>(H(),K("div",{key:v,class:ae(["step",[E.progress.step&&E.progress.step===v+1?E.progress.result?"success":"fail":""]])},[M("div",{class:ae(["name",[E.progress.steps?E.progress.steps[v].every(Boolean)?"success":"fail":""]])},Te(v+1)+". "+Te(a.name),3),M("div",null,[(H(!0),K(We,null,Ze(a.conds,(S,A)=>(H(),K("div",{key:A,class:ae(["condition",[E.progress.steps?E.progress.steps[v][A]?"success":"fail":""]])},Te(A+1)+". "+Te(S),3))),128))])],2))),128))],2)]),_:1})}}},Vt=["title"],Wt={__name:"ProgressTool",props:["chartHeightEnough"],emits:["refreshPattern","hideContext"],setup(E,{expose:N,emit:x}){const u=me(),{t:e}=Pe(),s=fe("mf"),y=x,k=B({}),P=B(!1),a=le(()=>u.state.tradingDerivative.config.autoRefresh);N({hide:S,set:A});function v(){const p=P.value;y("hideContext"),P.value=!p}function S(p=!1){P.value=p}function A(p){a.value&&Y(p,k.value),k.value=p}function V(){y("refreshPattern")}function Z(){u.dispatch("tradingDerivative/setAutoRefresh",!a.value)}function Y(p,o){if(s.isSet(p)&&(p.step!==o.step||p.step===o.step&&p.result!==o.result)){let h="";p.result?[2,4].includes(p.step)?h=e("trading.derivative.progressOrder",p):h=e("trading.derivative.progressSuccess",p):h=e("trading.derivative.progressFail",p),I(h)}}function I(p){const o=new SpeechSynthesisUtterance(p);o.lang="vi-VN",speechSynthesis.speak(o)}return(p,o)=>(H(),K("div",{class:ae(["context command",{green:k.value.result===!0,red:k.value.result===!1}]),title:p.$t("trading.derivative.progressTool"),onClick:v,onContextmenu:Z},[M("i",{class:ae(["far",{"fa-badge-check":!k.value.step,[`fa-circle-${k.value.step}`]:k.value.step,blink:a.value}])},null,2),xe(ee(Mt,{class:"contextmenu",progress:k.value,chartHeightEnough:E.chartHeightEnough,onRefreshPattern:V},null,8,["progress","chartHeightEnough"]),[[_e,P.value]])],42,Vt))}};var Ce={};const Zt=xt(Ct);/*!
 * devextreme-vue
 * Version: 22.2.12
 * Build date: Mon Apr 29 2024
 *
 * Copyright (c) 2012 - 2024 Developer Express Inc. ALL RIGHTS RESERVED
 *
 * This software may be modified and distributed under the terms
 * of the MIT license. See the LICENSE file in the root of the project for details.
 *
 * https://github.com/DevExpress/devextreme-vue
 */var Yt=Ke&&Ke.__importDefault||function(E){return E&&E.__esModule?E:{default:E}};Object.defineProperty(Ce,"__esModule",{value:!0});Ce.DxItem=Ce.DxButtonGroup=void 0;var Ht=Yt(Zt),zt=rt,Jt=rt,ct=zt.createComponent({props:{accessKey:String,activeStateEnabled:Boolean,buttonTemplate:{},disabled:Boolean,elementAttr:Object,focusStateEnabled:Boolean,height:[Function,Number,String],hint:String,hoverStateEnabled:Boolean,items:Array,keyExpr:[Function,String],onContentReady:Function,onDisposing:Function,onInitialized:Function,onItemClick:Function,onOptionChanged:Function,onSelectionChanged:Function,rtlEnabled:Boolean,selectedItemKeys:Array,selectedItems:Array,selectionMode:String,stylingMode:String,tabIndex:Number,visible:Boolean,width:[Function,Number,String]},emits:{"update:isActive":null,"update:hoveredElement":null,"update:accessKey":null,"update:activeStateEnabled":null,"update:buttonTemplate":null,"update:disabled":null,"update:elementAttr":null,"update:focusStateEnabled":null,"update:height":null,"update:hint":null,"update:hoverStateEnabled":null,"update:items":null,"update:keyExpr":null,"update:onContentReady":null,"update:onDisposing":null,"update:onInitialized":null,"update:onItemClick":null,"update:onOptionChanged":null,"update:onSelectionChanged":null,"update:rtlEnabled":null,"update:selectedItemKeys":null,"update:selectedItems":null,"update:selectionMode":null,"update:stylingMode":null,"update:tabIndex":null,"update:visible":null,"update:width":null},computed:{instance:function(){return this.$_instance}},beforeCreate:function(){this.$_WidgetClass=Ht.default,this.$_hasAsyncTemplate=!0,this.$_expectedChildren={item:{isCollectionItem:!0,optionName:"items"}}}});Ce.DxButtonGroup=ct;var Xe=Jt.createConfigurationComponent({emits:{"update:isActive":null,"update:hoveredElement":null,"update:disabled":null,"update:elementAttr":null,"update:hint":null,"update:html":null,"update:icon":null,"update:template":null,"update:text":null,"update:type":null,"update:visible":null},props:{disabled:Boolean,elementAttr:Object,hint:String,html:String,icon:String,template:{},text:String,type:String,visible:Boolean}});Ce.DxItem=Xe;Xe.$_optionName="items";Xe.$_isCollectionItem=!0;var Xt=Ce.default=ct;const jt={__name:"ScanContext",props:["modelValue"],emits:["update:modelValue"],setup(E,{emit:N}){const{t:x}=Pe(),u=[{icon:"chevrondoubleleft",side:"left",text:x("trading.derivative.scanContext.leftScan")},{icon:"chevrondoubleright",side:"right",text:x("trading.derivative.scanContext.rightScan")}],e=E,s=N;function y({itemData:{side:k}}){s("update:modelValue",k)}return(k,P)=>(H(),He(Je,{class:"scan-context"},{default:ze(()=>[ee(ot(Xt),{items:u,"selected-item-keys":[e.modelValue],"key-expr":"side","styling-mode":"outlined",onItemClick:y},null,8,["selected-item-keys"])]),_:1}))}},Ut=["title"],qt={__name:"ScanTool",props:["prices","timeToIndex"],emits:["scaned","removePattern","hideContext"],setup(E,{expose:N,emit:x}){const u=fe("mf"),e=E,s=x,y=B(null),k=B(!1),P=B("left");N({isSelected:a,hide:v,draw:V});function a(){return y.value.classList.contains("selected")}function v(){k.value=!1}function S(p){s("hideContext");const o=p.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(h=>h.classList.remove("selected")),o||(p.target.classList.add("selected"),s("removePattern"))}function A(){const p=k.value;s("hideContext"),k.value=!p}function V({time:p}){const o=P.value==="left",h=p?e.prices.filter(c=>!u.cmp(c.time,o,p)):e.prices;let i=o?Z(h):Y(h);u.isSet(i)&&s("scaned",I(i)),y.value.classList.remove("selected")}function Z(p){let o,[h,i,c,m]=Array(4).fill({});for(let d=p.length-1;d>=0;d--){const O=p[d].value,C=p[d].time,g=e.timeToIndex(C);if(g===-1)break;if(d===p.length-1&&(c={index:g,time:C,price:O},[i,h,m]=Array(3).fill(null).map(()=>u.cloneDeep(c))),o===void 0){if(O===c.price)continue;o=O>c.price}if(u.cmp(O,o,i.price)&&(u.cmp(h.price,!o,c.price)?([c,i]=[i,h].map(r=>u.cloneDeep(r)),h={index:g,time:C,price:O},m=u.cloneDeep(h),o=!o):i={index:g,time:C,price:O}),u.cmp(O,!o,h.price)?(h={index:g,time:C,price:O},m=u.cloneDeep(h)):m.index=g,u.cmp(O,o,m.price)&&(m={index:g,time:C,price:O}),c.index>h.index){const r=u.fmtNum(i.price-c.price,1,!0);if(r>=1&&(h.index-m.index>=2*(c.index-i.index)||u.fmtNum(h.price-m.price,1,!0)>r))break}}return{A:h,B:i,C:c}}function Y(p){let o,[h,i,c]=Array(3).fill({});for(let m=0;m<p.length;m++){const d=p[m].value,O=p[m].time,C=e.timeToIndex(O);if(C===-1)break;if(m===0&&(h={index:C,time:O,price:d},i=u.cloneDeep(h),c=u.cloneDeep(h)),o===void 0){if(d===h.price)continue;o=d>h.price}u.cmp(d,o,i.price)&&(i={index:C,time:O,price:d},c=u.cloneDeep(i)),u.cmp(i.price,o,h.price)&&u.cmp(d,!o,c.price)&&(u.cmp(d,o,h.price)?c={index:C,time:O,price:d}:(h=u.cloneDeep(i),i={index:C,time:O,price:d},c=u.cloneDeep(i),o=!o))}return{A:h,B:i,C:c}}function I(p){const o={};return Object.entries(p).forEach(([h,i])=>{const{index:c,...m}=i;o[h]=m}),o}return(p,o)=>(H(),K("div",{ref_key:"scanToolRef",ref:y,class:"context command",title:p.$t("trading.derivative.scanTool"),onClick:S,onContextmenu:A},[M("i",{class:ae(["far",{[`fa-angles-${P.value}`]:!0}])},null,2),xe(ee(jt,{class:"contextmenu",modelValue:P.value,"onUpdate:modelValue":o[0]||(o[0]=h=>P.value=h)},null,8,["modelValue"]),[[_e,k.value]])],40,Ut))}},Qt=["title"],Gt=M("i",{class:"far fa-heart-rate"},null,-1),Kt=[Gt],ei={__name:"PatternTool",props:["prices","priceSeries","timeMarkSeries","pickTimeToolRef","timeToIndex","indexToTime"],emits:["setProgress","hideContext"],setup(E,{expose:N,emit:x}){const u=me(),e=fe("mf"),s=E,y=x,k=B(null),P=le(()=>u.state.tradingDerivative.tools.pattern);let a={},v={};N({isSelected:S,draw:Z,load:Y,refresh:p,remove:O,drag:r}),ve(P,t=>{t&&Y(t,{isCheck:!0})});function S(){return k.value.classList.contains("selected")}function A(t){y("hideContext");const n=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(T=>T.classList.remove("selected")),n||(t.target.classList.add("selected"),s.pickTimeToolRef.remove())}function V(t){t.target.classList.remove("selected"),y("hideContext"),O()}function Z({time:t,price:n}){let f={lineType:"pattern",price:n,lineWidth:1,lineStyle:1,draggable:!0};if(e.isSet(v.A))if(e.isSet(v.B)){let _,w;if(e.isSet(v.C)){let L,b;a.A={time:t,price:n};const{progress:$,timeMark:F,info:{rEpr1:z,rEpr2:U,rEpr3:te,entry:se,pStatus:ie,x:re,X:q,y:Q,Y:X}}=o();w=$,_=F,L="A",b={price:n,title:`A ${z}`},v[L].applyOptions(b),L="B",b={title:`B ${U}`},v[L].applyOptions(b),L="C",b={title:`C ${te}`},v[L].applyOptions(b),L="D",b={price:se,title:"Entry "+ie},v[L].applyOptions(b),L="X",b={price:e.fmtNum(re),title:`X ${e.fmtNum(q)}`},v[L].applyOptions(b),L="Y",b={price:e.fmtNum(Q),title:`Y ${e.fmtNum(X)}`},v[L].applyOptions(b)}else{a.C={price:n};const{progress:L,timeMark:b,info:{rEpr1:$,rEpr2:F,rEpr3:z,entry:U,pStatus:te,x:se,X:ie,y:re,Y:q}}=o();w=L,_=b;let Q="A";v[Q].applyOptions({title:`A ${$}`}),Q="B",v[Q].applyOptions({title:`B ${F}`}),f.point="C",f.title=`C ${z}`,f.color="#FFEB3B",v[f.point]=s.priceSeries.createPriceLine(f),f.point="D",f.price=U,f.title="Entry "+te,f.color="#9C27B0",f.draggable=!1,v[f.point]=s.priceSeries.createPriceLine(f),f.point="Y",f.price=e.fmtNum(re),f.title=`Y ${e.fmtNum(q)}`,f.color="#E91E63",f.draggable=!1,v[f.point]=s.priceSeries.createPriceLine(f),f.point="X",f.price=e.fmtNum(se),f.title=`X ${e.fmtNum(ie)}`,f.color="#2196F3",f.draggable=!1,v[f.point]=s.priceSeries.createPriceLine(f)}d(),y("setProgress",w),g(_),k.value.classList.remove("selected")}else f.point="B",f.title="B 0",f.color="#4CAF50",v[f.point]=s.priceSeries.createPriceLine(f),a.B={price:n};else f.point="A",f.title="A 0",f.color="#F44336",v[f.point]=s.priceSeries.createPriceLine(f),a={A:{time:t,price:n}}}function Y(t,{isSave:n=!1,isCheck:T=!1}={}){a=e.cloneDeep(t),n&&d(),(T?i(a):!0)&&(C(),I())}function I(){let n={lineType:"pattern",lineWidth:1,lineStyle:1,draggable:!0};const{A:T,B:f,C:_}=a,{progress:w,timeMark:L,info:{rEpr1:b,rEpr2:$,rEpr3:F,entry:z,pStatus:U,x:te,X:se,y:ie,Y:re}}=o();y("setProgress",w),g(L),n.point="A",n.title=`A ${b}`,n.color="#F44336",n.price=T.price,v[n.point]=s.priceSeries.createPriceLine(n),n.point="B",n.title=`B ${$}`,n.color="#4CAF50",n.price=f.price,v[n.point]=s.priceSeries.createPriceLine(n),n.point="C",n.price=_.price,n.title=`C ${F}`,n.color="#FFEB3B",v[n.point]=s.priceSeries.createPriceLine(n),n.point="D",n.price=z,n.title="Entry "+U,n.color="#9C27B0",n.draggable=!1,v[n.point]=s.priceSeries.createPriceLine(n),n.point="Y",n.price=e.fmtNum(ie),n.title=`Y ${e.fmtNum(re)}`,n.color="#E91E63",n.draggable=!1,v[n.point]=s.priceSeries.createPriceLine(n),n.point="X",n.price=e.fmtNum(te),n.title=`X ${e.fmtNum(se)}`,n.color="#2196F3",n.draggable=!1,v[n.point]=s.priceSeries.createPriceLine(n)}function p(t=!1){e.isSet(v.C)&&(t&&m(),C(),I())}function o(){const{A:t,B:n,C:T}=a,f=n.price-T.price,_=f>0,w=h({phase:1,start:t,end:n,retracementPrice:T.price});let L=h({phase:2,start:w.R,end:T});const b=h({phase:3,start:L.R,end:{price:n.price+(_?1:-1)*w.rEp},breakPrices:[L.S1.price,n.price]});w.xBox.tr>=L.tr&&(L.tr=w.xBox.tr),console.log("calculatePattern",[w,L,b]);const $=e.fmtNum(f,1,!0)>=w.pr,F=e.fmtNum(T.price-b.xBox.R.price,1,!0)>=L.pr,z=e.fmtNum(b.xBox.pr)>=b.pr,U=!e.cmp(T.price,!_,w.S1.price),te=!e.cmp(b.xBox.R.price,_,L.S1.price),se=!e.cmp(b.xBox.S.price,!_,b.S1.price),ie=w.R.index+w.tr,re=w.R.index+5*w.tr,q=L.R.index+L.tr,Q=b.xBox.R.index+b.tr,X=b.xBox.R.index+5*b.tr,ne=b.xBox.R.index+L.tr,he=[ie,re,q,Q,X,ne],ce=b.xBox.S.index;let ge,j={};const we=[L.R.index>ie,w.rEpr<3,L.rEpr<w.rEpr];j.steps=[[$||w.rEt<w.tr&&w.rEp>=w.sEp,U,!b.breakIndexs[1]||ie<b.breakIndexs[1],ce>ie,ce<re],[...we,q>ie,ce<X,ce<q],[L.R.index-w.R.index>.5*w.tr,F,!b.breakIndexs[1]||q<b.breakIndexs[1],ce>q],[z,se,ce>Q,we.every(Boolean)||ce>ne]],j.step=1,j.result=j.steps[0].every(Boolean),ge=w.R1.price,j.result&&(ce<=q?(j.step=2,j.result=j.steps[1].every(Boolean),ge=L.S1.price):(j.step=3,j.result=j.steps[2].every(Boolean),ge=b.R1.price,j.result&&(j.step=4,j.result=j.steps[3].every(Boolean),j.result&&(ge=b.xBox.R.price))));const pe=`${U?$?1:0:2}${te?F?1:0:2}${se?z?1:0:2}`,ye=w.rEp,Ae=c(n.price,ye,_),be=b.breakIndexs[1]??ce,De=parseInt((be-w.R.index)/w.tr),Re=De>1?ye*De:ye,Ne=c(n.price,Re,_);return{progress:j,timeMark:he,info:{rEpr1:w.rEpr,rEpr2:L.rEpr,rEpr3:b.rEpr,entry:ge,pStatus:pe,x:Ae,X:ye,y:Ne,Y:Re}}}function h({phase:t,start:n,end:T,breakPrices:f,retracementPrice:_}){let w=e.cloneDeep(n),L=e.cloneDeep(T);const b=L.price>w.price;let $={},F={},z={},U=[null,null],te,se,ie;const re=s.pickTimeToolRef.get();return s.prices.filter(q=>{let Q=q.time>=w.time;return re&&(Q&=q.time<=re),Q}).every((q,Q)=>{const X=q.value,ne=s.timeToIndex(q.time);return ne===-1?!1:(Q===0&&($={R:{index:ne,price:X},S:{index:ne,price:X},pr:0,tr:0},F=e.cloneDeep($),z=e.cloneDeep($)),e.cmp(X,b,$.R.price)?($.pr>0&&(($.pr>F.pr||$.pr===F.pr&&$.tr>=F.tr)&&(F.pr=$.pr,F.R=e.cloneDeep($.R),F.S=e.cloneDeep($.S)),$.tr>F.tr&&(F.tr=$.tr),t===1&&_&&!e.cmp($.S.price,!b,_)&&$.tr>=z.tr&&$.pr>=z.pr&&(z=e.cloneDeep($))),$={R:{index:ne,price:X},S:{index:ne,price:X},pr:0,tr:0},t===3&&f&&(!U[0]&&e.cmp(X,b,f[0])&&(U[0]=ne),!U[1]&&e.cmp(X,b,f[1])&&(U[1]=ne))):($.S.index=ne,$.tr=$.S.index-$.R.index,e.cmp(X,!b,$.S.price)&&($.S.price=X,$.pr=e.fmtNum($.S.price-$.R.price,1,!0))),e.cmp(X,!b,w.price)?($.S.price=w.price,!1):!!e.cmp(X,!b,L.price))}),e.isSet($)&&(w.index=s.timeToIndex(w.time),L.index=$.S.index,L.time=s.indexToTime($.S.index),te=e.fmtNum(L.price-F.R.price,1,!0),se=e.fmtNum(w.price-F.S.price,1,!0),ie=L.index-F.S.index,t===3&&(z=$)),{tr:F.tr,pr:F.pr,rEp:te,sEp:se,rEpr:F.pr?e.fmtNum(te/F.pr):0,rEt:ie,S1:F.S,R1:F.R,xBox:z,S:w,R:L,breakIndexs:U}}function i({A:{time:t}}){return t>=s.prices[0].time&&t<s.prices.at(-1).time}function c(t,n,T){const f=t+(T?1:-1)*n;let _=e.fmtNum(f%1);if(T){if(_>=.1&&_<=.2)return Math.floor(f);if(_>=.6&&_<=.7)return Math.floor(f)+.5}else{if(_>=.8&&_<=.9)return Math.ceil(f);if(_>=.3&&_<=.4)return Math.floor(f)+.5}return f}function m(){if(s.pickTimeToolRef.get())return!1;const n=a.B.price-a.A.price>0,T=s.prices.at(-1).value;if(e.cmp(T,!n,a.C.price)){let f=T;for(let _=s.prices.length-1;_>=0;_--){const w=s.prices[_].value;if(w===a.B.price)break;f=n?Math.min(f,w):Math.max(f,w)}a.C.price=f,d()}}function d(t=!1){let n={isRemove:t,name:"pattern",points:[],data:[]};t?a={}:Object.entries(a).forEach(([T,f])=>{n.points.push(T),n.data.push(f)}),u.dispatch("tradingDerivative/drawTools",n)}function O(){d(!0),s.pickTimeToolRef.remove(),C(),y("setProgress",{})}function C(){e.isSet(v.A)&&(s.priceSeries.removePriceLine(v.A),e.isSet(v.B)&&(s.priceSeries.removePriceLine(v.B),e.isSet(v.C)&&(s.priceSeries.removePriceLine(v.C),s.priceSeries.removePriceLine(v.D),s.priceSeries.removePriceLine(v.X),s.priceSeries.removePriceLine(v.Y)))),v={},g([])}function g(t){const n=["#F44336","#F44336","#4CAF50","#FFEB3B","#FFEB3B","#2196F3"];let T=[];for(let f=0;f<t.length;f++){let _=s.indexToTime(t[f]);_&&(t.indexOf(t[f])!==t.lastIndexOf(t[f])&&(_+=f),T.push({time:_,value:1,color:n[f]}))}T.length&&T.sort((f,_)=>f.time-_.time),s.timeMarkSeries.setData(T)}function r({lineOptions:t}){if(e.isSet(v.C)){let n,T;a={A:{time:a.A.time,price:+v.A.options().price},B:{price:+v.B.options().price},C:{price:+v.C.options().price}},d();const{progress:f,timeMark:_,info:{rEpr1:w,rEpr2:L,rEpr3:b,entry:$,pStatus:F,x:z,X:U,y:te,Y:se}}=o();y("setProgress",f),g(_),n="A",T={title:`A ${w}`},v[n].applyOptions(T),n="B",T={title:`B ${L}`},v[n].applyOptions(T),n="C",T={title:`C ${b}`},v[n].applyOptions(T),n="D",T={price:$,title:"Entry "+F},t.point===n&&delete T.price,v[n].applyOptions(T),n="X",T={price:e.fmtNum(z),title:`X ${e.fmtNum(U)}`},v[n].applyOptions(T),n="Y",T={price:e.fmtNum(te),title:`Y ${e.fmtNum(se)}`},v[n].applyOptions(T)}}return(t,n)=>(H(),K("div",{ref_key:"patternToolRef",ref:k,class:"command",title:t.$t("trading.derivative.patternTool"),onClick:A,onContextmenu:V},Kt,40,Qt))}},ti=["title"],ii=M("i",{class:"far fa-pipe"},null,-1),ni=[ii],si={__name:"PickTimeTool",props:["pickTimeSeries"],emits:["refreshPattern","hideContext"],setup(E,{expose:N,emit:x}){const u=me(),e=E,s=x,y=B(null),k=le(()=>u.state.tradingDerivative.tools.pickTime);let P=null;N({isSelected:a,draw:V,remove:Y,get:v}),ve(k,I=>{I&&Z(I[0])});function a(){return y.value.classList.contains("selected")}function v(){return P}function S(I){s("hideContext");const p=I.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(o=>o.classList.remove("selected")),p||I.target.classList.add("selected")}function A(I){I.target.classList.remove("selected"),Y(),s("refreshPattern")}function V({time:I}){u.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"pickTime",points:[0],data:[I]}),Z(I),s("refreshPattern"),y.value.classList.remove("selected")}function Z(I){P=I,e.pickTimeSeries.setData([{time:I,value:1,color:"#9C27B0"}])}function Y(I=!0){I&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"pickTime"}),e.pickTimeSeries.setData([]),P=null}return(I,p)=>(H(),K("div",{ref_key:"pickTimeToolRef",ref:y,class:"command",title:I.$t("trading.derivative.pickTimeTool"),onClick:S,onContextmenu:A},ni,40,ti))}};const ri={class:"input"},oi={class:"color"},ai=["onClick"],ci={__name:"LineContext",props:["enable","title","color"],emits:["update:title","update:color"],setup(E,{emit:N}){const x=E,u=N,e=B(null),s=B(["#F44336","#FF9800","#FFEB3B","#4CAF50","#009688","#00BCD4","#2196F3","#673AB7","#9C27B0","#E91E63"]);ve(()=>x.enable,a=>{a&&kt().then(()=>e.value.instance.focus())});function y({value:a}){u("update:title",a)}function k(a){u("update:color",a)}function P(){u("deleteAllLine")}return(a,v)=>{const S=st("DxButton");return H(),He(Je,{class:"line-context"},{default:ze(()=>[M("div",ri,[ee(ot(Et),{ref_key:"titleRef",ref:e,value:x.title,"show-clear-button":!0,"input-attr":{style:`color:${x.color}`},onValueChanged:y},null,8,["value","input-attr"]),ee(S,{icon:"trash",type:"danger",onClick:v[0]||(v[0]=A=>P())})]),M("div",oi,[(H(!0),K(We,null,Ze(s.value,(A,V)=>(H(),K("div",{class:"color-swatch",style:_t({background:A,boxShadow:`0 0 4px ${A}`}),key:V,onClick:Z=>k(A)},null,12,ai))),128))])]),_:1})}}},li=["title"],pi=M("i",{class:"far fa-horizontal-rule"},null,-1),ui={__name:"LineTool",props:["priceSeries"],emits:["hideContext"],setup(E,{expose:N,emit:x}){const u=me(),e=E,s=x,y=B(null),k=B(!1),P=le(()=>u.state.tradingDerivative.tools.line),a=B(""),v=B("#F44336");let S=[];N({isSelected:A,hide:V,draw:I,drag:i}),ve(P,c=>{c&&p(c)});function A(){return y.value.classList.contains("selected")}function V(){k.value=!1}function Z(c){s("hideContext");const m=c.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(d=>d.classList.remove("selected")),m||c.target.classList.add("selected")}function Y(c){const m=k.value;s("hideContext"),k.value=!m}function I({price:c}){const m="line",d=S.length;if(S=S.filter(O=>{const C=O.options(),g=C.type=c===+C.price;return g&&(e.priceSeries.removePriceLine(O),u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:m,point:c})),!g}),S.length===d){const O=v.value,C=a.value,g={lineType:m,price:c,color:O,title:C,lineWidth:1,lineStyle:1,draggable:!0};S.push(e.priceSeries.createPriceLine(g)),u.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:m,points:[c],data:[{color:O,title:C}]})}y.value.classList.remove("selected")}function p(c){h(!1),o(c)}function o(c){const d={lineType:"line",lineWidth:1,lineStyle:1,draggable:!0};Object.entries(c).forEach(([O,{color:C,title:g}])=>{d.price=+O,d.color=C,d.title=g,S.push(e.priceSeries.createPriceLine(d))})}function h(c=!0){S.length>0&&(c&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line"}),S.forEach(m=>e.priceSeries.removePriceLine(m)),S=[])}function i({lineOptions:c,oldPrice:m,newPrice:d}){u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line",point:m});const O=c.color,C=c.title;u.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"line",points:[d],data:[{color:O,title:C}]}),y.value.classList.remove("selected")}return(c,m)=>(H(),K("div",{ref_key:"lineToolRef",ref:y,class:"context command",title:c.$t("trading.derivative.lineTool"),onClick:Z,onContextmenu:Y},[pi,xe(ee(ci,{class:"contextmenu",enable:k.value,title:a.value,"onUpdate:title":m[0]||(m[0]=d=>a.value=d),color:v.value,"onUpdate:color":m[1]||(m[1]=d=>v.value=d),onDeleteAllLine:h},null,8,["enable","title","color"]),[[_e,k.value]])],40,li))}},di=["title"],fi=M("i",{class:"far fa-grip-lines-vertical"},null,-1),mi=[fi],vi={__name:"TimeRangeTool",props:["timeRangeSeries","timeToIndex","indexToTime"],emits:["hideContext"],setup(E,{expose:N,emit:x}){const u=me(),e=fe("mf"),s=E,y=x,k=B(null),P=le(()=>u.state.tradingDerivative.tools.timeRange);let a=[];N({isSelected:v,draw:V}),ve(P,p=>{p&&Z(p)});function v(){return k.value.classList.contains("selected")}function S(p){y("hideContext");const o=p.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(h=>h.classList.remove("selected")),o||p.target.classList.add("selected")}function A(p){I(),p.target.classList.remove("selected")}function V({time:p}){let o={isRemove:!1,name:"timeRange",points:[],data:[]},h={time:p,value:1};switch(a.length){case 0:h.color="OrangeRed",a[0]=h,o.points.push(0),o.data.push(p);break;case 1:h.color="lime",a[1]=h,o.points.push(1),o.data.push(p),k.value.classList.remove("selected");break;default:const i=s.timeToIndex(a[0].time),c=s.timeToIndex(a[1].time),d=s.timeToIndex(p)+(c-i),O=s.indexToTime(d);h.color="OrangeRed",a[0]=e.cloneDeep(h),o.points.push(0),o.data.push(p),h.time=O,h.color="lime",a[1]=h,o.points.push(1),o.data.push(O),k.value.classList.remove("selected");break}s.timeRangeSeries.setData(a),u.dispatch("tradingDerivative/drawTools",o)}function Z(p){I(!1),Y(p)}function Y(p){let o,h;if(p.length===2)o=p[0],h=p[1];else if(p.length===3){const c=s.timeToIndex(p[0]),m=s.timeToIndex(p[1]),O=s.timeToIndex(p[2])+(m-c);o=p[2],h=s.indexToTime(O)}else return!1;let i=[{time:o,value:1,color:"OrangeRed"},{time:h,value:1,color:"lime"}];a=i,s.timeRangeSeries.setData(i)}function I(p=!0){p&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"timeRange"}),s.timeRangeSeries.setData([]),a=[]}return(p,o)=>(H(),K("div",{ref_key:"timeRangeToolRef",ref:k,class:"command",title:p.$t("trading.derivative.timeRangeTool"),onClick:S,onContextmenu:A},mi,40,di))}},hi=["title"],gi=M("i",{class:"far fa-line-height"},null,-1),Si=[gi],yi={__name:"TargetTool",props:["priceSeries"],emits:["hideContext"],setup(E,{expose:N,emit:x}){const u=me(),e=fe("mf"),s=E,y=x,k=B(null),P=le(()=>u.state.tradingDerivative.tools.target);let a={};N({isSelected:v,draw:V,drag:p}),ve(P,o=>{o&&Z(o)});function v(){return k.value.classList.contains("selected")}function S(o){y("hideContext");const h=o.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),h||(o.target.classList.add("selected"),I())}function A(o){I(),o.target.classList.remove("selected")}function V({price:o}){const h="target";let i={lineType:h,price:o,lineWidth:1,lineStyle:1,draggable:!0},c={isRemove:!1,name:h,points:[],data:[o]};if(e.isSet(a.A)){const m=+a.A.options().price,d=o-m;i.point="B",i.title=e.fmtNum(d),i.color="#F44336",a[i.point]=s.priceSeries.createPriceLine(i),c.points.push(i.point),i.point="X",i.price=e.fmtNum(m-.5*d),i.title=e.fmtNum(-.5*d),i.color="#2196F3",a[i.point]=s.priceSeries.createPriceLine(i),i.point="Y",i.price=e.fmtNum(m-d),i.title=e.fmtNum(-d),i.color="#673AB7",a[i.point]=s.priceSeries.createPriceLine(i),i.point="Z",i.price=e.fmtNum(m-2*d),i.title=e.fmtNum(-2*d),i.color="#9C27B0",a[i.point]=s.priceSeries.createPriceLine(i),i.point="W",i.price=e.fmtNum(m-4*d),i.title=e.fmtNum(-4*d),i.color="#E91E63",a[i.point]=s.priceSeries.createPriceLine(i),k.value.classList.remove("selected")}else i.point="A",i.title="0",i.color="#FF9800",a[i.point]=s.priceSeries.createPriceLine(i),c.points.push(i.point);u.dispatch("tradingDerivative/drawTools",c)}function Z(o){I(!1),Y(o)}function Y(o){let i={lineType:"target",lineWidth:1,lineStyle:1,draggable:!0};const c=o.A,m=o.B,d=m-c;i.point="A",i.price=c,i.title="0",i.color="#FF9800",a[i.point]=s.priceSeries.createPriceLine(i),i.point="B",i.price=m,i.title=e.fmtNum(d),i.color="#F44336",a[i.point]=s.priceSeries.createPriceLine(i),i.point="X",i.price=e.fmtNum(c-.5*d),i.title=e.fmtNum(-.5*d),i.color="#2196F3",a[i.point]=s.priceSeries.createPriceLine(i),i.point="Y",i.price=e.fmtNum(c-d),i.title=e.fmtNum(-d),i.color="#673AB7",a[i.point]=s.priceSeries.createPriceLine(i),i.point="Z",i.price=e.fmtNum(c-2*d),i.title=e.fmtNum(-2*d),i.color="#9C27B0",a[i.point]=s.priceSeries.createPriceLine(i),i.point="W",i.price=e.fmtNum(c-4*d),i.title=e.fmtNum(-4*d),i.color="#E91E63",a[i.point]=s.priceSeries.createPriceLine(i)}function I(o=!0){o&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"target"}),e.isSet(a.A)&&(s.priceSeries.removePriceLine(a.A),e.isSet(a.B)&&(s.priceSeries.removePriceLine(a.B),s.priceSeries.removePriceLine(a.X),s.priceSeries.removePriceLine(a.Y),s.priceSeries.removePriceLine(a.Z),s.priceSeries.removePriceLine(a.W))),a={}}function p({lineOptions:o,newPrice:h}){if(e.isSet(a.B)){let i={isRemove:!1,name:"target",points:[],data:[]},c,m,d=+a.A.options().price,O=+a.B.options().price,C=O-d;if(c="A",o.point==="A")C=+a.B.options().title,O=d+C;else if(o.point!=="B"){let g=0;switch(o.point){case"X":g=1.5;break;case"Y":g=2;break;case"Z":g=3;break;case"W":g=5;break}C=e.fmtNum((O-h)/g),d=O-C,m={price:d},a[c].applyOptions(m)}i.points.push(c),i.data.push(d),c="B",m={price:O,title:e.fmtNum(C)},o.point===c&&delete m.price,a[c].applyOptions(m),i.points.push(c),i.data.push(O),c="X",m={price:e.fmtNum(d-.5*C),title:e.fmtNum(-.5*C)},o.point===c&&delete m.price,a[c].applyOptions(m),c="Y",m={price:e.fmtNum(d-C),title:e.fmtNum(-C)},o.point===c&&delete m.price,a[c].applyOptions(m),c="Z",m={price:e.fmtNum(d-2*C),title:e.fmtNum(-2*C)},o.point===c&&delete m.price,a[c].applyOptions(m),c="W",m={price:e.fmtNum(d-4*C),title:e.fmtNum(-4*C)},o.point===c&&delete m.price,a[c].applyOptions(m),u.dispatch("tradingDerivative/drawTools",i)}}return(o,h)=>(H(),K("div",{ref_key:"targetToolRef",ref:k,class:"command",title:o.$t("trading.derivative.targetTool"),onClick:S,onContextmenu:A},Si,40,hi))}},Ti=["title"],tt=3,it=2,xi={__name:"OrderTool",props:["position","prices","priceSeries","inSession","TIME"],emits:["getTools","showEntry","showTpSl","orderChanged","hideContext"],setup(E,{expose:N,emit:x}){const u=me(),{t:e}=Pe(),s=fe("mf"),y=E,k=x,P=B(null),a=B(!1),v=le(()=>u.state.tradingDerivative.tools.order);let S={},A={},V=!1;N({show:Y,entry:I,tpsl:p,cancel:o,cancelWithoutClose:h,scan:i,drag:O}),ve(v,g=>{g&&m(g)});function Z(){return s.isSet(A.entry)||s.isSet(A.tp)}function Y({price:g}){if(g&&y.inSession()){const r=G(ke(new Date,7));if(s.isSet(A.entry))!s.isSet(A.tp)&&y.position&&r>y.TIME.ATO&&r<y.TIME.ATC&&k("showTpSl",{side:y.position});else{let t=null,n=0;y.position?(r<y.TIME.ATO?t="ATO":r>y.TIME.ATC&&(t="ATC"),t&&(S.entry=t,n=-y.position)):r>y.TIME.ATO&&r<y.TIME.ATC&&(t=g,n=t>=y.prices.at(-1).value?1:-1,S.side=n,S.entry=t),n&&k("showEntry",{side:n,price:t})}}}function I(){if(y.inSession()){const g=G(ke(new Date,7));g<y.TIME.ATO?et(e("trading.derivative.atoOrder"),e("titles.confirm")).then(t=>{t&&u.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(n=>{n.isOk?oe.success(e("trading.derivative.atoOrderSuccess")):C(n.message)})}):g>y.TIME.ATC?et(e("trading.derivative.atcOrder"),e("titles.confirm")).then(t=>{t&&u.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(n=>{n.isOk?oe.success(e("trading.derivative.atcOrderSuccess")):C(n.message)})}):u.dispatch("tradingDerivative/executeOrder",{action:"entry",entryData:{cmd:"new",side:S.side,price:S.entry}}).then(r=>{r.isOk?(c(["entry"]),oe.success(e("trading.derivative.newEntrySuccess"))):C(r.message)})}}function p(){S.tp=S.entry+S.side*tt,S.sl=S.entry-S.side*it,u.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:S.tp},slData:{cmd:"new",price:S.sl}}).then(g=>{g.isOk?(A.entry.applyOptions({draggable:!1}),c(["tp","sl"]),oe.success(e("trading.derivative.newTpSlSuccess"))):C(g.message)})}function o(){s.isSet(A.entry)?s.isSet(A.tp)?u.dispatch("tradingDerivative/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(g=>{g.isOk?(d(["entry","tp","sl"]),oe.success(e("trading.derivative.exitSuccess"))):C(g.message)}):u.dispatch("tradingDerivative/executeOrder",{action:"entry",entryData:{cmd:"delete"}}).then(g=>{g.isOk?(d(["entry"]),oe.success(e("trading.derivative.deleteEntrySuccess"))):C(g.message)}):k("getTools")}function h(){if(y.inSession()&&y.position){const g=G(ke(new Date,7));g>y.TIME.ATC-5*60&&(a.value=!0,g>y.TIME.ATC-15&&s.isSet(A.tp)&&u.dispatch("tradingDerivative/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(r=>{r.isOk?(d(["entry","tp","sl"]),oe.success(e("trading.derivative.autoCancelTpSlSuccess"))):C(r.message)}))}}function i(g){if(s.isSet(A.entry)){const r=S.side>0;s.isSet(A.tp)?(s.cmp(g,r,S.tp,!0)&&(V||(V=!0,u.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"delete"}}).then(t=>{t.isOk?(d(["entry","tp","sl"]),oe.success(e("trading.derivative.deleteTpSuccess"))):C(t.message),V=!1}))),s.cmp(g,!r,S.sl,!0)&&(V||(V=!0,u.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"cancel"}}).then(t=>{t.isOk?(d(["entry","tp","sl"]),oe.success(e("trading.derivative.deleteSlSuccess"))):C(t.message),V=!1})))):s.cmp(g,r,S.entry,!0)&&(V||(V=!0,setTimeout(()=>{S.tp=S.entry+S.side*tt,S.sl=S.entry-S.side*it,u.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:S.tp},slData:{cmd:"new",price:S.sl}}).then(t=>{t.isOk?(A.entry.applyOptions({draggable:!1}),c(["tp","sl"]),oe.success(e("trading.derivative.autoNewTpSlSuccess"))):C(t.message),V=!1})},1e3)))}}function c(g,r=!0){const t="order";let n={isRemove:!1,name:t,points:[],data:[]},T,f;g.forEach(_=>{switch(_){case"entry":T="yellow",f=S.side>0?"LONG":"SHORT";break;case"tp":T="lime",f=s.fmtNum(S.tp-S.entry,1,!0);break;case"sl":T="red",f=s.fmtNum(S.sl-S.entry,1,!0);break}if(s.isSet(A[_]))A[_].applyOptions({price:S[_],title:f}),n.points.push(_),n.data.push(S[_]);else{const w={lineType:t,kind:_,side:S.side,price:S[_],color:T,lineWidth:1,lineStyle:0,title:f,draggable:!(_==="entry"&&S.tp)};A[_]=y.priceSeries.createPriceLine(w),_==="entry"&&(n.points.push("side"),n.data.push(S.side)),n.points.push(_),n.data.push(S[_])}}),r&&u.dispatch("tradingDerivative/drawTools",n),k("orderChanged",Z())}function m(g){S=s.cloneDeep(g);let r=["entry"];"tp"in S&&r.push("tp","sl"),d(["entry","tp","sl"],!1),c(r,!1),k("orderChanged",Z())}function d(g,r=!0){r&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"order"}),g.forEach(t=>{s.isSet(A[t])&&(y.priceSeries.removePriceLine(A[t]),delete A[t])}),k("orderChanged",Z())}function O({line:g,lineOptions:r,oldPrice:t,newPrice:n}){if(n!==t){const T=r.kind;if(T!=="entry"||!y.position){const _=`${T}Data`,w=`change${T[0].toUpperCase()}${T.slice(1)}Success`;u.dispatch("tradingDerivative/executeOrder",{action:T,[_]:{cmd:"change",price:n}}).then(L=>{L.isOk?(S[T]=n,c([T]),oe.success(e(`trading.derivative.${w}`))):(g.applyOptions({price:t}),C(L.message))})}else g.applyOptions({price:t}),oe.show(e("trading.derivative.noChangeOrderLine"))}}function C(g){g||(g="unknown"),oe.error(e(`trading.derivative.${g}`))}return(g,r)=>(H(),K("div",{ref_key:"orderToolRef",ref:P,class:"cancel-order command",title:g.$t("trading.derivative.orderTool"),onClick:o},[M("i",{class:ae(["far fa-trash-alt",{blink:a.value}])},null,2)],8,Ti))}};const Ci=["title"],ki=["title"],_i=["title"],wi=["title"],bi=M("i",{class:"far fa-angle-double-right"},null,-1),Di=[bi],Ri="wss://tradestation.fireant.vn/quote?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",Ei="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",Ii={__name:"Chart",setup(E,{expose:N}){const x=me(),u=Dt(),{t:e}=Pe(),s=fe("mf"),y=fe("devices"),k=fe("filters"),P=B(null),a=B(null),v=B(null),S=B(null),A=B(null),V=B(null),Z=B(null),Y=B(null),I=B(null),p=B(null),o=B(null),h=B(null),i=B(null),c=B(null),m=B(null),d=B(null),O={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.25,bottom:.25}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:1e3,minBarSpacing:.01,barSpacing:.05}},C=$e(new Date,"yyyy-MM-dd"),g={START:G(new Date(`${C}T08:45:00Z`)),ATO:G(new Date(`${C}T09:00:00Z`)),ATC:G(new Date(`${C}T14:30:00Z`)),END:G(new Date(`${C}T14:45:00Z`))};let r={chart:{},whitespaces:[],crosshair:{},interval:null,refreshAt:Ve(new Date,11),statusAt:Ve(new Date,21),websocket:null,socketStop:!1,vpsUpdatedAt:Ve(new Date,61)};const t=wt({prices:[],series:{},chartDate:u.query.date??C,clock:$e(new Date,"HH:mm:ss"),chartHeightEnough:!1,isSocketWarning:!1,hasOrderLine:!1,TIME:g}),n=le(()=>x.state.tradingDerivative.status),T=le(()=>x.state.tradingDerivative.config),f=le(()=>x.state.tradingDerivative.isLoading),_=le(()=>n.value.position||n.value.pending||t.hasOrderLine);r.interval=setInterval(()=>{t.clock=$e(new Date,"HH:mm:ss"),Ee()&&(c.value&&c.value.cancelWithoutClose(),Me(new Date,new Date(r.refreshAt))>10&&(T.value.autoRefresh&&I.value.refresh(!0),r.refreshAt=new Date),Me(new Date,new Date(r.statusAt))>20&&(qe(),r.statusAt=new Date))},1e3),ft(),Ye(()=>{te(),w(),new ResizeObserver(U).observe(P.value),document.addEventListener("keydown",re)}),nt(()=>{L(),document.removeEventListener("keydown",re),clearInterval(r.interval),ce(),r.socketStop=!0}),ve(()=>x.state.tradingDerivative.chartData,q),N({connectSocket:he});function w(){r.chart=Lt(a.value,O),r.chart.subscribeCrosshairMove(se),r.chart.subscribeCustomPriceLineDragged(ie),t.series.whitespace=r.chart.addHistogramSeries({priceScaleId:"whitespace",scaleMargins:{top:0,bottom:0},color:"#808080",lastValueVisible:!1,priceLineVisible:!1}),t.series.timeRange=r.chart.addHistogramSeries({priceScaleId:"timeRange",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),t.series.pickTime=r.chart.addHistogramSeries({priceScaleId:"pickTime",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),t.series.timeMark=r.chart.addHistogramSeries({priceScaleId:"timeMark",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),t.series.price=r.chart.addLineSeries({color:"#F5F5F5",priceFormat:{minMove:.1}})}function L(){r.chart&&(r.chart.remove(),r.chart=null)}function b(l){pe(),be(!1),Y.value.isSelected()?Y.value.draw({time:r.crosshair.time}):I.value.isSelected()?I.value.draw({time:r.crosshair.time,price:Oe(r.crosshair.y)}):p.value.isSelected()?p.value.draw({time:r.crosshair.time}):o.value.isSelected()?o.value.draw({price:Oe(r.crosshair.y)}):h.value.isSelected()?h.value.draw({time:r.crosshair.time}):i.value.isSelected()&&i.value.draw({price:Oe(r.crosshair.y)})}function $(l){be(!0),l.preventDefault()}function F(l){l.stopPropagation()}function z(l){l.preventDefault(),l.stopPropagation()}function U(){P.value&&(te(),r.chart.resize(P.value.offsetWidth,P.value.offsetHeight),P.value.classList.contains("fullscreen")&&A.value.setFullscreen())}function te(){t.chartHeightEnough=P.value.offsetHeight>700}function se(l){if(l.time){let R=l.seriesPrices.get(t.series.price);r.crosshair.time=l.time,r.crosshair.price=R}else y.phone||(r.crosshair.time=null,r.crosshair.price=null);l.point!==void 0&&(r.crosshair.x=l.point.x,r.crosshair.y=l.point.y)}function ie(l){let R=l.customPriceLine,D=R.options();D.price=s.fmtNum(D.price);const W=+l.fromPriceString,J=D.price;switch(D.lineType){case"order":c.value.drag({line:R,lineOptions:D,oldPrice:W,newPrice:J});break;case"line":o.value.drag({lineOptions:D,oldPrice:W,newPrice:J});break;case"target":i.value.drag({lineOptions:D,newPrice:J});break;case"pattern":I.value.drag({lineOptions:D});break}}function re({ctrlKey:l,altKey:R,key:D}){const W=r.chart.timeScale(),J=r.chart.options().timeScale.barSpacing;switch(D){case"[":l?W.applyOptions({barSpacing:J-.01}):R&&W.scrollToPosition(W.scrollPosition()-50);break;case"]":l?W.applyOptions({barSpacing:J+.01}):R&&W.scrollToPosition(W.scrollPosition()+50);break}}function q(l){t.chartDate===C&&Ee()||(l.price.length>0&&(r.whitespaces=ne(r.whitespaces,X(t.chartDate))),t.series.whitespace.setData(r.whitespaces),t.prices=ne(t.prices,l.price),t.series.price.setData(t.prices))}function Q(l,R=null){const D=R??T.value.source;let W=[];l.forEach(J=>{let ue,de;D==="FireAnt"?(ue=G(ke(new Date(J.date),7)),de=J.price):(ue=G(new Date(`${C}T${J.time}Z`)),de=J.lastPrice),W.push({time:ue,value:de})}),W.length>1?(t.prices=ne(t.prices,W),t.series.price.setData(t.prices)):(t.prices.push(W[0]),t.series.price.update(W[0]))}function X(l){const R=G(new Date(`${l}T09:00:00Z`)),D=G(new Date(`${l}T11:30:00Z`)),W=G(new Date(`${l}T13:00:00Z`)),J=G(new Date(`${l}T14:30:00Z`)),ue=G(new Date(`${l}T14:00:00Z`));let de=[];for(let Se=R;Se<=J;Se++){if(Se>D&&Se<W)continue;let Ge={time:Se};(Se===ue||Se===J)&&(Ge.value=1),de.push(Ge)}return de}function ne(l,R){return Array.from(new Map([...l,...R].sort((D,W)=>D.time-W.time).map(D=>[D.time,D])).values())}async function he(){if(Ee()){await ce();const l=T.value.source==="FireAnt",R=l?Ri:Ei;r.websocket=new WebSocket(R),r.websocket.onclose=D=>{r.socketStop||(t.isSocketWarning=!0,he())},l?ge():(je(),we())}}async function ce(){r.websocket&&r.websocket.readyState===WebSocket.OPEN&&(r.websocket.close(),await new Promise(l=>{const R=setInterval(()=>{(!r.websocket||r.websocket.readyState===WebSocket.CLOSED)&&(r.websocket=null,clearInterval(R),l())},100)}))}function ge(){x.dispatch("tradingDerivative/setLoading",!0),r.websocket.onopen=l=>{if(r.websocket.readyState===WebSocket.OPEN){let R='{"protocol":"json","version":1}';r.websocket.send(R),R='{"arguments":["VN30F1M"],"invocationId":"0","target":"SubscribeTrades","type":1}',r.websocket.send(R)}},r.websocket.onmessage=l=>{t.isSocketWarning=!1,j(l.data).forEach(D=>{if(!D)return!1;D.type===3?(D.result[0].date.slice(0,10)===C&&(Le(),r.whitespaces=ne(r.whitespaces,X(C)),t.series.whitespace.setData(r.whitespaces),Q(D.result)),x.dispatch("tradingDerivative/setLoading",!1)):D.type===1&&D.target==="UpdateTrades"&&D.arguments[0]==="VN30F1M"&&(console.log("FireAnt",D.arguments[1]),c.value.scan(D.arguments[1].at(-1).price),Q(D.arguments[1]))})}}function j(l){let R=[];return l.split("").forEach(D=>{const W=D.indexOf("{"),J=D.lastIndexOf("}");let ue=null;if(W!==-1&&J!==-1&&J>W){const de=D.substring(W,J+1);de!=="{}"&&(ue=JSON.parse(de))}R.push(ue)}),R}function we(){r.websocket.onopen=l=>{if(r.websocket.readyState===WebSocket.OPEN){const R={action:"join",list:T.value.vn30f1m},D=`42${JSON.stringify(["regs",JSON.stringify(R)])}`;r.websocket.send(D)}},r.websocket.onmessage=l=>{if(t.isSocketWarning=!1,l.data.substr(0,1)==="4"&&l.data.substr(1,1)==="2"){const R=JSON.parse(l.data.substr(2));if(R[0]==="stockps"){const D=R[1].data;D.id===3220&&(console.log("VPS",D),c.value.scan(D.lastPrice),Q([D]))}}}}function je(){Me(new Date,new Date(r.vpsUpdatedAt))>60&&(fetch("https://bddatafeed.vps.com.vn/getpschartintraday/VN30F1M").then(l=>l.json()).then(l=>{console.log(l),Q(l,"VPS")}),r.vpsUpdatedAt=new Date)}function Ue(l){I.value.load(l,{isSave:!0})}function Ie(){I.value.refresh()}function pe(){Z.value.hide(),Y.value.hide(),o.value.hide()}function ye(l){y.phone||Z.value.hide(s.isSet(l)),Z.value.set(l)}function Ae(l){t.hasOrderLine=l}function be(l){l?c.value.show({price:Oe(r.crosshair.y)}):(m.value.style.display="none",d.value.style.display="none")}function De({side:l,price:R}){m.value.style.left=+(r.crosshair.x+(r.crosshair.x>innerWidth-71?-71:1))+"px",m.value.style.top=+(r.crosshair.y+(r.crosshair.y>innerHeight-61?-61:1))+"px",m.value.style.background=l>0?"green":"red",m.value.innerText=`${l>0?"LONG":"SHORT"} ${R}`,m.value.style.display="block"}function Re({side:l}){d.value.style.left=+(r.crosshair.x+(r.crosshair.x>innerWidth-61?-61:1))+"px",d.value.style.top=+(r.crosshair.y+(r.crosshair.y>innerHeight-51?-51:1))+"px",d.value.style.background=l>0?"green":"red",d.value.style.display="block"}function Ne(){c.value.entry()}function lt(){c.value.tpsl()}function pt(){r.chart.timeScale().scrollToRealTime()}function Ee(){const l=G(ke(new Date,7));return T.value.openingMarket&&l>=g.START&&l<=g.END}function ut(){if(!t.chartDate)return!1;Be()}function dt(){r.whitespaces=[],t.prices=[],he(),Be()}function ft(){x.dispatch("tradingDerivative/initChart").then(()=>{he(),!u.query.date&&T.value.lastOpeningDate&&(t.chartDate=T.value.lastOpeningDate),Be()})}function Be(){x.dispatch("tradingDerivative/getChartData",t.chartDate).then(l=>{l&&Le()})}function qe(){x.dispatch("tradingDerivative/getStatus")}function Le(){x.dispatch("tradingDerivative/getTools")}function mt(){x.dispatch("tradingDerivative/getAccountInfo").then(l=>{let R="";R+='<div style="width: 200px;">',R+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.nav")}</div><div>: ${k.currency(l.nav)}</div></div>`,R+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.maxVol")}</div><div>: ${k.numberVnFormat(l.maxVol)}</div></div>`,R+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.vm")}</div><div>: ${k.currency(l.vm)}</div></div>`,R+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.fee")}</div><div>: ${k.currency(l.fee)}</div></div>`,R+="</div>",Rt(R,e("trading.derivative.accountInfo"))})}function Oe(l){return s.fmtNum(t.series.price.coordinateToPrice(l))}function Fe(l){let R=r.whitespaces.findIndex(D=>D.time===l);if(R===-1){const D=$e(new Date(l*1e3),"yyyy-MM-dd"),W=G(new Date(`${D}T11:30:00Z`)),J=G(new Date(`${D}T13:00:00Z`)),ue=G(new Date(`${D}T14:30:00Z`));l>W&&l<J?l=W:l>ue&&(l=ue),R=r.whitespaces.findIndex(de=>de.time===l)}return R}function Qe(l){return l<r.whitespaces.length?r.whitespaces[l].time:!1}return(l,R)=>(H(),K("div",{ref_key:"chartContainerRef",ref:P,class:"derivative-chart",onClick:b,onContextmenu:$},[M("div",{ref_key:"chartRef",ref:a},null,512),M("div",{class:"area data-area",onClick:F,onContextmenu:z},[M("div",{ref_key:"connectionRef",ref:v,class:ae(["command",{yellow:n.value.pending,red:T.value.volInvalid}]),title:l.$t("trading.derivative.connection"),onClick:qe},[M("i",{class:ae(["far",{"fa-link-simple":n.value.connection,"fa-link-simple-slash":!n.value.connection,blink:t.isSocketWarning}])},null,2)],10,Ci),M("div",{class:ae(["command status",{green:n.value.position>0,red:n.value.position<0}]),title:l.$t("trading.derivative.position"),onClick:mt},Te(n.value.position),11,ki),M("div",{class:"command clock",onClick:he},Te(t.clock),1),xe(M("input",{type:"date",class:"chart-date command",title:l.$t("trading.derivative.date"),"onUpdate:modelValue":R[0]||(R[0]=D=>t.chartDate=D),onChange:ut},null,40,_i),[[bt,t.chartDate]]),M("div",{ref_key:"reloadToolRef",ref:S,class:"command",title:l.$t("trading.derivative.reload"),onClick:dt,onContextmenu:Le},[M("i",{class:ae(["far fa-sync-alt",{"fa-spin":f.value}])},null,2)],40,wi)],32),M("div",{class:"area tool-area",onClick:F,onContextmenu:z},[ee(Pt,{ref_key:"fullscreenToolRef",ref:A,chartContainerRef:P.value},null,8,["chartContainerRef"]),ee(Nt,{ref_key:"tradingviewToolRef",ref:V,vpsUser:T.value.vpsUser,vpsSession:T.value.vpsSession,chartContainerRef:P.value},null,8,["vpsUser","vpsSession","chartContainerRef"]),ee(Wt,{ref_key:"progressToolRef",ref:Z,chartHeightEnough:t.chartHeightEnough,onRefreshPattern:Ie,onHideContext:pe},null,8,["chartHeightEnough"]),ee(qt,{ref_key:"scanToolRef",ref:Y,prices:t.prices,timeToIndex:Fe,onScaned:Ue,onRemovePattern:R[1]||(R[1]=()=>I.value.remove()),onHideContext:pe},null,8,["prices"]),ee(ei,{ref_key:"patternToolRef",ref:I,prices:t.prices,priceSeries:t.series.price,timeMarkSeries:t.series.timeMark,pickTimeToolRef:p.value,timeToIndex:Fe,indexToTime:Qe,onSetProgress:ye,onHideContext:pe},null,8,["prices","priceSeries","timeMarkSeries","pickTimeToolRef"]),ee(si,{ref_key:"pickTimeToolRef",ref:p,pickTimeSeries:t.series.pickTime,onRefreshPattern:Ie,onHideContext:pe},null,8,["pickTimeSeries"]),ee(ui,{ref_key:"lineToolRef",ref:o,priceSeries:t.series.price,onHideContext:pe},null,8,["priceSeries"]),ee(vi,{ref_key:"timeRangeToolRef",ref:h,timeRangeSeries:t.series.timeRange,timeToIndex:Fe,indexToTime:Qe,onHideContext:pe},null,8,["timeRangeSeries"]),ee(yi,{ref_key:"targetToolRef",ref:i,priceSeries:t.series.price,onHideContext:pe},null,8,["priceSeries"]),xe(ee(xi,{ref_key:"orderToolRef",ref:c,position:n.value.position,prices:t.prices,priceSeries:t.series.price,inSession:Ee,TIME:t.TIME,onGetTools:Le,onShowEntry:De,onShowTpSl:Re,onOrderChanged:Ae,onHideContext:pe},null,8,["position","prices","priceSeries","TIME"]),[[_e,_.value]])],32),M("div",null,[M("div",{ref_key:"entryOrderRef",ref:m,class:"order-button entry",onClick:Ne}," Entry ",512),M("div",{ref_key:"tpslOrderRef",ref:d,class:"order-button tpsl",onClick:lt}," TP/SL ",512),M("div",{class:"chart-top",onClick:pt},Di)])],544))}};export{Ii as default};
