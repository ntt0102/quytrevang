import{u as N,r as _,a as z,c as A,b as v,e as n,f as c,_ as K,n as C,p as m,F as M,h as O,k as h,l as f,o as s,d as a,g as j,q as u,t as g,P as q,s as H}from"./app-4398a943.js";import{_ as X}from"./accordion-6afd7a42.js";import{_ as G}from"./Index-4dd03f66.js";const Z={ref:"submitRef",class:"display-none"},J={class:"step1"},Q={class:"download"},W={class:"upload-browser"},Y={for:"receiptImage"},ee=a("i",{class:"far fa-file-upload"},null,-1),te={class:"is-confirmed"},oe={key:0},le={__name:"PaidContractPopup",setup(ae,{expose:k}){const P=O(),{t:I}=N(),$=h("bus"),x=h("mc"),V=h("mf"),i=_(null),b=_(null),d=_(null),e=z({refreshKey:0,contract:{},formData:{}});let p=[];const y=A(()=>new Set(e.formData.documents.map(t=>t.file)));w();function R(t){i.value.setTitle(I(`components.paidContract.${t.status==2?"confirmTitle":"title"}`)+" #"+t.code),i.value.show(),e.contract=t}function S(t){e.formData.documents=e.formData.documents.filter(o=>!o.isUpload),[...t.target.files].forEach(o=>e.formData.documents.push({file:URL.createObjectURL(o),isUpload:!0}))}function B(t){t.value?e.formData.documents=e.formData.documents.filter(o=>o.isUpload):e.formData.documents=p.concat(e.formData.documents)}function U(){$.emit("checkPin",async()=>{let t=new FormData;if(t.append("contractId",e.contract.id),t.append("isDelete",e.formData.isDelete),t.append("isConfirmed",e.formData.isConfirmed),d.value)for(var o=0;o<d.value.files.length;o++){let l=await V.resizeImage({file:d.value.files[o],maxSize:x.MAX_SIZE_IMAGE_UPLOAD});t.append(`receiptImages[${o}]`,l)}P.dispatch("adminContract/paidContract",t).then(l=>{l&&i.value.hide()})})}function w(){e.formData={isPdfPreview:!1,isDelete:!1,isConfirmed:!1,documents:[]}}function T(){e.formData.isConfirmed=!!e.contract.confirmed_by,setTimeout(()=>b.value.instance.option("selectedIndex",e.contract.status==0?0:1),500),p=e.contract.url_paid_docs.map(t=>({file:t,isUpload:!1})),e.formData.documents=p}function L(){w(),e.refreshKey++}return k({show:R}),(t,o)=>{const l=f("DxButton"),D=f("DxCheckBox"),E=f("RouterLink"),F=f("DxScrollView");return s(),v(M,null,[n(K,{ref_key:"popupRef",ref:i,class:"paid-contract-popup",toolbarItems:[{toolbar:"bottom",location:"after",widget:"dxButton",options:{text:t.$t("buttons.save"),onClick:()=>t.$refs.submitRef.click()}},{toolbar:"bottom",location:"after",widget:"dxButton",options:{text:t.$t("buttons.cancel"),onClick:()=>i.value.hide()}}],onShown:T,onHidden:L},{default:c(()=>[n(F,null,{default:c(()=>[a("form",{onSubmit:H(U,["prevent"])},[a("button",Z,null,512),n(j(X),{ref_key:"accordionRef",ref:b,collapsible:!0,selectedIndex:0,items:[{title:t.$t("components.paidContract.step1"),template:"step1Template"},{title:t.$t("components.paidContract.step2"),template:"step2Template"}]},{step1Template:c(()=>[a("div",J,[a("div",Q,[n(l,{text:t.$t("buttons.receiptDownload"),icon:"download",type:"default","styling-mode":"contained",onClick:o[0]||(o[0]=()=>t.$refs.pdfRef.download({component:"PayReceiptPdf",contract:e.contract,isPreview:e.formData.isPdfPreview}))},null,8,["text"]),t.$screen.getScreenSizeInfo.isXSmall?m("",!0):(s(),C(D,{key:0,modelValue:e.formData.isPdfPreview,"onUpdate:modelValue":o[1]||(o[1]=r=>e.formData.isPdfPreview=r),text:t.$t("components.paidContract.preview")},null,8,["modelValue","text"]))])])]),step2Template:c(()=>[(s(),v("div",{class:"upload",key:e.refreshKey},[a("div",W,[a("input",{ref_key:"receiptImageRef",ref:d,type:"file",id:"receiptImage",multiple:"multiple",accept:"images/*",onChange:S},null,544),a("label",Y,[ee,u(" "+g(t.$t("titles.chooseImage")),1)]),n(D,{id:"contractDelete",modelValue:e.formData.isDelete,"onUpdate:modelValue":o[2]||(o[2]=r=>e.formData.isDelete=r),text:t.$t("titles.deleteOldImage"),onValueChanged:B},null,8,["modelValue","text"])]),y.value.length?(s(),C(q,{key:0,images:y.value},null,8,["images"])):m("",!0)]))]),_:1},8,["items"]),a("div",te,[n(D,{modelValue:e.formData.isConfirmed,"onUpdate:modelValue":o[3]||(o[3]=r=>e.formData.isConfirmed=r),text:t.$t("components.paidContract.isConfirmed")},null,8,["modelValue","text"]),e.contract.confirmed_by?(s(),v("div",oe,[u(" ("+g(t.$t("components.paidContract.confirmedBy"))+" ",1),n(E,{to:{name:"users",query:{code:e.contract.confirmed_by}}},{default:c(()=>[u("#"+g(e.contract.confirmed_by),1)]),_:1},8,["to"]),u(") ")])):m("",!0)])],32)]),_:1})]),_:1},8,["toolbarItems"]),t.$mf.isSet(e.contract)?(s(),C(G,{key:0,ref:"pdfRef"},null,512)):m("",!0)],64)}}};export{le as default};
