import{u as j,r as x,a as G,c as y,w as J,b as Q,d as F,e as o,f as g,g as l,F as W,h as Y,i as Z,j as ee,k as h,v as B,l as te,o as b,D as n,n as E,p as I,m as ae}from"./app-4398a943.js";import{_ as q}from"./ListTagBox-13f25266.js";import oe from"./DeletedUsersPopup-9c085c1a.js";import ie from"./ConfirmUserPopup-1c707cfa.js";import{_ as le}from"./UserDetailPopup-8a6bc0da.js";import"./accordion-6afd7a42.js";import"./Index-4dd03f66.js";const se={class:"users-page content-block dx-card responsive-paddings"},ne=["src"],ge={__name:"Index",setup(re){const u=Y(),w=Z(),p=ee(),{t:a}=j(),k=h("bus"),M=h("filters"),d=h("mt"),m=h("mf"),$=h("routeHistoryState"),s=x(null),S=x(null),r=G({gridData:null,banks:[],rolesCalculateFilterExpression:function(e,i,c){return c==="search"&&typeof e=="string"?["roles","contains",e]:function(t){return(t.roles||[]).indexOf(e)!==-1}},permissionsCalculateFilterExpression:function(e,i,c){return c==="search"&&typeof e=="string"?["permissions","contains",e]:function(t){return(t.permissions||[]).indexOf(e)!==-1}},validationRules:{name:[{type:"required",message:a("models.user.name")+d.validations.required},{type:"stringLength",max:50,message:a("models.user.validations.name")}],sex:[{type:"required",message:a("models.user.sex")+d.validations.required}],role:[{type:"required",message:a("models.user.roles")+d.validations.required}],birthday:[{type:"required",message:a("models.user.birthday")+d.validations.required},{type:"custom",validationCallback:O,message:a("models.user.validations.birthday")}],idNumber:[{type:"required",message:a("models.user.idNumber")+d.validations.required},{type:"async",validationCallback:e=>u.dispatch("adminUser/validateDuplicateIdNumber",e),message:a("models.user.idNumber")+d.validations.duplicate}],idIssuedOn:[{type:"required",message:a("models.user.idIssuedOn")+d.validations.required},{type:"custom",validationCallback:_,message:a("models.user.validations.idIssuedOn")}],phone:[{type:"required",message:a("models.user.phone")+d.validations.required},{type:"async",validationCallback:e=>u.dispatch("adminUser/validateDuplicatePhone",e),message:a("models.user.phone")+d.validations.duplicate}],email:[{type:"required",message:a("models.user.email")+d.validations.required},{type:"email",message:a("models.user.email")+d.validations.email},{type:"async",validationCallback:e=>u.dispatch("adminUser/validateDuplicateEmail",e),message:a("models.user.email")+d.validations.duplicate}],address:[{type:"required",message:a("models.user.address")+d.validations.required},{type:"stringLength",max:100,message:a("models.user.validations.address")}]}}),f=y(()=>u.state.auth.user.permissions),U=y(()=>u.state.auth.user.code),C=y(()=>u.state.adminUser.allRolesName),R=y(()=>u.state.adminUser.allPermissionsName);u.dispatch("adminUser/getUsers").then(()=>m.getBanks()).then(e=>r.banks=e),J(()=>u.state.adminUser.users,e=>H(e));function N(e){e.changes.length&&k.emit("checkPin",()=>{e.isDeleted=!1,u.dispatch("adminUser/save",e)})}function P(e){e.toolbarOptions.items.unshift({visible:m.isSet(p.query),location:"before",widget:"dxButton",options:{icon:"far fa-arrow-left small",hint:a("buttons.back"),onClick:()=>{w.go(-1)}}},{locateInMenu:"auto",showText:"inMenu",location:"before",widget:"dxButton",options:{icon:"far fa-share-square small",hint:a("admin.users.buttons.sendNotification"),text:a("admin.users.buttons.sendNotification"),onClick:()=>{s.value.instance.getSelectedRowKeys().length>0?w.push({name:"setting-notification",query:{codes:s.value.instance.getSelectedRowKeys().join(",")}}):B.show(a("messages.info.noSelectedRow"))}}},{locateInMenu:"auto",showText:"inMenu",location:"before",widget:"dxButton",options:{icon:"far fa-trash small",hint:a("admin.users.buttons.selectedDelete"),text:a("admin.users.buttons.selectedDelete"),onClick:()=>{let i=s.value.instance.getSelectedRowKeys();i.length>0?(k.emit("checkPin",()=>{s.value.instance.option("editing.mode","batch"),i.forEach(c=>{s.value.instance.deleteRow(s.value.instance.getRowIndexByKey(c))}),s.value.instance.saveEditData()}),s.value.instance.option("editing.mode","popup")):B.show(a("messages.info.noSelectedRow"))}}},{locateInMenu:"auto",showText:"inMenu",location:"before",widget:"dxButton",options:{icon:"far fa-user-times small",hint:a("admin.users.deletedUsers"),text:a("admin.users.deletedUsers"),onClick:()=>S.value.show()}})}function T(e,i){var c="Â ",t=(i.value||[]).map(v=>i.column.lookup.calculateCellValue(v)).join(", ");e.textContent=t||c,e.title=t}function D(e,i){i.setValue(e),i.component.updateDimensions()}function O(e){return moment(e.value).isBefore(moment().subtract(18,"years"))}function _(e){return moment(e.value).isBefore(moment().subtract(1,"day"))}function z(e){e.data.roles=["user"],e.data.bank_account={},s.value.instance.option("editing.popup.title",a("models.user.popup.create"))}function A(e){s.value.instance.option("editing.popup.title",`${a("models.user.popup.edit")} #${e.data.code}`)}function H(e){r.gridData=m.cloneDeep(e),p.query.code&&s.value.instance.columnOption("code","filterValues",[+p.query.code]),p.query.selected&&setTimeout(()=>s.value.instance.selectRows(p.query.selected.split(","),!0),0)}function L(e){m.pushPopupToHistoryState($,()=>s.value.instance.cancelEditData())}function K(){m.popRouteHistoryState($)}function V(e){if(e.rowType==="data"){if(e.column.dataField==="level"){let i;e.value<4?i="#adadad":e.value==4?i="#edc578":i="#86c285",e.cellElement.style.color=i}e.column.dataField==="phone"&&(e.cellElement.innerHTML=M.phone(e.value))}}function X(e){e.rowType=="data"&&e.columnIndex==5&&m.openLink(`https://zalo.me/${e.data.phone}`)}return(e,i)=>{const c=te("DxToolbar");return b(),Q(W,null,[F("div",se,[o(l(ae),{ref_key:"dataGridRef",ref:s,"data-source":r.gridData,"key-expr":"code","show-borders":!0,"column-auto-width":!0,"allow-column-reordering":!0,"allow-column-resizing":!0,"column-resizing-mode":"widget","column-chooser":{enabled:!0,mode:"select",allowSearch:!0},paging:{pageSize:10},headerFilter:{visible:!0},loadPanel:{enabled:!0},selection:{mode:"multiple",showCheckBoxesMode:"always"},editing:{allowAdding:!0,allowUpdating:!0,allowDeleting:!0,confirmDelete:!1,mode:"popup",popup:{showTitle:!0,onShown:L,onHidden:K},form:{colCount:2,labelLocation:e.$screen.getScreenSizeInfo.isXSmall?"top":"left",items:[{itemType:"group",caption:e.$t("models.user.groups.personalInfo"),items:[{dataField:"name"},{dataField:"sex"},{dataField:"birthday"}]},{itemType:"group",caption:e.$t("models.user.groups.idInfo"),items:[{dataField:"identity.number"},{dataField:"identity.issued_on"},{dataField:"",editorOptions:{value:e.$mt.idIssuedAtValue,readOnly:!0},label:{text:e.$t("models.user.idIssuedAt")}}]},{colCount:2,colSpan:2,itemType:"group",caption:e.$t("models.user.groups.contactInfo"),items:[{dataField:"phone"},{dataField:"email"},{dataField:"address",colSpan:2}]},{colCount:2,colSpan:2,itemType:"group",caption:e.$t("models.user.groups.bankInfo"),items:[{dataField:"bank_account.bank_name"},{dataField:"bank_account.account_name"},{dataField:"bank_account.account_number"}]},{visible:f.value.includes("system@control"),colCount:2,colSpan:2,itemType:"group",caption:e.$t("models.user.groups.permission"),items:[{dataField:"roles",colSpan:2},{dataField:"permissions",colSpan:2}]}]}},onCellPrepared:V,onContentReady:i[0]||(i[0]=t=>e.$mf.dataGridPreload(r.gridData,s.value.instance)),onToolbarPreparing:P,onInitNewRow:z,onEditingStart:A,onCellDblClick:X,onSaved:N},{avatarCellTemplate:g(({data:t})=>[F("img",{src:t.value,width:40,style:{borderRadius:"50%"}},null,8,ne)]),roleTagBoxEditor:g(({data:t})=>[o(q,{value:t.value,"on-value-changed":v=>D(v,t),"data-source":C.value,"data-grid-component":t.component},null,8,["value","on-value-changed","data-source","data-grid-component"])]),permissionTagBoxEditor:g(({data:t})=>[o(q,{value:t.value,"on-value-changed":v=>D(v,t),"data-source":R.value,"data-grid-component":t.component},null,8,["value","on-value-changed","data-source","data-grid-component"])]),commandCellTemplate:g(({data:t})=>[o(c,{items:[{visible:[4,5].includes(t.data.level)||f.value.includes("system@control")&&t.data.level>5,locateInMenu:"auto",showText:"inMenu",location:"center",widget:"dxButton",options:{type:"default",icon:`far fa-${t.data.level==4?"check":"file-check"} small`,hint:e.$t(`components.confirmUser.${t.data.level==4?"title":"confirmedTitle"}`),text:e.$t(`components.confirmUser.${t.data.level==4?"title":"confirmedTitle"}`),onClick:()=>e.$refs.confirmUserPopupRef.show({user:t.data})}},{visible:t.data.level>=6,locateInMenu:"auto",showText:"inMenu",location:"center",widget:"dxButton",options:{type:"default",icon:"far fa-usd-circle small",hint:e.$t("admin.users.buttons.viewContract"),text:e.$t("admin.users.buttons.viewContract"),onClick:()=>e.$router.push({name:"admin-contract",query:{userCode:t.data.code}})}},{visible:!t.data.permissions.includes("system@control")||f.value.includes("system@control"),locateInMenu:"auto",showText:"inMenu",location:"center",widget:"dxButton",options:{type:"default",icon:"edit",hint:e.$t("buttons.edit"),text:e.$t("buttons.edit"),onClick:()=>s.value.instance.editRow(t.rowIndex)}},{visible:t.data.level<=6&&t.data.code!=U.value&&!t.data.permissions.includes("system@control"),locateInMenu:"auto",showText:"inMenu",location:"center",widget:"dxButton",options:{type:"default",icon:"trash",hint:e.$t("buttons.delete"),text:e.$t("buttons.delete"),onClick:()=>e.$bus.emit("checkPin",()=>s.value.instance.deleteRow(t.rowIndex))}},{locateInMenu:"auto",showText:"inMenu",location:"center",widget:"dxButton",options:{type:"default",icon:"info",hint:e.$t("admin.users.detailUser"),text:e.$t("admin.users.detailUser"),onClick:()=>e.$refs.userDetailPopupRef.show(t.data)}}]},null,8,["items"])]),default:g(()=>[o(l(n),{fixed:!0,width:e.$screen.getScreenSizeInfo.isXSmall?35:125,type:"buttons",cssClass:"dx-datagrid-command-column","cell-template":"commandCellTemplate",caption:e.$t(`titles.commandHeaderTitle${e.$screen.getScreenSizeInfo.isXSmall?"Short":""}`)},null,8,["width","caption"]),o(l(n),{width:60,"allow-sorting":!1,allowFiltering:!1,"data-field":"url_avatar","cell-template":"avatarCellTemplate",cssClass:"avatar-column",caption:e.$t("models.user.avatar")},null,8,["caption"]),o(l(n),{"allow-editing":!1,"data-field":"code","data-type":"string","header-filter":{allowSearch:!0},name:"code",caption:e.$t("models.user.codeShort")},null,8,["caption"]),o(l(n),{"allow-editing":!1,"data-field":"level",dataType:"number",caption:e.$t("models.user.status"),lookup:{dataSource:e.$mf.getUserLevelList(),displayExpr:"name",valueExpr:"value"}},null,8,["caption","lookup"]),o(l(n),{"data-field":"name","data-type":"string","header-filter":{allowSearch:!0},caption:e.$t("models.user.name"),"validation-rules":r.validationRules.name},null,8,["caption","validation-rules"]),o(l(n),{visible:!1,"data-field":"sex","data-type":"number",caption:e.$t("models.user.sex"),"validation-rules":r.validationRules.sex,lookup:{dataSource:e.$mf.getSexList(),displayExpr:"name",valueExpr:"value"}},null,8,["caption","validation-rules","lookup"]),o(l(n),{visible:!1,"data-field":"birthday","data-type":"date","editor-options":{dateSerializationFormat:e.$mc.DX_SERVER_DATE_FORMAT,showClearButton:"true",useMaskBehavior:"true"},caption:e.$t("models.user.birthday"),"validation-rules":r.validationRules.birthday},null,8,["editor-options","caption","validation-rules"]),o(l(n),{visible:!1,"data-field":"identity.number","data-type":"string","editor-options":{mask:"000000000000"},"header-filter":{allowSearch:!0},caption:e.$t("models.user.idNumber"),"validation-rules":r.validationRules.idNumber},null,8,["caption","validation-rules"]),o(l(n),{visible:!1,"data-field":"identity.issued_on","data-type":"date","editor-options":{dateSerializationFormat:e.$mc.DX_SERVER_DATE_FORMAT,showClearButton:"true",useMaskBehavior:"true"},caption:e.$t("models.user.idIssuedOn"),"validation-rules":r.validationRules.idIssuedOn},null,8,["editor-options","caption","validation-rules"]),o(l(n),{"data-field":"phone","data-type":"string","editor-options":{mask:"0000.000.000"},"header-filter":{allowSearch:!0},caption:e.$t("models.user.phone"),"validation-rules":r.validationRules.phone},null,8,["caption","validation-rules"]),o(l(n),{visible:!1,"data-field":"email","data-type":"string",name:"email","header-filter":{allowSearch:!0},caption:e.$t("models.user.email"),"validation-rules":r.validationRules.email},null,8,["caption","validation-rules"]),o(l(n),{visible:!1,"data-field":"address","data-type":"string","header-filter":{allowSearch:!0},caption:e.$t("models.user.address"),"validation-rules":r.validationRules.address},null,8,["caption","validation-rules"]),o(l(n),{visible:!1,"data-field":"bank_account.bank_name","data-type":"string",lookup:{dataSource:r.banks,displayExpr:"short_name",valueExpr:"short_name",allowClearing:!0},"header-filter":{allowSearch:!0},caption:e.$t("models.user.bankName")},null,8,["lookup","caption"]),o(l(n),{visible:!1,"data-field":"bank_account.account_name","data-type":"string","header-filter":{allowSearch:!0},caption:e.$t("models.user.accountName")},null,8,["caption"]),o(l(n),{visible:!1,"data-field":"bank_account.account_number","data-type":"string","header-filter":{allowSearch:!0},caption:e.$t("models.user.accountNumber")},null,8,["caption"]),f.value.includes("system@control")?(b(),E(l(n),{key:0,visible:!1,"allow-sorting":!1,"data-field":"roles","data-type":"string","cell-template":T,"calculate-filter-expression":r.rolesCalculateFilterExpression,caption:e.$t("models.user.roles"),"edit-cell-template":"roleTagBoxEditor","validation-rules":r.validationRules.role,lookup:{dataSource:C.value}},null,8,["calculate-filter-expression","caption","validation-rules","lookup"])):I("",!0),f.value.includes("system@control")?(b(),E(l(n),{key:1,visible:!1,"allow-sorting":!1,"data-field":"permissions","data-type":"string","cell-template":T,"calculate-filter-expression":r.permissionsCalculateFilterExpression,caption:e.$t("models.user.permissions"),"edit-cell-template":"permissionTagBoxEditor",lookup:{dataSource:R.value}},null,8,["calculate-filter-expression","caption","lookup"])):I("",!0)]),_:1},8,["data-source","editing"])]),o(oe,{ref_key:"deletedUsersPopupRef",ref:S},null,512),o(ie,{ref:"confirmUserPopupRef"},null,512),o(le,{ref:"userDetailPopupRef"},null,512)],64)}}};export{ge as default};
