import{A as rt,B as ot,C as at,r as A,y as Be,E as je,o as H,b as J,d as B,G as ae,c as he,H as ye,I as ke,J as ct,K as lt,F as Ie,L as Ne,t as Se,h as me,e as ee,u as Fe,g as qe,k as fe,w as Ae,M as pt,m as dt,N as ut,z as Je,x as se,l as Ee,a as ft,O as mt,Q as vt,j as ht,R as gt}from"./app-92bfb0d2.js";import{_ as St}from"./button-group-66e14977.js";import{_ as yt}from"./text-box-cdc8fdca.js";import{g as U}from"./getUnixTime-dc73e3ca.js";import{c as Tt}from"./lightweight-charts.esm.development-03366bac.js";function Ue(N,I,x){return rt((x==null?void 0:x.in)||N,+ot(N)+I)}function xe(N,I,x){return Ue(N,I*at,x)}function xt(N,I,x){return Ue(N,I*1e3,x)}function kt(N,I,x){return xt(N,-I,x)}const Ct=["title"],_t={__name:"FullscreenTool",props:["chartContainerRef"],setup(N){const I=N,x=A(!1);Be(()=>{document.addEventListener("fullscreenchange",n)}),je(()=>{document.removeEventListener("fullscreenchange",n)});function m(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function n(){I.chartContainerRef&&(document.fullscreenElement?(x.value=!0,I.chartContainerRef.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(x.value=!1,I.chartContainerRef.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}return(r,T)=>(H(),J("div",{class:"command",title:r.$t("trading.derivative.fullscreen"),onClick:m},[B("i",{class:ae(["far",{"fa-compress":x.value,"fa-expand":!x.value}])},null,2)],8,Ct))}},wt=["title"],Rt=["src"],bt={__name:"TradingviewTool",props:["vpsUser","vpsSession","chartContainerRef"],setup(N){const I=N,x=A(null),m=A(!1),n=he(()=>`https://chart.vps.com.vn/tv/?u=${I.vpsUser}&s=${I.vpsSession}&symbol=VN30F1M&resolution=1&lang=vi`);function r(_){m.value=!m.value,T(),_.stopPropagation()}function T(){if(I.chartContainerRef&&x.value){const{offsetWidth:_,offsetHeight:o}=I.chartContainerRef,{top:v,left:l}=x.value.getBoundingClientRect();x.value.style.top=`${v-2}px`,x.value.style.left=`${l+32}px`,x.value.style.width=`${_-34}px`,x.value.style.height=`${o}px`}}return(_,o)=>(H(),J("div",{class:"tradingview command far fa-chart-candlestick",title:_.$t("trading.derivative.tradingview"),onClick:r},[ye(B("iframe",{ref_key:"tradingviewRef",ref:x,class:"chart",src:n.value},null,8,Rt),[[ke,m.value]])],8,wt))}};const Dt=B("div",{class:"triangle-shadow"},null,-1),Et=B("div",{class:"triangle"},null,-1),Lt={class:"container"},Ot={class:"conditions"},Pt={__name:"ProgressContext",props:["progress"],setup(N){const I=A([]);Be(()=>{x()});function x(){ct(Object.assign({"../../../../../lang/vi/derivative.js":()=>lt(()=>import("./derivative-7a854992.js"),[])}),`../../../../../lang/${window.lang}/derivative.js`).then(n=>{I.value=n.default||[]})}function m(n){n.stopPropagation()}return(n,r)=>(H(),J("div",{class:"pattern-context",onClick:m},[Dt,Et,B("div",Lt,[(H(!0),J(Ie,null,Ne(I.value,(T,_)=>(H(),J("div",{key:_,class:ae(["step"])},[B("div",{class:ae(["step-header",[N.progress.steps?N.progress.steps[_].every(Boolean)?"success":"fail":""]])},Se(_+1)+". "+Se(T.name),3),B("div",Ot,[(H(!0),J(Ie,null,Ne(T.conds,(o,v)=>(H(),J("div",{key:v,class:ae(["condition",[N.progress.steps?N.progress.steps[_][v]?"success":"fail":""]])},Se(v+1)+". "+Se(o),3))),128))])]))),128))])]))}},$t=["title"],It={__name:"ProgressTool",emits:["refreshPattern","hideContext"],setup(N,{expose:I,emit:x}){const m=me(),n=x,r=A({}),T=A(!1),_=he(()=>m.state.tradingDerivative.config.autoRefresh);I({hide:v,set:l});function o(){const P=T.value;n("hideContext"),T.value=!P,T.value&&n("refreshPattern")}function v(P){T.value=P}function l(P){X(P,r.value),r.value=P}function V(P){const w=P??!w.value;m.dispatch("tradingDerivative/setAutoRefresh",w)}function X(P,w){if(_.value&&(P.step>w.step||P.step===w.step&&P.result>w.result)){let R="";P.result?[2,4,5].includes(P.step)?R=t("trading.derivative.progressOrder",P):R=t("trading.derivative.progressSuccess",P):R=t("trading.derivative.progressFail",P),M(R)}}function M(P){const w=new SpeechSynthesisUtterance(P);w.lang="vi-VN",speechSynthesis.speak(w)}return(P,w)=>(H(),J("div",{class:ae(["context command",{green:r.value.result===!0,red:r.value.result===!1}]),title:P.$t("trading.derivative.progressTool"),onClick:o,onContextmenu:V},[B("i",{class:ae(["far",{"fa-badge-check":!r.value.step,[`fa-circle-${r.value.step}`]:r.value.step,blink:_.value}])},null,2),ye(ee(Pt,{class:"contextmenu",progress:r.value},null,8,["progress"]),[[ke,T.value]])],42,$t))}};const Nt=B("div",{class:"triangle-shadow"},null,-1),At=B("div",{class:"triangle"},null,-1),Bt={__name:"ScanContext",props:["modelValue"],emits:["update:modelValue"],setup(N,{emit:I}){const{t:x}=Fe(),m=[{icon:"chevrondoubleleft",side:"left",text:x("trading.derivative.scanContext.leftScan")},{icon:"chevrondoubleright",side:"right",text:x("trading.derivative.scanContext.rightScan")}],n=N,r=I;function T({itemData:{side:o}}){r("update:modelValue",o)}function _(o){o.stopPropagation()}return(o,v)=>(H(),J("div",{class:"scan-context",onClick:_},[Nt,At,ee(qe(St),{items:m,"selected-item-keys":[n.modelValue],"key-expr":"side","styling-mode":"outlined",onItemClick:T},null,8,["selected-item-keys"])]))}},Ft=["title"],Vt={__name:"ScanTool",props:["prices","timeToIndex"],emits:["scaned","removePattern","hideContext"],setup(N,{expose:I,emit:x}){const m=fe("mf"),n=N,r=x,T=A(null),_=A(!1),o=A("left");I({isSelected:v,hide:l,draw:M});function v(){return T.value.classList.contains("selected")}function l(u){_.value=u}function V(u){r("hideContext");const y=u.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(s=>s.classList.remove("selected")),y||(u.target.classList.add("selected"),r("removePattern"))}function X(){const u=_.value;r("hideContext"),_.value=!u}function M({time:u}){const y=o.value==="left",s=u?n.prices.filter(d=>!m.cmp(d.time,y,u)):n.prices;let a=y?P(s):w(s);m.isSet(a)&&r("scaned",R(a)),T.value.classList.remove("selected")}function P(u){let y,[s,a,d,f]=Array(4).fill({});for(let $=u.length-1;$>=0;$--){const S=u[$].value,g=u[$].time,i=n.timeToIndex(g);if(i===-1)break;if($===u.length-1&&(d={index:i,time:g,price:S},[a,s,f]=Array(3).fill(null).map(()=>m.cloneDeep(d))),y===void 0){if(S===d.price)continue;y=S>d.price}if(m.cmp(S,y,a.price)&&(m.cmp(s.price,!y,d.price)?([d,a]=[a,s].map(e=>m.cloneDeep(e)),s={index:i,time:g,price:S},f=m.cloneDeep(s),y=!y):a={index:i,time:g,price:S}),m.cmp(S,!y,s.price)?(s={index:i,time:g,price:S},f=m.cloneDeep(s)):f.index=i,m.cmp(S,y,f.price)&&(f={index:i,time:g,price:S}),d.index>s.index){const e=m.fmtNum(a.price-d.price,1,!0);if(e>=1.5&&(s.index-f.index>d.index-a.index||m.fmtNum(s.price-f.price,1,!0)>e))break}}return{A:s,B:a,C:d}}function w(u){let y,[s,a,d]=Array(3).fill({});for(let f=0;f<u.length;f++){const $=u[f].value,S=u[f].time,g=n.timeToIndex(S);if(g===-1)break;if(f===0&&(s={index:g,time:S,price:$},a=m.cloneDeep(s),d=m.cloneDeep(s)),y===void 0){if($===s.price)continue;y=$>s.price}m.cmp($,y,a.price)&&(a={index:g,time:S,price:$},d=m.cloneDeep(a)),m.cmp(a.price,y,s.price)&&m.cmp($,!y,d.price)&&(m.cmp($,y,s.price)?d={index:g,time:S,price:$}:(s=m.cloneDeep(a),a={index:g,time:S,price:$},d=m.cloneDeep(a),y=!y))}return{A:s,B:a,C:d}}function R(u){const y={};return Object.entries(u).forEach(([s,a])=>{const{index:d,...f}=a;y[s]=f}),y}return(u,y)=>(H(),J("div",{ref_key:"scanToolRef",ref:T,class:"context command",title:u.$t("trading.derivative.scanTool"),onClick:V,onContextmenu:X},[B("i",{class:ae(["far",{[`fa-angles-${o.value}`]:!0}])},null,2),ye(ee(Bt,{class:"contextmenu",modelValue:o.value,"onUpdate:modelValue":y[0]||(y[0]=s=>o.value=s)},null,8,["modelValue"]),[[ke,_.value]])],40,Ft))}},Mt=["title"],Wt=B("i",{class:"far fa-heart-rate"},null,-1),Zt=[Wt],Yt={__name:"PatternTool",props:["prices","priceSeries","timeMarkSeries","pickTimeToolRef","timeToIndex","indexToTime"],emits:["setProgress","hideContext"],setup(N,{expose:I,emit:x}){const m=me(),n=fe("mf"),r=N,T=x,_=A(null);let o={},v={};I({isSelected:l,draw:M,load:P,refresh:R,remove:f,drag:g});function l(){return _.value.classList.contains("selected")}function V(i){T("hideContext");const e=i.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(h=>h.classList.remove("selected")),e||(i.target.classList.add("selected"),r.pickTimeToolRef.remove())}function X(i){i.target.classList.remove("selected"),f()}function M({time:i,price:e}){let p={lineType:"pattern",price:e,lineWidth:1,lineStyle:1,draggable:!0};if(n.isSet(v.A))if(n.isSet(v.B)){let k,E;if(n.isSet(v.C)){let L,b;o.A={time:i,price:e};const{progress:O,timeMark:F,info:{rEpr1:z,rEpr2:j,rEpr3:G,entry:te,pStatus:K,x:re,X:q,y:ie,Y:W}}=u();E=O,k=F,L="A",b={price:e,title:`A ${z}`},v[L].applyOptions(b),L="B",b={title:`B ${j}`},v[L].applyOptions(b),L="C",b={title:`C ${G}`},v[L].applyOptions(b),L="D",b={price:te,title:"Entry "+K},v[L].applyOptions(b),L="X",b={price:n.fmtNum(re),title:`X ${n.fmtNum(q)}`},v[L].applyOptions(b),L="Y",b={price:n.fmtNum(ie),title:`Y ${n.fmtNum(W)}`},v[L].applyOptions(b)}else{o.C={price:e};const{progress:L,timeMark:b,info:{rEpr1:O,rEpr2:F,rEpr3:z,entry:j,pStatus:G,x:te,X:K,y:re,Y:q}}=u();E=L,k=b;let ie="A";v[ie].applyOptions({title:`A ${O}`}),ie="B",v[ie].applyOptions({title:`B ${F}`}),p.point="C",p.title=`C ${z}`,p.color="#FFEB3B",v[p.point]=r.priceSeries.createPriceLine(p),p.point="D",p.price=j,p.title="Entry "+G,p.color="#9C27B0",p.draggable=!1,v[p.point]=r.priceSeries.createPriceLine(p),p.point="Y",p.price=n.fmtNum(re),p.title=`Y ${n.fmtNum(q)}`,p.color="#E91E63",p.draggable=!1,v[p.point]=r.priceSeries.createPriceLine(p),p.point="X",p.price=n.fmtNum(te),p.title=`X ${n.fmtNum(K)}`,p.color="#2196F3",p.draggable=!1,v[p.point]=r.priceSeries.createPriceLine(p)}T("setProgress",E),S(k),_.value.classList.remove("selected")}else p.point="B",p.title="B 0",p.color="#4CAF50",v[p.point]=r.priceSeries.createPriceLine(p),o.B={price:e};else p.point="A",p.title="A 0",p.color="#F44336",v[p.point]=r.priceSeries.createPriceLine(p),o={A:{time:i,price:e}};d()}function P(i,e=!1){o=i,e&&d(),$(),w()}function w(){let e={lineType:"pattern",lineWidth:1,lineStyle:1,draggable:!0};const{A:h,B:p,C:k}=o,{progress:E,timeMark:L,info:{rEpr1:b,rEpr2:O,rEpr3:F,entry:z,pStatus:j,x:G,X:te,y:K,Y:re}}=u();T("setProgress",E),S(L),e.point="A",e.title=`A ${b}`,e.color="#F44336",e.price=h.price,v[e.point]=r.priceSeries.createPriceLine(e),e.point="B",e.title=`B ${O}`,e.color="#4CAF50",e.price=p.price,v[e.point]=r.priceSeries.createPriceLine(e),e.point="C",e.price=k.price,e.title=`C ${F}`,e.color="#FFEB3B",v[e.point]=r.priceSeries.createPriceLine(e),e.point="D",e.price=z,e.title="Entry "+j,e.color="#9C27B0",e.draggable=!1,v[e.point]=r.priceSeries.createPriceLine(e),e.point="Y",e.price=n.fmtNum(K),e.title=`Y ${n.fmtNum(re)}`,e.color="#E91E63",e.draggable=!1,v[e.point]=r.priceSeries.createPriceLine(e),e.point="X",e.price=n.fmtNum(G),e.title=`X ${n.fmtNum(te)}`,e.color="#2196F3",e.draggable=!1,v[e.point]=r.priceSeries.createPriceLine(e)}function R(i=!1){n.isSet(v.C)&&(i&&a(),$(),w())}function u(){const{A:i,B:e,C:h}=o,p=e.price-h.price,k=p>0,E=y({phase:1,start:i,end:e,retracementPrice:h.price});let L=y({phase:2,start:E.R,end:h});const b=y({phase:3,start:L.R,end:{price:e.price+(k?1:-1)*E.rEp},breakPrices:[L.S1.price,e.price]});E.xBox.tr>=L.tr&&(L.tr=E.xBox.tr),console.log("calculatePattern",[E,L,b]);const O=n.fmtNum(p,1,!0)>=E.pr,F=n.fmtNum(h.price-b.xBox.R.price,1,!0)>=L.pr,z=n.fmtNum(b.xBox.pr)>=b.pr,j=!n.cmp(h.price,!k,E.S1.price),G=!n.cmp(b.xBox.R.price,k,L.S1.price),te=!n.cmp(b.xBox.S.price,!k,b.S1.price),K=E.R.index+E.tr,re=E.R.index+5*E.tr,q=L.R.index+L.tr,ie=b.xBox.R.index+b.tr,W=b.xBox.R.index+5*b.tr,oe=b.xBox.R.index+L.tr,ne=[K,re,q,ie,W,oe],ce=b.xBox.S.index;let le,Z={};const Ce=[L.R.index>K,E.rEpr<3,L.rEpr<E.rEpr];Z.steps=[[O||E.rEt<E.tr&&E.rEp>=E.sEp,j,!b.breakIndexs[1]||K<b.breakIndexs[1],ce>K,ce<re],[...Ce,q>K,ce<W,ce<q],[L.R.index-E.R.index>.5*E.tr,F,ce>q],[z,te,ce>ie,Ce.every(Boolean)||ce>oe]],Z.step=1,Z.result=Z.steps[0].every(Boolean),le=E.R1.price,Z.result&&(ce<=q?(Z.step=2,Z.result=Z.steps[1].every(Boolean),le=L.S1.price):(Z.step=3,Z.result=Z.steps[2].every(Boolean),le=b.R1.price,Z.result&&(Z.step=4,Z.result=Z.steps[3].every(Boolean),Z.result&&(le=b.xBox.R.price))));const _e=`${j?O?1:0:2}${G?F?1:0:2}${te?z?1:0:2}`,ge=E.rEp,pe=s(e.price,ge,k),Le=b.breakIndexs[1]??ce,we=parseInt((Le-E.R.index)/E.tr),Te=we>1?ge*we:ge,Oe=s(e.price,Te,k);return{progress:Z,timeMark:ne,info:{rEpr1:E.rEpr,rEpr2:L.rEpr,rEpr3:b.rEpr,entry:le,pStatus:_e,x:pe,X:ge,y:Oe,Y:Te}}}function y({phase:i,start:e,end:h,breakPrices:p,retracementPrice:k}){let E=n.cloneDeep(e),L=n.cloneDeep(h);const b=L.price>E.price;let O={},F={},z={},j=[null,null],G,te,K;const re=r.pickTimeToolRef.get();return r.prices.filter(q=>{let ie=q.time>=E.time;return re&&(ie&=q.time<=re),ie}).every((q,ie)=>{const W=q.value,oe=q.time,ne=r.timeToIndex(oe);return ne===-1?!1:((ie===0||W===E.price)&&(O={R:{index:ne,time:oe,price:W},S:{index:ne,time:oe,price:W},pr:0,tr:0},F=n.cloneDeep(O),z=n.cloneDeep(O)),n.cmp(W,b,O.R.price)?(O.pr>F.pr&&(F.pr=O.pr),O.tr>=F.tr&&(F.tr=O.tr,F.R=n.cloneDeep(O.R),F.S=n.cloneDeep(O.S)),i===1&&k&&!n.cmp(O.S.price,!b,k)&&O.tr>=z.tr&&O.pr>=z.pr&&(z=n.cloneDeep(O)),O={R:{index:ne,time:oe,price:W},S:{index:ne,time:oe,price:W},pr:0,tr:0},i===3&&p&&(!j[0]&&n.cmp(W,b,p[0])&&(j[0]=ne),!j[1]&&n.cmp(W,b,p[1])&&(j[1]=ne))):(O.S.index=ne,O.tr=O.S.index-O.R.index,n.cmp(W,!b,O.S.price)&&(O.S.time=oe,O.S.price=W,O.pr=n.fmtNum(O.S.price-O.R.price,1,!0))),n.cmp(W,!b,E.price)?(O.S.price=E.price,!1):!!n.cmp(W,!b,L.price))}),n.isSet(O)&&(E.index=r.timeToIndex(E.time),L.index=O.S.index,L.time=r.indexToTime(O.S.index),G=n.fmtNum(L.price-F.R.price,1,!0),te=n.fmtNum(E.price-F.S.price,1,!0),K=L.index-F.S.index,i===3&&(z=O)),{tr:F.tr,pr:F.pr,rEp:G,sEp:te,rEpr:F.pr?n.fmtNum(G/F.pr):0,rEt:K,S1:F.S,R1:F.R,xBox:z,S:E,R:L,breakIndexs:j}}function s(i,e,h){const p=i+(h?1:-1)*e;let k=n.fmtNum(p%1);if(h){if(k>=.1&&k<=.2)return Math.floor(p);if(k>=.6&&k<=.7)return Math.floor(p)+.5}else{if(k>=.8&&k<=.9)return Math.ceil(p);if(k>=.3&&k<=.4)return Math.floor(p)+.5}return p}function a(){if(!r.pickTime)return!1;const i=o.B.price-o.A.price>0,e=r.prices.at(-1).value;if(n.cmp(e,!i,o.C.price)){let h=e;for(let p=r.prices.length-1;p>=0;p--){const k=r.prices[p].value;if(k===o.B.price)break;h=i?Math.min(h,k):Math.max(h,k)}o.C.price=h,d()}}function d(i=!1){let e={isRemove:i,name:"pattern",points:[],data:[]};i?o={}:Object.entries(o).forEach(([h,p])=>{e.points.push(h),e.data.push(p)}),m.dispatch("tradingDerivative/drawTools",e)}function f(){d(!0),r.pickTimeToolRef.remove(),$()}function $(){n.isSet(v.A)&&(r.priceSeries.removePriceLine(v.A),n.isSet(v.B)&&(r.priceSeries.removePriceLine(v.B),n.isSet(v.C)&&(r.priceSeries.removePriceLine(v.C),r.priceSeries.removePriceLine(v.D),r.priceSeries.removePriceLine(v.X),r.priceSeries.removePriceLine(v.Y)))),v={},T("setProgress",{}),S([])}function S(i){const e=["#F44336","#F44336","#4CAF50","#FFEB3B","#FFEB3B","#2196F3"];let h=[];for(let p=0;p<i.length;p++){let k=r.indexToTime(i[p]);k&&(i.indexOf(i[p])!==i.lastIndexOf(i[p])&&(k+=p),h.push({time:k,value:1,color:e[p]}))}h.length&&h.sort((p,k)=>p.time-k.time),r.timeMarkSeries.setData(h)}function g({lineOptions:i}){if(n.isSet(v.C)){let e,h;o={A:{time:o.A.time,price:+v.A.options().price},B:{price:+v.B.options().price},C:{price:+v.C.options().price}},d();const{progress:p,timeMark:k,info:{rEpr1:E,rEpr2:L,rEpr3:b,entry:O,pStatus:F,x:z,X:j,y:G,Y:te}}=u();T("setProgress",p),S(k),e="A",h={title:`A ${E}`},v[e].applyOptions(h),e="B",h={title:`B ${L}`},v[e].applyOptions(h),e="C",h={title:`C ${b}`},v[e].applyOptions(h),e="D",h={price:O,title:"Entry "+F},i.point===e&&delete h.price,v[e].applyOptions(h),e="X",h={price:n.fmtNum(z),title:`X ${n.fmtNum(j)}`},v[e].applyOptions(h),e="Y",h={price:n.fmtNum(G),title:`Y ${n.fmtNum(te)}`},v[e].applyOptions(h)}}return(i,e)=>(H(),J("div",{ref_key:"patternToolRef",ref:_,class:"command",title:i.$t("trading.derivative.patternTool"),onClick:V,onContextmenu:X},Zt,40,Mt))}},Ht=["title"],Jt=B("i",{class:"far fa-pipe"},null,-1),Xt=[Jt],zt={__name:"PickTimeTool",props:["pickTimeSeries"],emits:["refreshPattern","hideContext"],setup(N,{expose:I,emit:x}){const m=me(),n=N,r=x,T=A(null);let _=null;I({isSelected:o,draw:X,load:M,remove:P,get:v});function o(){return T.value.classList.contains("selected")}function v(){return _}function l(w){r("hideContext");const R=w.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(u=>u.classList.remove("selected")),R||w.target.classList.add("selected")}function V(w){w.target.classList.remove("selected"),P(),r("refreshPattern")}function X({time:w}){m.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"0_pt",points:[0],data:[w]}),M(w),r("refreshPattern"),T.value.classList.remove("selected")}function M(w){_=w,n.pickTimeSeries.setData([{time:w,value:1,color:"#9C27B0"}])}function P(w=!0){w&&m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"0_pt"}),n.pickTimeSeries.setData([]),_=null}return(w,R)=>(H(),J("div",{ref_key:"pickTimeToolRef",ref:T,class:"command",title:w.$t("trading.derivative.pickTimeTool"),onClick:l,onContextmenu:V},Xt,40,Ht))}};const jt=B("div",{class:"triangle-shadow"},null,-1),qt=B("div",{class:"triangle"},null,-1),Ut={class:"input"},Qt={class:"color"},Gt=["onClick"],Kt={__name:"LineContext",props:["enable","title","color"],emits:["update:title","update:color"],setup(N,{emit:I}){const x=N,m=I,n=A(null),r=A(["#F44336","#FF9800","#FFEB3B","#4CAF50","#009688","#00BCD4","#2196F3","#673AB7","#9C27B0","#E91E63"]);Ae(()=>x.enable,l=>{l&&pt().then(()=>n.value.instance.focus())});function T({value:l}){m("update:title",l)}function _(l){m("update:color",l)}function o(){m("deleteAllLine")}function v(l){l.stopPropagation()}return(l,V)=>{const X=dt("DxButton");return H(),J("div",{class:"line-context",onClick:v},[jt,qt,B("div",Ut,[ee(qe(yt),{ref_key:"titleRef",ref:n,value:x.title,"show-clear-button":!0,"input-attr":{style:`color:${x.color}`},onValueChanged:T},null,8,["value","input-attr"]),ee(X,{icon:"trash",type:"danger",onClick:V[0]||(V[0]=M=>o())})]),B("div",Qt,[(H(!0),J(Ie,null,Ne(r.value,(M,P)=>(H(),J("div",{class:"color-swatch",style:ut({background:M,boxShadow:`0 0 4px ${M}`}),key:P,onClick:w=>_(M)},null,12,Gt))),128))])])}}},ei=["title"],ti=B("i",{class:"far fa-horizontal-rule"},null,-1),ii={__name:"LineTool",props:["priceSeries"],emits:["hideContext"],setup(N,{expose:I,emit:x}){const m=me(),n=N,r=x,T=A(null),_=A(!1),o=A(""),v=A("#F44336");let l=[];I({isSelected:V,hide:X,draw:w,load:R,drag:s});function V(){return T.value.classList.contains("selected")}function X(a){_.value=a}function M(a){r("hideContext");const d=a.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(f=>f.classList.remove("selected")),d||a.target.classList.add("selected")}function P(a){const d=_.value;r("hideContext"),_.value=!d}function w({price:a}){const d="line",f=l.length;if(l=l.filter($=>{const S=$.options(),g=S.type=a===+S.price;return g&&(n.priceSeries.removePriceLine($),m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:d,point:a})),!g}),l.length===f){const $=v.value,S=o.value,g={lineType:d,price:a,color:$,title:S,lineWidth:1,lineStyle:1,draggable:!0};l.push(n.priceSeries.createPriceLine(g)),m.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:d,points:[a],data:[{color:$,title:S}]})}T.value.classList.remove("selected")}function R(a){y(!1),u(a)}function u(a){const f={lineType:"line",lineWidth:1,lineStyle:1,draggable:!0};Object.entries(a).forEach(([$,{color:S,title:g}])=>{f.price=+$,f.color=S,f.title=g,l.push(n.priceSeries.createPriceLine(f))})}function y(a=!0){l.length>0&&(a&&m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line"}),l.forEach(d=>n.priceSeries.removePriceLine(d)),l=[])}function s({lineOptions:a,oldPrice:d,newPrice:f}){m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line",point:d});const $=a.color,S=a.title;m.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"line",points:[f],data:[{color:$,title:S}]}),T.value.classList.remove("selected")}return(a,d)=>(H(),J("div",{ref_key:"lineToolRef",ref:T,class:"context command",title:a.$t("trading.derivative.lineTool"),onClick:M,onContextmenu:P},[ti,ye(ee(Kt,{class:"contextmenu",enable:_.value,title:o.value,"onUpdate:title":d[0]||(d[0]=f=>o.value=f),color:v.value,"onUpdate:color":d[1]||(d[1]=f=>v.value=f),onDeleteAllLine:y},null,8,["enable","title","color"]),[[ke,_.value]])],40,ei))}},ni=["title"],si=B("i",{class:"far fa-grip-lines-vertical"},null,-1),ri=[si],oi={__name:"TimeRangeTool",props:["timeRangeSeries","timeToIndex","indexToTime"],emits:["hideContext"],setup(N,{expose:I,emit:x}){const m=me(),n=fe("mf"),r=N,T=x,_=A(null);let o=[];I({isSelected:v,draw:X,load:M});function v(){return _.value.classList.contains("selected")}function l(R){T("hideContext");const u=R.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(y=>y.classList.remove("selected")),u||R.target.classList.add("selected")}function V(R){w(),R.target.classList.remove("selected")}function X({time:R}){let u={isRemove:!1,name:"tr",points:[],data:[]},y={time:R,value:1};switch(o.length){case 0:y.color="OrangeRed",o[0]=y,u.points.push(0),u.data.push(R);break;case 1:y.color="lime",o[1]=y,u.points.push(1),u.data.push(R),_.value.classList.remove("selected");break;default:const s=r.timeToIndex(o[0].time),a=r.timeToIndex(o[1].time),f=r.timeToIndex(R)+(a-s),$=r.indexToTime(f);y.color="OrangeRed",o[0]=n.cloneDeep(y),u.points.push(0),u.data.push(R),y.time=$,y.color="lime",o[1]=y,u.points.push(1),u.data.push($),_.value.classList.remove("selected");break}r.timeRangeSeries.setData(o),m.dispatch("tradingDerivative/drawTools",u)}function M(R){w(!1),P(R)}function P(R){let u,y;if(R.length===2)u=R[0],y=R[1];else if(R.length===3){const a=r.timeToIndex(R[0]),d=r.timeToIndex(R[1]),$=r.timeToIndex(R[2])+(d-a);u=R[2],y=r.indexToTime($)}else return!1;let s=[{time:u,value:1,color:"OrangeRed"},{time:y,value:1,color:"lime"}];o=s,r.timeRangeSeries.setData(s)}function w(R=!0){R&&m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"tr"}),r.timeRangeSeries.setData([]),o=[]}return(R,u)=>(H(),J("div",{ref_key:"timeRangeToolRef",ref:_,class:"command",title:R.$t("trading.derivative.timeRangeTool"),onClick:l,onContextmenu:V},ri,40,ni))}},ai=["title"],ci=B("i",{class:"far fa-line-height"},null,-1),li=[ci],pi={__name:"TargetTool",props:["priceSeries"],emits:["hideContext"],setup(N,{expose:I,emit:x}){const m=me(),n=fe("mf"),r=N,T=x,_=A(null);let o={};I({isSelected:v,draw:X,load:M,drag:R});function v(){return _.value.classList.contains("selected")}function l(u){T("hideContext");const y=u.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(s=>s.classList.remove("selected")),y||(u.target.classList.add("selected"),w())}function V(u){w(),u.target.classList.remove("selected")}function X({price:u}){const y="target";let s={lineType:y,price:u,lineWidth:1,lineStyle:1,draggable:!0},a={isRemove:!1,name:y,points:[],data:[u]};if(n.isSet(o.A)){const d=+o.A.options().price,f=u-d;s.point="B",s.title=n.fmtNum(f),s.color="#F44336",o[s.point]=r.priceSeries.createPriceLine(s),a.points.push(s.point),s.point="X",s.price=n.fmtNum(d-.5*f),s.title=n.fmtNum(-.5*f),s.color="#2196F3",o[s.point]=r.priceSeries.createPriceLine(s),s.point="Y",s.price=n.fmtNum(d-f),s.title=n.fmtNum(-f),s.color="#673AB7",o[s.point]=r.priceSeries.createPriceLine(s),s.point="Z",s.price=n.fmtNum(d-2*f),s.title=n.fmtNum(-2*f),s.color="#9C27B0",o[s.point]=r.priceSeries.createPriceLine(s),s.point="W",s.price=n.fmtNum(d-4*f),s.title=n.fmtNum(-4*f),s.color="#E91E63",o[s.point]=r.priceSeries.createPriceLine(s),_.value.classList.remove("selected")}else s.point="A",s.title="0",s.color="#FF9800",o[s.point]=r.priceSeries.createPriceLine(s),a.points.push(s.point);m.dispatch("tradingDerivative/drawTools",a)}function M(u){w(!1),P(u)}function P(u){let s={lineType:"target",lineWidth:1,lineStyle:1,draggable:!0};const a=u.A,d=u.B,f=d-a;s.point="A",s.price=a,s.title="0",s.color="#FF9800",o[s.point]=r.priceSeries.createPriceLine(s),s.point="B",s.price=d,s.title=n.fmtNum(f),s.color="#F44336",o[s.point]=r.priceSeries.createPriceLine(s),s.point="X",s.price=n.fmtNum(a-.5*f),s.title=n.fmtNum(-.5*f),s.color="#2196F3",o[s.point]=r.priceSeries.createPriceLine(s),s.point="Y",s.price=n.fmtNum(a-f),s.title=n.fmtNum(-f),s.color="#673AB7",o[s.point]=r.priceSeries.createPriceLine(s),s.point="Z",s.price=n.fmtNum(a-2*f),s.title=n.fmtNum(-2*f),s.color="#9C27B0",o[s.point]=r.priceSeries.createPriceLine(s),s.point="W",s.price=n.fmtNum(a-4*f),s.title=n.fmtNum(-4*f),s.color="#E91E63",o[s.point]=r.priceSeries.createPriceLine(s)}function w(u=!0){u&&m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"target"}),n.isSet(o.A)&&(r.priceSeries.removePriceLine(o.A),n.isSet(o.B)&&(r.priceSeries.removePriceLine(o.B),r.priceSeries.removePriceLine(o.X),r.priceSeries.removePriceLine(o.Y),r.priceSeries.removePriceLine(o.Z),r.priceSeries.removePriceLine(o.W))),o={}}function R({lineOptions:u,newPrice:y}){if(n.isSet(o.B)){let s={isRemove:!1,name:"target",points:[],data:[]},a,d,f=+o.A.options().price,$=+o.B.options().price,S=$-f;if(a="A",u.point==="A")S=+o.B.options().title,$=f+S;else if(u.point!=="B"){let g=0;switch(u.point){case"X":g=1.5;break;case"Y":g=2;break;case"Z":g=3;break;case"W":g=5;break}S=n.fmtNum(($-y)/g),f=$-S,d={price:f},o[a].applyOptions(d)}s.points.push(a),s.data.push(f),a="B",d={price:$,title:n.fmtNum(S)},u.point===a&&delete d.price,o[a].applyOptions(d),s.points.push(a),s.data.push($),a="X",d={price:n.fmtNum(f-.5*S),title:n.fmtNum(-.5*S)},u.point===a&&delete d.price,o[a].applyOptions(d),a="Y",d={price:n.fmtNum(f-S),title:n.fmtNum(-S)},u.point===a&&delete d.price,o[a].applyOptions(d),a="Z",d={price:n.fmtNum(f-2*S),title:n.fmtNum(-2*S)},u.point===a&&delete d.price,o[a].applyOptions(d),a="W",d={price:n.fmtNum(f-4*S),title:n.fmtNum(-4*S)},u.point===a&&delete d.price,o[a].applyOptions(d),m.dispatch("tradingDerivative/drawTools",s)}}return(u,y)=>(H(),J("div",{ref_key:"targetToolRef",ref:_,class:"command",title:u.$t("trading.derivative.targetTool"),onClick:l,onContextmenu:V},li,40,ai))}},di=["title"],Xe=3,ze=2,ui={__name:"OrderTool",props:["position","prices","priceSeries","inSession","TIME"],emits:["getTools","showEntry","showTpSl","hideContext"],setup(N,{expose:I,emit:x}){const m=me(),{t:n}=Fe(),r=fe("mf"),T=N,_=x,o=A(null),v=A(!1);let l={entry:{},tp:{},sl:{}},V=!1;I({has:X,show:M,entry:P,tpsl:w,cancel:R,cancelWithoutClose:u,scan:y,load:a,drag:$});function X(){return r.isSet(l.entry.line)||r.isSet(l.tp.line)}function M({price:g}){if(T.inSession()){const i=U(xe(new Date,7));if(r.isSet(l.entry.line))!r.isSet(l.tp.line)&&T.position&&i>T.TIME.ATO&&i<T.TIME.ATC&&_("showTpSl");else{let e=null,h=0;T.position?(i<T.TIME.ATO?e="ATO":i>T.TIME.ATC&&(e="ATC"),e&&(l.entry.price=e,h=-T.position)):i>T.TIME.ATO&&i<T.TIME.ATC&&(e=g,h=e>=T.prices.at(-1).value?1:-1,l.side=h,l.entry.price=e),h&&_("showEntry")}}}function P(){if(T.inSession()){const g=U(xe(new Date,7));g<T.TIME.ATO?Je(n("trading.derivative.atoOrder"),n("titles.confirm")).then(e=>{e&&m.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(h=>{h.isOk?se.success(n("trading.derivative.atoOrderSuccess")):S(h.message)})}):g>T.TIME.ATC?Je(n("trading.derivative.atcOrder"),n("titles.confirm")).then(e=>{e&&m.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(h=>{h.isOk?se.success(n("trading.derivative.atcOrderSuccess")):S(h.message)})}):m.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"new",side:l.side,price:l.entry.price}}).then(i=>{i.isOk?(s(["entry"]),se.success(n("trading.derivative.newEntrySuccess"))):S(i.message)})}}function w(){l.tp.price=l.entry.price+l.side*Xe,l.sl.price=l.entry.price-l.side*ze,m.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:l.tp.price},slData:{cmd:"new",price:l.sl.price}}).then(g=>{g.isOk?(l.entry.line.applyOptions({draggable:!1}),s(["entry","tp","sl"]),se.success(n("trading.derivative.newTpSlSuccess"))):S(g.message)})}function R(){r.isSet(l.entry.line)?r.isSet(l.tp.line)?m.dispatch("tradingDerivative/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(g=>{g.isOk?(f(["entry","tp","sl"]),se.success(n("trading.derivative.exitSuccess"))):S(g.message)}):m.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"delete"}}).then(g=>{g.isOk?(f(["entry"]),se.success(n("trading.derivative.deleteEntrySuccess"))):S(g.message)}):_("getTools")}function u(){if(T.inSession()&&T.position){const g=U(xe(new Date,7));g>T.TIME.ATC-5*60&&(v.value=!0,g>T.TIME.ATC-15&&r.isSet(l.tp.line)&&m.dispatch("tradingDerivative/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(i=>{i.isOk?(f(["entry","tp","sl"]),se.success(n("trading.derivative.autoCancelTpSlSuccess"))):S(i.message)}))}}function y(g){if(r.isSet(l.entry.line)){const i=l.side>0;r.isSet(l.tp.line)?(r.cmd(g,i,l.tp.price,!0)&&(V||(V=!0,m.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"delete"}}).then(e=>{e.isOk?(f(["entry","tp","sl"]),se.success(n("trading.derivative.deleteTpSuccess")),toggleOrderButton(!1)):S(e.message),V=!1}))),r.cmd(g,!i,l.sl.price,!0)&&(V||(V=!0,m.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"cancel"}}).then(e=>{e.isOk?(f(["entry","tp","sl"]),se.success(n("trading.derivative.deleteSlSuccess")),toggleOrderButton(!1)):S(e.message),V=!1})))):r.cmd(g,i,l.entry.price,!0)&&(V||(V=!0,setTimeout(()=>{l.tp.price=l.entry.price+l.side*Xe,l.sl.price=l.entry.price-l.side*ze,m.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:l.tp.price},slData:{cmd:"new",price:l.sl.price}}).then(e=>{e.isOk?(l.entry.line.applyOptions({draggable:!1}),s(["entry","tp","sl"]),se.success(n("trading.derivative.autoNewTpSlSuccess"))):S(e.message),V=!1})},1e3)))}}function s(g){const i="order";let e={isRemove:!1,name:i,points:[],data:[]},h,p;g.forEach(k=>{const E=l.entry.price,L=l.tp.price,b=l.sl.price;switch(k){case"entry":h="yellow",p=l.side>0?"LONG":"SHORT";break;case"tp":h="lime",p=r.fmtNum(L-E,1,!0);break;case"sl":h="red",p=r.fmtNum(b-E,1,!0);break}if(e.points.push(k),r.isSet(l[k].line))l[k].line.applyOptions({price:l[k].price,title:p}),e.data.push(l[k].line.options());else{const O={lineType:i,kind:k,side:l.side,price:l[k].price,color:h,lineWidth:1,lineStyle:0,title:p,draggable:!0};l[k].line=T.priceSeries.createPriceLine(O),e.data.push(O)}}),m.dispatch("tradingDerivative/drawTools",e)}function a(g){f(["entry","tp","sl"],!1),d(g)}function d(g){Object.entries(g).forEach(([i,e])=>{i==="entry"&&(l.side=e.side),l[i].price=e.price,l[i].line=T.priceSeries.createPriceLine(e)})}function f(g,i=!0){i&&m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"order"}),g.forEach(e=>{r.isSet(l[e].line)&&(T.priceSeries.removePriceLine(l[e].line),delete l[e].line)})}function $({line:g,lineOptions:i,oldPrice:e,newPrice:h}){if(h!==e){let p=!1;i.kind==="entry"?T.position||(p=!0,l[i.kind].price=h,m.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"change",price:l.entry.price}}).then(k=>{k.isOk?(s([i.kind]),se.success(n("trading.derivative.changeEntrySuccess"))):(g.applyOptions({price:e}),S(k.message))})):(p=!0,l[i.kind].price=h,i.kind==="tp"?m.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"change",price:l.tp.price}}).then(k=>{k.isOk?(s([i.kind]),se.success(n("trading.derivative.changeTpSuccess"))):(g.applyOptions({price:e}),S(k.message))}):m.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"change",price:l.sl.price}}).then(k=>{k.isOk?(s([i.kind]),se.success(n("trading.derivative.changeSlSuccess"))):(g.applyOptions({price:e}),S(k.message))})),p||(g.applyOptions({price:e}),se.show(n("trading.derivative.noChangeOrderLine")))}}function S(g){g||(g="unknown"),se.error(n(`trading.derivative.${g}`))}return(g,i)=>(H(),J("div",{ref_key:"orderToolRef",ref:o,class:"cancel-order command",title:g.$t("trading.derivative.orderTool"),onClick:R},[B("i",{class:ae(["far fa-trash-alt",{blink:v.value}])},null,2)],8,di))}};const fi=["title"],mi=["title"],vi=["title"],hi=["title"],gi="wss://tradestation.fireant.vn/quote?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",Si="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",_i={__name:"Chart",setup(N,{expose:I}){const x=me(),m=ht(),{t:n}=Fe(),r=fe("devices"),T=fe("mf"),_=fe("filters"),o=A(null),v=A(null),l=A(null),V=A(null),X=A(null),M=A(null),P=A(null),w=A(null),R=A(null),u=A(null),y=A(null),s=A(null),a=A(null),d=A(null),f=A(null),$={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.25,bottom:.25}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:1e3,minBarSpacing:.01,barSpacing:.05}},S=Ee(new Date,"yyyy-MM-dd"),g={START:U(new Date(`${S}T08:45:00Z`)),ATO:U(new Date(`${S}T09:00:00Z`)),ATC:U(new Date(`${S}T14:30:00Z`)),END:U(new Date(`${S}T14:45:00Z`))};let i={chart:{},whitespaces:[],crosshair:{},interval:null,interval60:null,websocket:null,socketStop:!1,vpsUpdatedAt:kt(new Date,61)};const e=ft({prices:[],series:{},chartDate:m.query.date??S,clock:Ee(new Date,"HH:mm:ss"),isSocketWarning:!1,progress:{},TIME:g}),h=he(()=>x.state.tradingDerivative.status),p=he(()=>x.state.tradingDerivative.config),k=he(()=>x.state.tradingDerivative.tools),E=he(()=>x.state.tradingDerivative.isLoading),L=he(()=>h.value.position||h.value.pending||a.value&&a.value.has());i.interval=setInterval(()=>{a.value&&a.value.cancelWithoutClose(),e.clock=Ee(new Date,"HH:mm:ss")},1e3),i.interval60=setInterval(()=>{Re()?(Ze(),p.value.autoRefresh&&w.value.refresh(!0)):clearInterval(i.interval60)},6e4),nt(),Be(()=>{b(),new ResizeObserver(re).observe(o.value),document.addEventListener("keydown",q)}),je(()=>{O(),document.removeEventListener("keydown",q),clearInterval(i.interval),clearInterval(i.interval60),Z(),i.socketStop=!0}),Ae(()=>x.state.tradingDerivative.chartData,ie),Ae(k,ce),I({connectSocket:le});function b(){i.chart=Tt(v.value,$),i.chart.subscribeCrosshairMove(te),i.chart.subscribeCustomPriceLineDragged(K),e.series.whitespace=i.chart.addHistogramSeries({priceScaleId:"whitespace",scaleMargins:{top:0,bottom:0},color:"#808080",lastValueVisible:!1,priceLineVisible:!1}),e.series.timeRange=i.chart.addHistogramSeries({priceScaleId:"timeRange",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),e.series.pickTime=i.chart.addHistogramSeries({priceScaleId:"pickTime",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),e.series.timeMark=i.chart.addHistogramSeries({priceScaleId:"timeMark",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),e.series.price=i.chart.addLineSeries({color:"#F5F5F5",priceFormat:{minMove:.1}})}function O(){i.chart&&(i.chart.remove(),i.chart=null)}function F(c){pe(),Te(!1),s.value.isSelected()?s.value.draw({time:i.crosshair.time}):w.value.isSelected()?w.value.draw({time:i.crosshair.time,price:De(i.crosshair.y)}):R.value.isSelected()?R.value.draw({time:i.crosshair.time}):P.value.isSelected()?P.value.draw({price:De(i.crosshair.y)}):y.value.isSelected()?y.value.draw({time:i.crosshair.time}):u.value.isSelected()&&u.value.draw({price:De(i.crosshair.y)})}function z(c){Te(!0),c.preventDefault()}function j(c){c.stopPropagation()}function G(c){c.preventDefault(),c.stopPropagation()}function te(c){if(c.time){let D=c.seriesPrices.get(e.series.price);i.crosshair.time=c.time,i.crosshair.price=D}else r.phone||(i.crosshair.time=null,i.crosshair.price=null);c.point!==void 0&&(i.crosshair.x=c.point.x,i.crosshair.y=c.point.y)}function K(c){let D=c.customPriceLine,C=D.options();C.price=T.fmtNum(C.price);const Y=+c.fromPriceString,Q=C.price;switch(C.lineType){case"order":a.value.drag({line:D,lineOptions:C,oldPrice:Y,newPrice:Q});break;case"line":P.value.drag({lineOptions:C,oldPrice:Y,newPrice:Q});break;case"target":u.value.drag({lineOptions:C,newPrice:Q});break;case"pattern":w.value.drag({lineOptions:C});break}}function re(){o.value&&(i.chart.resize(o.value.offsetWidth,o.value.offsetHeight),o.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function q(c){if(c.ctrlKey)switch(c.keyCode){case 219:i.chart.timeScale().applyOptions({barSpacing:i.chart.options().timeScale.barSpacing-.01});break;case 221:i.chart.timeScale().applyOptions({barSpacing:i.chart.options().timeScale.barSpacing+.01});break}if(c.altKey)switch(c.keyCode){case 219:i.chart.timeScale().scrollToPosition(i.chart.timeScale().scrollPosition()-50);break;case 221:i.chart.timeScale().scrollToPosition(i.chart.timeScale().scrollPosition()+50);break}}function ie(c){e.chartDate===S&&Re()||(c.price.length>0&&(i.whitespaces=ne(i.whitespaces,oe(e.chartDate))),e.series.whitespace.setData(i.whitespaces),e.prices=ne(e.prices,c.price),e.series.price.setData(e.prices))}function W(c,D=null){const C=D??p.value.source;let Y=[];c.forEach(Q=>{let de,ue;C==="FireAnt"?(de=U(xe(new Date(Q.date),7)),ue=Q.price):(de=U(new Date(`${S}T${Q.time}Z`)),ue=Q.lastPrice),Y.push({time:de,value:ue})}),Y.length>1?(e.prices=ne(e.prices,Y),e.series.price.setData(e.prices)):(e.prices.push(Y[0]),e.series.price.update(Y[0]))}function oe(c){const D=U(new Date(`${c}T09:00:00Z`)),C=U(new Date(`${c}T11:30:00Z`)),Y=U(new Date(`${c}T13:00:00Z`)),Q=U(new Date(`${c}T14:30:00Z`)),de=U(new Date(`${c}T14:00:00Z`));let ue=[];for(let ve=D;ve<=Q;ve++){if(ve>C&&ve<Y)continue;let He={time:ve};(ve===de||ve===Q)&&(He.value=1),ue.push(He)}return ue}function ne(c,D){return Array.from(new Map([...c,...D].sort((C,Y)=>C.time-Y.time).map(C=>[C.time,C])).values())}function ce(c){Object.entries(c).forEach(([D,C])=>{switch(D){case"order":a.value.load(C);break;case"pattern":Le(C)&&w.value.load(T.cloneDeep(C));break;case"tr":y.value.load(C);break;case"0_pt":R.value.load(C[0]);break;case"line":P.value.load(C);break;case"target":u.value.load(C);break}})}async function le(){if(Re()){await Z();const c=p.value.source==="FireAnt",D=c?gi:Si;i.websocket=new WebSocket(D),i.websocket.onclose=C=>{i.socketStop||(e.isSocketWarning=!0,le())},c?Ce():(We(),Me())}}async function Z(){i.websocket&&i.websocket.readyState===WebSocket.OPEN&&(i.websocket.close(),await new Promise(c=>{const D=setInterval(()=>{(!i.websocket||i.websocket.readyState===WebSocket.CLOSED)&&(i.websocket=null,clearInterval(D),c())},100)}))}function Ce(){x.dispatch("tradingDerivative/setLoading",!0),i.websocket.onopen=c=>{if(i.websocket.readyState===WebSocket.OPEN){let D='{"protocol":"json","version":1}';i.websocket.send(D),D='{"arguments":["VN30F1M"],"invocationId":"0","target":"SubscribeTrades","type":1}',i.websocket.send(D)}},i.websocket.onmessage=c=>{e.isSocketWarning=!1,Ve(c.data).forEach(C=>{if(!C)return!1;C.type===3?(C.result[0].date.slice(0,10)===S&&(be(),i.whitespaces=ne(i.whitespaces,oe(S)),e.series.whitespace.setData(i.whitespaces),W(C.result)),x.dispatch("tradingDerivative/setLoading",!1)):C.type===1&&C.target==="UpdateTrades"&&C.arguments[0]==="VN30F1M"&&(console.log("FireAnt",C.arguments[1]),a.value.scan(C.arguments[1].at(-1).price),W(C.arguments[1]))})}}function Ve(c){let D=[];return c.split("").forEach(C=>{const Y=C.indexOf("{"),Q=C.lastIndexOf("}");let de=null;if(Y!==-1&&Q!==-1&&Q>Y){const ue=C.substring(Y,Q+1);ue!=="{}"&&(de=JSON.parse(ue))}D.push(de)}),D}function Me(){i.websocket.onopen=c=>{if(i.websocket.readyState===WebSocket.OPEN){const D={action:"join",list:p.value.vn30f1m},C=`42${JSON.stringify(["regs",JSON.stringify(D)])}`;i.websocket.send(C)}},i.websocket.onmessage=c=>{if(e.isSocketWarning=!1,c.data.substr(0,1)==="4"&&c.data.substr(1,1)==="2"){const D=JSON.parse(c.data.substr(2));if(D[0]==="stockps"){const C=D[1].data;C.id===3220&&(console.log("VPS",C),a.value.scan(C.lastPrice),W([C]))}}}}function We(){mt(new Date,new Date(i.vpsUpdatedAt))>60&&(fetch("https://bddatafeed.vps.com.vn/getpschartintraday/VN30F1M").then(c=>c.json()).then(c=>{console.log(c),W(c,"VPS")}),i.vpsUpdatedAt=new Date)}function _e(){w.value.refresh()}function ge(c){w.value.load(c,!0)}function pe(){M.value.hide(),s.value.hide(),P.value.hide()}function Le({A:{time:c}}){return i.whitespaces.some(D=>D.time===c)}function we(c){M.value.set(c)}function Te(c){c?a.value.show({price:De(i.crosshair.y)}):(d.value.style.display="none",f.value.style.display="none")}function Oe(){d.value.style.left=+(i.crosshair.x+(i.crosshair.x>innerWidth-71?-71:1))+"px",d.value.style.top=+(i.crosshair.y+(i.crosshair.y>innerHeight-61?-61:1))+"px",d.value.style.background=side>0?"green":"red",d.value.innerText=`${side>0?"LONG":"SHORT"} ${price}`,d.value.style.display="block"}function Qe(){f.value.style.left=+(i.crosshair.x+(i.crosshair.x>innerWidth-61?-61:1))+"px",f.value.style.top=+(i.crosshair.y+(i.crosshair.y>innerHeight-51?-51:1))+"px",f.value.style.display="block"}function Ge(){a.value.entry()}function Ke(){a.value.tpsl()}function et(){i.chart.timeScale().scrollToRealTime()}function Re(){const c=U(xe(new Date,7));return p.value.openingMarket&&c>=g.START&&c<=g.END}function tt(){if(!e.chartDate)return!1;Pe()}function it(){i.whitespaces=[],e.prices=[],le(),Pe()}function nt(){x.dispatch("tradingDerivative/initChart").then(()=>{le(),!m.query.date&&p.value.lastOpeningDate&&(e.chartDate=p.value.lastOpeningDate),Pe()})}function Pe(){x.dispatch("tradingDerivative/getChartData",e.chartDate).then(c=>{c&&be()})}function Ze(){x.dispatch("tradingDerivative/getStatus")}function be(){x.dispatch("tradingDerivative/getTools")}function st(){x.dispatch("tradingDerivative/getAccountInfo").then(c=>{let D="";D+='<div style="width: 200px;">',D+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${n("trading.derivative.nav")}</div><div>: ${_.currency(c.nav)}</div></div>`,D+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${n("trading.derivative.maxVol")}</div><div>: ${_.numberVnFormat(c.maxVol)}</div></div>`,D+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${n("trading.derivative.vm")}</div><div>: ${_.currency(c.vm)}</div></div>`,D+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${n("trading.derivative.fee")}</div><div>: ${_.currency(c.fee)}</div></div>`,D+="</div>",gt(D,n("trading.derivative.accountInfo"))})}function De(c){return T.fmtNum(e.series.price.coordinateToPrice(c))}function $e(c){let D=i.whitespaces.findIndex(C=>C.time===c);if(D===-1){const C=Ee(new Date(c*1e3),"yyyy-MM-dd"),Y=U(new Date(`${C}T11:30:00Z`)),Q=U(new Date(`${C}T13:00:00Z`)),de=U(new Date(`${C}T14:30:00Z`));c>Y&&c<Q?c=Y:c>de&&(c=de),D=i.whitespaces.findIndex(ue=>ue.time===c)}return D}function Ye(c){return c<i.whitespaces.length?i.whitespaces[c].time:!1}return(c,D)=>(H(),J("div",{class:"derivative-chart",ref_key:"chartContainerRef",ref:o,onClick:F,onContextmenu:z},[B("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:v},[B("div",{class:"area data-area",onClick:j,onContextmenu:G},[B("div",{ref_key:"connectionRef",ref:l,class:ae(["command",{yellow:h.value.pending,red:p.value.volInValid}]),title:c.$t("trading.derivative.connection"),onClick:Ze},[B("i",{class:ae(["far",{"fa-link-simple":h.value.connection,"fa-link-simple-slash":!h.value.connection,blink:e.isSocketWarning}])},null,2)],10,fi),B("div",{class:ae(["command status",{green:h.value.position>0,red:h.value.position<0}]),title:c.$t("trading.derivative.position"),onClick:st},Se(h.value.position),11,mi),B("div",{class:"command clock",onClick:le},Se(e.clock),1),ye(B("input",{type:"date",class:"chart-date command",title:c.$t("trading.derivative.date"),"onUpdate:modelValue":D[0]||(D[0]=C=>e.chartDate=C),onChange:tt},null,40,vi),[[vt,e.chartDate]]),B("div",{ref_key:"reloadToolRef",ref:V,class:"command",title:c.$t("trading.derivative.reload"),onClick:it,onContextmenu:be},[B("i",{class:ae(["far fa-sync-alt",{"fa-spin":E.value}])},null,2)],40,hi)],32),B("div",{class:"area tool-area",onClick:j,onContextmenu:G},[ee(_t,{chartContainerRef:o.value},null,8,["chartContainerRef"]),ee(bt,{ref_key:"tradingviewRef",ref:X,vpsUser:p.value.vpsUser,vpsSession:p.value.vpsSession,chartContainerRef:o.value},null,8,["vpsUser","vpsSession","chartContainerRef"]),ee(It,{ref_key:"progressToolRef",ref:M,onRefreshPattern:_e,onHideContext:pe},null,512),ee(Vt,{ref_key:"scanToolRef",ref:s,prices:e.prices,timeToIndex:$e,onScaned:ge,onRemovePattern:D[1]||(D[1]=()=>w.value.remove()),onHideContext:pe},null,8,["prices"]),ee(Yt,{ref_key:"patternToolRef",ref:w,prices:e.prices,priceSeries:e.series.price,timeMarkSeries:e.series.timeMark,pickTimeToolRef:R.value,timeToIndex:$e,indexToTime:Ye,onSetProgress:we,onHideContext:pe},null,8,["prices","priceSeries","timeMarkSeries","pickTimeToolRef"]),ee(zt,{ref_key:"pickTimeToolRef",ref:R,pickTimeSeries:e.series.pickTime,onRefreshPattern:_e,onHideContext:pe},null,8,["pickTimeSeries"]),ee(ii,{ref_key:"lineToolRef",ref:P,priceSeries:e.series.price,onHideContext:pe},null,8,["priceSeries"]),ee(oi,{ref_key:"timeRangeToolRef",ref:y,timeRangeSeries:e.series.timeRange,timeToIndex:$e,indexToTime:Ye,onHideContext:pe},null,8,["timeRangeSeries"]),ee(pi,{ref_key:"targetToolRef",ref:u,priceSeries:e.series.price,onHideContext:pe},null,8,["priceSeries"]),ye(ee(ui,{ref_key:"orderToolRef",ref:a,position:h.value.position,prices:e.prices,priceSeries:e.series.price,inSession:Re,TIME:e.TIME,onGetTools:be,onShowEntry:Oe,onShowTpSl:Qe,onHideContext:pe},null,8,["position","prices","priceSeries","TIME"]),[[ke,L.value]])],32),B("div",null,[B("div",{ref_key:"entryOrderRef",ref:d,class:"order-button entry",onClick:Ge}," Entry ",512),B("div",{ref_key:"tpslOrderRef",ref:f,class:"order-button tpsl",onClick:Ke}," TP/SL ",512),B("div",{class:"chart-top command far fa-angle-double-right",onClick:et})])],512)],544))}};export{_i as default};
