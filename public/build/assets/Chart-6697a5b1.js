import{A as ui,B as fi,C as mi,l as fe,u as vi,r as D,a as hi,c as H,y as gi,E as xi,w as we,x as O,b as yi,d as m,G as W,t as Je,H as j,I as Si,J as K,e as Fe,K as Ti,h as Ci,j as ki,k as be,z as He,L as wi,o as Fi}from"./app-b54a2c82.js";import bi from"./LineContext-ffb6a69f.js";import Di from"./ScanContext-a0bc71a7.js";import Li from"./ProgressContext-8e9345d1.js";import{c as Oi}from"./lightweight-charts.esm.development-03366bac.js";import{g as R}from"./getUnixTime-34189d60.js";import"./text-box-5e073c35.js";function Ri(q,Q,E){return ui((E==null?void 0:E.in)||q,+fi(q)+Q)}function De(q,Q,E){return Ri(q,Q*mi,E)}const Ei=["title"],Ai=["title"],Pi=["title"],Bi=["title"],_i=["title"],Ii=["title"],Mi=["title"],Vi=["title"],Wi=["title"],Zi=m("i",{class:"far fa-heart-rate"},null,-1),$i=[Zi],Yi=["title"],Ni=m("i",{class:"far fa-pipe"},null,-1),Xi=[Ni],zi=["title"],Ji=m("i",{class:"far fa-horizontal-rule"},null,-1),Hi=["title"],ji=m("i",{class:"far fa-grip-lines-vertical"},null,-1),qi=[ji],Qi=["title"],Ui=m("i",{class:"far fa-line-height"},null,-1),Gi=[Ui],Ki=["title"],er=["src"],je=3,qe=2,tr="wss://tradestation.fireant.vn/quote?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",ur={__name:"Chart",setup(q){const Q={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.25,bottom:.25}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:1e3,minBarSpacing:.01,barSpacing:.05}},E=fe(new Date,"yyyy-MM-dd"),A={START:R(new Date(`${E}T08:45:00Z`)),ATO:R(new Date(`${E}T09:00:00Z`)),ATC:R(new Date(`${E}T14:30:00Z`)),END:R(new Date(`${E}T14:45:00Z`))},u=Ci(),Le=ki(),{t:h}=vi(),Qe=be("devices"),f=be("mf"),ee=be("filters"),V=D(null),Oe=D(null),Ue=D(null),Ge=D(null),Ke=D(null),et=D(null),tt=D(null),te=D(null),me=D(null),ve=D(null),he=D(null),ie=D(null),ge=D(null),it=D(null),$=D(null),U=D(null);let e={chart:{},series:{},data:{whitespace:[],price:[]},tools:{pattern:{}},crosshair:{},interval:null,interval60:null,websocket:null,isAutoOrdering:!1,socketStop:!1,socketSendData:null,currentSeconds:R(De(new Date,7)),alertAudio:null};z();const c=hi({chartDate:Le.query.date??E,clock:fe(new Date,"HH:mm:ss"),isFullscreen:!1,isSocketWarning:!1,isOrderWarning:!1,lineColor:"#F44336",lineTitle:"",progress:{},scanSide:"left",showProgressContext:!1,showScanContext:!1,showLineContext:!1,showTradingView:!1,tradingViewStyle:{left:"32px"}}),P=H(()=>u.state.tradingDerivative.status),_=H(()=>u.state.tradingDerivative.config),Re=H(()=>u.state.tradingDerivative.tools),rt=H(()=>u.state.tradingDerivative.isChartLoading),st=H(()=>P.value.position!=0||!!P.value.pending||!!Re.value.order),ot=H(()=>`https://chart.vps.com.vn/tv/?u=${_.value.vpsUser}&s=${_.value.vpsSession}&symbol=VN30F1M&resolution=1&lang=vi`);ri(),e.interval=setInterval(gt,1e3),e.interval60=setInterval(()=>{Z()?(Ye(),_.value.autoRefresh&&se(!0)):clearInterval(e.interval60)},6e4),gi(()=>{e.chart=Oi(Oe.value,Q),e.chart.subscribeCrosshairMove(lt),e.chart.subscribeCustomPriceLineDragged(ct),e.series.whitespace=e.chart.addHistogramSeries({priceScaleId:"whitespace",scaleMargins:{top:0,bottom:0},color:"#808080",lastValueVisible:!1,priceLineVisible:!1}),e.series.timeRange=e.chart.addHistogramSeries({priceScaleId:"timeRange",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),e.series.pickTime=e.chart.addHistogramSeries({priceScaleId:"pickTime",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),e.series.timeMark=e.chart.addHistogramSeries({priceScaleId:"timeMark",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),e.series.price=e.chart.addLineSeries({color:"#F5F5F5",priceFormat:{minMove:.1}}),new ResizeObserver(pt).observe(V.value),document.addEventListener("keydown",Pe),document.addEventListener("fullscreenchange",Be)}),xi(()=>{e.chart&&(e.chart.remove(),e.chart=null),document.removeEventListener("keydown",Pe),document.removeEventListener("fullscreenchange",Be),clearInterval(e.interval),clearInterval(e.interval60),e.websocket&&(e.websocket.close(),e.websocket=null),e.socketStop=!0}),we(()=>u.state.tradingDerivative.chartData,ut),we(Re,ft),we(()=>c.progress,mt);function nt(i){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1,le(!1),te.value.classList.contains("selected")?Nt():he.value.classList.contains("selected")?Ht():ie.value.classList.contains("selected")?Wt():ge.value.classList.contains("selected")?Ft():me.value.classList.contains("selected")?Et():ve.value.classList.contains("selected")&&It()}function at(i){le(!0),i.preventDefault()}function Ee(i){i.stopPropagation()}function Ae(i){i.preventDefault(),i.stopPropagation()}function lt(i){if(i.time){let r=i.seriesPrices.get(e.series.price);e.crosshair.time=i.time,e.crosshair.price=r}else Qe.phone||(e.crosshair.time=null,e.crosshair.price=null);i.point!=null&&(e.crosshair.x=i.point.x,e.crosshair.y=i.point.y)}function ct(i){let r=i.customPriceLine,t=r.options();t.price=parseFloat(t.price.toFixed(1));const s=+i.fromPriceString,l=t.price;switch(t.lineType){case"order":if(l!=s){let n=!1;t.kind=="entry"?P.value.position||(n=!0,e.tools.order[t.kind].price=l,u.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"change",price:e.tools.order.entry.price}}).then(a=>{a.isOk?(Y([t.kind]),O.success(h("trading.derivative.changeEntrySuccess"))):(r.applyOptions({price:s}),B(a.message))})):(n=!0,e.tools.order[t.kind].price=l,t.kind=="tp"?u.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"change",price:e.tools.order.tp.price}}).then(a=>{a.isOk?(Y([t.kind]),O.success(h("trading.derivative.changeTpSuccess"))):(r.applyOptions({price:s}),B(a.message))}):u.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"change",price:e.tools.order.sl.price}}).then(a=>{a.isOk?(Y([t.kind]),O.success(h("trading.derivative.changeSlSuccess"))):(r.applyOptions({price:s}),B(a.message))})),n||(r.applyOptions({price:s}),O.show(h("trading.derivative.noChangeOrderLine")))}break;case"line":u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line",point:s});const o=t.color,p=t.title;u.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"line",points:[l],data:[{color:o,title:p}]}),te.value.classList.remove("selected");break;case"target":if(f.isSet(e.tools.target.B)){let n={isRemove:!1,name:"target",points:[],data:[]},a,d,v=+e.tools.target.A.options().price,x=+e.tools.target.B.options().price,g=x-v;if(a="A",t.point=="A")g=+e.tools.target.B.options().title,x=v+g;else if(t.point!="B"){let T=0;switch(t.point){case"X":T=1.5;break;case"Y":T=2;break;case"Z":T=3;break;case"W":T=5;break}g=parseFloat(((x-l)/T).toFixed(1)),v=x-g,d={price:v},e.tools.target[a].applyOptions(d)}n.points.push(a),n.data.push(v),a="B",d={price:x,title:g.toFixed(1)},t.point==a&&delete d.price,e.tools.target[a].applyOptions(d),n.points.push(a),n.data.push(x),a="X",d={price:parseFloat((v-.5*g).toFixed(1)),title:(-.5*g).toFixed(1)},t.point==a&&delete d.price,e.tools.target[a].applyOptions(d),a="Y",d={price:parseFloat((v-g).toFixed(1)),title:(-g).toFixed(1)},t.point==a&&delete d.price,e.tools.target[a].applyOptions(d),a="Z",d={price:parseFloat((v-2*g).toFixed(1)),title:(-2*g).toFixed(1)},t.point==a&&delete d.price,e.tools.target[a].applyOptions(d),a="W",d={price:parseFloat((v-4*g).toFixed(1)),title:(-4*g).toFixed(1)},t.point==a&&delete d.price,e.tools.target[a].applyOptions(d),u.dispatch("tradingDerivative/drawTools",n)}break;case"pattern":if(f.isSet(e.tools.pattern.lines.B)){let n,a;e.tools.pattern.points={A:{time:e.tools.pattern.points.A.time,price:+e.tools.pattern.lines.A.options().price},B:{price:+e.tools.pattern.lines.B.options().price},C:{price:+e.tools.pattern.lines.C.options().price}},X();const{progress:d,timeMark:v,info:{rEpr1:x,rEpr2:g,rEpr3:T,entry:C,pStatus:F,x:b,X:L,y:k,Y:w}}=oe();ae(d),ne(v),n="A",a={title:`A ${x}`},e.tools.pattern.lines[n].applyOptions(a),n="B",a={title:`B ${g}`},e.tools.pattern.lines[n].applyOptions(a),n="C",a={title:`C ${T}`},e.tools.pattern.lines[n].applyOptions(a),n="D",a={price:C,title:"Entry "+F},t.point==n&&delete a.price,e.tools.pattern.lines[n].applyOptions(a),n="X",a={price:parseFloat(b.toFixed(1)),title:"X "+parseFloat(L.toFixed(1))},e.tools.pattern.lines[n].applyOptions(a),n="Y",a={price:parseFloat(k.toFixed(1)),title:"Y "+parseFloat(w.toFixed(1))},e.tools.pattern.lines[n].applyOptions(a)}break}}function pt(){V.value&&(e.chart.resize(V.value.offsetWidth,V.value.offsetHeight),V.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function Pe(i){if(i.ctrlKey)switch(i.keyCode){case 219:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing-.01});break;case 221:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing+.01});break}if(i.altKey)switch(i.keyCode){case 219:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()-50);break;case 221:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()+50);break}}function Be(){V.value&&(document.fullscreenElement?(c.isFullscreen=!0,V.value.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(c.isFullscreen=!1,V.value.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}function dt(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function ut(i){c.chartDate==E&&Z()||(i.price.length>0&&(e.data.whitespace=re(e.data.whitespace,Ie(c.chartDate))),e.series.whitespace.setData(e.data.whitespace),e.data.price=re(e.data.price,i.price),e.series.price.setData(e.data.price))}function _e(i){let r=[];i.forEach(t=>{const s=R(De(new Date(t.date),7));r.push({time:s,value:t.price})}),r.length>1?(e.data.price=re(e.data.price,r),e.series.price.setData(e.data.price)):(e.data.price.push(r[0]),e.series.price.update(r[0]))}function Ie(i){const r=R(new Date(`${i}T09:00:00Z`)),t=R(new Date(`${i}T11:30:00Z`)),s=R(new Date(`${i}T13:00:00Z`)),l=R(new Date(`${i}T14:30:00Z`)),o=R(new Date(`${i}T14:00:00Z`));let p=[];for(let n=r;n<=l;n++){if(n>t&&n<s)continue;let a={time:n};(n==o||n==l)&&(a.value=1),p.push(a)}return p}function re(i,r){return Array.from(new Map([...i,...r].sort((t,s)=>t.time-s.time).map(t=>[t.time,t])).values())}function ft(i){qt(),Object.entries(i).forEach(([r,t])=>{switch(r){case"order":xt(t);break;case"pattern":At(t)&&(e.tools.pattern.points=f.cloneDeep(t),ye());break;case"tr":Zt(t);break;case"0_pt":Ve(t[0]);break;case"line":Xt(t);break;case"target":jt(t);break}})}function mt(i,r){if(_.value.autoRefresh&&(i.step>r.step||i.step==r.step&&i.result>r.result)){let t="";i.result?[2,4].includes(i.step)?t=h("trading.derivative.progressOrder",i):t=h("trading.derivative.progressSuccess",i):t=h("trading.derivative.progressFail",i),vt(t)}}function vt(i){const r=new SpeechSynthesisUtterance(i);r.lang="vi-VN",speechSynthesis.speak(r)}function xe(){u.dispatch("tradingDerivative/setChartLoading",!0),e.websocket=new WebSocket(tr),e.websocket.onopen=i=>{let r='{"protocol":"json","version":1}';e.websocket.send(r),r='{"arguments":["VN30F1M"],"invocationId":"0","target":"SubscribeTrades","type":1}',e.websocket.send(r),e.socketSendData=r},e.websocket.onclose=i=>{!e.socketStop&&Z()&&(c.isSocketWarning=!0,xe())},e.websocket.onmessage=i=>{c.isSocketWarning=!1,ht(i.data).forEach(t=>{if(!t)return!1;t.type==3?(pe(),e.data.whitespace=re(e.data.whitespace,Ie(E)),e.series.whitespace.setData(e.data.whitespace),_e(t.result),u.dispatch("tradingDerivative/setChartLoading",!1)):t.type==1&&t.target=="UpdateTrades"&&t.arguments[0]=="VN30F1M"&&(Kt(t.arguments[1].at(-1).price),_e(t.arguments[1]))})}}function ht(i){let r=[];return i.split("").forEach(t=>{const s=t.indexOf("{"),l=t.lastIndexOf("}");let o=null;if(s!==-1&&l!==-1&&l>s){const p=t.substring(s,l+1);p!="{}"&&(o=JSON.parse(p))}r.push(o)}),r}function gt(){e.currentSeconds=R(De(new Date,7)),Z()&&(P.value.position&&e.currentSeconds>A.ATC-5*60&&(c.isOrderWarning=!0,e.currentSeconds>A.ATC-15&&f.isSet(e.tools.order.tp.line)&&u.dispatch("tradingDerivative/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(i=>{i.isOk?(N(["entry","tp","sl"]),O.success(h("trading.derivative.autoCancelTpSlSuccess"))):B(i.message)})),_.value.openingMarket&&e.currentSeconds==A.START&&xe()),c.clock=fe(new Date,"HH:mm:ss")}function Y(i){const r="order";let t={isRemove:!1,name:r,points:[],data:[]},s,l;i.forEach(o=>{switch(o){case"entry":s="yellow",l=e.tools.order.side>0?"LONG":"SHORT";break;case"tp":s="lime",l=parseFloat(Math.abs(e.tools.order.tp.price-e.tools.order.entry.price).toFixed(1));break;case"sl":s="red",l=parseFloat(Math.abs(e.tools.order.sl.price-e.tools.order.entry.price).toFixed(1));break}if(t.points.push(o),f.isSet(e.tools.order[o].line))e.tools.order[o].line.applyOptions({price:e.tools.order[o].price,title:l}),t.data.push(e.tools.order[o].line.options());else{const p={lineType:r,kind:o,side:e.tools.order.side,price:e.tools.order[o].price,color:s,lineWidth:1,lineStyle:0,title:l,draggable:!0};e.tools.order[o].line=e.series.price.createPriceLine(p),t.data.push(p)}}),u.dispatch("tradingDerivative/drawTools",t)}function xt(i){Object.entries(i).forEach(([r,t])=>{e.tools.order.side=t.side,e.tools.order[r].price=t.price,e.tools.order[r].line=e.series.price.createPriceLine(t)})}function N(i,r=!0){r&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"order"}),i.forEach(t=>{f.isSet(e.tools.order[t].line)&&(e.series.price.removePriceLine(e.tools.order[t].line),delete e.tools.order[t].line)})}function yt(i){c.showTradingView=!c.showTradingView,i.stopPropagation()}function St(){c.showProgressContext=!c.showProgressContext,c.showScanContext=!1,c.showLineContext=!1,c.showProgressContext&&se()}function Tt(){Ct()}function Ct(i){const r=i??!_.value.autoRefresh;u.dispatch("tradingDerivative/setAutoRefresh",r)}function kt(i){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const r=i.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(t=>t.classList.remove("selected")),r||(X(!0),G(),i.target.classList.add("selected"))}function wt(){c.showScanContext=!c.showScanContext,c.showProgressContext=!1,c.showLineContext=!1}function Ft(){const i=c.scanSide=="left",r=e.crosshair.time?e.data.price.filter(s=>!S(s.time,i,e.crosshair.time)):e.data.price;let t=i?bt(r):Dt(r);f.isSet(t)&&(e.tools.pattern.points=Lt(t),X(),Te(),G(),ye()),ge.value.classList.remove("selected")}function bt(i){let r,[t,s,l,o]=Array(4).fill({});for(let p=i.length-1;p>=0;p--){const n=i[p].value,a=i[p].time,d=I(a);if(d==-1)break;if(p==i.length-1&&(l={index:d,time:a,price:n},[s,t,o]=Array(3).fill(null).map(()=>f.cloneDeep(l))),r==null){if(n==l.price)continue;r=n>l.price}if(S(n,r,s.price)&&(S(t.price,!r,l.price)?([l,s]=[s,t].map(v=>f.cloneDeep(v)),t={index:d,time:a,price:n},o=f.cloneDeep(t),r=!r):s={index:d,time:a,price:n}),S(n,!r,t.price)?(t={index:d,time:a,price:n},o=f.cloneDeep(t)):o.index=d,S(n,r,o.price)&&(o={index:d,time:a,price:n}),l.index>t.index){const v=Math.abs(s.price-l.price);if(v>=1.5&&(t.index-o.index>l.index-s.index||Math.abs(t.price-o.price)>v))break}}return{A:t,B:s,C:l}}function Dt(i){let r,[t,s,l]=Array(3).fill({});for(let o=0;o<i.length;o++){const p=i[o].value,n=i[o].time,a=I(n);if(a==-1)break;if(o==0&&(t={index:a,time:n,price:p},s=f.cloneDeep(t),l=f.cloneDeep(t)),r==null){if(p==t.price)continue;r=p>t.price}S(p,r,s.price)&&(s={index:a,time:n,price:p},l=f.cloneDeep(s)),S(s.price,r,t.price)&&S(p,!r,l.price)&&(S(p,r,t.price)?l={index:a,time:n,price:p}:(t=f.cloneDeep(s),s={index:a,time:n,price:p},l=f.cloneDeep(s),r=!r))}return{A:t,B:s,C:l}}function Lt(i){const r={};return Object.entries(i).forEach(([t,s])=>{const{index:l,...o}=s;r[t]=o}),r}function Ot(i){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const r=i.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(t=>t.classList.remove("selected")),r||(Te(),i.target.classList.add("selected"))}function Rt(i){i.target.classList.remove("selected"),X(!0),G()}function Et(){const i="pattern",r=ce(e.crosshair.y),t=e.crosshair.time;let s={lineType:i,price:r,lineWidth:1,lineStyle:1,draggable:!0};if(f.isSet(e.tools.pattern.lines.A))if(f.isSet(e.tools.pattern.lines.B)){let l,o;if(f.isSet(e.tools.pattern.lines.C)){let p,n;e.tools.pattern.points.A={time:t,price:r};const{progress:a,timeMark:d,info:{rEpr1:v,rEpr2:x,rEpr3:g,entry:T,pStatus:C,x:F,X:b,y:L,Y:k}}=oe();o=a,l=d,p="A",n={price:r,title:`A ${v}`},e.tools.pattern.lines[p].applyOptions(n),p="B",n={title:`B ${x}`},e.tools.pattern.lines[p].applyOptions(n),p="C",n={title:`C ${g}`},e.tools.pattern.lines[p].applyOptions(n),p="D",n={price:T,title:"Entry "+C},e.tools.pattern.lines[p].applyOptions(n),p="X",n={price:parseFloat(F.toFixed(1)),title:"X "+parseFloat(b.toFixed(1))},e.tools.pattern.lines[p].applyOptions(n),p="Y",n={price:parseFloat(L.toFixed(1)),title:"Y "+parseFloat(k.toFixed(1))},e.tools.pattern.lines[p].applyOptions(n)}else{e.tools.pattern.points.C={price:r};const{progress:p,timeMark:n,info:{rEpr1:a,rEpr2:d,rEpr3:v,entry:x,pStatus:g,x:T,X:C,y:F,Y:b}}=oe();o=p,l=n;let L="A";e.tools.pattern.lines[L].applyOptions({title:`A ${a}`}),L="B",e.tools.pattern.lines[L].applyOptions({title:`B ${d}`}),s.point="C",s.title=`C ${v}`,s.color="#FFEB3B",e.tools.pattern.lines[s.point]=e.series.price.createPriceLine(s),s.point="D",s.price=x,s.title="Entry "+g,s.color="#9C27B0",s.draggable=!1,e.tools.pattern.lines[s.point]=e.series.price.createPriceLine(s),s.point="Y",s.price=parseFloat(F.toFixed(1)),s.title="Y "+parseFloat(b.toFixed(1)),s.color="#E91E63",s.draggable=!1,e.tools.pattern.lines[s.point]=e.series.price.createPriceLine(s),s.point="X",s.price=parseFloat(T.toFixed(1)),s.title="X "+parseFloat(C.toFixed(1)),s.color="#2196F3",s.draggable=!1,e.tools.pattern.lines[s.point]=e.series.price.createPriceLine(s)}ae(o),ne(l),me.value.classList.remove("selected")}else s.point="B",s.title="B 0",s.color="#4CAF50",e.tools.pattern.lines[s.point]=e.series.price.createPriceLine(s),e.tools.pattern.points.B={price:r};else s.point="A",s.title="A 0",s.color="#F44336",e.tools.pattern.lines[s.point]=e.series.price.createPriceLine(s),e.tools.pattern.points={A:{time:t,price:r}};X()}function ye(){let r={lineType:"pattern",lineWidth:1,lineStyle:1,draggable:!0};const{A:t,B:s,C:l}=e.tools.pattern.points,{progress:o,timeMark:p,info:{rEpr1:n,rEpr2:a,rEpr3:d,entry:v,pStatus:x,x:g,X:T,y:C,Y:F}}=oe();ae(o),ne(p),r.point="A",r.title=`A ${n}`,r.color="#F44336",r.price=t.price,e.tools.pattern.lines[r.point]=e.series.price.createPriceLine(r),r.point="B",r.title=`B ${a}`,r.color="#4CAF50",r.price=s.price,e.tools.pattern.lines[r.point]=e.series.price.createPriceLine(r),r.point="C",r.price=l.price,r.title=`C ${d}`,r.color="#FFEB3B",e.tools.pattern.lines[r.point]=e.series.price.createPriceLine(r),r.point="D",r.price=v,r.title="Entry "+x,r.color="#9C27B0",r.draggable=!1,e.tools.pattern.lines[r.point]=e.series.price.createPriceLine(r),r.point="Y",r.price=parseFloat(C.toFixed(1)),r.title="Y "+parseFloat(F.toFixed(1)),r.color="#E91E63",r.draggable=!1,e.tools.pattern.lines[r.point]=e.series.price.createPriceLine(r),r.point="X",r.price=parseFloat(g.toFixed(1)),r.title="X "+parseFloat(T.toFixed(1)),r.color="#2196F3",r.draggable=!1,e.tools.pattern.lines[r.point]=e.series.price.createPriceLine(r)}function se(i=!1){f.isSet(e.tools.pattern.lines.C)&&(i&&Pt(),G(),ye())}function At({A:{time:i}}){return e.data.price.some(r=>r.time===i)}function oe(){const{A:i,B:r,C:t}=e.tools.pattern.points,s=r.price-t.price,l=s>0,o=Se({phase:1,start:i,end:r,retracementPrice:t.price});let p=Se({phase:2,start:o.R,end:t});const n=Se({phase:3,start:p.R,end:{price:r.price+(l?1:-1)*o.rEp},breakPrices:[p.S1.price,r.price]});o.xBox.tr>=p.tr&&(p.tr=o.xBox.tr),console.log("calculatePattern",[o,p,n]);const a=Math.abs(s)>o.pr,d=Math.abs(t.price-n.xBox.R.price)>p.pr,v=n.xBox.pr>n.pr,x=S(t.price,l,o.S1.price),g=S(n.xBox.R.price,!l,p.S1.price),T=S(n.xBox.S.price,l,n.S1.price),C=o.R.index+o.tr,F=p.R.index+p.tr,b=n.xBox.R.index+n.tr,L=n.xBox.R.index+p.tr,k=[C,F,b,L],w=n.xBox.S.index,M=w<C+3*o.tr||n.breakIndexs[1],Ne=w<F+3*p.tr||n.breakIndexs[1],oi=w<b+3*n.tr||n.breakIndexs[1];let J,y={};y.steps=[[o.rEp>=1,o.rEt<o.tr||o.rEp>=o.sEp,o.rEpr>=1,o.rEpr>p.rEpr,a,x,w>C,M],[o.rEpr<3,C<p.R.index,F>C],[d,w>F,Ne,v,T],[C<p.R.index,w>b,oi],[C>=p.R.index,w>b,w>L]],y.step=1,y.result=y.steps[0].every(Boolean),J=o.R1.price,y.result&&(w<=F?(y.step=2,y.result=y.steps[1].every(Boolean),J=p.S1.price):(J=n.R1.price,n.breakIndexs[0]&&n.breakIndexs[0]<F&&y.steps[1].every(Boolean)?(y.step=2,y.result=!0):(y.step=3,y.result=y.steps[2].every(Boolean),y.result&&(C<p.R.index?(y.step=4,y.result=y.steps[3].every(Boolean),y.result&&(J=n.xBox.R.price)):(y.step=5,y.result=y.steps[4].every(Boolean),y.result&&(J=n.xBox.R.price))))));const ni=`${x?a?1:0:2}${g?d?1:0:2}${T?v?1:0:2}`,ai=parseFloat(o.rEpr.toFixed(1)),li=parseFloat(p.rEpr.toFixed(1)),ci=parseFloat(n.rEpr.toFixed(1)),ue=o.rEp,pi=Me(r.price,ue,l),Xe=parseInt((n.breakIndexs[1]-o.R.index)/o.tr),ze=Xe>1?ue*Xe:ue,di=Me(r.price,ze,l);return{progress:y,timeMark:k,info:{rEpr1:ai,rEpr2:li,rEpr3:ci,entry:J,pStatus:ni,x:pi,X:ue,y:di,Y:ze}}}function Se({phase:i,start:r,end:t,breakPrices:s,retracementPrice:l}){let o=f.cloneDeep(r),p=f.cloneDeep(t);const n=p.price>o.price;let a={},d={},v={},x=[null,null],g,T,C,F;return e.data.price.filter(b=>{let L=b.time>=o.time;return e.tools.pickTime&&(L&=b.time<=e.tools.pickTime),L}).every((b,L)=>{const k=b.value,w=b.time,M=I(w);return M==-1?!1:((L==0||k==o.price)&&(a={R:{index:M,time:w,price:k},S:{index:M,time:w,price:k},pr:0,tr:0},d=f.cloneDeep(a),v=f.cloneDeep(a)),S(k,n,a.R.price)?(Math.abs(a.R.price-d.R.price)<.2&&S(a.S.price,!n,d.R.price)&&a.pr<d.pr&&(d.S.index=a.S.index,d.tr=d.S.index-d.R.index),a.tr>=d.tr&&a.pr>=d.pr&&(d=f.cloneDeep(a)),i==1&&l&&!S(a.S.price,!n,l)&&a.tr>=v.tr&&a.pr>=v.pr&&(v=f.cloneDeep(a)),a={R:{index:M,time:w,price:k},S:{index:M,time:w,price:k},pr:0,tr:0},i==3&&s&&(!x[0]&&S(k,n,s[0])&&(x[0]=M),!x[1]&&S(k,n,s[1])&&(x[1]=M))):(a.S.index=M,a.tr=a.S.index-a.R.index,S(k,!n,a.S.price)&&(a.S.time=w,a.S.price=k,a.pr=Math.abs(a.S.price-a.R.price))),S(k,!n,o.price)?(a.S.price=o.price,!1):!!S(k,!n,p.price))}),f.isSet(a)&&(o.index=I(o.time),p.index=a.S.index,p.time=de(a.S.index),g=Math.abs(p.price-d.R.price),T=Math.abs(o.price-d.S.price),C=p.index-d.S.index,F=Math.abs(p.price-o.price)/(p.index-o.index),i==3&&(v=a)),{tr:d.tr,pr:d.pr,rEp:g,sEp:T,rEpr:d.pr?g/d.pr:0,rEt:C,v:F,S1:d.S,R1:d.R,xBox:v,S:o,R:p,breakIndexs:x}}function Me(i,r,t){const s=i+(t?1:-1)*r;let l=parseFloat((s%1).toFixed(1));if(t){if(l>=.1&&l<=.2)return Math.floor(s);if(l>=.6&&l<=.7)return Math.floor(s)+.5}else{if(l>=.8&&l<=.9)return Math.ceil(s);if(l>=.3&&l<=.4)return Math.floor(s)+.5}return s}function Pt(){if(!e.tools.pickTime)return!1;let i=e.tools.pattern.points;const r=i.B.price-i.A.price>0,t=e.data.price.at(-1).value;if(S(t,!r,i.C.price)){let s=t;for(let l=e.data.price.length-1;l>=0;l--){const o=e.data.price[l].value;if(o==i.B.price)break;s=r?Math.min(s,o):Math.max(s,o)}i.C.price=s,e.tools.pattern.points=i,X()}}function X(i=!1){let r={isRemove:i,name:"pattern",points:[],data:[]};i?e.tools.pattern.points={}:Object.entries(e.tools.pattern.points).forEach(([t,s])=>{r.points.push(t),r.data.push(s)}),u.dispatch("tradingDerivative/drawTools",r)}function G(){f.isSet(e.tools.pattern.lines.A)&&(e.series.price.removePriceLine(e.tools.pattern.lines.A),f.isSet(e.tools.pattern.lines.B)&&(e.series.price.removePriceLine(e.tools.pattern.lines.B),f.isSet(e.tools.pattern.lines.C)&&(e.series.price.removePriceLine(e.tools.pattern.lines.C),e.series.price.removePriceLine(e.tools.pattern.lines.D),e.series.price.removePriceLine(e.tools.pattern.lines.X),e.series.price.removePriceLine(e.tools.pattern.lines.Y)))),z(["pattern"]),ne([]),ae({})}function ne(i){const r=["#F44336","#4CAF50","#FFEB3B","#2196F3"];let t=[];for(let s=0;s<i.length;s++){const l=de(i[s]);l&&t.push({time:l,value:1,color:r[s]})}t.length&&t.sort((s,l)=>s.time-l.time),e.series.timeMark.setData(t)}function ae(i){c.progress=i}function Bt(i){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const r=i.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(t=>t.classList.remove("selected")),r||i.target.classList.add("selected")}function _t(i){i.target.classList.remove("selected"),Te(),se()}function It(){const i=e.crosshair.time;u.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"0_pt",points:[0],data:[i]}),Ve(i),se(),ve.value.classList.remove("selected")}function Ve(i){e.tools.pickTime=i,e.series.pickTime.setData([{time:i,value:1,color:"#9C27B0"}])}function Te(i=!0){i&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"0_pt"}),e.series.pickTime.setData([]),z(["pt"])}function Mt(i){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const r=i.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(t=>t.classList.remove("selected")),r||i.target.classList.add("selected")}function Vt(i){We(),i.target.classList.remove("selected")}function Wt(){let i={isRemove:!1,name:"tr",points:[],data:[]};const r=e.crosshair.time;let t={time:r,value:1};switch(e.tools.timeRange.length){case 0:t.color="OrangeRed",e.tools.timeRange[0]=t,i.points.push(0),i.data.push(r);break;case 1:t.color="lime",e.tools.timeRange[1]=t,i.points.push(1),i.data.push(r),ie.value.classList.remove("selected");break;default:const s=I(e.tools.timeRange[0].time),l=I(e.tools.timeRange[1].time),p=I(r)+(l-s),n=de(p);t.color="OrangeRed",e.tools.timeRange[0]=f.cloneDeep(t),i.points.push(0),i.data.push(r),t.time=n,t.color="lime",e.tools.timeRange[1]=t,i.points.push(1),i.data.push(n),ie.value.classList.remove("selected");break}e.series.timeRange.setData(e.tools.timeRange),u.dispatch("tradingDerivative/drawTools",i)}function Zt(i){let r,t;if(i.length==2)r=i[0],t=i[1];else if(i.length==3){const l=I(i[0]),o=I(i[1]),n=I(i[2])+(o-l);r=i[2],t=de(n)}else return!1;let s=[{time:r,value:1,color:"OrangeRed"},{time:t,value:1,color:"lime"}];e.tools.timeRange=s,e.series.timeRange.setData(s)}function We(i=!0){i&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"tr"}),e.series.timeRange.setData([]),z(["tr"])}function $t(i){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const r=i.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(t=>t.classList.remove("selected")),r||i.target.classList.add("selected")}function Yt(i){c.showLineContext=!c.showLineContext,c.showProgressContext=!1,c.showScanContext=!1}function Nt(){const i="line",r=ce(e.crosshair.y),t=e.tools.lines.length;if(e.tools.lines=e.tools.lines.filter(s=>{const l=s.options(),o=l.type=r==+l.price;return o&&(e.series.price.removePriceLine(s),u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:i,point:r})),!o}),e.tools.lines.length==t){const s=c.lineColor,l=c.lineTitle,o={lineType:i,price:r,color:s,title:l,lineWidth:1,lineStyle:1,draggable:!0};e.tools.lines.push(e.series.price.createPriceLine(o)),u.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:i,points:[r],data:[{color:s,title:l}]})}te.value.classList.remove("selected")}function Xt(i){const t={lineType:"line",lineWidth:1,lineStyle:1,draggable:!0};Object.entries(i).forEach(([s,{color:l,title:o}])=>{t.price=+s,t.color=l,t.title=o,e.tools.lines.push(e.series.price.createPriceLine(t))})}function Ze(i=!0){e.tools.lines.length>0&&(i&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line"}),e.tools.lines.forEach(r=>e.series.price.removePriceLine(r)),z(["lines"]))}function zt(i){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const r=i.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(t=>t.classList.remove("selected")),r||(i.target.classList.add("selected"),Ce())}function Jt(i){Ce(),i.target.classList.remove("selected")}function Ht(){const i="target",r=ce(e.crosshair.y);let t={lineType:i,price:r,lineWidth:1,lineStyle:1,draggable:!0},s={isRemove:!1,name:i,points:[],data:[r]};if(f.isSet(e.tools.target.A)){const l=+e.tools.target.A.options().price,o=r-l;t.point="B",t.title=parseFloat(o.toFixed(1)),t.color="#F44336",e.tools.target[t.point]=e.series.price.createPriceLine(t),s.points.push(t.point),t.point="X",t.price=parseFloat((l-.5*o).toFixed(1)),t.title=parseFloat((-.5*o).toFixed(1)),t.color="#2196F3",e.tools.target[t.point]=e.series.price.createPriceLine(t),t.point="Y",t.price=parseFloat((l-o).toFixed(1)),t.title=parseFloat(-o.toFixed(1)),t.color="#673AB7",e.tools.target[t.point]=e.series.price.createPriceLine(t),t.point="Z",t.price=parseFloat((l-2*o).toFixed(1)),t.title=parseFloat((-2*o).toFixed(1)),t.color="#9C27B0",e.tools.target[t.point]=e.series.price.createPriceLine(t),t.point="W",t.price=parseFloat((l-4*o).toFixed(1)),t.title=parseFloat((-4*o).toFixed(1)),t.color="#E91E63",e.tools.target[t.point]=e.series.price.createPriceLine(t),he.value.classList.remove("selected")}else t.point="A",t.title="0",t.color="#FF9800",e.tools.target[t.point]=e.series.price.createPriceLine(t),s.points.push(t.point);u.dispatch("tradingDerivative/drawTools",s)}function jt(i){let t={lineType:"target",lineWidth:1,lineStyle:1,draggable:!0};const s=i.A,l=i.B,o=l-s;t.point="A",t.price=s,t.title="0",t.color="#FF9800",e.tools.target[t.point]=e.series.price.createPriceLine(t),t.point="B",t.price=l,t.title=parseFloat(o.toFixed(1)),t.color="#F44336",e.tools.target[t.point]=e.series.price.createPriceLine(t),t.point="X",t.price=parseFloat((s-.5*o).toFixed(1)),t.title=parseFloat((-.5*o).toFixed(1)),t.color="#2196F3",e.tools.target[t.point]=e.series.price.createPriceLine(t),t.point="Y",t.price=parseFloat((s-o).toFixed(1)),t.title=parseFloat(-o.toFixed(1)),t.color="#673AB7",e.tools.target[t.point]=e.series.price.createPriceLine(t),t.point="Z",t.price=parseFloat((s-2*o).toFixed(1)),t.title=parseFloat((-2*o).toFixed(1)),t.color="#9C27B0",e.tools.target[t.point]=e.series.price.createPriceLine(t),t.point="W",t.price=parseFloat((s-4*o).toFixed(1)),t.title=parseFloat((-4*o).toFixed(1)),t.color="#E91E63",e.tools.target[t.point]=e.series.price.createPriceLine(t)}function Ce(i=!0){i&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"target"}),f.isSet(e.tools.target.A)&&(e.series.price.removePriceLine(e.tools.target.A),f.isSet(e.tools.target.B)&&(e.series.price.removePriceLine(e.tools.target.B),e.series.price.removePriceLine(e.tools.target.X),e.series.price.removePriceLine(e.tools.target.Y),e.series.price.removePriceLine(e.tools.target.Z),e.series.price.removePriceLine(e.tools.target.W))),z(["target"])}function qt(){N(["entry","tp","sl"],!1),Ze(!1),Ce(!1),We(!1),G()}function le(i){if(i){if(Z()&&(f.isSet(e.tools.order.tp.line)||P.value.position&&e.currentSeconds>A.ATO&&e.currentSeconds<A.ATC&&(U.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-61?-61:1))+"px",U.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-51?-51:1))+"px",U.value.style.display="block"),!f.isSet(e.tools.order.entry.line))){let r=null,t=0;P.value.position?(e.currentSeconds<A.ATO?r="ATO":e.currentSeconds>A.ATC&&(r="ATC"),r&&(e.tools.order.entry.price=r,t=-P.value.position)):e.currentSeconds>A.ATO&&e.currentSeconds<A.ATC&&(r=ce(e.crosshair.y),t=r>=e.data.price.at(-1).value?1:-1,e.tools.order.side=t,e.tools.order.entry.price=r),t&&($.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-71?-71:1))+"px",$.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-61?-61:1))+"px",$.value.style.background=t>0?"green":"red",$.value.innerText=`${t>0?"LONG":"SHORT"} ${r}`,$.value.style.display="block")}}else $.value.style.display="none",U.value.style.display="none"}function Qt(){Z()&&(e.currentSeconds<A.ATO?He(h("trading.derivative.atoOrder"),h("titles.confirm")).then(r=>{r&&u.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(t=>{t.isOk?O.success(h("trading.derivative.atoOrderSuccess")):B(t.message)})}):e.currentSeconds<A.ATC?u.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"new",side:e.tools.order.side,price:e.tools.order.entry.price}}).then(i=>{i.isOk?(Y(["entry"]),O.success(h("trading.derivative.newEntrySuccess"))):B(i.message)}):He(h("trading.derivative.atcOrder"),h("titles.confirm")).then(r=>{r&&u.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(t=>{t.isOk?O.success(h("trading.derivative.atcOrderSuccess")):B(t.message)})}))}function Ut(){e.tools.order.tp.price=e.tools.order.entry.price+e.tools.order.side*je,e.tools.order.sl.price=e.tools.order.entry.price-e.tools.order.side*qe,u.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.tools.order.tp.price},slData:{cmd:"new",price:e.tools.order.sl.price}}).then(i=>{i.isOk?(e.tools.order.entry.line.applyOptions({draggable:!1}),Y(["entry","tp","sl"]),O.success(h("trading.derivative.newTpSlSuccess"))):B(i.message)})}function Gt(){f.isSet(e.tools.order.entry.line)?f.isSet(e.tools.order.tp.line)?u.dispatch("tradingDerivative/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(i=>{i.isOk?(N(["entry","tp","sl"]),O.success(h("trading.derivative.exitSuccess"))):B(i.message)}):u.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"delete"}}).then(i=>{i.isOk?(N(["entry"]),O.success(h("trading.derivative.deleteEntrySuccess"))):B(i.message)}):pe()}function Kt(i){f.isSet(e.tools.order.entry.line)&&(f.isSet(e.tools.order.tp.line)?((e.tools.order.side>0&&i>=e.tools.order.tp.price||e.tools.order.side<0&&i<=e.tools.order.tp.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,u.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"delete"}}).then(r=>{r.isOk?(N(["entry","tp","sl"]),O.success(h("trading.derivative.deleteTpSuccess")),le(!1)):B(r.message),e.isAutoOrdering=!1}))),(e.tools.order.side>0&&i<=e.tools.order.sl.price||e.tools.order.side<0&&i>=e.tools.order.sl.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,u.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"cancel"}}).then(r=>{r.isOk?(N(["entry","tp","sl"]),O.success(h("trading.derivative.deleteSlSuccess")),le(!1)):B(r.message),e.isAutoOrdering=!1})))):(e.tools.order.side>0&&i>=e.tools.order.entry.price||e.tools.order.side<0&&i<=e.tools.order.entry.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,setTimeout(()=>{e.tools.order.tp.price=e.tools.order.entry.price+e.tools.order.side*je,e.tools.order.sl.price=e.tools.order.entry.price-e.tools.order.side*qe,u.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.tools.order.tp.price},slData:{cmd:"new",price:e.tools.order.sl.price}}).then(r=>{r.isOk?(e.tools.order.entry.line.applyOptions({draggable:!1}),Y(["entry","tp","sl"]),O.success(h("trading.derivative.autoNewTpSlSuccess"))):B(r.message),e.isAutoOrdering=!1})},1e3))))}function ei(){e.chart.timeScale().scrollToRealTime()}function Z(){return _.value.openingMarket&&e.currentSeconds>=A.START&&e.currentSeconds<=A.END}function ce(i){return parseFloat(e.series.price.coordinateToPrice(i).toFixed(1))}function B(i){i||(i="unknown"),O.error(h(`trading.derivative.${i}`))}function ti(){if(!c.chartDate)return!1;ke()}function $e(){Z()&&e.websocket.send(e.socketSendData)}function ii(){e.data.whitespace=[],e.data.price=[],$e(),ke()}function ri(){u.dispatch("tradingDerivative/initChart").then(()=>{Z()&&xe(),!Le.query.date&&_.value.lastOpeningDate&&(c.chartDate=_.value.lastOpeningDate),ke()})}function ke(){u.dispatch("tradingDerivative/getChartData",c.chartDate).then(i=>{i&&pe()})}function Ye(){u.dispatch("tradingDerivative/getStatus")}function pe(){u.dispatch("tradingDerivative/getTools")}function z(i){i||(i=["order","lines","tr","pattern","target","pt"]),i.includes("order")&&(e.tools.order={side:0,entry:{},tp:{},sl:{}}),i.includes("lines")&&(e.tools.lines=[]),i.includes("target")&&(e.tools.target={}),i.includes("tr")&&(e.tools.timeRange=[]),i.includes("pattern")&&(e.tools.pattern.lines={}),i.includes("pt")&&(e.tools.pickTime=null)}function si(){u.dispatch("tradingDerivative/getAccountInfo").then(i=>{let r="";r+='<div style="width: 200px;">',r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${h("trading.derivative.nav")}</div><div>: ${ee.currency(i.nav)}</div></div>`,r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${h("trading.derivative.maxVol")}</div><div>: ${ee.numberVnFormat(i.maxVol)}</div></div>`,r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${h("trading.derivative.vm")}</div><div>: ${ee.currency(i.vm)}</div></div>`,r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${h("trading.derivative.fee")}</div><div>: ${ee.currency(i.fee)}</div></div>`,r+="</div>",wi(r,h("trading.derivative.accountInfo"))})}function S(i,r,t,s=!1){return r?s?i>=t:i>t:s?i<=t:i<t}function I(i){let r=e.data.whitespace.findIndex(t=>t.time==i);if(r==-1){const t=fe(new Date(i*1e3),"yyyy-MM-dd"),s=R(new Date(`${t}T11:30:00Z`)),l=R(new Date(`${t}T13:00:00Z`)),o=R(new Date(`${t}T14:30:00Z`));i>s&&i<l?i=s:i>o&&(i=o),r=e.data.whitespace.findIndex(p=>p.time==i)}return r}function de(i){return i<e.data.whitespace.length?e.data.whitespace[i].time:!1}return(i,r)=>(Fi(),yi("div",{class:"derivative-container",ref_key:"chartContainerRef",ref:V,onClick:nt,onContextmenu:at},[m("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:Oe},[m("div",{class:"area data-area",onClick:Ee,onContextmenu:Ae},[m("div",{ref_key:"connectionRef",ref:Ue,class:W(["command",{yellow:P.value.pending,red:_.value.volInValid}]),title:i.$t("trading.derivative.connection"),onClick:Ye},[m("i",{class:W(["far",{"fa-link-simple":P.value.connection,"fa-link-simple-slash":!P.value.connection,blink:c.isSocketWarning}])},null,2)],10,Ei),m("div",{class:W(["command status",{green:P.value.position>0,red:P.value.position<0}]),title:i.$t("trading.derivative.position"),onClick:si},Je(P.value.position),11,Ai),m("div",{class:"command clock",onClick:$e},Je(c.clock),1),j(m("input",{type:"date",class:"chart-date command",title:i.$t("trading.derivative.date"),"onUpdate:modelValue":r[0]||(r[0]=t=>c.chartDate=t),onChange:ti},null,40,Pi),[[Si,c.chartDate]]),m("div",{ref_key:"reloadToolRef",ref:et,class:"command",title:i.$t("trading.derivative.reload"),onClick:ii,onContextmenu:pe},[m("i",{class:W(["far fa-sync-alt",{"fa-spin":rt.value}])},null,2)],40,Bi)],32),m("div",{class:"area tool-area",onClick:Ee,onContextmenu:Ae},[m("div",{ref_key:"fullscreenToolRef",ref:Ge,class:"command",title:i.$t("trading.derivative.fullscreen"),onClick:dt},[m("i",{class:W(["far",{"fa-compress":c.isFullscreen,"fa-expand":!c.isFullscreen}])},null,2)],8,_i),m("div",{ref_key:"tradingviewRef",ref:tt,class:"command far fa-chart-candlestick",title:i.$t("trading.derivative.tradingview"),onClick:yt},null,8,Ii),m("div",{class:W(["context command",{green:c.progress.result==!0,red:c.progress.result==!1}]),title:i.$t("trading.derivative.progressTool"),onClick:St,onContextmenu:Tt},[m("i",{class:W(["far",{"fa-badge-check":!c.progress.step,[`fa-circle-${c.progress.step}`]:c.progress.step,blink:_.value.autoRefresh}])},null,2),j(Fe(Li,{class:"contextmenu",progress:c.progress},null,8,["progress"]),[[K,c.showProgressContext]])],42,Mi),m("div",{ref_key:"scanToolRef",ref:ge,class:"context command",title:i.$t("trading.derivative.scanTool"),onClick:kt,onContextmenu:wt},[m("i",{class:W(["far",{[`fa-angles-${c.scanSide}`]:!0}])},null,2),j(Fe(Di,{class:"contextmenu",modelValue:c.scanSide,"onUpdate:modelValue":r[1]||(r[1]=t=>c.scanSide=t)},null,8,["modelValue"]),[[K,c.showScanContext]])],40,Vi),m("div",{ref_key:"patternToolRef",ref:me,class:"command",title:i.$t("trading.derivative.patternTool"),onClick:Ot,onContextmenu:Rt},$i,40,Wi),m("div",{ref_key:"pickTimeToolRef",ref:ve,class:"command",title:i.$t("trading.derivative.pickTimeTool"),onClick:Bt,onContextmenu:_t},Xi,40,Yi),m("div",{ref_key:"lineToolRef",ref:te,class:"context command",title:i.$t("trading.derivative.lineTool"),onClick:$t,onContextmenu:Yt},[Ji,j(Fe(bi,{class:"contextmenu",enable:c.showLineContext,title:c.lineTitle,"onUpdate:title":r[2]||(r[2]=t=>c.lineTitle=t),color:c.lineColor,"onUpdate:color":r[3]||(r[3]=t=>c.lineColor=t),onDeleteAllLine:Ze},null,8,["enable","title","color"]),[[K,c.showLineContext]])],40,zi),m("div",{ref_key:"timeRangeToolRef",ref:ie,class:"command",title:i.$t("trading.derivative.timeRangeTool"),onClick:Mt,onContextmenu:Vt},qi,40,Hi),m("div",{ref_key:"targetToolRef",ref:he,class:"command",title:i.$t("trading.derivative.targetTool"),onClick:zt,onContextmenu:Jt},Gi,40,Qi),j(m("div",{ref_key:"cancelOrderRef",ref:it,class:"cancel-order command",title:i.$t("trading.derivative.cancelTool"),onClick:Gt},[m("i",{class:W(["far fa-trash-alt",{blink:c.isOrderWarning}])},null,2)],8,Ki),[[K,st.value]])],32),m("div",null,[m("div",{ref_key:"entryOrderRef",ref:$,class:"order-button entry",onClick:Qt}," Entry ",512),m("div",{ref_key:"tpslOrderRef",ref:U,class:"order-button tpsl",onClick:Ut}," TP/SL ",512),m("div",{class:"chart-top command far fa-angle-double-right",onClick:ei})]),j(m("iframe",{ref_key:"tradingviewChartRef",ref:Ke,class:"tradingview-chart",style:Ti(c.tradingViewStyle),src:ot.value},null,12,er),[[K,c.showTradingView]])],512)],544))}};export{ur as default};
