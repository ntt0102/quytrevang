import{z as pt,A as dt,B as ut,r as N,y as Ye,C as et,o as H,b as J,d as B,E as ae,c as ce,G as Te,H as be,I as ft,J as mt,m as tt,e as ee,F as We,K as Ze,t as ye,h as me,u as Oe,k as fe,L as vt,M as ht,N as Ue,O as it,g as nt,w as ve,Q as gt,R as St,S as Qe,x as se,l as Le,a as yt,T as Me,U as Tt,j as xt,V as Ct}from"./app-bc93ddf7.js";import{_ as kt}from"./text-box-534b73f0.js";import{g as G}from"./getUnixTime-48cc3a66.js";import{c as _t}from"./lightweight-charts.esm.development-03366bac.js";function rt(E,I,T){return pt((T==null?void 0:T.in)||E,+dt(E)+I)}function _e(E,I,T){return rt(E,I*ut,T)}function bt(E,I,T){return rt(E,I*1e3,T)}function Ve(E,I,T){return bt(E,-I,T)}const wt=["title"],Dt={__name:"FullscreenTool",props:["chartContainerRef"],setup(E){const I=E,T=N(!1);Ye(()=>{document.addEventListener("fullscreenchange",t)}),et(()=>{document.removeEventListener("fullscreenchange",t)});function f(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function t(){I.chartContainerRef&&(document.fullscreenElement?(T.value=!0,I.chartContainerRef.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(T.value=!1,I.chartContainerRef.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}return(s,y)=>(H(),J("div",{class:"command",title:s.$t("trading.derivative.fullscreen"),onClick:f},[B("i",{class:ae(["far",{"fa-compress":T.value,"fa-expand":!T.value}])},null,2)],8,wt))}},Rt=["title"],Et=["src"],Lt={__name:"TradingviewTool",props:["vpsUser","vpsSession","chartContainerRef"],setup(E){const I=E,T=N(null),f=N(!1),t=ce(()=>`https://chart.vps.com.vn/tv/?u=${I.vpsUser}&s=${I.vpsSession}&symbol=VN30F1M&resolution=1&lang=vi`);function s(C){f.value=!f.value,y(),C.stopPropagation()}function y(){if(I.chartContainerRef&&T.value){const{offsetWidth:C,offsetHeight:R}=I.chartContainerRef,{top:u,left:h}=T.value.getBoundingClientRect();T.value.style.top=`${u-2}px`,T.value.style.left=`${h+32}px`,T.value.style.width=`${C-34}px`,T.value.style.height=`${R}px`}}return(C,R)=>(H(),J("div",{class:"tradingview command far fa-chart-candlestick",title:C.$t("trading.derivative.tradingview"),onClick:s},[Te(B("iframe",{ref_key:"tradingviewRef",ref:T,class:"chart",src:t.value},null,8,Et),[[be,f.value]])],8,Rt))}};const Ot=B("div",{class:"triangle-shadow"},null,-1),Pt=B("div",{class:"triangle"},null,-1),$t={class:"container"},It={__name:"ProgressContext",props:["progress"],emits:["refreshPattern"],setup(E,{emit:I}){const T=I,f=N([]);Ye(()=>{t()});function t(){ft(Object.assign({"../../../../../lang/vi/derivative.js":()=>mt(()=>import("./derivative-0a1a41d1.js"),[])}),`../../../../../lang/${window.lang}/derivative.js`).then(C=>{f.value=C.default||[]})}function s(){T("refreshPattern")}function y(C){C.stopPropagation()}return(C,R)=>{const u=tt("DxButton");return H(),J("div",{class:"pattern-context",onClick:y},[Ot,Pt,B("div",null,[ee(u,{icon:"refresh",type:"success",text:C.$t("trading.derivative.progressContext.refreshPattern"),onClick:s},null,8,["text"])]),B("div",$t,[(H(!0),J(We,null,Ze(f.value,(h,p)=>(H(),J("div",{key:p,class:ae(["step",[E.progress.step&&E.progress.step===p+1?E.progress.result?"success":"fail":""]])},[B("div",{class:ae(["name",[E.progress.steps?E.progress.steps[p].every(Boolean)?"success":"fail":""]])},ye(p+1)+". "+ye(h.name),3),B("div",null,[(H(!0),J(We,null,Ze(h.conds,(V,F)=>(H(),J("div",{key:F,class:ae(["condition",[E.progress.steps?E.progress.steps[p][F]?"success":"fail":""]])},ye(F+1)+". "+ye(V),3))),128))])],2))),128))])])}}},At=["title"],Nt={__name:"ProgressTool",props:["position"],emits:["refreshPattern","hideContext"],setup(E,{expose:I,emit:T}){const f=me(),{t}=Oe(),s=fe("mf"),y=E,C=T,R=N({}),u=N(!1),h=ce(()=>f.state.tradingDerivative.config.autoRefresh);I({hide:V,set:F});function p(){const r=u.value;C("hideContext"),u.value=!r,u.value&&Z()}function V(r){u.value=r}function F(r){!y.position&&h.value&&A(r,R.value),R.value=r}function Z(){C("refreshPattern")}function W(r){const m=r??!m.value;f.dispatch("tradingDerivative/setAutoRefresh",m)}function A(r,m){if(s.isSet(r)&&(r.step!==m.step||r.step===m.step&&r.result!==m.result)){let i="";r.result?[2,4].includes(r.step)?i=t("trading.derivative.progressOrder",r):i=t("trading.derivative.progressSuccess",r):i=t("trading.derivative.progressFail",r),S(i)}}function S(r){const m=new SpeechSynthesisUtterance(r);m.lang="vi-VN",speechSynthesis.speak(m)}return(r,m)=>(H(),J("div",{class:ae(["context command",{green:R.value.result===!0,red:R.value.result===!1}]),title:r.$t("trading.derivative.progressTool"),onClick:p,onContextmenu:W},[B("i",{class:ae(["far",{"fa-badge-check":!R.value.step,[`fa-circle-${R.value.step}`]:R.value.step,blink:h.value}])},null,2),Te(ee(It,{class:"contextmenu",progress:R.value,onRefreshPattern:Z},null,8,["progress"]),[[be,u.value]])],42,At))}};var xe={};const Bt=vt(ht);/*!
 * devextreme-vue
 * Version: 22.2.12
 * Build date: Mon Apr 29 2024
 *
 * Copyright (c) 2012 - 2024 Developer Express Inc. ALL RIGHTS RESERVED
 *
 * This software may be modified and distributed under the terms
 * of the MIT license. See the LICENSE file in the root of the project for details.
 *
 * https://github.com/DevExpress/devextreme-vue
 */var Ft=Ue&&Ue.__importDefault||function(E){return E&&E.__esModule?E:{default:E}};Object.defineProperty(xe,"__esModule",{value:!0});xe.DxItem=xe.DxButtonGroup=void 0;var Mt=Ft(Bt),Vt=it,Wt=it,st=Vt.createComponent({props:{accessKey:String,activeStateEnabled:Boolean,buttonTemplate:{},disabled:Boolean,elementAttr:Object,focusStateEnabled:Boolean,height:[Function,Number,String],hint:String,hoverStateEnabled:Boolean,items:Array,keyExpr:[Function,String],onContentReady:Function,onDisposing:Function,onInitialized:Function,onItemClick:Function,onOptionChanged:Function,onSelectionChanged:Function,rtlEnabled:Boolean,selectedItemKeys:Array,selectedItems:Array,selectionMode:String,stylingMode:String,tabIndex:Number,visible:Boolean,width:[Function,Number,String]},emits:{"update:isActive":null,"update:hoveredElement":null,"update:accessKey":null,"update:activeStateEnabled":null,"update:buttonTemplate":null,"update:disabled":null,"update:elementAttr":null,"update:focusStateEnabled":null,"update:height":null,"update:hint":null,"update:hoverStateEnabled":null,"update:items":null,"update:keyExpr":null,"update:onContentReady":null,"update:onDisposing":null,"update:onInitialized":null,"update:onItemClick":null,"update:onOptionChanged":null,"update:onSelectionChanged":null,"update:rtlEnabled":null,"update:selectedItemKeys":null,"update:selectedItems":null,"update:selectionMode":null,"update:stylingMode":null,"update:tabIndex":null,"update:visible":null,"update:width":null},computed:{instance:function(){return this.$_instance}},beforeCreate:function(){this.$_WidgetClass=Mt.default,this.$_hasAsyncTemplate=!0,this.$_expectedChildren={item:{isCollectionItem:!0,optionName:"items"}}}});xe.DxButtonGroup=st;var ze=Wt.createConfigurationComponent({emits:{"update:isActive":null,"update:hoveredElement":null,"update:disabled":null,"update:elementAttr":null,"update:hint":null,"update:html":null,"update:icon":null,"update:template":null,"update:text":null,"update:type":null,"update:visible":null},props:{disabled:Boolean,elementAttr:Object,hint:String,html:String,icon:String,template:{},text:String,type:String,visible:Boolean}});xe.DxItem=ze;ze.$_optionName="items";ze.$_isCollectionItem=!0;var Zt=xe.default=st;const Yt=B("div",{class:"triangle-shadow"},null,-1),zt=B("div",{class:"triangle"},null,-1),Ht={__name:"ScanContext",props:["modelValue"],emits:["update:modelValue"],setup(E,{emit:I}){const{t:T}=Oe(),f=[{icon:"chevrondoubleleft",side:"left",text:T("trading.derivative.scanContext.leftScan")},{icon:"chevrondoubleright",side:"right",text:T("trading.derivative.scanContext.rightScan")}],t=E,s=I;function y({itemData:{side:R}}){s("update:modelValue",R)}function C(R){R.stopPropagation()}return(R,u)=>(H(),J("div",{class:"scan-context",onClick:C},[Yt,zt,ee(nt(Zt),{items:f,"selected-item-keys":[t.modelValue],"key-expr":"side","styling-mode":"outlined",onItemClick:y},null,8,["selected-item-keys"])]))}},Jt=["title"],Xt={__name:"ScanTool",props:["prices","timeToIndex"],emits:["scaned","removePattern","hideContext"],setup(E,{expose:I,emit:T}){const f=fe("mf"),t=E,s=T,y=N(null),C=N(!1),R=N("left");I({isSelected:u,hide:h,draw:F});function u(){return y.value.classList.contains("selected")}function h(S){C.value=S}function p(S){s("hideContext");const r=S.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(m=>m.classList.remove("selected")),r||(S.target.classList.add("selected"),s("removePattern"))}function V(){const S=C.value;s("hideContext"),C.value=!S}function F({time:S}){const r=R.value==="left",m=S?t.prices.filter(c=>!f.cmp(c.time,r,S)):t.prices;let i=r?Z(m):W(m);f.isSet(i)&&s("scaned",A(i)),y.value.classList.remove("selected")}function Z(S){let r,[m,i,c,g]=Array(4).fill({});for(let v=S.length-1;v>=0;v--){const k=S[v].value,x=S[v].time,e=t.timeToIndex(x);if(e===-1)break;if(v===S.length-1&&(c={index:e,time:x,price:k},[i,m,g]=Array(3).fill(null).map(()=>f.cloneDeep(c))),r===void 0){if(k===c.price)continue;r=k>c.price}if(f.cmp(k,r,i.price)&&(f.cmp(m.price,!r,c.price)?([c,i]=[i,m].map(d=>f.cloneDeep(d)),m={index:e,time:x,price:k},g=f.cloneDeep(m),r=!r):i={index:e,time:x,price:k}),f.cmp(k,!r,m.price)?(m={index:e,time:x,price:k},g=f.cloneDeep(m)):g.index=e,f.cmp(k,r,g.price)&&(g={index:e,time:x,price:k}),c.index>m.index){const d=f.fmtNum(i.price-c.price,1,!0);if(d>=1&&(m.index-g.index>c.index-i.index||f.fmtNum(m.price-g.price,1,!0)>d))break}}return{A:m,B:i,C:c}}function W(S){let r,[m,i,c]=Array(3).fill({});for(let g=0;g<S.length;g++){const v=S[g].value,k=S[g].time,x=t.timeToIndex(k);if(x===-1)break;if(g===0&&(m={index:x,time:k,price:v},i=f.cloneDeep(m),c=f.cloneDeep(m)),r===void 0){if(v===m.price)continue;r=v>m.price}f.cmp(v,r,i.price)&&(i={index:x,time:k,price:v},c=f.cloneDeep(i)),f.cmp(i.price,r,m.price)&&f.cmp(v,!r,c.price)&&(f.cmp(v,r,m.price)?c={index:x,time:k,price:v}:(m=f.cloneDeep(i),i={index:x,time:k,price:v},c=f.cloneDeep(i),r=!r))}return{A:m,B:i,C:c}}function A(S){const r={};return Object.entries(S).forEach(([m,i])=>{const{index:c,...g}=i;r[m]=g}),r}return(S,r)=>(H(),J("div",{ref_key:"scanToolRef",ref:y,class:"context command",title:S.$t("trading.derivative.scanTool"),onClick:p,onContextmenu:V},[B("i",{class:ae(["far",{[`fa-angles-${R.value}`]:!0}])},null,2),Te(ee(Ht,{class:"contextmenu",modelValue:R.value,"onUpdate:modelValue":r[0]||(r[0]=m=>R.value=m)},null,8,["modelValue"]),[[be,C.value]])],40,Jt))}},jt=["title"],qt=B("i",{class:"far fa-heart-rate"},null,-1),Ut=[qt],Qt={__name:"PatternTool",props:["prices","priceSeries","timeMarkSeries","pickTimeToolRef","timeToIndex","indexToTime"],emits:["setProgress","hideContext"],setup(E,{expose:I,emit:T}){const f=me(),t=fe("mf"),s=E,y=T,C=N(null),R=ce(()=>f.state.tradingDerivative.tools.pattern);let u={},h={};I({isSelected:p,draw:Z,load:W,refresh:S,remove:k,drag:d}),ve(R,a=>{a&&W(a,{isCheck:!0})});function p(){return C.value.classList.contains("selected")}function V(a){y("hideContext");const n=a.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(_=>_.classList.remove("selected")),n||(a.target.classList.add("selected"),s.pickTimeToolRef.remove())}function F(a){a.target.classList.remove("selected"),k()}function Z({time:a,price:n}){let l={lineType:"pattern",price:n,lineWidth:1,lineStyle:1,draggable:!0};if(t.isSet(h.A))if(t.isSet(h.B)){let $,w;if(t.isSet(h.C)){let L,b;u.A={time:a,price:n};const{progress:P,timeMark:M,info:{rEpr1:X,rEpr2:U,rEpr3:re,entry:te,pStatus:ie,x:ne,X:j,y:Q,Y}}=r();w=P,$=M,L="A",b={price:n,title:`A ${X}`},h[L].applyOptions(b),L="B",b={title:`B ${U}`},h[L].applyOptions(b),L="C",b={title:`C ${re}`},h[L].applyOptions(b),L="D",b={price:te,title:"Entry "+ie},h[L].applyOptions(b),L="X",b={price:t.fmtNum(ne),title:`X ${t.fmtNum(j)}`},h[L].applyOptions(b),L="Y",b={price:t.fmtNum(Q),title:`Y ${t.fmtNum(Y)}`},h[L].applyOptions(b)}else{u.C={price:n};const{progress:L,timeMark:b,info:{rEpr1:P,rEpr2:M,rEpr3:X,entry:U,pStatus:re,x:te,X:ie,y:ne,Y:j}}=r();w=L,$=b;let Q="A";h[Q].applyOptions({title:`A ${P}`}),Q="B",h[Q].applyOptions({title:`B ${M}`}),l.point="C",l.title=`C ${X}`,l.color="#FFEB3B",h[l.point]=s.priceSeries.createPriceLine(l),l.point="D",l.price=U,l.title="Entry "+re,l.color="#9C27B0",l.draggable=!1,h[l.point]=s.priceSeries.createPriceLine(l),l.point="Y",l.price=t.fmtNum(ne),l.title=`Y ${t.fmtNum(j)}`,l.color="#E91E63",l.draggable=!1,h[l.point]=s.priceSeries.createPriceLine(l),l.point="X",l.price=t.fmtNum(te),l.title=`X ${t.fmtNum(ie)}`,l.color="#2196F3",l.draggable=!1,h[l.point]=s.priceSeries.createPriceLine(l)}v(),y("setProgress",w),e($),C.value.classList.remove("selected")}else l.point="B",l.title="B 0",l.color="#4CAF50",h[l.point]=s.priceSeries.createPriceLine(l),u.B={price:n};else l.point="A",l.title="A 0",l.color="#F44336",h[l.point]=s.priceSeries.createPriceLine(l),u={A:{time:a,price:n}}}function W(a,{isSave:n=!1,isCheck:_=!1}){u=t.cloneDeep(a),n&&v(),(_?i(u):!0)&&(x(),A())}function A(){let n={lineType:"pattern",lineWidth:1,lineStyle:1,draggable:!0};const{A:_,B:l,C:$}=u,{progress:w,timeMark:L,info:{rEpr1:b,rEpr2:P,rEpr3:M,entry:X,pStatus:U,x:re,X:te,y:ie,Y:ne}}=r();y("setProgress",w),e(L),n.point="A",n.title=`A ${b}`,n.color="#F44336",n.price=_.price,h[n.point]=s.priceSeries.createPriceLine(n),n.point="B",n.title=`B ${P}`,n.color="#4CAF50",n.price=l.price,h[n.point]=s.priceSeries.createPriceLine(n),n.point="C",n.price=$.price,n.title=`C ${M}`,n.color="#FFEB3B",h[n.point]=s.priceSeries.createPriceLine(n),n.point="D",n.price=X,n.title="Entry "+U,n.color="#9C27B0",n.draggable=!1,h[n.point]=s.priceSeries.createPriceLine(n),n.point="Y",n.price=t.fmtNum(ie),n.title=`Y ${t.fmtNum(ne)}`,n.color="#E91E63",n.draggable=!1,h[n.point]=s.priceSeries.createPriceLine(n),n.point="X",n.price=t.fmtNum(re),n.title=`X ${t.fmtNum(te)}`,n.color="#2196F3",n.draggable=!1,h[n.point]=s.priceSeries.createPriceLine(n)}function S(a=!1){t.isSet(h.C)&&(a&&g(),x(),A())}function r(){const{A:a,B:n,C:_}=u,l=n.price-_.price,$=l>0,w=m({phase:1,start:a,end:n,retracementPrice:_.price});let L=m({phase:2,start:w.R,end:_});const b=m({phase:3,start:L.R,end:{price:n.price+($?1:-1)*w.rEp},breakPrices:[L.S1.price,n.price]});w.xBox.tr>=L.tr&&(L.tr=w.xBox.tr),console.log("calculatePattern",[w,L,b]);const P=t.fmtNum(l,1,!0)>=w.pr,M=t.fmtNum(_.price-b.xBox.R.price,1,!0)>=L.pr,X=t.fmtNum(b.xBox.pr)>=b.pr,U=!t.cmp(_.price,!$,w.S1.price),re=!t.cmp(b.xBox.R.price,$,L.S1.price),te=!t.cmp(b.xBox.S.price,!$,b.S1.price),ie=w.R.index+w.tr,ne=w.R.index+5*w.tr,j=L.R.index+L.tr,Q=b.xBox.R.index+b.tr,Y=b.xBox.R.index+5*b.tr,oe=b.xBox.R.index+L.tr,Pe=[ie,ne,j,Q,Y,oe],le=b.xBox.S.index;let he,q={};const Ce=[L.R.index>ie,w.rEpr<3,L.rEpr<w.rEpr];q.steps=[[P||w.rEt<w.tr&&w.rEp>=w.sEp,U,!b.breakIndexs[1]||ie<b.breakIndexs[1],le>ie,le<ne],[...Ce,j>ie,le<Y,le<j],[L.R.index-w.R.index>.5*w.tr,M,!b.breakIndexs[1]||j<b.breakIndexs[1],le>j],[X,te,le>Q,Ce.every(Boolean)||le>oe]],q.step=1,q.result=q.steps[0].every(Boolean),he=w.R1.price,q.result&&(le<=j?(q.step=2,q.result=q.steps[1].every(Boolean),he=L.S1.price):(q.step=3,q.result=q.steps[2].every(Boolean),he=b.R1.price,q.result&&(q.step=4,q.result=q.steps[3].every(Boolean),q.result&&(he=b.xBox.R.price))));const $e=`${U?P?1:0:2}${re?M?1:0:2}${te?X?1:0:2}`,ge=w.rEp,Ie=c(n.price,ge,$),Ae=b.breakIndexs[1]??le,we=parseInt((Ae-w.R.index)/w.tr),De=we>1?ge*we:ge,Ne=c(n.price,De,$);return{progress:q,timeMark:Pe,info:{rEpr1:w.rEpr,rEpr2:L.rEpr,rEpr3:b.rEpr,entry:he,pStatus:$e,x:Ie,X:ge,y:Ne,Y:De}}}function m({phase:a,start:n,end:_,breakPrices:l,retracementPrice:$}){let w=t.cloneDeep(n),L=t.cloneDeep(_);const b=L.price>w.price;let P={},M={},X={},U=[null,null],re,te,ie;const ne=s.pickTimeToolRef.get();return s.prices.filter(j=>{let Q=j.time>=w.time;return ne&&(Q&=j.time<=ne),Q}).every((j,Q)=>{const Y=j.value,oe=s.timeToIndex(j.time);return oe===-1?!1:((Q===0||Y===w.price)&&(P={R:{index:oe,price:Y},S:{index:oe,price:Y},pr:0,tr:0},M=t.cloneDeep(P),X=t.cloneDeep(P)),t.cmp(Y,b,P.R.price)?(P.pr>0&&(P.pr>=M.pr&&(M.pr=P.pr,M.R=t.cloneDeep(P.R),M.S=t.cloneDeep(P.S)),P.tr>M.tr&&(M.tr=P.tr),a===1&&$&&!t.cmp(P.S.price,!b,$)&&P.tr>=X.tr&&P.pr>=X.pr&&(X=t.cloneDeep(P))),P={R:{index:oe,price:Y},S:{index:oe,price:Y},pr:0,tr:0},a===3&&l&&(!U[0]&&t.cmp(Y,b,l[0])&&(U[0]=oe),!U[1]&&t.cmp(Y,b,l[1])&&(U[1]=oe))):(P.S.index=oe,P.tr=P.S.index-P.R.index,t.cmp(Y,!b,P.S.price)&&(P.S.price=Y,P.pr=t.fmtNum(P.S.price-P.R.price,1,!0))),t.cmp(Y,!b,w.price)?(P.S.price=w.price,!1):!!t.cmp(Y,!b,L.price))}),t.isSet(P)&&(w.index=s.timeToIndex(w.time),L.index=P.S.index,L.time=s.indexToTime(P.S.index),re=t.fmtNum(L.price-M.R.price,1,!0),te=t.fmtNum(w.price-M.S.price,1,!0),ie=L.index-M.S.index,a===3&&(X=P)),{tr:M.tr,pr:M.pr,rEp:re,sEp:te,rEpr:M.pr?t.fmtNum(re/M.pr):0,rEt:ie,S1:M.S,R1:M.R,xBox:X,S:w,R:L,breakIndexs:U}}function i({A:{time:a}}){return a>=s.prices[0].time&&a<s.prices.at(-1).time}function c(a,n,_){const l=a+(_?1:-1)*n;let $=t.fmtNum(l%1);if(_){if($>=.1&&$<=.2)return Math.floor(l);if($>=.6&&$<=.7)return Math.floor(l)+.5}else{if($>=.8&&$<=.9)return Math.ceil(l);if($>=.3&&$<=.4)return Math.floor(l)+.5}return l}function g(){if(s.pickTimeToolRef.get())return!1;const n=u.B.price-u.A.price>0,_=s.prices.at(-1).value;if(t.cmp(_,!n,u.C.price)){let l=_;for(let $=s.prices.length-1;$>=0;$--){const w=s.prices[$].value;if(w===u.B.price)break;l=n?Math.min(l,w):Math.max(l,w)}u.C.price=l,v()}}function v(a=!1){let n={isRemove:a,name:"pattern",points:[],data:[]};a?u={}:Object.entries(u).forEach(([_,l])=>{n.points.push(_),n.data.push(l)}),f.dispatch("tradingDerivative/drawTools",n)}function k(){v(!0),s.pickTimeToolRef.remove(),x(),y("setProgress",{})}function x(){t.isSet(h.A)&&(s.priceSeries.removePriceLine(h.A),t.isSet(h.B)&&(s.priceSeries.removePriceLine(h.B),t.isSet(h.C)&&(s.priceSeries.removePriceLine(h.C),s.priceSeries.removePriceLine(h.D),s.priceSeries.removePriceLine(h.X),s.priceSeries.removePriceLine(h.Y)))),h={},e([])}function e(a){const n=["#F44336","#F44336","#4CAF50","#FFEB3B","#FFEB3B","#2196F3"];let _=[];for(let l=0;l<a.length;l++){let $=s.indexToTime(a[l]);$&&(a.indexOf(a[l])!==a.lastIndexOf(a[l])&&($+=l),_.push({time:$,value:1,color:n[l]}))}_.length&&_.sort((l,$)=>l.time-$.time),s.timeMarkSeries.setData(_)}function d({lineOptions:a}){if(t.isSet(h.C)){let n,_;u={A:{time:u.A.time,price:+h.A.options().price},B:{price:+h.B.options().price},C:{price:+h.C.options().price}},v();const{progress:l,timeMark:$,info:{rEpr1:w,rEpr2:L,rEpr3:b,entry:P,pStatus:M,x:X,X:U,y:re,Y:te}}=r();y("setProgress",l),e($),n="A",_={title:`A ${w}`},h[n].applyOptions(_),n="B",_={title:`B ${L}`},h[n].applyOptions(_),n="C",_={title:`C ${b}`},h[n].applyOptions(_),n="D",_={price:P,title:"Entry "+M},a.point===n&&delete _.price,h[n].applyOptions(_),n="X",_={price:t.fmtNum(X),title:`X ${t.fmtNum(U)}`},h[n].applyOptions(_),n="Y",_={price:t.fmtNum(re),title:`Y ${t.fmtNum(te)}`},h[n].applyOptions(_)}}return(a,n)=>(H(),J("div",{ref_key:"patternToolRef",ref:C,class:"command",title:a.$t("trading.derivative.patternTool"),onClick:V,onContextmenu:F},Ut,40,jt))}},Gt=["title"],Kt=B("i",{class:"far fa-pipe"},null,-1),ei=[Kt],ti={__name:"PickTimeTool",props:["pickTimeSeries"],emits:["refreshPattern","hideContext"],setup(E,{expose:I,emit:T}){const f=me(),t=E,s=T,y=N(null),C=ce(()=>f.state.tradingDerivative.tools.pickTime);let R=null;I({isSelected:u,draw:F,remove:W,get:h}),ve(C,A=>{A&&Z(A[0])});function u(){return y.value.classList.contains("selected")}function h(){return R}function p(A){s("hideContext");const S=A.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(r=>r.classList.remove("selected")),S||A.target.classList.add("selected")}function V(A){A.target.classList.remove("selected"),W(),s("refreshPattern")}function F({time:A}){f.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"pickTime",points:[0],data:[A]}),Z(A),s("refreshPattern"),y.value.classList.remove("selected")}function Z(A){R=A,t.pickTimeSeries.setData([{time:A,value:1,color:"#9C27B0"}])}function W(A=!0){A&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"pickTime"}),t.pickTimeSeries.setData([]),R=null}return(A,S)=>(H(),J("div",{ref_key:"pickTimeToolRef",ref:y,class:"command",title:A.$t("trading.derivative.pickTimeTool"),onClick:p,onContextmenu:V},ei,40,Gt))}};const ii=B("div",{class:"triangle-shadow"},null,-1),ni=B("div",{class:"triangle"},null,-1),ri={class:"input"},si={class:"color"},oi=["onClick"],ai={__name:"LineContext",props:["enable","title","color"],emits:["update:title","update:color"],setup(E,{emit:I}){const T=E,f=I,t=N(null),s=N(["#F44336","#FF9800","#FFEB3B","#4CAF50","#009688","#00BCD4","#2196F3","#673AB7","#9C27B0","#E91E63"]);ve(()=>T.enable,h=>{h&&gt().then(()=>t.value.instance.focus())});function y({value:h}){f("update:title",h)}function C(h){f("update:color",h)}function R(){f("deleteAllLine")}function u(h){h.stopPropagation()}return(h,p)=>{const V=tt("DxButton");return H(),J("div",{class:"line-context",onClick:u},[ii,ni,B("div",ri,[ee(nt(kt),{ref_key:"titleRef",ref:t,value:T.title,"show-clear-button":!0,"input-attr":{style:`color:${T.color}`},onValueChanged:y},null,8,["value","input-attr"]),ee(V,{icon:"trash",type:"danger",onClick:p[0]||(p[0]=F=>R())})]),B("div",si,[(H(!0),J(We,null,Ze(s.value,(F,Z)=>(H(),J("div",{class:"color-swatch",style:St({background:F,boxShadow:`0 0 4px ${F}`}),key:Z,onClick:W=>C(F)},null,12,oi))),128))])])}}},ci=["title"],li=B("i",{class:"far fa-horizontal-rule"},null,-1),pi={__name:"LineTool",props:["priceSeries"],emits:["hideContext"],setup(E,{expose:I,emit:T}){const f=me(),t=E,s=T,y=N(null),C=N(!1),R=ce(()=>f.state.tradingDerivative.tools.line),u=N(""),h=N("#F44336");let p=[];I({isSelected:V,hide:F,draw:A,drag:i}),ve(R,c=>{c&&S(c)});function V(){return y.value.classList.contains("selected")}function F(c){C.value=c}function Z(c){s("hideContext");const g=c.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(v=>v.classList.remove("selected")),g||c.target.classList.add("selected")}function W(c){const g=C.value;s("hideContext"),C.value=!g}function A({price:c}){const g="line",v=p.length;if(p=p.filter(k=>{const x=k.options(),e=x.type=c===+x.price;return e&&(t.priceSeries.removePriceLine(k),f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:g,point:c})),!e}),p.length===v){const k=h.value,x=u.value,e={lineType:g,price:c,color:k,title:x,lineWidth:1,lineStyle:1,draggable:!0};p.push(t.priceSeries.createPriceLine(e)),f.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:g,points:[c],data:[{color:k,title:x}]})}y.value.classList.remove("selected")}function S(c){m(!1),r(c)}function r(c){const v={lineType:"line",lineWidth:1,lineStyle:1,draggable:!0};Object.entries(c).forEach(([k,{color:x,title:e}])=>{v.price=+k,v.color=x,v.title=e,p.push(t.priceSeries.createPriceLine(v))})}function m(c=!0){p.length>0&&(c&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line"}),p.forEach(g=>t.priceSeries.removePriceLine(g)),p=[])}function i({lineOptions:c,oldPrice:g,newPrice:v}){f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line",point:g});const k=c.color,x=c.title;f.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"line",points:[v],data:[{color:k,title:x}]}),y.value.classList.remove("selected")}return(c,g)=>(H(),J("div",{ref_key:"lineToolRef",ref:y,class:"context command",title:c.$t("trading.derivative.lineTool"),onClick:Z,onContextmenu:W},[li,Te(ee(ai,{class:"contextmenu",enable:C.value,title:u.value,"onUpdate:title":g[0]||(g[0]=v=>u.value=v),color:h.value,"onUpdate:color":g[1]||(g[1]=v=>h.value=v),onDeleteAllLine:m},null,8,["enable","title","color"]),[[be,C.value]])],40,ci))}},di=["title"],ui=B("i",{class:"far fa-grip-lines-vertical"},null,-1),fi=[ui],mi={__name:"TimeRangeTool",props:["timeRangeSeries","timeToIndex","indexToTime"],emits:["hideContext"],setup(E,{expose:I,emit:T}){const f=me(),t=fe("mf"),s=E,y=T,C=N(null),R=ce(()=>f.state.tradingDerivative.tools.timeRange);let u=[];I({isSelected:h,draw:F}),ve(R,S=>{S&&Z(S)});function h(){return C.value.classList.contains("selected")}function p(S){y("hideContext");const r=S.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(m=>m.classList.remove("selected")),r||S.target.classList.add("selected")}function V(S){A(),S.target.classList.remove("selected")}function F({time:S}){let r={isRemove:!1,name:"timeRange",points:[],data:[]},m={time:S,value:1};switch(u.length){case 0:m.color="OrangeRed",u[0]=m,r.points.push(0),r.data.push(S);break;case 1:m.color="lime",u[1]=m,r.points.push(1),r.data.push(S),C.value.classList.remove("selected");break;default:const i=s.timeToIndex(u[0].time),c=s.timeToIndex(u[1].time),v=s.timeToIndex(S)+(c-i),k=s.indexToTime(v);m.color="OrangeRed",u[0]=t.cloneDeep(m),r.points.push(0),r.data.push(S),m.time=k,m.color="lime",u[1]=m,r.points.push(1),r.data.push(k),C.value.classList.remove("selected");break}s.timeRangeSeries.setData(u),f.dispatch("tradingDerivative/drawTools",r)}function Z(S){A(!1),W(S)}function W(S){let r,m;if(S.length===2)r=S[0],m=S[1];else if(S.length===3){const c=s.timeToIndex(S[0]),g=s.timeToIndex(S[1]),k=s.timeToIndex(S[2])+(g-c);r=S[2],m=s.indexToTime(k)}else return!1;let i=[{time:r,value:1,color:"OrangeRed"},{time:m,value:1,color:"lime"}];u=i,s.timeRangeSeries.setData(i)}function A(S=!0){S&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"timeRange"}),s.timeRangeSeries.setData([]),u=[]}return(S,r)=>(H(),J("div",{ref_key:"timeRangeToolRef",ref:C,class:"command",title:S.$t("trading.derivative.timeRangeTool"),onClick:p,onContextmenu:V},fi,40,di))}},vi=["title"],hi=B("i",{class:"far fa-line-height"},null,-1),gi=[hi],Si={__name:"TargetTool",props:["priceSeries"],emits:["hideContext"],setup(E,{expose:I,emit:T}){const f=me(),t=fe("mf"),s=E,y=T,C=N(null),R=ce(()=>f.state.tradingDerivative.tools.target);let u={};I({isSelected:h,draw:F,drag:S}),ve(R,r=>{r&&Z(r)});function h(){return C.value.classList.contains("selected")}function p(r){y("hideContext");const m=r.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),m||(r.target.classList.add("selected"),A())}function V(r){A(),r.target.classList.remove("selected")}function F({price:r}){const m="target";let i={lineType:m,price:r,lineWidth:1,lineStyle:1,draggable:!0},c={isRemove:!1,name:m,points:[],data:[r]};if(t.isSet(u.A)){const g=+u.A.options().price,v=r-g;i.point="B",i.title=t.fmtNum(v),i.color="#F44336",u[i.point]=s.priceSeries.createPriceLine(i),c.points.push(i.point),i.point="X",i.price=t.fmtNum(g-.5*v),i.title=t.fmtNum(-.5*v),i.color="#2196F3",u[i.point]=s.priceSeries.createPriceLine(i),i.point="Y",i.price=t.fmtNum(g-v),i.title=t.fmtNum(-v),i.color="#673AB7",u[i.point]=s.priceSeries.createPriceLine(i),i.point="Z",i.price=t.fmtNum(g-2*v),i.title=t.fmtNum(-2*v),i.color="#9C27B0",u[i.point]=s.priceSeries.createPriceLine(i),i.point="W",i.price=t.fmtNum(g-4*v),i.title=t.fmtNum(-4*v),i.color="#E91E63",u[i.point]=s.priceSeries.createPriceLine(i),C.value.classList.remove("selected")}else i.point="A",i.title="0",i.color="#FF9800",u[i.point]=s.priceSeries.createPriceLine(i),c.points.push(i.point);f.dispatch("tradingDerivative/drawTools",c)}function Z(r){A(!1),W(r)}function W(r){let i={lineType:"target",lineWidth:1,lineStyle:1,draggable:!0};const c=r.A,g=r.B,v=g-c;i.point="A",i.price=c,i.title="0",i.color="#FF9800",u[i.point]=s.priceSeries.createPriceLine(i),i.point="B",i.price=g,i.title=t.fmtNum(v),i.color="#F44336",u[i.point]=s.priceSeries.createPriceLine(i),i.point="X",i.price=t.fmtNum(c-.5*v),i.title=t.fmtNum(-.5*v),i.color="#2196F3",u[i.point]=s.priceSeries.createPriceLine(i),i.point="Y",i.price=t.fmtNum(c-v),i.title=t.fmtNum(-v),i.color="#673AB7",u[i.point]=s.priceSeries.createPriceLine(i),i.point="Z",i.price=t.fmtNum(c-2*v),i.title=t.fmtNum(-2*v),i.color="#9C27B0",u[i.point]=s.priceSeries.createPriceLine(i),i.point="W",i.price=t.fmtNum(c-4*v),i.title=t.fmtNum(-4*v),i.color="#E91E63",u[i.point]=s.priceSeries.createPriceLine(i)}function A(r=!0){r&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"target"}),t.isSet(u.A)&&(s.priceSeries.removePriceLine(u.A),t.isSet(u.B)&&(s.priceSeries.removePriceLine(u.B),s.priceSeries.removePriceLine(u.X),s.priceSeries.removePriceLine(u.Y),s.priceSeries.removePriceLine(u.Z),s.priceSeries.removePriceLine(u.W))),u={}}function S({lineOptions:r,newPrice:m}){if(t.isSet(u.B)){let i={isRemove:!1,name:"target",points:[],data:[]},c,g,v=+u.A.options().price,k=+u.B.options().price,x=k-v;if(c="A",r.point==="A")x=+u.B.options().title,k=v+x;else if(r.point!=="B"){let e=0;switch(r.point){case"X":e=1.5;break;case"Y":e=2;break;case"Z":e=3;break;case"W":e=5;break}x=t.fmtNum((k-m)/e),v=k-x,g={price:v},u[c].applyOptions(g)}i.points.push(c),i.data.push(v),c="B",g={price:k,title:t.fmtNum(x)},r.point===c&&delete g.price,u[c].applyOptions(g),i.points.push(c),i.data.push(k),c="X",g={price:t.fmtNum(v-.5*x),title:t.fmtNum(-.5*x)},r.point===c&&delete g.price,u[c].applyOptions(g),c="Y",g={price:t.fmtNum(v-x),title:t.fmtNum(-x)},r.point===c&&delete g.price,u[c].applyOptions(g),c="Z",g={price:t.fmtNum(v-2*x),title:t.fmtNum(-2*x)},r.point===c&&delete g.price,u[c].applyOptions(g),c="W",g={price:t.fmtNum(v-4*x),title:t.fmtNum(-4*x)},r.point===c&&delete g.price,u[c].applyOptions(g),f.dispatch("tradingDerivative/drawTools",i)}}return(r,m)=>(H(),J("div",{ref_key:"targetToolRef",ref:C,class:"command",title:r.$t("trading.derivative.targetTool"),onClick:p,onContextmenu:V},gi,40,vi))}},yi=["title"],Ge=3,Ke=2,Ti={__name:"OrderTool",props:["position","prices","priceSeries","inSession","TIME"],emits:["getTools","showEntry","showTpSl","orderChanged","hideContext"],setup(E,{expose:I,emit:T}){const f=me(),{t}=Oe(),s=fe("mf"),y=E,C=T,R=N(null),u=N(!1),h=ce(()=>f.state.tradingDerivative.tools.order);let p={side:0,entry:{},tp:{},sl:{}},V=!1;I({show:Z,entry:W,tpsl:A,cancel:S,cancelWithoutClose:r,scan:m,drag:k}),ve(h,e=>{e&&c(e)});function F(){return s.isSet(p.entry.line)||s.isSet(p.tp.line)}function Z({price:e}){if(e&&y.inSession()){const d=G(_e(new Date,7));if(s.isSet(p.entry.line))!s.isSet(p.tp.line)&&y.position&&d>y.TIME.ATO&&d<y.TIME.ATC&&C("showTpSl",{side:y.position});else{let a=null,n=0;y.position?(d<y.TIME.ATO?a="ATO":d>y.TIME.ATC&&(a="ATC"),a&&(p.entry.price=a,n=-y.position)):d>y.TIME.ATO&&d<y.TIME.ATC&&(a=e,n=a>=y.prices.at(-1).value?1:-1,p.side=n,p.entry.price=a),n&&C("showEntry",{side:n,price:a})}}}function W(){if(y.inSession()){const e=G(_e(new Date,7));e<y.TIME.ATO?Qe(t("trading.derivative.atoOrder"),t("titles.confirm")).then(a=>{a&&f.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(n=>{n.isOk?se.success(t("trading.derivative.atoOrderSuccess")):x(n.message)})}):e>y.TIME.ATC?Qe(t("trading.derivative.atcOrder"),t("titles.confirm")).then(a=>{a&&f.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(n=>{n.isOk?se.success(t("trading.derivative.atcOrderSuccess")):x(n.message)})}):f.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"new",side:p.side,price:p.entry.price}}).then(d=>{d.isOk?(i(["entry"]),se.success(t("trading.derivative.newEntrySuccess"))):x(d.message)})}}function A(){p.tp.price=p.entry.price+p.side*Ge,p.sl.price=p.entry.price-p.side*Ke,f.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:p.tp.price},slData:{cmd:"new",price:p.sl.price}}).then(e=>{e.isOk?(p.entry.line.applyOptions({draggable:!1}),i(["entry","tp","sl"]),se.success(t("trading.derivative.newTpSlSuccess"))):x(e.message)})}function S(){s.isSet(p.entry.line)?s.isSet(p.tp.line)?f.dispatch("tradingDerivative/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(e=>{e.isOk?(v(["entry","tp","sl"]),se.success(t("trading.derivative.exitSuccess"))):x(e.message)}):f.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"delete"}}).then(e=>{e.isOk?(v(["entry"]),se.success(t("trading.derivative.deleteEntrySuccess"))):x(e.message)}):C("getTools")}function r(){if(y.inSession()&&y.position){const e=G(_e(new Date,7));e>y.TIME.ATC-5*60&&(u.value=!0,e>y.TIME.ATC-15&&s.isSet(p.tp.line)&&f.dispatch("tradingDerivative/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(d=>{d.isOk?(v(["entry","tp","sl"]),se.success(t("trading.derivative.autoCancelTpSlSuccess"))):x(d.message)}))}}function m(e){if(s.isSet(p.entry.line)){const d=p.side>0;s.isSet(p.tp.line)?(s.cmp(e,d,p.tp.price,!0)&&(V||(V=!0,f.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"delete"}}).then(a=>{a.isOk?(v(["entry","tp","sl"]),se.success(t("trading.derivative.deleteTpSuccess"))):x(a.message),V=!1}))),s.cmp(e,!d,p.sl.price,!0)&&(V||(V=!0,f.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"cancel"}}).then(a=>{a.isOk?(v(["entry","tp","sl"]),se.success(t("trading.derivative.deleteSlSuccess"))):x(a.message),V=!1})))):s.cmp(e,d,p.entry.price,!0)&&(V||(V=!0,setTimeout(()=>{p.tp.price=p.entry.price+p.side*Ge,p.sl.price=p.entry.price-p.side*Ke,f.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:p.tp.price},slData:{cmd:"new",price:p.sl.price}}).then(a=>{a.isOk?(p.entry.line.applyOptions({draggable:!1}),i(["entry","tp","sl"]),se.success(t("trading.derivative.autoNewTpSlSuccess"))):x(a.message),V=!1})},1e3)))}}function i(e){const d="order";let a={isRemove:!1,name:d,points:[],data:[]},n,_;e.forEach(l=>{const $=p.entry.price,w=p.tp.price,L=p.sl.price;switch(l){case"entry":n="yellow",_=p.side>0?"LONG":"SHORT";break;case"tp":n="lime",_=s.fmtNum(w-$,1,!0);break;case"sl":n="red",_=s.fmtNum(L-$,1,!0);break}if(a.points.push(l),s.isSet(p[l].line))p[l].line.applyOptions({price:p[l].price,title:_}),a.data.push(p[l].line.options());else{const b={lineType:d,kind:l,side:p.side,price:p[l].price,color:n,lineWidth:1,lineStyle:0,title:_,draggable:!0};p[l].line=y.priceSeries.createPriceLine(b),a.data.push(b)}}),f.dispatch("tradingDerivative/drawTools",a),C("orderChanged",F())}function c(e){v(["entry","tp","sl"],!1),g(e),C("orderChanged",F())}function g(e){Object.entries(e).forEach(([d,a])=>{d==="entry"&&(p.side=a.side),p[d].price=a.price,p[d].line=y.priceSeries.createPriceLine(a)})}function v(e,d=!0){d&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"order"}),e.forEach(a=>{s.isSet(p[a].line)&&(y.priceSeries.removePriceLine(p[a].line),delete p[a].line)}),C("orderChanged",F())}function k({line:e,lineOptions:d,oldPrice:a,newPrice:n}){if(n!==a){let _=!1;d.kind==="entry"?y.position||(_=!0,p[d.kind].price=n,f.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"change",price:p.entry.price}}).then(l=>{l.isOk?(i([d.kind]),se.success(t("trading.derivative.changeEntrySuccess"))):(e.applyOptions({price:a}),x(l.message))})):(_=!0,p[d.kind].price=n,d.kind==="tp"?f.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"change",price:p.tp.price}}).then(l=>{l.isOk?(i([d.kind]),se.success(t("trading.derivative.changeTpSuccess"))):(e.applyOptions({price:a}),x(l.message))}):f.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"change",price:p.sl.price}}).then(l=>{l.isOk?(i([d.kind]),se.success(t("trading.derivative.changeSlSuccess"))):(e.applyOptions({price:a}),x(l.message))})),_||(e.applyOptions({price:a}),se.show(t("trading.derivative.noChangeOrderLine")))}}function x(e){e||(e="unknown"),se.error(t(`trading.derivative.${e}`))}return(e,d)=>(H(),J("div",{ref_key:"orderToolRef",ref:R,class:"cancel-order command",title:e.$t("trading.derivative.orderTool"),onClick:S},[B("i",{class:ae(["far fa-trash-alt",{blink:u.value}])},null,2)],8,yi))}};const xi=["title"],Ci=["title"],ki=["title"],_i=["title"],bi="wss://tradestation.fireant.vn/quote?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",wi="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",Oi={__name:"Chart",setup(E,{expose:I}){const T=me(),f=xt(),{t}=Oe(),s=fe("devices"),y=fe("mf"),C=fe("filters"),R=N(null),u=N(null),h=N(null),p=N(null),V=N(null),F=N(null),Z=N(null),W=N(null),A=N(null),S=N(null),r=N(null),m=N(null),i=N(null),c=N(null),g=N(null),v={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.25,bottom:.25}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:1e3,minBarSpacing:.01,barSpacing:.05}},k=Le(new Date,"yyyy-MM-dd"),x={START:G(new Date(`${k}T08:45:00Z`)),ATO:G(new Date(`${k}T09:00:00Z`)),ATC:G(new Date(`${k}T14:30:00Z`)),END:G(new Date(`${k}T14:45:00Z`))};let e={chart:{},whitespaces:[],crosshair:{},interval:null,interval10At:Ve(new Date,11),interval30At:Ve(new Date,31),websocket:null,socketStop:!1,vpsUpdatedAt:Ve(new Date,61)};const d=yt({prices:[],series:{},chartDate:f.query.date??k,clock:Le(new Date,"HH:mm:ss"),isSocketWarning:!1,hasOrderLine:!1,TIME:x}),a=ce(()=>T.state.tradingDerivative.status),n=ce(()=>T.state.tradingDerivative.config),_=ce(()=>T.state.tradingDerivative.isLoading),l=ce(()=>a.value.position||a.value.pending||d.hasOrderLine);e.interval=setInterval(()=>{i.value&&i.value.cancelWithoutClose(),d.clock=Le(new Date,"HH:mm:ss"),Me(new Date,new Date(e.interval10At))>10&&(ke()&&n.value.autoRefresh&&W.value.refresh(!0),e.interval10At=new Date),Me(new Date,new Date(e.interval30At))>30&&(ke()&&Xe(),e.interval30At=new Date)},1e3),ct(),Ye(()=>{$(),new ResizeObserver(re).observe(R.value),document.addEventListener("keydown",te)}),et(()=>{w(),document.removeEventListener("keydown",te),clearInterval(e.interval),oe(),e.socketStop=!0}),ve(()=>T.state.tradingDerivative.chartData,ie),I({connectSocket:Y});function $(){e.chart=_t(u.value,v),e.chart.subscribeCrosshairMove(X),e.chart.subscribeCustomPriceLineDragged(U),d.series.whitespace=e.chart.addHistogramSeries({priceScaleId:"whitespace",scaleMargins:{top:0,bottom:0},color:"#808080",lastValueVisible:!1,priceLineVisible:!1}),d.series.timeRange=e.chart.addHistogramSeries({priceScaleId:"timeRange",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),d.series.pickTime=e.chart.addHistogramSeries({priceScaleId:"pickTime",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),d.series.timeMark=e.chart.addHistogramSeries({priceScaleId:"timeMark",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),d.series.price=e.chart.addLineSeries({color:"#F5F5F5",priceFormat:{minMove:.1}})}function w(){e.chart&&(e.chart.remove(),e.chart=null)}function L(o){ue(),ge(!1),Z.value.isSelected()?Z.value.draw({time:e.crosshair.time}):W.value.isSelected()?W.value.draw({time:e.crosshair.time,price:Ee(e.crosshair.y)}):A.value.isSelected()?A.value.draw({time:e.crosshair.time}):S.value.isSelected()?S.value.draw({price:Ee(e.crosshair.y)}):r.value.isSelected()?r.value.draw({time:e.crosshair.time}):m.value.isSelected()&&m.value.draw({price:Ee(e.crosshair.y)})}function b(o){ge(!0),o.preventDefault()}function P(o){o.stopPropagation()}function M(o){o.preventDefault(),o.stopPropagation()}function X(o){if(o.time){let O=o.seriesPrices.get(d.series.price);e.crosshair.time=o.time,e.crosshair.price=O}else s.phone||(e.crosshair.time=null,e.crosshair.price=null);o.point!==void 0&&(e.crosshair.x=o.point.x,e.crosshair.y=o.point.y)}function U(o){let O=o.customPriceLine,D=O.options();D.price=y.fmtNum(D.price);const z=+o.fromPriceString,K=D.price;switch(D.lineType){case"order":i.value.drag({line:O,lineOptions:D,oldPrice:z,newPrice:K});break;case"line":S.value.drag({lineOptions:D,oldPrice:z,newPrice:K});break;case"target":m.value.drag({lineOptions:D,newPrice:K});break;case"pattern":W.value.drag({lineOptions:D});break}}function re(){R.value&&(e.chart.resize(R.value.offsetWidth,R.value.offsetHeight),R.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function te(o){if(o.ctrlKey)switch(o.keyCode){case 219:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing-.01});break;case 221:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing+.01});break}if(o.altKey)switch(o.keyCode){case 219:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()-50);break;case 221:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()+50);break}}function ie(o){d.chartDate===k&&ke()||(o.price.length>0&&(e.whitespaces=Q(e.whitespaces,j(d.chartDate))),d.series.whitespace.setData(e.whitespaces),d.prices=Q(d.prices,o.price),d.series.price.setData(d.prices))}function ne(o,O=null){const D=O??n.value.source;let z=[];o.forEach(K=>{let pe,de;D==="FireAnt"?(pe=G(_e(new Date(K.date),7)),de=K.price):(pe=G(new Date(`${k}T${K.time}Z`)),de=K.lastPrice),z.push({time:pe,value:de})}),z.length>1?(d.prices=Q(d.prices,z),d.series.price.setData(d.prices)):(d.prices.push(z[0]),d.series.price.update(z[0]))}function j(o){const O=G(new Date(`${o}T09:00:00Z`)),D=G(new Date(`${o}T11:30:00Z`)),z=G(new Date(`${o}T13:00:00Z`)),K=G(new Date(`${o}T14:30:00Z`)),pe=G(new Date(`${o}T14:00:00Z`));let de=[];for(let Se=O;Se<=K;Se++){if(Se>D&&Se<z)continue;let qe={time:Se};(Se===pe||Se===K)&&(qe.value=1),de.push(qe)}return de}function Q(o,O){return Array.from(new Map([...o,...O].sort((D,z)=>D.time-z.time).map(D=>[D.time,D])).values())}async function Y(){if(ke()){await oe();const o=n.value.source==="FireAnt",O=o?bi:wi;e.websocket=new WebSocket(O),e.websocket.onclose=D=>{e.socketStop||(d.isSocketWarning=!0,Y())},o?Pe():(q(),he())}}async function oe(){e.websocket&&e.websocket.readyState===WebSocket.OPEN&&(e.websocket.close(),await new Promise(o=>{const O=setInterval(()=>{(!e.websocket||e.websocket.readyState===WebSocket.CLOSED)&&(e.websocket=null,clearInterval(O),o())},100)}))}function Pe(){T.dispatch("tradingDerivative/setLoading",!0),e.websocket.onopen=o=>{if(e.websocket.readyState===WebSocket.OPEN){let O='{"protocol":"json","version":1}';e.websocket.send(O),O='{"arguments":["VN30F1M"],"invocationId":"0","target":"SubscribeTrades","type":1}',e.websocket.send(O)}},e.websocket.onmessage=o=>{d.isSocketWarning=!1,le(o.data).forEach(D=>{if(!D)return!1;D.type===3?(D.result[0].date.slice(0,10)===k&&(Re(),e.whitespaces=Q(e.whitespaces,j(k)),d.series.whitespace.setData(e.whitespaces),ne(D.result)),T.dispatch("tradingDerivative/setLoading",!1)):D.type===1&&D.target==="UpdateTrades"&&D.arguments[0]==="VN30F1M"&&(console.log("FireAnt",D.arguments[1]),i.value.scan(D.arguments[1].at(-1).price),ne(D.arguments[1]))})}}function le(o){let O=[];return o.split("").forEach(D=>{const z=D.indexOf("{"),K=D.lastIndexOf("}");let pe=null;if(z!==-1&&K!==-1&&K>z){const de=D.substring(z,K+1);de!=="{}"&&(pe=JSON.parse(de))}O.push(pe)}),O}function he(){e.websocket.onopen=o=>{if(e.websocket.readyState===WebSocket.OPEN){const O={action:"join",list:n.value.vn30f1m},D=`42${JSON.stringify(["regs",JSON.stringify(O)])}`;e.websocket.send(D)}},e.websocket.onmessage=o=>{if(d.isSocketWarning=!1,o.data.substr(0,1)==="4"&&o.data.substr(1,1)==="2"){const O=JSON.parse(o.data.substr(2));if(O[0]==="stockps"){const D=O[1].data;D.id===3220&&(console.log("VPS",D),i.value.scan(D.lastPrice),ne([D]))}}}}function q(){Me(new Date,new Date(e.vpsUpdatedAt))>60&&(fetch("https://bddatafeed.vps.com.vn/getpschartintraday/VN30F1M").then(o=>o.json()).then(o=>{console.log(o),ne(o,"VPS")}),e.vpsUpdatedAt=new Date)}function Ce(){W.value.refresh()}function He(o){W.value.load(o,{isSave:!0})}function ue(){F.value.hide(),Z.value.hide(),S.value.hide()}function Je(o){F.value.set(o)}function $e(o){d.hasOrderLine=o}function ge(o){o?i.value.show({price:Ee(e.crosshair.y)}):(c.value.style.display="none",g.value.style.display="none")}function Ie({side:o,price:O}){c.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-71?-71:1))+"px",c.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-61?-61:1))+"px",c.value.style.background=o>0?"green":"red",c.value.innerText=`${o>0?"LONG":"SHORT"} ${O}`,c.value.style.display="block"}function Ae({side:o}){g.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-61?-61:1))+"px",g.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-51?-51:1))+"px",g.value.style.background=o>0?"green":"red",g.value.style.display="block"}function we(){i.value.entry()}function De(){i.value.tpsl()}function Ne(){e.chart.timeScale().scrollToRealTime()}function ke(){const o=G(_e(new Date,7));return n.value.openingMarket&&o>=x.START&&o<=x.END}function ot(){if(!d.chartDate)return!1;Be()}function at(){e.whitespaces=[],d.prices=[],Y(),Be()}function ct(){T.dispatch("tradingDerivative/initChart").then(()=>{Y(),!f.query.date&&n.value.lastOpeningDate&&(d.chartDate=n.value.lastOpeningDate),Be()})}function Be(){T.dispatch("tradingDerivative/getChartData",d.chartDate).then(o=>{o&&Re()})}function Xe(){T.dispatch("tradingDerivative/getStatus")}function Re(){T.dispatch("tradingDerivative/getTools")}function lt(){T.dispatch("tradingDerivative/getAccountInfo").then(o=>{let O="";O+='<div style="width: 200px;">',O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.nav")}</div><div>: ${C.currency(o.nav)}</div></div>`,O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.maxVol")}</div><div>: ${C.numberVnFormat(o.maxVol)}</div></div>`,O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.vm")}</div><div>: ${C.currency(o.vm)}</div></div>`,O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.fee")}</div><div>: ${C.currency(o.fee)}</div></div>`,O+="</div>",Ct(O,t("trading.derivative.accountInfo"))})}function Ee(o){return y.fmtNum(d.series.price.coordinateToPrice(o))}function Fe(o){let O=e.whitespaces.findIndex(D=>D.time===o);if(O===-1){const D=Le(new Date(o*1e3),"yyyy-MM-dd"),z=G(new Date(`${D}T11:30:00Z`)),K=G(new Date(`${D}T13:00:00Z`)),pe=G(new Date(`${D}T14:30:00Z`));o>z&&o<K?o=z:o>pe&&(o=pe),O=e.whitespaces.findIndex(de=>de.time===o)}return O}function je(o){return o<e.whitespaces.length?e.whitespaces[o].time:!1}return(o,O)=>(H(),J("div",{class:"derivative-chart",ref_key:"chartContainerRef",ref:R,onClick:L,onContextmenu:b},[B("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:u},[B("div",{class:"area data-area",onClick:P,onContextmenu:M},[B("div",{ref_key:"connectionRef",ref:h,class:ae(["command",{yellow:a.value.pending,red:n.value.volInvalid}]),title:o.$t("trading.derivative.connection"),onClick:Xe},[B("i",{class:ae(["far",{"fa-link-simple":a.value.connection,"fa-link-simple-slash":!a.value.connection,blink:d.isSocketWarning}])},null,2)],10,xi),B("div",{class:ae(["command status",{green:a.value.position>0,red:a.value.position<0}]),title:o.$t("trading.derivative.position"),onClick:lt},ye(a.value.position),11,Ci),B("div",{class:"command clock",onClick:Y},ye(d.clock),1),Te(B("input",{type:"date",class:"chart-date command",title:o.$t("trading.derivative.date"),"onUpdate:modelValue":O[0]||(O[0]=D=>d.chartDate=D),onChange:ot},null,40,ki),[[Tt,d.chartDate]]),B("div",{ref_key:"reloadToolRef",ref:p,class:"command",title:o.$t("trading.derivative.reload"),onClick:at,onContextmenu:Re},[B("i",{class:ae(["far fa-sync-alt",{"fa-spin":_.value}])},null,2)],40,_i)],32),B("div",{class:"area tool-area",onClick:P,onContextmenu:M},[ee(Dt,{chartContainerRef:R.value},null,8,["chartContainerRef"]),ee(Lt,{ref_key:"tradingviewToolRef",ref:V,vpsUser:n.value.vpsUser,vpsSession:n.value.vpsSession,chartContainerRef:R.value},null,8,["vpsUser","vpsSession","chartContainerRef"]),ee(Nt,{ref_key:"progressToolRef",ref:F,position:a.value.position,onRefreshPattern:Ce,onHideContext:ue},null,8,["position"]),ee(Xt,{ref_key:"scanToolRef",ref:Z,prices:d.prices,timeToIndex:Fe,onScaned:He,onRemovePattern:O[1]||(O[1]=()=>W.value.remove()),onHideContext:ue},null,8,["prices"]),ee(Qt,{ref_key:"patternToolRef",ref:W,prices:d.prices,priceSeries:d.series.price,timeMarkSeries:d.series.timeMark,pickTimeToolRef:A.value,timeToIndex:Fe,indexToTime:je,onSetProgress:Je,onHideContext:ue},null,8,["prices","priceSeries","timeMarkSeries","pickTimeToolRef"]),ee(ti,{ref_key:"pickTimeToolRef",ref:A,pickTimeSeries:d.series.pickTime,onRefreshPattern:Ce,onHideContext:ue},null,8,["pickTimeSeries"]),ee(pi,{ref_key:"lineToolRef",ref:S,priceSeries:d.series.price,onHideContext:ue},null,8,["priceSeries"]),ee(mi,{ref_key:"timeRangeToolRef",ref:r,timeRangeSeries:d.series.timeRange,timeToIndex:Fe,indexToTime:je,onHideContext:ue},null,8,["timeRangeSeries"]),ee(Si,{ref_key:"targetToolRef",ref:m,priceSeries:d.series.price,onHideContext:ue},null,8,["priceSeries"]),Te(ee(Ti,{ref_key:"orderToolRef",ref:i,position:a.value.position,prices:d.prices,priceSeries:d.series.price,inSession:ke,TIME:d.TIME,onGetTools:Re,onShowEntry:Ie,onShowTpSl:Ae,onOrderChanged:$e,onHideContext:ue},null,8,["position","prices","priceSeries","TIME"]),[[be,l.value]])],32),B("div",null,[B("div",{ref_key:"entryOrderRef",ref:c,class:"order-button entry",onClick:we}," Entry ",512),B("div",{ref_key:"tpslOrderRef",ref:g,class:"order-button tpsl",onClick:De}," TP/SL ",512),B("div",{class:"chart-top command far fa-angle-double-right",onClick:Ne})])],512)],544))}};export{Oi as default};
