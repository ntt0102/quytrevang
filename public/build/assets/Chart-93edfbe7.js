import{A as fi,B as vi,C as mi,l as ge,u as gi,r as L,a as hi,c as q,y as yi,E as Si,w as he,x as P,b as Ti,d as m,G as Z,t as je,H as Q,I as xi,J as te,e as De,K as wi,h as Ci,j as ki,k as Oe,L as bi,z as He,M as Di,o as Oi}from"./app-d270a4ff.js";import Li from"./LineContext-2af19000.js";import Ri from"./ScanContext-2484c7ed.js";import Ei from"./ProgressContext-c6a3df5d.js";import{c as Pi}from"./lightweight-charts.esm.development-03366bac.js";import{g as R}from"./getUnixTime-e6a2917a.js";import"./text-box-18ad4d48.js";function Ue($,W,w){return fi((w==null?void 0:w.in)||$,+vi($)+W)}function Le($,W,w){return Ue($,W*mi,w)}function Ai($,W,w){return Ue($,W*1e3,w)}function _i($,W,w){return Ai($,-W,w)}const Bi=["title"],Ii=["title"],Vi=["title"],Fi=["title"],$i=["title"],Wi=["title"],Mi=["title"],Zi=["title"],Yi=["title"],Ni=m("i",{class:"far fa-heart-rate"},null,-1),Ji=[Ni],Xi=["title"],zi=m("i",{class:"far fa-pipe"},null,-1),ji=[zi],Hi=["title"],qi=m("i",{class:"far fa-horizontal-rule"},null,-1),Qi=["title"],Ui=m("i",{class:"far fa-grip-lines-vertical"},null,-1),Gi=[Ui],Ki=["title"],es=m("i",{class:"far fa-line-height"},null,-1),ts=[es],is=["title"],ss=["src"],qe=3,Qe=2,rs="wss://tradestation.fireant.vn/quote?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",os="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",gs={__name:"Chart",setup($){const W={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.25,bottom:.25}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:1e3,minBarSpacing:.01,barSpacing:.05}},w=ge(new Date,"yyyy-MM-dd"),A={START:R(new Date(`${w}T08:45:00Z`)),ATO:R(new Date(`${w}T09:00:00Z`)),ATC:R(new Date(`${w}T14:30:00Z`)),END:R(new Date(`${w}T14:45:00Z`))},f=Ci(),Re=ki(),{t:h}=gi(),Ge=Oe("devices"),v=Oe("mf"),ie=Oe("filters"),M=L(null),Ee=L(null),Ke=L(null),et=L(null),tt=L(null),it=L(null),st=L(null),se=L(null),ye=L(null),Se=L(null),Te=L(null),re=L(null),xe=L(null),rt=L(null),Y=L(null),U=L(null);let e={chart:{},series:{},data:{whitespace:[],price:[]},tools:{pattern:{}},crosshair:{},interval:null,interval60:null,websocket:null,socketStop:!1,vpsUpdatedAt:_i(new Date,61),isAutoOrdering:!1,currentSeconds:R(Le(new Date,7))};H();const c=hi({chartDate:Re.query.date??w,clock:ge(new Date,"HH:mm:ss"),isFullscreen:!1,isSocketWarning:!1,isOrderWarning:!1,lineColor:"#F44336",lineTitle:"",progress:{},scanSide:"left",showProgressContext:!1,showScanContext:!1,showLineContext:!1,showTradingView:!1,tradingViewStyle:{left:"32px"}}),_=q(()=>f.state.tradingDerivative.status),E=q(()=>f.state.tradingDerivative.config),Pe=q(()=>f.state.tradingDerivative.tools),ot=q(()=>f.state.tradingDerivative.isLoading),nt=q(()=>_.value.position!==0||!!_.value.pending||!!Pe.value.order),at=q(()=>`https://chart.vps.com.vn/tv/?u=${E.value.vpsUser}&s=${E.value.vpsSession}&symbol=VN30F1M&resolution=1&lang=vi`);ai(),e.interval=setInterval(wt,1e3),e.interval60=setInterval(()=>{j()?(Ne(),E.value.autoRefresh&&ae(!0)):clearInterval(e.interval60)},6e4),yi(()=>{e.chart=Pi(Ee.value,W),e.chart.subscribeCrosshairMove(pt),e.chart.subscribeCustomPriceLineDragged(dt),e.series.whitespace=e.chart.addHistogramSeries({priceScaleId:"whitespace",scaleMargins:{top:0,bottom:0},color:"#808080",lastValueVisible:!1,priceLineVisible:!1}),e.series.timeRange=e.chart.addHistogramSeries({priceScaleId:"timeRange",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),e.series.pickTime=e.chart.addHistogramSeries({priceScaleId:"pickTime",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),e.series.timeMark=e.chart.addHistogramSeries({priceScaleId:"timeMark",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),e.series.price=e.chart.addLineSeries({color:"#F5F5F5",priceFormat:{minMove:.1}}),new ResizeObserver(ut).observe(M.value),document.addEventListener("keydown",Be),document.addEventListener("fullscreenchange",Ie)}),Si(()=>{e.chart&&(e.chart.remove(),e.chart=null),document.removeEventListener("keydown",Be),document.removeEventListener("fullscreenchange",Ie),clearInterval(e.interval),clearInterval(e.interval60),Fe(),e.socketStop=!0}),he(()=>f.state.tradingDerivative.chartData,vt),he(Pe,mt),he(()=>c.progress,gt),he(()=>E.value.source,(t,s)=>s?N():null);function lt(t){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1,de(!1),se.value.classList.contains("selected")?Ht():Te.value.classList.contains("selected")?Gt():re.value.classList.contains("selected")?Jt():xe.value.classList.contains("selected")?Et():ye.value.classList.contains("selected")?Vt():Se.value.classList.contains("selected")&&Zt()}function ct(t){de(!0),t.preventDefault()}function Ae(t){t.stopPropagation()}function _e(t){t.preventDefault(),t.stopPropagation()}function pt(t){if(t.time){let s=t.seriesPrices.get(e.series.price);e.crosshair.time=t.time,e.crosshair.price=s}else Ge.phone||(e.crosshair.time=null,e.crosshair.price=null);t.point!==void 0&&(e.crosshair.x=t.point.x,e.crosshair.y=t.point.y)}function dt(t){let s=t.customPriceLine,i=s.options();i.price=d(i.price);const r=+t.fromPriceString,n=i.price;switch(i.lineType){case"order":if(n!==r){let l=!1;i.kind==="entry"?_.value.position||(l=!0,e.tools.order[i.kind].price=n,f.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"change",price:e.tools.order.entry.price}}).then(a=>{a.isOk?(J([i.kind]),P.success(h("trading.derivative.changeEntrySuccess"))):(s.applyOptions({price:r}),B(a.message))})):(l=!0,e.tools.order[i.kind].price=n,i.kind==="tp"?f.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"change",price:e.tools.order.tp.price}}).then(a=>{a.isOk?(J([i.kind]),P.success(h("trading.derivative.changeTpSuccess"))):(s.applyOptions({price:r}),B(a.message))}):f.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"change",price:e.tools.order.sl.price}}).then(a=>{a.isOk?(J([i.kind]),P.success(h("trading.derivative.changeSlSuccess"))):(s.applyOptions({price:r}),B(a.message))})),l||(s.applyOptions({price:r}),P.show(h("trading.derivative.noChangeOrderLine")))}break;case"line":f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line",point:r});const o=i.color,p=i.title;f.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"line",points:[n],data:[{color:o,title:p}]}),se.value.classList.remove("selected");break;case"target":if(v.isSet(e.tools.target.B)){let l={isRemove:!1,name:"target",points:[],data:[]},a,u,g=+e.tools.target.A.options().price,S=+e.tools.target.B.options().price,y=S-g;if(a="A",i.point==="A")y=+e.tools.target.B.options().title,S=g+y;else if(i.point!=="B"){let C=0;switch(i.point){case"X":C=1.5;break;case"Y":C=2;break;case"Z":C=3;break;case"W":C=5;break}y=d((S-n)/C),g=S-y,u={price:g},e.tools.target[a].applyOptions(u)}l.points.push(a),l.data.push(g),a="B",u={price:S,title:d(y)},i.point===a&&delete u.price,e.tools.target[a].applyOptions(u),l.points.push(a),l.data.push(S),a="X",u={price:d(g-.5*y),title:d(-.5*y)},i.point===a&&delete u.price,e.tools.target[a].applyOptions(u),a="Y",u={price:d(g-y),title:d(-y)},i.point===a&&delete u.price,e.tools.target[a].applyOptions(u),a="Z",u={price:d(g-2*y),title:d(-2*y)},i.point===a&&delete u.price,e.tools.target[a].applyOptions(u),a="W",u={price:d(g-4*y),title:d(-4*y)},i.point===a&&delete u.price,e.tools.target[a].applyOptions(u),f.dispatch("tradingDerivative/drawTools",l)}break;case"pattern":if(v.isSet(e.tools.pattern.lines.B)){let l,a;e.tools.pattern.points={A:{time:e.tools.pattern.points.A.time,price:+e.tools.pattern.lines.A.options().price},B:{price:+e.tools.pattern.lines.B.options().price},C:{price:+e.tools.pattern.lines.C.options().price}},z();const{progress:u,timeMark:g,info:{rEpr1:S,rEpr2:y,rEpr3:C,entry:O,pStatus:k,x:I,X:T,y:V,Y:b}}=le();pe(u),ce(g),l="A",a={title:`A ${S}`},e.tools.pattern.lines[l].applyOptions(a),l="B",a={title:`B ${y}`},e.tools.pattern.lines[l].applyOptions(a),l="C",a={title:`C ${C}`},e.tools.pattern.lines[l].applyOptions(a),l="D",a={price:O,title:"Entry "+k},i.point===l&&delete a.price,e.tools.pattern.lines[l].applyOptions(a),l="X",a={price:d(I),title:`X ${d(T)}`},e.tools.pattern.lines[l].applyOptions(a),l="Y",a={price:d(V),title:`Y ${d(b)}`},e.tools.pattern.lines[l].applyOptions(a)}break}}function ut(){M.value&&(e.chart.resize(M.value.offsetWidth,M.value.offsetHeight),M.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function Be(t){if(t.ctrlKey)switch(t.keyCode){case 219:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing-.01});break;case 221:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing+.01});break}if(t.altKey)switch(t.keyCode){case 219:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()-50);break;case 221:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()+50);break}}function Ie(){M.value&&(document.fullscreenElement?(c.isFullscreen=!0,M.value.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(c.isFullscreen=!1,M.value.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}function ft(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function vt(t){c.chartDate===w&&j()||(t.price.length>0&&(e.data.whitespace=ne(e.data.whitespace,Ve(c.chartDate))),e.series.whitespace.setData(e.data.whitespace),e.data.price=ne(e.data.price,t.price),e.series.price.setData(e.data.price))}function oe(t,s=null){const i=s??E.value.source;let r=[];t.forEach(n=>{let o,p;i==="FireAnt"?(o=R(Le(new Date(n.date),7)),p=n.price):(o=R(new Date(`${w}T${n.time}Z`)),p=n.lastPrice),r.push({time:o,value:p})}),r.length>1?(e.data.price=ne(e.data.price,r),e.series.price.setData(e.data.price)):(e.data.price.push(r[0]),e.series.price.update(r[0]))}function Ve(t){const s=R(new Date(`${t}T09:00:00Z`)),i=R(new Date(`${t}T11:30:00Z`)),r=R(new Date(`${t}T13:00:00Z`)),n=R(new Date(`${t}T14:30:00Z`)),o=R(new Date(`${t}T14:00:00Z`));let p=[];for(let l=s;l<=n;l++){if(l>i&&l<r)continue;let a={time:l};(l===o||l===n)&&(a.value=1),p.push(a)}return p}function ne(t,s){return Array.from(new Map([...t,...s].sort((i,r)=>i.time-r.time).map(i=>[i.time,i])).values())}function mt(t){ei(),Object.entries(t).forEach(([s,i])=>{switch(s){case"order":Ct(i);break;case"pattern":Ft(i)&&(e.tools.pattern.points=v.cloneDeep(i),we());break;case"tr":Xt(i);break;case"0_pt":We(i[0]);break;case"line":qt(i);break;case"target":Kt(i);break}})}function gt(t,s){if(E.value.autoRefresh&&(t.step>s.step||t.step===s.step&&t.result>s.result)){let i="";t.result?[2,4,5].includes(t.step)?i=h("trading.derivative.progressOrder",t):i=h("trading.derivative.progressSuccess",t):i=h("trading.derivative.progressFail",t),ht(i)}}function ht(t){const s=new SpeechSynthesisUtterance(t);s.lang="vi-VN",speechSynthesis.speak(s)}async function N(){if(j()){await Fe();const t=E.value.source==="FireAnt",s=t?rs:os;e.websocket=new WebSocket(s),e.websocket.onclose=i=>{e.socketStop||(c.isSocketWarning=!0,N())},t?yt():(xt(),Tt())}}async function Fe(){e.websocket&&e.websocket.readyState===WebSocket.OPEN&&(e.websocket.close(),await new Promise(t=>{const s=setInterval(()=>{(!e.websocket||e.websocket.readyState===WebSocket.CLOSED)&&(e.websocket=null,clearInterval(s),t())},100)}))}function yt(){f.dispatch("tradingDerivative/setLoading",!0),e.websocket.onopen=t=>{if(e.websocket.readyState===WebSocket.OPEN){let s='{"protocol":"json","version":1}';e.websocket.send(s),s='{"arguments":["VN30F1M"],"invocationId":"0","target":"SubscribeTrades","type":1}',e.websocket.send(s)}},e.websocket.onmessage=t=>{c.isSocketWarning=!1,St(t.data).forEach(i=>{if(!i)return!1;i.type===3?(i.result[0].date.slice(0,10)===w&&(ue(),e.data.whitespace=ne(e.data.whitespace,Ve(w)),e.series.whitespace.setData(e.data.whitespace),oe(i.result)),f.dispatch("tradingDerivative/setLoading",!1)):i.type===1&&i.target==="UpdateTrades"&&i.arguments[0]==="VN30F1M"&&(console.log("FireAnt",i.arguments[1]),Ye(i.arguments[1].at(-1).price),oe(i.arguments[1]))})}}function St(t){let s=[];return t.split("").forEach(i=>{const r=i.indexOf("{"),n=i.lastIndexOf("}");let o=null;if(r!==-1&&n!==-1&&n>r){const p=i.substring(r,n+1);p!=="{}"&&(o=JSON.parse(p))}s.push(o)}),s}function Tt(){e.websocket.onopen=t=>{if(e.websocket.readyState===WebSocket.OPEN){const s={action:"join",list:E.value.vn30f1m},i=`42${JSON.stringify(["regs",JSON.stringify(s)])}`;e.websocket.send(i)}},e.websocket.onmessage=t=>{if(c.isSocketWarning=!1,t.data.substr(0,1)==="4"&&t.data.substr(1,1)==="2"){const s=JSON.parse(t.data.substr(2));if(s[0]==="stockps"){const i=s[1].data;i.id===3220&&(console.log("VPS",i),Ye(i.lastPrice),oe([i]))}}}}function xt(){bi(new Date,new Date(e.vpsUpdatedAt))>60&&(fetch("https://bddatafeed.vps.com.vn/getpschartintraday/VN30F1M").then(t=>t.json()).then(t=>{console.log(t),oe(t,"VPS")}),e.vpsUpdatedAt=new Date)}function wt(){e.currentSeconds=R(Le(new Date,7)),j()&&(_.value.position&&e.currentSeconds>A.ATC-5*60&&(c.isOrderWarning=!0,e.currentSeconds>A.ATC-15&&v.isSet(e.tools.order.tp.line)&&f.dispatch("tradingDerivative/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(t=>{t.isOk?(X(["entry","tp","sl"]),P.success(h("trading.derivative.autoCancelTpSlSuccess"))):B(t.message)})),E.value.openingMarket&&e.currentSeconds===A.START&&N()),c.clock=ge(new Date,"HH:mm:ss")}function J(t){const s="order";let i={isRemove:!1,name:s,points:[],data:[]},r,n;t.forEach(o=>{const p=e.tools.order.entry.price,l=e.tools.order.tp.price,a=e.tools.order.sl.price;switch(o){case"entry":r="yellow",n=e.tools.order.side>0?"LONG":"SHORT";break;case"tp":r="lime",n=d(l-p,1,!0);break;case"sl":r="red",n=d(a-p,1,!0);break}if(i.points.push(o),v.isSet(e.tools.order[o].line))e.tools.order[o].line.applyOptions({price:e.tools.order[o].price,title:n}),i.data.push(e.tools.order[o].line.options());else{const u={lineType:s,kind:o,side:e.tools.order.side,price:e.tools.order[o].price,color:r,lineWidth:1,lineStyle:0,title:n,draggable:!0};e.tools.order[o].line=e.series.price.createPriceLine(u),i.data.push(u)}}),f.dispatch("tradingDerivative/drawTools",i)}function Ct(t){Object.entries(t).forEach(([s,i])=>{e.tools.order.side=i.side,e.tools.order[s].price=i.price,e.tools.order[s].line=e.series.price.createPriceLine(i)})}function X(t,s=!0){s&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"order"}),t.forEach(i=>{v.isSet(e.tools.order[i].line)&&(e.series.price.removePriceLine(e.tools.order[i].line),delete e.tools.order[i].line)})}function kt(t){c.showTradingView=!c.showTradingView,t.stopPropagation()}function bt(){c.showProgressContext=!c.showProgressContext,c.showScanContext=!1,c.showLineContext=!1,c.showProgressContext&&ae()}function Dt(){Ot()}function Ot(t){const s=t??!E.value.autoRefresh;f.dispatch("tradingDerivative/setAutoRefresh",s)}function Lt(t){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const s=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),s||(z(!0),K(),G(),t.target.classList.add("selected"))}function Rt(){c.showScanContext=!c.showScanContext,c.showProgressContext=!1,c.showLineContext=!1}function Et(){const t=c.scanSide==="left",s=e.crosshair.time?e.data.price.filter(r=>!x(r.time,t,e.crosshair.time)):e.data.price;let i=t?Pt(s):At(s);v.isSet(i)&&(e.tools.pattern.points=_t(i),z(),K(),G(),we()),xe.value.classList.remove("selected")}function Pt(t){let s,[i,r,n,o]=Array(4).fill({});for(let p=t.length-1;p>=0;p--){const l=t[p].value,a=t[p].time,u=F(a);if(u===-1)break;if(p===t.length-1&&(n={index:u,time:a,price:l},[r,i,o]=Array(3).fill(null).map(()=>v.cloneDeep(n))),s===void 0){if(l===n.price)continue;s=l>n.price}if(x(l,s,r.price)&&(x(i.price,!s,n.price)?([n,r]=[r,i].map(g=>v.cloneDeep(g)),i={index:u,time:a,price:l},o=v.cloneDeep(i),s=!s):r={index:u,time:a,price:l}),x(l,!s,i.price)?(i={index:u,time:a,price:l},o=v.cloneDeep(i)):o.index=u,x(l,s,o.price)&&(o={index:u,time:a,price:l}),n.index>i.index){const g=d(r.price-n.price,1,!0);if(g>=1.5&&(i.index-o.index>n.index-r.index||d(i.price-o.price,1,!0)>g))break}}return{A:i,B:r,C:n}}function At(t){let s,[i,r,n]=Array(3).fill({});for(let o=0;o<t.length;o++){const p=t[o].value,l=t[o].time,a=F(l);if(a===-1)break;if(o===0&&(i={index:a,time:l,price:p},r=v.cloneDeep(i),n=v.cloneDeep(i)),s===void 0){if(p===i.price)continue;s=p>i.price}x(p,s,r.price)&&(r={index:a,time:l,price:p},n=v.cloneDeep(r)),x(r.price,s,i.price)&&x(p,!s,n.price)&&(x(p,s,i.price)?n={index:a,time:l,price:p}:(i=v.cloneDeep(r),r={index:a,time:l,price:p},n=v.cloneDeep(r),s=!s))}return{A:i,B:r,C:n}}function _t(t){const s={};return Object.entries(t).forEach(([i,r])=>{const{index:n,...o}=r;s[i]=o}),s}function Bt(t){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const s=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),s||(K(),t.target.classList.add("selected"))}function It(t){t.target.classList.remove("selected"),z(!0),K(),G()}function Vt(){const t="pattern",s=fe(e.crosshair.y),i=e.crosshair.time;let r={lineType:t,price:s,lineWidth:1,lineStyle:1,draggable:!0};if(v.isSet(e.tools.pattern.lines.A))if(v.isSet(e.tools.pattern.lines.B)){let n,o;if(v.isSet(e.tools.pattern.lines.C)){let p,l;e.tools.pattern.points.A={time:i,price:s};const{progress:a,timeMark:u,info:{rEpr1:g,rEpr2:S,rEpr3:y,entry:C,pStatus:O,x:k,X:I,y:T,Y:V}}=le();o=a,n=u,p="A",l={price:s,title:`A ${g}`},e.tools.pattern.lines[p].applyOptions(l),p="B",l={title:`B ${S}`},e.tools.pattern.lines[p].applyOptions(l),p="C",l={title:`C ${y}`},e.tools.pattern.lines[p].applyOptions(l),p="D",l={price:C,title:"Entry "+O},e.tools.pattern.lines[p].applyOptions(l),p="X",l={price:d(k),title:`X ${d(I)}`},e.tools.pattern.lines[p].applyOptions(l),p="Y",l={price:d(T),title:`Y ${d(V)}`},e.tools.pattern.lines[p].applyOptions(l)}else{e.tools.pattern.points.C={price:s};const{progress:p,timeMark:l,info:{rEpr1:a,rEpr2:u,rEpr3:g,entry:S,pStatus:y,x:C,X:O,y:k,Y:I}}=le();o=p,n=l;let T="A";e.tools.pattern.lines[T].applyOptions({title:`A ${a}`}),T="B",e.tools.pattern.lines[T].applyOptions({title:`B ${u}`}),r.point="C",r.title=`C ${g}`,r.color="#FFEB3B",e.tools.pattern.lines[r.point]=e.series.price.createPriceLine(r),r.point="D",r.price=S,r.title="Entry "+y,r.color="#9C27B0",r.draggable=!1,e.tools.pattern.lines[r.point]=e.series.price.createPriceLine(r),r.point="Y",r.price=d(k),r.title=`Y ${d(I)}`,r.color="#E91E63",r.draggable=!1,e.tools.pattern.lines[r.point]=e.series.price.createPriceLine(r),r.point="X",r.price=d(C),r.title=`X ${d(O)}`,r.color="#2196F3",r.draggable=!1,e.tools.pattern.lines[r.point]=e.series.price.createPriceLine(r)}pe(o),ce(n),ye.value.classList.remove("selected")}else r.point="B",r.title="B 0",r.color="#4CAF50",e.tools.pattern.lines[r.point]=e.series.price.createPriceLine(r),e.tools.pattern.points.B={price:s};else r.point="A",r.title="A 0",r.color="#F44336",e.tools.pattern.lines[r.point]=e.series.price.createPriceLine(r),e.tools.pattern.points={A:{time:i,price:s}};z()}function we(){let s={lineType:"pattern",lineWidth:1,lineStyle:1,draggable:!0};const{A:i,B:r,C:n}=e.tools.pattern.points,{progress:o,timeMark:p,info:{rEpr1:l,rEpr2:a,rEpr3:u,entry:g,pStatus:S,x:y,X:C,y:O,Y:k}}=le();pe(o),ce(p),s.point="A",s.title=`A ${l}`,s.color="#F44336",s.price=i.price,e.tools.pattern.lines[s.point]=e.series.price.createPriceLine(s),s.point="B",s.title=`B ${a}`,s.color="#4CAF50",s.price=r.price,e.tools.pattern.lines[s.point]=e.series.price.createPriceLine(s),s.point="C",s.price=n.price,s.title=`C ${u}`,s.color="#FFEB3B",e.tools.pattern.lines[s.point]=e.series.price.createPriceLine(s),s.point="D",s.price=g,s.title="Entry "+S,s.color="#9C27B0",s.draggable=!1,e.tools.pattern.lines[s.point]=e.series.price.createPriceLine(s),s.point="Y",s.price=d(O),s.title=`Y ${d(k)}`,s.color="#E91E63",s.draggable=!1,e.tools.pattern.lines[s.point]=e.series.price.createPriceLine(s),s.point="X",s.price=d(y),s.title=`X ${d(C)}`,s.color="#2196F3",s.draggable=!1,e.tools.pattern.lines[s.point]=e.series.price.createPriceLine(s)}function ae(t=!1){v.isSet(e.tools.pattern.lines.C)&&(t&&$t(),G(),we())}function Ft({A:{time:t}}){return e.data.whitespace.some(s=>s.time===t)}function le(){const{A:t,B:s,C:i}=e.tools.pattern.points,r=s.price-i.price,n=r>0,o=Ce({phase:1,start:t,end:s,retracementPrice:i.price});let p=Ce({phase:2,start:o.R,end:i});const l=Ce({phase:3,start:p.R,end:{price:s.price+(n?1:-1)*o.rEp},breakPrices:[p.S1.price,s.price]});o.xBox.tr>=p.tr&&(p.tr=o.xBox.tr),console.log("calculatePattern",[o,p,l]);const a=d(r,1,!0)>=o.pr,u=d(i.price-l.xBox.R.price,1,!0)>=p.pr,g=d(l.xBox.pr)>=l.pr,S=!x(i.price,!n,o.S1.price),y=!x(l.xBox.R.price,n,p.S1.price),C=!x(l.xBox.S.price,!n,l.S1.price),O=o.R.index+o.tr,k=p.R.index+p.tr,I=l.xBox.R.index+l.tr,T=l.xBox.R.index+p.tr,V=[O,k,I,T],b=l.xBox.S.index;let ee,D={};const Je=[p.R.index>O,o.rEpr<3,p.rEpr<o.rEpr];D.steps=[[a||o.rEt<o.tr&&o.rEp>=o.sEp,S,!l.breakIndexs[1]||O<l.breakIndexs[1],b>O],[...Je,k>O,b<k],[p.R.index-o.R.index>.5*o.tr,u,b>k],[g,C,b>I,Je.every(Boolean)||b>T]],D.step=1,D.result=D.steps[0].every(Boolean),ee=o.R1.price,D.result&&(b<=k?(D.step=2,D.result=D.steps[1].every(Boolean),ee=p.S1.price):(D.step=3,D.result=D.steps[2].every(Boolean),ee=l.R1.price,D.result&&(D.step=4,D.result=D.steps[3].every(Boolean),D.result&&(ee=l.xBox.R.price))));const ci=`${S?a?1:0:2}${y?u?1:0:2}${C?g?1:0:2}`,me=o.rEp,pi=$e(s.price,me,n),di=l.breakIndexs[1]??b,Xe=parseInt((di-o.R.index)/o.tr),ze=Xe>1?me*Xe:me,ui=$e(s.price,ze,n);return{progress:D,timeMark:V,info:{rEpr1:o.rEpr,rEpr2:p.rEpr,rEpr3:l.rEpr,entry:ee,pStatus:ci,x:pi,X:me,y:ui,Y:ze}}}function Ce({phase:t,start:s,end:i,breakPrices:r,retracementPrice:n}){let o=v.cloneDeep(s),p=v.cloneDeep(i);const l=p.price>o.price;let a={},u={},g={},S=[null,null],y,C,O;return e.data.price.filter(k=>{let I=k.time>=o.time;return e.tools.pickTime&&(I&=k.time<=e.tools.pickTime),I}).every((k,I)=>{const T=k.value,V=k.time,b=F(V);return b===-1?!1:((I===0||T===o.price)&&(a={R:{index:b,time:V,price:T},S:{index:b,time:V,price:T},pr:0,tr:0},u=v.cloneDeep(a),g=v.cloneDeep(a)),x(T,l,a.R.price)?(a.pr>u.pr&&(u.pr=a.pr),a.tr>=u.tr&&(u.tr=a.tr,u.R=v.cloneDeep(a.R),u.S=v.cloneDeep(a.S)),t===1&&n&&!x(a.S.price,!l,n)&&a.tr>=g.tr&&a.pr>=g.pr&&(g=v.cloneDeep(a)),a={R:{index:b,time:V,price:T},S:{index:b,time:V,price:T},pr:0,tr:0},t===3&&r&&(!S[0]&&x(T,l,r[0])&&(S[0]=b),!S[1]&&x(T,l,r[1])&&(S[1]=b))):(a.S.index=b,a.tr=a.S.index-a.R.index,x(T,!l,a.S.price)&&(a.S.time=V,a.S.price=T,a.pr=d(a.S.price-a.R.price,1,!0))),x(T,!l,o.price)?(a.S.price=o.price,!1):!!x(T,!l,p.price))}),v.isSet(a)&&(o.index=F(o.time),p.index=a.S.index,p.time=ve(a.S.index),y=d(p.price-u.R.price,1,!0),C=d(o.price-u.S.price,1,!0),O=p.index-u.S.index,t===3&&(g=a)),{tr:u.tr,pr:u.pr,rEp:y,sEp:C,rEpr:u.pr?d(y/u.pr):0,rEt:O,S1:u.S,R1:u.R,xBox:g,S:o,R:p,breakIndexs:S}}function $e(t,s,i){const r=t+(i?1:-1)*s;let n=d(r%1);if(i){if(n>=.1&&n<=.2)return Math.floor(r);if(n>=.6&&n<=.7)return Math.floor(r)+.5}else{if(n>=.8&&n<=.9)return Math.ceil(r);if(n>=.3&&n<=.4)return Math.floor(r)+.5}return r}function $t(){if(!e.tools.pickTime)return!1;let t=e.tools.pattern.points;const s=t.B.price-t.A.price>0,i=e.data.price.at(-1).value;if(x(i,!s,t.C.price)){let r=i;for(let n=e.data.price.length-1;n>=0;n--){const o=e.data.price[n].value;if(o===t.B.price)break;r=s?Math.min(r,o):Math.max(r,o)}t.C.price=r,e.tools.pattern.points=t,z()}}function z(t=!1){let s={isRemove:t,name:"pattern",points:[],data:[]};t?e.tools.pattern.points={}:Object.entries(e.tools.pattern.points).forEach(([i,r])=>{s.points.push(i),s.data.push(r)}),f.dispatch("tradingDerivative/drawTools",s)}function G(){v.isSet(e.tools.pattern.lines.A)&&(e.series.price.removePriceLine(e.tools.pattern.lines.A),v.isSet(e.tools.pattern.lines.B)&&(e.series.price.removePriceLine(e.tools.pattern.lines.B),v.isSet(e.tools.pattern.lines.C)&&(e.series.price.removePriceLine(e.tools.pattern.lines.C),e.series.price.removePriceLine(e.tools.pattern.lines.D),e.series.price.removePriceLine(e.tools.pattern.lines.X),e.series.price.removePriceLine(e.tools.pattern.lines.Y)))),H(["pattern"]),ce([]),pe({})}function ce(t){const s=["#F44336","#4CAF50","#FFEB3B","#2196F3"];let i=[];for(let r=0;r<t.length;r++){let n=ve(t[r]);n&&(t.indexOf(t[r])!==t.lastIndexOf(t[r])&&(n+=r),i.push({time:n,value:1,color:s[r]}))}i.length&&i.sort((r,n)=>r.time-n.time),e.series.timeMark.setData(i)}function pe(t){c.progress=t}function Wt(t){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const s=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),s||t.target.classList.add("selected")}function Mt(t){t.target.classList.remove("selected"),K(),ae()}function Zt(){const t=e.crosshair.time;f.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"0_pt",points:[0],data:[t]}),We(t),ae(),Se.value.classList.remove("selected")}function We(t){e.tools.pickTime=t,e.series.pickTime.setData([{time:t,value:1,color:"#9C27B0"}])}function K(t=!0){t&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"0_pt"}),e.series.pickTime.setData([]),H(["pt"])}function Yt(t){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const s=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),s||t.target.classList.add("selected")}function Nt(t){Me(),t.target.classList.remove("selected")}function Jt(){let t={isRemove:!1,name:"tr",points:[],data:[]};const s=e.crosshair.time;let i={time:s,value:1};switch(e.tools.timeRange.length){case 0:i.color="OrangeRed",e.tools.timeRange[0]=i,t.points.push(0),t.data.push(s);break;case 1:i.color="lime",e.tools.timeRange[1]=i,t.points.push(1),t.data.push(s),re.value.classList.remove("selected");break;default:const r=F(e.tools.timeRange[0].time),n=F(e.tools.timeRange[1].time),p=F(s)+(n-r),l=ve(p);i.color="OrangeRed",e.tools.timeRange[0]=v.cloneDeep(i),t.points.push(0),t.data.push(s),i.time=l,i.color="lime",e.tools.timeRange[1]=i,t.points.push(1),t.data.push(l),re.value.classList.remove("selected");break}e.series.timeRange.setData(e.tools.timeRange),f.dispatch("tradingDerivative/drawTools",t)}function Xt(t){let s,i;if(t.length===2)s=t[0],i=t[1];else if(t.length===3){const n=F(t[0]),o=F(t[1]),l=F(t[2])+(o-n);s=t[2],i=ve(l)}else return!1;let r=[{time:s,value:1,color:"OrangeRed"},{time:i,value:1,color:"lime"}];e.tools.timeRange=r,e.series.timeRange.setData(r)}function Me(t=!0){t&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"tr"}),e.series.timeRange.setData([]),H(["tr"])}function zt(t){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const s=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),s||t.target.classList.add("selected")}function jt(t){c.showLineContext=!c.showLineContext,c.showProgressContext=!1,c.showScanContext=!1}function Ht(){const t="line",s=fe(e.crosshair.y),i=e.tools.lines.length;if(e.tools.lines=e.tools.lines.filter(r=>{const n=r.options(),o=n.type=s===+n.price;return o&&(e.series.price.removePriceLine(r),f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:t,point:s})),!o}),e.tools.lines.length===i){const r=c.lineColor,n=c.lineTitle,o={lineType:t,price:s,color:r,title:n,lineWidth:1,lineStyle:1,draggable:!0};e.tools.lines.push(e.series.price.createPriceLine(o)),f.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:t,points:[s],data:[{color:r,title:n}]})}se.value.classList.remove("selected")}function qt(t){const i={lineType:"line",lineWidth:1,lineStyle:1,draggable:!0};Object.entries(t).forEach(([r,{color:n,title:o}])=>{i.price=+r,i.color=n,i.title=o,e.tools.lines.push(e.series.price.createPriceLine(i))})}function Ze(t=!0){e.tools.lines.length>0&&(t&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line"}),e.tools.lines.forEach(s=>e.series.price.removePriceLine(s)),H(["lines"]))}function Qt(t){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const s=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),s||(t.target.classList.add("selected"),ke())}function Ut(t){ke(),t.target.classList.remove("selected")}function Gt(){const t="target",s=fe(e.crosshair.y);let i={lineType:t,price:s,lineWidth:1,lineStyle:1,draggable:!0},r={isRemove:!1,name:t,points:[],data:[s]};if(v.isSet(e.tools.target.A)){const n=+e.tools.target.A.options().price,o=s-n;i.point="B",i.title=d(o),i.color="#F44336",e.tools.target[i.point]=e.series.price.createPriceLine(i),r.points.push(i.point),i.point="X",i.price=d(n-.5*o),i.title=d(-.5*o),i.color="#2196F3",e.tools.target[i.point]=e.series.price.createPriceLine(i),i.point="Y",i.price=d(n-o),i.title=d(-o),i.color="#673AB7",e.tools.target[i.point]=e.series.price.createPriceLine(i),i.point="Z",i.price=d(n-2*o),i.title=d(-2*o),i.color="#9C27B0",e.tools.target[i.point]=e.series.price.createPriceLine(i),i.point="W",i.price=d(n-4*o),i.title=d(-4*o),i.color="#E91E63",e.tools.target[i.point]=e.series.price.createPriceLine(i),Te.value.classList.remove("selected")}else i.point="A",i.title="0",i.color="#FF9800",e.tools.target[i.point]=e.series.price.createPriceLine(i),r.points.push(i.point);f.dispatch("tradingDerivative/drawTools",r)}function Kt(t){let i={lineType:"target",lineWidth:1,lineStyle:1,draggable:!0};const r=t.A,n=t.B,o=n-r;i.point="A",i.price=r,i.title="0",i.color="#FF9800",e.tools.target[i.point]=e.series.price.createPriceLine(i),i.point="B",i.price=n,i.title=d(o),i.color="#F44336",e.tools.target[i.point]=e.series.price.createPriceLine(i),i.point="X",i.price=d(r-.5*o),i.title=d(-.5*o),i.color="#2196F3",e.tools.target[i.point]=e.series.price.createPriceLine(i),i.point="Y",i.price=d(r-o),i.title=d(-o),i.color="#673AB7",e.tools.target[i.point]=e.series.price.createPriceLine(i),i.point="Z",i.price=d(r-2*o),i.title=d(-2*o),i.color="#9C27B0",e.tools.target[i.point]=e.series.price.createPriceLine(i),i.point="W",i.price=d(r-4*o),i.title=d(-4*o),i.color="#E91E63",e.tools.target[i.point]=e.series.price.createPriceLine(i)}function ke(t=!0){t&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"target"}),v.isSet(e.tools.target.A)&&(e.series.price.removePriceLine(e.tools.target.A),v.isSet(e.tools.target.B)&&(e.series.price.removePriceLine(e.tools.target.B),e.series.price.removePriceLine(e.tools.target.X),e.series.price.removePriceLine(e.tools.target.Y),e.series.price.removePriceLine(e.tools.target.Z),e.series.price.removePriceLine(e.tools.target.W))),H(["target"])}function ei(){X(["entry","tp","sl"],!1),Ze(!1),ke(!1),Me(!1),G()}function de(t){if(t){if(j()&&(v.isSet(e.tools.order.tp.line)||_.value.position&&e.currentSeconds>A.ATO&&e.currentSeconds<A.ATC&&(U.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-61?-61:1))+"px",U.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-51?-51:1))+"px",U.value.style.display="block"),!v.isSet(e.tools.order.entry.line))){let s=null,i=0;_.value.position?(e.currentSeconds<A.ATO?s="ATO":e.currentSeconds>A.ATC&&(s="ATC"),s&&(e.tools.order.entry.price=s,i=-_.value.position)):e.currentSeconds>A.ATO&&e.currentSeconds<A.ATC&&(s=fe(e.crosshair.y),i=s>=e.data.price.at(-1).value?1:-1,e.tools.order.side=i,e.tools.order.entry.price=s),i&&(Y.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-71?-71:1))+"px",Y.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-61?-61:1))+"px",Y.value.style.background=i>0?"green":"red",Y.value.innerText=`${i>0?"LONG":"SHORT"} ${s}`,Y.value.style.display="block")}}else Y.value.style.display="none",U.value.style.display="none"}function ti(){j()&&(e.currentSeconds<A.ATO?He(h("trading.derivative.atoOrder"),h("titles.confirm")).then(s=>{s&&f.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(i=>{i.isOk?P.success(h("trading.derivative.atoOrderSuccess")):B(i.message)})}):e.currentSeconds<A.ATC?f.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"new",side:e.tools.order.side,price:e.tools.order.entry.price}}).then(t=>{t.isOk?(J(["entry"]),P.success(h("trading.derivative.newEntrySuccess"))):B(t.message)}):He(h("trading.derivative.atcOrder"),h("titles.confirm")).then(s=>{s&&f.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(i=>{i.isOk?P.success(h("trading.derivative.atcOrderSuccess")):B(i.message)})}))}function ii(){e.tools.order.tp.price=e.tools.order.entry.price+e.tools.order.side*qe,e.tools.order.sl.price=e.tools.order.entry.price-e.tools.order.side*Qe,f.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.tools.order.tp.price},slData:{cmd:"new",price:e.tools.order.sl.price}}).then(t=>{t.isOk?(e.tools.order.entry.line.applyOptions({draggable:!1}),J(["entry","tp","sl"]),P.success(h("trading.derivative.newTpSlSuccess"))):B(t.message)})}function si(){v.isSet(e.tools.order.entry.line)?v.isSet(e.tools.order.tp.line)?f.dispatch("tradingDerivative/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(t=>{t.isOk?(X(["entry","tp","sl"]),P.success(h("trading.derivative.exitSuccess"))):B(t.message)}):f.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"delete"}}).then(t=>{t.isOk?(X(["entry"]),P.success(h("trading.derivative.deleteEntrySuccess"))):B(t.message)}):ue()}function Ye(t){v.isSet(e.tools.order.entry.line)&&(v.isSet(e.tools.order.tp.line)?((e.tools.order.side>0&&t>=e.tools.order.tp.price||e.tools.order.side<0&&t<=e.tools.order.tp.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,f.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"delete"}}).then(s=>{s.isOk?(X(["entry","tp","sl"]),P.success(h("trading.derivative.deleteTpSuccess")),de(!1)):B(s.message),e.isAutoOrdering=!1}))),(e.tools.order.side>0&&t<=e.tools.order.sl.price||e.tools.order.side<0&&t>=e.tools.order.sl.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,f.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"cancel"}}).then(s=>{s.isOk?(X(["entry","tp","sl"]),P.success(h("trading.derivative.deleteSlSuccess")),de(!1)):B(s.message),e.isAutoOrdering=!1})))):(e.tools.order.side>0&&t>=e.tools.order.entry.price||e.tools.order.side<0&&t<=e.tools.order.entry.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,setTimeout(()=>{e.tools.order.tp.price=e.tools.order.entry.price+e.tools.order.side*qe,e.tools.order.sl.price=e.tools.order.entry.price-e.tools.order.side*Qe,f.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.tools.order.tp.price},slData:{cmd:"new",price:e.tools.order.sl.price}}).then(s=>{s.isOk?(e.tools.order.entry.line.applyOptions({draggable:!1}),J(["entry","tp","sl"]),P.success(h("trading.derivative.autoNewTpSlSuccess"))):B(s.message),e.isAutoOrdering=!1})},1e3))))}function ri(){e.chart.timeScale().scrollToRealTime()}function j(){return E.value.openingMarket&&e.currentSeconds>=A.START&&e.currentSeconds<=A.END}function oi(){if(!c.chartDate)return!1;be()}function ni(){e.data.whitespace=[],e.data.price=[],N(),be()}function ai(){f.dispatch("tradingDerivative/initChart").then(()=>{N(),!Re.query.date&&E.value.lastOpeningDate&&(c.chartDate=E.value.lastOpeningDate),be()})}function be(){f.dispatch("tradingDerivative/getChartData",c.chartDate).then(t=>{t&&ue()})}function Ne(){f.dispatch("tradingDerivative/getStatus")}function ue(){f.dispatch("tradingDerivative/getTools")}function H(t){t||(t=["order","lines","tr","pattern","target","pt"]),t.includes("order")&&(e.tools.order={side:0,entry:{},tp:{},sl:{}}),t.includes("lines")&&(e.tools.lines=[]),t.includes("target")&&(e.tools.target={}),t.includes("tr")&&(e.tools.timeRange=[]),t.includes("pattern")&&(e.tools.pattern.lines={}),t.includes("pt")&&(e.tools.pickTime=null)}function li(){f.dispatch("tradingDerivative/getAccountInfo").then(t=>{let s="";s+='<div style="width: 200px;">',s+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${h("trading.derivative.nav")}</div><div>: ${ie.currency(t.nav)}</div></div>`,s+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${h("trading.derivative.maxVol")}</div><div>: ${ie.numberVnFormat(t.maxVol)}</div></div>`,s+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${h("trading.derivative.vm")}</div><div>: ${ie.currency(t.vm)}</div></div>`,s+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${h("trading.derivative.fee")}</div><div>: ${ie.currency(t.fee)}</div></div>`,s+="</div>",Di(s,h("trading.derivative.accountInfo"))})}function fe(t){return d(e.series.price.coordinateToPrice(t))}function d(t,s=1,i=!1){return t=+t,i&&(t=Math.abs(t)),parseFloat(t.toFixed(s))}function B(t){t||(t="unknown"),P.error(h(`trading.derivative.${t}`))}function x(t,s,i,r=!1){return s?r?t>=i:t>i:r?t<=i:t<i}function F(t){let s=e.data.whitespace.findIndex(i=>i.time===t);if(s===-1){const i=ge(new Date(t*1e3),"yyyy-MM-dd"),r=R(new Date(`${i}T11:30:00Z`)),n=R(new Date(`${i}T13:00:00Z`)),o=R(new Date(`${i}T14:30:00Z`));t>r&&t<n?t=r:t>o&&(t=o),s=e.data.whitespace.findIndex(p=>p.time===t)}return s}function ve(t){return t<e.data.whitespace.length?e.data.whitespace[t].time:!1}return(t,s)=>(Oi(),Ti("div",{class:"derivative-chart",ref_key:"chartContainerRef",ref:M,onClick:lt,onContextmenu:ct},[m("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:Ee},[m("div",{class:"area data-area",onClick:Ae,onContextmenu:_e},[m("div",{ref_key:"connectionRef",ref:Ke,class:Z(["command",{yellow:_.value.pending,red:E.value.volInValid}]),title:t.$t("trading.derivative.connection"),onClick:Ne},[m("i",{class:Z(["far",{"fa-link-simple":_.value.connection,"fa-link-simple-slash":!_.value.connection,blink:c.isSocketWarning}])},null,2)],10,Bi),m("div",{class:Z(["command status",{green:_.value.position>0,red:_.value.position<0}]),title:t.$t("trading.derivative.position"),onClick:li},je(_.value.position),11,Ii),m("div",{class:"command clock",onClick:N},je(c.clock),1),Q(m("input",{type:"date",class:"chart-date command",title:t.$t("trading.derivative.date"),"onUpdate:modelValue":s[0]||(s[0]=i=>c.chartDate=i),onChange:oi},null,40,Vi),[[xi,c.chartDate]]),m("div",{ref_key:"reloadToolRef",ref:it,class:"command",title:t.$t("trading.derivative.reload"),onClick:ni,onContextmenu:ue},[m("i",{class:Z(["far fa-sync-alt",{"fa-spin":ot.value}])},null,2)],40,Fi)],32),m("div",{class:"area tool-area",onClick:Ae,onContextmenu:_e},[m("div",{ref_key:"fullscreenToolRef",ref:et,class:"command",title:t.$t("trading.derivative.fullscreen"),onClick:ft},[m("i",{class:Z(["far",{"fa-compress":c.isFullscreen,"fa-expand":!c.isFullscreen}])},null,2)],8,$i),m("div",{ref_key:"tradingviewRef",ref:st,class:"command far fa-chart-candlestick",title:t.$t("trading.derivative.tradingview"),onClick:kt},null,8,Wi),m("div",{class:Z(["context command",{green:c.progress.result===!0,red:c.progress.result===!1}]),title:t.$t("trading.derivative.progressTool"),onClick:bt,onContextmenu:Dt},[m("i",{class:Z(["far",{"fa-badge-check":!c.progress.step,[`fa-circle-${c.progress.step}`]:c.progress.step,blink:E.value.autoRefresh}])},null,2),Q(De(Ei,{class:"contextmenu",progress:c.progress},null,8,["progress"]),[[te,c.showProgressContext]])],42,Mi),m("div",{ref_key:"scanToolRef",ref:xe,class:"context command",title:t.$t("trading.derivative.scanTool"),onClick:Lt,onContextmenu:Rt},[m("i",{class:Z(["far",{[`fa-angles-${c.scanSide}`]:!0}])},null,2),Q(De(Ri,{class:"contextmenu",modelValue:c.scanSide,"onUpdate:modelValue":s[1]||(s[1]=i=>c.scanSide=i)},null,8,["modelValue"]),[[te,c.showScanContext]])],40,Zi),m("div",{ref_key:"patternToolRef",ref:ye,class:"command",title:t.$t("trading.derivative.patternTool"),onClick:Bt,onContextmenu:It},Ji,40,Yi),m("div",{ref_key:"pickTimeToolRef",ref:Se,class:"command",title:t.$t("trading.derivative.pickTimeTool"),onClick:Wt,onContextmenu:Mt},ji,40,Xi),m("div",{ref_key:"lineToolRef",ref:se,class:"context command",title:t.$t("trading.derivative.lineTool"),onClick:zt,onContextmenu:jt},[qi,Q(De(Li,{class:"contextmenu",enable:c.showLineContext,title:c.lineTitle,"onUpdate:title":s[2]||(s[2]=i=>c.lineTitle=i),color:c.lineColor,"onUpdate:color":s[3]||(s[3]=i=>c.lineColor=i),onDeleteAllLine:Ze},null,8,["enable","title","color"]),[[te,c.showLineContext]])],40,Hi),m("div",{ref_key:"timeRangeToolRef",ref:re,class:"command",title:t.$t("trading.derivative.timeRangeTool"),onClick:Yt,onContextmenu:Nt},Gi,40,Qi),m("div",{ref_key:"targetToolRef",ref:Te,class:"command",title:t.$t("trading.derivative.targetTool"),onClick:Qt,onContextmenu:Ut},ts,40,Ki),Q(m("div",{ref_key:"cancelOrderRef",ref:rt,class:"cancel-order command",title:t.$t("trading.derivative.cancelTool"),onClick:si},[m("i",{class:Z(["far fa-trash-alt",{blink:c.isOrderWarning}])},null,2)],8,is),[[te,nt.value]])],32),m("div",null,[m("div",{ref_key:"entryOrderRef",ref:Y,class:"order-button entry",onClick:ti}," Entry ",512),m("div",{ref_key:"tpslOrderRef",ref:U,class:"order-button tpsl",onClick:ii}," TP/SL ",512),m("div",{class:"chart-top command far fa-angle-double-right",onClick:ri})]),Q(m("iframe",{ref_key:"tradingviewChartRef",ref:tt,class:"tradingview-chart",style:wi(c.tradingViewStyle),src:at.value},null,12,ss),[[te,c.showTradingView]])],512)],544))}};export{gs as default};
