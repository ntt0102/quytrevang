import{z as ct,A as lt,B as pt,r as N,y as We,C as Ge,o as H,b as J,d as B,E as ae,c as ce,G as Te,H as _e,I as dt,J as ut,m as Ke,e as ee,F as Me,K as Ve,t as ye,h as me,u as Oe,L as ft,M as mt,N as je,O as et,g as tt,k as fe,w as ve,Q as vt,R as ht,S as qe,x as se,l as Le,a as gt,T as St,U as yt,j as Tt,V as xt}from"./app-1d3fc303.js";import{_ as Ct}from"./text-box-32c5b0f5.js";import{g as G}from"./getUnixTime-23abbbe3.js";import{c as kt}from"./lightweight-charts.esm.development-03366bac.js";function it(D,$,x){return ct((x==null?void 0:x.in)||D,+lt(D)+$)}function ke(D,$,x){return it(D,$*pt,x)}function _t(D,$,x){return it(D,$*1e3,x)}function bt(D,$,x){return _t(D,-$,x)}const wt=["title"],Dt={__name:"FullscreenTool",props:["chartContainerRef"],setup(D){const $=D,x=N(!1);We(()=>{document.addEventListener("fullscreenchange",t)}),Ge(()=>{document.removeEventListener("fullscreenchange",t)});function m(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function t(){$.chartContainerRef&&(document.fullscreenElement?(x.value=!0,$.chartContainerRef.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(x.value=!1,$.chartContainerRef.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}return(r,T)=>(H(),J("div",{class:"command",title:r.$t("trading.derivative.fullscreen"),onClick:m},[B("i",{class:ae(["far",{"fa-compress":x.value,"fa-expand":!x.value}])},null,2)],8,wt))}},Rt=["title"],Et=["src"],Lt={__name:"TradingviewTool",props:["vpsUser","vpsSession","chartContainerRef"],setup(D){const $=D,x=N(null),m=N(!1),t=ce(()=>`https://chart.vps.com.vn/tv/?u=${$.vpsUser}&s=${$.vpsSession}&symbol=VN30F1M&resolution=1&lang=vi`);function r(y){m.value=!m.value,T(),y.stopPropagation()}function T(){if($.chartContainerRef&&x.value){const{offsetWidth:y,offsetHeight:O}=$.chartContainerRef,{top:f,left:h}=x.value.getBoundingClientRect();x.value.style.top=`${f-2}px`,x.value.style.left=`${h+32}px`,x.value.style.width=`${y-34}px`,x.value.style.height=`${O}px`}}return(y,O)=>(H(),J("div",{class:"tradingview command far fa-chart-candlestick",title:y.$t("trading.derivative.tradingview"),onClick:r},[Te(B("iframe",{ref_key:"tradingviewRef",ref:x,class:"chart",src:t.value},null,8,Et),[[_e,m.value]])],8,Rt))}};const Ot=B("div",{class:"triangle-shadow"},null,-1),Pt=B("div",{class:"triangle"},null,-1),It={class:"container"},$t={__name:"ProgressContext",props:["progress"],emits:["refreshPattern"],setup(D,{emit:$}){const x=$,m=N([]);We(()=>{t()});function t(){dt(Object.assign({"../../../../../lang/vi/derivative.js":()=>ut(()=>import("./derivative-0a1a41d1.js"),[])}),`../../../../../lang/${window.lang}/derivative.js`).then(y=>{m.value=y.default||[]})}function r(){x("refreshPattern")}function T(y){y.stopPropagation()}return(y,O)=>{const f=Ke("DxButton");return H(),J("div",{class:"pattern-context",onClick:T},[Ot,Pt,B("div",null,[ee(f,{icon:"refresh",type:"success",text:y.$t("trading.derivative.progressContext.refreshPattern"),onClick:r},null,8,["text"])]),B("div",It,[(H(!0),J(Me,null,Ve(m.value,(h,p)=>(H(),J("div",{key:p,class:ae(["step",[D.progress.step&&D.progress.step===p+1?D.progress.result?"success":"fail":""]])},[B("div",{class:ae(["name",[D.progress.steps?D.progress.steps[p].every(Boolean)?"success":"fail":""]])},ye(p+1)+". "+ye(h.name),3),B("div",null,[(H(!0),J(Me,null,Ve(h.conds,(V,F)=>(H(),J("div",{key:F,class:ae(["condition",[D.progress.steps?D.progress.steps[p][F]?"success":"fail":""]])},ye(F+1)+". "+ye(V),3))),128))])],2))),128))])])}}},At=["title"],Nt={__name:"ProgressTool",props:["position"],emits:["refreshPattern","hideContext"],setup(D,{expose:$,emit:x}){const m=me(),{t}=Oe(),r=D,T=x,y=N({}),O=N(!1),f=ce(()=>m.state.tradingDerivative.config.autoRefresh);$({hide:p,set:V});function h(){const d=O.value;T("hideContext"),O.value=!d,O.value&&F()}function p(d){O.value=d}function V(d){r.position||W(d,y.value),y.value=d}function F(){T("refreshPattern")}function Z(d){const s=d??!s.value;m.dispatch("tradingDerivative/setAutoRefresh",s)}function W(d,s){if(f.value&&d&&(d.step!==s.step||d.step===s.step&&d.result!==s.result)){let g="";d.result?[2,4].includes(d.step)?g=t("trading.derivative.progressOrder",d):g=t("trading.derivative.progressSuccess",d):g=t("trading.derivative.progressFail",d),A(g)}}function A(d){const s=new SpeechSynthesisUtterance(d);s.lang="vi-VN",speechSynthesis.speak(s)}return(d,s)=>(H(),J("div",{class:ae(["context command",{green:y.value.result===!0,red:y.value.result===!1}]),title:d.$t("trading.derivative.progressTool"),onClick:h,onContextmenu:Z},[B("i",{class:ae(["far",{"fa-badge-check":!y.value.step,[`fa-circle-${y.value.step}`]:y.value.step,blink:f.value}])},null,2),Te(ee($t,{class:"contextmenu",progress:y.value,onRefreshPattern:F},null,8,["progress"]),[[_e,O.value]])],42,At))}};var xe={};const Bt=ft(mt);/*!
 * devextreme-vue
 * Version: 22.2.12
 * Build date: Mon Apr 29 2024
 *
 * Copyright (c) 2012 - 2024 Developer Express Inc. ALL RIGHTS RESERVED
 *
 * This software may be modified and distributed under the terms
 * of the MIT license. See the LICENSE file in the root of the project for details.
 *
 * https://github.com/DevExpress/devextreme-vue
 */var Ft=je&&je.__importDefault||function(D){return D&&D.__esModule?D:{default:D}};Object.defineProperty(xe,"__esModule",{value:!0});xe.DxItem=xe.DxButtonGroup=void 0;var Mt=Ft(Bt),Vt=et,Wt=et,nt=Vt.createComponent({props:{accessKey:String,activeStateEnabled:Boolean,buttonTemplate:{},disabled:Boolean,elementAttr:Object,focusStateEnabled:Boolean,height:[Function,Number,String],hint:String,hoverStateEnabled:Boolean,items:Array,keyExpr:[Function,String],onContentReady:Function,onDisposing:Function,onInitialized:Function,onItemClick:Function,onOptionChanged:Function,onSelectionChanged:Function,rtlEnabled:Boolean,selectedItemKeys:Array,selectedItems:Array,selectionMode:String,stylingMode:String,tabIndex:Number,visible:Boolean,width:[Function,Number,String]},emits:{"update:isActive":null,"update:hoveredElement":null,"update:accessKey":null,"update:activeStateEnabled":null,"update:buttonTemplate":null,"update:disabled":null,"update:elementAttr":null,"update:focusStateEnabled":null,"update:height":null,"update:hint":null,"update:hoverStateEnabled":null,"update:items":null,"update:keyExpr":null,"update:onContentReady":null,"update:onDisposing":null,"update:onInitialized":null,"update:onItemClick":null,"update:onOptionChanged":null,"update:onSelectionChanged":null,"update:rtlEnabled":null,"update:selectedItemKeys":null,"update:selectedItems":null,"update:selectionMode":null,"update:stylingMode":null,"update:tabIndex":null,"update:visible":null,"update:width":null},computed:{instance:function(){return this.$_instance}},beforeCreate:function(){this.$_WidgetClass=Mt.default,this.$_hasAsyncTemplate=!0,this.$_expectedChildren={item:{isCollectionItem:!0,optionName:"items"}}}});xe.DxButtonGroup=nt;var Ze=Wt.createConfigurationComponent({emits:{"update:isActive":null,"update:hoveredElement":null,"update:disabled":null,"update:elementAttr":null,"update:hint":null,"update:html":null,"update:icon":null,"update:template":null,"update:text":null,"update:type":null,"update:visible":null},props:{disabled:Boolean,elementAttr:Object,hint:String,html:String,icon:String,template:{},text:String,type:String,visible:Boolean}});xe.DxItem=Ze;Ze.$_optionName="items";Ze.$_isCollectionItem=!0;var Zt=xe.default=nt;const Yt=B("div",{class:"triangle-shadow"},null,-1),zt=B("div",{class:"triangle"},null,-1),Ht={__name:"ScanContext",props:["modelValue"],emits:["update:modelValue"],setup(D,{emit:$}){const{t:x}=Oe(),m=[{icon:"chevrondoubleleft",side:"left",text:x("trading.derivative.scanContext.leftScan")},{icon:"chevrondoubleright",side:"right",text:x("trading.derivative.scanContext.rightScan")}],t=D,r=$;function T({itemData:{side:O}}){r("update:modelValue",O)}function y(O){O.stopPropagation()}return(O,f)=>(H(),J("div",{class:"scan-context",onClick:y},[Yt,zt,ee(tt(Zt),{items:m,"selected-item-keys":[t.modelValue],"key-expr":"side","styling-mode":"outlined",onItemClick:T},null,8,["selected-item-keys"])]))}},Jt=["title"],Xt={__name:"ScanTool",props:["prices","timeToIndex"],emits:["scaned","removePattern","hideContext"],setup(D,{expose:$,emit:x}){const m=fe("mf"),t=D,r=x,T=N(null),y=N(!1),O=N("left");$({isSelected:f,hide:h,draw:F});function f(){return T.value.classList.contains("selected")}function h(d){y.value=d}function p(d){r("hideContext");const s=d.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(g=>g.classList.remove("selected")),s||(d.target.classList.add("selected"),r("removePattern"))}function V(){const d=y.value;r("hideContext"),y.value=!d}function F({time:d}){const s=O.value==="left",g=d?t.prices.filter(c=>!m.cmp(c.time,s,d)):t.prices;let i=s?Z(g):W(g);m.isSet(i)&&r("scaned",A(i)),T.value.classList.remove("selected")}function Z(d){let s,[g,i,c,S]=Array(4).fill({});for(let v=d.length-1;v>=0;v--){const _=d[v].value,C=d[v].time,e=t.timeToIndex(C);if(e===-1)break;if(v===d.length-1&&(c={index:e,time:C,price:_},[i,g,S]=Array(3).fill(null).map(()=>m.cloneDeep(c))),s===void 0){if(_===c.price)continue;s=_>c.price}if(m.cmp(_,s,i.price)&&(m.cmp(g.price,!s,c.price)?([c,i]=[i,g].map(u=>m.cloneDeep(u)),g={index:e,time:C,price:_},S=m.cloneDeep(g),s=!s):i={index:e,time:C,price:_}),m.cmp(_,!s,g.price)?(g={index:e,time:C,price:_},S=m.cloneDeep(g)):S.index=e,m.cmp(_,s,S.price)&&(S={index:e,time:C,price:_}),c.index>g.index){const u=m.fmtNum(i.price-c.price,1,!0);if(u>=1.5&&(g.index-S.index>c.index-i.index||m.fmtNum(g.price-S.price,1,!0)>u))break}}return{A:g,B:i,C:c}}function W(d){let s,[g,i,c]=Array(3).fill({});for(let S=0;S<d.length;S++){const v=d[S].value,_=d[S].time,C=t.timeToIndex(_);if(C===-1)break;if(S===0&&(g={index:C,time:_,price:v},i=m.cloneDeep(g),c=m.cloneDeep(g)),s===void 0){if(v===g.price)continue;s=v>g.price}m.cmp(v,s,i.price)&&(i={index:C,time:_,price:v},c=m.cloneDeep(i)),m.cmp(i.price,s,g.price)&&m.cmp(v,!s,c.price)&&(m.cmp(v,s,g.price)?c={index:C,time:_,price:v}:(g=m.cloneDeep(i),i={index:C,time:_,price:v},c=m.cloneDeep(i),s=!s))}return{A:g,B:i,C:c}}function A(d){const s={};return Object.entries(d).forEach(([g,i])=>{const{index:c,...S}=i;s[g]=S}),s}return(d,s)=>(H(),J("div",{ref_key:"scanToolRef",ref:T,class:"context command",title:d.$t("trading.derivative.scanTool"),onClick:p,onContextmenu:V},[B("i",{class:ae(["far",{[`fa-angles-${O.value}`]:!0}])},null,2),Te(ee(Ht,{class:"contextmenu",modelValue:O.value,"onUpdate:modelValue":s[0]||(s[0]=g=>O.value=g)},null,8,["modelValue"]),[[_e,y.value]])],40,Jt))}},jt=["title"],qt=B("i",{class:"far fa-heart-rate"},null,-1),Ut=[qt],Qt={__name:"PatternTool",props:["prices","priceSeries","timeMarkSeries","pickTimeToolRef","timeToIndex","indexToTime"],emits:["setProgress","hideContext"],setup(D,{expose:$,emit:x}){const m=me(),t=fe("mf"),r=D,T=x,y=N(null),O=ce(()=>m.state.tradingDerivative.tools.pattern);let f={},h={};$({isSelected:p,draw:Z,load:W,refresh:d,remove:_,drag:u}),ve(O,a=>{a&&W(a,{isCheck:!0})});function p(){return y.value.classList.contains("selected")}function V(a){T("hideContext");const n=a.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(k=>k.classList.remove("selected")),n||(a.target.classList.add("selected"),r.pickTimeToolRef.remove())}function F(a){a.target.classList.remove("selected"),_()}function Z({time:a,price:n}){let l={lineType:"pattern",price:n,lineWidth:1,lineStyle:1,draggable:!0};if(t.isSet(h.A))if(t.isSet(h.B)){let I,R;if(t.isSet(h.C)){let E,b;f.A={time:a,price:n};const{progress:P,timeMark:M,info:{rEpr1:X,rEpr2:U,rEpr3:re,entry:te,pStatus:ie,x:ne,X:j,y:Q,Y}}=s();R=P,I=M,E="A",b={price:n,title:`A ${X}`},h[E].applyOptions(b),E="B",b={title:`B ${U}`},h[E].applyOptions(b),E="C",b={title:`C ${re}`},h[E].applyOptions(b),E="D",b={price:te,title:"Entry "+ie},h[E].applyOptions(b),E="X",b={price:t.fmtNum(ne),title:`X ${t.fmtNum(j)}`},h[E].applyOptions(b),E="Y",b={price:t.fmtNum(Q),title:`Y ${t.fmtNum(Y)}`},h[E].applyOptions(b)}else{f.C={price:n};const{progress:E,timeMark:b,info:{rEpr1:P,rEpr2:M,rEpr3:X,entry:U,pStatus:re,x:te,X:ie,y:ne,Y:j}}=s();R=E,I=b;let Q="A";h[Q].applyOptions({title:`A ${P}`}),Q="B",h[Q].applyOptions({title:`B ${M}`}),l.point="C",l.title=`C ${X}`,l.color="#FFEB3B",h[l.point]=r.priceSeries.createPriceLine(l),l.point="D",l.price=U,l.title="Entry "+re,l.color="#9C27B0",l.draggable=!1,h[l.point]=r.priceSeries.createPriceLine(l),l.point="Y",l.price=t.fmtNum(ne),l.title=`Y ${t.fmtNum(j)}`,l.color="#E91E63",l.draggable=!1,h[l.point]=r.priceSeries.createPriceLine(l),l.point="X",l.price=t.fmtNum(te),l.title=`X ${t.fmtNum(ie)}`,l.color="#2196F3",l.draggable=!1,h[l.point]=r.priceSeries.createPriceLine(l)}v(),T("setProgress",R),e(I),y.value.classList.remove("selected")}else l.point="B",l.title="B 0",l.color="#4CAF50",h[l.point]=r.priceSeries.createPriceLine(l),f.B={price:n};else l.point="A",l.title="A 0",l.color="#F44336",h[l.point]=r.priceSeries.createPriceLine(l),f={A:{time:a,price:n}}}function W(a,{isSave:n=!1,isCheck:k=!1}){f=t.cloneDeep(a),n&&v(),(k?i(f):!0)&&(C(),A())}function A(){let n={lineType:"pattern",lineWidth:1,lineStyle:1,draggable:!0};const{A:k,B:l,C:I}=f,{progress:R,timeMark:E,info:{rEpr1:b,rEpr2:P,rEpr3:M,entry:X,pStatus:U,x:re,X:te,y:ie,Y:ne}}=s();T("setProgress",R),e(E),n.point="A",n.title=`A ${b}`,n.color="#F44336",n.price=k.price,h[n.point]=r.priceSeries.createPriceLine(n),n.point="B",n.title=`B ${P}`,n.color="#4CAF50",n.price=l.price,h[n.point]=r.priceSeries.createPriceLine(n),n.point="C",n.price=I.price,n.title=`C ${M}`,n.color="#FFEB3B",h[n.point]=r.priceSeries.createPriceLine(n),n.point="D",n.price=X,n.title="Entry "+U,n.color="#9C27B0",n.draggable=!1,h[n.point]=r.priceSeries.createPriceLine(n),n.point="Y",n.price=t.fmtNum(ie),n.title=`Y ${t.fmtNum(ne)}`,n.color="#E91E63",n.draggable=!1,h[n.point]=r.priceSeries.createPriceLine(n),n.point="X",n.price=t.fmtNum(re),n.title=`X ${t.fmtNum(te)}`,n.color="#2196F3",n.draggable=!1,h[n.point]=r.priceSeries.createPriceLine(n)}function d(a=!1){t.isSet(h.C)&&(a&&S(),C(),A())}function s(){const{A:a,B:n,C:k}=f,l=n.price-k.price,I=l>0,R=g({phase:1,start:a,end:n,retracementPrice:k.price});let E=g({phase:2,start:R.R,end:k});const b=g({phase:3,start:E.R,end:{price:n.price+(I?1:-1)*R.rEp},breakPrices:[E.S1.price,n.price]});R.xBox.tr>=E.tr&&(E.tr=R.xBox.tr),console.log("calculatePattern",[R,E,b]);const P=t.fmtNum(l,1,!0)>=R.pr,M=t.fmtNum(k.price-b.xBox.R.price,1,!0)>=E.pr,X=t.fmtNum(b.xBox.pr)>=b.pr,U=!t.cmp(k.price,!I,R.S1.price),re=!t.cmp(b.xBox.R.price,I,E.S1.price),te=!t.cmp(b.xBox.S.price,!I,b.S1.price),ie=R.R.index+R.tr,ne=R.R.index+5*R.tr,j=E.R.index+E.tr,Q=b.xBox.R.index+b.tr,Y=b.xBox.R.index+5*b.tr,oe=b.xBox.R.index+E.tr,Pe=[ie,ne,j,Q,Y,oe],le=b.xBox.S.index;let he,q={};const Ce=[E.R.index>ie,R.rEpr<3,E.rEpr<R.rEpr];q.steps=[[P||R.rEt<R.tr&&R.rEp>=R.sEp,U,!b.breakIndexs[1]||ie<b.breakIndexs[1],le>ie,le<ne],[...Ce,j>ie,le<Y,le<j],[E.R.index-R.R.index>.5*R.tr,M,!b.breakIndexs[1]||j<b.breakIndexs[1],le>j],[X,te,le>Q,Ce.every(Boolean)||le>oe]],q.step=1,q.result=q.steps[0].every(Boolean),he=R.R1.price,q.result&&(le<=j?(q.step=2,q.result=q.steps[1].every(Boolean),he=E.S1.price):(q.step=3,q.result=q.steps[2].every(Boolean),he=b.R1.price,q.result&&(q.step=4,q.result=q.steps[3].every(Boolean),q.result&&(he=b.xBox.R.price))));const Ie=`${U?P?1:0:2}${re?M?1:0:2}${te?X?1:0:2}`,ge=R.rEp,$e=c(n.price,ge,I),Ae=b.breakIndexs[1]??le,be=parseInt((Ae-R.R.index)/R.tr),we=be>1?ge*be:ge,Ne=c(n.price,we,I);return{progress:q,timeMark:Pe,info:{rEpr1:R.rEpr,rEpr2:E.rEpr,rEpr3:b.rEpr,entry:he,pStatus:Ie,x:$e,X:ge,y:Ne,Y:we}}}function g({phase:a,start:n,end:k,breakPrices:l,retracementPrice:I}){let R=t.cloneDeep(n),E=t.cloneDeep(k);const b=E.price>R.price;let P={},M={},X={},U=[null,null],re,te,ie;const ne=r.pickTimeToolRef.get();return r.prices.filter(j=>{let Q=j.time>=R.time;return ne&&(Q&=j.time<=ne),Q}).every((j,Q)=>{const Y=j.value,oe=r.timeToIndex(j.time);return oe===-1?!1:((Q===0||Y===R.price)&&(P={R:{index:oe,price:Y},S:{index:oe,price:Y},pr:0,tr:0},M=t.cloneDeep(P),X=t.cloneDeep(P)),t.cmp(Y,b,P.R.price)?(P.pr>0&&(P.pr>=M.pr&&(M.pr=P.pr,M.R=t.cloneDeep(P.R),M.S=t.cloneDeep(P.S)),P.tr>M.tr&&(M.tr=P.tr),a===1&&I&&!t.cmp(P.S.price,!b,I)&&P.tr>=X.tr&&P.pr>=X.pr&&(X=t.cloneDeep(P))),P={R:{index:oe,price:Y},S:{index:oe,price:Y},pr:0,tr:0},a===3&&l&&(!U[0]&&t.cmp(Y,b,l[0])&&(U[0]=oe),!U[1]&&t.cmp(Y,b,l[1])&&(U[1]=oe))):(P.S.index=oe,P.tr=P.S.index-P.R.index,t.cmp(Y,!b,P.S.price)&&(P.S.price=Y,P.pr=t.fmtNum(P.S.price-P.R.price,1,!0))),t.cmp(Y,!b,R.price)?(P.S.price=R.price,!1):!!t.cmp(Y,!b,E.price))}),t.isSet(P)&&(R.index=r.timeToIndex(R.time),E.index=P.S.index,E.time=r.indexToTime(P.S.index),re=t.fmtNum(E.price-M.R.price,1,!0),te=t.fmtNum(R.price-M.S.price,1,!0),ie=E.index-M.S.index,a===3&&(X=P)),{tr:M.tr,pr:M.pr,rEp:re,sEp:te,rEpr:M.pr?t.fmtNum(re/M.pr):0,rEt:ie,S1:M.S,R1:M.R,xBox:X,S:R,R:E,breakIndexs:U}}function i({A:{time:a}}){return a>=r.prices[0].time&&a<r.prices.at(-1).time}function c(a,n,k){const l=a+(k?1:-1)*n;let I=t.fmtNum(l%1);if(k){if(I>=.1&&I<=.2)return Math.floor(l);if(I>=.6&&I<=.7)return Math.floor(l)+.5}else{if(I>=.8&&I<=.9)return Math.ceil(l);if(I>=.3&&I<=.4)return Math.floor(l)+.5}return l}function S(){if(!r.pickTime)return!1;const a=f.B.price-f.A.price>0,n=r.prices.at(-1).value;if(t.cmp(n,!a,f.C.price)){let k=n;for(let l=r.prices.length-1;l>=0;l--){const I=r.prices[l].value;if(I===f.B.price)break;k=a?Math.min(k,I):Math.max(k,I)}f.C.price=k,v()}}function v(a=!1){let n={isRemove:a,name:"pattern",points:[],data:[]};a?f={}:Object.entries(f).forEach(([k,l])=>{n.points.push(k),n.data.push(l)}),m.dispatch("tradingDerivative/drawTools",n)}function _(){v(!0),r.pickTimeToolRef.remove(),C(),T("setProgress",{})}function C(){t.isSet(h.A)&&(r.priceSeries.removePriceLine(h.A),t.isSet(h.B)&&(r.priceSeries.removePriceLine(h.B),t.isSet(h.C)&&(r.priceSeries.removePriceLine(h.C),r.priceSeries.removePriceLine(h.D),r.priceSeries.removePriceLine(h.X),r.priceSeries.removePriceLine(h.Y)))),h={},e([])}function e(a){const n=["#F44336","#F44336","#4CAF50","#FFEB3B","#FFEB3B","#2196F3"];let k=[];for(let l=0;l<a.length;l++){let I=r.indexToTime(a[l]);I&&(a.indexOf(a[l])!==a.lastIndexOf(a[l])&&(I+=l),k.push({time:I,value:1,color:n[l]}))}k.length&&k.sort((l,I)=>l.time-I.time),r.timeMarkSeries.setData(k)}function u({lineOptions:a}){if(t.isSet(h.C)){let n,k;f={A:{time:f.A.time,price:+h.A.options().price},B:{price:+h.B.options().price},C:{price:+h.C.options().price}},v();const{progress:l,timeMark:I,info:{rEpr1:R,rEpr2:E,rEpr3:b,entry:P,pStatus:M,x:X,X:U,y:re,Y:te}}=s();T("setProgress",l),e(I),n="A",k={title:`A ${R}`},h[n].applyOptions(k),n="B",k={title:`B ${E}`},h[n].applyOptions(k),n="C",k={title:`C ${b}`},h[n].applyOptions(k),n="D",k={price:P,title:"Entry "+M},a.point===n&&delete k.price,h[n].applyOptions(k),n="X",k={price:t.fmtNum(X),title:`X ${t.fmtNum(U)}`},h[n].applyOptions(k),n="Y",k={price:t.fmtNum(re),title:`Y ${t.fmtNum(te)}`},h[n].applyOptions(k)}}return(a,n)=>(H(),J("div",{ref_key:"patternToolRef",ref:y,class:"command",title:a.$t("trading.derivative.patternTool"),onClick:V,onContextmenu:F},Ut,40,jt))}},Gt=["title"],Kt=B("i",{class:"far fa-pipe"},null,-1),ei=[Kt],ti={__name:"PickTimeTool",props:["pickTimeSeries"],emits:["refreshPattern","hideContext"],setup(D,{expose:$,emit:x}){const m=me(),t=D,r=x,T=N(null),y=ce(()=>m.state.tradingDerivative.tools.pickTime);let O=null;$({isSelected:f,draw:F,remove:W,get:h}),ve(y,A=>{A&&Z(A[0])});function f(){return T.value.classList.contains("selected")}function h(){return O}function p(A){r("hideContext");const d=A.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(s=>s.classList.remove("selected")),d||A.target.classList.add("selected")}function V(A){A.target.classList.remove("selected"),W(),r("refreshPattern")}function F({time:A}){m.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"pickTime",points:[0],data:[A]}),Z(A),r("refreshPattern"),T.value.classList.remove("selected")}function Z(A){O=A,t.pickTimeSeries.setData([{time:A,value:1,color:"#9C27B0"}])}function W(A=!0){A&&m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"pickTime"}),t.pickTimeSeries.setData([]),O=null}return(A,d)=>(H(),J("div",{ref_key:"pickTimeToolRef",ref:T,class:"command",title:A.$t("trading.derivative.pickTimeTool"),onClick:p,onContextmenu:V},ei,40,Gt))}};const ii=B("div",{class:"triangle-shadow"},null,-1),ni=B("div",{class:"triangle"},null,-1),ri={class:"input"},si={class:"color"},oi=["onClick"],ai={__name:"LineContext",props:["enable","title","color"],emits:["update:title","update:color"],setup(D,{emit:$}){const x=D,m=$,t=N(null),r=N(["#F44336","#FF9800","#FFEB3B","#4CAF50","#009688","#00BCD4","#2196F3","#673AB7","#9C27B0","#E91E63"]);ve(()=>x.enable,h=>{h&&vt().then(()=>t.value.instance.focus())});function T({value:h}){m("update:title",h)}function y(h){m("update:color",h)}function O(){m("deleteAllLine")}function f(h){h.stopPropagation()}return(h,p)=>{const V=Ke("DxButton");return H(),J("div",{class:"line-context",onClick:f},[ii,ni,B("div",ri,[ee(tt(Ct),{ref_key:"titleRef",ref:t,value:x.title,"show-clear-button":!0,"input-attr":{style:`color:${x.color}`},onValueChanged:T},null,8,["value","input-attr"]),ee(V,{icon:"trash",type:"danger",onClick:p[0]||(p[0]=F=>O())})]),B("div",si,[(H(!0),J(Me,null,Ve(r.value,(F,Z)=>(H(),J("div",{class:"color-swatch",style:ht({background:F,boxShadow:`0 0 4px ${F}`}),key:Z,onClick:W=>y(F)},null,12,oi))),128))])])}}},ci=["title"],li=B("i",{class:"far fa-horizontal-rule"},null,-1),pi={__name:"LineTool",props:["priceSeries"],emits:["hideContext"],setup(D,{expose:$,emit:x}){const m=me(),t=D,r=x,T=N(null),y=N(!1),O=ce(()=>m.state.tradingDerivative.tools.line),f=N(""),h=N("#F44336");let p=[];$({isSelected:V,hide:F,draw:A,drag:i}),ve(O,c=>{c&&d(c)});function V(){return T.value.classList.contains("selected")}function F(c){y.value=c}function Z(c){r("hideContext");const S=c.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(v=>v.classList.remove("selected")),S||c.target.classList.add("selected")}function W(c){const S=y.value;r("hideContext"),y.value=!S}function A({price:c}){const S="line",v=p.length;if(p=p.filter(_=>{const C=_.options(),e=C.type=c===+C.price;return e&&(t.priceSeries.removePriceLine(_),m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:S,point:c})),!e}),p.length===v){const _=h.value,C=f.value,e={lineType:S,price:c,color:_,title:C,lineWidth:1,lineStyle:1,draggable:!0};p.push(t.priceSeries.createPriceLine(e)),m.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:S,points:[c],data:[{color:_,title:C}]})}T.value.classList.remove("selected")}function d(c){g(!1),s(c)}function s(c){const v={lineType:"line",lineWidth:1,lineStyle:1,draggable:!0};Object.entries(c).forEach(([_,{color:C,title:e}])=>{v.price=+_,v.color=C,v.title=e,p.push(t.priceSeries.createPriceLine(v))})}function g(c=!0){p.length>0&&(c&&m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line"}),p.forEach(S=>t.priceSeries.removePriceLine(S)),p=[])}function i({lineOptions:c,oldPrice:S,newPrice:v}){m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line",point:S});const _=c.color,C=c.title;m.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"line",points:[v],data:[{color:_,title:C}]}),T.value.classList.remove("selected")}return(c,S)=>(H(),J("div",{ref_key:"lineToolRef",ref:T,class:"context command",title:c.$t("trading.derivative.lineTool"),onClick:Z,onContextmenu:W},[li,Te(ee(ai,{class:"contextmenu",enable:y.value,title:f.value,"onUpdate:title":S[0]||(S[0]=v=>f.value=v),color:h.value,"onUpdate:color":S[1]||(S[1]=v=>h.value=v),onDeleteAllLine:g},null,8,["enable","title","color"]),[[_e,y.value]])],40,ci))}},di=["title"],ui=B("i",{class:"far fa-grip-lines-vertical"},null,-1),fi=[ui],mi={__name:"TimeRangeTool",props:["timeRangeSeries","timeToIndex","indexToTime"],emits:["hideContext"],setup(D,{expose:$,emit:x}){const m=me(),t=fe("mf"),r=D,T=x,y=N(null),O=ce(()=>m.state.tradingDerivative.tools.timeRange);let f=[];$({isSelected:h,draw:F}),ve(O,d=>{d&&Z(d)});function h(){return y.value.classList.contains("selected")}function p(d){T("hideContext");const s=d.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(g=>g.classList.remove("selected")),s||d.target.classList.add("selected")}function V(d){A(),d.target.classList.remove("selected")}function F({time:d}){let s={isRemove:!1,name:"timeRange",points:[],data:[]},g={time:d,value:1};switch(f.length){case 0:g.color="OrangeRed",f[0]=g,s.points.push(0),s.data.push(d);break;case 1:g.color="lime",f[1]=g,s.points.push(1),s.data.push(d),y.value.classList.remove("selected");break;default:const i=r.timeToIndex(f[0].time),c=r.timeToIndex(f[1].time),v=r.timeToIndex(d)+(c-i),_=r.indexToTime(v);g.color="OrangeRed",f[0]=t.cloneDeep(g),s.points.push(0),s.data.push(d),g.time=_,g.color="lime",f[1]=g,s.points.push(1),s.data.push(_),y.value.classList.remove("selected");break}r.timeRangeSeries.setData(f),m.dispatch("tradingDerivative/drawTools",s)}function Z(d){A(!1),W(d)}function W(d){let s,g;if(d.length===2)s=d[0],g=d[1];else if(d.length===3){const c=r.timeToIndex(d[0]),S=r.timeToIndex(d[1]),_=r.timeToIndex(d[2])+(S-c);s=d[2],g=r.indexToTime(_)}else return!1;let i=[{time:s,value:1,color:"OrangeRed"},{time:g,value:1,color:"lime"}];f=i,r.timeRangeSeries.setData(i)}function A(d=!0){d&&m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"timeRange"}),r.timeRangeSeries.setData([]),f=[]}return(d,s)=>(H(),J("div",{ref_key:"timeRangeToolRef",ref:y,class:"command",title:d.$t("trading.derivative.timeRangeTool"),onClick:p,onContextmenu:V},fi,40,di))}},vi=["title"],hi=B("i",{class:"far fa-line-height"},null,-1),gi=[hi],Si={__name:"TargetTool",props:["priceSeries"],emits:["hideContext"],setup(D,{expose:$,emit:x}){const m=me(),t=fe("mf"),r=D,T=x,y=N(null),O=ce(()=>m.state.tradingDerivative.tools.target);let f={};$({isSelected:h,draw:F,drag:d}),ve(O,s=>{s&&Z(s)});function h(){return y.value.classList.contains("selected")}function p(s){T("hideContext");const g=s.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),g||(s.target.classList.add("selected"),A())}function V(s){A(),s.target.classList.remove("selected")}function F({price:s}){const g="target";let i={lineType:g,price:s,lineWidth:1,lineStyle:1,draggable:!0},c={isRemove:!1,name:g,points:[],data:[s]};if(t.isSet(f.A)){const S=+f.A.options().price,v=s-S;i.point="B",i.title=t.fmtNum(v),i.color="#F44336",f[i.point]=r.priceSeries.createPriceLine(i),c.points.push(i.point),i.point="X",i.price=t.fmtNum(S-.5*v),i.title=t.fmtNum(-.5*v),i.color="#2196F3",f[i.point]=r.priceSeries.createPriceLine(i),i.point="Y",i.price=t.fmtNum(S-v),i.title=t.fmtNum(-v),i.color="#673AB7",f[i.point]=r.priceSeries.createPriceLine(i),i.point="Z",i.price=t.fmtNum(S-2*v),i.title=t.fmtNum(-2*v),i.color="#9C27B0",f[i.point]=r.priceSeries.createPriceLine(i),i.point="W",i.price=t.fmtNum(S-4*v),i.title=t.fmtNum(-4*v),i.color="#E91E63",f[i.point]=r.priceSeries.createPriceLine(i),y.value.classList.remove("selected")}else i.point="A",i.title="0",i.color="#FF9800",f[i.point]=r.priceSeries.createPriceLine(i),c.points.push(i.point);m.dispatch("tradingDerivative/drawTools",c)}function Z(s){A(!1),W(s)}function W(s){let i={lineType:"target",lineWidth:1,lineStyle:1,draggable:!0};const c=s.A,S=s.B,v=S-c;i.point="A",i.price=c,i.title="0",i.color="#FF9800",f[i.point]=r.priceSeries.createPriceLine(i),i.point="B",i.price=S,i.title=t.fmtNum(v),i.color="#F44336",f[i.point]=r.priceSeries.createPriceLine(i),i.point="X",i.price=t.fmtNum(c-.5*v),i.title=t.fmtNum(-.5*v),i.color="#2196F3",f[i.point]=r.priceSeries.createPriceLine(i),i.point="Y",i.price=t.fmtNum(c-v),i.title=t.fmtNum(-v),i.color="#673AB7",f[i.point]=r.priceSeries.createPriceLine(i),i.point="Z",i.price=t.fmtNum(c-2*v),i.title=t.fmtNum(-2*v),i.color="#9C27B0",f[i.point]=r.priceSeries.createPriceLine(i),i.point="W",i.price=t.fmtNum(c-4*v),i.title=t.fmtNum(-4*v),i.color="#E91E63",f[i.point]=r.priceSeries.createPriceLine(i)}function A(s=!0){s&&m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"target"}),t.isSet(f.A)&&(r.priceSeries.removePriceLine(f.A),t.isSet(f.B)&&(r.priceSeries.removePriceLine(f.B),r.priceSeries.removePriceLine(f.X),r.priceSeries.removePriceLine(f.Y),r.priceSeries.removePriceLine(f.Z),r.priceSeries.removePriceLine(f.W))),f={}}function d({lineOptions:s,newPrice:g}){if(t.isSet(f.B)){let i={isRemove:!1,name:"target",points:[],data:[]},c,S,v=+f.A.options().price,_=+f.B.options().price,C=_-v;if(c="A",s.point==="A")C=+f.B.options().title,_=v+C;else if(s.point!=="B"){let e=0;switch(s.point){case"X":e=1.5;break;case"Y":e=2;break;case"Z":e=3;break;case"W":e=5;break}C=t.fmtNum((_-g)/e),v=_-C,S={price:v},f[c].applyOptions(S)}i.points.push(c),i.data.push(v),c="B",S={price:_,title:t.fmtNum(C)},s.point===c&&delete S.price,f[c].applyOptions(S),i.points.push(c),i.data.push(_),c="X",S={price:t.fmtNum(v-.5*C),title:t.fmtNum(-.5*C)},s.point===c&&delete S.price,f[c].applyOptions(S),c="Y",S={price:t.fmtNum(v-C),title:t.fmtNum(-C)},s.point===c&&delete S.price,f[c].applyOptions(S),c="Z",S={price:t.fmtNum(v-2*C),title:t.fmtNum(-2*C)},s.point===c&&delete S.price,f[c].applyOptions(S),c="W",S={price:t.fmtNum(v-4*C),title:t.fmtNum(-4*C)},s.point===c&&delete S.price,f[c].applyOptions(S),m.dispatch("tradingDerivative/drawTools",i)}}return(s,g)=>(H(),J("div",{ref_key:"targetToolRef",ref:y,class:"command",title:s.$t("trading.derivative.targetTool"),onClick:p,onContextmenu:V},gi,40,vi))}},yi=["title"],Ue=3,Qe=2,Ti={__name:"OrderTool",props:["position","prices","priceSeries","inSession","TIME"],emits:["getTools","showEntry","showTpSl","orderChanged","hideContext"],setup(D,{expose:$,emit:x}){const m=me(),{t}=Oe(),r=fe("mf"),T=D,y=x,O=N(null),f=N(!1),h=ce(()=>m.state.tradingDerivative.tools.order);let p={side:0,entry:{},tp:{},sl:{}},V=!1;$({show:Z,entry:W,tpsl:A,cancel:d,cancelWithoutClose:s,scan:g,drag:_}),ve(h,e=>{e&&c(e)});function F(){return r.isSet(p.entry.line)||r.isSet(p.tp.line)}function Z({price:e}){if(e&&T.inSession()){const u=G(ke(new Date,7));if(r.isSet(p.entry.line))!r.isSet(p.tp.line)&&T.position&&u>T.TIME.ATO&&u<T.TIME.ATC&&y("showTpSl",{side:T.position});else{let a=null,n=0;T.position?(u<T.TIME.ATO?a="ATO":u>T.TIME.ATC&&(a="ATC"),a&&(p.entry.price=a,n=-T.position)):u>T.TIME.ATO&&u<T.TIME.ATC&&(a=e,n=a>=T.prices.at(-1).value?1:-1,p.side=n,p.entry.price=a),n&&y("showEntry",{side:n,price:a})}}}function W(){if(T.inSession()){const e=G(ke(new Date,7));e<T.TIME.ATO?qe(t("trading.derivative.atoOrder"),t("titles.confirm")).then(a=>{a&&m.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(n=>{n.isOk?se.success(t("trading.derivative.atoOrderSuccess")):C(n.message)})}):e>T.TIME.ATC?qe(t("trading.derivative.atcOrder"),t("titles.confirm")).then(a=>{a&&m.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(n=>{n.isOk?se.success(t("trading.derivative.atcOrderSuccess")):C(n.message)})}):m.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"new",side:p.side,price:p.entry.price}}).then(u=>{u.isOk?(i(["entry"]),se.success(t("trading.derivative.newEntrySuccess"))):C(u.message)})}}function A(){p.tp.price=p.entry.price+p.side*Ue,p.sl.price=p.entry.price-p.side*Qe,m.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:p.tp.price},slData:{cmd:"new",price:p.sl.price}}).then(e=>{e.isOk?(p.entry.line.applyOptions({draggable:!1}),i(["entry","tp","sl"]),se.success(t("trading.derivative.newTpSlSuccess"))):C(e.message)})}function d(){r.isSet(p.entry.line)?r.isSet(p.tp.line)?m.dispatch("tradingDerivative/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(e=>{e.isOk?(v(["entry","tp","sl"]),se.success(t("trading.derivative.exitSuccess"))):C(e.message)}):m.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"delete"}}).then(e=>{e.isOk?(v(["entry"]),se.success(t("trading.derivative.deleteEntrySuccess"))):C(e.message)}):y("getTools")}function s(){if(T.inSession()&&T.position){const e=G(ke(new Date,7));e>T.TIME.ATC-5*60&&(f.value=!0,e>T.TIME.ATC-15&&r.isSet(p.tp.line)&&m.dispatch("tradingDerivative/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(u=>{u.isOk?(v(["entry","tp","sl"]),se.success(t("trading.derivative.autoCancelTpSlSuccess"))):C(u.message)}))}}function g(e){if(r.isSet(p.entry.line)){const u=p.side>0;r.isSet(p.tp.line)?(r.cmp(e,u,p.tp.price,!0)&&(V||(V=!0,m.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"delete"}}).then(a=>{a.isOk?(v(["entry","tp","sl"]),se.success(t("trading.derivative.deleteTpSuccess"))):C(a.message),V=!1}))),r.cmp(e,!u,p.sl.price,!0)&&(V||(V=!0,m.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"cancel"}}).then(a=>{a.isOk?(v(["entry","tp","sl"]),se.success(t("trading.derivative.deleteSlSuccess"))):C(a.message),V=!1})))):r.cmp(e,u,p.entry.price,!0)&&(V||(V=!0,setTimeout(()=>{p.tp.price=p.entry.price+p.side*Ue,p.sl.price=p.entry.price-p.side*Qe,m.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:p.tp.price},slData:{cmd:"new",price:p.sl.price}}).then(a=>{a.isOk?(p.entry.line.applyOptions({draggable:!1}),i(["entry","tp","sl"]),se.success(t("trading.derivative.autoNewTpSlSuccess"))):C(a.message),V=!1})},1e3)))}}function i(e){const u="order";let a={isRemove:!1,name:u,points:[],data:[]},n,k;e.forEach(l=>{const I=p.entry.price,R=p.tp.price,E=p.sl.price;switch(l){case"entry":n="yellow",k=p.side>0?"LONG":"SHORT";break;case"tp":n="lime",k=r.fmtNum(R-I,1,!0);break;case"sl":n="red",k=r.fmtNum(E-I,1,!0);break}if(a.points.push(l),r.isSet(p[l].line))p[l].line.applyOptions({price:p[l].price,title:k}),a.data.push(p[l].line.options());else{const b={lineType:u,kind:l,side:p.side,price:p[l].price,color:n,lineWidth:1,lineStyle:0,title:k,draggable:!0};p[l].line=T.priceSeries.createPriceLine(b),a.data.push(b)}}),m.dispatch("tradingDerivative/drawTools",a),y("orderChanged",F())}function c(e){v(["entry","tp","sl"],!1),S(e),y("orderChanged",F())}function S(e){Object.entries(e).forEach(([u,a])=>{u==="entry"&&(p.side=a.side),p[u].price=a.price,p[u].line=T.priceSeries.createPriceLine(a)})}function v(e,u=!0){u&&m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"order"}),e.forEach(a=>{r.isSet(p[a].line)&&(T.priceSeries.removePriceLine(p[a].line),delete p[a].line)}),y("orderChanged",F())}function _({line:e,lineOptions:u,oldPrice:a,newPrice:n}){if(n!==a){let k=!1;u.kind==="entry"?T.position||(k=!0,p[u.kind].price=n,m.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"change",price:p.entry.price}}).then(l=>{l.isOk?(i([u.kind]),se.success(t("trading.derivative.changeEntrySuccess"))):(e.applyOptions({price:a}),C(l.message))})):(k=!0,p[u.kind].price=n,u.kind==="tp"?m.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"change",price:p.tp.price}}).then(l=>{l.isOk?(i([u.kind]),se.success(t("trading.derivative.changeTpSuccess"))):(e.applyOptions({price:a}),C(l.message))}):m.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"change",price:p.sl.price}}).then(l=>{l.isOk?(i([u.kind]),se.success(t("trading.derivative.changeSlSuccess"))):(e.applyOptions({price:a}),C(l.message))})),k||(e.applyOptions({price:a}),se.show(t("trading.derivative.noChangeOrderLine")))}}function C(e){e||(e="unknown"),se.error(t(`trading.derivative.${e}`))}return(e,u)=>(H(),J("div",{ref_key:"orderToolRef",ref:O,class:"cancel-order command",title:e.$t("trading.derivative.orderTool"),onClick:d},[B("i",{class:ae(["far fa-trash-alt",{blink:f.value}])},null,2)],8,yi))}};const xi=["title"],Ci=["title"],ki=["title"],_i=["title"],bi="wss://tradestation.fireant.vn/quote?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",wi="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",Oi={__name:"Chart",setup(D,{expose:$}){const x=me(),m=Tt(),{t}=Oe(),r=fe("devices"),T=fe("mf"),y=fe("filters"),O=N(null),f=N(null),h=N(null),p=N(null),V=N(null),F=N(null),Z=N(null),W=N(null),A=N(null),d=N(null),s=N(null),g=N(null),i=N(null),c=N(null),S=N(null),v={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.25,bottom:.25}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:1e3,minBarSpacing:.01,barSpacing:.05}},_=Le(new Date,"yyyy-MM-dd"),C={START:G(new Date(`${_}T08:45:00Z`)),ATO:G(new Date(`${_}T09:00:00Z`)),ATC:G(new Date(`${_}T14:30:00Z`)),END:G(new Date(`${_}T14:45:00Z`))};let e={chart:{},whitespaces:[],crosshair:{},interval1:null,interval30:null,websocket:null,socketStop:!1,vpsUpdatedAt:bt(new Date,61)};const u=gt({prices:[],series:{},chartDate:m.query.date??_,clock:Le(new Date,"HH:mm:ss"),isSocketWarning:!1,hasOrderLine:!1,TIME:C}),a=ce(()=>x.state.tradingDerivative.status),n=ce(()=>x.state.tradingDerivative.config),k=ce(()=>x.state.tradingDerivative.isLoading),l=ce(()=>a.value.position||a.value.pending||u.hasOrderLine);e.interval1=setInterval(()=>{i.value&&i.value.cancelWithoutClose(),u.clock=Le(new Date,"HH:mm:ss")},1e3),e.interval30=setInterval(()=>{De()?(He(),n.value.autoRefresh&&W.value.refresh(!0)):clearInterval(e.interval30)},3e4),ot(),We(()=>{I(),new ResizeObserver(re).observe(O.value),document.addEventListener("keydown",te)}),Ge(()=>{R(),document.removeEventListener("keydown",te),clearInterval(e.interval1),clearInterval(e.interval30),oe(),e.socketStop=!0}),ve(()=>x.state.tradingDerivative.chartData,ie),$({connectSocket:Y});function I(){e.chart=kt(f.value,v),e.chart.subscribeCrosshairMove(X),e.chart.subscribeCustomPriceLineDragged(U),u.series.whitespace=e.chart.addHistogramSeries({priceScaleId:"whitespace",scaleMargins:{top:0,bottom:0},color:"#808080",lastValueVisible:!1,priceLineVisible:!1}),u.series.timeRange=e.chart.addHistogramSeries({priceScaleId:"timeRange",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),u.series.pickTime=e.chart.addHistogramSeries({priceScaleId:"pickTime",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),u.series.timeMark=e.chart.addHistogramSeries({priceScaleId:"timeMark",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),u.series.price=e.chart.addLineSeries({color:"#F5F5F5",priceFormat:{minMove:.1}})}function R(){e.chart&&(e.chart.remove(),e.chart=null)}function E(o){ue(),ge(!1),g.value.isSelected()?g.value.draw({time:e.crosshair.time}):W.value.isSelected()?W.value.draw({time:e.crosshair.time,price:Ee(e.crosshair.y)}):A.value.isSelected()?A.value.draw({time:e.crosshair.time}):Z.value.isSelected()?Z.value.draw({price:Ee(e.crosshair.y)}):s.value.isSelected()?s.value.draw({time:e.crosshair.time}):d.value.isSelected()&&d.value.draw({price:Ee(e.crosshair.y)})}function b(o){ge(!0),o.preventDefault()}function P(o){o.stopPropagation()}function M(o){o.preventDefault(),o.stopPropagation()}function X(o){if(o.time){let L=o.seriesPrices.get(u.series.price);e.crosshair.time=o.time,e.crosshair.price=L}else r.phone||(e.crosshair.time=null,e.crosshair.price=null);o.point!==void 0&&(e.crosshair.x=o.point.x,e.crosshair.y=o.point.y)}function U(o){let L=o.customPriceLine,w=L.options();w.price=T.fmtNum(w.price);const z=+o.fromPriceString,K=w.price;switch(w.lineType){case"order":i.value.drag({line:L,lineOptions:w,oldPrice:z,newPrice:K});break;case"line":Z.value.drag({lineOptions:w,oldPrice:z,newPrice:K});break;case"target":d.value.drag({lineOptions:w,newPrice:K});break;case"pattern":W.value.drag({lineOptions:w});break}}function re(){O.value&&(e.chart.resize(O.value.offsetWidth,O.value.offsetHeight),O.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function te(o){if(o.ctrlKey)switch(o.keyCode){case 219:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing-.01});break;case 221:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing+.01});break}if(o.altKey)switch(o.keyCode){case 219:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()-50);break;case 221:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()+50);break}}function ie(o){u.chartDate===_&&De()||(o.price.length>0&&(e.whitespaces=Q(e.whitespaces,j(u.chartDate))),u.series.whitespace.setData(e.whitespaces),u.prices=Q(u.prices,o.price),u.series.price.setData(u.prices))}function ne(o,L=null){const w=L??n.value.source;let z=[];o.forEach(K=>{let pe,de;w==="FireAnt"?(pe=G(ke(new Date(K.date),7)),de=K.price):(pe=G(new Date(`${_}T${K.time}Z`)),de=K.lastPrice),z.push({time:pe,value:de})}),z.length>1?(u.prices=Q(u.prices,z),u.series.price.setData(u.prices)):(u.prices.push(z[0]),u.series.price.update(z[0]))}function j(o){const L=G(new Date(`${o}T09:00:00Z`)),w=G(new Date(`${o}T11:30:00Z`)),z=G(new Date(`${o}T13:00:00Z`)),K=G(new Date(`${o}T14:30:00Z`)),pe=G(new Date(`${o}T14:00:00Z`));let de=[];for(let Se=L;Se<=K;Se++){if(Se>w&&Se<z)continue;let Xe={time:Se};(Se===pe||Se===K)&&(Xe.value=1),de.push(Xe)}return de}function Q(o,L){return Array.from(new Map([...o,...L].sort((w,z)=>w.time-z.time).map(w=>[w.time,w])).values())}async function Y(){if(De()){await oe();const o=n.value.source==="FireAnt",L=o?bi:wi;e.websocket=new WebSocket(L),e.websocket.onclose=w=>{e.socketStop||(u.isSocketWarning=!0,Y())},o?Pe():(q(),he())}}async function oe(){e.websocket&&e.websocket.readyState===WebSocket.OPEN&&(e.websocket.close(),await new Promise(o=>{const L=setInterval(()=>{(!e.websocket||e.websocket.readyState===WebSocket.CLOSED)&&(e.websocket=null,clearInterval(L),o())},100)}))}function Pe(){x.dispatch("tradingDerivative/setLoading",!0),e.websocket.onopen=o=>{if(e.websocket.readyState===WebSocket.OPEN){let L='{"protocol":"json","version":1}';e.websocket.send(L),L='{"arguments":["VN30F1M"],"invocationId":"0","target":"SubscribeTrades","type":1}',e.websocket.send(L)}},e.websocket.onmessage=o=>{u.isSocketWarning=!1,le(o.data).forEach(w=>{if(!w)return!1;w.type===3?(w.result[0].date.slice(0,10)===_&&(Re(),e.whitespaces=Q(e.whitespaces,j(_)),u.series.whitespace.setData(e.whitespaces),ne(w.result)),x.dispatch("tradingDerivative/setLoading",!1)):w.type===1&&w.target==="UpdateTrades"&&w.arguments[0]==="VN30F1M"&&(console.log("FireAnt",w.arguments[1]),i.value.scan(w.arguments[1].at(-1).price),ne(w.arguments[1]))})}}function le(o){let L=[];return o.split("").forEach(w=>{const z=w.indexOf("{"),K=w.lastIndexOf("}");let pe=null;if(z!==-1&&K!==-1&&K>z){const de=w.substring(z,K+1);de!=="{}"&&(pe=JSON.parse(de))}L.push(pe)}),L}function he(){e.websocket.onopen=o=>{if(e.websocket.readyState===WebSocket.OPEN){const L={action:"join",list:n.value.vn30f1m},w=`42${JSON.stringify(["regs",JSON.stringify(L)])}`;e.websocket.send(w)}},e.websocket.onmessage=o=>{if(u.isSocketWarning=!1,o.data.substr(0,1)==="4"&&o.data.substr(1,1)==="2"){const L=JSON.parse(o.data.substr(2));if(L[0]==="stockps"){const w=L[1].data;w.id===3220&&(console.log("VPS",w),i.value.scan(w.lastPrice),ne([w]))}}}}function q(){St(new Date,new Date(e.vpsUpdatedAt))>60&&(fetch("https://bddatafeed.vps.com.vn/getpschartintraday/VN30F1M").then(o=>o.json()).then(o=>{console.log(o),ne(o,"VPS")}),e.vpsUpdatedAt=new Date)}function Ce(){W.value.refresh()}function Ye(o){W.value.load(o,{isSave:!0})}function ue(){F.value.hide(),g.value.hide(),Z.value.hide()}function ze(o){F.value.set(o)}function Ie(o){u.hasOrderLine=o}function ge(o){o?i.value.show({price:Ee(e.crosshair.y)}):(c.value.style.display="none",S.value.style.display="none")}function $e({side:o,price:L}){c.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-71?-71:1))+"px",c.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-61?-61:1))+"px",c.value.style.background=o>0?"green":"red",c.value.innerText=`${o>0?"LONG":"SHORT"} ${L}`,c.value.style.display="block"}function Ae({side:o}){S.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-61?-61:1))+"px",S.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-51?-51:1))+"px",S.value.style.background=o>0?"green":"red",S.value.style.display="block"}function be(){i.value.entry()}function we(){i.value.tpsl()}function Ne(){e.chart.timeScale().scrollToRealTime()}function De(){const o=G(ke(new Date,7));return n.value.openingMarket&&o>=C.START&&o<=C.END}function rt(){if(!u.chartDate)return!1;Be()}function st(){e.whitespaces=[],u.prices=[],Y(),Be()}function ot(){x.dispatch("tradingDerivative/initChart").then(()=>{Y(),!m.query.date&&n.value.lastOpeningDate&&(u.chartDate=n.value.lastOpeningDate),Be()})}function Be(){x.dispatch("tradingDerivative/getChartData",u.chartDate).then(o=>{o&&Re()})}function He(){x.dispatch("tradingDerivative/getStatus")}function Re(){x.dispatch("tradingDerivative/getTools")}function at(){x.dispatch("tradingDerivative/getAccountInfo").then(o=>{let L="";L+='<div style="width: 200px;">',L+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.nav")}</div><div>: ${y.currency(o.nav)}</div></div>`,L+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.maxVol")}</div><div>: ${y.numberVnFormat(o.maxVol)}</div></div>`,L+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.vm")}</div><div>: ${y.currency(o.vm)}</div></div>`,L+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.fee")}</div><div>: ${y.currency(o.fee)}</div></div>`,L+="</div>",xt(L,t("trading.derivative.accountInfo"))})}function Ee(o){return T.fmtNum(u.series.price.coordinateToPrice(o))}function Fe(o){let L=e.whitespaces.findIndex(w=>w.time===o);if(L===-1){const w=Le(new Date(o*1e3),"yyyy-MM-dd"),z=G(new Date(`${w}T11:30:00Z`)),K=G(new Date(`${w}T13:00:00Z`)),pe=G(new Date(`${w}T14:30:00Z`));o>z&&o<K?o=z:o>pe&&(o=pe),L=e.whitespaces.findIndex(de=>de.time===o)}return L}function Je(o){return o<e.whitespaces.length?e.whitespaces[o].time:!1}return(o,L)=>(H(),J("div",{class:"derivative-chart",ref_key:"chartContainerRef",ref:O,onClick:E,onContextmenu:b},[B("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:f},[B("div",{class:"area data-area",onClick:P,onContextmenu:M},[B("div",{ref_key:"connectionRef",ref:h,class:ae(["command",{yellow:a.value.pending,red:n.value.volInValid}]),title:o.$t("trading.derivative.connection"),onClick:He},[B("i",{class:ae(["far",{"fa-link-simple":a.value.connection,"fa-link-simple-slash":!a.value.connection,blink:u.isSocketWarning}])},null,2)],10,xi),B("div",{class:ae(["command status",{green:a.value.position>0,red:a.value.position<0}]),title:o.$t("trading.derivative.position"),onClick:at},ye(a.value.position),11,Ci),B("div",{class:"command clock",onClick:Y},ye(u.clock),1),Te(B("input",{type:"date",class:"chart-date command",title:o.$t("trading.derivative.date"),"onUpdate:modelValue":L[0]||(L[0]=w=>u.chartDate=w),onChange:rt},null,40,ki),[[yt,u.chartDate]]),B("div",{ref_key:"reloadToolRef",ref:p,class:"command",title:o.$t("trading.derivative.reload"),onClick:st,onContextmenu:Re},[B("i",{class:ae(["far fa-sync-alt",{"fa-spin":k.value}])},null,2)],40,_i)],32),B("div",{class:"area tool-area",onClick:P,onContextmenu:M},[ee(Dt,{chartContainerRef:O.value},null,8,["chartContainerRef"]),ee(Lt,{ref_key:"tradingviewRef",ref:V,vpsUser:n.value.vpsUser,vpsSession:n.value.vpsSession,chartContainerRef:O.value},null,8,["vpsUser","vpsSession","chartContainerRef"]),ee(Nt,{ref_key:"progressToolRef",ref:F,position:a.value.position,onRefreshPattern:Ce,onHideContext:ue},null,8,["position"]),ee(Xt,{ref_key:"scanToolRef",ref:g,prices:u.prices,timeToIndex:Fe,onScaned:Ye,onRemovePattern:L[1]||(L[1]=()=>W.value.remove()),onHideContext:ue},null,8,["prices"]),ee(Qt,{ref_key:"patternToolRef",ref:W,prices:u.prices,priceSeries:u.series.price,timeMarkSeries:u.series.timeMark,pickTimeToolRef:A.value,timeToIndex:Fe,indexToTime:Je,onSetProgress:ze,onHideContext:ue},null,8,["prices","priceSeries","timeMarkSeries","pickTimeToolRef"]),ee(ti,{ref_key:"pickTimeToolRef",ref:A,pickTimeSeries:u.series.pickTime,onRefreshPattern:Ce,onHideContext:ue},null,8,["pickTimeSeries"]),ee(pi,{ref_key:"lineToolRef",ref:Z,priceSeries:u.series.price,onHideContext:ue},null,8,["priceSeries"]),ee(mi,{ref_key:"timeRangeToolRef",ref:s,timeRangeSeries:u.series.timeRange,timeToIndex:Fe,indexToTime:Je,onHideContext:ue},null,8,["timeRangeSeries"]),ee(Si,{ref_key:"targetToolRef",ref:d,priceSeries:u.series.price,onHideContext:ue},null,8,["priceSeries"]),Te(ee(Ti,{ref_key:"orderToolRef",ref:i,position:a.value.position,prices:u.prices,priceSeries:u.series.price,inSession:De,TIME:u.TIME,onGetTools:Re,onShowEntry:$e,onShowTpSl:Ae,onOrderChanged:Ie,onHideContext:ue},null,8,["position","prices","priceSeries","TIME"]),[[_e,l.value]])],32),B("div",null,[B("div",{ref_key:"entryOrderRef",ref:c,class:"order-button entry",onClick:be}," Entry ",512),B("div",{ref_key:"tpslOrderRef",ref:S,class:"order-button tpsl",onClick:we}," TP/SL ",512),B("div",{class:"chart-top command far fa-angle-double-right",onClick:Ne})])],512)],544))}};export{Oi as default};
