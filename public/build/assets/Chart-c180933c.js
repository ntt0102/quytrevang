import{z as vt,A as ht,B as gt,r as B,y as _e,C as Ie,o as Y,b as G,d as M,E as ae,c as le,G as xe,H as we,I as St,J as yt,K as Tt,m as st,p as ze,f as Je,e as ee,F as Ye,L as He,t as Te,h as me,u as Ae,k as fe,M as xt,N as Ct,O as et,Q as rt,g as ot,w as ve,R as kt,S as _t,T as tt,x as oe,l as Pe,a as wt,U as We,V as bt,j as Dt,W as Rt}from"./app-d97153e0.js";import{_ as Et}from"./text-box-fdbaf5a4.js";import{g as Q}from"./getUnixTime-7ef0af73.js";import{c as Lt}from"./lightweight-charts.esm.development-03366bac.js";function at(E,N,x){return vt((x==null?void 0:x.in)||E,+ht(E)+N)}function ke(E,N,x){return at(E,N*gt,x)}function Ot(E,N,x){return at(E,N*1e3,x)}function Ze(E,N,x){return Ot(E,-N,x)}const $t=["title"],Pt={__name:"FullscreenTool",props:["chartContainerRef"],setup(E,{expose:N}){const x=E,p=B(!1);N({setFullscreen:y}),_e(()=>{document.addEventListener("fullscreenchange",r),window.addEventListener("keydown",I)}),Ie(()=>{document.removeEventListener("fullscreenchange",r),window.removeEventListener("keydown",I)});function e(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function r(){x.chartContainerRef&&(document.fullscreenElement?(p.value=!0,x.chartContainerRef.classList.add("fullscreen"),y()):(p.value=!1,x.chartContainerRef.classList.remove("fullscreen"),k()))}function y(){document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"}function k(){document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"}function I(a){a.key==="F11"&&(e(),a.preventDefault())}return(a,m)=>(Y(),G("div",{class:"command",title:a.$t("trading.derivative.fullscreenTool"),onClick:e},[M("i",{class:ae(["far",{"fa-compress":p.value,"fa-expand":!p.value}])},null,2)],8,$t))}},It=["title"],At=["src"],Nt={__name:"TradingviewTool",props:["vpsUser","vpsSession","chartContainerRef"],setup(E){const N=E,x=B(null),p=B(!1),e=le(()=>`https://chart.vps.com.vn/tv/?u=${N.vpsUser}&s=${N.vpsSession}&symbol=VN30F1M&resolution=1&lang=vi`);_e(()=>{window.addEventListener("keydown",I)}),Ie(()=>{window.removeEventListener("keydown",I)});function r(a){y(),k(),a.stopPropagation()}function y(){p.value=!p.value}function k(){if(N.chartContainerRef&&x.value){const{offsetWidth:a,offsetHeight:m}=N.chartContainerRef,{top:h,left:O}=x.value.getBoundingClientRect();x.value.style.top=`${h-2}px`,x.value.style.left=`${O+32}px`,x.value.style.width=`${a-34}px`,x.value.style.height=`${m}px`}}function I(a){a.key==="F1"&&(y(),k(),a.preventDefault())}return(a,m)=>(Y(),G("div",{class:"tradingview command far fa-chart-candlestick",title:a.$t("trading.derivative.tradingviewTool"),onClick:r},[xe(M("iframe",{ref_key:"tradingviewRef",ref:x,class:"chart",src:e.value},null,8,At),[[we,p.value]])],8,It))}};const Bt=M("div",{class:"triangle-shadow"},null,-1),Ft=M("div",{class:"triangle"},null,-1),Xe={__name:"CoreContext",setup(E){function N(x){x.stopPropagation()}return(x,p)=>(Y(),G("div",{class:"core-context",onClick:N},[Bt,Ft,St(x.$slots,"default")]))}};const Mt={__name:"ProgressContext",props:["progress","chartHeightEnough"],emits:["refreshPattern"],setup(E,{emit:N}){const x=N,p=B([]);_e(()=>{e()});function e(){yt(Object.assign({"../../../../../lang/vi/derivative.js":()=>Tt(()=>import("./derivative-0a1a41d1.js"),[])}),`../../../../../lang/${window.lang}/derivative.js`).then(y=>{p.value=y.default||[]})}function r(){x("refreshPattern")}return(y,k)=>{const I=st("DxButton");return Y(),ze(Xe,{class:"pattern-context"},{default:Je(()=>[ee(I,{icon:"refresh",type:"success",text:y.$t("trading.derivative.progressContext.refreshPattern"),onClick:r},null,8,["text"]),M("div",{class:ae(["steps",{portrait:E.chartHeightEnough}])},[(Y(!0),G(Ye,null,He(p.value,(a,m)=>(Y(),G("div",{key:m,class:ae(["step",[E.progress.step&&E.progress.step===m+1?E.progress.result?"success":"fail":""]])},[M("div",{class:ae(["name",[E.progress.steps?E.progress.steps[m].every(Boolean)?"success":"fail":""]])},Te(m+1)+". "+Te(a.name),3),M("div",null,[(Y(!0),G(Ye,null,He(a.conds,(h,O)=>(Y(),G("div",{key:O,class:ae(["condition",[E.progress.steps?E.progress.steps[m][O]?"success":"fail":""]])},Te(O+1)+". "+Te(h),3))),128))])],2))),128))],2)]),_:1})}}},Vt=["title"],Wt={__name:"ProgressTool",props:["chartHeightEnough"],emits:["refreshPattern","hideContext"],setup(E,{expose:N,emit:x}){const p=me(),{t:e}=Ae(),r=fe("mf"),y=x,k=B({}),I=B(!1),a=le(()=>p.state.tradingDerivative.config.autoRefresh);N({hide:h,set:O}),_e(()=>{window.addEventListener("keydown",S)}),Ie(()=>{window.removeEventListener("keydown",S)});function m(){const s=I.value;y("hideContext"),I.value=!s}function h(s=!1){I.value=s}function O(s){a.value&&Z(s,k.value),k.value=s}function V(){y("refreshPattern")}function W(){p.dispatch("tradingDerivative/setAutoRefresh",!a.value)}function Z(s,f){if(r.isSet(s)&&(s.step!==f.step||s.step===f.step&&s.result!==f.result)){let t="";s.result?[2,4].includes(s.step)?t=e("trading.derivative.progressOrder",s):t=e("trading.derivative.progressSuccess",s):t=e("trading.derivative.progressFail",s),A(t)}}function A(s){const f=new SpeechSynthesisUtterance(s);f.lang="vi-VN",speechSynthesis.speak(f)}function S(s){s.key==="F2"&&(m(),s.preventDefault())}return(s,f)=>(Y(),G("div",{class:ae(["context command",{green:k.value.result===!0,red:k.value.result===!1}]),title:s.$t("trading.derivative.progressTool"),onClick:m,onContextmenu:W},[M("i",{class:ae(["far",{"fa-badge-check":!k.value.step,[`fa-circle-${k.value.step}`]:k.value.step,blink:a.value}])},null,2),xe(ee(Mt,{class:"contextmenu",progress:k.value,chartHeightEnough:E.chartHeightEnough,onRefreshPattern:V},null,8,["progress","chartHeightEnough"]),[[we,I.value]])],42,Vt))}};var Ce={};const Zt=xt(Ct);/*!
 * devextreme-vue
 * Version: 22.2.12
 * Build date: Mon Apr 29 2024
 *
 * Copyright (c) 2012 - 2024 Developer Express Inc. ALL RIGHTS RESERVED
 *
 * This software may be modified and distributed under the terms
 * of the MIT license. See the LICENSE file in the root of the project for details.
 *
 * https://github.com/DevExpress/devextreme-vue
 */var Yt=et&&et.__importDefault||function(E){return E&&E.__esModule?E:{default:E}};Object.defineProperty(Ce,"__esModule",{value:!0});Ce.DxItem=Ce.DxButtonGroup=void 0;var Ht=Yt(Zt),zt=rt,Jt=rt,ct=zt.createComponent({props:{accessKey:String,activeStateEnabled:Boolean,buttonTemplate:{},disabled:Boolean,elementAttr:Object,focusStateEnabled:Boolean,height:[Function,Number,String],hint:String,hoverStateEnabled:Boolean,items:Array,keyExpr:[Function,String],onContentReady:Function,onDisposing:Function,onInitialized:Function,onItemClick:Function,onOptionChanged:Function,onSelectionChanged:Function,rtlEnabled:Boolean,selectedItemKeys:Array,selectedItems:Array,selectionMode:String,stylingMode:String,tabIndex:Number,visible:Boolean,width:[Function,Number,String]},emits:{"update:isActive":null,"update:hoveredElement":null,"update:accessKey":null,"update:activeStateEnabled":null,"update:buttonTemplate":null,"update:disabled":null,"update:elementAttr":null,"update:focusStateEnabled":null,"update:height":null,"update:hint":null,"update:hoverStateEnabled":null,"update:items":null,"update:keyExpr":null,"update:onContentReady":null,"update:onDisposing":null,"update:onInitialized":null,"update:onItemClick":null,"update:onOptionChanged":null,"update:onSelectionChanged":null,"update:rtlEnabled":null,"update:selectedItemKeys":null,"update:selectedItems":null,"update:selectionMode":null,"update:stylingMode":null,"update:tabIndex":null,"update:visible":null,"update:width":null},computed:{instance:function(){return this.$_instance}},beforeCreate:function(){this.$_WidgetClass=Ht.default,this.$_hasAsyncTemplate=!0,this.$_expectedChildren={item:{isCollectionItem:!0,optionName:"items"}}}});Ce.DxButtonGroup=ct;var je=Jt.createConfigurationComponent({emits:{"update:isActive":null,"update:hoveredElement":null,"update:disabled":null,"update:elementAttr":null,"update:hint":null,"update:html":null,"update:icon":null,"update:template":null,"update:text":null,"update:type":null,"update:visible":null},props:{disabled:Boolean,elementAttr:Object,hint:String,html:String,icon:String,template:{},text:String,type:String,visible:Boolean}});Ce.DxItem=je;je.$_optionName="items";je.$_isCollectionItem=!0;var Xt=Ce.default=ct;const jt={__name:"ScanContext",props:["modelValue"],emits:["update:modelValue"],setup(E,{emit:N}){const{t:x}=Ae(),p=[{icon:"chevrondoubleleft",side:"left",text:x("trading.derivative.scanContext.leftScan")},{icon:"chevrondoubleright",side:"right",text:x("trading.derivative.scanContext.rightScan")}],e=E,r=N;function y({itemData:{side:k}}){r("update:modelValue",k)}return(k,I)=>(Y(),ze(Xe,{class:"scan-context"},{default:Je(()=>[ee(ot(Xt),{items:p,"selected-item-keys":[e.modelValue],"key-expr":"side","styling-mode":"outlined",onItemClick:y},null,8,["selected-item-keys"])]),_:1}))}},Ut=["title"],qt={__name:"ScanTool",props:["prices","timeToIndex"],emits:["scaned","removePattern","hideContext"],setup(E,{expose:N,emit:x}){const p=fe("mf"),e=E,r=x,y=B(null),k=B(!1),I=B("left");N({isSelected:a,hide:m,draw:V});function a(){return y.value.classList.contains("selected")}function m(){k.value=!1}function h(S){r("hideContext");const s=S.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(f=>f.classList.remove("selected")),s||(S.target.classList.add("selected"),r("removePattern"))}function O(){const S=k.value;r("hideContext"),k.value=!S}function V({time:S}){const s=I.value==="left",f=S?e.prices.filter(l=>!p.cmp(l.time,s,S)):e.prices;let t=s?W(f):Z(f);p.isSet(t)&&r("scaned",A(t)),y.value.classList.remove("selected")}function W(S){let s,[f,t,l,v]=Array(4).fill({});for(let u=S.length-1;u>=0;u--){const $=S[u].value,C=S[u].time,g=e.timeToIndex(C);if(g===-1)break;if(u===S.length-1&&(l={index:g,time:C,price:$},[t,f,v]=Array(3).fill(null).map(()=>p.cloneDeep(l))),s===void 0){if($===l.price)continue;s=$>l.price}if(p.cmp($,s,t.price)&&(p.cmp(f.price,!s,l.price)?([l,t]=[t,f].map(o=>p.cloneDeep(o)),f={index:g,time:C,price:$},v=p.cloneDeep(f),s=!s):t={index:g,time:C,price:$}),p.cmp($,!s,f.price)?(f={index:g,time:C,price:$},v=p.cloneDeep(f)):v.index=g,p.cmp($,s,v.price)&&(v={index:g,time:C,price:$}),l.index>f.index){const o=p.fmtNum(t.price-l.price,1,!0);if(o>=1&&(f.index-v.index>=2*(l.index-t.index)||p.fmtNum(f.price-v.price,1,!0)>o))break}}return{A:f,B:t,C:l}}function Z(S){let s,[f,t,l]=Array(3).fill({});for(let v=0;v<S.length;v++){const u=S[v].value,$=S[v].time,C=e.timeToIndex($);if(C===-1)break;if(v===0&&(f={index:C,time:$,price:u},t=p.cloneDeep(f),l=p.cloneDeep(f)),s===void 0){if(u===f.price)continue;s=u>f.price}p.cmp(u,s,t.price)&&(t={index:C,time:$,price:u},l=p.cloneDeep(t)),p.cmp(t.price,s,f.price)&&p.cmp(u,!s,l.price)&&(p.cmp(u,s,f.price)?l={index:C,time:$,price:u}:(f=p.cloneDeep(t),t={index:C,time:$,price:u},l=p.cloneDeep(t),s=!s))}return{A:f,B:t,C:l}}function A(S){const s={};return Object.entries(S).forEach(([f,t])=>{const{index:l,...v}=t;s[f]=v}),s}return(S,s)=>(Y(),G("div",{ref_key:"scanToolRef",ref:y,class:"context command",title:S.$t("trading.derivative.scanTool"),onClick:h,onContextmenu:O},[M("i",{class:ae(["far",{[`fa-angles-${I.value}`]:!0}])},null,2),xe(ee(jt,{class:"contextmenu",modelValue:I.value,"onUpdate:modelValue":s[0]||(s[0]=f=>I.value=f)},null,8,["modelValue"]),[[we,k.value]])],40,Ut))}},Qt=["title"],Gt=M("i",{class:"far fa-heart-rate"},null,-1),Kt=[Gt],ei={__name:"PatternTool",props:["prices","priceSeries","timeMarkSeries","pickTimeToolRef","timeToIndex","indexToTime"],emits:["setProgress","hideContext"],setup(E,{expose:N,emit:x}){const p=me(),e=fe("mf"),r=E,y=x,k=B(null),I=le(()=>p.state.tradingDerivative.tools.pattern);let a={},m={};N({isSelected:h,draw:W,load:Z,refresh:S,remove:$,drag:o}),ve(I,i=>{i&&Z(i,{isCheck:!0})});function h(){return k.value.classList.contains("selected")}function O(i){y("hideContext");const n=i.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(T=>T.classList.remove("selected")),n||(i.target.classList.add("selected"),r.pickTimeToolRef.remove())}function V(i){i.target.classList.remove("selected"),y("hideContext"),$()}function W({time:i,price:n}){let d={lineType:"pattern",price:n,lineWidth:1,lineStyle:1,draggable:!0};if(e.isSet(m.A))if(e.isSet(m.B)){let _,b;if(e.isSet(m.C)){let L,R;a.A={time:i,price:n};const{progress:P,timeMark:F,info:{rEpr1:H,rEpr2:j,rEpr3:te,entry:se,pStatus:ie,x:re,X:U,y:q,Y:J}}=s();b=P,_=F,L="A",R={price:n,title:`A ${H}`},m[L].applyOptions(R),L="B",R={title:`B ${j}`},m[L].applyOptions(R),L="C",R={title:`C ${te}`},m[L].applyOptions(R),L="D",R={price:se,title:"Entry "+ie},m[L].applyOptions(R),L="X",R={price:e.fmtNum(re),title:`X ${e.fmtNum(U)}`},m[L].applyOptions(R),L="Y",R={price:e.fmtNum(q),title:`Y ${e.fmtNum(J)}`},m[L].applyOptions(R)}else{a.C={price:n};const{progress:L,timeMark:R,info:{rEpr1:P,rEpr2:F,rEpr3:H,entry:j,pStatus:te,x:se,X:ie,y:re,Y:U}}=s();b=L,_=R;let q="A";m[q].applyOptions({title:`A ${P}`}),q="B",m[q].applyOptions({title:`B ${F}`}),d.point="C",d.title=`C ${H}`,d.color="#FFEB3B",m[d.point]=r.priceSeries.createPriceLine(d),d.point="D",d.price=j,d.title="Entry "+te,d.color="#9C27B0",d.draggable=!1,m[d.point]=r.priceSeries.createPriceLine(d),d.point="Y",d.price=e.fmtNum(re),d.title=`Y ${e.fmtNum(U)}`,d.color="#E91E63",d.draggable=!1,m[d.point]=r.priceSeries.createPriceLine(d),d.point="X",d.price=e.fmtNum(se),d.title=`X ${e.fmtNum(ie)}`,d.color="#2196F3",d.draggable=!1,m[d.point]=r.priceSeries.createPriceLine(d)}u(),y("setProgress",b),g(_),k.value.classList.remove("selected")}else d.point="B",d.title="B 0",d.color="#4CAF50",m[d.point]=r.priceSeries.createPriceLine(d),a.B={price:n};else d.point="A",d.title="A 0",d.color="#F44336",m[d.point]=r.priceSeries.createPriceLine(d),a={A:{time:i,price:n}}}function Z(i,{isSave:n=!1,isCheck:T=!1}={}){a=e.cloneDeep(i),n&&u(),(T?t(a):!0)&&(C(),A())}function A(){let n={lineType:"pattern",lineWidth:1,lineStyle:1,draggable:!0};const{A:T,B:d,C:_}=a,{progress:b,timeMark:L,info:{rEpr1:R,rEpr2:P,rEpr3:F,entry:H,pStatus:j,x:te,X:se,y:ie,Y:re}}=s();y("setProgress",b),g(L),n.point="A",n.title=`A ${R}`,n.color="#F44336",n.price=T.price,m[n.point]=r.priceSeries.createPriceLine(n),n.point="B",n.title=`B ${P}`,n.color="#4CAF50",n.price=d.price,m[n.point]=r.priceSeries.createPriceLine(n),n.point="C",n.price=_.price,n.title=`C ${F}`,n.color="#FFEB3B",m[n.point]=r.priceSeries.createPriceLine(n),n.point="D",n.price=H,n.title="Entry "+j,n.color="#9C27B0",n.draggable=!1,m[n.point]=r.priceSeries.createPriceLine(n),n.point="Y",n.price=e.fmtNum(ie),n.title=`Y ${e.fmtNum(re)}`,n.color="#E91E63",n.draggable=!1,m[n.point]=r.priceSeries.createPriceLine(n),n.point="X",n.price=e.fmtNum(te),n.title=`X ${e.fmtNum(se)}`,n.color="#2196F3",n.draggable=!1,m[n.point]=r.priceSeries.createPriceLine(n)}function S(i=!1){e.isSet(m.C)&&(i&&v(),C(),A())}function s(){const{A:i,B:n,C:T}=a,d=n.price-T.price,_=d>0,b=f({phase:1,start:i,end:n,retracementPrice:T.price});let L=f({phase:2,start:b.R,end:T});const R=f({phase:3,start:L.R,end:{price:n.price+(_?1:-1)*b.rEp},breakPrices:[L.S1.price,n.price]});b.xBox.tr>=L.tr&&(L.tr=b.xBox.tr),console.log("calculatePattern",[b,L,R]);const P=e.fmtNum(d,1,!0)>=b.pr,F=e.fmtNum(T.price-R.xBox.R.price,1,!0)>=L.pr,H=e.fmtNum(R.xBox.pr)>=R.pr,j=!e.cmp(T.price,!_,b.S1.price),te=!e.cmp(R.xBox.R.price,_,L.S1.price),se=!e.cmp(R.xBox.S.price,!_,R.S1.price),ie=b.R.index+b.tr,re=b.R.index+5*b.tr,U=L.R.index+L.tr,q=R.xBox.R.index+R.tr,J=R.xBox.R.index+5*R.tr,ne=R.xBox.R.index+L.tr,he=[ie,re,U,q,J,ne],ce=R.xBox.S.index;let ge,X={};const be=[L.R.index>ie,b.rEpr<3,L.rEpr<b.rEpr];X.steps=[[P||b.rEt<b.tr&&b.rEp>=b.sEp,j,!R.breakIndexs[1]||ie<R.breakIndexs[1],ce>ie,ce<re],[...be,U>ie,ce<J,ce<U],[L.R.index-b.R.index>.5*b.tr,F,!R.breakIndexs[1]||U<R.breakIndexs[1],ce>U],[H,se,ce>q,be.every(Boolean)||ce>ne]],X.step=1,X.result=X.steps[0].every(Boolean),ge=b.R1.price,X.result&&(ce<=U?(X.step=2,X.result=X.steps[1].every(Boolean),ge=L.S1.price):(X.step=3,X.result=X.steps[2].every(Boolean),ge=R.R1.price,X.result&&(X.step=4,X.result=X.steps[3].every(Boolean),X.result&&(ge=R.xBox.R.price))));const pe=`${j?P?1:0:2}${te?F?1:0:2}${se?H?1:0:2}`,ye=b.rEp,Be=l(n.price,ye,_),De=R.breakIndexs[1]??ce,Re=parseInt((De-b.R.index)/b.tr),Ee=Re>1?ye*Re:ye,Fe=l(n.price,Ee,_);return{progress:X,timeMark:he,info:{rEpr1:b.rEpr,rEpr2:L.rEpr,rEpr3:R.rEpr,entry:ge,pStatus:pe,x:Be,X:ye,y:Fe,Y:Ee}}}function f({phase:i,start:n,end:T,breakPrices:d,retracementPrice:_}){let b=e.cloneDeep(n),L=e.cloneDeep(T);const R=L.price>b.price;let P={},F={},H={},j=[null,null],te,se,ie;const re=r.pickTimeToolRef.get();return r.prices.filter(U=>{let q=U.time>=b.time;return re&&(q&=U.time<=re),q}).every((U,q)=>{const J=U.value,ne=r.timeToIndex(U.time);return ne===-1?!1:(q===0&&(P={R:{index:ne,price:J},S:{index:ne,price:J},pr:0,tr:0},F=e.cloneDeep(P),H=e.cloneDeep(P)),e.cmp(J,R,P.R.price)?(P.pr>0&&((P.pr>F.pr||P.pr===F.pr&&P.tr>=F.tr)&&(F.pr=P.pr,F.R=e.cloneDeep(P.R),F.S=e.cloneDeep(P.S)),P.tr>F.tr&&(F.tr=P.tr),i===1&&_&&!e.cmp(P.S.price,!R,_)&&P.tr>=H.tr&&P.pr>=H.pr&&(H=e.cloneDeep(P))),P={R:{index:ne,price:J},S:{index:ne,price:J},pr:0,tr:0},i===3&&d&&(!j[0]&&e.cmp(J,R,d[0])&&(j[0]=ne),!j[1]&&e.cmp(J,R,d[1])&&(j[1]=ne))):(P.S.index=ne,P.tr=P.S.index-P.R.index,e.cmp(J,!R,P.S.price)&&(P.S.price=J,P.pr=e.fmtNum(P.S.price-P.R.price,1,!0))),e.cmp(J,!R,b.price)?(P.S.price=b.price,!1):!!e.cmp(J,!R,L.price))}),e.isSet(P)&&(b.index=r.timeToIndex(b.time),L.index=P.S.index,L.time=r.indexToTime(P.S.index),te=e.fmtNum(L.price-F.R.price,1,!0),se=e.fmtNum(b.price-F.S.price,1,!0),ie=L.index-F.S.index,i===3&&(H=P)),{tr:F.tr,pr:F.pr,rEp:te,sEp:se,rEpr:F.pr?e.fmtNum(te/F.pr):0,rEt:ie,S1:F.S,R1:F.R,xBox:H,S:b,R:L,breakIndexs:j}}function t({A:{time:i}}){return i>=r.prices[0].time&&i<r.prices.at(-1).time}function l(i,n,T){const d=i+(T?1:-1)*n;let _=e.fmtNum(d%1);if(T){if(_>=.1&&_<=.2)return Math.floor(d);if(_>=.6&&_<=.7)return Math.floor(d)+.5}else{if(_>=.8&&_<=.9)return Math.ceil(d);if(_>=.3&&_<=.4)return Math.floor(d)+.5}return d}function v(){if(r.pickTimeToolRef.get())return!1;const n=a.B.price-a.A.price>0,T=r.prices.at(-1).value;if(e.cmp(T,!n,a.C.price)){let d=T;for(let _=r.prices.length-1;_>=0;_--){const b=r.prices[_].value;if(b===a.B.price)break;d=n?Math.min(d,b):Math.max(d,b)}a.C.price=d,u()}}function u(i=!1){let n={isRemove:i,name:"pattern",points:[],data:[]};i?a={}:Object.entries(a).forEach(([T,d])=>{n.points.push(T),n.data.push(d)}),p.dispatch("tradingDerivative/drawTools",n)}function $(){u(!0),r.pickTimeToolRef.remove(),C(),y("setProgress",{})}function C(){e.isSet(m.A)&&(r.priceSeries.removePriceLine(m.A),e.isSet(m.B)&&(r.priceSeries.removePriceLine(m.B),e.isSet(m.C)&&(r.priceSeries.removePriceLine(m.C),r.priceSeries.removePriceLine(m.D),r.priceSeries.removePriceLine(m.X),r.priceSeries.removePriceLine(m.Y)))),m={},g([])}function g(i){const n=["#F44336","#F44336","#4CAF50","#FFEB3B","#FFEB3B","#2196F3"];let T=[];for(let d=0;d<i.length;d++){let _=r.indexToTime(i[d]);_&&(i.indexOf(i[d])!==i.lastIndexOf(i[d])&&(_+=d),T.push({time:_,value:1,color:n[d]}))}T.length&&T.sort((d,_)=>d.time-_.time),r.timeMarkSeries.setData(T)}function o({lineOptions:i}){if(e.isSet(m.C)){let n,T;a={A:{time:a.A.time,price:+m.A.options().price},B:{price:+m.B.options().price},C:{price:+m.C.options().price}},u();const{progress:d,timeMark:_,info:{rEpr1:b,rEpr2:L,rEpr3:R,entry:P,pStatus:F,x:H,X:j,y:te,Y:se}}=s();y("setProgress",d),g(_),n="A",T={title:`A ${b}`},m[n].applyOptions(T),n="B",T={title:`B ${L}`},m[n].applyOptions(T),n="C",T={title:`C ${R}`},m[n].applyOptions(T),n="D",T={price:P,title:"Entry "+F},i.point===n&&delete T.price,m[n].applyOptions(T),n="X",T={price:e.fmtNum(H),title:`X ${e.fmtNum(j)}`},m[n].applyOptions(T),n="Y",T={price:e.fmtNum(te),title:`Y ${e.fmtNum(se)}`},m[n].applyOptions(T)}}return(i,n)=>(Y(),G("div",{ref_key:"patternToolRef",ref:k,class:"command",title:i.$t("trading.derivative.patternTool"),onClick:O,onContextmenu:V},Kt,40,Qt))}},ti=["title"],ii=M("i",{class:"far fa-pipe"},null,-1),ni=[ii],si={__name:"PickTimeTool",props:["pickTimeSeries"],emits:["refreshPattern","hideContext"],setup(E,{expose:N,emit:x}){const p=me(),e=E,r=x,y=B(null),k=le(()=>p.state.tradingDerivative.tools.pickTime);let I=null;N({isSelected:a,draw:V,remove:Z,get:m}),ve(k,A=>{A&&W(A[0])});function a(){return y.value.classList.contains("selected")}function m(){return I}function h(A){r("hideContext");const S=A.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(s=>s.classList.remove("selected")),S||A.target.classList.add("selected")}function O(A){A.target.classList.remove("selected"),Z(),r("refreshPattern")}function V({time:A}){p.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"pickTime",points:[0],data:[A]}),W(A),r("refreshPattern"),y.value.classList.remove("selected")}function W(A){I=A,e.pickTimeSeries.setData([{time:A,value:1,color:"#9C27B0"}])}function Z(A=!0){A&&p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"pickTime"}),e.pickTimeSeries.setData([]),I=null}return(A,S)=>(Y(),G("div",{ref_key:"pickTimeToolRef",ref:y,class:"command",title:A.$t("trading.derivative.pickTimeTool"),onClick:h,onContextmenu:O},ni,40,ti))}};const ri={class:"input"},oi={class:"color"},ai=["onClick"],ci={__name:"LineContext",props:["enable","title","color"],emits:["update:title","update:color"],setup(E,{emit:N}){const x=E,p=N,e=B(null),r=B(["#F44336","#FF9800","#FFEB3B","#4CAF50","#009688","#00BCD4","#2196F3","#673AB7","#9C27B0","#E91E63"]);ve(()=>x.enable,a=>{a&&kt().then(()=>e.value.instance.focus())});function y({value:a}){p("update:title",a)}function k(a){p("update:color",a)}function I(){p("deleteAllLine")}return(a,m)=>{const h=st("DxButton");return Y(),ze(Xe,{class:"line-context"},{default:Je(()=>[M("div",ri,[ee(ot(Et),{ref_key:"titleRef",ref:e,value:x.title,"show-clear-button":!0,"input-attr":{style:`color:${x.color}`},onValueChanged:y},null,8,["value","input-attr"]),ee(h,{icon:"trash",type:"danger",onClick:m[0]||(m[0]=O=>I())})]),M("div",oi,[(Y(!0),G(Ye,null,He(r.value,(O,V)=>(Y(),G("div",{class:"color-swatch",style:_t({background:O,boxShadow:`0 0 4px ${O}`}),key:V,onClick:W=>k(O)},null,12,ai))),128))])]),_:1})}}},li=["title"],pi=M("i",{class:"far fa-horizontal-rule"},null,-1),ui={__name:"LineTool",props:["priceSeries"],emits:["hideContext"],setup(E,{expose:N,emit:x}){const p=me(),e=E,r=x,y=B(null),k=B(!1),I=le(()=>p.state.tradingDerivative.tools.line),a=B(""),m=B("#F44336");let h=[];N({isSelected:O,hide:V,draw:A,drag:t}),ve(I,l=>{l&&S(l)});function O(){return y.value.classList.contains("selected")}function V(){k.value=!1}function W(l){r("hideContext");const v=l.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(u=>u.classList.remove("selected")),v||l.target.classList.add("selected")}function Z(l){const v=k.value;r("hideContext"),k.value=!v}function A({price:l}){const v="line",u=h.length;if(h=h.filter($=>{const C=$.options(),g=C.type=l===+C.price;return g&&(e.priceSeries.removePriceLine($),p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:v,point:l})),!g}),h.length===u){const $=m.value,C=a.value,g={lineType:v,price:l,color:$,title:C,lineWidth:1,lineStyle:1,draggable:!0};h.push(e.priceSeries.createPriceLine(g)),p.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:v,points:[l],data:[{color:$,title:C}]})}y.value.classList.remove("selected")}function S(l){f(!1),s(l)}function s(l){const u={lineType:"line",lineWidth:1,lineStyle:1,draggable:!0};Object.entries(l).forEach(([$,{color:C,title:g}])=>{u.price=+$,u.color=C,u.title=g,h.push(e.priceSeries.createPriceLine(u))})}function f(l=!0){h.length>0&&(l&&p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line"}),h.forEach(v=>e.priceSeries.removePriceLine(v)),h=[])}function t({lineOptions:l,oldPrice:v,newPrice:u}){p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line",point:v});const $=l.color,C=l.title;p.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"line",points:[u],data:[{color:$,title:C}]}),y.value.classList.remove("selected")}return(l,v)=>(Y(),G("div",{ref_key:"lineToolRef",ref:y,class:"context command",title:l.$t("trading.derivative.lineTool"),onClick:W,onContextmenu:Z},[pi,xe(ee(ci,{class:"contextmenu",enable:k.value,title:a.value,"onUpdate:title":v[0]||(v[0]=u=>a.value=u),color:m.value,"onUpdate:color":v[1]||(v[1]=u=>m.value=u),onDeleteAllLine:f},null,8,["enable","title","color"]),[[we,k.value]])],40,li))}},di=["title"],fi=M("i",{class:"far fa-grip-lines-vertical"},null,-1),mi=[fi],vi={__name:"TimeRangeTool",props:["timeRangeSeries","timeToIndex","indexToTime"],emits:["hideContext"],setup(E,{expose:N,emit:x}){const p=me(),e=fe("mf"),r=E,y=x,k=B(null),I=le(()=>p.state.tradingDerivative.tools.timeRange);let a=[];N({isSelected:m,draw:V}),ve(I,S=>{S&&W(S)});function m(){return k.value.classList.contains("selected")}function h(S){y("hideContext");const s=S.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(f=>f.classList.remove("selected")),s||S.target.classList.add("selected")}function O(S){A(),S.target.classList.remove("selected")}function V({time:S}){let s={isRemove:!1,name:"timeRange",points:[],data:[]},f={time:S,value:1};switch(a.length){case 0:f.color="OrangeRed",a[0]=f,s.points.push(0),s.data.push(S);break;case 1:f.color="lime",a[1]=f,s.points.push(1),s.data.push(S),k.value.classList.remove("selected");break;default:const t=r.timeToIndex(a[0].time),l=r.timeToIndex(a[1].time),u=r.timeToIndex(S)+(l-t),$=r.indexToTime(u);f.color="OrangeRed",a[0]=e.cloneDeep(f),s.points.push(0),s.data.push(S),f.time=$,f.color="lime",a[1]=f,s.points.push(1),s.data.push($),k.value.classList.remove("selected");break}r.timeRangeSeries.setData(a),p.dispatch("tradingDerivative/drawTools",s)}function W(S){A(!1),Z(S)}function Z(S){let s,f;if(S.length===2)s=S[0],f=S[1];else if(S.length===3){const l=r.timeToIndex(S[0]),v=r.timeToIndex(S[1]),$=r.timeToIndex(S[2])+(v-l);s=S[2],f=r.indexToTime($)}else return!1;let t=[{time:s,value:1,color:"OrangeRed"},{time:f,value:1,color:"lime"}];a=t,r.timeRangeSeries.setData(t)}function A(S=!0){S&&p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"timeRange"}),r.timeRangeSeries.setData([]),a=[]}return(S,s)=>(Y(),G("div",{ref_key:"timeRangeToolRef",ref:k,class:"command",title:S.$t("trading.derivative.timeRangeTool"),onClick:h,onContextmenu:O},mi,40,di))}},hi=["title"],gi=M("i",{class:"far fa-line-height"},null,-1),Si=[gi],yi={__name:"TargetTool",props:["priceSeries"],emits:["hideContext"],setup(E,{expose:N,emit:x}){const p=me(),e=fe("mf"),r=E,y=x,k=B(null),I=le(()=>p.state.tradingDerivative.tools.target);let a={};N({isSelected:m,draw:V,drag:S}),ve(I,s=>{s&&W(s)});function m(){return k.value.classList.contains("selected")}function h(s){y("hideContext");const f=s.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(t=>t.classList.remove("selected")),f||(s.target.classList.add("selected"),A())}function O(s){A(),s.target.classList.remove("selected")}function V({price:s}){const f="target";let t={lineType:f,price:s,lineWidth:1,lineStyle:1,draggable:!0},l={isRemove:!1,name:f,points:[],data:[s]};if(e.isSet(a.A)){const v=+a.A.options().price,u=s-v;t.point="B",t.title=e.fmtNum(u),t.color="#F44336",a[t.point]=r.priceSeries.createPriceLine(t),l.points.push(t.point),t.point="X",t.price=e.fmtNum(v-.5*u),t.title=e.fmtNum(-.5*u),t.color="#2196F3",a[t.point]=r.priceSeries.createPriceLine(t),t.point="Y",t.price=e.fmtNum(v-u),t.title=e.fmtNum(-u),t.color="#673AB7",a[t.point]=r.priceSeries.createPriceLine(t),t.point="Z",t.price=e.fmtNum(v-2*u),t.title=e.fmtNum(-2*u),t.color="#9C27B0",a[t.point]=r.priceSeries.createPriceLine(t),t.point="W",t.price=e.fmtNum(v-4*u),t.title=e.fmtNum(-4*u),t.color="#E91E63",a[t.point]=r.priceSeries.createPriceLine(t),k.value.classList.remove("selected")}else t.point="A",t.title="0",t.color="#FF9800",a[t.point]=r.priceSeries.createPriceLine(t),l.points.push(t.point);p.dispatch("tradingDerivative/drawTools",l)}function W(s){A(!1),Z(s)}function Z(s){let t={lineType:"target",lineWidth:1,lineStyle:1,draggable:!0};const l=s.A,v=s.B,u=v-l;t.point="A",t.price=l,t.title="0",t.color="#FF9800",a[t.point]=r.priceSeries.createPriceLine(t),t.point="B",t.price=v,t.title=e.fmtNum(u),t.color="#F44336",a[t.point]=r.priceSeries.createPriceLine(t),t.point="X",t.price=e.fmtNum(l-.5*u),t.title=e.fmtNum(-.5*u),t.color="#2196F3",a[t.point]=r.priceSeries.createPriceLine(t),t.point="Y",t.price=e.fmtNum(l-u),t.title=e.fmtNum(-u),t.color="#673AB7",a[t.point]=r.priceSeries.createPriceLine(t),t.point="Z",t.price=e.fmtNum(l-2*u),t.title=e.fmtNum(-2*u),t.color="#9C27B0",a[t.point]=r.priceSeries.createPriceLine(t),t.point="W",t.price=e.fmtNum(l-4*u),t.title=e.fmtNum(-4*u),t.color="#E91E63",a[t.point]=r.priceSeries.createPriceLine(t)}function A(s=!0){s&&p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"target"}),e.isSet(a.A)&&(r.priceSeries.removePriceLine(a.A),e.isSet(a.B)&&(r.priceSeries.removePriceLine(a.B),r.priceSeries.removePriceLine(a.X),r.priceSeries.removePriceLine(a.Y),r.priceSeries.removePriceLine(a.Z),r.priceSeries.removePriceLine(a.W))),a={}}function S({lineOptions:s,newPrice:f}){if(e.isSet(a.B)){let t={isRemove:!1,name:"target",points:[],data:[]},l,v,u=+a.A.options().price,$=+a.B.options().price,C=$-u;if(l="A",s.point==="A")C=+a.B.options().title,$=u+C;else if(s.point!=="B"){let g=0;switch(s.point){case"X":g=1.5;break;case"Y":g=2;break;case"Z":g=3;break;case"W":g=5;break}C=e.fmtNum(($-f)/g),u=$-C,v={price:u},a[l].applyOptions(v)}t.points.push(l),t.data.push(u),l="B",v={price:$,title:e.fmtNum(C)},s.point===l&&delete v.price,a[l].applyOptions(v),t.points.push(l),t.data.push($),l="X",v={price:e.fmtNum(u-.5*C),title:e.fmtNum(-.5*C)},s.point===l&&delete v.price,a[l].applyOptions(v),l="Y",v={price:e.fmtNum(u-C),title:e.fmtNum(-C)},s.point===l&&delete v.price,a[l].applyOptions(v),l="Z",v={price:e.fmtNum(u-2*C),title:e.fmtNum(-2*C)},s.point===l&&delete v.price,a[l].applyOptions(v),l="W",v={price:e.fmtNum(u-4*C),title:e.fmtNum(-4*C)},s.point===l&&delete v.price,a[l].applyOptions(v),p.dispatch("tradingDerivative/drawTools",t)}}return(s,f)=>(Y(),G("div",{ref_key:"targetToolRef",ref:k,class:"command",title:s.$t("trading.derivative.targetTool"),onClick:h,onContextmenu:O},Si,40,hi))}},Ti=["title"],it=3,nt=2,xi={__name:"OrderTool",props:["position","prices","priceSeries","inSession","TIME"],emits:["getTools","showEntry","showTpSl","orderChanged","hideContext"],setup(E,{expose:N,emit:x}){const p=me(),{t:e}=Ae(),r=fe("mf"),y=E,k=x,I=B(null),a=B(!1),m=le(()=>p.state.tradingDerivative.tools.order);let h={},O={},V=!1;N({show:Z,entry:A,tpsl:S,cancel:s,cancelWithoutClose:f,scan:t,drag:$}),ve(m,g=>{g&&v(g)});function W(){return r.isSet(O.entry)||r.isSet(O.tp)}function Z({price:g}){if(g&&y.inSession()){const o=Q(ke(new Date,7));if(r.isSet(O.entry))!r.isSet(O.tp)&&y.position&&o>y.TIME.ATO&&o<y.TIME.ATC&&k("showTpSl",{side:y.position});else{let i=null,n=0;y.position?(o<y.TIME.ATO?i="ATO":o>y.TIME.ATC&&(i="ATC"),i&&(h.entry=i,n=-y.position)):o>y.TIME.ATO&&o<y.TIME.ATC&&(i=g,n=i>=y.prices.at(-1).value?1:-1,h.side=n,h.entry=i),n&&k("showEntry",{side:n,price:i})}}}function A(){if(y.inSession()){const g=Q(ke(new Date,7));g<y.TIME.ATO?tt(e("trading.derivative.atoOrder"),e("titles.confirm")).then(i=>{i&&p.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(n=>{n.isOk?oe.success(e("trading.derivative.atoOrderSuccess")):C(n.message)})}):g>y.TIME.ATC?tt(e("trading.derivative.atcOrder"),e("titles.confirm")).then(i=>{i&&p.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(n=>{n.isOk?oe.success(e("trading.derivative.atcOrderSuccess")):C(n.message)})}):p.dispatch("tradingDerivative/executeOrder",{action:"entry",entryData:{cmd:"new",side:h.side,price:h.entry}}).then(o=>{o.isOk?(l(["entry"]),oe.success(e("trading.derivative.newEntrySuccess"))):C(o.message)})}}function S(){h.tp=h.entry+h.side*it,h.sl=h.entry-h.side*nt,p.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:h.tp},slData:{cmd:"new",price:h.sl}}).then(g=>{g.isOk?(O.entry.applyOptions({draggable:!1}),l(["tp","sl"]),oe.success(e("trading.derivative.newTpSlSuccess"))):C(g.message)})}function s(){r.isSet(O.entry)?r.isSet(O.tp)?p.dispatch("tradingDerivative/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(g=>{g.isOk?(u(["entry","tp","sl"]),oe.success(e("trading.derivative.exitSuccess"))):C(g.message)}):p.dispatch("tradingDerivative/executeOrder",{action:"entry",entryData:{cmd:"delete"}}).then(g=>{g.isOk?(u(["entry"]),oe.success(e("trading.derivative.deleteEntrySuccess"))):C(g.message)}):k("getTools")}function f(){if(y.inSession()&&y.position){const g=Q(ke(new Date,7));g>y.TIME.ATC-5*60&&(a.value=!0,g>y.TIME.ATC-15&&r.isSet(O.tp)&&p.dispatch("tradingDerivative/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(o=>{o.isOk?(u(["entry","tp","sl"]),oe.success(e("trading.derivative.autoCancelTpSlSuccess"))):C(o.message)}))}}function t(g){if(r.isSet(O.entry)){const o=h.side>0;r.isSet(O.tp)?(r.cmp(g,o,h.tp,!0)&&(V||(V=!0,p.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"delete"}}).then(i=>{i.isOk?(u(["entry","tp","sl"]),oe.success(e("trading.derivative.deleteTpSuccess"))):C(i.message),V=!1}))),r.cmp(g,!o,h.sl,!0)&&(V||(V=!0,p.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"cancel"}}).then(i=>{i.isOk?(u(["entry","tp","sl"]),oe.success(e("trading.derivative.deleteSlSuccess"))):C(i.message),V=!1})))):r.cmp(g,o,h.entry,!0)&&(V||(V=!0,setTimeout(()=>{h.tp=h.entry+h.side*it,h.sl=h.entry-h.side*nt,p.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:h.tp},slData:{cmd:"new",price:h.sl}}).then(i=>{i.isOk?(O.entry.applyOptions({draggable:!1}),l(["tp","sl"]),oe.success(e("trading.derivative.autoNewTpSlSuccess"))):C(i.message),V=!1})},1e3)))}}function l(g,o=!0){const i="order";let n={isRemove:!1,name:i,points:[],data:[]},T,d;g.forEach(_=>{switch(_){case"entry":T="yellow",d=h.side>0?"LONG":"SHORT";break;case"tp":T="lime",d=r.fmtNum(h.tp-h.entry,1,!0);break;case"sl":T="red",d=r.fmtNum(h.sl-h.entry,1,!0);break}if(r.isSet(O[_]))O[_].applyOptions({price:h[_],title:d}),n.points.push(_),n.data.push(h[_]);else{const b={lineType:i,kind:_,side:h.side,price:h[_],color:T,lineWidth:1,lineStyle:0,title:d,draggable:!(_==="entry"&&h.tp)};O[_]=y.priceSeries.createPriceLine(b),_==="entry"&&(n.points.push("side"),n.data.push(h.side)),n.points.push(_),n.data.push(h[_])}}),o&&p.dispatch("tradingDerivative/drawTools",n),k("orderChanged",W())}function v(g){h=r.cloneDeep(g);let o=["entry"];"tp"in h&&o.push("tp","sl"),u(["entry","tp","sl"],!1),l(o,!1),k("orderChanged",W())}function u(g,o=!0){o&&p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"order"}),g.forEach(i=>{r.isSet(O[i])&&(y.priceSeries.removePriceLine(O[i]),delete O[i])}),k("orderChanged",W())}function $({line:g,lineOptions:o,oldPrice:i,newPrice:n}){if(n!==i){const T=o.kind;if(T!=="entry"||!y.position){const _=`${T}Data`,b=`change${T[0].toUpperCase()}${T.slice(1)}Success`;p.dispatch("tradingDerivative/executeOrder",{action:T,[_]:{cmd:"change",price:n}}).then(L=>{L.isOk?(h[T]=n,l([T]),oe.success(e(`trading.derivative.${b}`))):(g.applyOptions({price:i}),C(L.message))})}else g.applyOptions({price:i}),oe.show(e("trading.derivative.noChangeOrderLine"))}}function C(g){g||(g="unknown"),oe.error(e(`trading.derivative.${g}`))}return(g,o)=>(Y(),G("div",{ref_key:"orderToolRef",ref:I,class:"cancel-order command",title:g.$t("trading.derivative.orderTool"),onClick:s},[M("i",{class:ae(["far fa-trash-alt",{blink:a.value}])},null,2)],8,Ti))}};const Ci=["title"],ki=["title"],_i=["title"],wi=["title"],bi=M("i",{class:"far fa-angle-double-right"},null,-1),Di=[bi],Ri="wss://tradestation.fireant.vn/quote?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",Ei="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",Ii={__name:"Chart",setup(E,{expose:N}){const x=me(),p=Dt(),{t:e}=Ae(),r=fe("mf"),y=fe("devices"),k=fe("filters"),I=B(null),a=B(null),m=B(null),h=B(null),O=B(null),V=B(null),W=B(null),Z=B(null),A=B(null),S=B(null),s=B(null),f=B(null),t=B(null),l=B(null),v=B(null),u=B(null),$={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.25,bottom:.25}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:1e3,minBarSpacing:.01,barSpacing:.05}},C=Pe(new Date,"yyyy-MM-dd"),g={START:Q(new Date(`${C}T08:45:00Z`)),ATO:Q(new Date(`${C}T09:00:00Z`)),ATC:Q(new Date(`${C}T14:30:00Z`)),END:Q(new Date(`${C}T14:45:00Z`))};let o={chart:{},whitespaces:[],crosshair:{},interval:null,refreshAt:Ze(new Date,11),statusAt:Ze(new Date,21),websocket:null,socketStop:!1,vpsUpdatedAt:Ze(new Date,61)};const i=wt({prices:[],series:{},chartDate:p.query.date??C,clock:Pe(new Date,"HH:mm:ss"),chartHeightEnough:!1,isSocketWarning:!1,hasOrderLine:!1,TIME:g}),n=le(()=>x.state.tradingDerivative.status),T=le(()=>x.state.tradingDerivative.config),d=le(()=>x.state.tradingDerivative.isLoading),_=le(()=>n.value.position||n.value.pending||i.hasOrderLine);o.interval=setInterval(()=>{i.clock=Pe(new Date,"HH:mm:ss"),Le()&&(l.value&&l.value.cancelWithoutClose(),We(new Date,new Date(o.refreshAt))>10&&(T.value.autoRefresh&&A.value.refresh(!0),o.refreshAt=new Date),We(new Date,new Date(o.statusAt))>20&&(Qe(),o.statusAt=new Date))},1e3),ft(),_e(()=>{te(),b(),new ResizeObserver(j).observe(I.value),document.addEventListener("keydown",re)}),Ie(()=>{L(),document.removeEventListener("keydown",re),clearInterval(o.interval),ce(),o.socketStop=!0}),ve(()=>x.state.tradingDerivative.chartData,U),N({connectSocket:he});function b(){o.chart=Lt(a.value,$),o.chart.subscribeCrosshairMove(se),o.chart.subscribeCustomPriceLineDragged(ie),i.series.whitespace=o.chart.addHistogramSeries({priceScaleId:"whitespace",scaleMargins:{top:0,bottom:0},color:"#808080",lastValueVisible:!1,priceLineVisible:!1}),i.series.timeRange=o.chart.addHistogramSeries({priceScaleId:"timeRange",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),i.series.pickTime=o.chart.addHistogramSeries({priceScaleId:"pickTime",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),i.series.timeMark=o.chart.addHistogramSeries({priceScaleId:"timeMark",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),i.series.price=o.chart.addLineSeries({color:"#F5F5F5",priceFormat:{minMove:.1}})}function L(){o.chart&&(o.chart.remove(),o.chart=null)}function R(c){pe(),De(!1),Z.value.isSelected()?Z.value.draw({time:o.crosshair.time}):A.value.isSelected()?A.value.draw({time:o.crosshair.time,price:$e(o.crosshair.y)}):S.value.isSelected()?S.value.draw({time:o.crosshair.time}):s.value.isSelected()?s.value.draw({price:$e(o.crosshair.y)}):f.value.isSelected()?f.value.draw({time:o.crosshair.time}):t.value.isSelected()&&t.value.draw({price:$e(o.crosshair.y)})}function P(c){De(!0),c.preventDefault()}function F(c){c.stopPropagation()}function H(c){c.preventDefault(),c.stopPropagation()}function j(){I.value&&(te(),o.chart.resize(I.value.offsetWidth,I.value.offsetHeight),I.value.classList.contains("fullscreen")&&O.value.setFullscreen())}function te(){i.chartHeightEnough=I.value.offsetHeight>700}function se(c){if(c.time){let w=c.seriesPrices.get(i.series.price);o.crosshair.time=c.time,o.crosshair.price=w}else y.phone||(o.crosshair.time=null,o.crosshair.price=null);c.point!==void 0&&(o.crosshair.x=c.point.x,o.crosshair.y=c.point.y)}function ie(c){let w=c.customPriceLine,D=w.options();D.price=r.fmtNum(D.price);const z=+c.fromPriceString,K=D.price;switch(D.lineType){case"order":l.value.drag({line:w,lineOptions:D,oldPrice:z,newPrice:K});break;case"line":s.value.drag({lineOptions:D,oldPrice:z,newPrice:K});break;case"target":t.value.drag({lineOptions:D,newPrice:K});break;case"pattern":A.value.drag({lineOptions:D});break}}function re(c){const w=o.chart.timeScale(),D=o.chart.options().timeScale.barSpacing;switch(c.key){case"[":c.ctrlKey?w.applyOptions({barSpacing:D-.01}):c.altKey&&w.scrollToPosition(w.scrollPosition()-50);break;case"]":c.ctrlKey?w.applyOptions({barSpacing:D+.01}):c.altKey&&w.scrollToPosition(w.scrollPosition()+50);break}}function U(c){i.chartDate===C&&Le()||(c.price.length>0&&(o.whitespaces=ne(o.whitespaces,J(i.chartDate))),i.series.whitespace.setData(o.whitespaces),i.prices=ne(i.prices,c.price),i.series.price.setData(i.prices))}function q(c,w=null){const D=w??T.value.source;let z=[];c.forEach(K=>{let ue,de;D==="FireAnt"?(ue=Q(ke(new Date(K.date),7)),de=K.price):(ue=Q(new Date(`${C}T${K.time}Z`)),de=K.lastPrice),z.push({time:ue,value:de})}),z.length>1?(i.prices=ne(i.prices,z),i.series.price.setData(i.prices)):(i.prices.push(z[0]),i.series.price.update(z[0]))}function J(c){const w=Q(new Date(`${c}T09:00:00Z`)),D=Q(new Date(`${c}T11:30:00Z`)),z=Q(new Date(`${c}T13:00:00Z`)),K=Q(new Date(`${c}T14:30:00Z`)),ue=Q(new Date(`${c}T14:00:00Z`));let de=[];for(let Se=w;Se<=K;Se++){if(Se>D&&Se<z)continue;let Ke={time:Se};(Se===ue||Se===K)&&(Ke.value=1),de.push(Ke)}return de}function ne(c,w){return Array.from(new Map([...c,...w].sort((D,z)=>D.time-z.time).map(D=>[D.time,D])).values())}async function he(){if(Le()){await ce();const c=T.value.source==="FireAnt",w=c?Ri:Ei;o.websocket=new WebSocket(w),o.websocket.onclose=D=>{o.socketStop||(i.isSocketWarning=!0,he())},c?ge():(Ue(),be())}}async function ce(){o.websocket&&o.websocket.readyState===WebSocket.OPEN&&(o.websocket.close(),await new Promise(c=>{const w=setInterval(()=>{(!o.websocket||o.websocket.readyState===WebSocket.CLOSED)&&(o.websocket=null,clearInterval(w),c())},100)}))}function ge(){x.dispatch("tradingDerivative/setLoading",!0),o.websocket.onopen=c=>{if(o.websocket.readyState===WebSocket.OPEN){let w='{"protocol":"json","version":1}';o.websocket.send(w),w='{"arguments":["VN30F1M"],"invocationId":"0","target":"SubscribeTrades","type":1}',o.websocket.send(w)}},o.websocket.onmessage=c=>{i.isSocketWarning=!1,X(c.data).forEach(D=>{if(!D)return!1;D.type===3?(D.result[0].date.slice(0,10)===C&&(Oe(),o.whitespaces=ne(o.whitespaces,J(C)),i.series.whitespace.setData(o.whitespaces),q(D.result)),x.dispatch("tradingDerivative/setLoading",!1)):D.type===1&&D.target==="UpdateTrades"&&D.arguments[0]==="VN30F1M"&&(console.log("FireAnt",D.arguments[1]),l.value.scan(D.arguments[1].at(-1).price),q(D.arguments[1]))})}}function X(c){let w=[];return c.split("").forEach(D=>{const z=D.indexOf("{"),K=D.lastIndexOf("}");let ue=null;if(z!==-1&&K!==-1&&K>z){const de=D.substring(z,K+1);de!=="{}"&&(ue=JSON.parse(de))}w.push(ue)}),w}function be(){o.websocket.onopen=c=>{if(o.websocket.readyState===WebSocket.OPEN){const w={action:"join",list:T.value.vn30f1m},D=`42${JSON.stringify(["regs",JSON.stringify(w)])}`;o.websocket.send(D)}},o.websocket.onmessage=c=>{if(i.isSocketWarning=!1,c.data.substr(0,1)==="4"&&c.data.substr(1,1)==="2"){const w=JSON.parse(c.data.substr(2));if(w[0]==="stockps"){const D=w[1].data;D.id===3220&&(console.log("VPS",D),l.value.scan(D.lastPrice),q([D]))}}}}function Ue(){We(new Date,new Date(o.vpsUpdatedAt))>60&&(fetch("https://bddatafeed.vps.com.vn/getpschartintraday/VN30F1M").then(c=>c.json()).then(c=>{console.log(c),q(c,"VPS")}),o.vpsUpdatedAt=new Date)}function qe(c){A.value.load(c,{isSave:!0})}function Ne(){A.value.refresh()}function pe(){W.value.hide(),Z.value.hide(),s.value.hide()}function ye(c){y.phone||W.value.hide(r.isSet(c)),W.value.set(c)}function Be(c){i.hasOrderLine=c}function De(c){c?l.value.show({price:$e(o.crosshair.y)}):(v.value.style.display="none",u.value.style.display="none")}function Re({side:c,price:w}){v.value.style.left=+(o.crosshair.x+(o.crosshair.x>innerWidth-71?-71:1))+"px",v.value.style.top=+(o.crosshair.y+(o.crosshair.y>innerHeight-61?-61:1))+"px",v.value.style.background=c>0?"green":"red",v.value.innerText=`${c>0?"LONG":"SHORT"} ${w}`,v.value.style.display="block"}function Ee({side:c}){u.value.style.left=+(o.crosshair.x+(o.crosshair.x>innerWidth-61?-61:1))+"px",u.value.style.top=+(o.crosshair.y+(o.crosshair.y>innerHeight-51?-51:1))+"px",u.value.style.background=c>0?"green":"red",u.value.style.display="block"}function Fe(){l.value.entry()}function lt(){l.value.tpsl()}function pt(){o.chart.timeScale().scrollToRealTime()}function Le(){const c=Q(ke(new Date,7));return T.value.openingMarket&&c>=g.START&&c<=g.END}function ut(){if(!i.chartDate)return!1;Me()}function dt(){o.whitespaces=[],i.prices=[],he(),Me()}function ft(){x.dispatch("tradingDerivative/initChart").then(()=>{he(),!p.query.date&&T.value.lastOpeningDate&&(i.chartDate=T.value.lastOpeningDate),Me()})}function Me(){x.dispatch("tradingDerivative/getChartData",i.chartDate).then(c=>{c&&Oe()})}function Qe(){x.dispatch("tradingDerivative/getStatus")}function Oe(){x.dispatch("tradingDerivative/getTools")}function mt(){x.dispatch("tradingDerivative/getAccountInfo").then(c=>{let w="";w+='<div style="width: 200px;">',w+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.nav")}</div><div>: ${k.currency(c.nav)}</div></div>`,w+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.maxVol")}</div><div>: ${k.numberVnFormat(c.maxVol)}</div></div>`,w+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.vm")}</div><div>: ${k.currency(c.vm)}</div></div>`,w+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.fee")}</div><div>: ${k.currency(c.fee)}</div></div>`,w+="</div>",Rt(w,e("trading.derivative.accountInfo"))})}function $e(c){return r.fmtNum(i.series.price.coordinateToPrice(c))}function Ve(c){let w=o.whitespaces.findIndex(D=>D.time===c);if(w===-1){const D=Pe(new Date(c*1e3),"yyyy-MM-dd"),z=Q(new Date(`${D}T11:30:00Z`)),K=Q(new Date(`${D}T13:00:00Z`)),ue=Q(new Date(`${D}T14:30:00Z`));c>z&&c<K?c=z:c>ue&&(c=ue),w=o.whitespaces.findIndex(de=>de.time===c)}return w}function Ge(c){return c<o.whitespaces.length?o.whitespaces[c].time:!1}return(c,w)=>(Y(),G("div",{ref_key:"chartContainerRef",ref:I,class:"derivative-chart",onClick:R,onContextmenu:P},[M("div",{ref_key:"chartRef",ref:a},null,512),M("div",{class:"area data-area",onClick:F,onContextmenu:H},[M("div",{ref_key:"connectionRef",ref:m,class:ae(["command",{yellow:n.value.pending,red:T.value.volInvalid}]),title:c.$t("trading.derivative.connection"),onClick:Qe},[M("i",{class:ae(["far",{"fa-link-simple":n.value.connection,"fa-link-simple-slash":!n.value.connection,blink:i.isSocketWarning}])},null,2)],10,Ci),M("div",{class:ae(["command status",{green:n.value.position>0,red:n.value.position<0}]),title:c.$t("trading.derivative.position"),onClick:mt},Te(n.value.position),11,ki),M("div",{class:"command clock",onClick:he},Te(i.clock),1),xe(M("input",{type:"date",class:"chart-date command",title:c.$t("trading.derivative.date"),"onUpdate:modelValue":w[0]||(w[0]=D=>i.chartDate=D),onChange:ut},null,40,_i),[[bt,i.chartDate]]),M("div",{ref_key:"reloadToolRef",ref:h,class:"command",title:c.$t("trading.derivative.reload"),onClick:dt,onContextmenu:Oe},[M("i",{class:ae(["far fa-sync-alt",{"fa-spin":d.value}])},null,2)],40,wi)],32),M("div",{class:"area tool-area",onClick:F,onContextmenu:H},[ee(Pt,{ref_key:"fullscreenToolRef",ref:O,chartContainerRef:I.value},null,8,["chartContainerRef"]),ee(Nt,{ref_key:"tradingviewToolRef",ref:V,vpsUser:T.value.vpsUser,vpsSession:T.value.vpsSession,chartContainerRef:I.value},null,8,["vpsUser","vpsSession","chartContainerRef"]),ee(Wt,{ref_key:"progressToolRef",ref:W,chartHeightEnough:i.chartHeightEnough,onRefreshPattern:Ne,onHideContext:pe},null,8,["chartHeightEnough"]),ee(qt,{ref_key:"scanToolRef",ref:Z,prices:i.prices,timeToIndex:Ve,onScaned:qe,onRemovePattern:w[1]||(w[1]=()=>A.value.remove()),onHideContext:pe},null,8,["prices"]),ee(ei,{ref_key:"patternToolRef",ref:A,prices:i.prices,priceSeries:i.series.price,timeMarkSeries:i.series.timeMark,pickTimeToolRef:S.value,timeToIndex:Ve,indexToTime:Ge,onSetProgress:ye,onHideContext:pe},null,8,["prices","priceSeries","timeMarkSeries","pickTimeToolRef"]),ee(si,{ref_key:"pickTimeToolRef",ref:S,pickTimeSeries:i.series.pickTime,onRefreshPattern:Ne,onHideContext:pe},null,8,["pickTimeSeries"]),ee(ui,{ref_key:"lineToolRef",ref:s,priceSeries:i.series.price,onHideContext:pe},null,8,["priceSeries"]),ee(vi,{ref_key:"timeRangeToolRef",ref:f,timeRangeSeries:i.series.timeRange,timeToIndex:Ve,indexToTime:Ge,onHideContext:pe},null,8,["timeRangeSeries"]),ee(yi,{ref_key:"targetToolRef",ref:t,priceSeries:i.series.price,onHideContext:pe},null,8,["priceSeries"]),xe(ee(xi,{ref_key:"orderToolRef",ref:l,position:n.value.position,prices:i.prices,priceSeries:i.series.price,inSession:Le,TIME:i.TIME,onGetTools:Oe,onShowEntry:Re,onShowTpSl:Ee,onOrderChanged:Be,onHideContext:pe},null,8,["position","prices","priceSeries","TIME"]),[[we,_.value]])],32),M("div",null,[M("div",{ref_key:"entryOrderRef",ref:v,class:"order-button entry",onClick:Fe}," Entry ",512),M("div",{ref_key:"tpslOrderRef",ref:u,class:"order-button tpsl",onClick:lt}," TP/SL ",512),M("div",{class:"chart-top",onClick:pt},Di)])],544))}};export{Ii as default};
