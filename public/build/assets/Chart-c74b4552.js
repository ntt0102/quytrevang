import{z as ct,A as lt,B as pt,r as N,y as We,C as Ge,o as H,b as J,d as B,E as ae,c as ce,G as Te,H as _e,I as dt,J as ut,m as Ke,e as ee,F as Me,K as Ve,t as ye,h as me,u as Oe,k as fe,L as ft,M as mt,N as je,O as et,g as tt,w as ve,Q as vt,R as ht,S as qe,x as se,l as Le,a as gt,T as St,U as yt,j as Tt,V as xt}from"./app-fc3e8f11.js";import{_ as Ct}from"./text-box-a4ffb386.js";import{g as G}from"./getUnixTime-88165698.js";import{c as kt}from"./lightweight-charts.esm.development-03366bac.js";function it(R,$,T){return ct((T==null?void 0:T.in)||R,+lt(R)+$)}function ke(R,$,T){return it(R,$*pt,T)}function _t(R,$,T){return it(R,$*1e3,T)}function bt(R,$,T){return _t(R,-$,T)}const wt=["title"],Dt={__name:"FullscreenTool",props:["chartContainerRef"],setup(R){const $=R,T=N(!1);We(()=>{document.addEventListener("fullscreenchange",t)}),Ge(()=>{document.removeEventListener("fullscreenchange",t)});function f(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function t(){$.chartContainerRef&&(document.fullscreenElement?(T.value=!0,$.chartContainerRef.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(T.value=!1,$.chartContainerRef.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}return(s,y)=>(H(),J("div",{class:"command",title:s.$t("trading.derivative.fullscreen"),onClick:f},[B("i",{class:ae(["far",{"fa-compress":T.value,"fa-expand":!T.value}])},null,2)],8,wt))}},Rt=["title"],Et=["src"],Lt={__name:"TradingviewTool",props:["vpsUser","vpsSession","chartContainerRef"],setup(R){const $=R,T=N(null),f=N(!1),t=ce(()=>`https://chart.vps.com.vn/tv/?u=${$.vpsUser}&s=${$.vpsSession}&symbol=VN30F1M&resolution=1&lang=vi`);function s(C){f.value=!f.value,y(),C.stopPropagation()}function y(){if($.chartContainerRef&&T.value){const{offsetWidth:C,offsetHeight:D}=$.chartContainerRef,{top:u,left:h}=T.value.getBoundingClientRect();T.value.style.top=`${u-2}px`,T.value.style.left=`${h+32}px`,T.value.style.width=`${C-34}px`,T.value.style.height=`${D}px`}}return(C,D)=>(H(),J("div",{class:"tradingview command far fa-chart-candlestick",title:C.$t("trading.derivative.tradingview"),onClick:s},[Te(B("iframe",{ref_key:"tradingviewRef",ref:T,class:"chart",src:t.value},null,8,Et),[[_e,f.value]])],8,Rt))}};const Ot=B("div",{class:"triangle-shadow"},null,-1),Pt=B("div",{class:"triangle"},null,-1),It={class:"container"},$t={__name:"ProgressContext",props:["progress"],emits:["refreshPattern"],setup(R,{emit:$}){const T=$,f=N([]);We(()=>{t()});function t(){dt(Object.assign({"../../../../../lang/vi/derivative.js":()=>ut(()=>import("./derivative-0a1a41d1.js"),[])}),`../../../../../lang/${window.lang}/derivative.js`).then(C=>{f.value=C.default||[]})}function s(){T("refreshPattern")}function y(C){C.stopPropagation()}return(C,D)=>{const u=Ke("DxButton");return H(),J("div",{class:"pattern-context",onClick:y},[Ot,Pt,B("div",null,[ee(u,{icon:"refresh",type:"success",text:C.$t("trading.derivative.progressContext.refreshPattern"),onClick:s},null,8,["text"])]),B("div",It,[(H(!0),J(Me,null,Ve(f.value,(h,p)=>(H(),J("div",{key:p,class:ae(["step",[R.progress.step&&R.progress.step===p+1?R.progress.result?"success":"fail":""]])},[B("div",{class:ae(["name",[R.progress.steps?R.progress.steps[p].every(Boolean)?"success":"fail":""]])},ye(p+1)+". "+ye(h.name),3),B("div",null,[(H(!0),J(Me,null,Ve(h.conds,(V,F)=>(H(),J("div",{key:F,class:ae(["condition",[R.progress.steps?R.progress.steps[p][F]?"success":"fail":""]])},ye(F+1)+". "+ye(V),3))),128))])],2))),128))])])}}},At=["title"],Nt={__name:"ProgressTool",props:["position"],emits:["refreshPattern","hideContext"],setup(R,{expose:$,emit:T}){const f=me(),{t}=Oe(),s=fe("mf"),y=R,C=T,D=N({}),u=N(!1),h=ce(()=>f.state.tradingDerivative.config.autoRefresh);$({hide:V,set:F});function p(){const r=u.value;C("hideContext"),u.value=!r,u.value&&Z()}function V(r){u.value=r}function F(r){!y.position&&h.value&&A(r,D.value),D.value=r}function Z(){C("refreshPattern")}function W(r){const m=r??!m.value;f.dispatch("tradingDerivative/setAutoRefresh",m)}function A(r,m){if(s.isSet(r)&&(r.step!==m.step||r.step===m.step&&r.result!==m.result)){let i="";r.result?[2,4].includes(r.step)?i=t("trading.derivative.progressOrder",r):i=t("trading.derivative.progressSuccess",r):i=t("trading.derivative.progressFail",r),S(i)}}function S(r){const m=new SpeechSynthesisUtterance(r);m.lang="vi-VN",speechSynthesis.speak(m)}return(r,m)=>(H(),J("div",{class:ae(["context command",{green:D.value.result===!0,red:D.value.result===!1}]),title:r.$t("trading.derivative.progressTool"),onClick:p,onContextmenu:W},[B("i",{class:ae(["far",{"fa-badge-check":!D.value.step,[`fa-circle-${D.value.step}`]:D.value.step,blink:h.value}])},null,2),Te(ee($t,{class:"contextmenu",progress:D.value,onRefreshPattern:Z},null,8,["progress"]),[[_e,u.value]])],42,At))}};var xe={};const Bt=ft(mt);/*!
 * devextreme-vue
 * Version: 22.2.12
 * Build date: Mon Apr 29 2024
 *
 * Copyright (c) 2012 - 2024 Developer Express Inc. ALL RIGHTS RESERVED
 *
 * This software may be modified and distributed under the terms
 * of the MIT license. See the LICENSE file in the root of the project for details.
 *
 * https://github.com/DevExpress/devextreme-vue
 */var Ft=je&&je.__importDefault||function(R){return R&&R.__esModule?R:{default:R}};Object.defineProperty(xe,"__esModule",{value:!0});xe.DxItem=xe.DxButtonGroup=void 0;var Mt=Ft(Bt),Vt=et,Wt=et,nt=Vt.createComponent({props:{accessKey:String,activeStateEnabled:Boolean,buttonTemplate:{},disabled:Boolean,elementAttr:Object,focusStateEnabled:Boolean,height:[Function,Number,String],hint:String,hoverStateEnabled:Boolean,items:Array,keyExpr:[Function,String],onContentReady:Function,onDisposing:Function,onInitialized:Function,onItemClick:Function,onOptionChanged:Function,onSelectionChanged:Function,rtlEnabled:Boolean,selectedItemKeys:Array,selectedItems:Array,selectionMode:String,stylingMode:String,tabIndex:Number,visible:Boolean,width:[Function,Number,String]},emits:{"update:isActive":null,"update:hoveredElement":null,"update:accessKey":null,"update:activeStateEnabled":null,"update:buttonTemplate":null,"update:disabled":null,"update:elementAttr":null,"update:focusStateEnabled":null,"update:height":null,"update:hint":null,"update:hoverStateEnabled":null,"update:items":null,"update:keyExpr":null,"update:onContentReady":null,"update:onDisposing":null,"update:onInitialized":null,"update:onItemClick":null,"update:onOptionChanged":null,"update:onSelectionChanged":null,"update:rtlEnabled":null,"update:selectedItemKeys":null,"update:selectedItems":null,"update:selectionMode":null,"update:stylingMode":null,"update:tabIndex":null,"update:visible":null,"update:width":null},computed:{instance:function(){return this.$_instance}},beforeCreate:function(){this.$_WidgetClass=Mt.default,this.$_hasAsyncTemplate=!0,this.$_expectedChildren={item:{isCollectionItem:!0,optionName:"items"}}}});xe.DxButtonGroup=nt;var Ze=Wt.createConfigurationComponent({emits:{"update:isActive":null,"update:hoveredElement":null,"update:disabled":null,"update:elementAttr":null,"update:hint":null,"update:html":null,"update:icon":null,"update:template":null,"update:text":null,"update:type":null,"update:visible":null},props:{disabled:Boolean,elementAttr:Object,hint:String,html:String,icon:String,template:{},text:String,type:String,visible:Boolean}});xe.DxItem=Ze;Ze.$_optionName="items";Ze.$_isCollectionItem=!0;var Zt=xe.default=nt;const Yt=B("div",{class:"triangle-shadow"},null,-1),zt=B("div",{class:"triangle"},null,-1),Ht={__name:"ScanContext",props:["modelValue"],emits:["update:modelValue"],setup(R,{emit:$}){const{t:T}=Oe(),f=[{icon:"chevrondoubleleft",side:"left",text:T("trading.derivative.scanContext.leftScan")},{icon:"chevrondoubleright",side:"right",text:T("trading.derivative.scanContext.rightScan")}],t=R,s=$;function y({itemData:{side:D}}){s("update:modelValue",D)}function C(D){D.stopPropagation()}return(D,u)=>(H(),J("div",{class:"scan-context",onClick:C},[Yt,zt,ee(tt(Zt),{items:f,"selected-item-keys":[t.modelValue],"key-expr":"side","styling-mode":"outlined",onItemClick:y},null,8,["selected-item-keys"])]))}},Jt=["title"],Xt={__name:"ScanTool",props:["prices","timeToIndex"],emits:["scaned","removePattern","hideContext"],setup(R,{expose:$,emit:T}){const f=fe("mf"),t=R,s=T,y=N(null),C=N(!1),D=N("left");$({isSelected:u,hide:h,draw:F});function u(){return y.value.classList.contains("selected")}function h(S){C.value=S}function p(S){s("hideContext");const r=S.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(m=>m.classList.remove("selected")),r||(S.target.classList.add("selected"),s("removePattern"))}function V(){const S=C.value;s("hideContext"),C.value=!S}function F({time:S}){const r=D.value==="left",m=S?t.prices.filter(c=>!f.cmp(c.time,r,S)):t.prices;let i=r?Z(m):W(m);f.isSet(i)&&s("scaned",A(i)),y.value.classList.remove("selected")}function Z(S){let r,[m,i,c,g]=Array(4).fill({});for(let v=S.length-1;v>=0;v--){const _=S[v].value,x=S[v].time,e=t.timeToIndex(x);if(e===-1)break;if(v===S.length-1&&(c={index:e,time:x,price:_},[i,m,g]=Array(3).fill(null).map(()=>f.cloneDeep(c))),r===void 0){if(_===c.price)continue;r=_>c.price}if(f.cmp(_,r,i.price)&&(f.cmp(m.price,!r,c.price)?([c,i]=[i,m].map(d=>f.cloneDeep(d)),m={index:e,time:x,price:_},g=f.cloneDeep(m),r=!r):i={index:e,time:x,price:_}),f.cmp(_,!r,m.price)?(m={index:e,time:x,price:_},g=f.cloneDeep(m)):g.index=e,f.cmp(_,r,g.price)&&(g={index:e,time:x,price:_}),c.index>m.index){const d=f.fmtNum(i.price-c.price,1,!0);if(d>=1.5&&(m.index-g.index>c.index-i.index||f.fmtNum(m.price-g.price,1,!0)>d))break}}return{A:m,B:i,C:c}}function W(S){let r,[m,i,c]=Array(3).fill({});for(let g=0;g<S.length;g++){const v=S[g].value,_=S[g].time,x=t.timeToIndex(_);if(x===-1)break;if(g===0&&(m={index:x,time:_,price:v},i=f.cloneDeep(m),c=f.cloneDeep(m)),r===void 0){if(v===m.price)continue;r=v>m.price}f.cmp(v,r,i.price)&&(i={index:x,time:_,price:v},c=f.cloneDeep(i)),f.cmp(i.price,r,m.price)&&f.cmp(v,!r,c.price)&&(f.cmp(v,r,m.price)?c={index:x,time:_,price:v}:(m=f.cloneDeep(i),i={index:x,time:_,price:v},c=f.cloneDeep(i),r=!r))}return{A:m,B:i,C:c}}function A(S){const r={};return Object.entries(S).forEach(([m,i])=>{const{index:c,...g}=i;r[m]=g}),r}return(S,r)=>(H(),J("div",{ref_key:"scanToolRef",ref:y,class:"context command",title:S.$t("trading.derivative.scanTool"),onClick:p,onContextmenu:V},[B("i",{class:ae(["far",{[`fa-angles-${D.value}`]:!0}])},null,2),Te(ee(Ht,{class:"contextmenu",modelValue:D.value,"onUpdate:modelValue":r[0]||(r[0]=m=>D.value=m)},null,8,["modelValue"]),[[_e,C.value]])],40,Jt))}},jt=["title"],qt=B("i",{class:"far fa-heart-rate"},null,-1),Ut=[qt],Qt={__name:"PatternTool",props:["prices","priceSeries","timeMarkSeries","pickTimeToolRef","timeToIndex","indexToTime"],emits:["setProgress","hideContext"],setup(R,{expose:$,emit:T}){const f=me(),t=fe("mf"),s=R,y=T,C=N(null),D=ce(()=>f.state.tradingDerivative.tools.pattern);let u={},h={};$({isSelected:p,draw:Z,load:W,refresh:S,remove:_,drag:d}),ve(D,a=>{a&&W(a,{isCheck:!0})});function p(){return C.value.classList.contains("selected")}function V(a){y("hideContext");const n=a.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(k=>k.classList.remove("selected")),n||(a.target.classList.add("selected"),s.pickTimeToolRef.remove())}function F(a){a.target.classList.remove("selected"),_()}function Z({time:a,price:n}){let l={lineType:"pattern",price:n,lineWidth:1,lineStyle:1,draggable:!0};if(t.isSet(h.A))if(t.isSet(h.B)){let I,E;if(t.isSet(h.C)){let L,b;u.A={time:a,price:n};const{progress:P,timeMark:M,info:{rEpr1:X,rEpr2:U,rEpr3:re,entry:te,pStatus:ie,x:ne,X:j,y:Q,Y}}=r();E=P,I=M,L="A",b={price:n,title:`A ${X}`},h[L].applyOptions(b),L="B",b={title:`B ${U}`},h[L].applyOptions(b),L="C",b={title:`C ${re}`},h[L].applyOptions(b),L="D",b={price:te,title:"Entry "+ie},h[L].applyOptions(b),L="X",b={price:t.fmtNum(ne),title:`X ${t.fmtNum(j)}`},h[L].applyOptions(b),L="Y",b={price:t.fmtNum(Q),title:`Y ${t.fmtNum(Y)}`},h[L].applyOptions(b)}else{u.C={price:n};const{progress:L,timeMark:b,info:{rEpr1:P,rEpr2:M,rEpr3:X,entry:U,pStatus:re,x:te,X:ie,y:ne,Y:j}}=r();E=L,I=b;let Q="A";h[Q].applyOptions({title:`A ${P}`}),Q="B",h[Q].applyOptions({title:`B ${M}`}),l.point="C",l.title=`C ${X}`,l.color="#FFEB3B",h[l.point]=s.priceSeries.createPriceLine(l),l.point="D",l.price=U,l.title="Entry "+re,l.color="#9C27B0",l.draggable=!1,h[l.point]=s.priceSeries.createPriceLine(l),l.point="Y",l.price=t.fmtNum(ne),l.title=`Y ${t.fmtNum(j)}`,l.color="#E91E63",l.draggable=!1,h[l.point]=s.priceSeries.createPriceLine(l),l.point="X",l.price=t.fmtNum(te),l.title=`X ${t.fmtNum(ie)}`,l.color="#2196F3",l.draggable=!1,h[l.point]=s.priceSeries.createPriceLine(l)}v(),y("setProgress",E),e(I),C.value.classList.remove("selected")}else l.point="B",l.title="B 0",l.color="#4CAF50",h[l.point]=s.priceSeries.createPriceLine(l),u.B={price:n};else l.point="A",l.title="A 0",l.color="#F44336",h[l.point]=s.priceSeries.createPriceLine(l),u={A:{time:a,price:n}}}function W(a,{isSave:n=!1,isCheck:k=!1}){u=t.cloneDeep(a),n&&v(),(k?i(u):!0)&&(x(),A())}function A(){let n={lineType:"pattern",lineWidth:1,lineStyle:1,draggable:!0};const{A:k,B:l,C:I}=u,{progress:E,timeMark:L,info:{rEpr1:b,rEpr2:P,rEpr3:M,entry:X,pStatus:U,x:re,X:te,y:ie,Y:ne}}=r();y("setProgress",E),e(L),n.point="A",n.title=`A ${b}`,n.color="#F44336",n.price=k.price,h[n.point]=s.priceSeries.createPriceLine(n),n.point="B",n.title=`B ${P}`,n.color="#4CAF50",n.price=l.price,h[n.point]=s.priceSeries.createPriceLine(n),n.point="C",n.price=I.price,n.title=`C ${M}`,n.color="#FFEB3B",h[n.point]=s.priceSeries.createPriceLine(n),n.point="D",n.price=X,n.title="Entry "+U,n.color="#9C27B0",n.draggable=!1,h[n.point]=s.priceSeries.createPriceLine(n),n.point="Y",n.price=t.fmtNum(ie),n.title=`Y ${t.fmtNum(ne)}`,n.color="#E91E63",n.draggable=!1,h[n.point]=s.priceSeries.createPriceLine(n),n.point="X",n.price=t.fmtNum(re),n.title=`X ${t.fmtNum(te)}`,n.color="#2196F3",n.draggable=!1,h[n.point]=s.priceSeries.createPriceLine(n)}function S(a=!1){t.isSet(h.C)&&(a&&g(),x(),A())}function r(){const{A:a,B:n,C:k}=u,l=n.price-k.price,I=l>0,E=m({phase:1,start:a,end:n,retracementPrice:k.price});let L=m({phase:2,start:E.R,end:k});const b=m({phase:3,start:L.R,end:{price:n.price+(I?1:-1)*E.rEp},breakPrices:[L.S1.price,n.price]});E.xBox.tr>=L.tr&&(L.tr=E.xBox.tr),console.log("calculatePattern",[E,L,b]);const P=t.fmtNum(l,1,!0)>=E.pr,M=t.fmtNum(k.price-b.xBox.R.price,1,!0)>=L.pr,X=t.fmtNum(b.xBox.pr)>=b.pr,U=!t.cmp(k.price,!I,E.S1.price),re=!t.cmp(b.xBox.R.price,I,L.S1.price),te=!t.cmp(b.xBox.S.price,!I,b.S1.price),ie=E.R.index+E.tr,ne=E.R.index+5*E.tr,j=L.R.index+L.tr,Q=b.xBox.R.index+b.tr,Y=b.xBox.R.index+5*b.tr,oe=b.xBox.R.index+L.tr,Pe=[ie,ne,j,Q,Y,oe],le=b.xBox.S.index;let he,q={};const Ce=[L.R.index>ie,E.rEpr<3,L.rEpr<E.rEpr];q.steps=[[P||E.rEt<E.tr&&E.rEp>=E.sEp,U,!b.breakIndexs[1]||ie<b.breakIndexs[1],le>ie,le<ne],[...Ce,j>ie,le<Y,le<j],[L.R.index-E.R.index>.5*E.tr,M,!b.breakIndexs[1]||j<b.breakIndexs[1],le>j],[X,te,le>Q,Ce.every(Boolean)||le>oe]],q.step=1,q.result=q.steps[0].every(Boolean),he=E.R1.price,q.result&&(le<=j?(q.step=2,q.result=q.steps[1].every(Boolean),he=L.S1.price):(q.step=3,q.result=q.steps[2].every(Boolean),he=b.R1.price,q.result&&(q.step=4,q.result=q.steps[3].every(Boolean),q.result&&(he=b.xBox.R.price))));const Ie=`${U?P?1:0:2}${re?M?1:0:2}${te?X?1:0:2}`,ge=E.rEp,$e=c(n.price,ge,I),Ae=b.breakIndexs[1]??le,be=parseInt((Ae-E.R.index)/E.tr),we=be>1?ge*be:ge,Ne=c(n.price,we,I);return{progress:q,timeMark:Pe,info:{rEpr1:E.rEpr,rEpr2:L.rEpr,rEpr3:b.rEpr,entry:he,pStatus:Ie,x:$e,X:ge,y:Ne,Y:we}}}function m({phase:a,start:n,end:k,breakPrices:l,retracementPrice:I}){let E=t.cloneDeep(n),L=t.cloneDeep(k);const b=L.price>E.price;let P={},M={},X={},U=[null,null],re,te,ie;const ne=s.pickTimeToolRef.get();return s.prices.filter(j=>{let Q=j.time>=E.time;return ne&&(Q&=j.time<=ne),Q}).every((j,Q)=>{const Y=j.value,oe=s.timeToIndex(j.time);return oe===-1?!1:((Q===0||Y===E.price)&&(P={R:{index:oe,price:Y},S:{index:oe,price:Y},pr:0,tr:0},M=t.cloneDeep(P),X=t.cloneDeep(P)),t.cmp(Y,b,P.R.price)?(P.pr>0&&(P.pr>=M.pr&&(M.pr=P.pr,M.R=t.cloneDeep(P.R),M.S=t.cloneDeep(P.S)),P.tr>M.tr&&(M.tr=P.tr),a===1&&I&&!t.cmp(P.S.price,!b,I)&&P.tr>=X.tr&&P.pr>=X.pr&&(X=t.cloneDeep(P))),P={R:{index:oe,price:Y},S:{index:oe,price:Y},pr:0,tr:0},a===3&&l&&(!U[0]&&t.cmp(Y,b,l[0])&&(U[0]=oe),!U[1]&&t.cmp(Y,b,l[1])&&(U[1]=oe))):(P.S.index=oe,P.tr=P.S.index-P.R.index,t.cmp(Y,!b,P.S.price)&&(P.S.price=Y,P.pr=t.fmtNum(P.S.price-P.R.price,1,!0))),t.cmp(Y,!b,E.price)?(P.S.price=E.price,!1):!!t.cmp(Y,!b,L.price))}),t.isSet(P)&&(E.index=s.timeToIndex(E.time),L.index=P.S.index,L.time=s.indexToTime(P.S.index),re=t.fmtNum(L.price-M.R.price,1,!0),te=t.fmtNum(E.price-M.S.price,1,!0),ie=L.index-M.S.index,a===3&&(X=P)),{tr:M.tr,pr:M.pr,rEp:re,sEp:te,rEpr:M.pr?t.fmtNum(re/M.pr):0,rEt:ie,S1:M.S,R1:M.R,xBox:X,S:E,R:L,breakIndexs:U}}function i({A:{time:a}}){return a>=s.prices[0].time&&a<s.prices.at(-1).time}function c(a,n,k){const l=a+(k?1:-1)*n;let I=t.fmtNum(l%1);if(k){if(I>=.1&&I<=.2)return Math.floor(l);if(I>=.6&&I<=.7)return Math.floor(l)+.5}else{if(I>=.8&&I<=.9)return Math.ceil(l);if(I>=.3&&I<=.4)return Math.floor(l)+.5}return l}function g(){if(!s.pickTime)return!1;const a=u.B.price-u.A.price>0,n=s.prices.at(-1).value;if(t.cmp(n,!a,u.C.price)){let k=n;for(let l=s.prices.length-1;l>=0;l--){const I=s.prices[l].value;if(I===u.B.price)break;k=a?Math.min(k,I):Math.max(k,I)}u.C.price=k,v()}}function v(a=!1){let n={isRemove:a,name:"pattern",points:[],data:[]};a?u={}:Object.entries(u).forEach(([k,l])=>{n.points.push(k),n.data.push(l)}),f.dispatch("tradingDerivative/drawTools",n)}function _(){v(!0),s.pickTimeToolRef.remove(),x(),y("setProgress",{})}function x(){t.isSet(h.A)&&(s.priceSeries.removePriceLine(h.A),t.isSet(h.B)&&(s.priceSeries.removePriceLine(h.B),t.isSet(h.C)&&(s.priceSeries.removePriceLine(h.C),s.priceSeries.removePriceLine(h.D),s.priceSeries.removePriceLine(h.X),s.priceSeries.removePriceLine(h.Y)))),h={},e([])}function e(a){const n=["#F44336","#F44336","#4CAF50","#FFEB3B","#FFEB3B","#2196F3"];let k=[];for(let l=0;l<a.length;l++){let I=s.indexToTime(a[l]);I&&(a.indexOf(a[l])!==a.lastIndexOf(a[l])&&(I+=l),k.push({time:I,value:1,color:n[l]}))}k.length&&k.sort((l,I)=>l.time-I.time),s.timeMarkSeries.setData(k)}function d({lineOptions:a}){if(t.isSet(h.C)){let n,k;u={A:{time:u.A.time,price:+h.A.options().price},B:{price:+h.B.options().price},C:{price:+h.C.options().price}},v();const{progress:l,timeMark:I,info:{rEpr1:E,rEpr2:L,rEpr3:b,entry:P,pStatus:M,x:X,X:U,y:re,Y:te}}=r();y("setProgress",l),e(I),n="A",k={title:`A ${E}`},h[n].applyOptions(k),n="B",k={title:`B ${L}`},h[n].applyOptions(k),n="C",k={title:`C ${b}`},h[n].applyOptions(k),n="D",k={price:P,title:"Entry "+M},a.point===n&&delete k.price,h[n].applyOptions(k),n="X",k={price:t.fmtNum(X),title:`X ${t.fmtNum(U)}`},h[n].applyOptions(k),n="Y",k={price:t.fmtNum(re),title:`Y ${t.fmtNum(te)}`},h[n].applyOptions(k)}}return(a,n)=>(H(),J("div",{ref_key:"patternToolRef",ref:C,class:"command",title:a.$t("trading.derivative.patternTool"),onClick:V,onContextmenu:F},Ut,40,jt))}},Gt=["title"],Kt=B("i",{class:"far fa-pipe"},null,-1),ei=[Kt],ti={__name:"PickTimeTool",props:["pickTimeSeries"],emits:["refreshPattern","hideContext"],setup(R,{expose:$,emit:T}){const f=me(),t=R,s=T,y=N(null),C=ce(()=>f.state.tradingDerivative.tools.pickTime);let D=null;$({isSelected:u,draw:F,remove:W,get:h}),ve(C,A=>{A&&Z(A[0])});function u(){return y.value.classList.contains("selected")}function h(){return D}function p(A){s("hideContext");const S=A.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(r=>r.classList.remove("selected")),S||A.target.classList.add("selected")}function V(A){A.target.classList.remove("selected"),W(),s("refreshPattern")}function F({time:A}){f.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"pickTime",points:[0],data:[A]}),Z(A),s("refreshPattern"),y.value.classList.remove("selected")}function Z(A){D=A,t.pickTimeSeries.setData([{time:A,value:1,color:"#9C27B0"}])}function W(A=!0){A&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"pickTime"}),t.pickTimeSeries.setData([]),D=null}return(A,S)=>(H(),J("div",{ref_key:"pickTimeToolRef",ref:y,class:"command",title:A.$t("trading.derivative.pickTimeTool"),onClick:p,onContextmenu:V},ei,40,Gt))}};const ii=B("div",{class:"triangle-shadow"},null,-1),ni=B("div",{class:"triangle"},null,-1),ri={class:"input"},si={class:"color"},oi=["onClick"],ai={__name:"LineContext",props:["enable","title","color"],emits:["update:title","update:color"],setup(R,{emit:$}){const T=R,f=$,t=N(null),s=N(["#F44336","#FF9800","#FFEB3B","#4CAF50","#009688","#00BCD4","#2196F3","#673AB7","#9C27B0","#E91E63"]);ve(()=>T.enable,h=>{h&&vt().then(()=>t.value.instance.focus())});function y({value:h}){f("update:title",h)}function C(h){f("update:color",h)}function D(){f("deleteAllLine")}function u(h){h.stopPropagation()}return(h,p)=>{const V=Ke("DxButton");return H(),J("div",{class:"line-context",onClick:u},[ii,ni,B("div",ri,[ee(tt(Ct),{ref_key:"titleRef",ref:t,value:T.title,"show-clear-button":!0,"input-attr":{style:`color:${T.color}`},onValueChanged:y},null,8,["value","input-attr"]),ee(V,{icon:"trash",type:"danger",onClick:p[0]||(p[0]=F=>D())})]),B("div",si,[(H(!0),J(Me,null,Ve(s.value,(F,Z)=>(H(),J("div",{class:"color-swatch",style:ht({background:F,boxShadow:`0 0 4px ${F}`}),key:Z,onClick:W=>C(F)},null,12,oi))),128))])])}}},ci=["title"],li=B("i",{class:"far fa-horizontal-rule"},null,-1),pi={__name:"LineTool",props:["priceSeries"],emits:["hideContext"],setup(R,{expose:$,emit:T}){const f=me(),t=R,s=T,y=N(null),C=N(!1),D=ce(()=>f.state.tradingDerivative.tools.line),u=N(""),h=N("#F44336");let p=[];$({isSelected:V,hide:F,draw:A,drag:i}),ve(D,c=>{c&&S(c)});function V(){return y.value.classList.contains("selected")}function F(c){C.value=c}function Z(c){s("hideContext");const g=c.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(v=>v.classList.remove("selected")),g||c.target.classList.add("selected")}function W(c){const g=C.value;s("hideContext"),C.value=!g}function A({price:c}){const g="line",v=p.length;if(p=p.filter(_=>{const x=_.options(),e=x.type=c===+x.price;return e&&(t.priceSeries.removePriceLine(_),f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:g,point:c})),!e}),p.length===v){const _=h.value,x=u.value,e={lineType:g,price:c,color:_,title:x,lineWidth:1,lineStyle:1,draggable:!0};p.push(t.priceSeries.createPriceLine(e)),f.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:g,points:[c],data:[{color:_,title:x}]})}y.value.classList.remove("selected")}function S(c){m(!1),r(c)}function r(c){const v={lineType:"line",lineWidth:1,lineStyle:1,draggable:!0};Object.entries(c).forEach(([_,{color:x,title:e}])=>{v.price=+_,v.color=x,v.title=e,p.push(t.priceSeries.createPriceLine(v))})}function m(c=!0){p.length>0&&(c&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line"}),p.forEach(g=>t.priceSeries.removePriceLine(g)),p=[])}function i({lineOptions:c,oldPrice:g,newPrice:v}){f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line",point:g});const _=c.color,x=c.title;f.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"line",points:[v],data:[{color:_,title:x}]}),y.value.classList.remove("selected")}return(c,g)=>(H(),J("div",{ref_key:"lineToolRef",ref:y,class:"context command",title:c.$t("trading.derivative.lineTool"),onClick:Z,onContextmenu:W},[li,Te(ee(ai,{class:"contextmenu",enable:C.value,title:u.value,"onUpdate:title":g[0]||(g[0]=v=>u.value=v),color:h.value,"onUpdate:color":g[1]||(g[1]=v=>h.value=v),onDeleteAllLine:m},null,8,["enable","title","color"]),[[_e,C.value]])],40,ci))}},di=["title"],ui=B("i",{class:"far fa-grip-lines-vertical"},null,-1),fi=[ui],mi={__name:"TimeRangeTool",props:["timeRangeSeries","timeToIndex","indexToTime"],emits:["hideContext"],setup(R,{expose:$,emit:T}){const f=me(),t=fe("mf"),s=R,y=T,C=N(null),D=ce(()=>f.state.tradingDerivative.tools.timeRange);let u=[];$({isSelected:h,draw:F}),ve(D,S=>{S&&Z(S)});function h(){return C.value.classList.contains("selected")}function p(S){y("hideContext");const r=S.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(m=>m.classList.remove("selected")),r||S.target.classList.add("selected")}function V(S){A(),S.target.classList.remove("selected")}function F({time:S}){let r={isRemove:!1,name:"timeRange",points:[],data:[]},m={time:S,value:1};switch(u.length){case 0:m.color="OrangeRed",u[0]=m,r.points.push(0),r.data.push(S);break;case 1:m.color="lime",u[1]=m,r.points.push(1),r.data.push(S),C.value.classList.remove("selected");break;default:const i=s.timeToIndex(u[0].time),c=s.timeToIndex(u[1].time),v=s.timeToIndex(S)+(c-i),_=s.indexToTime(v);m.color="OrangeRed",u[0]=t.cloneDeep(m),r.points.push(0),r.data.push(S),m.time=_,m.color="lime",u[1]=m,r.points.push(1),r.data.push(_),C.value.classList.remove("selected");break}s.timeRangeSeries.setData(u),f.dispatch("tradingDerivative/drawTools",r)}function Z(S){A(!1),W(S)}function W(S){let r,m;if(S.length===2)r=S[0],m=S[1];else if(S.length===3){const c=s.timeToIndex(S[0]),g=s.timeToIndex(S[1]),_=s.timeToIndex(S[2])+(g-c);r=S[2],m=s.indexToTime(_)}else return!1;let i=[{time:r,value:1,color:"OrangeRed"},{time:m,value:1,color:"lime"}];u=i,s.timeRangeSeries.setData(i)}function A(S=!0){S&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"timeRange"}),s.timeRangeSeries.setData([]),u=[]}return(S,r)=>(H(),J("div",{ref_key:"timeRangeToolRef",ref:C,class:"command",title:S.$t("trading.derivative.timeRangeTool"),onClick:p,onContextmenu:V},fi,40,di))}},vi=["title"],hi=B("i",{class:"far fa-line-height"},null,-1),gi=[hi],Si={__name:"TargetTool",props:["priceSeries"],emits:["hideContext"],setup(R,{expose:$,emit:T}){const f=me(),t=fe("mf"),s=R,y=T,C=N(null),D=ce(()=>f.state.tradingDerivative.tools.target);let u={};$({isSelected:h,draw:F,drag:S}),ve(D,r=>{r&&Z(r)});function h(){return C.value.classList.contains("selected")}function p(r){y("hideContext");const m=r.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),m||(r.target.classList.add("selected"),A())}function V(r){A(),r.target.classList.remove("selected")}function F({price:r}){const m="target";let i={lineType:m,price:r,lineWidth:1,lineStyle:1,draggable:!0},c={isRemove:!1,name:m,points:[],data:[r]};if(t.isSet(u.A)){const g=+u.A.options().price,v=r-g;i.point="B",i.title=t.fmtNum(v),i.color="#F44336",u[i.point]=s.priceSeries.createPriceLine(i),c.points.push(i.point),i.point="X",i.price=t.fmtNum(g-.5*v),i.title=t.fmtNum(-.5*v),i.color="#2196F3",u[i.point]=s.priceSeries.createPriceLine(i),i.point="Y",i.price=t.fmtNum(g-v),i.title=t.fmtNum(-v),i.color="#673AB7",u[i.point]=s.priceSeries.createPriceLine(i),i.point="Z",i.price=t.fmtNum(g-2*v),i.title=t.fmtNum(-2*v),i.color="#9C27B0",u[i.point]=s.priceSeries.createPriceLine(i),i.point="W",i.price=t.fmtNum(g-4*v),i.title=t.fmtNum(-4*v),i.color="#E91E63",u[i.point]=s.priceSeries.createPriceLine(i),C.value.classList.remove("selected")}else i.point="A",i.title="0",i.color="#FF9800",u[i.point]=s.priceSeries.createPriceLine(i),c.points.push(i.point);f.dispatch("tradingDerivative/drawTools",c)}function Z(r){A(!1),W(r)}function W(r){let i={lineType:"target",lineWidth:1,lineStyle:1,draggable:!0};const c=r.A,g=r.B,v=g-c;i.point="A",i.price=c,i.title="0",i.color="#FF9800",u[i.point]=s.priceSeries.createPriceLine(i),i.point="B",i.price=g,i.title=t.fmtNum(v),i.color="#F44336",u[i.point]=s.priceSeries.createPriceLine(i),i.point="X",i.price=t.fmtNum(c-.5*v),i.title=t.fmtNum(-.5*v),i.color="#2196F3",u[i.point]=s.priceSeries.createPriceLine(i),i.point="Y",i.price=t.fmtNum(c-v),i.title=t.fmtNum(-v),i.color="#673AB7",u[i.point]=s.priceSeries.createPriceLine(i),i.point="Z",i.price=t.fmtNum(c-2*v),i.title=t.fmtNum(-2*v),i.color="#9C27B0",u[i.point]=s.priceSeries.createPriceLine(i),i.point="W",i.price=t.fmtNum(c-4*v),i.title=t.fmtNum(-4*v),i.color="#E91E63",u[i.point]=s.priceSeries.createPriceLine(i)}function A(r=!0){r&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"target"}),t.isSet(u.A)&&(s.priceSeries.removePriceLine(u.A),t.isSet(u.B)&&(s.priceSeries.removePriceLine(u.B),s.priceSeries.removePriceLine(u.X),s.priceSeries.removePriceLine(u.Y),s.priceSeries.removePriceLine(u.Z),s.priceSeries.removePriceLine(u.W))),u={}}function S({lineOptions:r,newPrice:m}){if(t.isSet(u.B)){let i={isRemove:!1,name:"target",points:[],data:[]},c,g,v=+u.A.options().price,_=+u.B.options().price,x=_-v;if(c="A",r.point==="A")x=+u.B.options().title,_=v+x;else if(r.point!=="B"){let e=0;switch(r.point){case"X":e=1.5;break;case"Y":e=2;break;case"Z":e=3;break;case"W":e=5;break}x=t.fmtNum((_-m)/e),v=_-x,g={price:v},u[c].applyOptions(g)}i.points.push(c),i.data.push(v),c="B",g={price:_,title:t.fmtNum(x)},r.point===c&&delete g.price,u[c].applyOptions(g),i.points.push(c),i.data.push(_),c="X",g={price:t.fmtNum(v-.5*x),title:t.fmtNum(-.5*x)},r.point===c&&delete g.price,u[c].applyOptions(g),c="Y",g={price:t.fmtNum(v-x),title:t.fmtNum(-x)},r.point===c&&delete g.price,u[c].applyOptions(g),c="Z",g={price:t.fmtNum(v-2*x),title:t.fmtNum(-2*x)},r.point===c&&delete g.price,u[c].applyOptions(g),c="W",g={price:t.fmtNum(v-4*x),title:t.fmtNum(-4*x)},r.point===c&&delete g.price,u[c].applyOptions(g),f.dispatch("tradingDerivative/drawTools",i)}}return(r,m)=>(H(),J("div",{ref_key:"targetToolRef",ref:C,class:"command",title:r.$t("trading.derivative.targetTool"),onClick:p,onContextmenu:V},gi,40,vi))}},yi=["title"],Ue=3,Qe=2,Ti={__name:"OrderTool",props:["position","prices","priceSeries","inSession","TIME"],emits:["getTools","showEntry","showTpSl","orderChanged","hideContext"],setup(R,{expose:$,emit:T}){const f=me(),{t}=Oe(),s=fe("mf"),y=R,C=T,D=N(null),u=N(!1),h=ce(()=>f.state.tradingDerivative.tools.order);let p={side:0,entry:{},tp:{},sl:{}},V=!1;$({show:Z,entry:W,tpsl:A,cancel:S,cancelWithoutClose:r,scan:m,drag:_}),ve(h,e=>{e&&c(e)});function F(){return s.isSet(p.entry.line)||s.isSet(p.tp.line)}function Z({price:e}){if(e&&y.inSession()){const d=G(ke(new Date,7));if(s.isSet(p.entry.line))!s.isSet(p.tp.line)&&y.position&&d>y.TIME.ATO&&d<y.TIME.ATC&&C("showTpSl",{side:y.position});else{let a=null,n=0;y.position?(d<y.TIME.ATO?a="ATO":d>y.TIME.ATC&&(a="ATC"),a&&(p.entry.price=a,n=-y.position)):d>y.TIME.ATO&&d<y.TIME.ATC&&(a=e,n=a>=y.prices.at(-1).value?1:-1,p.side=n,p.entry.price=a),n&&C("showEntry",{side:n,price:a})}}}function W(){if(y.inSession()){const e=G(ke(new Date,7));e<y.TIME.ATO?qe(t("trading.derivative.atoOrder"),t("titles.confirm")).then(a=>{a&&f.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(n=>{n.isOk?se.success(t("trading.derivative.atoOrderSuccess")):x(n.message)})}):e>y.TIME.ATC?qe(t("trading.derivative.atcOrder"),t("titles.confirm")).then(a=>{a&&f.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(n=>{n.isOk?se.success(t("trading.derivative.atcOrderSuccess")):x(n.message)})}):f.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"new",side:p.side,price:p.entry.price}}).then(d=>{d.isOk?(i(["entry"]),se.success(t("trading.derivative.newEntrySuccess"))):x(d.message)})}}function A(){p.tp.price=p.entry.price+p.side*Ue,p.sl.price=p.entry.price-p.side*Qe,f.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:p.tp.price},slData:{cmd:"new",price:p.sl.price}}).then(e=>{e.isOk?(p.entry.line.applyOptions({draggable:!1}),i(["entry","tp","sl"]),se.success(t("trading.derivative.newTpSlSuccess"))):x(e.message)})}function S(){s.isSet(p.entry.line)?s.isSet(p.tp.line)?f.dispatch("tradingDerivative/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(e=>{e.isOk?(v(["entry","tp","sl"]),se.success(t("trading.derivative.exitSuccess"))):x(e.message)}):f.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"delete"}}).then(e=>{e.isOk?(v(["entry"]),se.success(t("trading.derivative.deleteEntrySuccess"))):x(e.message)}):C("getTools")}function r(){if(y.inSession()&&y.position){const e=G(ke(new Date,7));e>y.TIME.ATC-5*60&&(u.value=!0,e>y.TIME.ATC-15&&s.isSet(p.tp.line)&&f.dispatch("tradingDerivative/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(d=>{d.isOk?(v(["entry","tp","sl"]),se.success(t("trading.derivative.autoCancelTpSlSuccess"))):x(d.message)}))}}function m(e){if(s.isSet(p.entry.line)){const d=p.side>0;s.isSet(p.tp.line)?(s.cmp(e,d,p.tp.price,!0)&&(V||(V=!0,f.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"delete"}}).then(a=>{a.isOk?(v(["entry","tp","sl"]),se.success(t("trading.derivative.deleteTpSuccess"))):x(a.message),V=!1}))),s.cmp(e,!d,p.sl.price,!0)&&(V||(V=!0,f.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"cancel"}}).then(a=>{a.isOk?(v(["entry","tp","sl"]),se.success(t("trading.derivative.deleteSlSuccess"))):x(a.message),V=!1})))):s.cmp(e,d,p.entry.price,!0)&&(V||(V=!0,setTimeout(()=>{p.tp.price=p.entry.price+p.side*Ue,p.sl.price=p.entry.price-p.side*Qe,f.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:p.tp.price},slData:{cmd:"new",price:p.sl.price}}).then(a=>{a.isOk?(p.entry.line.applyOptions({draggable:!1}),i(["entry","tp","sl"]),se.success(t("trading.derivative.autoNewTpSlSuccess"))):x(a.message),V=!1})},1e3)))}}function i(e){const d="order";let a={isRemove:!1,name:d,points:[],data:[]},n,k;e.forEach(l=>{const I=p.entry.price,E=p.tp.price,L=p.sl.price;switch(l){case"entry":n="yellow",k=p.side>0?"LONG":"SHORT";break;case"tp":n="lime",k=s.fmtNum(E-I,1,!0);break;case"sl":n="red",k=s.fmtNum(L-I,1,!0);break}if(a.points.push(l),s.isSet(p[l].line))p[l].line.applyOptions({price:p[l].price,title:k}),a.data.push(p[l].line.options());else{const b={lineType:d,kind:l,side:p.side,price:p[l].price,color:n,lineWidth:1,lineStyle:0,title:k,draggable:!0};p[l].line=y.priceSeries.createPriceLine(b),a.data.push(b)}}),f.dispatch("tradingDerivative/drawTools",a),C("orderChanged",F())}function c(e){v(["entry","tp","sl"],!1),g(e),C("orderChanged",F())}function g(e){Object.entries(e).forEach(([d,a])=>{d==="entry"&&(p.side=a.side),p[d].price=a.price,p[d].line=y.priceSeries.createPriceLine(a)})}function v(e,d=!0){d&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"order"}),e.forEach(a=>{s.isSet(p[a].line)&&(y.priceSeries.removePriceLine(p[a].line),delete p[a].line)}),C("orderChanged",F())}function _({line:e,lineOptions:d,oldPrice:a,newPrice:n}){if(n!==a){let k=!1;d.kind==="entry"?y.position||(k=!0,p[d.kind].price=n,f.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"change",price:p.entry.price}}).then(l=>{l.isOk?(i([d.kind]),se.success(t("trading.derivative.changeEntrySuccess"))):(e.applyOptions({price:a}),x(l.message))})):(k=!0,p[d.kind].price=n,d.kind==="tp"?f.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"change",price:p.tp.price}}).then(l=>{l.isOk?(i([d.kind]),se.success(t("trading.derivative.changeTpSuccess"))):(e.applyOptions({price:a}),x(l.message))}):f.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"change",price:p.sl.price}}).then(l=>{l.isOk?(i([d.kind]),se.success(t("trading.derivative.changeSlSuccess"))):(e.applyOptions({price:a}),x(l.message))})),k||(e.applyOptions({price:a}),se.show(t("trading.derivative.noChangeOrderLine")))}}function x(e){e||(e="unknown"),se.error(t(`trading.derivative.${e}`))}return(e,d)=>(H(),J("div",{ref_key:"orderToolRef",ref:D,class:"cancel-order command",title:e.$t("trading.derivative.orderTool"),onClick:S},[B("i",{class:ae(["far fa-trash-alt",{blink:u.value}])},null,2)],8,yi))}};const xi=["title"],Ci=["title"],ki=["title"],_i=["title"],bi="wss://tradestation.fireant.vn/quote?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",wi="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",Oi={__name:"Chart",setup(R,{expose:$}){const T=me(),f=Tt(),{t}=Oe(),s=fe("devices"),y=fe("mf"),C=fe("filters"),D=N(null),u=N(null),h=N(null),p=N(null),V=N(null),F=N(null),Z=N(null),W=N(null),A=N(null),S=N(null),r=N(null),m=N(null),i=N(null),c=N(null),g=N(null),v={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.25,bottom:.25}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:1e3,minBarSpacing:.01,barSpacing:.05}},_=Le(new Date,"yyyy-MM-dd"),x={START:G(new Date(`${_}T08:45:00Z`)),ATO:G(new Date(`${_}T09:00:00Z`)),ATC:G(new Date(`${_}T14:30:00Z`)),END:G(new Date(`${_}T14:45:00Z`))};let e={chart:{},whitespaces:[],crosshair:{},interval1:null,interval30:null,websocket:null,socketStop:!1,vpsUpdatedAt:bt(new Date,61)};const d=gt({prices:[],series:{},chartDate:f.query.date??_,clock:Le(new Date,"HH:mm:ss"),isSocketWarning:!1,hasOrderLine:!1,TIME:x}),a=ce(()=>T.state.tradingDerivative.status),n=ce(()=>T.state.tradingDerivative.config),k=ce(()=>T.state.tradingDerivative.isLoading),l=ce(()=>a.value.position||a.value.pending||d.hasOrderLine);e.interval1=setInterval(()=>{i.value&&i.value.cancelWithoutClose(),d.clock=Le(new Date,"HH:mm:ss")},1e3),e.interval30=setInterval(()=>{De()?(He(),n.value.autoRefresh&&W.value.refresh(!0)):clearInterval(e.interval30)},3e4),ot(),We(()=>{I(),new ResizeObserver(re).observe(D.value),document.addEventListener("keydown",te)}),Ge(()=>{E(),document.removeEventListener("keydown",te),clearInterval(e.interval1),clearInterval(e.interval30),oe(),e.socketStop=!0}),ve(()=>T.state.tradingDerivative.chartData,ie),$({connectSocket:Y});function I(){e.chart=kt(u.value,v),e.chart.subscribeCrosshairMove(X),e.chart.subscribeCustomPriceLineDragged(U),d.series.whitespace=e.chart.addHistogramSeries({priceScaleId:"whitespace",scaleMargins:{top:0,bottom:0},color:"#808080",lastValueVisible:!1,priceLineVisible:!1}),d.series.timeRange=e.chart.addHistogramSeries({priceScaleId:"timeRange",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),d.series.pickTime=e.chart.addHistogramSeries({priceScaleId:"pickTime",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),d.series.timeMark=e.chart.addHistogramSeries({priceScaleId:"timeMark",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),d.series.price=e.chart.addLineSeries({color:"#F5F5F5",priceFormat:{minMove:.1}})}function E(){e.chart&&(e.chart.remove(),e.chart=null)}function L(o){ue(),ge(!1),m.value.isSelected()?m.value.draw({time:e.crosshair.time}):W.value.isSelected()?W.value.draw({time:e.crosshair.time,price:Ee(e.crosshair.y)}):A.value.isSelected()?A.value.draw({time:e.crosshair.time}):Z.value.isSelected()?Z.value.draw({price:Ee(e.crosshair.y)}):r.value.isSelected()?r.value.draw({time:e.crosshair.time}):S.value.isSelected()&&S.value.draw({price:Ee(e.crosshair.y)})}function b(o){ge(!0),o.preventDefault()}function P(o){o.stopPropagation()}function M(o){o.preventDefault(),o.stopPropagation()}function X(o){if(o.time){let O=o.seriesPrices.get(d.series.price);e.crosshair.time=o.time,e.crosshair.price=O}else s.phone||(e.crosshair.time=null,e.crosshair.price=null);o.point!==void 0&&(e.crosshair.x=o.point.x,e.crosshair.y=o.point.y)}function U(o){let O=o.customPriceLine,w=O.options();w.price=y.fmtNum(w.price);const z=+o.fromPriceString,K=w.price;switch(w.lineType){case"order":i.value.drag({line:O,lineOptions:w,oldPrice:z,newPrice:K});break;case"line":Z.value.drag({lineOptions:w,oldPrice:z,newPrice:K});break;case"target":S.value.drag({lineOptions:w,newPrice:K});break;case"pattern":W.value.drag({lineOptions:w});break}}function re(){D.value&&(e.chart.resize(D.value.offsetWidth,D.value.offsetHeight),D.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function te(o){if(o.ctrlKey)switch(o.keyCode){case 219:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing-.01});break;case 221:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing+.01});break}if(o.altKey)switch(o.keyCode){case 219:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()-50);break;case 221:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()+50);break}}function ie(o){d.chartDate===_&&De()||(o.price.length>0&&(e.whitespaces=Q(e.whitespaces,j(d.chartDate))),d.series.whitespace.setData(e.whitespaces),d.prices=Q(d.prices,o.price),d.series.price.setData(d.prices))}function ne(o,O=null){const w=O??n.value.source;let z=[];o.forEach(K=>{let pe,de;w==="FireAnt"?(pe=G(ke(new Date(K.date),7)),de=K.price):(pe=G(new Date(`${_}T${K.time}Z`)),de=K.lastPrice),z.push({time:pe,value:de})}),z.length>1?(d.prices=Q(d.prices,z),d.series.price.setData(d.prices)):(d.prices.push(z[0]),d.series.price.update(z[0]))}function j(o){const O=G(new Date(`${o}T09:00:00Z`)),w=G(new Date(`${o}T11:30:00Z`)),z=G(new Date(`${o}T13:00:00Z`)),K=G(new Date(`${o}T14:30:00Z`)),pe=G(new Date(`${o}T14:00:00Z`));let de=[];for(let Se=O;Se<=K;Se++){if(Se>w&&Se<z)continue;let Xe={time:Se};(Se===pe||Se===K)&&(Xe.value=1),de.push(Xe)}return de}function Q(o,O){return Array.from(new Map([...o,...O].sort((w,z)=>w.time-z.time).map(w=>[w.time,w])).values())}async function Y(){if(De()){await oe();const o=n.value.source==="FireAnt",O=o?bi:wi;e.websocket=new WebSocket(O),e.websocket.onclose=w=>{e.socketStop||(d.isSocketWarning=!0,Y())},o?Pe():(q(),he())}}async function oe(){e.websocket&&e.websocket.readyState===WebSocket.OPEN&&(e.websocket.close(),await new Promise(o=>{const O=setInterval(()=>{(!e.websocket||e.websocket.readyState===WebSocket.CLOSED)&&(e.websocket=null,clearInterval(O),o())},100)}))}function Pe(){T.dispatch("tradingDerivative/setLoading",!0),e.websocket.onopen=o=>{if(e.websocket.readyState===WebSocket.OPEN){let O='{"protocol":"json","version":1}';e.websocket.send(O),O='{"arguments":["VN30F1M"],"invocationId":"0","target":"SubscribeTrades","type":1}',e.websocket.send(O)}},e.websocket.onmessage=o=>{d.isSocketWarning=!1,le(o.data).forEach(w=>{if(!w)return!1;w.type===3?(w.result[0].date.slice(0,10)===_&&(Re(),e.whitespaces=Q(e.whitespaces,j(_)),d.series.whitespace.setData(e.whitespaces),ne(w.result)),T.dispatch("tradingDerivative/setLoading",!1)):w.type===1&&w.target==="UpdateTrades"&&w.arguments[0]==="VN30F1M"&&(console.log("FireAnt",w.arguments[1]),i.value.scan(w.arguments[1].at(-1).price),ne(w.arguments[1]))})}}function le(o){let O=[];return o.split("").forEach(w=>{const z=w.indexOf("{"),K=w.lastIndexOf("}");let pe=null;if(z!==-1&&K!==-1&&K>z){const de=w.substring(z,K+1);de!=="{}"&&(pe=JSON.parse(de))}O.push(pe)}),O}function he(){e.websocket.onopen=o=>{if(e.websocket.readyState===WebSocket.OPEN){const O={action:"join",list:n.value.vn30f1m},w=`42${JSON.stringify(["regs",JSON.stringify(O)])}`;e.websocket.send(w)}},e.websocket.onmessage=o=>{if(d.isSocketWarning=!1,o.data.substr(0,1)==="4"&&o.data.substr(1,1)==="2"){const O=JSON.parse(o.data.substr(2));if(O[0]==="stockps"){const w=O[1].data;w.id===3220&&(console.log("VPS",w),i.value.scan(w.lastPrice),ne([w]))}}}}function q(){St(new Date,new Date(e.vpsUpdatedAt))>60&&(fetch("https://bddatafeed.vps.com.vn/getpschartintraday/VN30F1M").then(o=>o.json()).then(o=>{console.log(o),ne(o,"VPS")}),e.vpsUpdatedAt=new Date)}function Ce(){W.value.refresh()}function Ye(o){W.value.load(o,{isSave:!0})}function ue(){F.value.hide(),m.value.hide(),Z.value.hide()}function ze(o){F.value.set(o)}function Ie(o){d.hasOrderLine=o}function ge(o){o?i.value.show({price:Ee(e.crosshair.y)}):(c.value.style.display="none",g.value.style.display="none")}function $e({side:o,price:O}){c.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-71?-71:1))+"px",c.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-61?-61:1))+"px",c.value.style.background=o>0?"green":"red",c.value.innerText=`${o>0?"LONG":"SHORT"} ${O}`,c.value.style.display="block"}function Ae({side:o}){g.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-61?-61:1))+"px",g.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-51?-51:1))+"px",g.value.style.background=o>0?"green":"red",g.value.style.display="block"}function be(){i.value.entry()}function we(){i.value.tpsl()}function Ne(){e.chart.timeScale().scrollToRealTime()}function De(){const o=G(ke(new Date,7));return n.value.openingMarket&&o>=x.START&&o<=x.END}function rt(){if(!d.chartDate)return!1;Be()}function st(){e.whitespaces=[],d.prices=[],Y(),Be()}function ot(){T.dispatch("tradingDerivative/initChart").then(()=>{Y(),!f.query.date&&n.value.lastOpeningDate&&(d.chartDate=n.value.lastOpeningDate),Be()})}function Be(){T.dispatch("tradingDerivative/getChartData",d.chartDate).then(o=>{o&&Re()})}function He(){T.dispatch("tradingDerivative/getStatus")}function Re(){T.dispatch("tradingDerivative/getTools")}function at(){T.dispatch("tradingDerivative/getAccountInfo").then(o=>{let O="";O+='<div style="width: 200px;">',O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.nav")}</div><div>: ${C.currency(o.nav)}</div></div>`,O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.maxVol")}</div><div>: ${C.numberVnFormat(o.maxVol)}</div></div>`,O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.vm")}</div><div>: ${C.currency(o.vm)}</div></div>`,O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.fee")}</div><div>: ${C.currency(o.fee)}</div></div>`,O+="</div>",xt(O,t("trading.derivative.accountInfo"))})}function Ee(o){return y.fmtNum(d.series.price.coordinateToPrice(o))}function Fe(o){let O=e.whitespaces.findIndex(w=>w.time===o);if(O===-1){const w=Le(new Date(o*1e3),"yyyy-MM-dd"),z=G(new Date(`${w}T11:30:00Z`)),K=G(new Date(`${w}T13:00:00Z`)),pe=G(new Date(`${w}T14:30:00Z`));o>z&&o<K?o=z:o>pe&&(o=pe),O=e.whitespaces.findIndex(de=>de.time===o)}return O}function Je(o){return o<e.whitespaces.length?e.whitespaces[o].time:!1}return(o,O)=>(H(),J("div",{class:"derivative-chart",ref_key:"chartContainerRef",ref:D,onClick:L,onContextmenu:b},[B("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:u},[B("div",{class:"area data-area",onClick:P,onContextmenu:M},[B("div",{ref_key:"connectionRef",ref:h,class:ae(["command",{yellow:a.value.pending,red:n.value.volInValid}]),title:o.$t("trading.derivative.connection"),onClick:He},[B("i",{class:ae(["far",{"fa-link-simple":a.value.connection,"fa-link-simple-slash":!a.value.connection,blink:d.isSocketWarning}])},null,2)],10,xi),B("div",{class:ae(["command status",{green:a.value.position>0,red:a.value.position<0}]),title:o.$t("trading.derivative.position"),onClick:at},ye(a.value.position),11,Ci),B("div",{class:"command clock",onClick:Y},ye(d.clock),1),Te(B("input",{type:"date",class:"chart-date command",title:o.$t("trading.derivative.date"),"onUpdate:modelValue":O[0]||(O[0]=w=>d.chartDate=w),onChange:rt},null,40,ki),[[yt,d.chartDate]]),B("div",{ref_key:"reloadToolRef",ref:p,class:"command",title:o.$t("trading.derivative.reload"),onClick:st,onContextmenu:Re},[B("i",{class:ae(["far fa-sync-alt",{"fa-spin":k.value}])},null,2)],40,_i)],32),B("div",{class:"area tool-area",onClick:P,onContextmenu:M},[ee(Dt,{chartContainerRef:D.value},null,8,["chartContainerRef"]),ee(Lt,{ref_key:"tradingviewRef",ref:V,vpsUser:n.value.vpsUser,vpsSession:n.value.vpsSession,chartContainerRef:D.value},null,8,["vpsUser","vpsSession","chartContainerRef"]),ee(Nt,{ref_key:"progressToolRef",ref:F,position:a.value.position,onRefreshPattern:Ce,onHideContext:ue},null,8,["position"]),ee(Xt,{ref_key:"scanToolRef",ref:m,prices:d.prices,timeToIndex:Fe,onScaned:Ye,onRemovePattern:O[1]||(O[1]=()=>W.value.remove()),onHideContext:ue},null,8,["prices"]),ee(Qt,{ref_key:"patternToolRef",ref:W,prices:d.prices,priceSeries:d.series.price,timeMarkSeries:d.series.timeMark,pickTimeToolRef:A.value,timeToIndex:Fe,indexToTime:Je,onSetProgress:ze,onHideContext:ue},null,8,["prices","priceSeries","timeMarkSeries","pickTimeToolRef"]),ee(ti,{ref_key:"pickTimeToolRef",ref:A,pickTimeSeries:d.series.pickTime,onRefreshPattern:Ce,onHideContext:ue},null,8,["pickTimeSeries"]),ee(pi,{ref_key:"lineToolRef",ref:Z,priceSeries:d.series.price,onHideContext:ue},null,8,["priceSeries"]),ee(mi,{ref_key:"timeRangeToolRef",ref:r,timeRangeSeries:d.series.timeRange,timeToIndex:Fe,indexToTime:Je,onHideContext:ue},null,8,["timeRangeSeries"]),ee(Si,{ref_key:"targetToolRef",ref:S,priceSeries:d.series.price,onHideContext:ue},null,8,["priceSeries"]),Te(ee(Ti,{ref_key:"orderToolRef",ref:i,position:a.value.position,prices:d.prices,priceSeries:d.series.price,inSession:De,TIME:d.TIME,onGetTools:Re,onShowEntry:$e,onShowTpSl:Ae,onOrderChanged:Ie,onHideContext:ue},null,8,["position","prices","priceSeries","TIME"]),[[_e,l.value]])],32),B("div",null,[B("div",{ref_key:"entryOrderRef",ref:c,class:"order-button entry",onClick:be}," Entry ",512),B("div",{ref_key:"tpslOrderRef",ref:g,class:"order-button tpsl",onClick:we}," TP/SL ",512),B("div",{class:"chart-top command far fa-angle-double-right",onClick:Ne})])],512)],544))}};export{Oi as default};
