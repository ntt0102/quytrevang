import{y as wt,u as Lt,c as Et,i as Q,r as y,d as At,e as be,x as Rt,z as _t,w as Se,v as S,f as Dt,g as Ft,h as m,j as ee,A as ce,t as Te,B as M,C as $t,E as Bt,G as z,F as Mt,H as Pe,I as qt,o as Nt}from"./app-09e86fda.js";import It from"./CopyistStatusPopup-dc43c546.js";import{c as Vt,_ as jt}from"./DailyCashFlowPopup-aaf523aa.js";import Wt from"./ColorPicker-57c6b1e3.js";const Xt="/build/assets/spinner-4da4a8c6.gif";class Ht{constructor(){this.create()}create(){return new Promise((O,C)=>{const v=indexedDB.open("orderChart",1);v.onupgradeneeded=o=>{this.store=o.target.result,this.store.createObjectStore("order",{keyPath:"kind"}),this.store.createObjectStore("line",{keyPath:"price"}),this.store.createObjectStore("box",{keyPath:"point"}),this.store.createObjectStore("ruler",{keyPath:"point"}),this.store.createObjectStore("pattern1",{keyPath:"point"}),this.store.createObjectStore("pattern2",{keyPath:"point"}),this.store.createObjectStore("volprofile",{keyPath:"time"}),this.store.createObjectStore("alert",{keyPath:"price"}),this.store.createObjectStore("target",{keyPath:"price"}),O()},v.onsuccess=o=>{this.store=o.target.result,O()},v.onerror=()=>{location.reload(),C()}})}get(O){var C=this.store;return new Promise(function(o,f){var _=C.transaction(O,"readonly");if(Array.isArray(O)){var g=O.map(k=>_.objectStore(k)),$=g.map(v);Promise.all($).then(k=>o(k))}else{var B=_.objectStore(O);v(B).then(k=>o(k))}});function v(o){return new Promise(function(f,_){const g=o.getAll();g.onsuccess=$=>f($.target.result),g.onerror=()=>_()})}}set(O,C){const v=this.store.transaction(O,"readwrite").objectStore(O);Array.isArray(C)?C.length>0&&C.forEach(o=>v.put(o)):v.put(C)}clear(O){var C=this.store;return new Promise(function(v,o){const f=C.transaction(O,"readwrite").objectStore(O).clear();f.onsuccess=()=>{v()},f.onerror=_=>{console.error(`Error to empty Object Store: ${O}`),o()}})}}const s=new Ht,zt="/build/assets/alert-4d705e53.mp3";const Ut={class:"content-block dx-card responsive-paddings"},Yt={class:"area data-area"},Kt=["title"],Gt=["title"],Jt=["title"],Zt={class:"area tool-area"},Qt=["title"],er=["title"],tr=["title"],rr=["title"],ir=["title"],ar=["title"],sr=["title"],or=["title"],nr=["title"],cr=["title"],lr=["title"],dr=["title"],pr=["src"],xe=3,we=2,ur="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",fr=120,hr={__name:"Index",setup(Le){const O={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.05,bottom:.4}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:20,minBarSpacing:.01}},C=moment().format("YYYY-MM-DD"),v={START:moment(C+" 08:45:00").unix(),ATO:moment(C+" 09:00:00").unix(),ATC:moment(C+" 14:30:00").unix(),END:moment(C+" 14:45:00").unix()},o=Lt(),{t:f}=Et(),_=Q("devices"),g=Q("mf"),$=Q("bus"),B=Q("filters"),k=y(null),le=y(null),q=y(null),de=y(null),pe=y(null),ue=y(null),fe=y(null),Ee=y(null),N=y(null),U=y(null),te=y(null),re=y(null),ie=y(null),Y=y(null),I=y(null),D=y(null),V=y(null),Ae=y(null);let e={chart:{},series:{},data:{whitespace:[],original:[],price:[],cash:[]},order:{side:0,entry:{},tp:{},sl:{}},lines:[],ruler:{l0:{},ln1:{},l1:{},pointCount:0},target:{A:{},B:{},X:{}},pattern1:{A:{},B:{},C:{},X:{}},pattern2:{E:{},S:{},T:{}},volprofile:{v1:{},v2:{},poc:{},pointCount:0},box:[],alerts:[],crosshair:{},shark:null,loadWhitespace:!0,interval:null,interval60:null,websocket:null,isAutoOrdering:!1,socketStop:!1,volumeMax:0,socketRefreshTime:moment()};const h=At({chartDate:C,clock:moment().format("HH:mm:ss"),isFullscreen:!1,color:"#F44336",showColorPicker:!1,showTradingView:!1}),T=be(()=>o.state.tradingOrder.status),Re=be(()=>`https://chart.vps.com.vn/tv/?loadLastChart=true&symbol=VN30F1M&u=${o.state.tradingOrder.config.vpsCode}&s=${o.state.tradingOrder.config.vpsSession}&resolution=1`);o.dispatch("tradingOrder/getConfig").then(()=>{se()}),o.dispatch("tradingOrder/getStatus"),e.interval=setInterval(Xe,1e3),e.interval60=setInterval(()=>o.dispatch("tradingOrder/getStatus"),6e4),s.create(),Rt(()=>{e.chart=Vt(le.value,O),k.value.addEventListener("click",De),k.value.addEventListener("contextmenu",_e),e.chart.subscribeCrosshairMove(Fe),e.chart.subscribeCustomPriceLineDragged($e),e.series.whitespace=e.chart.addLineSeries({priceScaleId:"whitespace",visible:!1}),e.series.cash=e.chart.addLineSeries({priceScaleId:"cash",scaleMargins:{top:.61,bottom:.01},color:"yellow",lastValueVisible:!1}),e.series.price=e.chart.addLineSeries({color:"#CCCCCC",priceFormat:{minMove:.1}}),new ResizeObserver(Be).observe(k.value),document.addEventListener("keydown",Me),document.addEventListener("fullscreenchange",qe),o.dispatch("tradingOrder/getChartData",h.chartDate).then(()=>{Ie()})}),_t(()=>{clearInterval(e.interval),clearInterval(e.interval60),e.socketStop=!0,e.websocket.close(),e.websocket=null}),Se(()=>o.state.tradingOrder.chartData,Ve),Se(()=>o.state.tradingOrder.isChartLoading,t=>{de.value.style.display=t?"block":"none"});function _e(t){He(),t.preventDefault()}function De(){oe(),N.value.classList.contains("selected")?j():U.value.classList.contains("selected")?tt():te.value.classList.contains("selected")?at():re.value.classList.contains("selected")?nt():ie.value.classList.contains("selected")?ye():Y.value.classList.contains("selected")&&ft()}function Fe(t){if(t.time){let r=t.seriesPrices.get(e.series.price);e.crosshair.time=t.time,e.crosshair.price=r}else _.phone||(e.crosshair.time=null,e.crosshair.price=null);t.point!=null&&(e.crosshair.x=t.point.x,e.crosshair.y=t.point.y)}function $e(t){let r=t.customPriceLine,i=r.options();i.price=G(i.price);const a=+t.fromPriceString,d=i.price;switch(i.lineType){case"order":if(d!=a){let c=!1;i.kind=="entry"?T.value.position||(c=!0,e.order[i.kind].price=d,o.dispatch("tradingOrder/executeOrder",{action:"entry",data:{cmd:"change",price:e.order.entry.price}}).then(n=>{n.isOk?(L(i.kind),S.success(f("trading.orderChart.changeEntrySuccess"))):(r.applyOptions({price:a}),x(n.message))})):(c=!0,e.order[i.kind].price=d,i.kind=="tp"?o.dispatch("tradingOrder/executeOrder",{action:"tp",data:{cmd:"change",price:e.order.tp.price}}).then(n=>{n.isOk?(L(i.kind),S.success(f("trading.orderChart.changeTpSuccess"))):(r.applyOptions({price:a}),x(n.message))}):o.dispatch("tradingOrder/executeOrder",{action:"sl",data:{cmd:"change",price:e.order.sl.price}}).then(n=>{n.isOk?(L(i.kind),S.success(f("trading.orderChart.changeSlSuccess"))):(r.applyOptions({price:a}),x(n.message))})),c||(r.applyOptions({price:a}),S.show(f("trading.orderChart.noChangeOrderLine")))}break;case"line":s.set("line",{price:a,removed:!0}),s.set("line",i),N.value.classList.remove("selected");break;case"ruler":switch(i.point){case"l0":if(s.set("ruler",i),e.ruler.pointCount==2){const A=+e.ruler.l1.options().title,R=+(d-A).toFixed(1);e.ruler.ln1.applyOptions({price:R}),s.set("ruler",e.ruler.ln1.options());const p=+(d+A).toFixed(1);e.ruler.l1.applyOptions({price:p}),s.set("ruler",e.ruler.l1.options())}break;case"ln1":const c=+e.ruler.l0.options().price,n=d-c;r.applyOptions({title:n.toFixed(1)}),s.set("ruler",r.options()),e.ruler.l1.applyOptions({title:(-n).toFixed(1),price:+(c-n).toFixed(1)}),s.set("ruler",e.ruler.l1.options());break;case"l1":const b=+e.ruler.l0.options().price,w=d-b;r.applyOptions({title:w.toFixed(1)}),s.set("ruler",r.options()),e.ruler.ln1.applyOptions({title:(-w).toFixed(1),price:+(b-w).toFixed(1)}),s.set("ruler",e.ruler.ln1.options());break}break;case"pattern1":if(g.isSet(e.pattern1.X)){const c=+e.pattern1.A.options().price,n=+e.pattern1.B.options().price,b=+e.pattern1.C.options().price,w=n-c;e.pattern1.X.applyOptions({price:+(b+1.5*w).toFixed(1),title:(1.5*w).toFixed(1)}),s.set("pattern1",e.pattern1.X.options())}break;case"pattern2":if(g.isSet(e.pattern2.T)){const c=e.pattern2.E.options(),n=+c.price1,b=+c.price2,w=+c.price3,A=+c.price4,R=+c.price,p=w-b,Z=n-A,xt=w-A,W=R-A;let X,H;i.point=="S"?(H=+e.pattern2.S.options().price,X=R-H):(X=Math.abs(p)>Math.abs(W/2)?p:W/2,H=R-X,e.pattern2.S.applyOptions({price:+H.toFixed(1)}));const ke=H+(Math.abs(W)>Math.abs(xt)?Math.abs(W)>Math.abs(Z)?1:1.5:2)*W,Oe=ke-R;e.pattern2.S.applyOptions({title:`SL=${(-X).toFixed(1)}`}),s.set("pattern2",e.pattern2.S.options()),e.pattern2.E.applyOptions({title:`RR=${(Oe/X).toFixed(1)}`}),s.set("pattern2",e.pattern2.E.options()),e.pattern2.T.applyOptions({price:+ke.toFixed(1),title:`TP=${Oe.toFixed(1)}`}),s.set("pattern2",e.pattern2.T.options())}break;case"alert":s.set("alert",{price:a,removed:!0});const l=e.data.price.slice(-1)[0].value;let u=d>=l?">":"<";r.applyOptions({title:u}),s.set("alert",r.options()),Y.value.classList.remove("selected");break}}function Be(){k.value&&(e.chart.resize(k.value.offsetWidth,k.value.offsetHeight),k.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function Me(t){if(t.ctrlKey||t.metaKey)switch(t.keyCode){case 38:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing+.05});break;case 40:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing-.05});break;case 37:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()-10);break;case 39:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()+10);break;case 96:U.value.click();break;case 97:N.value.click();break;case 98:ue.value.click();break;case 99:pe.value.click();case 100:fe.value.click();break}}function qe(){k.value&&(document.fullscreenElement?(h.isFullscreen=!0,k.value.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(h.isFullscreen=!1,k.value.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}function Ne(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function Ie(){return new Promise(async t=>{T.value.pending&&((await s.get("order")).map(b=>{e.order.side=b.side,e.order[b.kind].price=b.price,L(b.kind),E(!0)}),e.order.tp.hasOwnProperty("line")&&e.order.entry.line.applyOptions({draggable:!1})),(await s.get("line")).forEach(n=>{n.removed||e.lines.push(e.series.price.createPriceLine(n))});const i=await s.get("box");i.length==2&&(e.box=i,e.series.box.setData([i[0].x,i[1].x]),e.box[0].y=e.series.price.createPriceLine(i[0].y),e.box[1].y=e.series.price.createPriceLine(i[1].y));const a=await s.get("ruler");a.length>0&&(e.ruler.pointCount=a.length>1?2:1,a.forEach(n=>{e.ruler[n.point]=e.series.price.createPriceLine(n)}));const d=await s.get("target");d.length>0&&d.forEach(n=>{e.target[n.point]=e.series.cash.createPriceLine(n)});const l=await s.get("pattern1");l.length>0&&l.forEach(n=>{e.pattern1[n.point]=e.series.price.createPriceLine(n)});const u=await s.get("pattern2");u.length>0&&u.forEach(n=>{e.pattern2[n.point]=e.series.price.createPriceLine(n)}),(await s.get("alert")).forEach(n=>{n.removed||e.alerts.push(e.series.price.createPriceLine(n))}),t()})}function Ve(){e.loadWhitespace&&(o.state.tradingOrder.chartData.length>0&&(e.data.whitespace=ae(e.data.whitespace,We())),e.series.whitespace.setData(e.data.whitespace),e.loadWhitespace=!1),e.data.original=ae(o.state.tradingOrder.chartData,e.data.original);let t=e.data.original.reduce((r,i)=>{let a=i.price,d=0;return r.price.length>0&&(a=r.price.slice(-1)[0].value,d=r.cash.slice(-1)[0].value),r.price.push({time:i.time,value:i.price}),r.cash.push({time:i.time,value:d+(i.price-a)*i.volume}),r},{price:[],cash:[]});e.data.price=t.price,e.series.price.setData(t.price),e.data.cash=t.cash,e.series.cash.setData(t.cash)}function je(t){const r=e.data.original.length;if(e.data.original=ae(e.data.original,[t]),e.data.original.length>r){const i=e.data.price.slice(-1)[0].value,a=e.data.cash.slice(-1)[0].value;e.data.price.push({time:t.time,value:t.price}),e.series.price.setData(e.data.price),e.data.cash.push({time:t.time,value:a+(t.price-i)*t.volume}),e.series.cash.setData(e.data.cash)}}function We(){const t=h.chartDate,r=moment(`${t} 09:00:00`).unix(),i=moment(`${t} 11:30:00`).unix(),a=moment(`${t} 13:00:00`).unix(),d=moment(`${t} 14:30:00`).unix();let l=[],u;for(u=r;u<=i;u++)l.push({time:u+7*60*60});for(u=a;u<=d;u++)l.push({time:u+7*60*60});return l}function ae(t,r){return Array.from(new Map([...t,...r].sort((i,a)=>i.time-a.time).map(i=>[i.time,i])).values())}function se(){e.websocket=new WebSocket(ur),e.websocket.onopen=t=>{let r={action:"join",list:o.state.tradingOrder.config.symbol};e.websocket.send(`42${JSON.stringify(["regs",JSON.stringify(r)])}`)},e.websocket.onclose=t=>{if(e.socketStop)return!1;K()&&(he(!0),se(),moment().diff(e.socketRefreshTime,"seconds")>fr&&ne())},e.websocket.onmessage=t=>{if(he(!1),t.data.substr(0,1)==4&&t.data.substr(1,1)==2){const r=JSON.parse(t.data.substr(2));if(r[0]=="stockps"){const i=r[1].data;i.id==3220&&(e.data.original.length>0&&je({time:moment(`${C} ${i.time}`).unix()+7*60*60,price:i.lastPrice,volume:i.lastVol}),Ct(),yt())}}}}function Xe(){const t=moment().unix();K(t)&&(T.value.position&&t>v.ATC-5*60&&(ze(),t>v.ATC-15&&e.order.tp.hasOwnProperty("line")&&o.dispatch("tradingOrder/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(r=>{r.isOk?(P("entry"),P("tp"),P("sl"),E(!1),s.clear("order"),S.success(f("trading.orderChart.autoCancelTpSlSuccess")),J()):x(r.message)})),t==v.START&&se()),h.clock=moment().format("HH:mm:ss")}function He(){if(o.state.tradingOrder.config.openingMarket){const t=moment().unix();if(K(t)&&(e.order.tp.hasOwnProperty("line")||T.value.position&&t>v.ATO&&t<v.ATC&&(e.order.entry.price=e.data.price.slice(-1)[0].value,e.order.side=T.value.position,V.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-61?-61:1))+"px",V.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-51?-51:1))+"px",V.value.style.display="block"),!e.order.entry.hasOwnProperty("line"))){let r=null,i=0;T.value.position?(t<v.ATO?r="ATO":t>v.ATC&&(r="ATC"),r&&(e.order.entry.price=r,i=-T.value.position)):t>v.ATO&&t<v.ATC&&(r=F(e.crosshair.y),i=r>=e.data.price.slice(-1)[0].value?1:-1,e.order.side=i,e.order.entry.price=r),i&&(D.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-71?-71:1))+"px",D.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-61?-61:1))+"px",D.value.style.background=i>0?"green":"red",D.value.innerText=`${i>0?"LONG":"SHORT"} ${r}`,D.value.style.display="block")}}}function oe(){D.value.style.display="none",V.value.style.display="none"}function E(t){I.value.style.display=t?"block":"none"}function ze(){I.value.classList.contains("blink")||I.value.classList.add("blink")}function he(t){t?q.value.classList.contains("blink")||q.value.classList.add("blink"):q.value.classList.contains("blink")&&q.value.classList.remove("blink")}function L(t){let r,i;switch(t){case"entry":r="yellow",i=e.order.side>0?"LONG":"SHORT";break;case"tp":r="lime",i=Math.abs(e.order.tp.price-e.order.entry.price).toFixed(1);break;case"sl":r="red",i=Math.abs(e.order.sl.price-e.order.entry.price).toFixed(1);break}e.order[t].hasOwnProperty("line")?e.order[t].line.applyOptions({price:e.order[t].price,title:i}):e.order[t].line=e.series.price.createPriceLine({lineType:"order",kind:t,price:e.order[t].price,color:r,lineWidth:1,lineStyle:0,title:i,draggable:!0}),s.set("order",{kind:t,price:+e.order[t].price,side:e.order.side})}function P(t){e.order[t].hasOwnProperty("line")&&(e.series.price.removePriceLine(e.order[t].line),delete e.order[t].line)}function Ue(t){h.showTradingView=!h.showTradingView,t.stopPropagation()}function Ye(t){h.showColorPicker=!h.showColorPicker,t.stopPropagation()}function Ke(t){g.isSet(e.pattern1.X)&&(j(+e.pattern1.X.options().price),j(+e.pattern1.Y.options().price),j(+e.pattern1.Z.options().price),j(+e.pattern1.T.options().price)),t.preventDefault(),t.stopPropagation()}function Ge(t){h.showColorPicker=!1;const r=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),r||t.target.classList.add("selected"),t.stopPropagation()}function Je(t){Ze(),t.target.classList.remove("selected"),t.preventDefault(),t.stopPropagation()}function j(t=null,r=null,i=null){const a="line";t||(t=G(F(e.crosshair.y))),r||(r=h.color);const d=e.lines.length;if(e.lines=e.lines.filter(l=>{const u=l.options(),c=u.type=t==+u.price;return c&&(e.series.price.removePriceLine(l),s.set("line",{price:t,removed:!0})),!c}),e.lines.length==d){const l={lineType:a,price:t,color:r,title:i,lineWidth:1,lineStyle:1,draggable:!0};e.lines.push(e.series.price.createPriceLine(l)),s.set("line",l)}N.value.classList.remove("selected")}function Ze(){e.lines.forEach(t=>e.series.price.removePriceLine(t)),e.lines=[],s.clear("line")}function Qe(t){h.showColorPicker=!1;const r=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),r||(t.target.classList.add("selected"),me()),t.stopPropagation()}function et(t){me(),t.target.classList.remove("selected"),t.preventDefault(),t.stopPropagation()}function tt(){const t=F(e.crosshair.y);let r={lineType:"ruler",price:t,lineWidth:1,lineStyle:1,draggable:!0};if(e.ruler.pointCount==0)r.point="l0",r.color="#F44336",r.title="0",e.ruler[r.point]=e.series.price.createPriceLine(r),e.ruler.pointCount++,s.set("ruler",r);else{const i=+e.ruler.l0.options().price,a=t-i;r.point="l1",r.color="#FF9800",r.title=a.toFixed(1),e.ruler[r.point]=e.series.price.createPriceLine(r),s.set("ruler",r);const d=-a;r.point="ln1",r.color="#FF9800",r.title=d.toFixed(1),r.price=+(i+d).toFixed(1),e.ruler[r.point]=e.series.price.createPriceLine(r),s.set("ruler",r),e.ruler.pointCount++,U.value.classList.remove("selected")}}function me(){e.ruler.pointCount>0&&(e.series.price.removePriceLine(e.ruler.l0),e.ruler.pointCount>1&&(e.series.price.removePriceLine(e.ruler.ln1),e.series.price.removePriceLine(e.ruler.l1)),e.ruler={l0:{},ln1:{},l1:{},pointCount:0},s.clear("ruler"))}function rt(t){h.showColorPicker=!1;const r=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),r||(t.target.classList.add("selected"),ve()),t.stopPropagation()}function it(t){ve(),t.target.classList.remove("selected"),t.preventDefault(),t.stopPropagation()}function at(){let r={lineType:"target",price:F(e.crosshair.y,"cash"),lineWidth:2,lineStyle:0,draggable:!1};if(g.isSet(e.target.A)?(r.point="B",r.title="B",r.color="#009688"):(r.point="A",r.title="A",r.color="#009688"),e.target[r.point]=e.series.cash.createPriceLine(r),s.set("target",r),r.point=="B"){const i=+e.target.A.options().price,a=+e.target.B.options().price;r.point="X",r.price=+(i+2*(a-i)).toFixed(1),r.title="X",r.color="#9C27B0",e.target[r.point]=e.series.cash.createPriceLine(r),s.set("target",r),te.value.classList.remove("selected")}}function ve(){g.isSet(e.target.A)&&(e.series.cash.removePriceLine(e.target.A),g.isSet(e.target.B)&&(e.series.cash.removePriceLine(e.target.B),e.series.cash.removePriceLine(e.target.X)),e.target={A:{},B:{},X:{}},s.clear("target"))}function st(t){h.showColorPicker=!1;const r=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),r||(t.target.classList.add("selected"),ge()),t.stopPropagation()}function ot(t){ge(),t.target.classList.remove("selected"),t.preventDefault(),t.stopPropagation()}function nt(){let r={lineType:"pattern1",price:F(e.crosshair.y),lineWidth:1,lineStyle:1,draggable:!0};if(g.isSet(e.pattern1.A)?g.isSet(e.pattern1.B)?g.isSet(e.pattern1.C)||(r.point="C",r.title="C",r.color="#E91E63"):(r.point="B",r.title="B",r.color="#009688"):(r.point="A",r.title="A",r.color="#009688"),e.pattern1[r.point]=e.series.price.createPriceLine(r),s.set("pattern1",r),r.point=="C"){const i=+e.pattern1.A.options().price,a=+e.pattern1.B.options().price,d=+e.pattern1.C.options().price,l=a-i;r.point="X",r.price=+(d+1.5*l).toFixed(1),r.title=(1.5*l).toFixed(1),r.color="#673AB7",e.pattern1[r.point]=e.series.price.createPriceLine(r),s.set("pattern1",r),re.value.classList.remove("selected")}}function ge(){g.isSet(e.pattern1.A)&&(e.series.price.removePriceLine(e.pattern1.A),g.isSet(e.pattern1.B)&&(e.series.price.removePriceLine(e.pattern1.B),g.isSet(e.pattern1.C)&&(e.series.price.removePriceLine(e.pattern1.C),e.series.price.removePriceLine(e.pattern1.X))),e.pattern1={A:{},B:{},C:{},X:{}},s.clear("pattern1"))}function ct(t){h.showColorPicker=!1;const r=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),r||(t.target.classList.add("selected"),ye(!0)),t.stopPropagation()}function lt(t){Ce(),t.target.classList.remove("selected"),t.preventDefault(),t.stopPropagation()}function ye(t=!1){let r={};if(g.isSet(e.pattern2.E)){const Z=e.pattern2.E.options();r={time:Z.time1,value:Z.price1},Ce()}else{if(t)return!1;r={time:e.crosshair.time,value:F(e.crosshair.y)}}const{point2:i,point3:a,point4:d,point5:l}=dt(r);if(i.value==r.value)return!1;const u=a.value-i.value,c=a.value-d.value,n=l.value-d.value,b=Math.abs(u)>Math.abs(n/2)?u:n/2,w=l.value-b,A=w+(Math.abs(n)>Math.abs(c)?1.5:2)*n,R=A-l.value;let p={lineType:"pattern2",lineWidth:1,lineStyle:1};p.price=l.value,p.time1=r.time,p.price1=r.value,p.price2=i.value,p.price3=a.value,p.price4=d.value,p.point="E",p.title=`RR=${(R/b).toFixed(1)}`,p.color="#FF9800",p.draggable=!0,e.pattern2[p.point]=e.series.price.createPriceLine(p),s.set("pattern2",p),p.price=+w.toFixed(1),p.point="S",p.title=`SL=${(-b).toFixed(1)}`,p.color="#E91E63",p.draggable=!0,e.pattern2[p.point]=e.series.price.createPriceLine(p),s.set("pattern2",p),p.point="T",p.price=+A.toFixed(1),p.title=`TP=${R.toFixed(1)}`,p.color="#2196F3",p.draggable=!1,e.pattern2[p.point]=e.series.price.createPriceLine(p),s.set("pattern2",p),ie.value.classList.remove("selected")}function dt(t){let r=0,i=0,a=t,d=t,l=t,u=t;for(let c of e.data.price)if(c.time>=t.time){if(c.value<t.value){if(a.value>d.value)break;if(c.value<l.value)r>i&&(a=l,d=u,i=r),l=c,u=c,r=0;else if(c.value>l.value){if(c.value>t.value)break;c.value>u.value&&(u=c,r=+Math.abs(u.value-l.value).toFixed(1))}}else if(c.value>t.value){if(a.value<d.value)break;if(c.value>l.value)r>i&&(a=l,d=u,i=r),l=c,u=c,r=0;else if(c.value<l.value){if(c.value<t.value)break;c.value<u.value&&(u=c,r=+Math.abs(u.value-l.value).toFixed(1))}}}return{point2:a,point3:d,point4:l,point5:u}}function Ce(){g.isSet(e.pattern2.T)&&(e.series.price.removePriceLine(e.pattern2.E),e.series.price.removePriceLine(e.pattern2.S),e.series.price.removePriceLine(e.pattern2.T),e.pattern2={E:{},S:{},T:{}},s.clear("pattern2"))}function pt(t){h.showColorPicker=!1;const r=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),r||t.target.classList.add("selected"),t.stopPropagation()}function ut(t){ht(),t.target.classList.remove("selected"),t.preventDefault(),t.stopPropagation()}function ft(){const t="alert",r=G(F(e.crosshair.y)),i=e.alerts.length;if(e.alerts=e.alerts.filter(a=>{const d=a.options(),l=d.type=r==+d.price;return l&&(e.series.price.removePriceLine(a),s.set("alert",{price:r,removed:!0})),!l}),e.alerts.length==i){const a={lineType:t,price:r,title:r>=e.data.price.slice(-1)[0].value?">":"<",color:"red",lineWidth:1,lineStyle:1,draggable:!0};e.alerts.push(e.series.price.createPriceLine(a)),s.set("alert",a)}Y.value.classList.remove("selected")}function ht(){e.alerts.forEach(t=>e.series.price.removePriceLine(t)),e.alerts=[],s.clear("alert")}async function mt(){e.order.entry.hasOwnProperty("line")&&(e.order.tp.hasOwnProperty("line")?o.dispatch("tradingOrder/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(t=>{t.isOk?(P("entry"),P("tp"),P("sl"),E(!1),s.clear("order"),S.success(f("trading.orderChart.exitSuccess"))):(E(!0),x(t.message))}):o.dispatch("tradingOrder/executeOrder",{action:"entry",data:{cmd:"delete"}}).then(t=>{t.isOk?(P("entry"),E(!1),s.clear("order"),S.success(f("trading.orderChart.deleteEntrySuccess"))):(E(!0),x(t.message))}))}function vt(){const t=moment().unix();K(t)&&(t<v.ATO?Pe(f("trading.orderChart.atoOrder"),f("titles.confirm")).then(i=>{i&&o.dispatch("tradingOrder/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(a=>{a.isOk?S.success(f("trading.orderChart.atoOrderSuccess")):x(a.message)})}):t<v.ATC?o.dispatch("tradingOrder/executeOrder",{action:"entry",data:{cmd:"new",side:e.order.side,price:e.order.entry.price}}).then(r=>{r.isOk?(L("entry"),E(!0),S.success(f("trading.orderChart.newEntrySuccess"))):x(r.message)}):Pe(f("trading.orderChart.atcOrder"),f("titles.confirm")).then(i=>{i&&o.dispatch("tradingOrder/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(a=>{a.isOk?S.success(f("trading.orderChart.atcOrderSuccess")):x(a.message)})}))}function gt(){e.order.tp.price=e.order.entry.price+e.order.side*xe,e.order.sl.price=e.order.entry.price-e.order.side*we,o.dispatch("tradingOrder/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.order.tp.price},slData:{cmd:"new",price:e.order.sl.price}}).then(t=>{t.isOk?(L("entry"),L("tp"),L("sl"),e.order.entry.line.applyOptions({draggable:!1}),S.success(f("trading.orderChart.newTpSlSuccess"))):x(t.message)})}function yt(){if(e.order.entry.hasOwnProperty("line")){const t=e.data.price.slice(-1)[0].value;e.order.tp.hasOwnProperty("line")?((e.order.side>0&&t>=e.order.tp.price||e.order.side<0&&t<=e.order.tp.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,o.dispatch("tradingOrder/executeOrder",{action:"sl",data:{cmd:"delete"}}).then(r=>{r.isOk?(P("entry"),P("tp"),P("sl"),E(!1),s.clear("order"),S.success(f("trading.orderChart.deleteTpSuccess")),oe(),J()):x(r.message),e.isAutoOrdering=!1}))),(e.order.side>0&&t<=e.order.sl.price||e.order.side<0&&t>=e.order.sl.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,o.dispatch("tradingOrder/executeOrder",{action:"tp",data:{cmd:"cancel"}}).then(r=>{r.isOk?(P("entry"),P("tp"),P("sl"),E(!1),s.clear("order"),S.success(f("trading.orderChart.deleteSlSuccess")),oe(),J()):x(r.message),e.isAutoOrdering=!1})))):(e.order.side>0&&t>=e.order.entry.price||e.order.side<0&&t<=e.order.entry.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,setTimeout(()=>{e.order.tp.price=e.order.entry.price+e.order.side*xe,e.order.sl.price=e.order.entry.price-e.order.side*we,o.dispatch("tradingOrder/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.order.tp.price},slData:{cmd:"new",price:e.order.sl.price}}).then(r=>{r.isOk?(L("tp"),L("sl"),e.order.entry.line.applyOptions({draggable:!1}),S.success(f("trading.orderChart.autoNewTpSlSuccess")),J()):x(r.message),e.isAutoOrdering=!1})},1e3)))}}function Ct(){if(T.value.position&&g.isSet(e.target.X)){const t=e.data.cash.slice(-1)[0].value,r=+e.target.B.options().price,i=+e.target.X.options().price,a=i-r;(a>0&&t>=i||a<0&&t<=i)&&I.value.click()}}function kt(){e.chart.timeScale().scrollToRealTime()}function K(t=null){return t||(t=moment().unix()),t>=v.START&&t<=v.END}function F(t,r="price"){return G(e.series[r].coordinateToPrice(t))}function G(t){return t?+ +t.toFixed(1):0}function x(t){t||(t="unknown"),S.error(f(`trading.orderChart.${t}`))}function Ot(){e.loadWhitespace=!0,o.dispatch("tradingOrder/getChartData",h.chartDate)}function ne(){e.socketRefreshTime=moment(),e.loadWhitespace=!0,o.dispatch("tradingOrder/getChartData",h.chartDate)}function bt(){e.data.original=[],e.data.price=[],e.data.cash=[],e.data.whitespace=[],ne()}function J(){let t=new Audio(zt);t.crossOrigin="anonymous",t.addEventListener("canplaythrough",function(){t.play()})}function St(){o.dispatch("tradingOrder/getAccountInfo").then(t=>{let r="";r+='<div style="width: 200px;">',r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${f("trading.orderChart.nav")}</div><div>: ${B.currency(t.nav)}</div></div>`,r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${f("trading.orderChart.maxVol")}</div><div>: ${B.numberVnFormat(t.maxVol)}</div></div>`,r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${f("trading.orderChart.vm")}</div><div>: ${B.currency(t.vm)}</div></div>`,r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${f("trading.orderChart.fee")}</div><div>: ${B.currency(t.fee)}</div></div>`,r+="</div>",qt(r,f("trading.orderChart.accountInfo"))})}function Tt(){$.emit("checkPin",()=>o.dispatch("tradingOrder/report"))}function Pt(){$.emit("checkPin",()=>o.dispatch("tradingOrder/export"))}return(t,r)=>{const i=Dt("DxToolbar");return Nt(),Ft(Mt,null,[m("div",Ut,[ee(i,{items:[{location:"before",widget:"dxButton",options:{icon:"far fa-flag-checkered small",hint:t.$t("trading.orderChart.buttons.report"),onClick:Tt}},{location:"before",widget:"dxButton",options:{icon:"far fa-file-export small",hint:t.$t("trading.orderChart.buttons.export"),onClick:Pt}},{location:"before",widget:"dxButton",options:{icon:"far fa-chart-line small",hint:t.$t("trading.orderChart.buttons.cashflow"),onClick:()=>t.$refs.dailyCashFlowPopupRef.show()}}]},null,8,["items"]),m("div",{class:"order-chart-container",ref_key:"chartContainerRef",ref:k},[m("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:le},[m("div",Yt,[m("div",{ref_key:"connectionRef",ref:q,class:ce(`command far fa-${T.value.connection?"link":"unlink"}`),title:t.$t("trading.orderChart.connection"),onClick:r[0]||(r[0]=()=>t.$store.dispatch("tradingOrder/getStatus"))},null,10,Kt),m("div",{class:ce(["command status",{green:T.value.position>0,red:T.value.position<0,pending:T.value.pending}]),title:t.$t("trading.orderChart.position"),onClick:St},Te(T.value.position),11,Gt),m("div",{class:"command clock",onClick:ne},Te(h.clock),1),M(m("input",{type:"date",class:"chart-date command",title:t.$t("trading.orderChart.date"),"onUpdate:modelValue":r[1]||(r[1]=a=>h.chartDate=a),onChange:Ot},null,40,Jt),[[$t,h.chartDate]]),m("img",{ref_key:"spinnerRef",ref:de,class:"command spinner",src:Xt},null,512)]),m("div",Zt,[m("div",{ref_key:"fullscreenToolRef",ref:pe,class:ce(`command far fa-${h.isFullscreen?"compress":"expand"}`),title:t.$t("trading.orderChart.fullscreen"),onClick:Ne},null,10,Qt),m("div",{ref_key:"reloadToolRef",ref:ue,class:"command far fa-sync-alt",title:t.$t("trading.orderChart.reload"),onClick:bt},null,8,er),m("div",{ref_key:"tradingviewRef",ref:fe,class:"command far fa-chart-bar",title:t.$t("trading.orderChart.tradingview"),onClick:Ue},null,8,tr),m("div",{ref_key:"colorToolRef",ref:Ee,class:"color command far fa-palette",style:Bt({color:h.color}),title:t.$t("trading.orderChart.colorTool"),onClick:Ye,onContextmenu:Ke},[M(ee(Wt,{class:"color-picker",modelValue:h.color,"onUpdate:modelValue":r[2]||(r[2]=a=>h.color=a)},null,8,["modelValue"]),[[z,h.showColorPicker]])],44,rr),m("div",{ref_key:"lineToolRef",ref:N,class:"command far fa-horizontal-rule",title:t.$t("trading.orderChart.lineTool"),onClick:Ge,onContextmenu:Je},null,40,ir),m("div",{ref_key:"pattern1ToolRef",ref:re,class:"command far fa-star",title:t.$t("trading.orderChart.pattern1Tool"),onClick:st,onContextmenu:ot},null,40,ar),M(m("div",{ref_key:"pattern2ToolRef",ref:ie,class:"command far fa-heart",title:t.$t("trading.orderChart.pattern2Tool"),onClick:ct,onContextmenu:lt},null,40,sr),[[z,!1]]),m("div",{ref_key:"rulerToolRef",ref:U,class:"command far fa-line-height",title:t.$t("trading.orderChart.rulerTool"),onClick:Qe,onContextmenu:et},null,40,or),m("div",{ref_key:"targetToolRef",ref:te,class:"command far fa-dot-circle",title:t.$t("trading.orderChart.targetTool"),onClick:rt,onContextmenu:it},null,40,nr),M(m("div",{ref_key:"alertToolRef",ref:Y,class:"command far fa-alarm-exclamation",title:t.$t("trading.orderChart.alertTool"),onClick:pt,onContextmenu:ut},null,40,cr),[[z,!1]]),M(m("div",{class:"command far fa-info-circle",title:t.$t("trading.orderChart.copyistStatusPopup.title"),onClick:r[3]||(r[3]=()=>t.$refs.copyistStatusPopupRef.show())},null,8,lr),[[z,!1]]),m("div",{ref_key:"cancelOrderRef",ref:I,class:"cancel-order command far fa-trash-alt",title:t.$t("trading.orderChart.cancelTool"),onClick:mt},null,8,dr)]),m("div",null,[m("div",{ref_key:"entryOrderRef",ref:D,class:"order-button entry",onClick:vt}," Entry ",512),m("div",{ref_key:"tpslOrderRef",ref:V,class:"order-button tpsl",onClick:gt}," TP/SL ",512),m("div",{class:"chart-top command far fa-angle-double-right",onClick:kt})]),M(m("iframe",{ref_key:"tradingviewChartRef",ref:Ae,class:"tradingview-chart",src:Re.value},null,8,pr),[[z,h.showTradingView]])],512)],512)]),ee(It,{ref:"copyistStatusPopupRef"},null,512),ee(jt,{ref:"dailyCashFlowPopupRef"},null,512)],64)}}},Cr=wt(hr,[["__scopeId","data-v-9117b4e7"]]);export{Cr as default};
