import{A as mi,B as gi,C as hi,l as me,u as yi,r as D,a as xi,c as H,y as Si,E as Ti,w as ge,x as R,b as Ci,d as v,G as Z,t as je,H as q,I as ki,J as ee,e as Fe,K as wi,h as Fi,j as bi,k as be,z as He,L as Di,o as Oi}from"./app-ea6307cb.js";import Li from"./LineContext-d2cdbec3.js";import Ri from"./ScanContext-7444dc52.js";import Ei from"./ProgressContext-f516b7da.js";import{c as Pi}from"./lightweight-charts.esm.development-03366bac.js";import{g as O}from"./getUnixTime-244053ee.js";import"./text-box-ac6a0e6e.js";function Ue(V,M,T){return mi((T==null?void 0:T.in)||V,+gi(V)+M)}function De(V,M,T){return Ue(V,M*hi,T)}function Ai(V,M,T){return Ue(V,M*1e3,T)}function _i(V,M,T){return Ai(V,-M,T)}const Bi=["title"],Ii=["title"],Vi=["title"],Mi=["title"],Wi=["title"],Zi=["title"],$i=["title"],Yi=["title"],Ni=["title"],Ji=v("i",{class:"far fa-heart-rate"},null,-1),Xi=[Ji],zi=["title"],ji=v("i",{class:"far fa-pipe"},null,-1),Hi=[ji],qi=["title"],Qi=v("i",{class:"far fa-horizontal-rule"},null,-1),Ui=["title"],Gi=v("i",{class:"far fa-grip-lines-vertical"},null,-1),Ki=[Gi],es=["title"],ts=v("i",{class:"far fa-line-height"},null,-1),is=[ts],ss=["title"],rs=["src"],qe=3,Qe=2,os="wss://tradestation.fireant.vn/quote?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",ns="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",hs={__name:"Chart",setup(V){const M={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.25,bottom:.25}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:1e3,minBarSpacing:.01,barSpacing:.05}},T=me(new Date,"yyyy-MM-dd"),E={START:O(new Date(`${T}T08:45:00Z`)),ATO:O(new Date(`${T}T09:00:00Z`)),ATC:O(new Date(`${T}T14:30:00Z`)),END:O(new Date(`${T}T14:45:00Z`))},u=Fi(),Oe=bi(),{t:g}=yi(),Ge=be("devices"),f=be("mf"),te=be("filters"),W=D(null),Le=D(null),Ke=D(null),et=D(null),tt=D(null),it=D(null),st=D(null),ie=D(null),he=D(null),ye=D(null),xe=D(null),se=D(null),Se=D(null),rt=D(null),$=D(null),Q=D(null);let e={chart:{},series:{},data:{whitespace:[],price:[]},tools:{pattern:{}},crosshair:{},interval:null,interval60:null,websocket:null,socketStop:!1,vpsUpdatedAt:_i(new Date,60),isAutoOrdering:!1,currentSeconds:O(De(new Date,7))};j();const c=xi({chartDate:Oe.query.date??T,clock:me(new Date,"HH:mm:ss"),isFullscreen:!1,isSocketWarning:!1,isOrderWarning:!1,lineColor:"#F44336",lineTitle:"",progress:{},scanSide:"left",showProgressContext:!1,showScanContext:!1,showLineContext:!1,showTradingView:!1,tradingViewStyle:{left:"32px"}}),P=H(()=>u.state.tradingDerivative.status),L=H(()=>u.state.tradingDerivative.config),Re=H(()=>u.state.tradingDerivative.tools),ot=H(()=>u.state.tradingDerivative.isLoading),nt=H(()=>P.value.position!==0||!!P.value.pending||!!Re.value.order),at=H(()=>`https://chart.vps.com.vn/tv/?u=${L.value.vpsUser}&s=${L.value.vpsSession}&symbol=VN30F1M&resolution=1&lang=vi`);ni(),e.interval=setInterval(Tt,1e3),e.interval60=setInterval(()=>{z()?(Ne(),L.value.autoRefresh&&ne(!0)):clearInterval(e.interval60)},6e4),Si(()=>{e.chart=Pi(Le.value,M),e.chart.subscribeCrosshairMove(pt),e.chart.subscribeCustomPriceLineDragged(dt),e.series.whitespace=e.chart.addHistogramSeries({priceScaleId:"whitespace",scaleMargins:{top:0,bottom:0},color:"#808080",lastValueVisible:!1,priceLineVisible:!1}),e.series.timeRange=e.chart.addHistogramSeries({priceScaleId:"timeRange",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),e.series.pickTime=e.chart.addHistogramSeries({priceScaleId:"pickTime",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),e.series.timeMark=e.chart.addHistogramSeries({priceScaleId:"timeMark",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),e.series.price=e.chart.addLineSeries({color:"#F5F5F5",priceFormat:{minMove:.1}}),new ResizeObserver(ut).observe(W.value),document.addEventListener("keydown",Ae),document.addEventListener("fullscreenchange",_e)}),Ti(()=>{e.chart&&(e.chart.remove(),e.chart=null),document.removeEventListener("keydown",Ae),document.removeEventListener("fullscreenchange",_e),clearInterval(e.interval),clearInterval(e.interval60),Ie(),e.socketStop=!0}),ge(()=>u.state.tradingDerivative.chartData,vt),ge(Re,mt),ge(()=>c.progress,gt),ge(()=>L.value.source,(t,s)=>s?Y():null);function lt(t){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1,pe(!1),ie.value.classList.contains("selected")?jt():xe.value.classList.contains("selected")?Ut():se.value.classList.contains("selected")?Nt():Se.value.classList.contains("selected")?Lt():he.value.classList.contains("selected")?Bt():ye.value.classList.contains("selected")&&Zt()}function ct(t){pe(!0),t.preventDefault()}function Ee(t){t.stopPropagation()}function Pe(t){t.preventDefault(),t.stopPropagation()}function pt(t){if(t.time){let s=t.seriesPrices.get(e.series.price);e.crosshair.time=t.time,e.crosshair.price=s}else Ge.phone||(e.crosshair.time=null,e.crosshair.price=null);t.point!==void 0&&(e.crosshair.x=t.point.x,e.crosshair.y=t.point.y)}function dt(t){let s=t.customPriceLine,i=s.options();i.price=parseFloat(i.price.toFixed(1));const r=+t.fromPriceString,n=i.price;switch(i.lineType){case"order":if(n!==r){let a=!1;i.kind==="entry"?P.value.position||(a=!0,e.tools.order[i.kind].price=n,u.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"change",price:e.tools.order.entry.price}}).then(l=>{l.isOk?(N([i.kind]),R.success(g("trading.derivative.changeEntrySuccess"))):(s.applyOptions({price:r}),A(l.message))})):(a=!0,e.tools.order[i.kind].price=n,i.kind==="tp"?u.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"change",price:e.tools.order.tp.price}}).then(l=>{l.isOk?(N([i.kind]),R.success(g("trading.derivative.changeTpSuccess"))):(s.applyOptions({price:r}),A(l.message))}):u.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"change",price:e.tools.order.sl.price}}).then(l=>{l.isOk?(N([i.kind]),R.success(g("trading.derivative.changeSlSuccess"))):(s.applyOptions({price:r}),A(l.message))})),a||(s.applyOptions({price:r}),R.show(g("trading.derivative.noChangeOrderLine")))}break;case"line":u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line",point:r});const o=i.color,p=i.title;u.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"line",points:[n],data:[{color:o,title:p}]}),ie.value.classList.remove("selected");break;case"target":if(f.isSet(e.tools.target.B)){let a={isRemove:!1,name:"target",points:[],data:[]},l,d,m=+e.tools.target.A.options().price,y=+e.tools.target.B.options().price,h=y-m;if(l="A",i.point==="A")h=+e.tools.target.B.options().title,y=m+h;else if(i.point!=="B"){let C=0;switch(i.point){case"X":C=1.5;break;case"Y":C=2;break;case"Z":C=3;break;case"W":C=5;break}h=parseFloat(((y-n)/C).toFixed(1)),m=y-h,d={price:m},e.tools.target[l].applyOptions(d)}a.points.push(l),a.data.push(m),l="B",d={price:y,title:h.toFixed(1)},i.point===l&&delete d.price,e.tools.target[l].applyOptions(d),a.points.push(l),a.data.push(y),l="X",d={price:parseFloat((m-.5*h).toFixed(1)),title:(-.5*h).toFixed(1)},i.point===l&&delete d.price,e.tools.target[l].applyOptions(d),l="Y",d={price:parseFloat((m-h).toFixed(1)),title:(-h).toFixed(1)},i.point===l&&delete d.price,e.tools.target[l].applyOptions(d),l="Z",d={price:parseFloat((m-2*h).toFixed(1)),title:(-2*h).toFixed(1)},i.point===l&&delete d.price,e.tools.target[l].applyOptions(d),l="W",d={price:parseFloat((m-4*h).toFixed(1)),title:(-4*h).toFixed(1)},i.point===l&&delete d.price,e.tools.target[l].applyOptions(d),u.dispatch("tradingDerivative/drawTools",a)}break;case"pattern":if(f.isSet(e.tools.pattern.lines.B)){let a,l;e.tools.pattern.points={A:{time:e.tools.pattern.points.A.time,price:+e.tools.pattern.lines.A.options().price},B:{price:+e.tools.pattern.lines.B.options().price},C:{price:+e.tools.pattern.lines.C.options().price}},X();const{progress:d,timeMark:m,info:{rEpr1:y,rEpr2:h,rEpr3:C,entry:b,pStatus:k,x:_,X:x,y:B,Y:w}}=ae();ce(d),le(m),a="A",l={title:`A ${y}`},e.tools.pattern.lines[a].applyOptions(l),a="B",l={title:`B ${h}`},e.tools.pattern.lines[a].applyOptions(l),a="C",l={title:`C ${C}`},e.tools.pattern.lines[a].applyOptions(l),a="D",l={price:b,title:"Entry "+k},i.point===a&&delete l.price,e.tools.pattern.lines[a].applyOptions(l),a="X",l={price:parseFloat(_.toFixed(1)),title:"X "+parseFloat(x.toFixed(1))},e.tools.pattern.lines[a].applyOptions(l),a="Y",l={price:parseFloat(B.toFixed(1)),title:"Y "+parseFloat(w.toFixed(1))},e.tools.pattern.lines[a].applyOptions(l)}break}}function ut(){W.value&&(e.chart.resize(W.value.offsetWidth,W.value.offsetHeight),W.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function Ae(t){if(t.ctrlKey)switch(t.keyCode){case 219:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing-.01});break;case 221:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing+.01});break}if(t.altKey)switch(t.keyCode){case 219:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()-50);break;case 221:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()+50);break}}function _e(){W.value&&(document.fullscreenElement?(c.isFullscreen=!0,W.value.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(c.isFullscreen=!1,W.value.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}function ft(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function vt(t){c.chartDate===T&&z()||(t.price.length>0&&(e.data.whitespace=oe(e.data.whitespace,Be(c.chartDate))),e.series.whitespace.setData(e.data.whitespace),e.data.price=oe(e.data.price,t.price),e.series.price.setData(e.data.price))}function re(t){let s=[];t.forEach(i=>{let r,n;L.value.source==="FireAnt"?(r=O(De(new Date(i.date),7)),n=i.price):(r=O(new Date(`${T}T${i.time}Z`)),n=i.lastPrice),s.push({time:r,value:n})}),s.length>1?(e.data.price=oe(e.data.price,s),e.series.price.setData(e.data.price)):(e.data.price.push(s[0]),e.series.price.update(s[0]))}function Be(t){const s=O(new Date(`${t}T09:00:00Z`)),i=O(new Date(`${t}T11:30:00Z`)),r=O(new Date(`${t}T13:00:00Z`)),n=O(new Date(`${t}T14:30:00Z`)),o=O(new Date(`${t}T14:00:00Z`));let p=[];for(let a=s;a<=n;a++){if(a>i&&a<r)continue;let l={time:a};(a===o||a===n)&&(l.value=1),p.push(l)}return p}function oe(t,s){return Array.from(new Map([...t,...s].sort((i,r)=>i.time-r.time).map(i=>[i.time,i])).values())}function mt(t){Kt(),Object.entries(t).forEach(([s,i])=>{switch(s){case"order":Ct(i);break;case"pattern":It(i)&&(e.tools.pattern.points=f.cloneDeep(i),Te());break;case"tr":Jt(i);break;case"0_pt":We(i[0]);break;case"line":Ht(i);break;case"target":Gt(i);break}})}function gt(t,s){if(L.value.autoRefresh&&(t.step>s.step||t.step===s.step&&t.result>s.result)){let i="";t.result?[2,4,5].includes(t.step)?i=g("trading.derivative.progressOrder",t):i=g("trading.derivative.progressSuccess",t):i=g("trading.derivative.progressFail",t),ht(i)}}function ht(t){const s=new SpeechSynthesisUtterance(t);s.lang="vi-VN",speechSynthesis.speak(s)}async function Y(){if(z()){await Ie();const t=L.value.source==="FireAnt",s=t?os:ns;e.websocket=new WebSocket(s),e.websocket.onclose=i=>{e.socketStop||(c.isSocketWarning=!0,Y())},t?yt():(Ve(),St())}}async function Ie(){e.websocket&&e.websocket.readyState===WebSocket.OPEN&&(e.websocket.close(),await new Promise(t=>{const s=setInterval(()=>{(!e.websocket||e.websocket.readyState===WebSocket.CLOSED)&&(e.websocket=null,clearInterval(s),t())},100)}))}function yt(){u.dispatch("tradingDerivative/setLoading",!0),e.websocket.onopen=t=>{if(e.websocket.readyState===WebSocket.OPEN){let s='{"protocol":"json","version":1}';e.websocket.send(s),s='{"arguments":["VN30F1M"],"invocationId":"0","target":"SubscribeTrades","type":1}',e.websocket.send(s)}},e.websocket.onmessage=t=>{c.isSocketWarning=!1,xt(t.data).forEach(i=>{if(!i)return!1;i.type===3?(i.result[0].date.slice(0,10)===T&&(ue(),e.data.whitespace=oe(e.data.whitespace,Be(T)),e.series.whitespace.setData(e.data.whitespace),re(i.result)),u.dispatch("tradingDerivative/setLoading",!1)):i.type===1&&i.target==="UpdateTrades"&&i.arguments[0]==="VN30F1M"&&(console.log("FireAnt",i.arguments[1]),Ye(i.arguments[1].at(-1).price),re(i.arguments[1]))})}}function xt(t){let s=[];return t.split("").forEach(i=>{const r=i.indexOf("{"),n=i.lastIndexOf("}");let o=null;if(r!==-1&&n!==-1&&n>r){const p=i.substring(r,n+1);p!=="{}"&&(o=JSON.parse(p))}s.push(o)}),s}function St(){e.websocket.onopen=t=>{if(e.websocket.readyState===WebSocket.OPEN){const s={action:"join",list:L.value.vn30f1m},i=`42${JSON.stringify(["regs",JSON.stringify(s)])}`;e.websocket.send(i)}},e.websocket.onmessage=t=>{if(c.isSocketWarning=!1,t.data.substr(0,1)==="4"&&t.data.substr(1,1)==="2"){const s=JSON.parse(t.data.substr(2));if(s[0]==="stockps"){const i=s[1].data;i.id===3220&&(console.log("VPS",i),Ye(i.lastPrice),re([i]))}}}}function Ve(){fetch("https://bddatafeed.vps.com.vn/getpschartintraday/VN30F1M").then(t=>t.json()).then(t=>{console.log(t),re(t)}),e.vpsUpdatedAt=new Date}function Tt(){e.currentSeconds=O(De(new Date,7)),z()&&(P.value.position&&e.currentSeconds>E.ATC-5*60&&(c.isOrderWarning=!0,e.currentSeconds>E.ATC-15&&f.isSet(e.tools.order.tp.line)&&u.dispatch("tradingDerivative/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(t=>{t.isOk?(J(["entry","tp","sl"]),R.success(g("trading.derivative.autoCancelTpSlSuccess"))):A(t.message)})),L.value.openingMarket&&e.currentSeconds===E.START&&Y()),c.clock=me(new Date,"HH:mm:ss")}function N(t){const s="order";let i={isRemove:!1,name:s,points:[],data:[]},r,n;t.forEach(o=>{switch(o){case"entry":r="yellow",n=e.tools.order.side>0?"LONG":"SHORT";break;case"tp":r="lime",n=parseFloat(Math.abs(e.tools.order.tp.price-e.tools.order.entry.price).toFixed(1));break;case"sl":r="red",n=parseFloat(Math.abs(e.tools.order.sl.price-e.tools.order.entry.price).toFixed(1));break}if(i.points.push(o),f.isSet(e.tools.order[o].line))e.tools.order[o].line.applyOptions({price:e.tools.order[o].price,title:n}),i.data.push(e.tools.order[o].line.options());else{const p={lineType:s,kind:o,side:e.tools.order.side,price:e.tools.order[o].price,color:r,lineWidth:1,lineStyle:0,title:n,draggable:!0};e.tools.order[o].line=e.series.price.createPriceLine(p),i.data.push(p)}}),u.dispatch("tradingDerivative/drawTools",i)}function Ct(t){Object.entries(t).forEach(([s,i])=>{e.tools.order.side=i.side,e.tools.order[s].price=i.price,e.tools.order[s].line=e.series.price.createPriceLine(i)})}function J(t,s=!0){s&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"order"}),t.forEach(i=>{f.isSet(e.tools.order[i].line)&&(e.series.price.removePriceLine(e.tools.order[i].line),delete e.tools.order[i].line)})}function kt(t){Ve(),t.stopPropagation()}function wt(){c.showProgressContext=!c.showProgressContext,c.showScanContext=!1,c.showLineContext=!1,c.showProgressContext&&ne()}function Ft(){bt()}function bt(t){const s=t??!L.value.autoRefresh;u.dispatch("tradingDerivative/setAutoRefresh",s)}function Dt(t){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const s=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),s||(X(!0),G(),U(),t.target.classList.add("selected"))}function Ot(){c.showScanContext=!c.showScanContext,c.showProgressContext=!1,c.showLineContext=!1}function Lt(){const t=c.scanSide==="left",s=e.crosshair.time?e.data.price.filter(r=>!S(r.time,t,e.crosshair.time)):e.data.price;let i=t?Rt(s):Et(s);f.isSet(i)&&(e.tools.pattern.points=Pt(i),X(),G(),U(),Te()),Se.value.classList.remove("selected")}function Rt(t){let s,[i,r,n,o]=Array(4).fill({});for(let p=t.length-1;p>=0;p--){const a=t[p].value,l=t[p].time,d=I(l);if(d===-1)break;if(p===t.length-1&&(n={index:d,time:l,price:a},[r,i,o]=Array(3).fill(null).map(()=>f.cloneDeep(n))),s===void 0){if(a===n.price)continue;s=a>n.price}if(S(a,s,r.price)&&(S(i.price,!s,n.price)?([n,r]=[r,i].map(m=>f.cloneDeep(m)),i={index:d,time:l,price:a},o=f.cloneDeep(i),s=!s):r={index:d,time:l,price:a}),S(a,!s,i.price)?(i={index:d,time:l,price:a},o=f.cloneDeep(i)):o.index=d,S(a,s,o.price)&&(o={index:d,time:l,price:a}),n.index>i.index){const m=Math.abs(r.price-n.price);if(m>=1.5&&(i.index-o.index>n.index-r.index||Math.abs(i.price-o.price)>m))break}}return{A:i,B:r,C:n}}function Et(t){let s,[i,r,n]=Array(3).fill({});for(let o=0;o<t.length;o++){const p=t[o].value,a=t[o].time,l=I(a);if(l===-1)break;if(o===0&&(i={index:l,time:a,price:p},r=f.cloneDeep(i),n=f.cloneDeep(i)),s===void 0){if(p===i.price)continue;s=p>i.price}S(p,s,r.price)&&(r={index:l,time:a,price:p},n=f.cloneDeep(r)),S(r.price,s,i.price)&&S(p,!s,n.price)&&(S(p,s,i.price)?n={index:l,time:a,price:p}:(i=f.cloneDeep(r),r={index:l,time:a,price:p},n=f.cloneDeep(r),s=!s))}return{A:i,B:r,C:n}}function Pt(t){const s={};return Object.entries(t).forEach(([i,r])=>{const{index:n,...o}=r;s[i]=o}),s}function At(t){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const s=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),s||(G(),t.target.classList.add("selected"))}function _t(t){t.target.classList.remove("selected"),X(!0),G(),U()}function Bt(){const t="pattern",s=de(e.crosshair.y),i=e.crosshair.time;let r={lineType:t,price:s,lineWidth:1,lineStyle:1,draggable:!0};if(f.isSet(e.tools.pattern.lines.A))if(f.isSet(e.tools.pattern.lines.B)){let n,o;if(f.isSet(e.tools.pattern.lines.C)){let p,a;e.tools.pattern.points.A={time:i,price:s};const{progress:l,timeMark:d,info:{rEpr1:m,rEpr2:y,rEpr3:h,entry:C,pStatus:b,x:k,X:_,y:x,Y:B}}=ae();o=l,n=d,p="A",a={price:s,title:`A ${m}`},e.tools.pattern.lines[p].applyOptions(a),p="B",a={title:`B ${y}`},e.tools.pattern.lines[p].applyOptions(a),p="C",a={title:`C ${h}`},e.tools.pattern.lines[p].applyOptions(a),p="D",a={price:C,title:"Entry "+b},e.tools.pattern.lines[p].applyOptions(a),p="X",a={price:parseFloat(k.toFixed(1)),title:"X "+parseFloat(_.toFixed(1))},e.tools.pattern.lines[p].applyOptions(a),p="Y",a={price:parseFloat(x.toFixed(1)),title:"Y "+parseFloat(B.toFixed(1))},e.tools.pattern.lines[p].applyOptions(a)}else{e.tools.pattern.points.C={price:s};const{progress:p,timeMark:a,info:{rEpr1:l,rEpr2:d,rEpr3:m,entry:y,pStatus:h,x:C,X:b,y:k,Y:_}}=ae();o=p,n=a;let x="A";e.tools.pattern.lines[x].applyOptions({title:`A ${l}`}),x="B",e.tools.pattern.lines[x].applyOptions({title:`B ${d}`}),r.point="C",r.title=`C ${m}`,r.color="#FFEB3B",e.tools.pattern.lines[r.point]=e.series.price.createPriceLine(r),r.point="D",r.price=y,r.title="Entry "+h,r.color="#9C27B0",r.draggable=!1,e.tools.pattern.lines[r.point]=e.series.price.createPriceLine(r),r.point="Y",r.price=parseFloat(k.toFixed(1)),r.title="Y "+parseFloat(_.toFixed(1)),r.color="#E91E63",r.draggable=!1,e.tools.pattern.lines[r.point]=e.series.price.createPriceLine(r),r.point="X",r.price=parseFloat(C.toFixed(1)),r.title="X "+parseFloat(b.toFixed(1)),r.color="#2196F3",r.draggable=!1,e.tools.pattern.lines[r.point]=e.series.price.createPriceLine(r)}ce(o),le(n),he.value.classList.remove("selected")}else r.point="B",r.title="B 0",r.color="#4CAF50",e.tools.pattern.lines[r.point]=e.series.price.createPriceLine(r),e.tools.pattern.points.B={price:s};else r.point="A",r.title="A 0",r.color="#F44336",e.tools.pattern.lines[r.point]=e.series.price.createPriceLine(r),e.tools.pattern.points={A:{time:i,price:s}};X()}function Te(){let s={lineType:"pattern",lineWidth:1,lineStyle:1,draggable:!0};const{A:i,B:r,C:n}=e.tools.pattern.points,{progress:o,timeMark:p,info:{rEpr1:a,rEpr2:l,rEpr3:d,entry:m,pStatus:y,x:h,X:C,y:b,Y:k}}=ae();ce(o),le(p),s.point="A",s.title=`A ${a}`,s.color="#F44336",s.price=i.price,e.tools.pattern.lines[s.point]=e.series.price.createPriceLine(s),s.point="B",s.title=`B ${l}`,s.color="#4CAF50",s.price=r.price,e.tools.pattern.lines[s.point]=e.series.price.createPriceLine(s),s.point="C",s.price=n.price,s.title=`C ${d}`,s.color="#FFEB3B",e.tools.pattern.lines[s.point]=e.series.price.createPriceLine(s),s.point="D",s.price=m,s.title="Entry "+y,s.color="#9C27B0",s.draggable=!1,e.tools.pattern.lines[s.point]=e.series.price.createPriceLine(s),s.point="Y",s.price=parseFloat(b.toFixed(1)),s.title="Y "+parseFloat(k.toFixed(1)),s.color="#E91E63",s.draggable=!1,e.tools.pattern.lines[s.point]=e.series.price.createPriceLine(s),s.point="X",s.price=parseFloat(h.toFixed(1)),s.title="X "+parseFloat(C.toFixed(1)),s.color="#2196F3",s.draggable=!1,e.tools.pattern.lines[s.point]=e.series.price.createPriceLine(s)}function ne(t=!1){f.isSet(e.tools.pattern.lines.C)&&(t&&Vt(),U(),Te())}function It({A:{time:t}}){return e.data.whitespace.some(s=>s.time===t)}function ae(){const{A:t,B:s,C:i}=e.tools.pattern.points,r=s.price-i.price,n=r>0,o=Ce({phase:1,start:t,end:s,retracementPrice:i.price});let p=Ce({phase:2,start:o.R,end:i});const a=Ce({phase:3,start:p.R,end:{price:s.price+(n?1:-1)*o.rEp},breakPrices:[p.S1.price,s.price]});o.xBox.tr>=p.tr&&(p.tr=o.xBox.tr),console.log("calculatePattern",[o,p,a]);const l=Math.abs(r)>=o.pr,d=Math.abs(i.price-a.xBox.R.price)>=p.pr,m=a.xBox.pr>=a.pr,y=!S(i.price,!n,o.S1.price),h=!S(a.xBox.R.price,n,p.S1.price),C=!S(a.xBox.S.price,!n,a.S1.price),b=o.R.index+o.tr,k=p.R.index+p.tr,_=a.xBox.R.index+a.tr,x=a.xBox.R.index+p.tr,B=[b,k,_,x],w=a.xBox.S.index;let K,F={};const Je=[p.R.index>b,o.rEpr<3,p.rEpr<o.rEpr];F.steps=[[l||o.rEt<o.tr&&o.rEp>=o.sEp,y,!a.breakIndexs[1]||b<a.breakIndexs[1],w>b],[...Je,k>b,w<k],[p.R.index-o.R.index>.5*o.tr,d,w>k],[m,C,w>_,Je.every(Boolean)||w>x]],F.step=1,F.result=F.steps[0].every(Boolean),K=o.R1.price,F.result&&(w<=k?(F.step=2,F.result=F.steps[1].every(Boolean),K=p.S1.price):(F.step=3,F.result=F.steps[2].every(Boolean),K=a.R1.price,F.result&&(F.step=4,F.result=F.steps[3].every(Boolean),F.result&&(K=a.xBox.R.price))));const li=`${y?l?1:0:2}${h?d?1:0:2}${C?m?1:0:2}`,ci=parseFloat(o.rEpr.toFixed(1)),pi=parseFloat(p.rEpr.toFixed(1)),di=parseFloat(a.rEpr.toFixed(1)),ve=o.rEp,ui=Me(s.price,ve,n),fi=a.breakIndexs[1]??w,Xe=parseInt((fi-o.R.index)/o.tr),ze=Xe>1?ve*Xe:ve,vi=Me(s.price,ze,n);return{progress:F,timeMark:B,info:{rEpr1:ci,rEpr2:pi,rEpr3:di,entry:K,pStatus:li,x:ui,X:ve,y:vi,Y:ze}}}function Ce({phase:t,start:s,end:i,breakPrices:r,retracementPrice:n}){let o=f.cloneDeep(s),p=f.cloneDeep(i);const a=p.price>o.price;let l={},d={},m={},y=[null,null],h,C,b;return e.data.price.filter(k=>{let _=k.time>=o.time;return e.tools.pickTime&&(_&=k.time<=e.tools.pickTime),_}).every((k,_)=>{const x=k.value,B=k.time,w=I(B);return w===-1?!1:((_===0||x===o.price)&&(l={R:{index:w,time:B,price:x},S:{index:w,time:B,price:x},pr:0,tr:0},d=f.cloneDeep(l),m=f.cloneDeep(l)),S(x,a,l.R.price)?(l.tr>=d.tr&&l.pr>=d.pr&&(d=f.cloneDeep(l)),t===1&&n&&!S(l.S.price,!a,n)&&l.tr>=m.tr&&l.pr>=m.pr&&(m=f.cloneDeep(l)),l={R:{index:w,time:B,price:x},S:{index:w,time:B,price:x},pr:0,tr:0},t===3&&r&&(!y[0]&&S(x,a,r[0])&&(y[0]=w),!y[1]&&S(x,a,r[1])&&(y[1]=w))):(l.S.index=w,l.tr=l.S.index-l.R.index,S(x,!a,l.S.price)&&(l.S.time=B,l.S.price=x,l.pr=Math.abs(l.S.price-l.R.price))),S(x,!a,o.price)?(l.S.price=o.price,!1):!!S(x,!a,p.price))}),f.isSet(l)&&(o.index=I(o.time),p.index=l.S.index,p.time=fe(l.S.index),h=Math.abs(p.price-d.R.price),C=Math.abs(o.price-d.S.price),b=p.index-d.S.index,t===3&&(m=l)),{tr:d.tr,pr:d.pr,rEp:h,sEp:C,rEpr:d.pr?h/d.pr:0,rEt:b,S1:d.S,R1:d.R,xBox:m,S:o,R:p,breakIndexs:y}}function Me(t,s,i){const r=t+(i?1:-1)*s;let n=parseFloat((r%1).toFixed(1));if(i){if(n>=.1&&n<=.2)return Math.floor(r);if(n>=.6&&n<=.7)return Math.floor(r)+.5}else{if(n>=.8&&n<=.9)return Math.ceil(r);if(n>=.3&&n<=.4)return Math.floor(r)+.5}return r}function Vt(){if(!e.tools.pickTime)return!1;let t=e.tools.pattern.points;const s=t.B.price-t.A.price>0,i=e.data.price.at(-1).value;if(S(i,!s,t.C.price)){let r=i;for(let n=e.data.price.length-1;n>=0;n--){const o=e.data.price[n].value;if(o===t.B.price)break;r=s?Math.min(r,o):Math.max(r,o)}t.C.price=r,e.tools.pattern.points=t,X()}}function X(t=!1){let s={isRemove:t,name:"pattern",points:[],data:[]};t?e.tools.pattern.points={}:Object.entries(e.tools.pattern.points).forEach(([i,r])=>{s.points.push(i),s.data.push(r)}),u.dispatch("tradingDerivative/drawTools",s)}function U(){f.isSet(e.tools.pattern.lines.A)&&(e.series.price.removePriceLine(e.tools.pattern.lines.A),f.isSet(e.tools.pattern.lines.B)&&(e.series.price.removePriceLine(e.tools.pattern.lines.B),f.isSet(e.tools.pattern.lines.C)&&(e.series.price.removePriceLine(e.tools.pattern.lines.C),e.series.price.removePriceLine(e.tools.pattern.lines.D),e.series.price.removePriceLine(e.tools.pattern.lines.X),e.series.price.removePriceLine(e.tools.pattern.lines.Y)))),j(["pattern"]),le([]),ce({})}function le(t){const s=["#F44336","#4CAF50","#FFEB3B","#2196F3"];let i=[];for(let r=0;r<t.length;r++){let n=fe(t[r]);n&&(t.indexOf(t[r])!==t.lastIndexOf(t[r])&&(n+=r),i.push({time:n,value:1,color:s[r]}))}i.length&&i.sort((r,n)=>r.time-n.time),e.series.timeMark.setData(i)}function ce(t){c.progress=t}function Mt(t){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const s=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),s||t.target.classList.add("selected")}function Wt(t){t.target.classList.remove("selected"),G(),ne()}function Zt(){const t=e.crosshair.time;u.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"0_pt",points:[0],data:[t]}),We(t),ne(),ye.value.classList.remove("selected")}function We(t){e.tools.pickTime=t,e.series.pickTime.setData([{time:t,value:1,color:"#9C27B0"}])}function G(t=!0){t&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"0_pt"}),e.series.pickTime.setData([]),j(["pt"])}function $t(t){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const s=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),s||t.target.classList.add("selected")}function Yt(t){Ze(),t.target.classList.remove("selected")}function Nt(){let t={isRemove:!1,name:"tr",points:[],data:[]};const s=e.crosshair.time;let i={time:s,value:1};switch(e.tools.timeRange.length){case 0:i.color="OrangeRed",e.tools.timeRange[0]=i,t.points.push(0),t.data.push(s);break;case 1:i.color="lime",e.tools.timeRange[1]=i,t.points.push(1),t.data.push(s),se.value.classList.remove("selected");break;default:const r=I(e.tools.timeRange[0].time),n=I(e.tools.timeRange[1].time),p=I(s)+(n-r),a=fe(p);i.color="OrangeRed",e.tools.timeRange[0]=f.cloneDeep(i),t.points.push(0),t.data.push(s),i.time=a,i.color="lime",e.tools.timeRange[1]=i,t.points.push(1),t.data.push(a),se.value.classList.remove("selected");break}e.series.timeRange.setData(e.tools.timeRange),u.dispatch("tradingDerivative/drawTools",t)}function Jt(t){let s,i;if(t.length===2)s=t[0],i=t[1];else if(t.length===3){const n=I(t[0]),o=I(t[1]),a=I(t[2])+(o-n);s=t[2],i=fe(a)}else return!1;let r=[{time:s,value:1,color:"OrangeRed"},{time:i,value:1,color:"lime"}];e.tools.timeRange=r,e.series.timeRange.setData(r)}function Ze(t=!0){t&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"tr"}),e.series.timeRange.setData([]),j(["tr"])}function Xt(t){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const s=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),s||t.target.classList.add("selected")}function zt(t){c.showLineContext=!c.showLineContext,c.showProgressContext=!1,c.showScanContext=!1}function jt(){const t="line",s=de(e.crosshair.y),i=e.tools.lines.length;if(e.tools.lines=e.tools.lines.filter(r=>{const n=r.options(),o=n.type=s===+n.price;return o&&(e.series.price.removePriceLine(r),u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:t,point:s})),!o}),e.tools.lines.length===i){const r=c.lineColor,n=c.lineTitle,o={lineType:t,price:s,color:r,title:n,lineWidth:1,lineStyle:1,draggable:!0};e.tools.lines.push(e.series.price.createPriceLine(o)),u.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:t,points:[s],data:[{color:r,title:n}]})}ie.value.classList.remove("selected")}function Ht(t){const i={lineType:"line",lineWidth:1,lineStyle:1,draggable:!0};Object.entries(t).forEach(([r,{color:n,title:o}])=>{i.price=+r,i.color=n,i.title=o,e.tools.lines.push(e.series.price.createPriceLine(i))})}function $e(t=!0){e.tools.lines.length>0&&(t&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line"}),e.tools.lines.forEach(s=>e.series.price.removePriceLine(s)),j(["lines"]))}function qt(t){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const s=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),s||(t.target.classList.add("selected"),ke())}function Qt(t){ke(),t.target.classList.remove("selected")}function Ut(){const t="target",s=de(e.crosshair.y);let i={lineType:t,price:s,lineWidth:1,lineStyle:1,draggable:!0},r={isRemove:!1,name:t,points:[],data:[s]};if(f.isSet(e.tools.target.A)){const n=+e.tools.target.A.options().price,o=s-n;i.point="B",i.title=parseFloat(o.toFixed(1)),i.color="#F44336",e.tools.target[i.point]=e.series.price.createPriceLine(i),r.points.push(i.point),i.point="X",i.price=parseFloat((n-.5*o).toFixed(1)),i.title=parseFloat((-.5*o).toFixed(1)),i.color="#2196F3",e.tools.target[i.point]=e.series.price.createPriceLine(i),i.point="Y",i.price=parseFloat((n-o).toFixed(1)),i.title=parseFloat(-o.toFixed(1)),i.color="#673AB7",e.tools.target[i.point]=e.series.price.createPriceLine(i),i.point="Z",i.price=parseFloat((n-2*o).toFixed(1)),i.title=parseFloat((-2*o).toFixed(1)),i.color="#9C27B0",e.tools.target[i.point]=e.series.price.createPriceLine(i),i.point="W",i.price=parseFloat((n-4*o).toFixed(1)),i.title=parseFloat((-4*o).toFixed(1)),i.color="#E91E63",e.tools.target[i.point]=e.series.price.createPriceLine(i),xe.value.classList.remove("selected")}else i.point="A",i.title="0",i.color="#FF9800",e.tools.target[i.point]=e.series.price.createPriceLine(i),r.points.push(i.point);u.dispatch("tradingDerivative/drawTools",r)}function Gt(t){let i={lineType:"target",lineWidth:1,lineStyle:1,draggable:!0};const r=t.A,n=t.B,o=n-r;i.point="A",i.price=r,i.title="0",i.color="#FF9800",e.tools.target[i.point]=e.series.price.createPriceLine(i),i.point="B",i.price=n,i.title=parseFloat(o.toFixed(1)),i.color="#F44336",e.tools.target[i.point]=e.series.price.createPriceLine(i),i.point="X",i.price=parseFloat((r-.5*o).toFixed(1)),i.title=parseFloat((-.5*o).toFixed(1)),i.color="#2196F3",e.tools.target[i.point]=e.series.price.createPriceLine(i),i.point="Y",i.price=parseFloat((r-o).toFixed(1)),i.title=parseFloat(-o.toFixed(1)),i.color="#673AB7",e.tools.target[i.point]=e.series.price.createPriceLine(i),i.point="Z",i.price=parseFloat((r-2*o).toFixed(1)),i.title=parseFloat((-2*o).toFixed(1)),i.color="#9C27B0",e.tools.target[i.point]=e.series.price.createPriceLine(i),i.point="W",i.price=parseFloat((r-4*o).toFixed(1)),i.title=parseFloat((-4*o).toFixed(1)),i.color="#E91E63",e.tools.target[i.point]=e.series.price.createPriceLine(i)}function ke(t=!0){t&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"target"}),f.isSet(e.tools.target.A)&&(e.series.price.removePriceLine(e.tools.target.A),f.isSet(e.tools.target.B)&&(e.series.price.removePriceLine(e.tools.target.B),e.series.price.removePriceLine(e.tools.target.X),e.series.price.removePriceLine(e.tools.target.Y),e.series.price.removePriceLine(e.tools.target.Z),e.series.price.removePriceLine(e.tools.target.W))),j(["target"])}function Kt(){J(["entry","tp","sl"],!1),$e(!1),ke(!1),Ze(!1),U()}function pe(t){if(t){if(z()&&(f.isSet(e.tools.order.tp.line)||P.value.position&&e.currentSeconds>E.ATO&&e.currentSeconds<E.ATC&&(Q.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-61?-61:1))+"px",Q.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-51?-51:1))+"px",Q.value.style.display="block"),!f.isSet(e.tools.order.entry.line))){let s=null,i=0;P.value.position?(e.currentSeconds<E.ATO?s="ATO":e.currentSeconds>E.ATC&&(s="ATC"),s&&(e.tools.order.entry.price=s,i=-P.value.position)):e.currentSeconds>E.ATO&&e.currentSeconds<E.ATC&&(s=de(e.crosshair.y),i=s>=e.data.price.at(-1).value?1:-1,e.tools.order.side=i,e.tools.order.entry.price=s),i&&($.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-71?-71:1))+"px",$.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-61?-61:1))+"px",$.value.style.background=i>0?"green":"red",$.value.innerText=`${i>0?"LONG":"SHORT"} ${s}`,$.value.style.display="block")}}else $.value.style.display="none",Q.value.style.display="none"}function ei(){z()&&(e.currentSeconds<E.ATO?He(g("trading.derivative.atoOrder"),g("titles.confirm")).then(s=>{s&&u.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(i=>{i.isOk?R.success(g("trading.derivative.atoOrderSuccess")):A(i.message)})}):e.currentSeconds<E.ATC?u.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"new",side:e.tools.order.side,price:e.tools.order.entry.price}}).then(t=>{t.isOk?(N(["entry"]),R.success(g("trading.derivative.newEntrySuccess"))):A(t.message)}):He(g("trading.derivative.atcOrder"),g("titles.confirm")).then(s=>{s&&u.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(i=>{i.isOk?R.success(g("trading.derivative.atcOrderSuccess")):A(i.message)})}))}function ti(){e.tools.order.tp.price=e.tools.order.entry.price+e.tools.order.side*qe,e.tools.order.sl.price=e.tools.order.entry.price-e.tools.order.side*Qe,u.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.tools.order.tp.price},slData:{cmd:"new",price:e.tools.order.sl.price}}).then(t=>{t.isOk?(e.tools.order.entry.line.applyOptions({draggable:!1}),N(["entry","tp","sl"]),R.success(g("trading.derivative.newTpSlSuccess"))):A(t.message)})}function ii(){f.isSet(e.tools.order.entry.line)?f.isSet(e.tools.order.tp.line)?u.dispatch("tradingDerivative/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(t=>{t.isOk?(J(["entry","tp","sl"]),R.success(g("trading.derivative.exitSuccess"))):A(t.message)}):u.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"delete"}}).then(t=>{t.isOk?(J(["entry"]),R.success(g("trading.derivative.deleteEntrySuccess"))):A(t.message)}):ue()}function Ye(t){f.isSet(e.tools.order.entry.line)&&(f.isSet(e.tools.order.tp.line)?((e.tools.order.side>0&&t>=e.tools.order.tp.price||e.tools.order.side<0&&t<=e.tools.order.tp.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,u.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"delete"}}).then(s=>{s.isOk?(J(["entry","tp","sl"]),R.success(g("trading.derivative.deleteTpSuccess")),pe(!1)):A(s.message),e.isAutoOrdering=!1}))),(e.tools.order.side>0&&t<=e.tools.order.sl.price||e.tools.order.side<0&&t>=e.tools.order.sl.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,u.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"cancel"}}).then(s=>{s.isOk?(J(["entry","tp","sl"]),R.success(g("trading.derivative.deleteSlSuccess")),pe(!1)):A(s.message),e.isAutoOrdering=!1})))):(e.tools.order.side>0&&t>=e.tools.order.entry.price||e.tools.order.side<0&&t<=e.tools.order.entry.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,setTimeout(()=>{e.tools.order.tp.price=e.tools.order.entry.price+e.tools.order.side*qe,e.tools.order.sl.price=e.tools.order.entry.price-e.tools.order.side*Qe,u.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.tools.order.tp.price},slData:{cmd:"new",price:e.tools.order.sl.price}}).then(s=>{s.isOk?(e.tools.order.entry.line.applyOptions({draggable:!1}),N(["entry","tp","sl"]),R.success(g("trading.derivative.autoNewTpSlSuccess"))):A(s.message),e.isAutoOrdering=!1})},1e3))))}function si(){e.chart.timeScale().scrollToRealTime()}function z(){return L.value.openingMarket&&e.currentSeconds>=E.START&&e.currentSeconds<=E.END}function de(t){return parseFloat(e.series.price.coordinateToPrice(t).toFixed(1))}function A(t){t||(t="unknown"),R.error(g(`trading.derivative.${t}`))}function ri(){if(!c.chartDate)return!1;we()}function oi(){e.data.whitespace=[],e.data.price=[],Y(),we()}function ni(){u.dispatch("tradingDerivative/initChart").then(()=>{Y(),!Oe.query.date&&L.value.lastOpeningDate&&(c.chartDate=L.value.lastOpeningDate),we()})}function we(){u.dispatch("tradingDerivative/getChartData",c.chartDate).then(t=>{t&&ue()})}function Ne(){u.dispatch("tradingDerivative/getStatus")}function ue(){u.dispatch("tradingDerivative/getTools")}function j(t){t||(t=["order","lines","tr","pattern","target","pt"]),t.includes("order")&&(e.tools.order={side:0,entry:{},tp:{},sl:{}}),t.includes("lines")&&(e.tools.lines=[]),t.includes("target")&&(e.tools.target={}),t.includes("tr")&&(e.tools.timeRange=[]),t.includes("pattern")&&(e.tools.pattern.lines={}),t.includes("pt")&&(e.tools.pickTime=null)}function ai(){u.dispatch("tradingDerivative/getAccountInfo").then(t=>{let s="";s+='<div style="width: 200px;">',s+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${g("trading.derivative.nav")}</div><div>: ${te.currency(t.nav)}</div></div>`,s+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${g("trading.derivative.maxVol")}</div><div>: ${te.numberVnFormat(t.maxVol)}</div></div>`,s+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${g("trading.derivative.vm")}</div><div>: ${te.currency(t.vm)}</div></div>`,s+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${g("trading.derivative.fee")}</div><div>: ${te.currency(t.fee)}</div></div>`,s+="</div>",Di(s,g("trading.derivative.accountInfo"))})}function S(t,s,i,r=!1){return s?r?t>=i:t>i:r?t<=i:t<i}function I(t){let s=e.data.whitespace.findIndex(i=>i.time===t);if(s===-1){const i=me(new Date(t*1e3),"yyyy-MM-dd"),r=O(new Date(`${i}T11:30:00Z`)),n=O(new Date(`${i}T13:00:00Z`)),o=O(new Date(`${i}T14:30:00Z`));t>r&&t<n?t=r:t>o&&(t=o),s=e.data.whitespace.findIndex(p=>p.time===t)}return s}function fe(t){return t<e.data.whitespace.length?e.data.whitespace[t].time:!1}return(t,s)=>(Oi(),Ci("div",{class:"derivative-chart",ref_key:"chartContainerRef",ref:W,onClick:lt,onContextmenu:ct},[v("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:Le},[v("div",{class:"area data-area",onClick:Ee,onContextmenu:Pe},[v("div",{ref_key:"connectionRef",ref:Ke,class:Z(["command",{yellow:P.value.pending,red:L.value.volInValid}]),title:t.$t("trading.derivative.connection"),onClick:Ne},[v("i",{class:Z(["far",{"fa-link-simple":P.value.connection,"fa-link-simple-slash":!P.value.connection,blink:c.isSocketWarning}])},null,2)],10,Bi),v("div",{class:Z(["command status",{green:P.value.position>0,red:P.value.position<0}]),title:t.$t("trading.derivative.position"),onClick:ai},je(P.value.position),11,Ii),v("div",{class:"command clock",onClick:Y},je(c.clock),1),q(v("input",{type:"date",class:"chart-date command",title:t.$t("trading.derivative.date"),"onUpdate:modelValue":s[0]||(s[0]=i=>c.chartDate=i),onChange:ri},null,40,Vi),[[ki,c.chartDate]]),v("div",{ref_key:"reloadToolRef",ref:it,class:"command",title:t.$t("trading.derivative.reload"),onClick:oi,onContextmenu:ue},[v("i",{class:Z(["far fa-sync-alt",{"fa-spin":ot.value}])},null,2)],40,Mi)],32),v("div",{class:"area tool-area",onClick:Ee,onContextmenu:Pe},[v("div",{ref_key:"fullscreenToolRef",ref:et,class:"command",title:t.$t("trading.derivative.fullscreen"),onClick:ft},[v("i",{class:Z(["far",{"fa-compress":c.isFullscreen,"fa-expand":!c.isFullscreen}])},null,2)],8,Wi),v("div",{ref_key:"tradingviewRef",ref:st,class:"command far fa-chart-candlestick",title:t.$t("trading.derivative.tradingview"),onClick:kt},null,8,Zi),v("div",{class:Z(["context command",{green:c.progress.result===!0,red:c.progress.result===!1}]),title:t.$t("trading.derivative.progressTool"),onClick:wt,onContextmenu:Ft},[v("i",{class:Z(["far",{"fa-badge-check":!c.progress.step,[`fa-circle-${c.progress.step}`]:c.progress.step,blink:L.value.autoRefresh}])},null,2),q(Fe(Ei,{class:"contextmenu",progress:c.progress},null,8,["progress"]),[[ee,c.showProgressContext]])],42,$i),v("div",{ref_key:"scanToolRef",ref:Se,class:"context command",title:t.$t("trading.derivative.scanTool"),onClick:Dt,onContextmenu:Ot},[v("i",{class:Z(["far",{[`fa-angles-${c.scanSide}`]:!0}])},null,2),q(Fe(Ri,{class:"contextmenu",modelValue:c.scanSide,"onUpdate:modelValue":s[1]||(s[1]=i=>c.scanSide=i)},null,8,["modelValue"]),[[ee,c.showScanContext]])],40,Yi),v("div",{ref_key:"patternToolRef",ref:he,class:"command",title:t.$t("trading.derivative.patternTool"),onClick:At,onContextmenu:_t},Xi,40,Ni),v("div",{ref_key:"pickTimeToolRef",ref:ye,class:"command",title:t.$t("trading.derivative.pickTimeTool"),onClick:Mt,onContextmenu:Wt},Hi,40,zi),v("div",{ref_key:"lineToolRef",ref:ie,class:"context command",title:t.$t("trading.derivative.lineTool"),onClick:Xt,onContextmenu:zt},[Qi,q(Fe(Li,{class:"contextmenu",enable:c.showLineContext,title:c.lineTitle,"onUpdate:title":s[2]||(s[2]=i=>c.lineTitle=i),color:c.lineColor,"onUpdate:color":s[3]||(s[3]=i=>c.lineColor=i),onDeleteAllLine:$e},null,8,["enable","title","color"]),[[ee,c.showLineContext]])],40,qi),v("div",{ref_key:"timeRangeToolRef",ref:se,class:"command",title:t.$t("trading.derivative.timeRangeTool"),onClick:$t,onContextmenu:Yt},Ki,40,Ui),v("div",{ref_key:"targetToolRef",ref:xe,class:"command",title:t.$t("trading.derivative.targetTool"),onClick:qt,onContextmenu:Qt},is,40,es),q(v("div",{ref_key:"cancelOrderRef",ref:rt,class:"cancel-order command",title:t.$t("trading.derivative.cancelTool"),onClick:ii},[v("i",{class:Z(["far fa-trash-alt",{blink:c.isOrderWarning}])},null,2)],8,ss),[[ee,nt.value]])],32),v("div",null,[v("div",{ref_key:"entryOrderRef",ref:$,class:"order-button entry",onClick:ei}," Entry ",512),v("div",{ref_key:"tpslOrderRef",ref:Q,class:"order-button tpsl",onClick:ti}," TP/SL ",512),v("div",{class:"chart-top command far fa-angle-double-right",onClick:si})]),q(v("iframe",{ref_key:"tradingviewChartRef",ref:tt,class:"tradingview-chart",style:wi(c.tradingViewStyle),src:at.value},null,12,rs),[[ee,c.showTradingView]])],512)],544))}};export{hs as default};
