import{m as l,a as m,n as u}from"./app-f37d1114.js";import{D as c,a as p}from"./data-grid-ec6370c3.js";import"./moment-53db9517.js";import"./ui.data_grid.row_dragging-72b50656.js";import"./dialog-42ea61b6.js";const g={components:{DxDataGrid:c,DxColumn:p},data(){return{gridData:null,validationRules:{name:[{type:"required",message:this.$t("admin.smartorders.planName")+this.$mt.validations.required}],months:[{type:"required",message:this.$t("admin.smartorders.months")+this.$mt.validations.required}],price:[{type:"required",message:this.$t("admin.smartorders.planPrice")+this.$mt.validations.required}],renewalPrice:[{type:"required",message:this.$t("admin.smartorders.renewalPrice")+this.$mt.validations.required}],highestPrice:[{type:"required",message:this.$t("admin.smartorders.highestPrice")+this.$mt.validations.required}]}}},computed:{...l("Admin.smartorders",["plans"]),popup(){return this.$refs.popup.instance},dataGrid:function(){return this.$refs.dataGrid.instance}},watch:{plans(){this.gridData=this.$mf.cloneDeep(this.plans)}},methods:{...m("Admin.smartorders",["getPlans","savePlans"]),show(){this.popup.show(),this.getPlans(),this.$mf.pushPopupToHistoryState(()=>this.popup.hide())},onSave(t){setTimeout(()=>this.$bus.emit("checkPin",()=>this.savePlans({changes:t.changes})),100)},onHiding(){this.gridData=null,this.$mf.popRouteHistoryState()}}};var v=function(){var e=this,a=e._self._c;return a("DxPopup",{ref:"popup",staticClass:"price-plans-popup",attrs:{showCloseButton:!0,fullScreen:!!e.$devices.phone,"show-title":!0,title:e.$t("admin.smartorders.pricePlans")},on:{hiding:e.onHiding},scopedSlots:e._u([{key:"content",fn:function(){return[a("DxScrollView",[a("div",[a("DxDataGrid",{ref:"dataGrid",attrs:{"data-source":e.gridData,"key-expr":"id","show-borders":!0,"column-auto-width":!0,"allow-column-reordering":!0,"allow-column-resizing":!0,"column-resizing-mode":"widget",paging:{pageSize:8},headerFilter:{visible:!0},loadPanel:{enabled:!0},selection:{mode:"single"},editing:{allowAdding:!0,allowUpdating:!0,allowDeleting:!0,mode:"batch",startEditAction:"dblClick"}},on:{contentReady:function(r){return e.$mf.dataGridPreload(e.gridData,e.dataGrid)},saved:e.onSave},scopedSlots:e._u([{key:"commandCellTemplate",fn:function({data:r}){return[a("DxToolbar",{attrs:{items:[{locateInMenu:"auto",showText:"inMenu",location:"center",widget:"dxButton",options:{type:"default",icon:"trash",hint:e.$t("buttons.delete"),text:e.$t("buttons.delete"),onClick:()=>{e.dataGrid.deleteRow(r.rowIndex)}}}]}})]}}])},[a("DxColumn",{attrs:{fixed:!0,width:35,type:"buttons",cssClass:"dx-datagrid-command-column","cell-template":"commandCellTemplate",caption:e.$t("titles.commandHeaderTitleShort")}}),a("DxColumn",{attrs:{"data-field":"name","data-type":"string",caption:e.$t("admin.smartorders.planName"),"validation-rules":e.validationRules.name}}),a("DxColumn",{attrs:{"data-field":"months","data-type":"number",caption:e.$t("admin.smartorders.months"),"validation-rules":e.validationRules.months}}),a("DxColumn",{attrs:{"data-field":"price","data-type":"number",format:"#,##0","editor-options":{step:"1000",format:"#,##0"},caption:e.$t("admin.smartorders.planPrice"),"validation-rules":e.validationRules.price}}),a("DxColumn",{attrs:{"data-field":"renewal_price","data-type":"number",format:"#,##0","editor-options":{step:"1000",format:"#,##0"},caption:e.$t("admin.smartorders.renewalPrice"),"validation-rules":e.validationRules.renewalPrice}}),a("DxColumn",{attrs:{"data-field":"highest_price","data-type":"number",format:"#,##0","editor-options":{step:"1000",format:"#,##0"},caption:e.$t("admin.smartorders.highestPrice"),"validation-rules":e.validationRules.highestPrice}})],1)],1)])]},proxy:!0}])})},f=[],$=u(g,v,f,!1,null,null,null,null);const w=$.exports;function h(){return{sos:[],users:[],plans:[]}}const _={sos:t=>t.sos,users:t=>t.users,plans:t=>t.plans},x={fetch({commit:t,dispatch:e,getters:a,state:r,rootGetters:i}){return new Promise((s,n)=>{axios.get("so/manage").then(o=>{t("setState",o.data),s()})})},validateDuplicateUser({state:t,rootGetters:e},a){const r=t.sos.find(i=>i.id===a.data.id);return r&&a.value==r.user_code?Promise.resolve(!0):new Promise((i,s)=>{axios.post("so/manage/validate-user",{userCode:a.value},{noLoading:!0}).then(n=>{i(n.data)})})},save({commit:t,dispatch:e,getters:a,state:r,rootGetters:i},s){return new Promise((n,o)=>{axios.post("so/manage",s).then(d=>{n(),d.data.isOk&&e("fetch")})})},getPlans({commit:t,dispatch:e,getters:a,state:r,rootGetters:i}){return new Promise((s,n)=>{axios.get("so/plans").then(o=>{t("setPlans",o.data),s()})})},savePlans({commit:t,dispatch:e,getters:a,state:r,rootGetters:i},s){return new Promise((n,o)=>{axios.post("so/plans",s).then(d=>{n(),d.data.isOk&&e("getPlans")})})},resetState({commit:t}){t("resetState")}},D={setState(t,e){t.sos=e.sos,t.users=e.users},setPlans(t,e){t.plans=e.plans},resetState(t){t=Object.assign(t,h())}},P={namespaced:!0,state:h,getters:_,actions:x,mutations:D};const y={components:{DxDataGrid:c,DxColumn:p,PricePlansPopup:w},data(){return{gridData:null,validationRules:{user:[{type:"required",message:this.$t("admin.smartorders.user")+this.$mt.validations.required},{type:"async",validationCallback:this.validateDuplicateUser,message:this.$t("admin.smartorders.user")+this.$mt.validations.duplicate}],balance:[{type:"periods",message:this.$t("admin.smartorders.periods")+this.$mt.validations.required}],lastTransaction:[{type:"deviceLimit",message:this.$t("admin.smartorders.deviceLimit")+this.$mt.validations.required}],startedAt:[{type:"required",message:this.$t("admin.smartorders.startedAt")+this.$mt.validations.required}]}}},beforeCreate(){this.$store.registerModule("Admin.smartorders",P)},created(){this.fetch()},destroyed(){this.$store.unregisterModule("Admin.smartorders")},computed:{...l("Admin.smartorders",["sos","users"]),dataGrid:function(){return this.$refs.dataGrid.instance}},watch:{sos(){this.cloneDeepData()}},methods:{...m("Admin.smartorders",["fetch","validateDuplicateUser","save"]),onSave(t){this.$bus.emit("checkPin",()=>this.save({changes:t.changes}))},cloneDeepData(){this.gridData=this.$mf.cloneDeep(this.sos)},onInitNewRow(t){t.data.last_transaction=this.$t("admin.smartorders.openNewBook")},onToolbarPreparing(t){t.toolbarOptions.items.unshift({location:"before",widget:"dxButton",options:{icon:"far fa-tags small",hint:this.$t("admin.smartorders.pricePlans"),onClick:()=>{this.$refs.pricePlansPopup.show()}}})}}};var b=function(){var e=this,a=e._self._c;return a("div",{staticClass:"smartorders-page"},[a("h2",{staticClass:"content-block"},[e._v(" "+e._s(e.$t("admin.smartorders.title"))+" ")]),a("div",{staticClass:"content-block dx-card responsive-paddings"},[a("DxDataGrid",{ref:"dataGrid",attrs:{"data-source":e.gridData,"key-expr":"id","show-borders":!0,"column-auto-width":!0,"allow-column-reordering":!0,"allow-column-resizing":!0,"column-chooser":{enabled:!0,mode:"select",allowSearch:!0},"column-resizing-mode":"widget",paging:{pageSize:10},headerFilter:{visible:!0},loadPanel:{enabled:!0},selection:{mode:"single"},editing:{allowAdding:!0,allowUpdating:!0,allowDeleting:!0,confirmDelete:!1,mode:"batch"}},on:{contentReady:function(r){return e.$mf.dataGridPreload(e.gridData,e.dataGrid)},"init-new-row":e.onInitNewRow,"toolbar-preparing":e.onToolbarPreparing,saved:e.onSave},scopedSlots:e._u([{key:"commandCellTemplate",fn:function({data:r}){return[a("DxToolbar",{attrs:{items:[{locateInMenu:"auto",showText:"inMenu",location:"center",widget:"dxButton",options:{type:"default",icon:"far fa-empty-set small",hint:e.$t("admin.smartorders.clearDevices"),text:e.$t("admin.smartorders.clearDevices"),onClick:()=>e.dataGrid.cellValue(r.rowIndex,"devices",[])}},{locateInMenu:"auto",showText:"inMenu",location:"center",widget:"dxButton",options:{type:"default",icon:"trash",hint:e.$t("buttons.delete"),text:e.$t("buttons.delete"),onClick:()=>e.dataGrid.deleteRow(r.rowIndex)}}]}})]}}])},[a("DxColumn",{attrs:{fixed:!0,width:e.$devices.phone?35:70,alignment:"center",type:"buttons",cssClass:"dx-datagrid-command-column","cell-template":"commandCellTemplate",caption:e.$t(`titles.commandHeaderTitle${e.$devices.phone?"Short":""}`)}}),a("DxColumn",{attrs:{"data-field":"user_code",dataType:"number",name:"userCode","header-filter":{allowSearch:!0},caption:e.$t("admin.smartorders.user"),"validation-rules":e.validationRules.user,lookup:{dataSource:e.users,displayExpr:"name",valueExpr:"code",searchEnabled:!0,searchExpr:["code","name"]}}}),a("DxColumn",{attrs:{"data-field":"started_at","data-type":"date","editor-options":{dateSerializationFormat:e.$mc.DX_SERVER_DATE_FORMAT},caption:e.$t("admin.smartorders.startedAt")}}),a("DxColumn",{attrs:{"data-field":"periods",dataType:"string","header-filter":{allowSearch:!0},caption:e.$t("admin.smartorders.periods"),"validation-rules":e.validationRules.periods}}),a("DxColumn",{attrs:{"data-field":"device_limit",dataType:"number","header-filter":{allowSearch:!0},caption:e.$t("admin.smartorders.deviceLimit"),"validation-rules":e.validationRules.deviceLimit}}),a("DxColumn",{attrs:{visible:!1,"data-field":"devices",dataType:"string","header-filter":{allowSearch:!0},caption:e.$t("admin.smartorders.devices")}})],1)],1),a("PricePlansPopup",{ref:"pricePlansPopup"})],1)},C=[],S=u(y,b,C,!1,null,null,null,null);const A=S.exports;export{A as default};
