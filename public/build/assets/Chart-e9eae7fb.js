import{A as rt,B as ot,C as at,r as A,y as Ae,E as ze,o as H,b as J,d as V,G as ce,c as ve,H as Se,I as Te,J as ct,K as lt,F as $e,L as Ie,t as ge,h as fe,e as ie,u as Be,g as je,k as ue,w as Ne,M as pt,m as dt,N as ut,z as He,x as oe,l as be,a as ft,O as mt,Q as vt,j as ht,R as gt}from"./app-7b54428a.js";import{_ as St}from"./button-group-1bf197f1.js";import{_ as yt}from"./text-box-6cd34739.js";import{g as U}from"./getUnixTime-e99c76d5.js";import{c as Tt}from"./lightweight-charts.esm.development-03366bac.js";function qe(N,$,w){return rt((w==null?void 0:w.in)||N,+ot(N)+$)}function ye(N,$,w){return qe(N,$*at,w)}function xt(N,$,w){return qe(N,$*1e3,w)}function kt(N,$,w){return xt(N,-$,w)}const Ct=["title"],_t={__name:"FullscreenTool",props:["chartContainerRef"],setup(N){const $=N,w=A(!1);Ae(()=>{document.addEventListener("fullscreenchange",n)}),ze(()=>{document.removeEventListener("fullscreenchange",n)});function u(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function n(){$.chartContainerRef&&(document.fullscreenElement?(w.value=!0,$.chartContainerRef.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(w.value=!1,$.chartContainerRef.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}return(r,T)=>(H(),J("div",{class:"command",title:r.$t("trading.derivative.fullscreen"),onClick:u},[V("i",{class:ce(["far",{"fa-compress":w.value,"fa-expand":!w.value}])},null,2)],8,Ct))}},wt=["title"],bt=["src"],Rt={__name:"TradingviewTool",props:["vpsUser","vpsSession","chartContainerRef"],setup(N){const $=N,w=A(null),u=A(!1),n=ve(()=>`https://chart.vps.com.vn/tv/?u=${$.vpsUser}&s=${$.vpsSession}&symbol=VN30F1M&resolution=1&lang=vi`);function r(_){u.value=!u.value,T(),_.stopPropagation()}function T(){if($.chartContainerRef&&w.value){const{offsetWidth:_,offsetHeight:l}=$.chartContainerRef,{top:v,left:o}=w.value.getBoundingClientRect();w.value.style.top=`${v-2}px`,w.value.style.left=`${o+32}px`,w.value.style.width=`${_-34}px`,w.value.style.height=`${l}px`}}return(_,l)=>(H(),J("div",{class:"tradingview command far fa-chart-candlestick",title:_.$t("trading.derivative.tradingview"),onClick:r},[Se(V("iframe",{ref_key:"tradingviewRef",ref:w,class:"chart",src:n.value},null,8,bt),[[Te,u.value]])],8,wt))}};const Dt=V("div",{class:"triangle-shadow"},null,-1),Et=V("div",{class:"triangle"},null,-1),Lt={class:"container"},Ot={class:"conditions"},Pt={__name:"ProgressContext",props:["progress"],setup(N){const $=A([]);Ae(()=>{w()});function w(){ct(Object.assign({"../../../../../lang/vi/derivative.js":()=>lt(()=>import("./derivative-abc38cb4.js"),[])}),`../../../../../lang/${window.lang}/derivative.js`).then(n=>{$.value=n.default||[]})}function u(n){n.stopPropagation()}return(n,r)=>(H(),J("div",{class:"pattern-context",onClick:u},[Dt,Et,V("div",Lt,[(H(!0),J($e,null,Ie($.value,(T,_)=>(H(),J("div",{key:_,class:ce(["step"])},[V("div",{class:ce(["step-header",[N.progress.steps?N.progress.steps[_].every(Boolean)?"success":"fail":""]])},ge(_+1)+". "+ge(T.name),3),V("div",Ot,[(H(!0),J($e,null,Ie(T.conds,(l,v)=>(H(),J("div",{key:v,class:ce(["condition",[N.progress.steps?N.progress.steps[_][v]?"success":"fail":""]])},ge(v+1)+". "+ge(l),3))),128))])]))),128))])]))}},$t=["title"],It={__name:"ProgressTool",emits:["refreshPattern","hideContext"],setup(N,{expose:$,emit:w}){const u=fe(),n=w,r=A({}),T=A(!1),_=ve(()=>u.state.tradingDerivative.config.autoRefresh);$({hide:v,set:o});function l(){const I=T.value;n("hideContext"),T.value=!I,T.value&&n("refreshPattern")}function v(I){T.value=I}function o(I){Z(I,r.value),r.value=I}function B(I){const P=I??!P.value;u.dispatch("tradingDerivative/setAutoRefresh",P)}function Z(I,P){if(_.value&&(I.step>P.step||I.step===P.step&&I.result>P.result)){let b="";I.result?[2,4,5].includes(I.step)?b=t("trading.derivative.progressOrder",I):b=t("trading.derivative.progressSuccess",I):b=t("trading.derivative.progressFail",I),M(b)}}function M(I){const P=new SpeechSynthesisUtterance(I);P.lang="vi-VN",speechSynthesis.speak(P)}return(I,P)=>(H(),J("div",{class:ce(["context command",{green:r.value.result===!0,red:r.value.result===!1}]),title:I.$t("trading.derivative.progressTool"),onClick:l,onContextmenu:B},[V("i",{class:ce(["far",{"fa-badge-check":!r.value.step,[`fa-circle-${r.value.step}`]:r.value.step,blink:_.value}])},null,2),Se(ie(Pt,{class:"contextmenu",progress:r.value},null,8,["progress"]),[[Te,T.value]])],42,$t))}};const Nt=V("div",{class:"triangle-shadow"},null,-1),At=V("div",{class:"triangle"},null,-1),Bt={__name:"ScanContext",props:["modelValue"],emits:["update:modelValue"],setup(N,{emit:$}){const{t:w}=Be(),u=[{icon:"chevrondoubleleft",side:"left",text:w("trading.derivative.scanContext.leftScan")},{icon:"chevrondoubleright",side:"right",text:w("trading.derivative.scanContext.rightScan")}],n=N,r=$;function T({itemData:{side:l}}){r("update:modelValue",l)}function _(l){l.stopPropagation()}return(l,v)=>(H(),J("div",{class:"scan-context",onClick:_},[Nt,At,ie(je(St),{items:u,"selected-item-keys":[n.modelValue],"key-expr":"side","styling-mode":"outlined",onItemClick:T},null,8,["selected-item-keys"])]))}},Vt=["title"],Ft={__name:"ScanTool",props:["prices","timeToIndex"],emits:["scaned","removePattern","hideContext"],setup(N,{expose:$,emit:w}){const u=ue("mf"),n=N,r=w,T=A(null),_=A(!1),l=A("left");$({isSelected:v,hide:o,draw:M});function v(){return T.value.classList.contains("selected")}function o(d){_.value=d}function B(d){r("hideContext");const g=d.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(s=>s.classList.remove("selected")),g||(d.target.classList.add("selected"),r("removePattern"))}function Z(){const d=_.value;r("hideContext"),_.value=!d}function M({time:d}){const g=l.value==="left",s=d?n.prices.filter(f=>!u.cmp(f.time,g,d)):n.prices;let p=g?I(s):P(s);u.isSet(p)&&r("scaned",b(p)),T.value.classList.remove("selected")}function I(d){let g,[s,p,f,m]=Array(4).fill({});for(let k=d.length-1;k>=0;k--){const y=d[k].value,h=d[k].time,i=n.timeToIndex(h);if(i===-1)break;if(k===d.length-1&&(f={index:i,time:h,price:y},[p,s,m]=Array(3).fill(null).map(()=>u.cloneDeep(f))),g===void 0){if(y===f.price)continue;g=y>f.price}if(u.cmp(y,g,p.price)&&(u.cmp(s.price,!g,f.price)?([f,p]=[p,s].map(e=>u.cloneDeep(e)),s={index:i,time:h,price:y},m=u.cloneDeep(s),g=!g):p={index:i,time:h,price:y}),u.cmp(y,!g,s.price)?(s={index:i,time:h,price:y},m=u.cloneDeep(s)):m.index=i,u.cmp(y,g,m.price)&&(m={index:i,time:h,price:y}),f.index>s.index){const e=u.fmtNum(p.price-f.price,1,!0);if(e>=1.5&&(s.index-m.index>f.index-p.index||u.fmtNum(s.price-m.price,1,!0)>e))break}}return{A:s,B:p,C:f}}function P(d){let g,[s,p,f]=Array(3).fill({});for(let m=0;m<d.length;m++){const k=d[m].value,y=d[m].time,h=n.timeToIndex(y);if(h===-1)break;if(m===0&&(s={index:h,time:y,price:k},p=u.cloneDeep(s),f=u.cloneDeep(s)),g===void 0){if(k===s.price)continue;g=k>s.price}u.cmp(k,g,p.price)&&(p={index:h,time:y,price:k},f=u.cloneDeep(p)),u.cmp(p.price,g,s.price)&&u.cmp(k,!g,f.price)&&(u.cmp(k,g,s.price)?f={index:h,time:y,price:k}:(s=u.cloneDeep(p),p={index:h,time:y,price:k},f=u.cloneDeep(p),g=!g))}return{A:s,B:p,C:f}}function b(d){const g={};return Object.entries(d).forEach(([s,p])=>{const{index:f,...m}=p;g[s]=m}),g}return(d,g)=>(H(),J("div",{ref_key:"scanToolRef",ref:T,class:"context command",title:d.$t("trading.derivative.scanTool"),onClick:B,onContextmenu:Z},[V("i",{class:ce(["far",{[`fa-angles-${l.value}`]:!0}])},null,2),Se(ie(Bt,{class:"contextmenu",modelValue:l.value,"onUpdate:modelValue":g[0]||(g[0]=s=>l.value=s)},null,8,["modelValue"]),[[Te,_.value]])],40,Vt))}},Mt=["title"],Wt=V("i",{class:"far fa-heart-rate"},null,-1),Zt=[Wt],Yt={__name:"PatternTool",props:["prices","priceSeries","timeMarkSeries","pickTimeToolRef","timeToIndex","indexToTime"],emits:["setProgress","hideContext"],setup(N,{expose:$,emit:w}){const u=fe(),n=ue("mf"),r=N,T=w,_=A(null);let l={},v={};$({isSelected:o,draw:M,load:I,refresh:b,remove:m,drag:h});function o(){return _.value.classList.contains("selected")}function B(i){T("hideContext");const e=i.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(S=>S.classList.remove("selected")),e||(i.target.classList.add("selected"),r.pickTimeToolRef.remove())}function Z(i){i.target.classList.remove("selected"),m()}function M({time:i,price:e}){let c={lineType:"pattern",price:e,lineWidth:1,lineStyle:1,draggable:!0};if(n.isSet(v.A))if(n.isSet(v.B)){let x,O;if(n.isSet(v.C)){let E,R;l.A={time:i,price:e};const{progress:L,timeMark:F,info:{rEpr1:X,rEpr2:z,rEpr3:K,entry:ne,pStatus:ee,x:te,X:se,y:re,Y:W}}=d();O=L,x=F,E="A",R={price:e,title:`A ${X}`},v[E].applyOptions(R),E="B",R={title:`B ${z}`},v[E].applyOptions(R),E="C",R={title:`C ${K}`},v[E].applyOptions(R),E="D",R={price:ne,title:"Entry "+ee},v[E].applyOptions(R),E="X",R={price:n.fmtNum(te),title:`X ${n.fmtNum(se)}`},v[E].applyOptions(R),E="Y",R={price:n.fmtNum(re),title:`Y ${n.fmtNum(W)}`},v[E].applyOptions(R)}else{l.C={price:e};const{progress:E,timeMark:R,info:{rEpr1:L,rEpr2:F,rEpr3:X,entry:z,pStatus:K,x:ne,X:ee,y:te,Y:se}}=d();O=E,x=R;let re="A";v[re].applyOptions({title:`A ${L}`}),re="B",v[re].applyOptions({title:`B ${F}`}),c.point="C",c.title=`C ${X}`,c.color="#FFEB3B",v[c.point]=r.priceSeries.createPriceLine(c),c.point="D",c.price=z,c.title="Entry "+K,c.color="#9C27B0",c.draggable=!1,v[c.point]=r.priceSeries.createPriceLine(c),c.point="Y",c.price=n.fmtNum(te),c.title=`Y ${n.fmtNum(se)}`,c.color="#E91E63",c.draggable=!1,v[c.point]=r.priceSeries.createPriceLine(c),c.point="X",c.price=n.fmtNum(ne),c.title=`X ${n.fmtNum(ee)}`,c.color="#2196F3",c.draggable=!1,v[c.point]=r.priceSeries.createPriceLine(c)}T("setProgress",O),y(x),_.value.classList.remove("selected")}else c.point="B",c.title="B 0",c.color="#4CAF50",v[c.point]=r.priceSeries.createPriceLine(c),l.B={price:e};else c.point="A",c.title="A 0",c.color="#F44336",v[c.point]=r.priceSeries.createPriceLine(c),l={A:{time:i,price:e}};f()}function I(i,e=!1){l=i,e&&f(),k(),P()}function P(){let e={lineType:"pattern",lineWidth:1,lineStyle:1,draggable:!0};const{A:S,B:c,C:x}=l,{progress:O,timeMark:E,info:{rEpr1:R,rEpr2:L,rEpr3:F,entry:X,pStatus:z,x:K,X:ne,y:ee,Y:te}}=d();T("setProgress",O),y(E),e.point="A",e.title=`A ${R}`,e.color="#F44336",e.price=S.price,v[e.point]=r.priceSeries.createPriceLine(e),e.point="B",e.title=`B ${L}`,e.color="#4CAF50",e.price=c.price,v[e.point]=r.priceSeries.createPriceLine(e),e.point="C",e.price=x.price,e.title=`C ${F}`,e.color="#FFEB3B",v[e.point]=r.priceSeries.createPriceLine(e),e.point="D",e.price=X,e.title="Entry "+z,e.color="#9C27B0",e.draggable=!1,v[e.point]=r.priceSeries.createPriceLine(e),e.point="Y",e.price=n.fmtNum(ee),e.title=`Y ${n.fmtNum(te)}`,e.color="#E91E63",e.draggable=!1,v[e.point]=r.priceSeries.createPriceLine(e),e.point="X",e.price=n.fmtNum(K),e.title=`X ${n.fmtNum(ne)}`,e.color="#2196F3",e.draggable=!1,v[e.point]=r.priceSeries.createPriceLine(e)}function b(i=!1){n.isSet(v.C)&&(i&&p(),k(),P())}function d(){const{A:i,B:e,C:S}=l,c=e.price-S.price,x=c>0,O=g({phase:1,start:i,end:e,retracementPrice:S.price});let E=g({phase:2,start:O.R,end:S});const R=g({phase:3,start:E.R,end:{price:e.price+(x?1:-1)*O.rEp},breakPrices:[E.S1.price,e.price]});O.xBox.tr>=E.tr&&(E.tr=O.xBox.tr),console.log("calculatePattern",[O,E,R]);const L=n.fmtNum(c,1,!0)>=O.pr,F=n.fmtNum(S.price-R.xBox.R.price,1,!0)>=E.pr,X=n.fmtNum(R.xBox.pr)>=R.pr,z=!n.cmp(S.price,!x,O.S1.price),K=!n.cmp(R.xBox.R.price,x,E.S1.price),ne=!n.cmp(R.xBox.S.price,!x,R.S1.price),ee=O.R.index+O.tr,te=E.R.index+E.tr,se=R.xBox.R.index+R.tr,re=R.xBox.R.index+E.tr,W=[ee,te,se,re],Q=R.xBox.S.index;let j,q={};const de=[E.R.index>ee,O.rEpr<3,E.rEpr<O.rEpr];q.steps=[[L||O.rEt<O.tr&&O.rEp>=O.sEp,z,!R.breakIndexs[1]||ee<R.breakIndexs[1],Q>ee],[...de,te>ee,Q<te],[E.R.index-O.R.index>.5*O.tr,F,Q>te],[X,ne,Q>se,de.every(Boolean)||Q>re]],q.step=1,q.result=q.steps[0].every(Boolean),j=O.R1.price,q.result&&(Q<=te?(q.step=2,q.result=q.steps[1].every(Boolean),j=E.S1.price):(q.step=3,q.result=q.steps[2].every(Boolean),j=R.R1.price,q.result&&(q.step=4,q.result=q.steps[3].every(Boolean),q.result&&(j=R.xBox.R.price))));const De=`${z?L?1:0:2}${K?F?1:0:2}${ne?X?1:0:2}`,he=O.rEp,xe=s(e.price,he,x),Ee=R.breakIndexs[1]??Q,ae=parseInt((Ee-O.R.index)/O.tr),ke=ae>1?he*ae:he,Le=s(e.price,ke,x);return{progress:q,timeMark:W,info:{rEpr1:O.rEpr,rEpr2:E.rEpr,rEpr3:R.rEpr,entry:j,pStatus:De,x:xe,X:he,y:Le,Y:ke}}}function g({phase:i,start:e,end:S,breakPrices:c,retracementPrice:x}){let O=n.cloneDeep(e),E=n.cloneDeep(S);const R=E.price>O.price;let L={},F={},X={},z=[null,null],K,ne,ee;const te=r.pickTimeToolRef.get();return r.prices.filter(se=>{let re=se.time>=O.time;return te&&(re&=se.time<=te),re}).every((se,re)=>{const W=se.value,Q=se.time,j=r.timeToIndex(Q);return j===-1?!1:((re===0||W===O.price)&&(L={R:{index:j,time:Q,price:W},S:{index:j,time:Q,price:W},pr:0,tr:0},F=n.cloneDeep(L),X=n.cloneDeep(L)),n.cmp(W,R,L.R.price)?(L.pr>F.pr&&(F.pr=L.pr),L.tr>=F.tr&&(F.tr=L.tr,F.R=n.cloneDeep(L.R),F.S=n.cloneDeep(L.S)),i===1&&x&&!n.cmp(L.S.price,!R,x)&&L.tr>=X.tr&&L.pr>=X.pr&&(X=n.cloneDeep(L)),L={R:{index:j,time:Q,price:W},S:{index:j,time:Q,price:W},pr:0,tr:0},i===3&&c&&(!z[0]&&n.cmp(W,R,c[0])&&(z[0]=j),!z[1]&&n.cmp(W,R,c[1])&&(z[1]=j))):(L.S.index=j,L.tr=L.S.index-L.R.index,n.cmp(W,!R,L.S.price)&&(L.S.time=Q,L.S.price=W,L.pr=n.fmtNum(L.S.price-L.R.price,1,!0))),n.cmp(W,!R,O.price)?(L.S.price=O.price,!1):!!n.cmp(W,!R,E.price))}),n.isSet(L)&&(O.index=r.timeToIndex(O.time),E.index=L.S.index,E.time=r.indexToTime(L.S.index),K=n.fmtNum(E.price-F.R.price,1,!0),ne=n.fmtNum(O.price-F.S.price,1,!0),ee=E.index-F.S.index,i===3&&(X=L)),{tr:F.tr,pr:F.pr,rEp:K,sEp:ne,rEpr:F.pr?n.fmtNum(K/F.pr):0,rEt:ee,S1:F.S,R1:F.R,xBox:X,S:O,R:E,breakIndexs:z}}function s(i,e,S){const c=i+(S?1:-1)*e;let x=n.fmtNum(c%1);if(S){if(x>=.1&&x<=.2)return Math.floor(c);if(x>=.6&&x<=.7)return Math.floor(c)+.5}else{if(x>=.8&&x<=.9)return Math.ceil(c);if(x>=.3&&x<=.4)return Math.floor(c)+.5}return c}function p(){if(!r.pickTime)return!1;const i=l.B.price-l.A.price>0,e=r.prices.at(-1).value;if(n.cmp(e,!i,l.C.price)){let S=e;for(let c=r.prices.length-1;c>=0;c--){const x=r.prices[c].value;if(x===l.B.price)break;S=i?Math.min(S,x):Math.max(S,x)}l.C.price=S,f()}}function f(i=!1){let e={isRemove:i,name:"pattern",points:[],data:[]};i?l={}:Object.entries(l).forEach(([S,c])=>{e.points.push(S),e.data.push(c)}),u.dispatch("tradingDerivative/drawTools",e)}function m(){f(!0),r.pickTimeToolRef.remove(),k()}function k(){n.isSet(v.A)&&(r.priceSeries.removePriceLine(v.A),n.isSet(v.B)&&(r.priceSeries.removePriceLine(v.B),n.isSet(v.C)&&(r.priceSeries.removePriceLine(v.C),r.priceSeries.removePriceLine(v.D),r.priceSeries.removePriceLine(v.X),r.priceSeries.removePriceLine(v.Y)))),v={},T("setProgress",{}),y([])}function y(i){const e=["#F44336","#4CAF50","#FFEB3B","#2196F3"];let S=[];for(let c=0;c<i.length;c++){let x=r.indexToTime(i[c]);x&&(i.indexOf(i[c])!==i.lastIndexOf(i[c])&&(x+=c),S.push({time:x,value:1,color:e[c]}))}S.length&&S.sort((c,x)=>c.time-x.time),r.timeMarkSeries.setData(S)}function h({lineOptions:i}){if(n.isSet(v.C)){let e,S;l={A:{time:l.A.time,price:+v.A.options().price},B:{price:+v.B.options().price},C:{price:+v.C.options().price}},f();const{progress:c,timeMark:x,info:{rEpr1:O,rEpr2:E,rEpr3:R,entry:L,pStatus:F,x:X,X:z,y:K,Y:ne}}=d();T("setProgress",c),y(x),e="A",S={title:`A ${O}`},v[e].applyOptions(S),e="B",S={title:`B ${E}`},v[e].applyOptions(S),e="C",S={title:`C ${R}`},v[e].applyOptions(S),e="D",S={price:L,title:"Entry "+F},i.point===e&&delete S.price,v[e].applyOptions(S),e="X",S={price:n.fmtNum(X),title:`X ${n.fmtNum(z)}`},v[e].applyOptions(S),e="Y",S={price:n.fmtNum(K),title:`Y ${n.fmtNum(ne)}`},v[e].applyOptions(S)}}return(i,e)=>(H(),J("div",{ref_key:"patternToolRef",ref:_,class:"command",title:i.$t("trading.derivative.patternTool"),onClick:B,onContextmenu:Z},Zt,40,Mt))}},Ht=["title"],Jt=V("i",{class:"far fa-pipe"},null,-1),Xt=[Jt],zt={__name:"PickTimeTool",props:["pickTimeSeries"],emits:["refreshPattern","hideContext"],setup(N,{expose:$,emit:w}){const u=fe(),n=N,r=w,T=A(null);let _=null;$({isSelected:l,draw:Z,load:M,remove:I,get:v});function l(){return T.value.classList.contains("selected")}function v(){return _}function o(P){r("hideContext");const b=P.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(d=>d.classList.remove("selected")),b||P.target.classList.add("selected")}function B(P){P.target.classList.remove("selected"),I(),r("refreshPattern")}function Z({time:P}){u.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"0_pt",points:[0],data:[P]}),M(P),r("refreshPattern"),T.value.classList.remove("selected")}function M(P){_=P,n.pickTimeSeries.setData([{time:P,value:1,color:"#9C27B0"}])}function I(P=!0){P&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"0_pt"}),n.pickTimeSeries.setData([]),_=null}return(P,b)=>(H(),J("div",{ref_key:"pickTimeToolRef",ref:T,class:"command",title:P.$t("trading.derivative.pickTimeTool"),onClick:o,onContextmenu:B},Xt,40,Ht))}};const jt=V("div",{class:"triangle-shadow"},null,-1),qt=V("div",{class:"triangle"},null,-1),Ut={class:"input"},Qt={class:"color"},Gt=["onClick"],Kt={__name:"LineContext",props:["enable","title","color"],emits:["update:title","update:color"],setup(N,{emit:$}){const w=N,u=$,n=A(null),r=A(["#F44336","#FF9800","#FFEB3B","#4CAF50","#009688","#00BCD4","#2196F3","#673AB7","#9C27B0","#E91E63"]);Ne(()=>w.enable,o=>{o&&pt().then(()=>n.value.instance.focus())});function T({value:o}){u("update:title",o)}function _(o){u("update:color",o)}function l(){u("deleteAllLine")}function v(o){o.stopPropagation()}return(o,B)=>{const Z=dt("DxButton");return H(),J("div",{class:"line-context",onClick:v},[jt,qt,V("div",Ut,[ie(je(yt),{ref_key:"titleRef",ref:n,value:w.title,"show-clear-button":!0,"input-attr":{style:`color:${w.color}`},onValueChanged:T},null,8,["value","input-attr"]),ie(Z,{icon:"trash",type:"danger",onClick:B[0]||(B[0]=M=>l())})]),V("div",Qt,[(H(!0),J($e,null,Ie(r.value,(M,I)=>(H(),J("div",{class:"color-swatch",style:ut({background:M,boxShadow:`0 0 4px ${M}`}),key:I,onClick:P=>_(M)},null,12,Gt))),128))])])}}},ei=["title"],ti=V("i",{class:"far fa-horizontal-rule"},null,-1),ii={__name:"LineTool",props:["priceSeries"],emits:["hideContext"],setup(N,{expose:$,emit:w}){const u=fe(),n=N,r=w,T=A(null),_=A(!1),l=A(""),v=A("#F44336");let o=[];$({isSelected:B,hide:Z,draw:P,load:b,drag:s});function B(){return T.value.classList.contains("selected")}function Z(p){_.value=p}function M(p){r("hideContext");const f=p.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(m=>m.classList.remove("selected")),f||p.target.classList.add("selected")}function I(p){const f=_.value;r("hideContext"),_.value=!f}function P({price:p}){const f="line",m=o.length;if(o=o.filter(k=>{const y=k.options(),h=y.type=p===+y.price;return h&&(n.priceSeries.removePriceLine(k),u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:f,point:p})),!h}),o.length===m){const k=v.value,y=l.value,h={lineType:f,price:p,color:k,title:y,lineWidth:1,lineStyle:1,draggable:!0};o.push(n.priceSeries.createPriceLine(h)),u.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:f,points:[p],data:[{color:k,title:y}]})}T.value.classList.remove("selected")}function b(p){g(!1),d(p)}function d(p){const m={lineType:"line",lineWidth:1,lineStyle:1,draggable:!0};Object.entries(p).forEach(([k,{color:y,title:h}])=>{m.price=+k,m.color=y,m.title=h,o.push(n.priceSeries.createPriceLine(m))})}function g(p=!0){o.length>0&&(p&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line"}),o.forEach(f=>n.priceSeries.removePriceLine(f)),o=[])}function s({lineOptions:p,oldPrice:f,newPrice:m}){u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line",point:f});const k=p.color,y=p.title;u.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"line",points:[m],data:[{color:k,title:y}]}),T.value.classList.remove("selected")}return(p,f)=>(H(),J("div",{ref_key:"lineToolRef",ref:T,class:"context command",title:p.$t("trading.derivative.lineTool"),onClick:M,onContextmenu:I},[ti,Se(ie(Kt,{class:"contextmenu",enable:_.value,title:l.value,"onUpdate:title":f[0]||(f[0]=m=>l.value=m),color:v.value,"onUpdate:color":f[1]||(f[1]=m=>v.value=m),onDeleteAllLine:g},null,8,["enable","title","color"]),[[Te,_.value]])],40,ei))}},ni=["title"],si=V("i",{class:"far fa-grip-lines-vertical"},null,-1),ri=[si],oi={__name:"TimeRangeTool",props:["timeRangeSeries","timeToIndex","indexToTime"],emits:["hideContext"],setup(N,{expose:$,emit:w}){const u=fe(),n=ue("mf"),r=N,T=w,_=A(null);let l=[];$({isSelected:v,draw:Z,load:M});function v(){return _.value.classList.contains("selected")}function o(b){T("hideContext");const d=b.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(g=>g.classList.remove("selected")),d||b.target.classList.add("selected")}function B(b){P(),b.target.classList.remove("selected")}function Z({time:b}){let d={isRemove:!1,name:"tr",points:[],data:[]},g={time:b,value:1};switch(l.length){case 0:g.color="OrangeRed",l[0]=g,d.points.push(0),d.data.push(b);break;case 1:g.color="lime",l[1]=g,d.points.push(1),d.data.push(b),_.value.classList.remove("selected");break;default:const s=r.timeToIndex(l[0].time),p=r.timeToIndex(l[1].time),m=r.timeToIndex(b)+(p-s),k=r.indexToTime(m);g.color="OrangeRed",l[0]=n.cloneDeep(g),d.points.push(0),d.data.push(b),g.time=k,g.color="lime",l[1]=g,d.points.push(1),d.data.push(k),_.value.classList.remove("selected");break}r.timeRangeSeries.setData(l),u.dispatch("tradingDerivative/drawTools",d)}function M(b){P(!1),I(b)}function I(b){let d,g;if(b.length===2)d=b[0],g=b[1];else if(b.length===3){const p=r.timeToIndex(b[0]),f=r.timeToIndex(b[1]),k=r.timeToIndex(b[2])+(f-p);d=b[2],g=r.indexToTime(k)}else return!1;let s=[{time:d,value:1,color:"OrangeRed"},{time:g,value:1,color:"lime"}];l=s,r.timeRangeSeries.setData(s)}function P(b=!0){b&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"tr"}),r.timeRangeSeries.setData([]),l=[]}return(b,d)=>(H(),J("div",{ref_key:"timeRangeToolRef",ref:_,class:"command",title:b.$t("trading.derivative.timeRangeTool"),onClick:o,onContextmenu:B},ri,40,ni))}},ai=["title"],ci=V("i",{class:"far fa-line-height"},null,-1),li=[ci],pi={__name:"TargetTool",props:["priceSeries"],emits:["hideContext"],setup(N,{expose:$,emit:w}){const u=fe(),n=ue("mf"),r=N,T=w,_=A(null);let l={};$({isSelected:v,draw:Z,load:M,drag:b});function v(){return _.value.classList.contains("selected")}function o(d){T("hideContext");const g=d.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(s=>s.classList.remove("selected")),g||(d.target.classList.add("selected"),P())}function B(d){P(),d.target.classList.remove("selected")}function Z({price:d}){const g="target";let s={lineType:g,price:d,lineWidth:1,lineStyle:1,draggable:!0},p={isRemove:!1,name:g,points:[],data:[d]};if(n.isSet(l.A)){const f=+l.A.options().price,m=d-f;s.point="B",s.title=n.fmtNum(m),s.color="#F44336",l[s.point]=r.priceSeries.createPriceLine(s),p.points.push(s.point),s.point="X",s.price=n.fmtNum(f-.5*m),s.title=n.fmtNum(-.5*m),s.color="#2196F3",l[s.point]=r.priceSeries.createPriceLine(s),s.point="Y",s.price=n.fmtNum(f-m),s.title=n.fmtNum(-m),s.color="#673AB7",l[s.point]=r.priceSeries.createPriceLine(s),s.point="Z",s.price=n.fmtNum(f-2*m),s.title=n.fmtNum(-2*m),s.color="#9C27B0",l[s.point]=r.priceSeries.createPriceLine(s),s.point="W",s.price=n.fmtNum(f-4*m),s.title=n.fmtNum(-4*m),s.color="#E91E63",l[s.point]=r.priceSeries.createPriceLine(s),_.value.classList.remove("selected")}else s.point="A",s.title="0",s.color="#FF9800",l[s.point]=r.priceSeries.createPriceLine(s),p.points.push(s.point);u.dispatch("tradingDerivative/drawTools",p)}function M(d){P(!1),I(d)}function I(d){let s={lineType:"target",lineWidth:1,lineStyle:1,draggable:!0};const p=d.A,f=d.B,m=f-p;s.point="A",s.price=p,s.title="0",s.color="#FF9800",l[s.point]=r.priceSeries.createPriceLine(s),s.point="B",s.price=f,s.title=n.fmtNum(m),s.color="#F44336",l[s.point]=r.priceSeries.createPriceLine(s),s.point="X",s.price=n.fmtNum(p-.5*m),s.title=n.fmtNum(-.5*m),s.color="#2196F3",l[s.point]=r.priceSeries.createPriceLine(s),s.point="Y",s.price=n.fmtNum(p-m),s.title=n.fmtNum(-m),s.color="#673AB7",l[s.point]=r.priceSeries.createPriceLine(s),s.point="Z",s.price=n.fmtNum(p-2*m),s.title=n.fmtNum(-2*m),s.color="#9C27B0",l[s.point]=r.priceSeries.createPriceLine(s),s.point="W",s.price=n.fmtNum(p-4*m),s.title=n.fmtNum(-4*m),s.color="#E91E63",l[s.point]=r.priceSeries.createPriceLine(s)}function P(d=!0){d&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"target"}),n.isSet(l.A)&&(r.priceSeries.removePriceLine(l.A),n.isSet(l.B)&&(r.priceSeries.removePriceLine(l.B),r.priceSeries.removePriceLine(l.X),r.priceSeries.removePriceLine(l.Y),r.priceSeries.removePriceLine(l.Z),r.priceSeries.removePriceLine(l.W))),l={}}function b({lineOptions:d,newPrice:g}){if(n.isSet(l.B)){let s={isRemove:!1,name:"target",points:[],data:[]},p,f,m=+l.A.options().price,k=+l.B.options().price,y=k-m;if(p="A",d.point==="A")y=+l.B.options().title,k=m+y;else if(d.point!=="B"){let h=0;switch(d.point){case"X":h=1.5;break;case"Y":h=2;break;case"Z":h=3;break;case"W":h=5;break}y=n.fmtNum((k-g)/h),m=k-y,f={price:m},l[p].applyOptions(f)}s.points.push(p),s.data.push(m),p="B",f={price:k,title:n.fmtNum(y)},d.point===p&&delete f.price,l[p].applyOptions(f),s.points.push(p),s.data.push(k),p="X",f={price:n.fmtNum(m-.5*y),title:n.fmtNum(-.5*y)},d.point===p&&delete f.price,l[p].applyOptions(f),p="Y",f={price:n.fmtNum(m-y),title:n.fmtNum(-y)},d.point===p&&delete f.price,l[p].applyOptions(f),p="Z",f={price:n.fmtNum(m-2*y),title:n.fmtNum(-2*y)},d.point===p&&delete f.price,l[p].applyOptions(f),p="W",f={price:n.fmtNum(m-4*y),title:n.fmtNum(-4*y)},d.point===p&&delete f.price,l[p].applyOptions(f),u.dispatch("tradingDerivative/drawTools",s)}}return(d,g)=>(H(),J("div",{ref_key:"targetToolRef",ref:_,class:"command",title:d.$t("trading.derivative.targetTool"),onClick:o,onContextmenu:B},li,40,ai))}},di=["title"],Je=3,Xe=2,ui={__name:"OrderTool",props:["position","prices","priceSeries","inSession","TIME"],emits:["getTools","showEntry","showTpSl","hideContext"],setup(N,{expose:$,emit:w}){const u=fe(),{t:n}=Be(),r=ue("mf"),T=N,_=w,l=A(null),v=A(!1);let o={entry:{},tp:{},sl:{}},B=!1;$({has:Z,show:M,entry:I,tpsl:P,cancel:b,cancelWithoutClose:d,scan:g,load:p,drag:k});function Z(){return r.isSet(o.entry.line)||r.isSet(o.tp.line)}function M({price:h}){if(T.inSession()){const i=U(ye(new Date,7));if(r.isSet(o.entry.line))!r.isSet(o.tp.line)&&T.position&&i>T.TIME.ATO&&i<T.TIME.ATC&&_("showTpSl");else{let e=null,S=0;T.position?(i<T.TIME.ATO?e="ATO":i>T.TIME.ATC&&(e="ATC"),e&&(o.entry.price=e,S=-T.position)):i>T.TIME.ATO&&i<T.TIME.ATC&&(e=h,S=e>=T.prices.at(-1).value?1:-1,o.side=S,o.entry.price=e),S&&_("showEntry")}}}function I(){if(T.inSession()){const h=U(ye(new Date,7));h<T.TIME.ATO?He(n("trading.derivative.atoOrder"),n("titles.confirm")).then(e=>{e&&u.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(S=>{S.isOk?oe.success(n("trading.derivative.atoOrderSuccess")):y(S.message)})}):h>T.TIME.ATC?He(n("trading.derivative.atcOrder"),n("titles.confirm")).then(e=>{e&&u.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(S=>{S.isOk?oe.success(n("trading.derivative.atcOrderSuccess")):y(S.message)})}):u.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"new",side:o.side,price:o.entry.price}}).then(i=>{i.isOk?(s(["entry"]),oe.success(n("trading.derivative.newEntrySuccess"))):y(i.message)})}}function P(){o.tp.price=o.entry.price+o.side*Je,o.sl.price=o.entry.price-o.side*Xe,u.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:o.tp.price},slData:{cmd:"new",price:o.sl.price}}).then(h=>{h.isOk?(o.entry.line.applyOptions({draggable:!1}),s(["entry","tp","sl"]),oe.success(n("trading.derivative.newTpSlSuccess"))):y(h.message)})}function b(){r.isSet(o.entry.line)?r.isSet(o.tp.line)?u.dispatch("tradingDerivative/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(h=>{h.isOk?(m(["entry","tp","sl"]),oe.success(n("trading.derivative.exitSuccess"))):y(h.message)}):u.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"delete"}}).then(h=>{h.isOk?(m(["entry"]),oe.success(n("trading.derivative.deleteEntrySuccess"))):y(h.message)}):_("getTools")}function d(){if(T.inSession()&&T.position){const h=U(ye(new Date,7));h>T.TIME.ATC-5*60&&(v.value=!0,h>T.TIME.ATC-15&&r.isSet(o.tp.line)&&u.dispatch("tradingDerivative/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(i=>{i.isOk?(m(["entry","tp","sl"]),oe.success(n("trading.derivative.autoCancelTpSlSuccess"))):y(i.message)}))}}function g(h){if(r.isSet(o.entry.line)){const i=o.side>0;r.isSet(o.tp.line)?(r.cmd(h,i,o.tp.price,!0)&&(B||(B=!0,u.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"delete"}}).then(e=>{e.isOk?(m(["entry","tp","sl"]),oe.success(n("trading.derivative.deleteTpSuccess")),toggleOrderButton(!1)):y(e.message),B=!1}))),r.cmd(h,!i,o.sl.price,!0)&&(B||(B=!0,u.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"cancel"}}).then(e=>{e.isOk?(m(["entry","tp","sl"]),oe.success(n("trading.derivative.deleteSlSuccess")),toggleOrderButton(!1)):y(e.message),B=!1})))):r.cmd(h,i,o.entry.price,!0)&&(B||(B=!0,setTimeout(()=>{o.tp.price=o.entry.price+o.side*Je,o.sl.price=o.entry.price-o.side*Xe,u.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:o.tp.price},slData:{cmd:"new",price:o.sl.price}}).then(e=>{e.isOk?(o.entry.line.applyOptions({draggable:!1}),s(["entry","tp","sl"]),oe.success(n("trading.derivative.autoNewTpSlSuccess"))):y(e.message),B=!1})},1e3)))}}function s(h){const i="order";let e={isRemove:!1,name:i,points:[],data:[]},S,c;h.forEach(x=>{const O=o.entry.price,E=o.tp.price,R=o.sl.price;switch(x){case"entry":S="yellow",c=o.side>0?"LONG":"SHORT";break;case"tp":S="lime",c=r.fmtNum(E-O,1,!0);break;case"sl":S="red",c=r.fmtNum(R-O,1,!0);break}if(e.points.push(x),r.isSet(o[x].line))o[x].line.applyOptions({price:o[x].price,title:c}),e.data.push(o[x].line.options());else{const L={lineType:i,kind:x,side:o.side,price:o[x].price,color:S,lineWidth:1,lineStyle:0,title:c,draggable:!0};o[x].line=T.priceSeries.createPriceLine(L),e.data.push(L)}}),u.dispatch("tradingDerivative/drawTools",e)}function p(h){m(["entry","tp","sl"],!1),f(h)}function f(h){Object.entries(h).forEach(([i,e])=>{i==="entry"&&(o.side=e.side),o[i].price=e.price,o[i].line=T.priceSeries.createPriceLine(e)})}function m(h,i=!0){i&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"order"}),h.forEach(e=>{r.isSet(o[e].line)&&(T.priceSeries.removePriceLine(o[e].line),delete o[e].line)})}function k({line:h,lineOptions:i,oldPrice:e,newPrice:S}){if(S!==e){let c=!1;i.kind==="entry"?T.position||(c=!0,o[i.kind].price=S,u.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"change",price:o.entry.price}}).then(x=>{x.isOk?(s([i.kind]),oe.success(n("trading.derivative.changeEntrySuccess"))):(h.applyOptions({price:e}),y(x.message))})):(c=!0,o[i.kind].price=S,i.kind==="tp"?u.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"change",price:o.tp.price}}).then(x=>{x.isOk?(s([i.kind]),oe.success(n("trading.derivative.changeTpSuccess"))):(h.applyOptions({price:e}),y(x.message))}):u.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"change",price:o.sl.price}}).then(x=>{x.isOk?(s([i.kind]),oe.success(n("trading.derivative.changeSlSuccess"))):(h.applyOptions({price:e}),y(x.message))})),c||(h.applyOptions({price:e}),oe.show(n("trading.derivative.noChangeOrderLine")))}}function y(h){h||(h="unknown"),oe.error(n(`trading.derivative.${h}`))}return(h,i)=>(H(),J("div",{ref_key:"orderToolRef",ref:l,class:"cancel-order command",title:h.$t("trading.derivative.orderTool"),onClick:b},[V("i",{class:ce(["far fa-trash-alt",{blink:v.value}])},null,2)],8,di))}};const fi=["title"],mi=["title"],vi=["title"],hi=["title"],gi="wss://tradestation.fireant.vn/quote?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",Si="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",_i={__name:"Chart",setup(N,{expose:$}){const w={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.25,bottom:.25}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:1e3,minBarSpacing:.01,barSpacing:.05}},u=be(new Date,"yyyy-MM-dd"),n={START:U(new Date(`${u}T08:45:00Z`)),ATO:U(new Date(`${u}T09:00:00Z`)),ATC:U(new Date(`${u}T14:30:00Z`)),END:U(new Date(`${u}T14:45:00Z`))},r=fe(),T=ht(),{t:_}=Be(),l=ue("devices"),v=ue("mf"),o=ue("filters"),B=A(null),Z=A(null),M=A(null),I=A(null),P=A(null),b=A(null),d=A(null),g=A(null),s=A(null),p=A(null),f=A(null),m=A(null),k=A(null),y=A(null),h=A(null);let i={chart:{},whitespaces:[],crosshair:{},interval:null,interval60:null,websocket:null,socketStop:!1,vpsUpdatedAt:kt(new Date,61)};const e=ft({prices:[],series:{},chartDate:T.query.date??u,clock:be(new Date,"HH:mm:ss"),isSocketWarning:!1,progress:{},TIME:n}),S=ve(()=>r.state.tradingDerivative.status),c=ve(()=>r.state.tradingDerivative.config),x=ve(()=>r.state.tradingDerivative.tools),O=ve(()=>r.state.tradingDerivative.isLoading),E=ve(()=>S.value.position||S.value.pending||k.value&&k.value.has());i.interval=setInterval(()=>{k.value&&k.value.cancelWithoutClose(),e.clock=be(new Date,"HH:mm:ss")},1e3),i.interval60=setInterval(()=>{Ce()?(We(),c.value.autoRefresh&&g.value.refresh(!0)):clearInterval(i.interval60)},6e4),nt(),Ae(()=>{R(),new ResizeObserver(te).observe(B.value),document.addEventListener("keydown",se)}),ze(()=>{L(),document.removeEventListener("keydown",se),clearInterval(i.interval),clearInterval(i.interval60),Re(),i.socketStop=!0}),Ne(()=>r.state.tradingDerivative.chartData,re),Ne(x,q),$({connectSocket:de});function R(){i.chart=Tt(Z.value,w),i.chart.subscribeCrosshairMove(ne),i.chart.subscribeCustomPriceLineDragged(ee),e.series.whitespace=i.chart.addHistogramSeries({priceScaleId:"whitespace",scaleMargins:{top:0,bottom:0},color:"#808080",lastValueVisible:!1,priceLineVisible:!1}),e.series.timeRange=i.chart.addHistogramSeries({priceScaleId:"timeRange",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),e.series.pickTime=i.chart.addHistogramSeries({priceScaleId:"pickTime",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),e.series.timeMark=i.chart.addHistogramSeries({priceScaleId:"timeMark",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),e.series.price=i.chart.addLineSeries({color:"#F5F5F5",priceFormat:{minMove:.1}})}function L(){i.chart&&(i.chart.remove(),i.chart=null)}function F(a){ae(),Me(!1),m.value.isSelected()?m.value.draw({time:i.crosshair.time}):g.value.isSelected()?g.value.draw({time:i.crosshair.time,price:we(i.crosshair.y)}):s.value.isSelected()?s.value.draw({time:i.crosshair.time}):d.value.isSelected()?d.value.draw({price:we(i.crosshair.y)}):f.value.isSelected()?f.value.draw({time:i.crosshair.time}):p.value.isSelected()&&p.value.draw({price:we(i.crosshair.y)})}function X(a){Me(!0),a.preventDefault()}function z(a){a.stopPropagation()}function K(a){a.preventDefault(),a.stopPropagation()}function ne(a){if(a.time){let D=a.seriesPrices.get(e.series.price);i.crosshair.time=a.time,i.crosshair.price=D}else l.phone||(i.crosshair.time=null,i.crosshair.price=null);a.point!==void 0&&(i.crosshair.x=a.point.x,i.crosshair.y=a.point.y)}function ee(a){let D=a.customPriceLine,C=D.options();C.price=v.fmtNum(C.price);const Y=+a.fromPriceString,G=C.price;switch(C.lineType){case"order":k.value.drag({line:D,lineOptions:C,oldPrice:Y,newPrice:G});break;case"line":d.value.drag({lineOptions:C,oldPrice:Y,newPrice:G});break;case"target":p.value.drag({lineOptions:C,newPrice:G});break;case"pattern":g.value.drag({lineOptions:C});break}}function te(){B.value&&(i.chart.resize(B.value.offsetWidth,B.value.offsetHeight),B.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function se(a){if(a.ctrlKey)switch(a.keyCode){case 219:i.chart.timeScale().applyOptions({barSpacing:i.chart.options().timeScale.barSpacing-.01});break;case 221:i.chart.timeScale().applyOptions({barSpacing:i.chart.options().timeScale.barSpacing+.01});break}if(a.altKey)switch(a.keyCode){case 219:i.chart.timeScale().scrollToPosition(i.chart.timeScale().scrollPosition()-50);break;case 221:i.chart.timeScale().scrollToPosition(i.chart.timeScale().scrollPosition()+50);break}}function re(a){e.chartDate===u&&Ce()||(a.price.length>0&&(i.whitespaces=j(i.whitespaces,Q(e.chartDate))),e.series.whitespace.setData(i.whitespaces),e.prices=j(e.prices,a.price),e.series.price.setData(e.prices))}function W(a,D=null){const C=D??c.value.source;let Y=[];a.forEach(G=>{let le,pe;C==="FireAnt"?(le=U(ye(new Date(G.date),7)),pe=G.price):(le=U(new Date(`${u}T${G.time}Z`)),pe=G.lastPrice),Y.push({time:le,value:pe})}),Y.length>1?(e.prices=j(e.prices,Y),e.series.price.setData(e.prices)):(e.prices.push(Y[0]),e.series.price.update(Y[0]))}function Q(a){const D=U(new Date(`${a}T09:00:00Z`)),C=U(new Date(`${a}T11:30:00Z`)),Y=U(new Date(`${a}T13:00:00Z`)),G=U(new Date(`${a}T14:30:00Z`)),le=U(new Date(`${a}T14:00:00Z`));let pe=[];for(let me=D;me<=G;me++){if(me>C&&me<Y)continue;let Ye={time:me};(me===le||me===G)&&(Ye.value=1),pe.push(Ye)}return pe}function j(a,D){return Array.from(new Map([...a,...D].sort((C,Y)=>C.time-Y.time).map(C=>[C.time,C])).values())}function q(a){Object.entries(a).forEach(([D,C])=>{switch(D){case"order":k.value.load(C);break;case"pattern":ke(C)&&g.value.load(v.cloneDeep(C));break;case"tr":f.value.load(C);break;case"0_pt":s.value.load(C[0]);break;case"line":d.value.load(C);break;case"target":p.value.load(C);break}})}async function de(){if(Ce()){await Re();const a=c.value.source==="FireAnt",D=a?gi:Si;i.websocket=new WebSocket(D),i.websocket.onclose=C=>{i.socketStop||(e.isSocketWarning=!0,de())},a?Ve():(he(),De())}}async function Re(){i.websocket&&i.websocket.readyState===WebSocket.OPEN&&(i.websocket.close(),await new Promise(a=>{const D=setInterval(()=>{(!i.websocket||i.websocket.readyState===WebSocket.CLOSED)&&(i.websocket=null,clearInterval(D),a())},100)}))}function Ve(){r.dispatch("tradingDerivative/setLoading",!0),i.websocket.onopen=a=>{if(i.websocket.readyState===WebSocket.OPEN){let D='{"protocol":"json","version":1}';i.websocket.send(D),D='{"arguments":["VN30F1M"],"invocationId":"0","target":"SubscribeTrades","type":1}',i.websocket.send(D)}},i.websocket.onmessage=a=>{e.isSocketWarning=!1,Fe(a.data).forEach(C=>{if(!C)return!1;C.type===3?(C.result[0].date.slice(0,10)===u&&(_e(),i.whitespaces=j(i.whitespaces,Q(u)),e.series.whitespace.setData(i.whitespaces),W(C.result)),r.dispatch("tradingDerivative/setLoading",!1)):C.type===1&&C.target==="UpdateTrades"&&C.arguments[0]==="VN30F1M"&&(console.log("FireAnt",C.arguments[1]),k.value.scan(C.arguments[1].at(-1).price),W(C.arguments[1]))})}}function Fe(a){let D=[];return a.split("").forEach(C=>{const Y=C.indexOf("{"),G=C.lastIndexOf("}");let le=null;if(Y!==-1&&G!==-1&&G>Y){const pe=C.substring(Y,G+1);pe!=="{}"&&(le=JSON.parse(pe))}D.push(le)}),D}function De(){i.websocket.onopen=a=>{if(i.websocket.readyState===WebSocket.OPEN){const D={action:"join",list:c.value.vn30f1m},C=`42${JSON.stringify(["regs",JSON.stringify(D)])}`;i.websocket.send(C)}},i.websocket.onmessage=a=>{if(e.isSocketWarning=!1,a.data.substr(0,1)==="4"&&a.data.substr(1,1)==="2"){const D=JSON.parse(a.data.substr(2));if(D[0]==="stockps"){const C=D[1].data;C.id===3220&&(console.log("VPS",C),k.value.scan(C.lastPrice),W([C]))}}}}function he(){mt(new Date,new Date(i.vpsUpdatedAt))>60&&(fetch("https://bddatafeed.vps.com.vn/getpschartintraday/VN30F1M").then(a=>a.json()).then(a=>{console.log(a),W(a,"VPS")}),i.vpsUpdatedAt=new Date)}function xe(){g.value.refresh()}function Ee(a){g.value.load(a,!0)}function ae(){b.value.hide(),m.value.hide(),d.value.hide()}function ke({A:{time:a}}){return i.whitespaces.some(D=>D.time===a)}function Le(a){b.value.set(a)}function Me(a){a?k.value.show({price:we(i.crosshair.y)}):(y.value.style.display="none",h.value.style.display="none")}function Ue(){y.value.style.left=+(i.crosshair.x+(i.crosshair.x>innerWidth-71?-71:1))+"px",y.value.style.top=+(i.crosshair.y+(i.crosshair.y>innerHeight-61?-61:1))+"px",y.value.style.background=side>0?"green":"red",y.value.innerText=`${side>0?"LONG":"SHORT"} ${price}`,y.value.style.display="block"}function Qe(){h.value.style.left=+(i.crosshair.x+(i.crosshair.x>innerWidth-61?-61:1))+"px",h.value.style.top=+(i.crosshair.y+(i.crosshair.y>innerHeight-51?-51:1))+"px",h.value.style.display="block"}function Ge(){k.value.entry()}function Ke(){k.value.tpsl()}function et(){i.chart.timeScale().scrollToRealTime()}function Ce(){const a=U(ye(new Date,7));return c.value.openingMarket&&a>=n.START&&a<=n.END}function tt(){if(!e.chartDate)return!1;Oe()}function it(){i.whitespaces=[],e.prices=[],de(),Oe()}function nt(){r.dispatch("tradingDerivative/initChart").then(()=>{de(),!T.query.date&&c.value.lastOpeningDate&&(e.chartDate=c.value.lastOpeningDate),Oe()})}function Oe(){r.dispatch("tradingDerivative/getChartData",e.chartDate).then(a=>{a&&_e()})}function We(){r.dispatch("tradingDerivative/getStatus")}function _e(){r.dispatch("tradingDerivative/getTools")}function st(){r.dispatch("tradingDerivative/getAccountInfo").then(a=>{let D="";D+='<div style="width: 200px;">',D+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${_("trading.derivative.nav")}</div><div>: ${o.currency(a.nav)}</div></div>`,D+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${_("trading.derivative.maxVol")}</div><div>: ${o.numberVnFormat(a.maxVol)}</div></div>`,D+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${_("trading.derivative.vm")}</div><div>: ${o.currency(a.vm)}</div></div>`,D+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${_("trading.derivative.fee")}</div><div>: ${o.currency(a.fee)}</div></div>`,D+="</div>",gt(D,_("trading.derivative.accountInfo"))})}function we(a){return v.fmtNum(e.series.price.coordinateToPrice(a))}function Pe(a){let D=i.whitespaces.findIndex(C=>C.time===a);if(D===-1){const C=be(new Date(a*1e3),"yyyy-MM-dd"),Y=U(new Date(`${C}T11:30:00Z`)),G=U(new Date(`${C}T13:00:00Z`)),le=U(new Date(`${C}T14:30:00Z`));a>Y&&a<G?a=Y:a>le&&(a=le),D=i.whitespaces.findIndex(pe=>pe.time===a)}return D}function Ze(a){return a<i.whitespaces.length?i.whitespaces[a].time:!1}return(a,D)=>(H(),J("div",{class:"derivative-chart",ref_key:"chartContainerRef",ref:B,onClick:F,onContextmenu:X},[V("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:Z},[V("div",{class:"area data-area",onClick:z,onContextmenu:K},[V("div",{ref_key:"connectionRef",ref:M,class:ce(["command",{yellow:S.value.pending,red:c.value.volInValid}]),title:a.$t("trading.derivative.connection"),onClick:We},[V("i",{class:ce(["far",{"fa-link-simple":S.value.connection,"fa-link-simple-slash":!S.value.connection,blink:e.isSocketWarning}])},null,2)],10,fi),V("div",{class:ce(["command status",{green:S.value.position>0,red:S.value.position<0}]),title:a.$t("trading.derivative.position"),onClick:st},ge(S.value.position),11,mi),V("div",{class:"command clock",onClick:de},ge(e.clock),1),Se(V("input",{type:"date",class:"chart-date command",title:a.$t("trading.derivative.date"),"onUpdate:modelValue":D[0]||(D[0]=C=>e.chartDate=C),onChange:tt},null,40,vi),[[vt,e.chartDate]]),V("div",{ref_key:"reloadToolRef",ref:I,class:"command",title:a.$t("trading.derivative.reload"),onClick:it,onContextmenu:_e},[V("i",{class:ce(["far fa-sync-alt",{"fa-spin":O.value}])},null,2)],40,hi)],32),V("div",{class:"area tool-area",onClick:z,onContextmenu:K},[ie(_t,{chartContainerRef:B.value},null,8,["chartContainerRef"]),ie(Rt,{ref_key:"tradingviewRef",ref:P,vpsUser:c.value.vpsUser,vpsSession:c.value.vpsSession,chartContainerRef:B.value},null,8,["vpsUser","vpsSession","chartContainerRef"]),ie(It,{ref_key:"progressToolRef",ref:b,onRefreshPattern:xe,onHideContext:ae},null,512),ie(Ft,{ref_key:"scanToolRef",ref:m,prices:e.prices,timeToIndex:Pe,onScaned:Ee,onRemovePattern:D[1]||(D[1]=()=>g.value.remove()),onHideContext:ae},null,8,["prices"]),ie(Yt,{ref_key:"patternToolRef",ref:g,prices:e.prices,priceSeries:e.series.price,timeMarkSeries:e.series.timeMark,pickTimeToolRef:s.value,timeToIndex:Pe,indexToTime:Ze,onSetProgress:Le,onHideContext:ae},null,8,["prices","priceSeries","timeMarkSeries","pickTimeToolRef"]),ie(zt,{ref_key:"pickTimeToolRef",ref:s,pickTimeSeries:e.series.pickTime,onRefreshPattern:xe,onHideContext:ae},null,8,["pickTimeSeries"]),ie(ii,{ref_key:"lineToolRef",ref:d,priceSeries:e.series.price,onHideContext:ae},null,8,["priceSeries"]),ie(oi,{ref_key:"timeRangeToolRef",ref:f,timeRangeSeries:e.series.timeRange,timeToIndex:Pe,indexToTime:Ze,onHideContext:ae},null,8,["timeRangeSeries"]),ie(pi,{ref_key:"targetToolRef",ref:p,priceSeries:e.series.price,onHideContext:ae},null,8,["priceSeries"]),Se(ie(ui,{ref_key:"orderToolRef",ref:k,position:S.value.position,prices:e.prices,priceSeries:e.series.price,inSession:Ce,TIME:e.TIME,onGetTools:_e,onShowEntry:Ue,onShowTpSl:Qe,onHideContext:ae},null,8,["position","prices","priceSeries","TIME"]),[[Te,E.value]])],32),V("div",null,[V("div",{ref_key:"entryOrderRef",ref:y,class:"order-button entry",onClick:Ge}," Entry ",512),V("div",{ref_key:"tpslOrderRef",ref:h,class:"order-button tpsl",onClick:Ke}," TP/SL ",512),V("div",{class:"chart-top command far fa-angle-double-right",onClick:et})])],512)],544))}};export{_i as default};
