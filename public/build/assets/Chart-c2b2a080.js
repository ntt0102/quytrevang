import{A as li,B as ci,C as pi,l as ge,u as di,r as w,a as ui,c as H,y as fi,E as mi,w as Je,x as D,b as vi,d as v,G as W,t as He,H as j,I as gi,J as te,e as Fe,K as hi,h as xi,j as yi,k as De,z as je,L as Si,o as Ci}from"./app-5f01ca70.js";import Ti from"./LineContext-ca964f54.js";import wi from"./ScanContext-0f286108.js";import ki from"./ProgressContext-be18482d.js";import{c as Fi}from"./lightweight-charts.esm.development-03366bac.js";import{g as b}from"./getUnixTime-325f33a1.js";import"./text-box-1d5717b6.js";function Di(q,Q,O){return li((O==null?void 0:O.in)||q,+ci(q)+Q)}function be(q,Q,O){return Di(q,Q*pi,O)}const bi=["title"],Li=["title"],Oi=["title"],Ri=["title"],Ei=["title"],Pi=["title"],Ai=["title"],_i=["title"],Bi=["title"],Ii=v("i",{class:"far fa-heart-rate"},null,-1),Mi=[Ii],Vi=["title"],Wi=v("i",{class:"far fa-pipe"},null,-1),Zi=[Wi],$i=["title"],Yi=v("i",{class:"far fa-horizontal-rule"},null,-1),Ni=["title"],Xi=v("i",{class:"far fa-grip-lines-vertical"},null,-1),zi=[Xi],Ji=["title"],Hi=v("i",{class:"far fa-line-height"},null,-1),ji=[Hi],qi=["title"],Qi=["src"],qe=3,Qe=2,Ui="wss://tradestation.fireant.vn/quote?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",sr={__name:"Chart",setup(q){const Q={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.25,bottom:.25}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:1e3,minBarSpacing:.01,barSpacing:.05}},O=ge(new Date,"yyyy-MM-dd"),R={START:b(new Date(`${O}T08:45:00Z`)),ATO:b(new Date(`${O}T09:00:00Z`)),ATC:b(new Date(`${O}T14:30:00Z`)),END:b(new Date(`${O}T14:45:00Z`))},u=xi(),Le=yi(),{t:h}=di(),Ue=De("devices"),m=De("mf"),ie=De("filters"),I=w(null),Oe=w(null),Ge=w(null),Ke=w(null),et=w(null),tt=w(null),it=w(null),re=w(null),he=w(null),xe=w(null),ye=w(null),oe=w(null),Se=w(null),rt=w(null),$=w(null),U=w(null);let e={chart:{},series:{},data:{whitespace:[],price:[]},tools:{},crosshair:{},interval:null,interval60:null,websocket:null,isAutoOrdering:!1,socketStop:!1,socketSendData:null,currentSeconds:b(be(new Date,7))};z();const c=ui({chartDate:Le.query.date??O,clock:ge(new Date,"HH:mm:ss"),isFullscreen:!1,isSocketWarning:!1,isOrderWarning:!1,lineColor:"#F44336",lineTitle:"",progress:{},scanSide:"left",showProgressContext:!1,showScanContext:!1,showLineContext:!1,showTradingView:!1,tradingViewStyle:{left:"32px"}}),E=H(()=>u.state.tradingDerivative.status),M=H(()=>u.state.tradingDerivative.config),Re=H(()=>u.state.tradingDerivative.tools),ot=H(()=>u.state.tradingDerivative.isChartLoading),st=H(()=>E.value.position!=0||!!E.value.pending||!!Re.value.order),nt=H(()=>`https://chart.vps.com.vn/tv/?u=${M.value.vpsUser}&s=${M.value.vpsSession}&symbol=VN30F1M&resolution=1&lang=vi`);u.dispatch("tradingDerivative/initChart").then(()=>{Z()&&Ce(),!Le.query.date&&M.value.lastOpeningDate&&(c.chartDate=M.value.lastOpeningDate),u.dispatch("tradingDerivative/getChartData",c.chartDate).then(i=>{i&&ue()})}),e.interval=setInterval(gt,1e3),e.interval60=setInterval(()=>{Z()?(Ne(),M.value.autoRefresh&&ne(!0)):clearInterval(e.interval60)},6e4),fi(()=>{e.chart=Fi(Oe.value,Q),e.chart.subscribeCrosshairMove(ct),e.chart.subscribeCustomPriceLineDragged(pt),e.series.whitespace=e.chart.addHistogramSeries({priceScaleId:"whitespace",scaleMargins:{top:0,bottom:0},color:"#808080",lastValueVisible:!1,priceLineVisible:!1}),e.series.timeRange=e.chart.addHistogramSeries({priceScaleId:"timeRange",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),e.series.pickTime=e.chart.addHistogramSeries({priceScaleId:"pickTime",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),e.series.timeMark=e.chart.addHistogramSeries({priceScaleId:"timeMark",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),e.series.price=e.chart.addLineSeries({color:"#F5F5F5",priceFormat:{minMove:.1}}),new ResizeObserver(dt).observe(I.value),document.addEventListener("keydown",Ae),document.addEventListener("fullscreenchange",_e)}),mi(()=>{e.chart&&(e.chart.remove(),e.chart=null),document.removeEventListener("keydown",Ae),document.removeEventListener("fullscreenchange",_e),clearInterval(e.interval),clearInterval(e.interval60),e.websocket&&(e.websocket.close(),e.websocket=null),e.socketStop=!0}),Je(()=>u.state.tradingDerivative.chartData,mt),Je(()=>Re.value,ft);function at(i){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1,pe(!1),re.value.classList.contains("selected")?$t():ye.value.classList.contains("selected")?zt():oe.value.classList.contains("selected")?Mt():Se.value.classList.contains("selected")?wt():he.value.classList.contains("selected")?Ot():xe.value.classList.contains("selected")&&_t()}function lt(i){pe(!0),i.preventDefault()}function Ee(i){i.stopPropagation()}function Pe(i){i.preventDefault(),i.stopPropagation()}function ct(i){if(i.time){let r=i.seriesPrices.get(e.series.price);e.crosshair.time=i.time,e.crosshair.price=r}else Ue.phone||(e.crosshair.time=null,e.crosshair.price=null);i.point!=null&&(e.crosshair.x=i.point.x,e.crosshair.y=i.point.y)}function pt(i){let r=i.customPriceLine,t=r.options();t.price=parseFloat(t.price.toFixed(1));const o=+i.fromPriceString,a=t.price;switch(t.lineType){case"order":if(a!=o){let l=!1;t.kind=="entry"?E.value.position||(l=!0,e.tools.order[t.kind].price=a,u.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"change",price:e.tools.order.entry.price}}).then(n=>{n.isOk?(Y([t.kind]),D.success(h("trading.derivative.changeEntrySuccess"))):(r.applyOptions({price:o}),P(n.message))})):(l=!0,e.tools.order[t.kind].price=a,t.kind=="tp"?u.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"change",price:e.tools.order.tp.price}}).then(n=>{n.isOk?(Y([t.kind]),D.success(h("trading.derivative.changeTpSuccess"))):(r.applyOptions({price:o}),P(n.message))}):u.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"change",price:e.tools.order.sl.price}}).then(n=>{n.isOk?(Y([t.kind]),D.success(h("trading.derivative.changeSlSuccess"))):(r.applyOptions({price:o}),P(n.message))})),l||(r.applyOptions({price:o}),D.show(h("trading.derivative.noChangeOrderLine")))}break;case"line":u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line",point:o});const s=t.color,d=t.title;u.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"line",points:[a],data:[{color:s,title:d}]}),re.value.classList.remove("selected");break;case"target":if(m.isSet(e.tools.target.B)){let l={isRemove:!1,name:"target",points:[],data:[]},n,p,f=+e.tools.target.A.options().price,y=+e.tools.target.B.options().price,g=y-f;if(n="A",t.point=="A")g=+e.tools.target.B.options().title,y=f+g;else if(t.point!="B"){let C=0;switch(t.point){case"X":C=1.5;break;case"Y":C=2;break;case"Z":C=3;break;case"W":C=5;break}g=parseFloat(((y-a)/C).toFixed(1)),f=y-g,p={price:f},e.tools.target[n].applyOptions(p)}l.points.push(n),l.data.push(f),n="B",p={price:y,title:g.toFixed(1)},t.point==n&&delete p.price,e.tools.target[n].applyOptions(p),l.points.push(n),l.data.push(y),n="X",p={price:parseFloat((f-.5*g).toFixed(1)),title:(-.5*g).toFixed(1)},t.point==n&&delete p.price,e.tools.target[n].applyOptions(p),n="Y",p={price:parseFloat((f-g).toFixed(1)),title:(-g).toFixed(1)},t.point==n&&delete p.price,e.tools.target[n].applyOptions(p),n="Z",p={price:parseFloat((f-2*g).toFixed(1)),title:(-2*g).toFixed(1)},t.point==n&&delete p.price,e.tools.target[n].applyOptions(p),n="W",p={price:parseFloat((f-4*g).toFixed(1)),title:(-4*g).toFixed(1)},t.point==n&&delete p.price,e.tools.target[n].applyOptions(p),u.dispatch("tradingDerivative/drawTools",l)}break;case"pattern":if(m.isSet(e.tools.pattern.B)){let l,n;const p=e.tools.pattern.A.options(),f=e.tools.pattern.B.options(),y=e.tools.pattern.C.options(),g={A:{time:+p.time,price:+p.price},B:{price:+f.price},C:{price:+y.price}},{progress:C,timeMark:B,info:{rEpr1:L,rEpr2:A,rEpr3:S,entry:k,prStatus:T,x:_,X:K,y:ee,Y:me}}=ae(g);ce(C),le(B),X(g),l="A",n={title:`A ${L}`},e.tools.pattern[l].applyOptions(n),l="B",n={title:`B ${A}`},e.tools.pattern[l].applyOptions(n),l="C",n={title:`C ${S}`},e.tools.pattern[l].applyOptions(n),l="D",n={price:k,title:"Entry "+T},t.point==l&&delete n.price,e.tools.pattern[l].applyOptions(n),l="X",n={price:parseFloat(_.toFixed(1)),title:"X "+parseFloat(K.toFixed(1))},e.tools.pattern[l].applyOptions(n),l="Y",n={price:parseFloat(ee.toFixed(1)),title:"Y "+parseFloat(me.toFixed(1))},e.tools.pattern[l].applyOptions(n)}break}}function dt(){I.value&&(e.chart.resize(I.value.offsetWidth,I.value.offsetHeight),I.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function Ae(i){if(i.ctrlKey)switch(i.keyCode){case 219:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing-.01});break;case 221:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing+.01});break}if(i.altKey)switch(i.keyCode){case 219:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()-50);break;case 221:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()+50);break}}function _e(){I.value&&(document.fullscreenElement?(c.isFullscreen=!0,I.value.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(c.isFullscreen=!1,I.value.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}function ut(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function ft(i){Ht(),Object.entries(i).forEach(([r,t])=>{switch(r){case"order":ht(t);break;case"pattern":Rt(i.pattern)&&Te(i.pattern);break;case"tr":Vt(t);break;case"0_pt":Ve(t[0]);break;case"line":Yt(t);break;case"target":Jt(t);break}})}function mt(i){c.chartDate==O&&Z()||(i.price.length>0&&(e.data.whitespace=se(e.data.whitespace,Ie(c.chartDate))),e.series.whitespace.setData(e.data.whitespace),e.data.price=se(e.data.price,i.price),e.series.price.setData(e.data.price))}function Be(i){let r=[];i.forEach(t=>{const o=b(be(new Date(t.date),7));r.push({time:o,value:t.price})}),r.length>1?(e.data.price=se(e.data.price,r),e.series.price.setData(e.data.price)):(e.data.price.push(r[0]),e.series.price.update(r[0]))}function Ie(i){const r=b(new Date(`${i}T09:00:00Z`)),t=b(new Date(`${i}T11:30:00Z`)),o=b(new Date(`${i}T13:00:00Z`)),a=b(new Date(`${i}T14:30:00Z`)),s=b(new Date(`${i}T14:00:00Z`));let d=[];for(let l=r;l<=a;l++){if(l>t&&l<o)continue;let n={time:l};(l==s||l==a)&&(n.value=1),d.push(n)}return d}function se(i,r){return Array.from(new Map([...i,...r].sort((t,o)=>t.time-o.time).map(t=>[t.time,t])).values())}function Ce(){u.dispatch("tradingDerivative/setChartLoading",!0),e.websocket=new WebSocket(Ui),e.websocket.onopen=i=>{let r='{"protocol":"json","version":1}';e.websocket.send(r),r='{"arguments":["VN30F1M"],"invocationId":"0","target":"SubscribeTrades","type":1}',e.websocket.send(r),e.socketSendData=r},e.websocket.onclose=i=>{!e.socketStop&&Z()&&(c.isSocketWarning=!0,Ce())},e.websocket.onmessage=i=>{c.isSocketWarning=!1,vt(i.data).forEach(t=>{if(!t)return!1;t.type==3?(ue(),e.data.whitespace=se(e.data.whitespace,Ie(O)),e.series.whitespace.setData(e.data.whitespace),Be(t.result),u.dispatch("tradingDerivative/setChartLoading",!1)):t.type==1&&t.target=="UpdateTrades"&&t.arguments[0]=="VN30F1M"&&(Ut(t.arguments[1].at(-1).price),Be(t.arguments[1]))})}}function vt(i){let r=[];return i.split("").forEach(t=>{const o=t.indexOf("{"),a=t.lastIndexOf("}");let s=null;if(o!==-1&&a!==-1&&a>o){const d=t.substring(o,a+1);d!="{}"&&(s=JSON.parse(d))}r.push(s)}),r}function gt(){e.currentSeconds=b(be(new Date,7)),Z()&&(E.value.position&&e.currentSeconds>R.ATC-5*60&&(c.isOrderWarning=!0,e.currentSeconds>R.ATC-15&&m.isSet(e.tools.order.tp.line)&&u.dispatch("tradingDerivative/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(i=>{i.isOk?(N(["entry","tp","sl"]),D.success(h("trading.derivative.autoCancelTpSlSuccess"))):P(i.message)})),M.value.openingMarket&&e.currentSeconds==R.START&&Ce()),c.clock=ge(new Date,"HH:mm:ss")}function Y(i){const r="order";let t={isRemove:!1,name:r,points:[],data:[]},o,a;i.forEach(s=>{switch(s){case"entry":o="yellow",a=e.tools.order.side>0?"LONG":"SHORT";break;case"tp":o="lime",a=parseFloat(Math.abs(e.tools.order.tp.price-e.tools.order.entry.price).toFixed(1));break;case"sl":o="red",a=parseFloat(Math.abs(e.tools.order.sl.price-e.tools.order.entry.price).toFixed(1));break}if(t.points.push(s),m.isSet(e.tools.order[s].line))e.tools.order[s].line.applyOptions({price:e.tools.order[s].price,title:a}),t.data.push(e.tools.order[s].line.options());else{const d={lineType:r,kind:s,side:e.tools.order.side,price:e.tools.order[s].price,color:o,lineWidth:1,lineStyle:0,title:a,draggable:!0};e.tools.order[s].line=e.series.price.createPriceLine(d),t.data.push(d)}}),u.dispatch("tradingDerivative/drawTools",t)}function ht(i){Object.entries(i).forEach(([r,t])=>{e.tools.order.side=t.side,e.tools.order[r].price=t.price,e.tools.order[r].line=e.series.price.createPriceLine(t)})}function N(i,r=!0){r&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"order"}),i.forEach(t=>{m.isSet(e.tools.order[t].line)&&(e.series.price.removePriceLine(e.tools.order[t].line),delete e.tools.order[t].line)})}function xt(i){c.showTradingView=!c.showTradingView,i.stopPropagation()}function yt(){c.showProgressContext=!c.showProgressContext,c.showScanContext=!1,c.showLineContext=!1,c.showProgressContext&&ne()}function St(i){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const r=i.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(t=>t.classList.remove("selected")),r||(G(),X(),i.target.classList.add("selected"))}function Ct(){c.showScanContext=!c.showScanContext,c.showProgressContext=!1,c.showLineContext=!1}function Tt(){u.dispatch("tradingDerivative/setAutoRefresh",!M.value.autoRefresh)}function wt(){const i=c.scanSide=="left",r=e.crosshair.time?e.data.price.filter(o=>!x(o.time,i,e.crosshair.time)):e.data.price;let t=i?kt(r):Ft(r);t=Dt(t),m.isSet(t)&&(We(),G(),Te(t),X(t)),Se.value.classList.remove("selected")}function kt(i){let r,[t,o,a,s]=Array(4).fill({});for(let d=i.length-1;d>=0;d--){const l=i[d].value,n=i[d].time,p=V(n);if(p==-1)break;if(d==i.length-1&&(a={index:p,time:n,price:l},[o,t,s]=Array(3).fill(null).map(()=>m.cloneDeep(a))),r==null){if(l==a.price)continue;r=l>a.price}if(x(l,r,o.price)&&(x(t.price,!r,a.price)?([a,o]=[o,t].map(f=>m.cloneDeep(f)),t={index:p,time:n,price:l},s=m.cloneDeep(t),r=!r):o={index:p,time:n,price:l}),x(l,!r,t.price)?(t={index:p,time:n,price:l},s=m.cloneDeep(t)):s.index=p,x(l,r,s.price)&&(s={index:p,time:n,price:l}),a.index>t.index){const f=Math.abs(o.price-a.price);if(f>=1.5&&(t.index-s.index>a.index-o.index||Math.abs(t.price-s.price)>f))break}}return{A:t,B:o,C:a}}function Ft(i){let r,[t,o,a]=Array(3).fill({});for(let s=0;s<i.length;s++){const d=i[s].value,l=i[s].time,n=V(l);if(n==-1)break;if(s==0&&(t={index:n,time:l,price:d},o=m.cloneDeep(t),a=m.cloneDeep(t)),r==null){if(d==t.price)continue;r=d>t.price}x(d,r,o.price)&&(o={index:n,time:l,price:d},a=m.cloneDeep(o)),x(o.price,r,t.price)&&x(d,!r,a.price)&&(x(d,r,t.price)?a={index:n,time:l,price:d}:(t=m.cloneDeep(o),o={index:n,time:l,price:d},a=m.cloneDeep(o),r=!r))}return{A:t,B:o,C:a}}function Dt(i){const r={};return Object.entries(i).forEach(([t,o])=>{const{index:a,...s}=o;r[t]=s}),r}function bt(i){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const r=i.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(t=>t.classList.remove("selected")),r||i.target.classList.add("selected")}function Lt(i){i.target.classList.remove("selected"),G(),X()}function Ot(){const i="pattern",r=de(e.crosshair.y),t=e.crosshair.time;let o={lineType:i,price:r,lineWidth:1,lineStyle:1,draggable:!0};if(m.isSet(e.tools.pattern.A)){const a=e.tools.pattern.A.options();if(m.isSet(e.tools.pattern.B)){const s=e.tools.pattern.B.options();let d,l,n;if(m.isSet(e.tools.pattern.C)){let p,f;const y=e.tools.pattern.C.options();d={A:{time:t,price:r},B:{price:+s.price},C:{price:+y.price}};const{progress:g,timeMark:C,info:{rEpr1:B,rEpr2:L,rEpr3:A,entry:S,prStatus:k,x:T,X:_,y:K,Y:ee}}=ae(d);n=g,l=C,p="A",f={price:r,time:t,title:`A ${B}`},e.tools.pattern[p].applyOptions(f),p="B",f={title:`B ${L}`},e.tools.pattern[p].applyOptions(f),p="C",f={title:`C ${A}`},e.tools.pattern[p].applyOptions(f),p="D",f={price:S,title:"Entry "+k},e.tools.pattern[p].applyOptions(f),p="X",f={price:parseFloat(T.toFixed(1)),title:"X "+parseFloat(_.toFixed(1))},e.tools.pattern[p].applyOptions(f),p="Y",f={price:parseFloat(K.toFixed(1)),title:"Y "+parseFloat(ee.toFixed(1))},e.tools.pattern[p].applyOptions(f)}else{d={A:{time:+a.time,price:+a.price},B:{price:+s.price},C:{price:r}};const{progress:p,timeMark:f,info:{rEpr1:y,rEpr2:g,rEpr3:C,entry:B,prStatus:L,x:A,X:S,y:k,Y:T}}=ae(d);n=p,l=f;let _="A";e.tools.pattern[_].applyOptions({title:`A ${y}`}),_="B",e.tools.pattern[_].applyOptions({title:`B ${g}`}),o.point="C",o.title=`C ${C}`,o.color="#FFEB3B",e.tools.pattern[o.point]=e.series.price.createPriceLine(o),o.point="D",o.price=B,o.title="Entry "+L,o.color="#9C27B0",o.draggable=!1,e.tools.pattern[o.point]=e.series.price.createPriceLine(o),o.point="Y",o.price=parseFloat(k.toFixed(1)),o.title="Y "+parseFloat(T.toFixed(1)),o.color="#E91E63",o.draggable=!1,e.tools.pattern[o.point]=e.series.price.createPriceLine(o),o.point="X",o.price=parseFloat(A.toFixed(1)),o.title="X "+parseFloat(S.toFixed(1)),o.color="#2196F3",o.draggable=!1,e.tools.pattern[o.point]=e.series.price.createPriceLine(o)}ce(n),le(l),X(d),he.value.classList.remove("selected")}else o.point="B",o.title="B 0",o.color="#4CAF50",e.tools.pattern[o.point]=e.series.price.createPriceLine(o)}else o.point="A",o.title="A 0",o.color="#F44336",o.time=t,e.tools.pattern[o.point]=e.series.price.createPriceLine(o)}function Te(i){let t={lineType:"pattern",lineWidth:1,lineStyle:1,draggable:!0};const{progress:o,timeMark:a,info:{rEpr1:s,rEpr2:d,rEpr3:l,entry:n,prStatus:p,x:f,X:y,y:g,Y:C}}=ae(i);ce(o),le(a),t.point="A",t.title=`A ${s}`,t.color="#F44336",t.price=i.A.price,t.time=i.A.time,e.tools.pattern[t.point]=e.series.price.createPriceLine(t),t.point="B",t.title=`B ${d}`,t.color="#4CAF50",t.price=i.B.price,e.tools.pattern[t.point]=e.series.price.createPriceLine(t),t.point="C",t.price=i.C.price,t.title=`C ${l}`,t.color="#FFEB3B",e.tools.pattern[t.point]=e.series.price.createPriceLine(t),t.point="D",t.price=n,t.title="Entry "+p,t.color="#9C27B0",t.draggable=!1,e.tools.pattern[t.point]=e.series.price.createPriceLine(t),t.point="Y",t.price=parseFloat(g.toFixed(1)),t.title="Y "+parseFloat(C.toFixed(1)),t.color="#E91E63",t.draggable=!1,e.tools.pattern[t.point]=e.series.price.createPriceLine(t),t.point="X",t.price=parseFloat(f.toFixed(1)),t.title="X "+parseFloat(y.toFixed(1)),t.color="#2196F3",t.draggable=!1,e.tools.pattern[t.point]=e.series.price.createPriceLine(t)}function ne(i=!1){if(m.isSet(e.tools.pattern.C)){const r=e.tools.pattern.A.options(),t=e.tools.pattern.B.options(),o=e.tools.pattern.C.options();let a={A:{time:+r.time,price:+r.price},B:{price:+t.price},C:{price:+o.price}};i&&(a=Et(a)),G(),Te(a)}}function Rt({A:{time:i}}){return e.data.price.some(r=>r.time===i)}function ae({A:i,B:r,C:t}){const o=r.price-t.price,a=o>0,s=we({phase:1,start:i,end:r,retracementPrice:t.price});let d=we({phase:2,start:s.R,end:t});const l=we({phase:3,start:d.R,end:{price:r.price+(a?1:-1)*s.rEp},breakPrice:r.price});s.xBox.tr>=d.tr&&(d.tr=s.xBox.tr),console.log("calculatePattern",[s,d,l]);const n=Math.abs(o)>s.pr,p=Math.abs(t.price-l.xBox.R.price)>d.pr,f=l.xBox.pr>l.pr,y=x(t.price,a,s.S1.price),g=x(l.xBox.R.price,!a,d.S1.price),C=x(l.xBox.S.price,a,l.S1.price),B=y?n?1:0:2,L=g?p?1:0:2,A=C?f?1:0:2,S=`${B}${L}${A}`,k=s.R.index+s.tr,T=d.R.index+d.tr,_=l.xBox.R.index+l.tr,K=[k,T,_],ee=l.xBox.S.index>k,me=l.xBox.S.index>T,ii=l.xBox.S.index>_;let J,F={};F.steps=[[s.rEp>=1,s.rEt<s.tr||s.rEp>=s.sEp,s.rEpr>=1&&s.rEpr<3,s.rEpr>d.rEpr,B==1,ee==1],[me==0],[L>0,me==1],[A==1,ii==1]],F.step=1,F.steps[0].every(Boolean)?F.steps[1].every(Boolean)?(F.step=2,F.result=!0,J=d.S1.price):(F.step=3,F.steps[2].every(Boolean)?(F.step=4,F.steps[3].every(Boolean)?(F.result=!0,J=l.xBox.R.price):(F.result=!1,J=l.R1.price)):(F.result=!1,J=l.R1.price)):(F.result=!1,J=s.S1.price);const ri=parseFloat(s.rEpr.toFixed(1)),oi=parseFloat(d.rEpr.toFixed(1)),si=parseFloat(l.rEpr.toFixed(1)),ve=s.rEp,ni=Me(r.price,ve,a),Xe=parseInt((l.breakIndex-s.R.index)/s.tr),ze=Xe>1?ve*Xe:ve,ai=Me(r.price,ze,a);return{progress:F,timeMark:K,info:{rEpr1:ri,rEpr2:oi,rEpr3:si,entry:J,prStatus:S,x:ni,X:ve,y:ai,Y:ze}}}function we({phase:i,start:r,end:t,breakPrice:o,retracementPrice:a}){let s=m.cloneDeep(r),d=m.cloneDeep(t);const l=d.price>s.price;let n={},p={},f={},y=null,g,C,B;return e.data.price.filter(L=>{let A=L.time>=s.time;return e.tools.pickTime&&(A&=L.time<=e.tools.pickTime),A}).every((L,A)=>{const S=L.value,k=L.time,T=V(k);if(T==-1)return!1;if((A==0||S==s.price)&&(n={R:{index:T,time:k,price:S},S:{index:T,time:k,price:S},pr:0,tr:0},p=m.cloneDeep(n),f=m.cloneDeep(n)),x(S,l,n.R.price)){const _=Math.abs(n.R.price-p.R.price);_<.2&&x(n.S.price,!l,p.R.price)&&n.pr<p.pr&&(p.S.index=n.S.index,p.tr=p.S.index-p.R.index,p.pr+=_),n.tr>=p.tr&&n.pr>=p.pr&&(p=m.cloneDeep(n)),i==1&&a&&!x(n.S.price,!l,a)&&n.tr>=f.tr&&n.pr>=f.pr&&(f=m.cloneDeep(n)),n={R:{index:T,time:k,price:S},S:{index:T,time:k,price:S},pr:0,tr:0},i==3&&o&&!x(S,l,o)&&(y=T)}else n.S.index=T,n.tr=n.S.index-n.R.index,x(S,!l,n.S.price)&&(n.S.time=k,n.S.price=S,n.pr=Math.abs(n.S.price-n.R.price));return x(S,!l,s.price)?(n.S.price=s.price,!1):!!x(S,!l,d.price)}),m.isSet(n)&&(d.index=n.S.index,d.time=fe(n.S.index),g=Math.abs(d.price-p.R.price),C=Math.abs(s.price-p.S.price),B=d.index-p.S.index,i==3&&(f=n)),{tr:p.tr,pr:p.pr,rEp:g,sEp:C,rEpr:p.pr?g/p.pr:0,rEt:B,S1:p.S,R1:p.R,xBox:f,S:s,R:d,breakIndex:y}}function Me(i,r,t){const o=i+(t?1:-1)*r;let a=parseFloat((o%1).toFixed(1));if(t){if(a>=.1&&a<=.2)return Math.floor(o);if(a>=.6&&a<=.7)return Math.floor(o)+.5}else{if(a>=.8&&a<=.9)return Math.ceil(o);if(a>=.3&&a<=.4)return Math.floor(o)+.5}return o}function Et(i){let r=m.cloneDeep(i);const t=r.B.price-r.A.price,o=e.data.price.at(-1).value;if(x(o,!t,r.C.price)){let a=o;for(let s=e.data.price.length-1;s>=0;s--){const d=e.data.price[s].value;if(d==r.C.price)break;a=t?Math.min(a,d):Math.max(a,d)}r.C.price=a,X(r)}return r}function X(i={}){let r=!m.isSet(i),t={isRemove:r,name:"pattern",points:[],data:[]};r||Object.entries(i).forEach(([o,a])=>{t.points.push(o),t.data.push(a)}),u.dispatch("tradingDerivative/drawTools",t)}function G(){m.isSet(e.tools.pattern.A)&&(e.series.price.removePriceLine(e.tools.pattern.A),m.isSet(e.tools.pattern.B)&&(e.series.price.removePriceLine(e.tools.pattern.B),m.isSet(e.tools.pattern.C)&&(e.series.price.removePriceLine(e.tools.pattern.C),e.series.price.removePriceLine(e.tools.pattern.D),e.series.price.removePriceLine(e.tools.pattern.X),e.series.price.removePriceLine(e.tools.pattern.Y)))),z(["pattern"]),le([]),ce(0)}function le(i){const r=["#F44336","#4CAF50","#FFEB3B"];let t=[];for(let o=0;o<i.length;o++)t.push({time:fe(i[o]),value:1,color:r[o]});t.length&&t.sort((o,a)=>o.time-a.time),e.series.timeMark.setData(t)}function ce(i){c.progress=i}function Pt(i){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const r=i.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(t=>t.classList.remove("selected")),r||i.target.classList.add("selected")}function At(i){i.target.classList.remove("selected"),We(),ne()}function _t(){const i=e.crosshair.time;u.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"0_pt",points:[0],data:[i]}),Ve(i),ne(),xe.value.classList.remove("selected")}function Ve(i){e.tools.pickTime=i,e.series.pickTime.setData([{time:i,value:1,color:"#9C27B0"}])}function We(i=!0){i&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"0_pt"}),e.series.pickTime.setData([]),z(["pt"])}function Bt(i){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const r=i.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(t=>t.classList.remove("selected")),r||i.target.classList.add("selected")}function It(i){Ze(),i.target.classList.remove("selected")}function Mt(){let i={isRemove:!1,name:"tr",points:[],data:[]};const r=e.crosshair.time;let t={time:r,value:1};switch(e.tools.timeRange.length){case 0:t.color="OrangeRed",e.tools.timeRange[0]=t,i.points.push(0),i.data.push(r);break;case 1:t.color="lime",e.tools.timeRange[1]=t,i.points.push(1),i.data.push(r),oe.value.classList.remove("selected");break;default:const o=V(e.tools.timeRange[0].time),a=V(e.tools.timeRange[1].time),d=V(r)+(a-o),l=fe(d);t.color="OrangeRed",e.tools.timeRange[0]=m.cloneDeep(t),i.points.push(0),i.data.push(r),t.time=l,t.color="lime",e.tools.timeRange[1]=t,i.points.push(1),i.data.push(l),oe.value.classList.remove("selected");break}e.series.timeRange.setData(e.tools.timeRange),u.dispatch("tradingDerivative/drawTools",i)}function Vt(i){let r,t;if(i.length==2)r=i[0],t=i[1];else if(i.length==3){const a=V(i[0]),s=V(i[1]),l=V(i[2])+(s-a);r=i[2],t=fe(l)}else return!1;let o=[{time:r,value:1,color:"OrangeRed"},{time:t,value:1,color:"lime"}];e.tools.timeRange=o,e.series.timeRange.setData(o)}function Ze(i=!0){i&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"tr"}),e.series.timeRange.setData([]),z(["tr"])}function Wt(i){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const r=i.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(t=>t.classList.remove("selected")),r||i.target.classList.add("selected")}function Zt(i){c.showLineContext=!c.showLineContext,c.showProgressContext=!1,c.showScanContext=!1}function $t(){const i="line",r=de(e.crosshair.y),t=e.tools.lines.length;if(e.tools.lines=e.tools.lines.filter(o=>{const a=o.options(),s=a.type=r==+a.price;return s&&(e.series.price.removePriceLine(o),u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:i,point:r})),!s}),e.tools.lines.length==t){const o=c.lineColor,a=c.lineTitle,s={lineType:i,price:r,color:o,title:a,lineWidth:1,lineStyle:1,draggable:!0};e.tools.lines.push(e.series.price.createPriceLine(s)),u.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:i,points:[r],data:[{color:o,title:a}]})}re.value.classList.remove("selected")}function Yt(i){const t={lineType:"line",lineWidth:1,lineStyle:1,draggable:!0};Object.entries(i).forEach(([o,{color:a,title:s}])=>{t.price=+o,t.color=a,t.title=s,e.tools.lines.push(e.series.price.createPriceLine(t))})}function $e(i=!0){e.tools.lines.length>0&&(i&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line"}),e.tools.lines.forEach(r=>e.series.price.removePriceLine(r)),z(["lines"]))}function Nt(i){c.showProgressContext=!1,c.showScanContext=!1,c.showLineContext=!1;const r=i.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(t=>t.classList.remove("selected")),r||(i.target.classList.add("selected"),ke())}function Xt(i){ke(),i.target.classList.remove("selected")}function zt(){const i="target",r=de(e.crosshair.y);let t={lineType:i,price:r,lineWidth:1,lineStyle:1,draggable:!0},o={isRemove:!1,name:i,points:[],data:[r]};if(m.isSet(e.tools.target.A)){const a=+e.tools.target.A.options().price,s=r-a;t.point="B",t.title=parseFloat(s.toFixed(1)),t.color="#F44336",e.tools.target[t.point]=e.series.price.createPriceLine(t),o.points.push(t.point),t.point="X",t.price=parseFloat((a-.5*s).toFixed(1)),t.title=parseFloat((-.5*s).toFixed(1)),t.color="#2196F3",e.tools.target[t.point]=e.series.price.createPriceLine(t),t.point="Y",t.price=parseFloat((a-s).toFixed(1)),t.title=parseFloat(-s.toFixed(1)),t.color="#673AB7",e.tools.target[t.point]=e.series.price.createPriceLine(t),t.point="Z",t.price=parseFloat((a-2*s).toFixed(1)),t.title=parseFloat((-2*s).toFixed(1)),t.color="#9C27B0",e.tools.target[t.point]=e.series.price.createPriceLine(t),t.point="W",t.price=parseFloat((a-4*s).toFixed(1)),t.title=parseFloat((-4*s).toFixed(1)),t.color="#E91E63",e.tools.target[t.point]=e.series.price.createPriceLine(t),ye.value.classList.remove("selected")}else t.point="A",t.title="0",t.color="#FF9800",e.tools.target[t.point]=e.series.price.createPriceLine(t),o.points.push(t.point);u.dispatch("tradingDerivative/drawTools",o)}function Jt(i){let t={lineType:"target",lineWidth:1,lineStyle:1,draggable:!0};const o=i.A,a=i.B,s=a-o;t.point="A",t.price=o,t.title="0",t.color="#FF9800",e.tools.target[t.point]=e.series.price.createPriceLine(t),t.point="B",t.price=a,t.title=parseFloat(s.toFixed(1)),t.color="#F44336",e.tools.target[t.point]=e.series.price.createPriceLine(t),t.point="X",t.price=parseFloat((o-.5*s).toFixed(1)),t.title=parseFloat((-.5*s).toFixed(1)),t.color="#2196F3",e.tools.target[t.point]=e.series.price.createPriceLine(t),t.point="Y",t.price=parseFloat((o-s).toFixed(1)),t.title=parseFloat(-s.toFixed(1)),t.color="#673AB7",e.tools.target[t.point]=e.series.price.createPriceLine(t),t.point="Z",t.price=parseFloat((o-2*s).toFixed(1)),t.title=parseFloat((-2*s).toFixed(1)),t.color="#9C27B0",e.tools.target[t.point]=e.series.price.createPriceLine(t),t.point="W",t.price=parseFloat((o-4*s).toFixed(1)),t.title=parseFloat((-4*s).toFixed(1)),t.color="#E91E63",e.tools.target[t.point]=e.series.price.createPriceLine(t)}function ke(i=!0){i&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"target"}),m.isSet(e.tools.target.A)&&(e.series.price.removePriceLine(e.tools.target.A),m.isSet(e.tools.target.B)&&(e.series.price.removePriceLine(e.tools.target.B),e.series.price.removePriceLine(e.tools.target.X),e.series.price.removePriceLine(e.tools.target.Y),e.series.price.removePriceLine(e.tools.target.Z),e.series.price.removePriceLine(e.tools.target.W))),z(["target"])}function Ht(){N(["entry","tp","sl"],!1),$e(!1),ke(!1),Ze(!1),G()}function pe(i){if(i){if(Z()&&(m.isSet(e.tools.order.tp.line)||E.value.position&&e.currentSeconds>R.ATO&&e.currentSeconds<R.ATC&&(U.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-61?-61:1))+"px",U.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-51?-51:1))+"px",U.value.style.display="block"),!m.isSet(e.tools.order.entry.line))){let r=null,t=0;E.value.position?(e.currentSeconds<R.ATO?r="ATO":e.currentSeconds>R.ATC&&(r="ATC"),r&&(e.tools.order.entry.price=r,t=-E.value.position)):e.currentSeconds>R.ATO&&e.currentSeconds<R.ATC&&(r=de(e.crosshair.y),t=r>=e.data.price.at(-1).value?1:-1,e.tools.order.side=t,e.tools.order.entry.price=r),t&&($.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-71?-71:1))+"px",$.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-61?-61:1))+"px",$.value.style.background=t>0?"green":"red",$.value.innerText=`${t>0?"LONG":"SHORT"} ${r}`,$.value.style.display="block")}}else $.value.style.display="none",U.value.style.display="none"}function jt(){Z()&&(e.currentSeconds<R.ATO?je(h("trading.derivative.atoOrder"),h("titles.confirm")).then(r=>{r&&u.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(t=>{t.isOk?D.success(h("trading.derivative.atoOrderSuccess")):P(t.message)})}):e.currentSeconds<R.ATC?u.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"new",side:e.tools.order.side,price:e.tools.order.entry.price}}).then(i=>{i.isOk?(Y(["entry"]),D.success(h("trading.derivative.newEntrySuccess"))):P(i.message)}):je(h("trading.derivative.atcOrder"),h("titles.confirm")).then(r=>{r&&u.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(t=>{t.isOk?D.success(h("trading.derivative.atcOrderSuccess")):P(t.message)})}))}function qt(){e.tools.order.tp.price=e.tools.order.entry.price+e.tools.order.side*qe,e.tools.order.sl.price=e.tools.order.entry.price-e.tools.order.side*Qe,u.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.tools.order.tp.price},slData:{cmd:"new",price:e.tools.order.sl.price}}).then(i=>{i.isOk?(e.tools.order.entry.line.applyOptions({draggable:!1}),Y(["entry","tp","sl"]),D.success(h("trading.derivative.newTpSlSuccess"))):P(i.message)})}function Qt(){m.isSet(e.tools.order.entry.line)?m.isSet(e.tools.order.tp.line)?u.dispatch("tradingDerivative/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(i=>{i.isOk?(N(["entry","tp","sl"]),D.success(h("trading.derivative.exitSuccess"))):P(i.message)}):u.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"delete"}}).then(i=>{i.isOk?(N(["entry"]),D.success(h("trading.derivative.deleteEntrySuccess"))):P(i.message)}):ue()}function Ut(i){m.isSet(e.tools.order.entry.line)&&(m.isSet(e.tools.order.tp.line)?((e.tools.order.side>0&&i>=e.tools.order.tp.price||e.tools.order.side<0&&i<=e.tools.order.tp.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,u.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"delete"}}).then(r=>{r.isOk?(N(["entry","tp","sl"]),D.success(h("trading.derivative.deleteTpSuccess")),pe(!1)):P(r.message),e.isAutoOrdering=!1}))),(e.tools.order.side>0&&i<=e.tools.order.sl.price||e.tools.order.side<0&&i>=e.tools.order.sl.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,u.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"cancel"}}).then(r=>{r.isOk?(N(["entry","tp","sl"]),D.success(h("trading.derivative.deleteSlSuccess")),pe(!1)):P(r.message),e.isAutoOrdering=!1})))):(e.tools.order.side>0&&i>=e.tools.order.entry.price||e.tools.order.side<0&&i<=e.tools.order.entry.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,setTimeout(()=>{e.tools.order.tp.price=e.tools.order.entry.price+e.tools.order.side*qe,e.tools.order.sl.price=e.tools.order.entry.price-e.tools.order.side*Qe,u.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.tools.order.tp.price},slData:{cmd:"new",price:e.tools.order.sl.price}}).then(r=>{r.isOk?(e.tools.order.entry.line.applyOptions({draggable:!1}),Y(["entry","tp","sl"]),D.success(h("trading.derivative.autoNewTpSlSuccess"))):P(r.message),e.isAutoOrdering=!1})},1e3))))}function Gt(){e.chart.timeScale().scrollToRealTime()}function Z(){return M.value.openingMarket&&e.currentSeconds>=R.START&&e.currentSeconds<=R.END}function de(i){return parseFloat(e.series.price.coordinateToPrice(i).toFixed(1))}function P(i){i||(i="unknown"),D.error(h(`trading.derivative.${i}`))}function Kt(){if(!c.chartDate)return!1;u.dispatch("tradingDerivative/getChartData",c.chartDate)}function Ye(){Z()&&e.websocket.send(e.socketSendData)}function ei(){e.data.whitespace=[],e.data.price=[],Ye(),u.dispatch("tradingDerivative/getChartData",c.chartDate)}function Ne(){u.dispatch("tradingDerivative/getStatus")}function ue(){u.dispatch("tradingDerivative/getTools")}function z(i){i==null&&(i=["order","lines","tr","pattern","target","pt"]),i.includes("order")&&(e.tools.order={side:0,entry:{},tp:{},sl:{}}),i.includes("lines")&&(e.tools.lines=[]),i.includes("target")&&(e.tools.target={}),i.includes("tr")&&(e.tools.timeRange=[]),i.includes("pattern")&&(e.tools.pattern={}),i.includes("pt")&&(e.tools.pickTime=null)}function ti(){u.dispatch("tradingDerivative/getAccountInfo").then(i=>{let r="";r+='<div style="width: 200px;">',r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${h("trading.derivative.nav")}</div><div>: ${ie.currency(i.nav)}</div></div>`,r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${h("trading.derivative.maxVol")}</div><div>: ${ie.numberVnFormat(i.maxVol)}</div></div>`,r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${h("trading.derivative.vm")}</div><div>: ${ie.currency(i.vm)}</div></div>`,r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${h("trading.derivative.fee")}</div><div>: ${ie.currency(i.fee)}</div></div>`,r+="</div>",Si(r,h("trading.derivative.accountInfo"))})}function x(i,r,t,o=!1){return r?o?i>=t:i>t:o?i<=t:i<t}function V(i){let r=e.data.whitespace.findIndex(t=>t.time==i);if(r==-1){const t=ge(new Date(i*1e3),"yyyy-MM-dd"),o=b(new Date(`${t}T11:30:00Z`)),a=b(new Date(`${t}T13:00:00Z`)),s=b(new Date(`${t}T14:30:00Z`));i>o&&i<a?i=o:i>s&&(i=s),r=e.data.whitespace.findIndex(d=>d.time==i)}return r}function fe(i){return e.data.whitespace[i].time}return(i,r)=>(Ci(),vi("div",{class:"derivative-container",ref_key:"chartContainerRef",ref:I,onClick:at,onContextmenu:lt},[v("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:Oe},[v("div",{class:"area data-area",onClick:Ee,onContextmenu:Pe},[v("div",{ref_key:"connectionRef",ref:Ge,class:W(["command",{yellow:E.value.pending}]),title:i.$t("trading.derivative.connection"),onClick:Ne},[v("i",{class:W(["far",{"fa-link-simple":E.value.connection,"fa-link-simple-slash":!E.value.connection,blink:c.isSocketWarning}])},null,2)],10,bi),v("div",{class:W(["command status",{green:E.value.position>0,red:E.value.position<0}]),title:i.$t("trading.derivative.position"),onClick:ti},He(E.value.position),11,Li),v("div",{class:"command clock",onClick:Ye},He(c.clock),1),j(v("input",{type:"date",class:"chart-date command",title:i.$t("trading.derivative.date"),"onUpdate:modelValue":r[0]||(r[0]=t=>c.chartDate=t),onChange:Kt},null,40,Oi),[[gi,c.chartDate]]),v("div",{ref_key:"reloadToolRef",ref:tt,class:"command",title:i.$t("trading.derivative.reload"),onClick:ei,onContextmenu:ue},[v("i",{class:W(["far fa-sync-alt",{"fa-spin":ot.value}])},null,2)],40,Ri)],32),v("div",{class:"area tool-area",onClick:Ee,onContextmenu:Pe},[v("div",{ref_key:"fullscreenToolRef",ref:Ke,class:"command",title:i.$t("trading.derivative.fullscreen"),onClick:ut},[v("i",{class:W(["far",{"fa-compress":c.isFullscreen,"fa-expand":!c.isFullscreen}])},null,2)],8,Ei),v("div",{ref_key:"tradingviewRef",ref:it,class:"command far fa-chart-candlestick",title:i.$t("trading.derivative.tradingview"),onClick:xt},null,8,Pi),v("div",{class:W(["context command",{green:c.progress.result==!0,red:c.progress.result==!1}]),title:i.$t("trading.derivative.progressTool"),onClick:yt,onContextmenu:Tt},[v("i",{class:W(["far",{"fa-badge-check":!c.progress.step,[`fa-circle-${c.progress.step}`]:c.progress.step,blink:M.value.autoRefresh}])},null,2),j(Fe(ki,{class:"contextmenu",progress:c.progress},null,8,["progress"]),[[te,c.showProgressContext]])],42,Ai),v("div",{ref_key:"scanToolRef",ref:Se,class:"context command",title:i.$t("trading.derivative.scanTool"),onClick:St,onContextmenu:Ct},[v("i",{class:W(["far",{[`fa-angles-${c.scanSide}`]:!0}])},null,2),j(Fe(wi,{class:"contextmenu",modelValue:c.scanSide,"onUpdate:modelValue":r[1]||(r[1]=t=>c.scanSide=t)},null,8,["modelValue"]),[[te,c.showScanContext]])],40,_i),v("div",{ref_key:"patternToolRef",ref:he,class:"command",title:i.$t("trading.derivative.patternTool"),onClick:bt,onContextmenu:Lt},Mi,40,Bi),v("div",{ref_key:"pickTimeToolRef",ref:xe,class:"command",title:i.$t("trading.derivative.pickTimeTool"),onClick:Pt,onContextmenu:At},Zi,40,Vi),v("div",{ref_key:"lineToolRef",ref:re,class:"context command",title:i.$t("trading.derivative.lineTool"),onClick:Wt,onContextmenu:Zt},[Yi,j(Fe(Ti,{class:"contextmenu",enable:c.showLineContext,title:c.lineTitle,"onUpdate:title":r[2]||(r[2]=t=>c.lineTitle=t),color:c.lineColor,"onUpdate:color":r[3]||(r[3]=t=>c.lineColor=t),onDeleteAllLine:$e},null,8,["enable","title","color"]),[[te,c.showLineContext]])],40,$i),v("div",{ref_key:"timeRangeToolRef",ref:oe,class:"command",title:i.$t("trading.derivative.timeRangeTool"),onClick:Bt,onContextmenu:It},zi,40,Ni),v("div",{ref_key:"targetToolRef",ref:ye,class:"command",title:i.$t("trading.derivative.targetTool"),onClick:Nt,onContextmenu:Xt},ji,40,Ji),j(v("div",{ref_key:"cancelOrderRef",ref:rt,class:"cancel-order command",title:i.$t("trading.derivative.cancelTool"),onClick:Qt},[v("i",{class:W(["far fa-trash-alt",{blink:c.isOrderWarning}])},null,2)],8,qi),[[te,st.value]])],32),v("div",null,[v("div",{ref_key:"entryOrderRef",ref:$,class:"order-button entry",onClick:jt}," Entry ",512),v("div",{ref_key:"tpslOrderRef",ref:U,class:"order-button tpsl",onClick:qt}," TP/SL ",512),v("div",{class:"chart-top command far fa-angle-double-right",onClick:Gt})]),j(v("iframe",{ref_key:"tradingviewChartRef",ref:et,class:"tradingview-chart",style:hi(c.tradingViewStyle),src:nt.value},null,12,Qi),[[te,c.showTradingView]])],512)],544))}};export{sr as default};
