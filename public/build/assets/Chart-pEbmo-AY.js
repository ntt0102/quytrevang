import{z as mt,A as vt,B as ht,r as B,y as we,C as Ne,o as z,b as ee,d as F,D as ae,c as ce,E as Ce,G as De,H as gt,I as St,J as Tt,m as ot,p as qe,f as Ue,e as ie,F as Xe,K as je,t as xe,h as ge,u as Be,k as ve,L as yt,M as xt,N as tt,O as Ct,g as at,w as Se,Q as kt,R as wt,S as it,x as oe,l as Ae,a as Dt,T as ze,U as bt,j as _t,V as Rt}from"./app-C9dEGvxy.js";import{D as Et}from"./text-box-B6UNhy78.js";import{g as G}from"./getUnixTime-xaaDr7FI.js";import{c as Lt}from"./lightweight-charts.esm.development-CeIklpfa.js";/* empty css            */function ct(E,P,C){return mt(E,+vt(E)+P)}function ke(E,P,C){return ct(E,P*ht)}function Ot(E,P,C){return ct(E,P*1e3)}function Je(E,P,C){return Ot(E,-P)}const $t=["title"],It={__name:"FullscreenTool",props:["chartContainerRef"],setup(E,{expose:P}){const C=E,p=B(!1);P({checkFullscreen:r}),we(()=>{document.addEventListener("fullscreenchange",h),window.addEventListener("keydown",a)}),Ne(()=>{document.removeEventListener("fullscreenchange",h),window.removeEventListener("keydown",a)});function e(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function r(){C.chartContainerRef.classList.contains("fullscreen")&&k()}function h(){C.chartContainerRef&&(document.fullscreenElement?(p.value=!0,C.chartContainerRef.classList.add("fullscreen"),k()):(p.value=!1,C.chartContainerRef.classList.remove("fullscreen"),A()))}function k(){document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"}function A(){document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"}function a(f){f.key==="F11"&&(e(),f.preventDefault())}return(f,g)=>(z(),ee("div",{class:"command",title:f.$t("trading.derivative.fullscreenTool"),onClick:e},[F("i",{class:ae(["far",{"fa-compress":p.value,"fa-expand":!p.value}])},null,2)],8,$t))}},Pt=["title"],At=["src"],Nt={__name:"TradingviewTool",props:["vpsUser","vpsSession","chartContainerRef"],setup(E){const P=E,C=B(null),p=B(!1),e=ce(()=>`https://chart.vps.com.vn/tv/?u=${P.vpsUser}&s=${P.vpsSession}&symbol=VN30F1M&resolution=1&lang=vi`);we(()=>{window.addEventListener("keydown",A)}),Ne(()=>{window.removeEventListener("keydown",A)});function r(a){h(),k(),a.stopPropagation()}function h(){p.value=!p.value}function k(){if(P.chartContainerRef&&C.value){const{offsetWidth:a,offsetHeight:f}=P.chartContainerRef,{top:g,left:L}=C.value.getBoundingClientRect();C.value.style.top=`${g-2}px`,C.value.style.left=`${L+32}px`,C.value.style.width=`${a-34}px`,C.value.style.height=`${f}px`}}function A(a){a.key==="F2"&&(h(),k(),a.preventDefault())}return(a,f)=>(z(),ee("div",{class:"tradingview command far fa-chart-candlestick",title:a.$t("trading.derivative.tradingviewTool"),onClick:r},[Ce(F("iframe",{ref_key:"tradingviewRef",ref:C,class:"chart",src:e.value},null,8,At),[[De,p.value]])],8,Pt))}},Bt=F("div",{class:"triangle-shadow"},null,-1),Ft=F("div",{class:"triangle"},null,-1),Ge={__name:"CoreContext",setup(E){function P(C){C.stopPropagation()}return(C,p)=>(z(),ee("div",{class:"core-context",onClick:P},[Bt,Ft,gt(C.$slots,"default")]))}},Mt={__name:"ProgressContext",props:["progress","chartHeightEnough"],emits:["refreshPattern"],setup(E,{emit:P}){const C=P,p=B([]);we(()=>{e()});function e(){St(Object.assign({"../../../../../lang/vi/derivative.js":()=>Tt(()=>import("./derivative-BEBVm5-D.js"),[])}),`../../../../../lang/${window.lang}/derivative.js`,8).then(h=>{p.value=h.default||[]})}function r(){C("refreshPattern")}return(h,k)=>{const A=ot("DxButton");return z(),qe(Ge,{class:"pattern-context"},{default:Ue(()=>[ie(A,{icon:"refresh",type:"success",text:h.$t("trading.derivative.progressContext.refreshPattern"),onClick:r},null,8,["text"]),F("div",{class:ae(["steps",{portrait:E.chartHeightEnough}])},[(z(!0),ee(Xe,null,je(p.value,(a,f)=>(z(),ee("div",{key:f,class:ae(["step",[E.progress.step&&E.progress.step===f+1?E.progress.result?"success":"fail":""]])},[F("div",{class:ae(["name",[E.progress.steps?E.progress.steps[f].every(Boolean)?"success":"fail":""]])},xe(f+1)+". "+xe(a.name),3),F("div",null,[(z(!0),ee(Xe,null,je(a.conds,(g,L)=>(z(),ee("div",{key:L,class:ae(["condition",[E.progress.steps?E.progress.steps[f][L]?"success":"fail":""]])},xe(L+1)+". "+xe(g),3))),128))])],2))),128))],2)]),_:1})}}},Vt=["title"],Wt={__name:"ProgressTool",props:["chartHeightEnough"],emits:["refreshPattern","hideContext"],setup(E,{expose:P,emit:C}){const p=ge(),{t:e}=Be(),r=ve("mf"),h=C,k=B({}),A=B(!1),a=ce(()=>p.state.tradingDerivative.config.autoRefresh);P({hide:g,set:L}),we(()=>{window.addEventListener("keydown",T)}),Ne(()=>{window.removeEventListener("keydown",T)});function f(){const s=A.value;h("hideContext"),A.value=!s}function g(s=!1){A.value=s}function L(s){a.value&&Y(s,k.value),k.value=s}function V(){h("refreshPattern")}function W(){p.dispatch("tradingDerivative/setAutoRefresh",!a.value)}function Y(s,m){if(r.isSet(s)&&(s.step!==m.step||s.step===m.step&&s.result!==m.result)){let t="";s.result?[2,4].includes(s.step)?t=e("trading.derivative.progressOrder",s):t=e("trading.derivative.progressSuccess",s):t=e("trading.derivative.progressFail",s),$(t)}}function $(s){const m=new SpeechSynthesisUtterance(s);m.lang="vi-VN",speechSynthesis.speak(m)}function T(s){s.key==="F3"&&(f(),s.preventDefault())}return(s,m)=>(z(),ee("div",{class:ae(["context command",{green:k.value.result===!0,red:k.value.result===!1}]),title:s.$t("trading.derivative.progressTool"),onClick:f,onContextmenu:W},[F("i",{class:ae(["far",{"fa-badge-check":!k.value.step,[`fa-circle-${k.value.step}`]:k.value.step,blink:a.value}])},null,2),Ce(ie(Mt,{class:"contextmenu",progress:k.value,chartHeightEnough:E.chartHeightEnough,onRefreshPattern:V},null,8,["progress","chartHeightEnough"]),[[De,A.value]])],42,Vt))}};var me={};const Zt=yt(xt);/*!
 * devextreme-vue
 * Version: 22.2.12
 * Build date: Mon Apr 29 2024
 *
 * Copyright (c) 2012 - 2024 Developer Express Inc. ALL RIGHTS RESERVED
 *
 * This software may be modified and distributed under the terms
 * of the MIT license. See the LICENSE file in the root of the project for details.
 *
 * https://github.com/DevExpress/devextreme-vue
 */var nt;function Yt(){if(nt)return me;nt=1;var E=me&&me.__importDefault||function(h){return h&&h.__esModule?h:{default:h}};Object.defineProperty(me,"__esModule",{value:!0}),me.DxItem=me.DxButtonGroup=void 0;var P=E(Zt),C=tt(),p=tt(),e=C.createComponent({props:{accessKey:String,activeStateEnabled:Boolean,buttonTemplate:{},disabled:Boolean,elementAttr:Object,focusStateEnabled:Boolean,height:[Function,Number,String],hint:String,hoverStateEnabled:Boolean,items:Array,keyExpr:[Function,String],onContentReady:Function,onDisposing:Function,onInitialized:Function,onItemClick:Function,onOptionChanged:Function,onSelectionChanged:Function,rtlEnabled:Boolean,selectedItemKeys:Array,selectedItems:Array,selectionMode:String,stylingMode:String,tabIndex:Number,visible:Boolean,width:[Function,Number,String]},emits:{"update:isActive":null,"update:hoveredElement":null,"update:accessKey":null,"update:activeStateEnabled":null,"update:buttonTemplate":null,"update:disabled":null,"update:elementAttr":null,"update:focusStateEnabled":null,"update:height":null,"update:hint":null,"update:hoverStateEnabled":null,"update:items":null,"update:keyExpr":null,"update:onContentReady":null,"update:onDisposing":null,"update:onInitialized":null,"update:onItemClick":null,"update:onOptionChanged":null,"update:onSelectionChanged":null,"update:rtlEnabled":null,"update:selectedItemKeys":null,"update:selectedItems":null,"update:selectionMode":null,"update:stylingMode":null,"update:tabIndex":null,"update:visible":null,"update:width":null},computed:{instance:function(){return this.$_instance}},beforeCreate:function(){this.$_WidgetClass=P.default,this.$_hasAsyncTemplate=!0,this.$_expectedChildren={item:{isCollectionItem:!0,optionName:"items"}}}});me.DxButtonGroup=e;var r=p.createConfigurationComponent({emits:{"update:isActive":null,"update:hoveredElement":null,"update:disabled":null,"update:elementAttr":null,"update:hint":null,"update:html":null,"update:icon":null,"update:template":null,"update:text":null,"update:type":null,"update:visible":null},props:{disabled:Boolean,elementAttr:Object,hint:String,html:String,icon:String,template:{},text:String,type:String,visible:Boolean}});return me.DxItem=r,r.$_optionName="items",r.$_isCollectionItem=!0,me.default=e,me}var Ht=Yt();const zt=Ct(Ht),Jt={__name:"ScanContext",props:["modelValue"],emits:["update:modelValue"],setup(E,{emit:P}){const{t:C}=Be(),p=[{icon:"chevrondoubleleft",side:"left",text:C("trading.derivative.scanContext.leftScan")},{icon:"chevrondoubleright",side:"right",text:C("trading.derivative.scanContext.rightScan")}],e=E,r=P;function h({itemData:{side:k}}){r("update:modelValue",k)}return(k,A)=>(z(),qe(Ge,{class:"scan-context"},{default:Ue(()=>[ie(at(zt),{items:p,"selected-item-keys":[e.modelValue],"key-expr":"side","styling-mode":"outlined",onItemClick:h},null,8,["selected-item-keys"])]),_:1}))}},Xt=["title"],jt={__name:"ScanTool",props:["prices","timeToIndex"],emits:["scaned","removePattern","hideContext"],setup(E,{expose:P,emit:C}){const p=ve("mf"),e=E,r=C,h=B(null),k=B(!1),A=B("left");P({isSelected:a,hide:f,draw:V});function a(){return h.value.classList.contains("selected")}function f(){k.value=!1}function g(T){r("hideContext");const s=T.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(m=>m.classList.remove("selected")),s||(T.target.classList.add("selected"),r("removePattern"))}function L(){const T=k.value;r("hideContext"),k.value=!T}function V({time:T}){const s=A.value==="left",m=T?e.prices.filter(l=>!p.cmp(l.time,s,T)):e.prices;let t=s?W(m):Y(m);p.isSet(t)&&r("scaned",$(t)),h.value.classList.remove("selected")}function W(T){let s,[m,t,l,v]=Array(4).fill({});for(let d=T.length-1;d>=0;d--){const O=T[d].value,x=T[d].time,S=e.timeToIndex(x);if(S===-1)break;if(d===T.length-1&&(l={index:S,time:x,price:O},[t,m,v]=Array(3).fill(null).map(()=>p.cloneDeep(l))),s===void 0){if(O===l.price)continue;s=O>l.price}if(p.cmp(O,s,t.price)&&(p.cmp(m.price,!s,l.price)?([l,t]=[t,m].map(o=>p.cloneDeep(o)),m={index:S,time:x,price:O},v=p.cloneDeep(m),s=!s):t={index:S,time:x,price:O}),p.cmp(O,!s,m.price)?(m={index:S,time:x,price:O},v=p.cloneDeep(m)):v.index=S,p.cmp(O,s,v.price)&&(v={index:S,time:x,price:O}),l.index>m.index){const o=p.fmtNum(t.price-l.price,1,!0);if(o>=1&&(m.index-v.index>=2*(l.index-t.index)||p.fmtNum(m.price-v.price,1,!0)>o))break}}return{A:m,B:t,C:l}}function Y(T){let s,[m,t,l]=Array(3).fill({});for(let v=0;v<T.length;v++){const d=T[v].value,O=T[v].time,x=e.timeToIndex(O);if(x===-1)break;if(v===0&&(m={index:x,time:O,price:d},t=p.cloneDeep(m),l=p.cloneDeep(m)),s===void 0){if(d===m.price)continue;s=d>m.price}p.cmp(d,s,t.price)&&(t={index:x,time:O,price:d},l=p.cloneDeep(t)),p.cmp(t.price,s,m.price)&&p.cmp(d,!s,l.price)&&(p.cmp(d,s,m.price)?l={index:x,time:O,price:d}:(m=p.cloneDeep(t),t={index:x,time:O,price:d},l=p.cloneDeep(t),s=!s))}return{A:m,B:t,C:l}}function $(T){const s={};return Object.entries(T).forEach(([m,t])=>{const{index:l,...v}=t;s[m]=v}),s}return(T,s)=>(z(),ee("div",{ref_key:"scanToolRef",ref:h,class:"context command",title:T.$t("trading.derivative.scanTool"),onClick:g,onContextmenu:L},[F("i",{class:ae(["far",{[`fa-angles-${A.value}`]:!0}])},null,2),Ce(ie(Jt,{class:"contextmenu",modelValue:A.value,"onUpdate:modelValue":s[0]||(s[0]=m=>A.value=m)},null,8,["modelValue"]),[[De,k.value]])],40,Xt))}},qt=["title"],Ut=F("i",{class:"far fa-heart-rate"},null,-1),Gt=[Ut],Qt={__name:"PatternTool",props:["prices","priceSeries","timeMarkSeries","pickTimeToolRef","timeToIndex","indexToTime"],emits:["setProgress","hideContext"],setup(E,{expose:P,emit:C}){const p=ge(),e=ve("mf"),r=E,h=C,k=B(null),A=ce(()=>p.state.tradingDerivative.tools.pattern);let a={},f={};P({isSelected:g,draw:W,load:Y,refresh:T,remove:O,drag:o}),Se(A,i=>{i&&Y(i,{isCheck:!0})});function g(){return k.value.classList.contains("selected")}function L(i){h("hideContext");const n=i.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(y=>y.classList.remove("selected")),n||(i.target.classList.add("selected"),r.pickTimeToolRef.remove())}function V(i){i.target.classList.remove("selected"),h("hideContext"),O()}function W({time:i,price:n}){let u={lineType:"pattern",price:n,lineWidth:1,lineStyle:1,draggable:!0};if(e.isSet(f.A))if(e.isSet(f.B)){let w,Z;if(e.isSet(f.C)){let _,R;a.A={time:i,price:n};const{progress:N,timeMark:I,info:{rEpr1:M,rEpr2:J,rEpr3:te,entry:ne,pStatus:re,x:Q,X:se,y:H,Y:j}}=s();Z=N,w=I,_="A",R={price:n,title:`A ${M}`},f[_].applyOptions(R),_="B",R={title:`B ${J}`},f[_].applyOptions(R),_="C",R={title:`C ${te}`},f[_].applyOptions(R),_="D",R={price:ne,title:"Entry "+re},f[_].applyOptions(R),_="X",R={price:e.fmtNum(Q),title:`X ${e.fmtNum(se)}`},f[_].applyOptions(R),_="Y",R={price:e.fmtNum(H),title:`Y ${e.fmtNum(j)}`},f[_].applyOptions(R)}else{a.C={price:n};const{progress:_,timeMark:R,info:{rEpr1:N,rEpr2:I,rEpr3:M,entry:J,pStatus:te,x:ne,X:re,y:Q,Y:se}}=s();Z=_,w=R;let H="A";f[H].applyOptions({title:`A ${N}`}),H="B",f[H].applyOptions({title:`B ${I}`}),u.point="C",u.title=`C ${M}`,u.color="#FFEB3B",f[u.point]=r.priceSeries.createPriceLine(u),u.point="D",u.price=J,u.title="Entry "+te,u.color="#9C27B0",u.draggable=!1,f[u.point]=r.priceSeries.createPriceLine(u),u.point="Y",u.price=e.fmtNum(Q),u.title=`Y ${e.fmtNum(se)}`,u.color="#E91E63",u.draggable=!1,f[u.point]=r.priceSeries.createPriceLine(u),u.point="X",u.price=e.fmtNum(ne),u.title=`X ${e.fmtNum(re)}`,u.color="#2196F3",u.draggable=!1,f[u.point]=r.priceSeries.createPriceLine(u)}d(),h("setProgress",Z),S(w),k.value.classList.remove("selected")}else u.point="B",u.title="B 0",u.color="#4CAF50",f[u.point]=r.priceSeries.createPriceLine(u),a.B={price:n};else u.point="A",u.title="A 0",u.color="#F44336",f[u.point]=r.priceSeries.createPriceLine(u),a={A:{time:i,price:n}}}function Y(i,{isSave:n=!1,isCheck:y=!1}={}){a=e.cloneDeep(i),n&&d(),(y?t(a):!0)&&(x(),$())}function $(){let n={lineType:"pattern",lineWidth:1,lineStyle:1,draggable:!0};const{A:y,B:u,C:w}=a,{progress:Z,timeMark:_,info:{rEpr1:R,rEpr2:N,rEpr3:I,entry:M,pStatus:J,x:te,X:ne,y:re,Y:Q}}=s();h("setProgress",Z),S(_),n.point="A",n.title=`A ${R}`,n.color="#F44336",n.price=y.price,f[n.point]=r.priceSeries.createPriceLine(n),n.point="B",n.title=`B ${N}`,n.color="#4CAF50",n.price=u.price,f[n.point]=r.priceSeries.createPriceLine(n),n.point="C",n.price=w.price,n.title=`C ${I}`,n.color="#FFEB3B",f[n.point]=r.priceSeries.createPriceLine(n),n.point="D",n.price=M,n.title="Entry "+J,n.color="#9C27B0",n.draggable=!1,f[n.point]=r.priceSeries.createPriceLine(n),n.point="Y",n.price=e.fmtNum(re),n.title=`Y ${e.fmtNum(Q)}`,n.color="#E91E63",n.draggable=!1,f[n.point]=r.priceSeries.createPriceLine(n),n.point="X",n.price=e.fmtNum(te),n.title=`X ${e.fmtNum(ne)}`,n.color="#2196F3",n.draggable=!1,f[n.point]=r.priceSeries.createPriceLine(n)}function T(i=!1){e.isSet(f.C)&&(i&&v(),x(),$())}function s(){const{A:i,B:n,C:y}=a,u=n.price-y.price,w=u>0,Z=r.pickTimeToolRef.get(),_=m({phase:1,side:w,start:i,end:n,retracementPrice:y.price,stopTime:Z});let R=m({phase:2,side:!w,start:_.R,end:y,stopTime:Z});const N=m({phase:3,side:w,start:R.R,breakPrice:n.price,stopTime:Z??r.indexToTime(_.R.index+6*_.tr)});_.xBox.tr>=R.tr&&(R.tr=_.xBox.tr),console.log("calculatePattern",[_,R,N]);const I=e.fmtNum(u,1,!0)>=_.pr,M=e.fmtNum(y.price-N.xBox.R.price,1,!0)>=R.pr,J=e.fmtNum(N.xBox.pr)>=N.pr,te=!e.cmp(y.price,!w,_.S1.price),ne=!e.cmp(N.xBox.R.price,w,R.S1.price),re=!e.cmp(N.xBox.S.price,!w,N.S1.price),Q=_.R.index+_.tr,se=_.R.index+5*_.tr,H=R.R.index+R.tr,j=2*R.R.index-R.S1.index,q=N.xBox.R.index+N.tr,he=N.xBox.R.index+R.tr,be=[Q,se,H,j,q,he],le=N.R.index;let Te,U={};const _e=[R.R.index>Q,_.rEpr<3,R.rEpr<_.rEpr];U.steps=[[I,te,!N.breakIndex||Q<N.breakIndex,le>Q,!N.hasDouble,le<se],[..._e,H>Q,le<j,le<H],[R.R.index-_.R.index>.5*_.tr,M,!N.breakIndex||H<N.breakIndex,le>H],[J,re,le>q,_e.every(Boolean)||le>he]],U.step=1,U.result=U.steps[0].every(Boolean),Te=_.R1.price,U.result&&(le<=H?(U.step=2,U.result=U.steps[1].every(Boolean),Te=R.S1.price):(U.step=3,U.result=U.steps[2].every(Boolean),Te=N.R1.price,U.result&&(U.step=4,U.result=U.steps[3].every(Boolean),U.result&&(Te=N.xBox.R.price))));const Me=`${te?I?1:0:2}${ne?M?1:0:2}${re?J?1:0:2}`,ye=_.rEp,Re=l(n.price,ye,w),Ve=N.breakIndex??le,Ee=parseInt((Ve-_.R.index)/_.tr),Le=Ee>1?ye*Ee:ye,We=l(n.price,Le,w);return{progress:U,timeMark:be,info:{rEpr1:_.rEpr,rEpr2:R.rEpr,rEpr3:N.rEpr,entry:Te,pStatus:Me,x:Re,X:ye,y:We,Y:Le}}}function m({phase:i,start:n,end:y,side:u,breakPrice:w,retracementPrice:Z,stopTime:_}){let R=e.cloneDeep(n),N=e.cloneDeep(y??{});R.index=r.timeToIndex(R.time);let I={},M={},J={},te=null,ne,re=0,Q;return r.prices.filter(se=>{let H=se.time>=R.time;return _&&(H&=se.time<=_),H}).every((se,H)=>{const j=se.value,q=r.timeToIndex(se.time);if(q===-1)return!1;if(H===0&&(I={R:{index:q,price:j},S:{index:q,price:j},pr:0,tr:0},Q=q,M=e.cloneDeep(I),J=e.cloneDeep(I)),e.cmp(j,u,I.R.price)?(I.pr>0&&((I.pr>M.pr||I.pr===M.pr&&I.tr>=M.tr)&&(M.pr=I.pr,M.R=e.cloneDeep(I.R),M.S=e.cloneDeep(I.S)),I.tr>M.tr&&(M.tr=I.tr),i===1&&Z&&!e.cmp(I.S.price,!u,Z)&&I.tr>=J.tr&&I.pr>=J.pr&&(J=e.cloneDeep(I))),I={R:{index:q,price:j},S:{index:q,price:j},pr:0,tr:0},i===3&&w&&!te&&e.cmp(j,u,w)&&(te=q)):(I.tr=q-I.R.index,e.cmp(j,!u,I.S.price)&&(I.S.index=q,I.S.price=j,I.pr=e.fmtNum(I.S.price-I.R.price,1,!0))),Q=q,j===R.price)re=e.fmtNum(q-R.index,1);else if(e.cmp(j,!u,R.price))return I.S.price=R.price,!1;return!(N.price&&!e.cmp(j,!u,N.price))}),e.isSet(I)&&(i===3&&(J=I,N.price=J.R.price),N.index=Q,N.time=r.indexToTime(N.index),ne=e.fmtNum(N.price-M.R.price,1,!0)),{tr:M.tr,pr:M.pr,rEp:ne,rEpr:M.pr?e.fmtNum(ne/M.pr,1):0,S1:M.S,R1:M.R,xBox:J,S:R,R:N,hasDouble:re>=M.tr/2,breakIndex:te}}function t({A:{time:i}}){return i>=r.prices[0].time&&i<r.prices.at(-1).time}function l(i,n,y){const u=i+(y?1:-1)*n;let w=e.fmtNum(u%1);if(y){if(w>=.1&&w<=.2)return Math.floor(u);if(w>=.6&&w<=.7)return Math.floor(u)+.5}else{if(w>=.8&&w<=.9)return Math.ceil(u);if(w>=.3&&w<=.4)return Math.floor(u)+.5}return u}function v(){if(r.pickTimeToolRef.get())return!1;const n=a.B.price-a.A.price>0,y=r.prices.at(-1).value;if(e.cmp(y,!n,a.C.price)){let u=y;for(let w=r.prices.length-1;w>=0;w--){const Z=r.prices[w].value;if(Z===a.B.price)break;u=n?Math.min(u,Z):Math.max(u,Z)}a.C.price=u,d()}}function d(i=!1){let n={isRemove:i,name:"pattern",points:[],data:[]};i?a={}:Object.entries(a).forEach(([y,u])=>{n.points.push(y),n.data.push(u)}),p.dispatch("tradingDerivative/drawTools",n)}function O(){d(!0),r.pickTimeToolRef.remove(),x(),h("setProgress",{})}function x(){e.isSet(f.A)&&(r.priceSeries.removePriceLine(f.A),e.isSet(f.B)&&(r.priceSeries.removePriceLine(f.B),e.isSet(f.C)&&(r.priceSeries.removePriceLine(f.C),r.priceSeries.removePriceLine(f.D),r.priceSeries.removePriceLine(f.X),r.priceSeries.removePriceLine(f.Y)))),f={},S([])}function S(i){const n=["#F44336","#F44336","#4CAF50","#009688","#FFEB3B","#FF9800"];let y=[];for(let u=0;u<i.length;u++){let w=r.indexToTime(i[u]);w&&(i.indexOf(i[u])!==i.lastIndexOf(i[u])&&(w+=u),y.push({time:w,value:1,color:n[u]}))}y.length&&y.sort((u,w)=>u.time-w.time),r.timeMarkSeries.setData(y)}function o({lineOptions:i}){if(e.isSet(f.C)){let n,y;a={A:{time:a.A.time,price:+f.A.options().price},B:{price:+f.B.options().price},C:{price:+f.C.options().price}},d();const{progress:u,timeMark:w,info:{rEpr1:Z,rEpr2:_,rEpr3:R,entry:N,pStatus:I,x:M,X:J,y:te,Y:ne}}=s();h("setProgress",u),S(w),n="A",y={title:`A ${Z}`},f[n].applyOptions(y),n="B",y={title:`B ${_}`},f[n].applyOptions(y),n="C",y={title:`C ${R}`},f[n].applyOptions(y),n="D",y={price:N,title:"Entry "+I},i.point===n&&delete y.price,f[n].applyOptions(y),n="X",y={price:e.fmtNum(M),title:`X ${e.fmtNum(J)}`},f[n].applyOptions(y),n="Y",y={price:e.fmtNum(te),title:`Y ${e.fmtNum(ne)}`},f[n].applyOptions(y)}}return(i,n)=>(z(),ee("div",{ref_key:"patternToolRef",ref:k,class:"command",title:i.$t("trading.derivative.patternTool"),onClick:L,onContextmenu:V},Gt,40,qt))}},Kt=["title"],ei=F("i",{class:"far fa-pipe"},null,-1),ti=[ei],ii={__name:"PickTimeTool",props:["pickTimeSeries"],emits:["refreshPattern","hideContext"],setup(E,{expose:P,emit:C}){const p=ge(),e=E,r=C,h=B(null),k=ce(()=>p.state.tradingDerivative.tools.pickTime);let A=null;P({isSelected:a,draw:V,remove:Y,get:f}),Se(k,$=>{$&&W($[0])});function a(){return h.value.classList.contains("selected")}function f(){return A}function g($){r("hideContext");const T=$.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(s=>s.classList.remove("selected")),T||$.target.classList.add("selected")}function L($){$.target.classList.remove("selected"),Y(),r("refreshPattern")}function V({time:$}){p.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"pickTime",points:[0],data:[$]}),W($),r("refreshPattern"),h.value.classList.remove("selected")}function W($){A=$,e.pickTimeSeries.setData([{time:$,value:1,color:"#9C27B0"}])}function Y($=!0){$&&p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"pickTime"}),e.pickTimeSeries.setData([]),A=null}return($,T)=>(z(),ee("div",{ref_key:"pickTimeToolRef",ref:h,class:"command",title:$.$t("trading.derivative.pickTimeTool"),onClick:g,onContextmenu:L},ti,40,Kt))}},ni={class:"input"},si={class:"color"},ri=["onClick"],oi={__name:"LineContext",props:["enable","title","color"],emits:["update:title","update:color"],setup(E,{emit:P}){const C=E,p=P,e=B(null),r=B(["#F44336","#FF9800","#FFEB3B","#4CAF50","#009688","#00BCD4","#2196F3","#673AB7","#9C27B0","#E91E63"]);Se(()=>C.enable,a=>{a&&kt().then(()=>e.value.instance.focus())});function h({value:a}){p("update:title",a)}function k(a){p("update:color",a)}function A(){p("deleteAllLine")}return(a,f)=>{const g=ot("DxButton");return z(),qe(Ge,{class:"line-context"},{default:Ue(()=>[F("div",ni,[ie(at(Et),{ref_key:"titleRef",ref:e,value:C.title,"show-clear-button":!0,"input-attr":{style:`color:${C.color}`},onValueChanged:h},null,8,["value","input-attr"]),ie(g,{icon:"trash",type:"danger",onClick:f[0]||(f[0]=L=>A())})]),F("div",si,[(z(!0),ee(Xe,null,je(r.value,(L,V)=>(z(),ee("div",{class:"color-swatch",style:wt({background:L,boxShadow:`0 0 4px ${L}`}),key:V,onClick:W=>k(L)},null,12,ri))),128))])]),_:1})}}},ai=["title"],ci=F("i",{class:"far fa-horizontal-rule"},null,-1),li={__name:"LineTool",props:["priceSeries"],emits:["hideContext"],setup(E,{expose:P,emit:C}){const p=ge(),e=E,r=C,h=B(null),k=B(!1),A=ce(()=>p.state.tradingDerivative.tools.line),a=B(""),f=B("#F44336");let g=[];P({isSelected:L,hide:V,draw:$,drag:t}),Se(A,l=>{l&&T(l)});function L(){return h.value.classList.contains("selected")}function V(){k.value=!1}function W(l){r("hideContext");const v=l.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(d=>d.classList.remove("selected")),v||l.target.classList.add("selected")}function Y(l){const v=k.value;r("hideContext"),k.value=!v}function $({price:l}){const v="line",d=g.length;if(g=g.filter(O=>{const x=O.options(),S=x.type=l===+x.price;return S&&(e.priceSeries.removePriceLine(O),p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:v,point:l})),!S}),g.length===d){const O=f.value,x=a.value,S={lineType:v,price:l,color:O,title:x,lineWidth:1,lineStyle:1,draggable:!0};g.push(e.priceSeries.createPriceLine(S)),p.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:v,points:[l],data:[{color:O,title:x}]})}h.value.classList.remove("selected")}function T(l){m(!1),s(l)}function s(l){const d={lineType:"line",lineWidth:1,lineStyle:1,draggable:!0};Object.entries(l).forEach(([O,{color:x,title:S}])=>{d.price=+O,d.color=x,d.title=S,g.push(e.priceSeries.createPriceLine(d))})}function m(l=!0){g.length>0&&(l&&p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line"}),g.forEach(v=>e.priceSeries.removePriceLine(v)),g=[])}function t({lineOptions:l,oldPrice:v,newPrice:d}){p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line",point:v});const O=l.color,x=l.title;p.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"line",points:[d],data:[{color:O,title:x}]}),h.value.classList.remove("selected")}return(l,v)=>(z(),ee("div",{ref_key:"lineToolRef",ref:h,class:"context command",title:l.$t("trading.derivative.lineTool"),onClick:W,onContextmenu:Y},[ci,Ce(ie(oi,{class:"contextmenu",enable:k.value,title:a.value,"onUpdate:title":v[0]||(v[0]=d=>a.value=d),color:f.value,"onUpdate:color":v[1]||(v[1]=d=>f.value=d),onDeleteAllLine:m},null,8,["enable","title","color"]),[[De,k.value]])],40,ai))}},pi=["title"],ui=F("i",{class:"far fa-grip-lines-vertical"},null,-1),di=[ui],fi={__name:"TimeRangeTool",props:["timeRangeSeries","timeToIndex","indexToTime"],emits:["hideContext"],setup(E,{expose:P,emit:C}){const p=ge(),e=ve("mf"),r=E,h=C,k=B(null),A=ce(()=>p.state.tradingDerivative.tools.timeRange);let a=[];P({isSelected:f,draw:V}),Se(A,T=>{T&&W(T)});function f(){return k.value.classList.contains("selected")}function g(T){h("hideContext");const s=T.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(m=>m.classList.remove("selected")),s||T.target.classList.add("selected")}function L(T){$(),T.target.classList.remove("selected")}function V({time:T}){let s={isRemove:!1,name:"timeRange",points:[],data:[]},m={time:T,value:1};switch(a.length){case 0:m.color="OrangeRed",a[0]=m,s.points.push(0),s.data.push(T);break;case 1:m.color="lime",a[1]=m,s.points.push(1),s.data.push(T),k.value.classList.remove("selected");break;default:const t=r.timeToIndex(a[0].time),l=r.timeToIndex(a[1].time),d=r.timeToIndex(T)+(l-t),O=r.indexToTime(d);m.color="OrangeRed",a[0]=e.cloneDeep(m),s.points.push(0),s.data.push(T),m.time=O,m.color="lime",a[1]=m,s.points.push(1),s.data.push(O),k.value.classList.remove("selected");break}r.timeRangeSeries.setData(a),p.dispatch("tradingDerivative/drawTools",s)}function W(T){$(!1),Y(T)}function Y(T){let s,m;if(T.length===2)s=T[0],m=T[1];else if(T.length===3){const l=r.timeToIndex(T[0]),v=r.timeToIndex(T[1]),O=r.timeToIndex(T[2])+(v-l);s=T[2],m=r.indexToTime(O)}else return!1;let t=[{time:s,value:1,color:"OrangeRed"},{time:m,value:1,color:"lime"}];a=t,r.timeRangeSeries.setData(t)}function $(T=!0){T&&p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"timeRange"}),r.timeRangeSeries.setData([]),a=[]}return(T,s)=>(z(),ee("div",{ref_key:"timeRangeToolRef",ref:k,class:"command",title:T.$t("trading.derivative.timeRangeTool"),onClick:g,onContextmenu:L},di,40,pi))}},mi=["title"],vi=F("i",{class:"far fa-line-height"},null,-1),hi=[vi],gi={__name:"TargetTool",props:["priceSeries"],emits:["hideContext"],setup(E,{expose:P,emit:C}){const p=ge(),e=ve("mf"),r=E,h=C,k=B(null),A=ce(()=>p.state.tradingDerivative.tools.target);let a={};P({isSelected:f,draw:V,drag:T}),Se(A,s=>{s&&W(s)});function f(){return k.value.classList.contains("selected")}function g(s){h("hideContext");const m=s.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(t=>t.classList.remove("selected")),m||(s.target.classList.add("selected"),$())}function L(s){$(),s.target.classList.remove("selected")}function V({price:s}){const m="target";let t={lineType:m,price:s,lineWidth:1,lineStyle:1,draggable:!0},l={isRemove:!1,name:m,points:[],data:[s]};if(e.isSet(a.A)){const v=+a.A.options().price,d=s-v;t.point="B",t.title=e.fmtNum(d),t.color="#F44336",a[t.point]=r.priceSeries.createPriceLine(t),l.points.push(t.point),t.point="X",t.price=e.fmtNum(v-.5*d),t.title=e.fmtNum(-.5*d),t.color="#2196F3",a[t.point]=r.priceSeries.createPriceLine(t),t.point="Y",t.price=e.fmtNum(v-d),t.title=e.fmtNum(-d),t.color="#673AB7",a[t.point]=r.priceSeries.createPriceLine(t),t.point="Z",t.price=e.fmtNum(v-2*d),t.title=e.fmtNum(-2*d),t.color="#9C27B0",a[t.point]=r.priceSeries.createPriceLine(t),t.point="W",t.price=e.fmtNum(v-4*d),t.title=e.fmtNum(-4*d),t.color="#E91E63",a[t.point]=r.priceSeries.createPriceLine(t),k.value.classList.remove("selected")}else t.point="A",t.title="0",t.color="#FF9800",a[t.point]=r.priceSeries.createPriceLine(t),l.points.push(t.point);p.dispatch("tradingDerivative/drawTools",l)}function W(s){$(!1),Y(s)}function Y(s){let t={lineType:"target",lineWidth:1,lineStyle:1,draggable:!0};const l=s.A,v=s.B,d=v-l;t.point="A",t.price=l,t.title="0",t.color="#FF9800",a[t.point]=r.priceSeries.createPriceLine(t),t.point="B",t.price=v,t.title=e.fmtNum(d),t.color="#F44336",a[t.point]=r.priceSeries.createPriceLine(t),t.point="X",t.price=e.fmtNum(l-.5*d),t.title=e.fmtNum(-.5*d),t.color="#2196F3",a[t.point]=r.priceSeries.createPriceLine(t),t.point="Y",t.price=e.fmtNum(l-d),t.title=e.fmtNum(-d),t.color="#673AB7",a[t.point]=r.priceSeries.createPriceLine(t),t.point="Z",t.price=e.fmtNum(l-2*d),t.title=e.fmtNum(-2*d),t.color="#9C27B0",a[t.point]=r.priceSeries.createPriceLine(t),t.point="W",t.price=e.fmtNum(l-4*d),t.title=e.fmtNum(-4*d),t.color="#E91E63",a[t.point]=r.priceSeries.createPriceLine(t)}function $(s=!0){s&&p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"target"}),e.isSet(a.A)&&(r.priceSeries.removePriceLine(a.A),e.isSet(a.B)&&(r.priceSeries.removePriceLine(a.B),r.priceSeries.removePriceLine(a.X),r.priceSeries.removePriceLine(a.Y),r.priceSeries.removePriceLine(a.Z),r.priceSeries.removePriceLine(a.W))),a={}}function T({lineOptions:s,newPrice:m}){if(e.isSet(a.B)){let t={isRemove:!1,name:"target",points:[],data:[]},l,v,d=+a.A.options().price,O=+a.B.options().price,x=O-d;if(l="A",s.point==="A")x=+a.B.options().title,O=d+x;else if(s.point!=="B"){let S=0;switch(s.point){case"X":S=1.5;break;case"Y":S=2;break;case"Z":S=3;break;case"W":S=5;break}x=e.fmtNum((O-m)/S),d=O-x,v={price:d},a[l].applyOptions(v)}t.points.push(l),t.data.push(d),l="B",v={price:O,title:e.fmtNum(x)},s.point===l&&delete v.price,a[l].applyOptions(v),t.points.push(l),t.data.push(O),l="X",v={price:e.fmtNum(d-.5*x),title:e.fmtNum(-.5*x)},s.point===l&&delete v.price,a[l].applyOptions(v),l="Y",v={price:e.fmtNum(d-x),title:e.fmtNum(-x)},s.point===l&&delete v.price,a[l].applyOptions(v),l="Z",v={price:e.fmtNum(d-2*x),title:e.fmtNum(-2*x)},s.point===l&&delete v.price,a[l].applyOptions(v),l="W",v={price:e.fmtNum(d-4*x),title:e.fmtNum(-4*x)},s.point===l&&delete v.price,a[l].applyOptions(v),p.dispatch("tradingDerivative/drawTools",t)}}return(s,m)=>(z(),ee("div",{ref_key:"targetToolRef",ref:k,class:"command",title:s.$t("trading.derivative.targetTool"),onClick:g,onContextmenu:L},hi,40,mi))}},Si=["title"],st=3,rt=2,Ti={__name:"OrderTool",props:["position","prices","priceSeries","inSession","TIME"],emits:["getTools","showEntry","showTpSl","orderChanged","hideContext"],setup(E,{expose:P,emit:C}){const p=ge(),{t:e}=Be(),r=ve("mf"),h=E,k=C,A=B(null),a=B(!1),f=ce(()=>p.state.tradingDerivative.tools.order);let g={},L={},V=!1;P({show:Y,entry:$,tpsl:T,cancel:s,cancelWithoutClose:m,scan:t,drag:O}),Se(f,S=>{S&&v(S)});function W(){return r.isSet(L.entry)||r.isSet(L.tp)}function Y({price:S}){if(S&&h.inSession()){const o=G(ke(new Date,7));if(r.isSet(L.entry))!r.isSet(L.tp)&&h.position&&o>h.TIME.ATO&&o<h.TIME.ATC&&k("showTpSl",{side:h.position});else{let i=null,n=0;h.position?(o<h.TIME.ATO?i="ATO":o>h.TIME.ATC&&(i="ATC"),i&&(g.entry=i,n=-h.position)):o>h.TIME.ATO&&o<h.TIME.ATC&&(i=S,n=i>=h.prices.at(-1).value?1:-1,g.side=n,g.entry=i),n&&k("showEntry",{side:n,price:i})}}}function $(){if(h.inSession()){const S=G(ke(new Date,7));S<h.TIME.ATO?it(e("trading.derivative.atoOrder"),e("titles.confirm")).then(i=>{i&&p.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(n=>{n.isOk?oe.success(e("trading.derivative.atoOrderSuccess")):x(n.message)})}):S>h.TIME.ATC?it(e("trading.derivative.atcOrder"),e("titles.confirm")).then(i=>{i&&p.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(n=>{n.isOk?oe.success(e("trading.derivative.atcOrderSuccess")):x(n.message)})}):p.dispatch("tradingDerivative/executeOrder",{action:"entry",entryData:{cmd:"new",side:g.side,price:g.entry}}).then(o=>{o.isOk?(l(["entry"]),oe.success(e("trading.derivative.newEntrySuccess"))):x(o.message)})}}function T(){g.tp=g.entry+g.side*st,g.sl=g.entry-g.side*rt,p.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:g.tp},slData:{cmd:"new",price:g.sl}}).then(S=>{S.isOk?(L.entry.applyOptions({draggable:!1}),l(["tp","sl"]),oe.success(e("trading.derivative.newTpSlSuccess"))):x(S.message)})}function s(){r.isSet(L.entry)?r.isSet(L.tp)?p.dispatch("tradingDerivative/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(S=>{S.isOk?(d(["entry","tp","sl"]),oe.success(e("trading.derivative.exitSuccess"))):x(S.message)}):p.dispatch("tradingDerivative/executeOrder",{action:"entry",entryData:{cmd:"delete"}}).then(S=>{S.isOk?(d(["entry"]),oe.success(e("trading.derivative.deleteEntrySuccess"))):x(S.message)}):k("getTools")}function m(){if(h.inSession()&&h.position){const S=G(ke(new Date,7));S>h.TIME.ATC-5*60&&(a.value=!0,S>h.TIME.ATC-15&&r.isSet(L.tp)&&p.dispatch("tradingDerivative/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(o=>{o.isOk?(d(["entry","tp","sl"]),oe.success(e("trading.derivative.autoCancelTpSlSuccess"))):x(o.message)}))}}function t(S){if(r.isSet(L.entry)){const o=g.side>0;r.isSet(L.tp)?(r.cmp(S,o,g.tp,!0)&&(V||(V=!0,p.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"delete"}}).then(i=>{i.isOk?(d(["entry","tp","sl"]),oe.success(e("trading.derivative.deleteTpSuccess"))):x(i.message),V=!1}))),r.cmp(S,!o,g.sl,!0)&&(V||(V=!0,p.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"cancel"}}).then(i=>{i.isOk?(d(["entry","tp","sl"]),oe.success(e("trading.derivative.deleteSlSuccess"))):x(i.message),V=!1})))):r.cmp(S,o,g.entry,!0)&&(V||(V=!0,setTimeout(()=>{g.tp=g.entry+g.side*st,g.sl=g.entry-g.side*rt,p.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:g.tp},slData:{cmd:"new",price:g.sl}}).then(i=>{i.isOk?(L.entry.applyOptions({draggable:!1}),l(["tp","sl"]),oe.success(e("trading.derivative.autoNewTpSlSuccess"))):x(i.message),V=!1})},1e3)))}}function l(S,o=!0){const i="order";let n={isRemove:!1,name:i,points:[],data:[]},y,u;S.forEach(w=>{switch(w){case"entry":y="yellow",u=g.side>0?"LONG":"SHORT";break;case"tp":y="lime",u=r.fmtNum(g.tp-g.entry,1,!0);break;case"sl":y="red",u=r.fmtNum(g.sl-g.entry,1,!0);break}if(r.isSet(L[w]))L[w].applyOptions({price:g[w],title:u}),n.points.push(w),n.data.push(g[w]);else{const Z={lineType:i,kind:w,side:g.side,price:g[w],color:y,lineWidth:1,lineStyle:0,title:u,draggable:!(w==="entry"&&g.tp)};L[w]=h.priceSeries.createPriceLine(Z),w==="entry"&&(n.points.push("side"),n.data.push(g.side)),n.points.push(w),n.data.push(g[w])}}),o&&p.dispatch("tradingDerivative/drawTools",n),k("orderChanged",W())}function v(S){g=r.cloneDeep(S);let o=["entry"];"tp"in g&&o.push("tp","sl"),d(["entry","tp","sl"],!1),l(o,!1),k("orderChanged",W())}function d(S,o=!0){o&&p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"order"}),S.forEach(i=>{r.isSet(L[i])&&(h.priceSeries.removePriceLine(L[i]),delete L[i])}),k("orderChanged",W())}function O({line:S,lineOptions:o,oldPrice:i,newPrice:n}){if(n!==i){const y=o.kind;if(y!=="entry"||!h.position){const w=`${y}Data`,Z=`change${y[0].toUpperCase()}${y.slice(1)}Success`;p.dispatch("tradingDerivative/executeOrder",{action:y,[w]:{cmd:"change",price:n}}).then(_=>{_.isOk?(g[y]=n,l([y]),oe.success(e(`trading.derivative.${Z}`))):(S.applyOptions({price:i}),x(_.message))})}else S.applyOptions({price:i}),oe.show(e("trading.derivative.noChangeOrderLine"))}}function x(S){S||(S="unknown"),oe.error(e(`trading.derivative.${S}`))}return(S,o)=>(z(),ee("div",{ref_key:"orderToolRef",ref:A,class:"cancel-order command",title:S.$t("trading.derivative.orderTool"),onClick:s},[F("i",{class:ae(["far fa-trash-alt",{blink:a.value}])},null,2)],8,Si))}},yi=["title"],xi=["title"],Ci=["title"],ki=["title"],wi=F("i",{class:"far fa-angle-double-right"},null,-1),Di=[wi],bi="wss://tradestation.fireant.vn/quote?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",_i="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",Ii={__name:"Chart",setup(E,{expose:P}){const C=ge(),p=_t(),{t:e}=Be(),r=ve("mf"),h=ve("devices"),k=ve("filters"),A=B(null),a=B(null),f=B(null),g=B(null),L=B(null),V=B(null),W=B(null),Y=B(null),$=B(null),T=B(null),s=B(null),m=B(null),t=B(null),l=B(null),v=B(null),d=B(null),O={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.25,bottom:.25}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:1e3,minBarSpacing:.01,barSpacing:.05}},x=Ae(new Date,"yyyy-MM-dd"),S={START:G(new Date(`${x}T08:45:00Z`)),ATO:G(new Date(`${x}T09:00:00Z`)),ATC:G(new Date(`${x}T14:30:00Z`)),END:G(new Date(`${x}T14:45:00Z`))};let o={chart:{},whitespaces:[],crosshair:{},interval:null,refreshAt:Je(new Date,11),statusAt:Je(new Date,21),websocket:null,socketStop:!1,vpsUpdatedAt:Je(new Date,61)};const i=Dt({prices:[],series:{},chartDate:p.query.date??x,clock:Ae(new Date,"HH:mm:ss"),chartHeightEnough:!1,isSocketWarning:!1,hasOrderLine:!1,TIME:S}),n=ce(()=>C.state.tradingDerivative.status),y=ce(()=>C.state.tradingDerivative.config),u=ce(()=>C.state.tradingDerivative.isLoading),w=ce(()=>n.value.position||n.value.pending||i.hasOrderLine);o.interval=setInterval(()=>{i.clock=Ae(new Date,"HH:mm:ss"),Oe()&&(l.value&&l.value.cancelWithoutClose(),ze(new Date,new Date(o.refreshAt))>10&&(y.value.autoRefresh&&$.value.refresh(!0),o.refreshAt=new Date),ze(new Date,new Date(o.statusAt))>20&&(Ke(),o.statusAt=new Date))},1e3),dt(),we(()=>{te(),Z(),new ResizeObserver(J).observe(A.value),document.addEventListener("keydown",Q)}),Ne(()=>{_(),document.removeEventListener("keydown",Q),clearInterval(o.interval),be(),o.socketStop=!0}),Se(()=>C.state.tradingDerivative.chartData,se),P({connectSocket:he});function Z(){o.chart=Lt(a.value,O),o.chart.subscribeCrosshairMove(ne),o.chart.subscribeCustomPriceLineDragged(re),i.series.whitespace=o.chart.addHistogramSeries({priceScaleId:"whitespace",scaleMargins:{top:0,bottom:0},color:"#808080",lastValueVisible:!1,priceLineVisible:!1}),i.series.timeRange=o.chart.addHistogramSeries({priceScaleId:"timeRange",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),i.series.pickTime=o.chart.addHistogramSeries({priceScaleId:"pickTime",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),i.series.timeMark=o.chart.addHistogramSeries({priceScaleId:"timeMark",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),i.series.price=o.chart.addLineSeries({color:"#F5F5F5",priceFormat:{minMove:.1}})}function _(){o.chart&&(o.chart.remove(),o.chart=null)}function R(c){de(),Re(!1),Y.value.isSelected()?Y.value.draw({time:o.crosshair.time}):$.value.isSelected()?$.value.draw({time:o.crosshair.time,price:Ie(o.crosshair.y)}):T.value.isSelected()?T.value.draw({time:o.crosshair.time}):s.value.isSelected()?s.value.draw({price:Ie(o.crosshair.y)}):m.value.isSelected()?m.value.draw({time:o.crosshair.time}):t.value.isSelected()&&t.value.draw({price:Ie(o.crosshair.y)})}function N(c){Re(!0),c.preventDefault()}function I(c){c.stopPropagation()}function M(c){c.preventDefault(),c.stopPropagation()}function J(){A.value&&(te(),o.chart.resize(A.value.offsetWidth,A.value.offsetHeight),L.value.checkFullscreen())}function te(){i.chartHeightEnough=A.value.offsetHeight>700}function ne(c){if(c.time){let D=c.seriesPrices.get(i.series.price);o.crosshair.time=c.time,o.crosshair.price=D}else h.phone||(o.crosshair.time=null,o.crosshair.price=null);c.point!==void 0&&(o.crosshair.x=c.point.x,o.crosshair.y=c.point.y)}function re(c){let D=c.customPriceLine,b=D.options();b.price=r.fmtNum(b.price);const X=+c.fromPriceString,K=b.price;switch(b.lineType){case"order":l.value.drag({line:D,lineOptions:b,oldPrice:X,newPrice:K});break;case"line":s.value.drag({lineOptions:b,oldPrice:X,newPrice:K});break;case"target":t.value.drag({lineOptions:b,newPrice:K});break;case"pattern":$.value.drag({lineOptions:b});break}}function Q(c){const D=o.chart.timeScale(),b=o.chart.options().timeScale.barSpacing;switch(c.key){case"[":c.ctrlKey?D.applyOptions({barSpacing:b-.01}):c.altKey&&D.scrollToPosition(D.scrollPosition()-50);break;case"]":c.ctrlKey?D.applyOptions({barSpacing:b+.01}):c.altKey&&D.scrollToPosition(D.scrollPosition()+50);break}}function se(c){i.chartDate===x&&Oe()||(c.price.length>0&&(o.whitespaces=q(o.whitespaces,j(i.chartDate))),i.series.whitespace.setData(o.whitespaces),i.prices=q(i.prices,c.price),i.series.price.setData(i.prices))}function H(c,D=null){const b=D??y.value.source;let X=[];c.forEach(K=>{let pe,fe;b==="FireAnt"?(pe=G(ke(new Date(K.date),7)),fe=K.price):(pe=G(new Date(`${x}T${K.time}Z`)),fe=K.lastPrice),X.push({time:pe,value:fe})}),X.length>1?(i.prices=q(i.prices,X),i.series.price.setData(i.prices)):(i.prices.push(X[0]),i.series.price.update(X[0]))}function j(c){const D=G(new Date(`${c}T09:00:00Z`)),b=G(new Date(`${c}T11:30:00Z`)),X=G(new Date(`${c}T13:00:00Z`)),K=G(new Date(`${c}T14:30:00Z`)),pe=G(new Date(`${c}T14:00:00Z`)),fe=G(new Date(`${c}T15:00:00Z`));let He=[];for(let ue=D;ue<=K;ue++){if(ue>b&&ue<X)continue;let Pe={time:ue};(ue===pe||ue===K)&&(Pe.value=1),He.push(Pe)}if(i.chartDate===x)for(let ue=K+1;ue<=fe;ue++){let Pe={time:ue};He.push(Pe)}return He}function q(c,D){return Array.from(new Map([...c,...D].sort((b,X)=>b.time-X.time).map(b=>[b.time,b])).values())}async function he(){if(Oe()){await be();const c=y.value.source==="FireAnt",D=c?bi:_i;o.websocket=new WebSocket(D),o.websocket.onclose=b=>{o.socketStop||(i.isSocketWarning=!0,he())},c?le():(_e(),U())}}async function be(){o.websocket&&o.websocket.readyState===WebSocket.OPEN&&(o.websocket.close(),await new Promise(c=>{const D=setInterval(()=>{(!o.websocket||o.websocket.readyState===WebSocket.CLOSED)&&(o.websocket=null,clearInterval(D),c())},100)}))}function le(){C.dispatch("tradingDerivative/setLoading",!0),o.websocket.onopen=c=>{if(o.websocket.readyState===WebSocket.OPEN){let D='{"protocol":"json","version":1}';o.websocket.send(D),D='{"arguments":["VN30F1M"],"invocationId":"0","target":"SubscribeTrades","type":1}',o.websocket.send(D)}},o.websocket.onmessage=c=>{i.isSocketWarning=!1,Te(c.data).forEach(b=>{if(!b)return!1;b.type===3?(b.result[0].date.slice(0,10)===x&&($e(),o.whitespaces=q(o.whitespaces,j(x)),i.series.whitespace.setData(o.whitespaces),H(b.result)),C.dispatch("tradingDerivative/setLoading",!1)):b.type===1&&b.target==="UpdateTrades"&&b.arguments[0]==="VN30F1M"&&(console.log("FireAnt",b.arguments[1]),l.value.scan(b.arguments[1].at(-1).price),H(b.arguments[1]))})}}function Te(c){let D=[];return c.split("").forEach(b=>{const X=b.indexOf("{"),K=b.lastIndexOf("}");let pe=null;if(X!==-1&&K!==-1&&K>X){const fe=b.substring(X,K+1);fe!=="{}"&&(pe=JSON.parse(fe))}D.push(pe)}),D}function U(){o.websocket.onopen=c=>{if(o.websocket.readyState===WebSocket.OPEN){const D={action:"join",list:y.value.vn30f1m},b=`42${JSON.stringify(["regs",JSON.stringify(D)])}`;o.websocket.send(b)}},o.websocket.onmessage=c=>{if(i.isSocketWarning=!1,c.data.substr(0,1)==="4"&&c.data.substr(1,1)==="2"){const D=JSON.parse(c.data.substr(2));if(D[0]==="stockps"){const b=D[1].data;b.id===3220&&(console.log("VPS",b),l.value.scan(b.lastPrice),H([b]))}}}}function _e(){ze(new Date,new Date(o.vpsUpdatedAt))>60&&(fetch("https://bddatafeed.vps.com.vn/getpschartintraday/VN30F1M").then(c=>c.json()).then(c=>{console.log(c),H(c,"VPS")}),o.vpsUpdatedAt=new Date)}function Qe(c){$.value.load(c,{isSave:!0})}function Fe(){$.value.refresh()}function de(){W.value.hide(),Y.value.hide(),s.value.hide()}function Me(c){h.phone||W.value.hide(r.isSet(c)),W.value.set(c)}function ye(c){i.hasOrderLine=c}function Re(c){c?l.value.show({price:Ie(o.crosshair.y)}):(v.value.style.display="none",d.value.style.display="none")}function Ve({side:c,price:D}){v.value.style.left=+(o.crosshair.x+(o.crosshair.x>innerWidth-71?-71:1))+"px",v.value.style.top=+(o.crosshair.y+(o.crosshair.y>innerHeight-61?-61:1))+"px",v.value.style.background=c>0?"green":"red",v.value.innerText=`${c>0?"LONG":"SHORT"} ${D}`,v.value.style.display="block"}function Ee({side:c}){d.value.style.left=+(o.crosshair.x+(o.crosshair.x>innerWidth-61?-61:1))+"px",d.value.style.top=+(o.crosshair.y+(o.crosshair.y>innerHeight-51?-51:1))+"px",d.value.style.background=c>0?"green":"red",d.value.style.display="block"}function Le(){l.value.entry()}function We(){l.value.tpsl()}function lt(){o.chart.timeScale().scrollToRealTime()}function Oe(){const c=G(ke(new Date,7));return y.value.openingMarket&&c>=S.START&&c<=S.END}function pt(){if(!i.chartDate)return!1;Ze()}function ut(){o.whitespaces=[],i.prices=[],he(),Ze()}function dt(){C.dispatch("tradingDerivative/initChart").then(()=>{he(),!p.query.date&&y.value.lastOpeningDate&&(i.chartDate=y.value.lastOpeningDate),Ze()})}function Ze(){C.dispatch("tradingDerivative/getChartData",i.chartDate).then(c=>{c&&$e()})}function Ke(){C.dispatch("tradingDerivative/getStatus")}function $e(){C.dispatch("tradingDerivative/getTools")}function ft(){C.dispatch("tradingDerivative/getAccountInfo").then(c=>{let D="";D+='<div style="width: 200px;">',D+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.nav")}</div><div>: ${k.currency(c.nav)}</div></div>`,D+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.maxVol")}</div><div>: ${k.numberVnFormat(c.maxVol)}</div></div>`,D+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.vm")}</div><div>: ${k.currency(c.vm)}</div></div>`,D+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.fee")}</div><div>: ${k.currency(c.fee)}</div></div>`,D+="</div>",Rt(D,e("trading.derivative.accountInfo"))})}function Ie(c){return r.fmtNum(i.series.price.coordinateToPrice(c))}function Ye(c){let D=o.whitespaces.findIndex(b=>b.time===c);if(D===-1){const b=Ae(new Date(c*1e3),"yyyy-MM-dd"),X=G(new Date(`${b}T11:30:00Z`)),K=G(new Date(`${b}T13:00:00Z`)),pe=G(new Date(`${b}T14:30:00Z`));c>X&&c<K?c=X:c>pe&&(c=pe),D=o.whitespaces.findIndex(fe=>fe.time===c)}return D}function et(c){return c<o.whitespaces.length?o.whitespaces[c].time:!1}return(c,D)=>(z(),ee("div",{ref_key:"chartContainerRef",ref:A,class:"derivative-chart",onClick:R,onContextmenu:N},[F("div",{ref_key:"chartRef",ref:a},null,512),F("div",{class:"area data-area",onClick:I,onContextmenu:M},[F("div",{ref_key:"connectionRef",ref:f,class:ae(["command",{yellow:n.value.pending,red:y.value.volInvalid}]),title:c.$t("trading.derivative.connection"),onClick:Ke},[F("i",{class:ae(["far",{"fa-link-simple":n.value.connection,"fa-link-simple-slash":!n.value.connection,blink:i.isSocketWarning}])},null,2)],10,yi),F("div",{class:ae(["command status",{green:n.value.position>0,red:n.value.position<0}]),title:c.$t("trading.derivative.position"),onClick:ft},xe(n.value.position),11,xi),F("div",{class:"command clock",onClick:he},xe(i.clock),1),Ce(F("input",{type:"date",class:"chart-date command",title:c.$t("trading.derivative.date"),"onUpdate:modelValue":D[0]||(D[0]=b=>i.chartDate=b),onChange:pt},null,40,Ci),[[bt,i.chartDate]]),F("div",{ref_key:"reloadToolRef",ref:g,class:"command",title:c.$t("trading.derivative.reload"),onClick:ut,onContextmenu:$e},[F("i",{class:ae(["far fa-sync-alt",{"fa-spin":u.value}])},null,2)],40,ki)],32),F("div",{class:"area tool-area",onClick:I,onContextmenu:M},[ie(It,{ref_key:"fullscreenToolRef",ref:L,chartContainerRef:A.value},null,8,["chartContainerRef"]),ie(Nt,{ref_key:"tradingviewToolRef",ref:V,vpsUser:y.value.vpsUser,vpsSession:y.value.vpsSession,chartContainerRef:A.value},null,8,["vpsUser","vpsSession","chartContainerRef"]),ie(Wt,{ref_key:"progressToolRef",ref:W,chartHeightEnough:i.chartHeightEnough,onRefreshPattern:Fe,onHideContext:de},null,8,["chartHeightEnough"]),ie(jt,{ref_key:"scanToolRef",ref:Y,prices:i.prices,timeToIndex:Ye,onScaned:Qe,onRemovePattern:D[1]||(D[1]=()=>$.value.remove()),onHideContext:de},null,8,["prices"]),ie(Qt,{ref_key:"patternToolRef",ref:$,prices:i.prices,priceSeries:i.series.price,timeMarkSeries:i.series.timeMark,pickTimeToolRef:T.value,timeToIndex:Ye,indexToTime:et,onSetProgress:Me,onHideContext:de},null,8,["prices","priceSeries","timeMarkSeries","pickTimeToolRef"]),ie(ii,{ref_key:"pickTimeToolRef",ref:T,pickTimeSeries:i.series.pickTime,onRefreshPattern:Fe,onHideContext:de},null,8,["pickTimeSeries"]),ie(li,{ref_key:"lineToolRef",ref:s,priceSeries:i.series.price,onHideContext:de},null,8,["priceSeries"]),ie(fi,{ref_key:"timeRangeToolRef",ref:m,timeRangeSeries:i.series.timeRange,timeToIndex:Ye,indexToTime:et,onHideContext:de},null,8,["timeRangeSeries"]),ie(gi,{ref_key:"targetToolRef",ref:t,priceSeries:i.series.price,onHideContext:de},null,8,["priceSeries"]),Ce(ie(Ti,{ref_key:"orderToolRef",ref:l,position:n.value.position,prices:i.prices,priceSeries:i.series.price,inSession:Oe,TIME:i.TIME,onGetTools:$e,onShowEntry:Ve,onShowTpSl:Ee,onOrderChanged:ye,onHideContext:de},null,8,["position","prices","priceSeries","TIME"]),[[De,w.value]])],32),F("div",null,[F("div",{ref_key:"entryOrderRef",ref:v,class:"order-button entry",onClick:Le}," Entry ",512),F("div",{ref_key:"tpslOrderRef",ref:d,class:"order-button tpsl",onClick:We}," TP/SL ",512),F("div",{class:"chart-top",onClick:lt},Di)])],544))}};export{Ii as default};
