import{z as dt,A as ft,B as mt,r as B,y as Ye,C as et,o as z,b as J,d as F,E as oe,c as le,G as xe,H as _e,I as vt,J as ht,m as tt,e as te,F as We,K as Ze,t as Te,h as me,u as $e,k as fe,L as gt,M as St,N as qe,O as it,g as nt,w as ve,Q as yt,R as Tt,S as Qe,x as ae,l as Pe,a as xt,T as Me,U as Ct,j as kt,V as _t}from"./app-c93ccb61.js";import{_ as bt}from"./text-box-1efa51fb.js";import{g as G}from"./getUnixTime-5a1ded35.js";import{c as wt}from"./lightweight-charts.esm.development-03366bac.js";function st(R,N,k){return dt((k==null?void 0:k.in)||R,+ft(R)+N)}function ke(R,N,k){return st(R,N*mt,k)}function Dt(R,N,k){return st(R,N*1e3,k)}function Ve(R,N,k){return Dt(R,-N,k)}const Rt=["title"],Et={__name:"FullscreenTool",props:["chartContainerRef"],setup(R,{expose:N}){const k=R,u=B(!1);N({setFullscreen:T,toggleFullscreen:e}),Ye(()=>{document.addEventListener("fullscreenchange",r)}),et(()=>{document.removeEventListener("fullscreenchange",r)});function e({set:D=!1,unset:l=!1}){document.fullscreenElement?D||document.exitFullscreen():l||document.documentElement.requestFullscreen()}function r(){k.chartContainerRef&&(document.fullscreenElement?(u.value=!0,k.chartContainerRef.classList.add("fullscreen"),T()):(u.value=!1,k.chartContainerRef.classList.remove("fullscreen"),x()))}function T(){document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"}function x(){document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"}return(D,l)=>(z(),J("div",{class:"command",title:D.$t("trading.derivative.fullscreen"),onClick:e},[F("i",{class:oe(["far",{"fa-compress":u.value,"fa-expand":!u.value}])},null,2)],8,Rt))}},Lt=["title"],Ot=["src"],Pt={__name:"TradingviewTool",props:["vpsUser","vpsSession","chartContainerRef"],setup(R){const N=R,k=B(null),u=B(!1),e=le(()=>`https://chart.vps.com.vn/tv/?u=${N.vpsUser}&s=${N.vpsSession}&symbol=VN30F1M&resolution=1&lang=vi`);function r(x){u.value=!u.value,T(),x.stopPropagation()}function T(){if(N.chartContainerRef&&k.value){const{offsetWidth:x,offsetHeight:D}=N.chartContainerRef,{top:l,left:m}=k.value.getBoundingClientRect();k.value.style.top=`${l-2}px`,k.value.style.left=`${m+32}px`,k.value.style.width=`${x-34}px`,k.value.style.height=`${D}px`}}return(x,D)=>(z(),J("div",{class:"tradingview command far fa-chart-candlestick",title:x.$t("trading.derivative.tradingview"),onClick:r},[xe(F("iframe",{ref_key:"tradingviewRef",ref:k,class:"chart",src:e.value},null,8,Ot),[[_e,u.value]])],8,Lt))}};const $t=F("div",{class:"triangle-shadow"},null,-1),It=F("div",{class:"triangle"},null,-1),At={__name:"ProgressContext",props:["progress","chartHeightEnough"],emits:["refreshPattern"],setup(R,{emit:N}){const k=N,u=B([]);Ye(()=>{e()});function e(){vt(Object.assign({"../../../../../lang/vi/derivative.js":()=>ht(()=>import("./derivative-0a1a41d1.js"),[])}),`../../../../../lang/${window.lang}/derivative.js`).then(x=>{u.value=x.default||[]})}function r(){k("refreshPattern")}function T(x){x.stopPropagation()}return(x,D)=>{const l=tt("DxButton");return z(),J("div",{class:oe(["pattern-context",{portrait:R.chartHeightEnough}]),onClick:T},[$t,It,F("div",null,[te(l,{icon:"refresh",type:"success",text:x.$t("trading.derivative.progressContext.refreshPattern"),onClick:r},null,8,["text"])]),F("div",{class:oe(["steps",{portrait:R.chartHeightEnough}])},[(z(!0),J(We,null,Ze(u.value,(m,g)=>(z(),J("div",{key:g,class:oe(["step",[R.progress.step&&R.progress.step===g+1?R.progress.result?"success":"fail":""]])},[F("div",{class:oe(["name",[R.progress.steps?R.progress.steps[g].every(Boolean)?"success":"fail":""]])},Te(g+1)+". "+Te(m.name),3),F("div",null,[(z(!0),J(We,null,Ze(m.conds,(A,M)=>(z(),J("div",{key:M,class:oe(["condition",[R.progress.steps?R.progress.steps[g][M]?"success":"fail":""]])},Te(M+1)+". "+Te(A),3))),128))])],2))),128))],2)],2)}}},Nt=["title"],Bt={__name:"ProgressTool",props:["chartHeightEnough"],emits:["refreshPattern","hideContext"],setup(R,{expose:N,emit:k}){const u=me(),{t:e}=$e(),r=fe("mf"),T=k,x=B({}),D=B(!1),l=le(()=>u.state.tradingDerivative.config.autoRefresh);N({hide:g,set:A});function m(){const p=D.value;T("hideContext"),D.value=!p,D.value&&M()}function g(p=!1){D.value=p}function A(p){l.value&&Z(p,x.value),x.value=p}function M(){T("refreshPattern")}function W(){u.dispatch("tradingDerivative/setAutoRefresh",!l.value)}function Z(p,o){if(r.isSet(p)&&(p.step!==o.step||p.step===o.step&&p.result!==o.result)){let h="";p.result?[2,4].includes(p.step)?h=e("trading.derivative.progressOrder",p):h=e("trading.derivative.progressSuccess",p):h=e("trading.derivative.progressFail",p),I(h)}}function I(p){const o=new SpeechSynthesisUtterance(p);o.lang="vi-VN",speechSynthesis.speak(o)}return(p,o)=>(z(),J("div",{class:oe(["context command",{green:x.value.result===!0,red:x.value.result===!1}]),title:p.$t("trading.derivative.progressTool"),onClick:m,onContextmenu:W},[F("i",{class:oe(["far",{"fa-badge-check":!x.value.step,[`fa-circle-${x.value.step}`]:x.value.step,blink:l.value}])},null,2),xe(te(At,{class:"contextmenu",progress:x.value,chartHeightEnough:R.chartHeightEnough,onRefreshPattern:M},null,8,["progress","chartHeightEnough"]),[[_e,D.value]])],42,Nt))}};var Ce={};const Ft=gt(St);/*!
 * devextreme-vue
 * Version: 22.2.12
 * Build date: Mon Apr 29 2024
 *
 * Copyright (c) 2012 - 2024 Developer Express Inc. ALL RIGHTS RESERVED
 *
 * This software may be modified and distributed under the terms
 * of the MIT license. See the LICENSE file in the root of the project for details.
 *
 * https://github.com/DevExpress/devextreme-vue
 */var Mt=qe&&qe.__importDefault||function(R){return R&&R.__esModule?R:{default:R}};Object.defineProperty(Ce,"__esModule",{value:!0});Ce.DxItem=Ce.DxButtonGroup=void 0;var Vt=Mt(Ft),Wt=it,Zt=it,rt=Wt.createComponent({props:{accessKey:String,activeStateEnabled:Boolean,buttonTemplate:{},disabled:Boolean,elementAttr:Object,focusStateEnabled:Boolean,height:[Function,Number,String],hint:String,hoverStateEnabled:Boolean,items:Array,keyExpr:[Function,String],onContentReady:Function,onDisposing:Function,onInitialized:Function,onItemClick:Function,onOptionChanged:Function,onSelectionChanged:Function,rtlEnabled:Boolean,selectedItemKeys:Array,selectedItems:Array,selectionMode:String,stylingMode:String,tabIndex:Number,visible:Boolean,width:[Function,Number,String]},emits:{"update:isActive":null,"update:hoveredElement":null,"update:accessKey":null,"update:activeStateEnabled":null,"update:buttonTemplate":null,"update:disabled":null,"update:elementAttr":null,"update:focusStateEnabled":null,"update:height":null,"update:hint":null,"update:hoverStateEnabled":null,"update:items":null,"update:keyExpr":null,"update:onContentReady":null,"update:onDisposing":null,"update:onInitialized":null,"update:onItemClick":null,"update:onOptionChanged":null,"update:onSelectionChanged":null,"update:rtlEnabled":null,"update:selectedItemKeys":null,"update:selectedItems":null,"update:selectionMode":null,"update:stylingMode":null,"update:tabIndex":null,"update:visible":null,"update:width":null},computed:{instance:function(){return this.$_instance}},beforeCreate:function(){this.$_WidgetClass=Vt.default,this.$_hasAsyncTemplate=!0,this.$_expectedChildren={item:{isCollectionItem:!0,optionName:"items"}}}});Ce.DxButtonGroup=rt;var He=Zt.createConfigurationComponent({emits:{"update:isActive":null,"update:hoveredElement":null,"update:disabled":null,"update:elementAttr":null,"update:hint":null,"update:html":null,"update:icon":null,"update:template":null,"update:text":null,"update:type":null,"update:visible":null},props:{disabled:Boolean,elementAttr:Object,hint:String,html:String,icon:String,template:{},text:String,type:String,visible:Boolean}});Ce.DxItem=He;He.$_optionName="items";He.$_isCollectionItem=!0;var Yt=Ce.default=rt;const Ht=F("div",{class:"triangle-shadow"},null,-1),zt=F("div",{class:"triangle"},null,-1),Jt={__name:"ScanContext",props:["modelValue"],emits:["update:modelValue"],setup(R,{emit:N}){const{t:k}=$e(),u=[{icon:"chevrondoubleleft",side:"left",text:k("trading.derivative.scanContext.leftScan")},{icon:"chevrondoubleright",side:"right",text:k("trading.derivative.scanContext.rightScan")}],e=R,r=N;function T({itemData:{side:D}}){r("update:modelValue",D)}function x(D){D.stopPropagation()}return(D,l)=>(z(),J("div",{class:"scan-context",onClick:x},[Ht,zt,te(nt(Yt),{items:u,"selected-item-keys":[e.modelValue],"key-expr":"side","styling-mode":"outlined",onItemClick:T},null,8,["selected-item-keys"])]))}},Xt=["title"],jt={__name:"ScanTool",props:["prices","timeToIndex"],emits:["scaned","removePattern","hideContext"],setup(R,{expose:N,emit:k}){const u=fe("mf"),e=R,r=k,T=B(null),x=B(!1),D=B("left");N({isSelected:l,hide:m,draw:M});function l(){return T.value.classList.contains("selected")}function m(){x.value=!1}function g(p){r("hideContext");const o=p.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(h=>h.classList.remove("selected")),o||(p.target.classList.add("selected"),r("removePattern"))}function A(){const p=x.value;r("hideContext"),x.value=!p}function M({time:p}){const o=D.value==="left",h=p?e.prices.filter(c=>!u.cmp(c.time,o,p)):e.prices;let i=o?W(h):Z(h);u.isSet(i)&&r("scaned",I(i)),T.value.classList.remove("selected")}function W(p){let o,[h,i,c,v]=Array(4).fill({});for(let d=p.length-1;d>=0;d--){const P=p[d].value,C=p[d].time,S=e.timeToIndex(C);if(S===-1)break;if(d===p.length-1&&(c={index:S,time:C,price:P},[i,h,v]=Array(3).fill(null).map(()=>u.cloneDeep(c))),o===void 0){if(P===c.price)continue;o=P>c.price}if(u.cmp(P,o,i.price)&&(u.cmp(h.price,!o,c.price)?([c,i]=[i,h].map(s=>u.cloneDeep(s)),h={index:S,time:C,price:P},v=u.cloneDeep(h),o=!o):i={index:S,time:C,price:P}),u.cmp(P,!o,h.price)?(h={index:S,time:C,price:P},v=u.cloneDeep(h)):v.index=S,u.cmp(P,o,v.price)&&(v={index:S,time:C,price:P}),c.index>h.index){const s=u.fmtNum(i.price-c.price,1,!0);if(s>=1&&(h.index-v.index>=2*(c.index-i.index)||u.fmtNum(h.price-v.price,1,!0)>s))break}}return{A:h,B:i,C:c}}function Z(p){let o,[h,i,c]=Array(3).fill({});for(let v=0;v<p.length;v++){const d=p[v].value,P=p[v].time,C=e.timeToIndex(P);if(C===-1)break;if(v===0&&(h={index:C,time:P,price:d},i=u.cloneDeep(h),c=u.cloneDeep(h)),o===void 0){if(d===h.price)continue;o=d>h.price}u.cmp(d,o,i.price)&&(i={index:C,time:P,price:d},c=u.cloneDeep(i)),u.cmp(i.price,o,h.price)&&u.cmp(d,!o,c.price)&&(u.cmp(d,o,h.price)?c={index:C,time:P,price:d}:(h=u.cloneDeep(i),i={index:C,time:P,price:d},c=u.cloneDeep(i),o=!o))}return{A:h,B:i,C:c}}function I(p){const o={};return Object.entries(p).forEach(([h,i])=>{const{index:c,...v}=i;o[h]=v}),o}return(p,o)=>(z(),J("div",{ref_key:"scanToolRef",ref:T,class:"context command",title:p.$t("trading.derivative.scanTool"),onClick:g,onContextmenu:A},[F("i",{class:oe(["far",{[`fa-angles-${D.value}`]:!0}])},null,2),xe(te(Jt,{class:"contextmenu",modelValue:D.value,"onUpdate:modelValue":o[0]||(o[0]=h=>D.value=h)},null,8,["modelValue"]),[[_e,x.value]])],40,Xt))}},Ut=["title"],qt=F("i",{class:"far fa-heart-rate"},null,-1),Qt=[qt],Gt={__name:"PatternTool",props:["prices","priceSeries","timeMarkSeries","pickTimeToolRef","timeToIndex","indexToTime"],emits:["setProgress","hideContext"],setup(R,{expose:N,emit:k}){const u=me(),e=fe("mf"),r=R,T=k,x=B(null),D=le(()=>u.state.tradingDerivative.tools.pattern);let l={},m={};N({isSelected:g,draw:W,load:Z,refresh:p,remove:P,drag:s}),ve(D,t=>{t&&Z(t,{isCheck:!0})});function g(){return x.value.classList.contains("selected")}function A(t){T("hideContext");const n=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(y=>y.classList.remove("selected")),n||(t.target.classList.add("selected"),r.pickTimeToolRef.remove())}function M(t){t.target.classList.remove("selected"),T("hideContext"),P()}function W({time:t,price:n}){let f={lineType:"pattern",price:n,lineWidth:1,lineStyle:1,draggable:!0};if(e.isSet(m.A))if(e.isSet(m.B)){let _,b;if(e.isSet(m.C)){let L,w;l.A={time:t,price:n};const{progress:$,timeMark:V,info:{rEpr1:Y,rEpr2:U,rEpr3:ne,entry:se,pStatus:K,x:re,X:q,y:Q,Y:X}}=o();b=$,_=V,L="A",w={price:n,title:`A ${Y}`},m[L].applyOptions(w),L="B",w={title:`B ${U}`},m[L].applyOptions(w),L="C",w={title:`C ${ne}`},m[L].applyOptions(w),L="D",w={price:se,title:"Entry "+K},m[L].applyOptions(w),L="X",w={price:e.fmtNum(re),title:`X ${e.fmtNum(q)}`},m[L].applyOptions(w),L="Y",w={price:e.fmtNum(Q),title:`Y ${e.fmtNum(X)}`},m[L].applyOptions(w)}else{l.C={price:n};const{progress:L,timeMark:w,info:{rEpr1:$,rEpr2:V,rEpr3:Y,entry:U,pStatus:ne,x:se,X:K,y:re,Y:q}}=o();b=L,_=w;let Q="A";m[Q].applyOptions({title:`A ${$}`}),Q="B",m[Q].applyOptions({title:`B ${V}`}),f.point="C",f.title=`C ${Y}`,f.color="#FFEB3B",m[f.point]=r.priceSeries.createPriceLine(f),f.point="D",f.price=U,f.title="Entry "+ne,f.color="#9C27B0",f.draggable=!1,m[f.point]=r.priceSeries.createPriceLine(f),f.point="Y",f.price=e.fmtNum(re),f.title=`Y ${e.fmtNum(q)}`,f.color="#E91E63",f.draggable=!1,m[f.point]=r.priceSeries.createPriceLine(f),f.point="X",f.price=e.fmtNum(se),f.title=`X ${e.fmtNum(K)}`,f.color="#2196F3",f.draggable=!1,m[f.point]=r.priceSeries.createPriceLine(f)}d(),T("setProgress",b),S(_),x.value.classList.remove("selected")}else f.point="B",f.title="B 0",f.color="#4CAF50",m[f.point]=r.priceSeries.createPriceLine(f),l.B={price:n};else f.point="A",f.title="A 0",f.color="#F44336",m[f.point]=r.priceSeries.createPriceLine(f),l={A:{time:t,price:n}}}function Z(t,{isSave:n=!1,isCheck:y=!1}){l=e.cloneDeep(t),n&&d(),(y?i(l):!0)&&(C(),I())}function I(){let n={lineType:"pattern",lineWidth:1,lineStyle:1,draggable:!0};const{A:y,B:f,C:_}=l,{progress:b,timeMark:L,info:{rEpr1:w,rEpr2:$,rEpr3:V,entry:Y,pStatus:U,x:ne,X:se,y:K,Y:re}}=o();T("setProgress",b),S(L),n.point="A",n.title=`A ${w}`,n.color="#F44336",n.price=y.price,m[n.point]=r.priceSeries.createPriceLine(n),n.point="B",n.title=`B ${$}`,n.color="#4CAF50",n.price=f.price,m[n.point]=r.priceSeries.createPriceLine(n),n.point="C",n.price=_.price,n.title=`C ${V}`,n.color="#FFEB3B",m[n.point]=r.priceSeries.createPriceLine(n),n.point="D",n.price=Y,n.title="Entry "+U,n.color="#9C27B0",n.draggable=!1,m[n.point]=r.priceSeries.createPriceLine(n),n.point="Y",n.price=e.fmtNum(K),n.title=`Y ${e.fmtNum(re)}`,n.color="#E91E63",n.draggable=!1,m[n.point]=r.priceSeries.createPriceLine(n),n.point="X",n.price=e.fmtNum(ne),n.title=`X ${e.fmtNum(se)}`,n.color="#2196F3",n.draggable=!1,m[n.point]=r.priceSeries.createPriceLine(n)}function p(t=!1){e.isSet(m.C)&&(t&&v(),C(),I())}function o(){const{A:t,B:n,C:y}=l,f=n.price-y.price,_=f>0,b=h({phase:1,start:t,end:n,retracementPrice:y.price});let L=h({phase:2,start:b.R,end:y});const w=h({phase:3,start:L.R,end:{price:n.price+(_?1:-1)*b.rEp},breakPrices:[L.S1.price,n.price]});b.xBox.tr>=L.tr&&(L.tr=b.xBox.tr),console.log("calculatePattern",[b,L,w]);const $=e.fmtNum(f,1,!0)>=b.pr,V=e.fmtNum(y.price-w.xBox.R.price,1,!0)>=L.pr,Y=e.fmtNum(w.xBox.pr)>=w.pr,U=!e.cmp(y.price,!_,b.S1.price),ne=!e.cmp(w.xBox.R.price,_,L.S1.price),se=!e.cmp(w.xBox.S.price,!_,w.S1.price),K=b.R.index+b.tr,re=b.R.index+5*b.tr,q=L.R.index+L.tr,Q=w.xBox.R.index+w.tr,X=w.xBox.R.index+5*w.tr,ie=w.xBox.R.index+L.tr,he=[K,re,q,Q,X,ie],ce=w.xBox.S.index;let ge,j={};const be=[L.R.index>K,b.rEpr<3,L.rEpr<b.rEpr];j.steps=[[$||b.rEt<b.tr&&b.rEp>=b.sEp,U,!w.breakIndexs[1]||K<w.breakIndexs[1],ce>K,ce<re],[...be,q>K,ce<X,ce<q],[L.R.index-b.R.index>.5*b.tr,V,!w.breakIndexs[1]||q<w.breakIndexs[1],ce>q],[Y,se,ce>Q,be.every(Boolean)||ce>ie]],j.step=1,j.result=j.steps[0].every(Boolean),ge=b.R1.price,j.result&&(ce<=q?(j.step=2,j.result=j.steps[1].every(Boolean),ge=L.S1.price):(j.step=3,j.result=j.steps[2].every(Boolean),ge=w.R1.price,j.result&&(j.step=4,j.result=j.steps[3].every(Boolean),j.result&&(ge=w.xBox.R.price))));const pe=`${U?$?1:0:2}${ne?V?1:0:2}${se?Y?1:0:2}`,ye=b.rEp,Ae=c(n.price,ye,_),we=w.breakIndexs[1]??ce,De=parseInt((we-b.R.index)/b.tr),Re=De>1?ye*De:ye,Ne=c(n.price,Re,_);return{progress:j,timeMark:he,info:{rEpr1:b.rEpr,rEpr2:L.rEpr,rEpr3:w.rEpr,entry:ge,pStatus:pe,x:Ae,X:ye,y:Ne,Y:Re}}}function h({phase:t,start:n,end:y,breakPrices:f,retracementPrice:_}){let b=e.cloneDeep(n),L=e.cloneDeep(y);const w=L.price>b.price;let $={},V={},Y={},U=[null,null],ne,se,K;const re=r.pickTimeToolRef.get();return r.prices.filter(q=>{let Q=q.time>=b.time;return re&&(Q&=q.time<=re),Q}).every((q,Q)=>{const X=q.value,ie=r.timeToIndex(q.time);return ie===-1?!1:(Q===0&&($={R:{index:ie,price:X},S:{index:ie,price:X},pr:0,tr:0},V=e.cloneDeep($),Y=e.cloneDeep($)),e.cmp(X,w,$.R.price)?($.pr>0&&(($.pr>V.pr||$.pr===V.pr&&$.tr>=V.tr)&&(V.pr=$.pr,V.R=e.cloneDeep($.R),V.S=e.cloneDeep($.S)),$.tr>V.tr&&(V.tr=$.tr),t===1&&_&&!e.cmp($.S.price,!w,_)&&$.tr>=Y.tr&&$.pr>=Y.pr&&(Y=e.cloneDeep($))),$={R:{index:ie,price:X},S:{index:ie,price:X},pr:0,tr:0},t===3&&f&&(!U[0]&&e.cmp(X,w,f[0])&&(U[0]=ie),!U[1]&&e.cmp(X,w,f[1])&&(U[1]=ie))):($.S.index=ie,$.tr=$.S.index-$.R.index,e.cmp(X,!w,$.S.price)&&($.S.price=X,$.pr=e.fmtNum($.S.price-$.R.price,1,!0))),e.cmp(X,!w,b.price)?($.S.price=b.price,!1):!!e.cmp(X,!w,L.price))}),e.isSet($)&&(b.index=r.timeToIndex(b.time),L.index=$.S.index,L.time=r.indexToTime($.S.index),ne=e.fmtNum(L.price-V.R.price,1,!0),se=e.fmtNum(b.price-V.S.price,1,!0),K=L.index-V.S.index,t===3&&(Y=$)),{tr:V.tr,pr:V.pr,rEp:ne,sEp:se,rEpr:V.pr?e.fmtNum(ne/V.pr):0,rEt:K,S1:V.S,R1:V.R,xBox:Y,S:b,R:L,breakIndexs:U}}function i({A:{time:t}}){return t>=r.prices[0].time&&t<r.prices.at(-1).time}function c(t,n,y){const f=t+(y?1:-1)*n;let _=e.fmtNum(f%1);if(y){if(_>=.1&&_<=.2)return Math.floor(f);if(_>=.6&&_<=.7)return Math.floor(f)+.5}else{if(_>=.8&&_<=.9)return Math.ceil(f);if(_>=.3&&_<=.4)return Math.floor(f)+.5}return f}function v(){if(r.pickTimeToolRef.get())return!1;const n=l.B.price-l.A.price>0,y=r.prices.at(-1).value;if(e.cmp(y,!n,l.C.price)){let f=y;for(let _=r.prices.length-1;_>=0;_--){const b=r.prices[_].value;if(b===l.B.price)break;f=n?Math.min(f,b):Math.max(f,b)}l.C.price=f,d()}}function d(t=!1){let n={isRemove:t,name:"pattern",points:[],data:[]};t?l={}:Object.entries(l).forEach(([y,f])=>{n.points.push(y),n.data.push(f)}),u.dispatch("tradingDerivative/drawTools",n)}function P(){d(!0),r.pickTimeToolRef.remove(),C(),T("setProgress",{})}function C(){e.isSet(m.A)&&(r.priceSeries.removePriceLine(m.A),e.isSet(m.B)&&(r.priceSeries.removePriceLine(m.B),e.isSet(m.C)&&(r.priceSeries.removePriceLine(m.C),r.priceSeries.removePriceLine(m.D),r.priceSeries.removePriceLine(m.X),r.priceSeries.removePriceLine(m.Y)))),m={},S([])}function S(t){const n=["#F44336","#F44336","#4CAF50","#FFEB3B","#FFEB3B","#2196F3"];let y=[];for(let f=0;f<t.length;f++){let _=r.indexToTime(t[f]);_&&(t.indexOf(t[f])!==t.lastIndexOf(t[f])&&(_+=f),y.push({time:_,value:1,color:n[f]}))}y.length&&y.sort((f,_)=>f.time-_.time),r.timeMarkSeries.setData(y)}function s({lineOptions:t}){if(e.isSet(m.C)){let n,y;l={A:{time:l.A.time,price:+m.A.options().price},B:{price:+m.B.options().price},C:{price:+m.C.options().price}},d();const{progress:f,timeMark:_,info:{rEpr1:b,rEpr2:L,rEpr3:w,entry:$,pStatus:V,x:Y,X:U,y:ne,Y:se}}=o();T("setProgress",f),S(_),n="A",y={title:`A ${b}`},m[n].applyOptions(y),n="B",y={title:`B ${L}`},m[n].applyOptions(y),n="C",y={title:`C ${w}`},m[n].applyOptions(y),n="D",y={price:$,title:"Entry "+V},t.point===n&&delete y.price,m[n].applyOptions(y),n="X",y={price:e.fmtNum(Y),title:`X ${e.fmtNum(U)}`},m[n].applyOptions(y),n="Y",y={price:e.fmtNum(ne),title:`Y ${e.fmtNum(se)}`},m[n].applyOptions(y)}}return(t,n)=>(z(),J("div",{ref_key:"patternToolRef",ref:x,class:"command",title:t.$t("trading.derivative.patternTool"),onClick:A,onContextmenu:M},Qt,40,Ut))}},Kt=["title"],ei=F("i",{class:"far fa-pipe"},null,-1),ti=[ei],ii={__name:"PickTimeTool",props:["pickTimeSeries"],emits:["refreshPattern","hideContext"],setup(R,{expose:N,emit:k}){const u=me(),e=R,r=k,T=B(null),x=le(()=>u.state.tradingDerivative.tools.pickTime);let D=null;N({isSelected:l,draw:M,remove:Z,get:m}),ve(x,I=>{I&&W(I[0])});function l(){return T.value.classList.contains("selected")}function m(){return D}function g(I){r("hideContext");const p=I.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(o=>o.classList.remove("selected")),p||I.target.classList.add("selected")}function A(I){I.target.classList.remove("selected"),Z(),r("refreshPattern")}function M({time:I}){u.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"pickTime",points:[0],data:[I]}),W(I),r("refreshPattern"),T.value.classList.remove("selected")}function W(I){D=I,e.pickTimeSeries.setData([{time:I,value:1,color:"#9C27B0"}])}function Z(I=!0){I&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"pickTime"}),e.pickTimeSeries.setData([]),D=null}return(I,p)=>(z(),J("div",{ref_key:"pickTimeToolRef",ref:T,class:"command",title:I.$t("trading.derivative.pickTimeTool"),onClick:g,onContextmenu:A},ti,40,Kt))}};const ni=F("div",{class:"triangle-shadow"},null,-1),si=F("div",{class:"triangle"},null,-1),ri={class:"input"},oi={class:"color"},ai=["onClick"],ci={__name:"LineContext",props:["enable","title","color"],emits:["update:title","update:color"],setup(R,{emit:N}){const k=R,u=N,e=B(null),r=B(["#F44336","#FF9800","#FFEB3B","#4CAF50","#009688","#00BCD4","#2196F3","#673AB7","#9C27B0","#E91E63"]);ve(()=>k.enable,m=>{m&&yt().then(()=>e.value.instance.focus())});function T({value:m}){u("update:title",m)}function x(m){u("update:color",m)}function D(){u("deleteAllLine")}function l(m){m.stopPropagation()}return(m,g)=>{const A=tt("DxButton");return z(),J("div",{class:"line-context",onClick:l},[ni,si,F("div",ri,[te(nt(bt),{ref_key:"titleRef",ref:e,value:k.title,"show-clear-button":!0,"input-attr":{style:`color:${k.color}`},onValueChanged:T},null,8,["value","input-attr"]),te(A,{icon:"trash",type:"danger",onClick:g[0]||(g[0]=M=>D())})]),F("div",oi,[(z(!0),J(We,null,Ze(r.value,(M,W)=>(z(),J("div",{class:"color-swatch",style:Tt({background:M,boxShadow:`0 0 4px ${M}`}),key:W,onClick:Z=>x(M)},null,12,ai))),128))])])}}},li=["title"],pi=F("i",{class:"far fa-horizontal-rule"},null,-1),ui={__name:"LineTool",props:["priceSeries"],emits:["hideContext"],setup(R,{expose:N,emit:k}){const u=me(),e=R,r=k,T=B(null),x=B(!1),D=le(()=>u.state.tradingDerivative.tools.line),l=B(""),m=B("#F44336");let g=[];N({isSelected:A,hide:M,draw:I,drag:i}),ve(D,c=>{c&&p(c)});function A(){return T.value.classList.contains("selected")}function M(){x.value=!1}function W(c){r("hideContext");const v=c.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(d=>d.classList.remove("selected")),v||c.target.classList.add("selected")}function Z(c){const v=x.value;r("hideContext"),x.value=!v}function I({price:c}){const v="line",d=g.length;if(g=g.filter(P=>{const C=P.options(),S=C.type=c===+C.price;return S&&(e.priceSeries.removePriceLine(P),u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:v,point:c})),!S}),g.length===d){const P=m.value,C=l.value,S={lineType:v,price:c,color:P,title:C,lineWidth:1,lineStyle:1,draggable:!0};g.push(e.priceSeries.createPriceLine(S)),u.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:v,points:[c],data:[{color:P,title:C}]})}T.value.classList.remove("selected")}function p(c){h(!1),o(c)}function o(c){const d={lineType:"line",lineWidth:1,lineStyle:1,draggable:!0};Object.entries(c).forEach(([P,{color:C,title:S}])=>{d.price=+P,d.color=C,d.title=S,g.push(e.priceSeries.createPriceLine(d))})}function h(c=!0){g.length>0&&(c&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line"}),g.forEach(v=>e.priceSeries.removePriceLine(v)),g=[])}function i({lineOptions:c,oldPrice:v,newPrice:d}){u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line",point:v});const P=c.color,C=c.title;u.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"line",points:[d],data:[{color:P,title:C}]}),T.value.classList.remove("selected")}return(c,v)=>(z(),J("div",{ref_key:"lineToolRef",ref:T,class:"context command",title:c.$t("trading.derivative.lineTool"),onClick:W,onContextmenu:Z},[pi,xe(te(ci,{class:"contextmenu",enable:x.value,title:l.value,"onUpdate:title":v[0]||(v[0]=d=>l.value=d),color:m.value,"onUpdate:color":v[1]||(v[1]=d=>m.value=d),onDeleteAllLine:h},null,8,["enable","title","color"]),[[_e,x.value]])],40,li))}},di=["title"],fi=F("i",{class:"far fa-grip-lines-vertical"},null,-1),mi=[fi],vi={__name:"TimeRangeTool",props:["timeRangeSeries","timeToIndex","indexToTime"],emits:["hideContext"],setup(R,{expose:N,emit:k}){const u=me(),e=fe("mf"),r=R,T=k,x=B(null),D=le(()=>u.state.tradingDerivative.tools.timeRange);let l=[];N({isSelected:m,draw:M}),ve(D,p=>{p&&W(p)});function m(){return x.value.classList.contains("selected")}function g(p){T("hideContext");const o=p.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(h=>h.classList.remove("selected")),o||p.target.classList.add("selected")}function A(p){I(),p.target.classList.remove("selected")}function M({time:p}){let o={isRemove:!1,name:"timeRange",points:[],data:[]},h={time:p,value:1};switch(l.length){case 0:h.color="OrangeRed",l[0]=h,o.points.push(0),o.data.push(p);break;case 1:h.color="lime",l[1]=h,o.points.push(1),o.data.push(p),x.value.classList.remove("selected");break;default:const i=r.timeToIndex(l[0].time),c=r.timeToIndex(l[1].time),d=r.timeToIndex(p)+(c-i),P=r.indexToTime(d);h.color="OrangeRed",l[0]=e.cloneDeep(h),o.points.push(0),o.data.push(p),h.time=P,h.color="lime",l[1]=h,o.points.push(1),o.data.push(P),x.value.classList.remove("selected");break}r.timeRangeSeries.setData(l),u.dispatch("tradingDerivative/drawTools",o)}function W(p){I(!1),Z(p)}function Z(p){let o,h;if(p.length===2)o=p[0],h=p[1];else if(p.length===3){const c=r.timeToIndex(p[0]),v=r.timeToIndex(p[1]),P=r.timeToIndex(p[2])+(v-c);o=p[2],h=r.indexToTime(P)}else return!1;let i=[{time:o,value:1,color:"OrangeRed"},{time:h,value:1,color:"lime"}];l=i,r.timeRangeSeries.setData(i)}function I(p=!0){p&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"timeRange"}),r.timeRangeSeries.setData([]),l=[]}return(p,o)=>(z(),J("div",{ref_key:"timeRangeToolRef",ref:x,class:"command",title:p.$t("trading.derivative.timeRangeTool"),onClick:g,onContextmenu:A},mi,40,di))}},hi=["title"],gi=F("i",{class:"far fa-line-height"},null,-1),Si=[gi],yi={__name:"TargetTool",props:["priceSeries"],emits:["hideContext"],setup(R,{expose:N,emit:k}){const u=me(),e=fe("mf"),r=R,T=k,x=B(null),D=le(()=>u.state.tradingDerivative.tools.target);let l={};N({isSelected:m,draw:M,drag:p}),ve(D,o=>{o&&W(o)});function m(){return x.value.classList.contains("selected")}function g(o){T("hideContext");const h=o.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),h||(o.target.classList.add("selected"),I())}function A(o){I(),o.target.classList.remove("selected")}function M({price:o}){const h="target";let i={lineType:h,price:o,lineWidth:1,lineStyle:1,draggable:!0},c={isRemove:!1,name:h,points:[],data:[o]};if(e.isSet(l.A)){const v=+l.A.options().price,d=o-v;i.point="B",i.title=e.fmtNum(d),i.color="#F44336",l[i.point]=r.priceSeries.createPriceLine(i),c.points.push(i.point),i.point="X",i.price=e.fmtNum(v-.5*d),i.title=e.fmtNum(-.5*d),i.color="#2196F3",l[i.point]=r.priceSeries.createPriceLine(i),i.point="Y",i.price=e.fmtNum(v-d),i.title=e.fmtNum(-d),i.color="#673AB7",l[i.point]=r.priceSeries.createPriceLine(i),i.point="Z",i.price=e.fmtNum(v-2*d),i.title=e.fmtNum(-2*d),i.color="#9C27B0",l[i.point]=r.priceSeries.createPriceLine(i),i.point="W",i.price=e.fmtNum(v-4*d),i.title=e.fmtNum(-4*d),i.color="#E91E63",l[i.point]=r.priceSeries.createPriceLine(i),x.value.classList.remove("selected")}else i.point="A",i.title="0",i.color="#FF9800",l[i.point]=r.priceSeries.createPriceLine(i),c.points.push(i.point);u.dispatch("tradingDerivative/drawTools",c)}function W(o){I(!1),Z(o)}function Z(o){let i={lineType:"target",lineWidth:1,lineStyle:1,draggable:!0};const c=o.A,v=o.B,d=v-c;i.point="A",i.price=c,i.title="0",i.color="#FF9800",l[i.point]=r.priceSeries.createPriceLine(i),i.point="B",i.price=v,i.title=e.fmtNum(d),i.color="#F44336",l[i.point]=r.priceSeries.createPriceLine(i),i.point="X",i.price=e.fmtNum(c-.5*d),i.title=e.fmtNum(-.5*d),i.color="#2196F3",l[i.point]=r.priceSeries.createPriceLine(i),i.point="Y",i.price=e.fmtNum(c-d),i.title=e.fmtNum(-d),i.color="#673AB7",l[i.point]=r.priceSeries.createPriceLine(i),i.point="Z",i.price=e.fmtNum(c-2*d),i.title=e.fmtNum(-2*d),i.color="#9C27B0",l[i.point]=r.priceSeries.createPriceLine(i),i.point="W",i.price=e.fmtNum(c-4*d),i.title=e.fmtNum(-4*d),i.color="#E91E63",l[i.point]=r.priceSeries.createPriceLine(i)}function I(o=!0){o&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"target"}),e.isSet(l.A)&&(r.priceSeries.removePriceLine(l.A),e.isSet(l.B)&&(r.priceSeries.removePriceLine(l.B),r.priceSeries.removePriceLine(l.X),r.priceSeries.removePriceLine(l.Y),r.priceSeries.removePriceLine(l.Z),r.priceSeries.removePriceLine(l.W))),l={}}function p({lineOptions:o,newPrice:h}){if(e.isSet(l.B)){let i={isRemove:!1,name:"target",points:[],data:[]},c,v,d=+l.A.options().price,P=+l.B.options().price,C=P-d;if(c="A",o.point==="A")C=+l.B.options().title,P=d+C;else if(o.point!=="B"){let S=0;switch(o.point){case"X":S=1.5;break;case"Y":S=2;break;case"Z":S=3;break;case"W":S=5;break}C=e.fmtNum((P-h)/S),d=P-C,v={price:d},l[c].applyOptions(v)}i.points.push(c),i.data.push(d),c="B",v={price:P,title:e.fmtNum(C)},o.point===c&&delete v.price,l[c].applyOptions(v),i.points.push(c),i.data.push(P),c="X",v={price:e.fmtNum(d-.5*C),title:e.fmtNum(-.5*C)},o.point===c&&delete v.price,l[c].applyOptions(v),c="Y",v={price:e.fmtNum(d-C),title:e.fmtNum(-C)},o.point===c&&delete v.price,l[c].applyOptions(v),c="Z",v={price:e.fmtNum(d-2*C),title:e.fmtNum(-2*C)},o.point===c&&delete v.price,l[c].applyOptions(v),c="W",v={price:e.fmtNum(d-4*C),title:e.fmtNum(-4*C)},o.point===c&&delete v.price,l[c].applyOptions(v),u.dispatch("tradingDerivative/drawTools",i)}}return(o,h)=>(z(),J("div",{ref_key:"targetToolRef",ref:x,class:"command",title:o.$t("trading.derivative.targetTool"),onClick:g,onContextmenu:A},Si,40,hi))}},Ti=["title"],Ge=3,Ke=2,xi={__name:"OrderTool",props:["position","prices","priceSeries","inSession","TIME"],emits:["getTools","showEntry","showTpSl","orderChanged","hideContext"],setup(R,{expose:N,emit:k}){const u=me(),{t:e}=$e(),r=fe("mf"),T=R,x=k,D=B(null),l=B(!1),m=le(()=>u.state.tradingDerivative.tools.order);let g={},A={},M=!1;N({show:Z,entry:I,tpsl:p,cancel:o,cancelWithoutClose:h,scan:i,drag:P}),ve(m,S=>{S&&v(S)});function W(){return r.isSet(A.entry)||r.isSet(A.tp)}function Z({price:S}){if(S&&T.inSession()){const s=G(ke(new Date,7));if(r.isSet(A.entry))!r.isSet(A.tp)&&T.position&&s>T.TIME.ATO&&s<T.TIME.ATC&&x("showTpSl",{side:T.position});else{let t=null,n=0;T.position?(s<T.TIME.ATO?t="ATO":s>T.TIME.ATC&&(t="ATC"),t&&(g.entry=t,n=-T.position)):s>T.TIME.ATO&&s<T.TIME.ATC&&(t=S,n=t>=T.prices.at(-1).value?1:-1,g.side=n,g.entry=t),n&&x("showEntry",{side:n,price:t})}}}function I(){if(T.inSession()){const S=G(ke(new Date,7));S<T.TIME.ATO?Qe(e("trading.derivative.atoOrder"),e("titles.confirm")).then(t=>{t&&u.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(n=>{n.isOk?ae.success(e("trading.derivative.atoOrderSuccess")):C(n.message)})}):S>T.TIME.ATC?Qe(e("trading.derivative.atcOrder"),e("titles.confirm")).then(t=>{t&&u.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(n=>{n.isOk?ae.success(e("trading.derivative.atcOrderSuccess")):C(n.message)})}):u.dispatch("tradingDerivative/executeOrder",{action:"entry",entryData:{cmd:"new",side:g.side,price:g.entry}}).then(s=>{s.isOk?(c(["entry"]),ae.success(e("trading.derivative.newEntrySuccess"))):C(s.message)})}}function p(){g.tp=g.entry+g.side*Ge,g.sl=g.entry-g.side*Ke,u.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:g.tp},slData:{cmd:"new",price:g.sl}}).then(S=>{S.isOk?(A.entry.applyOptions({draggable:!1}),c(["tp","sl"]),ae.success(e("trading.derivative.newTpSlSuccess"))):C(S.message)})}function o(){r.isSet(A.entry)?r.isSet(A.tp)?u.dispatch("tradingDerivative/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(S=>{S.isOk?(d(["entry","tp","sl"]),ae.success(e("trading.derivative.exitSuccess"))):C(S.message)}):u.dispatch("tradingDerivative/executeOrder",{action:"entry",entryData:{cmd:"delete"}}).then(S=>{S.isOk?(d(["entry"]),ae.success(e("trading.derivative.deleteEntrySuccess"))):C(S.message)}):x("getTools")}function h(){if(T.inSession()&&T.position){const S=G(ke(new Date,7));S>T.TIME.ATC-5*60&&(l.value=!0,S>T.TIME.ATC-15&&r.isSet(A.tp)&&u.dispatch("tradingDerivative/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(s=>{s.isOk?(d(["entry","tp","sl"]),ae.success(e("trading.derivative.autoCancelTpSlSuccess"))):C(s.message)}))}}function i(S){if(r.isSet(A.entry)){const s=g.side>0;r.isSet(A.tp)?(r.cmp(S,s,g.tp,!0)&&(M||(M=!0,u.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"delete"}}).then(t=>{t.isOk?(d(["entry","tp","sl"]),ae.success(e("trading.derivative.deleteTpSuccess"))):C(t.message),M=!1}))),r.cmp(S,!s,g.sl,!0)&&(M||(M=!0,u.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"cancel"}}).then(t=>{t.isOk?(d(["entry","tp","sl"]),ae.success(e("trading.derivative.deleteSlSuccess"))):C(t.message),M=!1})))):r.cmp(S,s,g.entry,!0)&&(M||(M=!0,setTimeout(()=>{g.tp=g.entry+g.side*Ge,g.sl=g.entry-g.side*Ke,u.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:g.tp},slData:{cmd:"new",price:g.sl}}).then(t=>{t.isOk?(A.entry.applyOptions({draggable:!1}),c(["tp","sl"]),ae.success(e("trading.derivative.autoNewTpSlSuccess"))):C(t.message),M=!1})},1e3)))}}function c(S,s=!0){const t="order";let n={isRemove:!1,name:t,points:[],data:[]},y,f;S.forEach(_=>{switch(_){case"entry":y="yellow",f=g.side>0?"LONG":"SHORT";break;case"tp":y="lime",f=r.fmtNum(g.tp-g.entry,1,!0);break;case"sl":y="red",f=r.fmtNum(g.sl-g.entry,1,!0);break}if(r.isSet(A[_]))A[_].applyOptions({price:g[_],title:f}),n.points.push(_),n.data.push(g[_]);else{const b={lineType:t,kind:_,side:g.side,price:g[_],color:y,lineWidth:1,lineStyle:0,title:f,draggable:!(_==="entry"&&g.tp)};A[_]=T.priceSeries.createPriceLine(b),_==="entry"&&(n.points.push("side"),n.data.push(g.side)),n.points.push(_),n.data.push(g[_])}}),s&&u.dispatch("tradingDerivative/drawTools",n),x("orderChanged",W())}function v(S){g=r.cloneDeep(S);let s=["entry"];"tp"in g&&s.push("tp","sl"),d(["entry","tp","sl"],!1),c(s,!1),x("orderChanged",W())}function d(S,s=!0){s&&u.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"order"}),S.forEach(t=>{r.isSet(A[t])&&(T.priceSeries.removePriceLine(A[t]),delete A[t])}),x("orderChanged",W())}function P({line:S,lineOptions:s,oldPrice:t,newPrice:n}){if(n!==t){const y=s.kind;if(y!=="entry"||!T.position){const _=`${y}Data`,b=`change${y[0].toUpperCase()}${y.slice(1)}Success`;u.dispatch("tradingDerivative/executeOrder",{action:y,[_]:{cmd:"change",price:n}}).then(L=>{L.isOk?(g[y]=n,c([y]),ae.success(e(`trading.derivative.${b}`))):(S.applyOptions({price:t}),C(L.message))})}else S.applyOptions({price:t}),ae.show(e("trading.derivative.noChangeOrderLine"))}}function C(S){S||(S="unknown"),ae.error(e(`trading.derivative.${S}`))}return(S,s)=>(z(),J("div",{ref_key:"orderToolRef",ref:D,class:"cancel-order command",title:S.$t("trading.derivative.orderTool"),onClick:o},[F("i",{class:oe(["far fa-trash-alt",{blink:l.value}])},null,2)],8,Ti))}};const Ci=["title"],ki=["title"],_i=["title"],bi=["title"],wi="wss://tradestation.fireant.vn/quote?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",Di="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",Pi={__name:"Chart",setup(R,{expose:N}){const k=me(),u=kt(),{t:e}=$e(),r=fe("devices"),T=fe("mf"),x=fe("filters"),D=B(null),l=B(null),m=B(null),g=B(null),A=B(null),M=B(null),W=B(null),Z=B(null),I=B(null),p=B(null),o=B(null),h=B(null),i=B(null),c=B(null),v=B(null),d=B(null),P={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.25,bottom:.25}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:1e3,minBarSpacing:.01,barSpacing:.05}},C=Pe(new Date,"yyyy-MM-dd"),S={START:G(new Date(`${C}T08:45:00Z`)),ATO:G(new Date(`${C}T09:00:00Z`)),ATC:G(new Date(`${C}T14:30:00Z`)),END:G(new Date(`${C}T14:45:00Z`))};let s={chart:{},whitespaces:[],crosshair:{},interval:null,refreshAt:Ve(new Date,11),statusAt:Ve(new Date,21),websocket:null,socketStop:!1,vpsUpdatedAt:Ve(new Date,61)};const t=xt({prices:[],series:{},chartDate:u.query.date??C,clock:Pe(new Date,"HH:mm:ss"),chartHeightEnough:!1,isSocketWarning:!1,hasOrderLine:!1,TIME:S}),n=le(()=>k.state.tradingDerivative.status),y=le(()=>k.state.tradingDerivative.config),f=le(()=>k.state.tradingDerivative.isLoading),_=le(()=>n.value.position||n.value.pending||t.hasOrderLine);s.interval=setInterval(()=>{t.clock=Pe(new Date,"HH:mm:ss"),Ee()&&(c.value&&c.value.cancelWithoutClose(),Me(new Date,new Date(s.refreshAt))>10&&(y.value.autoRefresh&&I.value.refresh(!0),s.refreshAt=new Date),Me(new Date,new Date(s.statusAt))>20&&(Xe(),s.statusAt=new Date))},1e3),pt(),Ye(()=>{K(),b(),new ResizeObserver(se).observe(D.value),document.addEventListener("keydown",re),A.value.toggleFullscreen({set:!0})}),et(()=>{L(),document.removeEventListener("keydown",re),clearInterval(s.interval),ce(),s.socketStop=!0,A.value.toggleFullscreen({unset:!0})}),ve(()=>k.state.tradingDerivative.chartData,q),N({connectSocket:he});function b(){s.chart=wt(l.value,P),s.chart.subscribeCrosshairMove(U),s.chart.subscribeCustomPriceLineDragged(ne),t.series.whitespace=s.chart.addHistogramSeries({priceScaleId:"whitespace",scaleMargins:{top:0,bottom:0},color:"#808080",lastValueVisible:!1,priceLineVisible:!1}),t.series.timeRange=s.chart.addHistogramSeries({priceScaleId:"timeRange",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),t.series.pickTime=s.chart.addHistogramSeries({priceScaleId:"pickTime",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),t.series.timeMark=s.chart.addHistogramSeries({priceScaleId:"timeMark",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),t.series.price=s.chart.addLineSeries({color:"#F5F5F5",priceFormat:{minMove:.1}})}function L(){s.chart&&(s.chart.remove(),s.chart=null)}function w(a){pe(),we(!1),Z.value.isSelected()?Z.value.draw({time:s.crosshair.time}):I.value.isSelected()?I.value.draw({time:s.crosshair.time,price:Oe(s.crosshair.y)}):p.value.isSelected()?p.value.draw({time:s.crosshair.time}):o.value.isSelected()?o.value.draw({price:Oe(s.crosshair.y)}):h.value.isSelected()?h.value.draw({time:s.crosshair.time}):i.value.isSelected()&&i.value.draw({price:Oe(s.crosshair.y)})}function $(a){we(!0),a.preventDefault()}function V(a){a.stopPropagation()}function Y(a){a.preventDefault(),a.stopPropagation()}function U(a){if(a.time){let O=a.seriesPrices.get(t.series.price);s.crosshair.time=a.time,s.crosshair.price=O}else r.phone||(s.crosshair.time=null,s.crosshair.price=null);a.point!==void 0&&(s.crosshair.x=a.point.x,s.crosshair.y=a.point.y)}function ne(a){let O=a.customPriceLine,E=O.options();E.price=T.fmtNum(E.price);const H=+a.fromPriceString,ee=E.price;switch(E.lineType){case"order":c.value.drag({line:O,lineOptions:E,oldPrice:H,newPrice:ee});break;case"line":o.value.drag({lineOptions:E,oldPrice:H,newPrice:ee});break;case"target":i.value.drag({lineOptions:E,newPrice:ee});break;case"pattern":I.value.drag({lineOptions:E});break}}function se(){D.value&&(K(),s.chart.resize(D.value.offsetWidth,D.value.offsetHeight),D.value.classList.contains("fullscreen")&&A.value.setFullscreen())}function K(){t.chartHeightEnough=D.value.offsetHeight>700}function re(a){if(a.ctrlKey)switch(a.keyCode){case 219:s.chart.timeScale().applyOptions({barSpacing:s.chart.options().timeScale.barSpacing-.01});break;case 221:s.chart.timeScale().applyOptions({barSpacing:s.chart.options().timeScale.barSpacing+.01});break}if(a.altKey)switch(a.keyCode){case 219:s.chart.timeScale().scrollToPosition(s.chart.timeScale().scrollPosition()-50);break;case 221:s.chart.timeScale().scrollToPosition(s.chart.timeScale().scrollPosition()+50);break}}function q(a){t.chartDate===C&&Ee()||(a.price.length>0&&(s.whitespaces=ie(s.whitespaces,X(t.chartDate))),t.series.whitespace.setData(s.whitespaces),t.prices=ie(t.prices,a.price),t.series.price.setData(t.prices))}function Q(a,O=null){const E=O??y.value.source;let H=[];a.forEach(ee=>{let ue,de;E==="FireAnt"?(ue=G(ke(new Date(ee.date),7)),de=ee.price):(ue=G(new Date(`${C}T${ee.time}Z`)),de=ee.lastPrice),H.push({time:ue,value:de})}),H.length>1?(t.prices=ie(t.prices,H),t.series.price.setData(t.prices)):(t.prices.push(H[0]),t.series.price.update(H[0]))}function X(a){const O=G(new Date(`${a}T09:00:00Z`)),E=G(new Date(`${a}T11:30:00Z`)),H=G(new Date(`${a}T13:00:00Z`)),ee=G(new Date(`${a}T14:30:00Z`)),ue=G(new Date(`${a}T14:00:00Z`));let de=[];for(let Se=O;Se<=ee;Se++){if(Se>E&&Se<H)continue;let Ue={time:Se};(Se===ue||Se===ee)&&(Ue.value=1),de.push(Ue)}return de}function ie(a,O){return Array.from(new Map([...a,...O].sort((E,H)=>E.time-H.time).map(E=>[E.time,E])).values())}async function he(){if(Ee()){await ce();const a=y.value.source==="FireAnt",O=a?wi:Di;s.websocket=new WebSocket(O),s.websocket.onclose=E=>{s.socketStop||(t.isSocketWarning=!0,he())},a?ge():(ze(),be())}}async function ce(){s.websocket&&s.websocket.readyState===WebSocket.OPEN&&(s.websocket.close(),await new Promise(a=>{const O=setInterval(()=>{(!s.websocket||s.websocket.readyState===WebSocket.CLOSED)&&(s.websocket=null,clearInterval(O),a())},100)}))}function ge(){k.dispatch("tradingDerivative/setLoading",!0),s.websocket.onopen=a=>{if(s.websocket.readyState===WebSocket.OPEN){let O='{"protocol":"json","version":1}';s.websocket.send(O),O='{"arguments":["VN30F1M"],"invocationId":"0","target":"SubscribeTrades","type":1}',s.websocket.send(O)}},s.websocket.onmessage=a=>{t.isSocketWarning=!1,j(a.data).forEach(E=>{if(!E)return!1;E.type===3?(E.result[0].date.slice(0,10)===C&&(Le(),s.whitespaces=ie(s.whitespaces,X(C)),t.series.whitespace.setData(s.whitespaces),Q(E.result)),k.dispatch("tradingDerivative/setLoading",!1)):E.type===1&&E.target==="UpdateTrades"&&E.arguments[0]==="VN30F1M"&&(console.log("FireAnt",E.arguments[1]),c.value.scan(E.arguments[1].at(-1).price),Q(E.arguments[1]))})}}function j(a){let O=[];return a.split("").forEach(E=>{const H=E.indexOf("{"),ee=E.lastIndexOf("}");let ue=null;if(H!==-1&&ee!==-1&&ee>H){const de=E.substring(H,ee+1);de!=="{}"&&(ue=JSON.parse(de))}O.push(ue)}),O}function be(){s.websocket.onopen=a=>{if(s.websocket.readyState===WebSocket.OPEN){const O={action:"join",list:y.value.vn30f1m},E=`42${JSON.stringify(["regs",JSON.stringify(O)])}`;s.websocket.send(E)}},s.websocket.onmessage=a=>{if(t.isSocketWarning=!1,a.data.substr(0,1)==="4"&&a.data.substr(1,1)==="2"){const O=JSON.parse(a.data.substr(2));if(O[0]==="stockps"){const E=O[1].data;E.id===3220&&(console.log("VPS",E),c.value.scan(E.lastPrice),Q([E]))}}}}function ze(){Me(new Date,new Date(s.vpsUpdatedAt))>60&&(fetch("https://bddatafeed.vps.com.vn/getpschartintraday/VN30F1M").then(a=>a.json()).then(a=>{console.log(a),Q(a,"VPS")}),s.vpsUpdatedAt=new Date)}function Ie(){I.value.refresh()}function Je(a){I.value.load(a,{isSave:!0})}function pe(){W.value.hide(),Z.value.hide(),o.value.hide()}function ye(a){r.phone||W.value.hide(T.isSet(a)),W.value.set(a)}function Ae(a){t.hasOrderLine=a}function we(a){a?c.value.show({price:Oe(s.crosshair.y)}):(v.value.style.display="none",d.value.style.display="none")}function De({side:a,price:O}){v.value.style.left=+(s.crosshair.x+(s.crosshair.x>innerWidth-71?-71:1))+"px",v.value.style.top=+(s.crosshair.y+(s.crosshair.y>innerHeight-61?-61:1))+"px",v.value.style.background=a>0?"green":"red",v.value.innerText=`${a>0?"LONG":"SHORT"} ${O}`,v.value.style.display="block"}function Re({side:a}){d.value.style.left=+(s.crosshair.x+(s.crosshair.x>innerWidth-61?-61:1))+"px",d.value.style.top=+(s.crosshair.y+(s.crosshair.y>innerHeight-51?-51:1))+"px",d.value.style.background=a>0?"green":"red",d.value.style.display="block"}function Ne(){c.value.entry()}function ot(){c.value.tpsl()}function at(){s.chart.timeScale().scrollToRealTime()}function Ee(){const a=G(ke(new Date,7));return y.value.openingMarket&&a>=S.START&&a<=S.END}function ct(){if(!t.chartDate)return!1;Be()}function lt(){s.whitespaces=[],t.prices=[],he(),Be()}function pt(){k.dispatch("tradingDerivative/initChart").then(()=>{he(),!u.query.date&&y.value.lastOpeningDate&&(t.chartDate=y.value.lastOpeningDate),Be()})}function Be(){k.dispatch("tradingDerivative/getChartData",t.chartDate).then(a=>{a&&Le()})}function Xe(){k.dispatch("tradingDerivative/getStatus")}function Le(){k.dispatch("tradingDerivative/getTools")}function ut(){k.dispatch("tradingDerivative/getAccountInfo").then(a=>{let O="";O+='<div style="width: 200px;">',O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.nav")}</div><div>: ${x.currency(a.nav)}</div></div>`,O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.maxVol")}</div><div>: ${x.numberVnFormat(a.maxVol)}</div></div>`,O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.vm")}</div><div>: ${x.currency(a.vm)}</div></div>`,O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.fee")}</div><div>: ${x.currency(a.fee)}</div></div>`,O+="</div>",_t(O,e("trading.derivative.accountInfo"))})}function Oe(a){return T.fmtNum(t.series.price.coordinateToPrice(a))}function Fe(a){let O=s.whitespaces.findIndex(E=>E.time===a);if(O===-1){const E=Pe(new Date(a*1e3),"yyyy-MM-dd"),H=G(new Date(`${E}T11:30:00Z`)),ee=G(new Date(`${E}T13:00:00Z`)),ue=G(new Date(`${E}T14:30:00Z`));a>H&&a<ee?a=H:a>ue&&(a=ue),O=s.whitespaces.findIndex(de=>de.time===a)}return O}function je(a){return a<s.whitespaces.length?s.whitespaces[a].time:!1}return(a,O)=>(z(),J("div",{class:"derivative-chart",ref_key:"chartContainerRef",ref:D,onClick:w,onContextmenu:$},[F("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:l},[F("div",{class:"area data-area",onClick:V,onContextmenu:Y},[F("div",{ref_key:"connectionRef",ref:m,class:oe(["command",{yellow:n.value.pending,red:y.value.volInvalid}]),title:a.$t("trading.derivative.connection"),onClick:Xe},[F("i",{class:oe(["far",{"fa-link-simple":n.value.connection,"fa-link-simple-slash":!n.value.connection,blink:t.isSocketWarning}])},null,2)],10,Ci),F("div",{class:oe(["command status",{green:n.value.position>0,red:n.value.position<0}]),title:a.$t("trading.derivative.position"),onClick:ut},Te(n.value.position),11,ki),F("div",{class:"command clock",onClick:he},Te(t.clock),1),xe(F("input",{type:"date",class:"chart-date command",title:a.$t("trading.derivative.date"),"onUpdate:modelValue":O[0]||(O[0]=E=>t.chartDate=E),onChange:ct},null,40,_i),[[Ct,t.chartDate]]),F("div",{ref_key:"reloadToolRef",ref:g,class:"command",title:a.$t("trading.derivative.reload"),onClick:lt,onContextmenu:Le},[F("i",{class:oe(["far fa-sync-alt",{"fa-spin":f.value}])},null,2)],40,bi)],32),F("div",{class:"area tool-area",onClick:V,onContextmenu:Y},[te(Et,{ref_key:"fullscreenToolRef",ref:A,chartContainerRef:D.value},null,8,["chartContainerRef"]),te(Pt,{ref_key:"tradingviewToolRef",ref:M,vpsUser:y.value.vpsUser,vpsSession:y.value.vpsSession,chartContainerRef:D.value},null,8,["vpsUser","vpsSession","chartContainerRef"]),te(Bt,{ref_key:"progressToolRef",ref:W,chartHeightEnough:t.chartHeightEnough,onRefreshPattern:Ie,onHideContext:pe},null,8,["chartHeightEnough"]),te(jt,{ref_key:"scanToolRef",ref:Z,prices:t.prices,timeToIndex:Fe,onScaned:Je,onRemovePattern:O[1]||(O[1]=()=>I.value.remove()),onHideContext:pe},null,8,["prices"]),te(Gt,{ref_key:"patternToolRef",ref:I,prices:t.prices,priceSeries:t.series.price,timeMarkSeries:t.series.timeMark,pickTimeToolRef:p.value,timeToIndex:Fe,indexToTime:je,onSetProgress:ye,onHideContext:pe},null,8,["prices","priceSeries","timeMarkSeries","pickTimeToolRef"]),te(ii,{ref_key:"pickTimeToolRef",ref:p,pickTimeSeries:t.series.pickTime,onRefreshPattern:Ie,onHideContext:pe},null,8,["pickTimeSeries"]),te(ui,{ref_key:"lineToolRef",ref:o,priceSeries:t.series.price,onHideContext:pe},null,8,["priceSeries"]),te(vi,{ref_key:"timeRangeToolRef",ref:h,timeRangeSeries:t.series.timeRange,timeToIndex:Fe,indexToTime:je,onHideContext:pe},null,8,["timeRangeSeries"]),te(yi,{ref_key:"targetToolRef",ref:i,priceSeries:t.series.price,onHideContext:pe},null,8,["priceSeries"]),xe(te(xi,{ref_key:"orderToolRef",ref:c,position:n.value.position,prices:t.prices,priceSeries:t.series.price,inSession:Ee,TIME:t.TIME,onGetTools:Le,onShowEntry:De,onShowTpSl:Re,onOrderChanged:Ae,onHideContext:pe},null,8,["position","prices","priceSeries","TIME"]),[[_e,_.value]])],32),F("div",null,[F("div",{ref_key:"entryOrderRef",ref:v,class:"order-button entry",onClick:Ne}," Entry ",512),F("div",{ref_key:"tpslOrderRef",ref:d,class:"order-button tpsl",onClick:ot}," TP/SL ",512),F("div",{class:"chart-top command far fa-angle-double-right",onClick:at})])],512)],544))}};export{Pi as default};
