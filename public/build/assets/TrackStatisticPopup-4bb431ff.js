import{u as I,c as G,i as p,r as C,d as H,e as j,w as X,f as P,n as U,k as r,_ as K,o as L,j as e,l as i,m as Q,D as l}from"./app-7b233b13.js";const Z={__name:"TrackStatisticPopup",setup(W,{expose:k}){const m=I(),{t:s}=G(),V=p("bus"),u=p("mt"),F=p("mc"),T=p("mf"),_=p("filters"),R=C(null),v=C(null),a=H({gridData:null,editPermission:"trades@edit",validationRules:{symbol:[{type:"required",message:s("trading.statistic.symbol")+u.validations.required}],buyDate:[{type:"required",message:s("trading.statistic.date")+u.validations.required}],buyVolume:[{type:"required",message:s("trading.statistic.volume")+u.validations.required},{type:"custom",validationCallback:d,message:s("trading.statistic.validations.array")}],buyPrice:[{type:"required",message:s("trading.statistic.price")+u.validations.required},{type:"custom",validationCallback:d,message:s("trading.statistic.validations.array")}],buyFee:[{type:"required",message:s("trading.statistic.fee")+u.validations.required},{type:"custom",validationCallback:d,message:s("trading.statistic.validations.array")}],sellDate:[{type:"custom",validationCallback:M,message:s("trading.statistic.validations.sellDate")}],sellVolume:[{type:"custom",validationCallback:d,message:s("trading.statistic.validations.array")}],sellPrice:[{type:"custom",validationCallback:d,message:s("trading.statistic.validations.array")}],sellFee:[{type:"custom",validationCallback:d,message:s("trading.statistic.validations.array")}]}}),g=j(()=>m.state.auth.user.permissions);X(()=>m.state.tradingStatistic.data,t=>{a.gridData=T.cloneDeep(t)});function q(){R.value.show()}function A(t){t.changes.length&&V.emit("checkPin",()=>m.dispatch("tradingStatistic/save",t))}function E(t){t.data.buy_date=moment().format(F.SERVER_DATE_FORMAT),t.data.buy_volume="[]",t.data.buy_price="[]",t.data.buy_fee="[]",t.data.sell_volume="[]",t.data.sell_price="[]",t.data.sell_fee="[]"}function M(t){return t.value?moment(t.value).isAfter(moment(t.data.buy_date)):!0}function d(t){return/^\[.*\]$/.test(t.value)}function B(t){try{const n=w(t);return n.percent==-100?"-":_.shorten(n.money)}catch{return"-"}}function N(t){try{const n=w(t);return n.percent==-100?"-":_.numberVnFormat(n.percent,1)}catch{return"-"}}function w(t){const n=JSON.parse(t.buy_volume),y=JSON.parse(t.buy_price),f=JSON.parse(t.buy_fee),c=JSON.parse(t.sell_volume),z=JSON.parse(t.sell_price),S=JSON.parse(t.sell_fee);let b=0,$=0,h=0;for(let o=0;o<n.length;o++)b=-n[o]*y[o]-f[o];h=b;for(let o=0;o<c.length;o++)$=c[o]*z[o]-S[o],h+=-S[o];const D=b+$;return{money:D,percent:D/-h*100}}function O(){m.dispatch("tradingStatistic/getData")}function J(){a.gridData=null}return k({show:q}),(t,n)=>{const y=P("DxToolbar"),f=P("DxScrollView");return L(),U(K,{ref_key:"popupRef",ref:R,title:t.$t("trading.statistic.buttons.addData"),onShown:O,onHidden:J},{default:r(()=>[e(f,null,{default:r(()=>[e(i(Q),{ref_key:"dataGridRef",ref:v,"data-source":a.gridData,"key-expr":"id","show-borders":!0,"column-auto-width":!0,"allow-column-reordering":!0,"allow-column-resizing":!0,"column-resizing-mode":"widget",paging:{pageSize:8},headerFilter:{visible:!0},loadPanel:{enabled:!0},selection:{mode:"single"},editing:{allowAdding:g.value.includes(a.editPermission),allowUpdating:g.value.includes(a.editPermission),allowDeleting:g.value.includes(a.editPermission),mode:"batch",startEditAction:"dblClick"},onContentReady:n[0]||(n[0]=c=>t.$mf.dataGridPreload(a.gridData,v.value.instance)),onInitNewRow:E,onSaved:A},{commandCellTemplate:r(({data:c})=>[e(y,{items:[{locateInMenu:"auto",showText:"inMenu",location:"center",widget:"dxButton",options:{type:"default",icon:"trash",hint:t.$t("buttons.delete"),text:t.$t("buttons.delete"),onClick:()=>{v.value.instance.deleteRow(c.rowIndex)}}}]},null,8,["items"])]),default:r(()=>[e(i(l),{fixed:!0,visible:g.value.includes(a.editPermission),width:35,type:"buttons",cssClass:"dx-datagrid-command-column","cell-template":"commandCellTemplate",caption:t.$t("titles.commandHeaderTitleShort")},null,8,["visible","caption"]),e(i(l),{"data-field":"symbol","data-type":"string",width:80,caption:t.$t("trading.statistic.symbol"),"validation-rules":a.validationRules.symbol},null,8,["caption","validation-rules"]),e(i(l),{alignment:"center",caption:t.$t("trading.statistic.buy")},{default:r(()=>[e(i(l),{"data-field":"buy_date","data-type":"date",width:110,"editor-options":{dateSerializationFormat:t.$mc.DX_SERVER_DATE_FORMAT,showClearButton:"true",useMaskBehavior:"true",applyValueMode:"useButtons"},caption:t.$t("trading.statistic.date"),"validation-rules":a.validationRules.buyDate},null,8,["editor-options","caption","validation-rules"]),e(i(l),{"data-field":"buy_volume","data-type":"string",caption:t.$t("trading.statistic.volume"),"validation-rules":a.validationRules.buyVolume},null,8,["caption","validation-rules"]),e(i(l),{"data-field":"buy_price","data-type":"string",caption:t.$t("trading.statistic.price"),"validation-rules":a.validationRules.buyPrice},null,8,["caption","validation-rules"]),e(i(l),{"data-field":"buy_fee","data-type":"string",caption:t.$t("trading.statistic.fee"),"validation-rules":a.validationRules.buyFee},null,8,["caption","validation-rules"])]),_:1},8,["caption"]),e(i(l),{alignment:"center",caption:t.$t("trading.statistic.sell")},{default:r(()=>[e(i(l),{"data-field":"sell_date","data-type":"date",width:110,"editor-options":{dateSerializationFormat:t.$mc.DX_SERVER_DATE_FORMAT,showClearButton:"true",useMaskBehavior:"true",applyValueMode:"useButtons"},caption:t.$t("trading.statistic.date"),"validation-rules":a.validationRules.sellDate},null,8,["editor-options","caption","validation-rules"]),e(i(l),{"data-field":"sell_volume","data-type":"string",caption:t.$t("trading.statistic.volume"),"validation-rules":a.validationRules.sellVolume},null,8,["caption","validation-rules"]),e(i(l),{"data-field":"sell_price","data-type":"string",caption:t.$t("trading.statistic.price"),"validation-rules":a.validationRules.sellPrice},null,8,["caption","validation-rules"]),e(i(l),{"data-field":"sell_fee","data-type":"string",caption:t.$t("trading.statistic.fee"),"validation-rules":a.validationRules.sellFee},null,8,["caption","validation-rules"])]),_:1},8,["caption"]),e(i(l),{alignment:"center",caption:t.$t("trading.statistic.profit")},{default:r(()=>[e(i(l),{"data-type":"string","calculate-cell-value":B,caption:t.$t("trading.statistic.moneyProfit")},null,8,["caption"]),e(i(l),{"data-type":"string","calculate-cell-value":N,caption:t.$t("trading.statistic.percentProfit")},null,8,["caption"])]),_:1},8,["caption"])]),_:1},8,["data-source","editing"])]),_:1})]),_:1},8,["title"])}}};export{Z as default};
