import{z as pt,A as dt,B as ut,r as F,y as Ye,C as et,o as H,b as J,d as M,E as ae,c as ce,G as Te,H as be,I as ft,J as mt,m as tt,e as ee,F as We,K as Ze,t as ye,h as me,u as Oe,k as fe,L as vt,M as ht,N as Ue,O as it,g as nt,w as ve,Q as gt,R as St,S as Qe,x as re,l as Le,a as yt,T as Me,U as Tt,j as xt,V as Ct}from"./app-880aef2a.js";import{_ as kt}from"./text-box-a4df9701.js";import{g as G}from"./getUnixTime-cfeba2a7.js";import{c as _t}from"./lightweight-charts.esm.development-03366bac.js";function st(P,I,C){return pt((C==null?void 0:C.in)||P,+dt(P)+I)}function _e(P,I,C){return st(P,I*ut,C)}function bt(P,I,C){return st(P,I*1e3,C)}function Ve(P,I,C){return bt(P,-I,C)}const wt=["title"],Dt={__name:"FullscreenTool",props:["chartContainerRef"],setup(P){const I=P,C=F(!1);Ye(()=>{document.addEventListener("fullscreenchange",e)}),et(()=>{document.removeEventListener("fullscreenchange",e)});function f(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function e(){I.chartContainerRef&&(document.fullscreenElement?(C.value=!0,I.chartContainerRef.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(C.value=!1,I.chartContainerRef.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}return(s,x)=>(H(),J("div",{class:"command",title:s.$t("trading.derivative.fullscreen"),onClick:f},[M("i",{class:ae(["far",{"fa-compress":C.value,"fa-expand":!C.value}])},null,2)],8,wt))}},Rt=["title"],Et=["src"],Lt={__name:"TradingviewTool",props:["vpsUser","vpsSession","chartContainerRef"],setup(P){const I=P,C=F(null),f=F(!1),e=ce(()=>`https://chart.vps.com.vn/tv/?u=${I.vpsUser}&s=${I.vpsSession}&symbol=VN30F1M&resolution=1&lang=vi`);function s(T){f.value=!f.value,x(),T.stopPropagation()}function x(){if(I.chartContainerRef&&C.value){const{offsetWidth:T,offsetHeight:$}=I.chartContainerRef,{top:d,left:m}=C.value.getBoundingClientRect();C.value.style.top=`${d-2}px`,C.value.style.left=`${m+32}px`,C.value.style.width=`${T-34}px`,C.value.style.height=`${$}px`}}return(T,$)=>(H(),J("div",{class:"tradingview command far fa-chart-candlestick",title:T.$t("trading.derivative.tradingview"),onClick:s},[Te(M("iframe",{ref_key:"tradingviewRef",ref:C,class:"chart",src:e.value},null,8,Et),[[be,f.value]])],8,Rt))}};const Ot=M("div",{class:"triangle-shadow"},null,-1),Pt=M("div",{class:"triangle"},null,-1),$t={class:"container"},It={__name:"ProgressContext",props:["progress"],emits:["refreshPattern"],setup(P,{emit:I}){const C=I,f=F([]);Ye(()=>{e()});function e(){ft(Object.assign({"../../../../../lang/vi/derivative.js":()=>mt(()=>import("./derivative-0a1a41d1.js"),[])}),`../../../../../lang/${window.lang}/derivative.js`).then(T=>{f.value=T.default||[]})}function s(){C("refreshPattern")}function x(T){T.stopPropagation()}return(T,$)=>{const d=tt("DxButton");return H(),J("div",{class:"pattern-context",onClick:x},[Ot,Pt,M("div",null,[ee(d,{icon:"refresh",type:"success",text:T.$t("trading.derivative.progressContext.refreshPattern"),onClick:s},null,8,["text"])]),M("div",$t,[(H(!0),J(We,null,Ze(f.value,(m,S)=>(H(),J("div",{key:S,class:ae(["step",[P.progress.step&&P.progress.step===S+1?P.progress.result?"success":"fail":""]])},[M("div",{class:ae(["name",[P.progress.steps?P.progress.steps[S].every(Boolean)?"success":"fail":""]])},ye(S+1)+". "+ye(m.name),3),M("div",null,[(H(!0),J(We,null,Ze(m.conds,(N,B)=>(H(),J("div",{key:B,class:ae(["condition",[P.progress.steps?P.progress.steps[S][B]?"success":"fail":""]])},ye(B+1)+". "+ye(N),3))),128))])],2))),128))])])}}},At=["title"],Nt={__name:"ProgressTool",props:[],emits:["refreshPattern","hideContext"],setup(P,{expose:I,emit:C}){const f=me(),{t:e}=Oe(),s=fe("mf"),x=C,T=F({}),$=F(!1),d=ce(()=>f.state.tradingDerivative.config.autoRefresh);I({hide:S,set:N});function m(){const l=$.value;x("hideContext"),$.value=!l,$.value&&B()}function S(l){$.value=l}function N(l){d.value&&W(l,T.value),T.value=l}function B(){x("refreshPattern")}function Z(l){const r=l??!r.value;f.dispatch("tradingDerivative/setAutoRefresh",r)}function W(l,r){if(s.isSet(l)&&(l.step!==r.step||l.step===r.step&&l.result!==r.result)){let v="";l.result?[2,4].includes(l.step)?v=e("trading.derivative.progressOrder",l):v=e("trading.derivative.progressSuccess",l):v=e("trading.derivative.progressFail",l),A(v)}}function A(l){const r=new SpeechSynthesisUtterance(l);r.lang="vi-VN",speechSynthesis.speak(r)}return(l,r)=>(H(),J("div",{class:ae(["context command",{green:T.value.result===!0,red:T.value.result===!1}]),title:l.$t("trading.derivative.progressTool"),onClick:m,onContextmenu:Z},[M("i",{class:ae(["far",{"fa-badge-check":!T.value.step,[`fa-circle-${T.value.step}`]:T.value.step,blink:d.value}])},null,2),Te(ee(It,{class:"contextmenu",progress:T.value,onRefreshPattern:B},null,8,["progress"]),[[be,$.value]])],42,At))}};var xe={};const Bt=vt(ht);/*!
 * devextreme-vue
 * Version: 22.2.12
 * Build date: Mon Apr 29 2024
 *
 * Copyright (c) 2012 - 2024 Developer Express Inc. ALL RIGHTS RESERVED
 *
 * This software may be modified and distributed under the terms
 * of the MIT license. See the LICENSE file in the root of the project for details.
 *
 * https://github.com/DevExpress/devextreme-vue
 */var Ft=Ue&&Ue.__importDefault||function(P){return P&&P.__esModule?P:{default:P}};Object.defineProperty(xe,"__esModule",{value:!0});xe.DxItem=xe.DxButtonGroup=void 0;var Mt=Ft(Bt),Vt=it,Wt=it,rt=Vt.createComponent({props:{accessKey:String,activeStateEnabled:Boolean,buttonTemplate:{},disabled:Boolean,elementAttr:Object,focusStateEnabled:Boolean,height:[Function,Number,String],hint:String,hoverStateEnabled:Boolean,items:Array,keyExpr:[Function,String],onContentReady:Function,onDisposing:Function,onInitialized:Function,onItemClick:Function,onOptionChanged:Function,onSelectionChanged:Function,rtlEnabled:Boolean,selectedItemKeys:Array,selectedItems:Array,selectionMode:String,stylingMode:String,tabIndex:Number,visible:Boolean,width:[Function,Number,String]},emits:{"update:isActive":null,"update:hoveredElement":null,"update:accessKey":null,"update:activeStateEnabled":null,"update:buttonTemplate":null,"update:disabled":null,"update:elementAttr":null,"update:focusStateEnabled":null,"update:height":null,"update:hint":null,"update:hoverStateEnabled":null,"update:items":null,"update:keyExpr":null,"update:onContentReady":null,"update:onDisposing":null,"update:onInitialized":null,"update:onItemClick":null,"update:onOptionChanged":null,"update:onSelectionChanged":null,"update:rtlEnabled":null,"update:selectedItemKeys":null,"update:selectedItems":null,"update:selectionMode":null,"update:stylingMode":null,"update:tabIndex":null,"update:visible":null,"update:width":null},computed:{instance:function(){return this.$_instance}},beforeCreate:function(){this.$_WidgetClass=Mt.default,this.$_hasAsyncTemplate=!0,this.$_expectedChildren={item:{isCollectionItem:!0,optionName:"items"}}}});xe.DxButtonGroup=rt;var ze=Wt.createConfigurationComponent({emits:{"update:isActive":null,"update:hoveredElement":null,"update:disabled":null,"update:elementAttr":null,"update:hint":null,"update:html":null,"update:icon":null,"update:template":null,"update:text":null,"update:type":null,"update:visible":null},props:{disabled:Boolean,elementAttr:Object,hint:String,html:String,icon:String,template:{},text:String,type:String,visible:Boolean}});xe.DxItem=ze;ze.$_optionName="items";ze.$_isCollectionItem=!0;var Zt=xe.default=rt;const Yt=M("div",{class:"triangle-shadow"},null,-1),zt=M("div",{class:"triangle"},null,-1),Ht={__name:"ScanContext",props:["modelValue"],emits:["update:modelValue"],setup(P,{emit:I}){const{t:C}=Oe(),f=[{icon:"chevrondoubleleft",side:"left",text:C("trading.derivative.scanContext.leftScan")},{icon:"chevrondoubleright",side:"right",text:C("trading.derivative.scanContext.rightScan")}],e=P,s=I;function x({itemData:{side:$}}){s("update:modelValue",$)}function T($){$.stopPropagation()}return($,d)=>(H(),J("div",{class:"scan-context",onClick:T},[Yt,zt,ee(nt(Zt),{items:f,"selected-item-keys":[e.modelValue],"key-expr":"side","styling-mode":"outlined",onItemClick:x},null,8,["selected-item-keys"])]))}},Jt=["title"],Xt={__name:"ScanTool",props:["prices","timeToIndex"],emits:["scaned","removePattern","hideContext"],setup(P,{expose:I,emit:C}){const f=fe("mf"),e=P,s=C,x=F(null),T=F(!1),$=F("left");I({isSelected:d,hide:m,draw:B});function d(){return x.value.classList.contains("selected")}function m(l){T.value=l}function S(l){s("hideContext");const r=l.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(v=>v.classList.remove("selected")),r||(l.target.classList.add("selected"),s("removePattern"))}function N(){const l=T.value;s("hideContext"),T.value=!l}function B({time:l}){const r=$.value==="left",v=l?e.prices.filter(o=>!f.cmp(o.time,r,l)):e.prices;let i=r?Z(v):W(v);f.isSet(i)&&s("scaned",A(i)),x.value.classList.remove("selected")}function Z(l){let r,[v,i,o,h]=Array(4).fill({});for(let g=l.length-1;g>=0;g--){const k=l[g].value,E=l[g].time,n=e.timeToIndex(E);if(n===-1)break;if(g===l.length-1&&(o={index:n,time:E,price:k},[i,v,h]=Array(3).fill(null).map(()=>f.cloneDeep(o))),r===void 0){if(k===o.price)continue;r=k>o.price}if(f.cmp(k,r,i.price)&&(f.cmp(v.price,!r,o.price)?([o,i]=[i,v].map(a=>f.cloneDeep(a)),v={index:n,time:E,price:k},h=f.cloneDeep(v),r=!r):i={index:n,time:E,price:k}),f.cmp(k,!r,v.price)?(v={index:n,time:E,price:k},h=f.cloneDeep(v)):h.index=n,f.cmp(k,r,h.price)&&(h={index:n,time:E,price:k}),o.index>v.index){const a=f.fmtNum(i.price-o.price,1,!0);if(a>=1&&(v.index-h.index>o.index-i.index||f.fmtNum(v.price-h.price,1,!0)>a))break}}return{A:v,B:i,C:o}}function W(l){let r,[v,i,o]=Array(3).fill({});for(let h=0;h<l.length;h++){const g=l[h].value,k=l[h].time,E=e.timeToIndex(k);if(E===-1)break;if(h===0&&(v={index:E,time:k,price:g},i=f.cloneDeep(v),o=f.cloneDeep(v)),r===void 0){if(g===v.price)continue;r=g>v.price}f.cmp(g,r,i.price)&&(i={index:E,time:k,price:g},o=f.cloneDeep(i)),f.cmp(i.price,r,v.price)&&f.cmp(g,!r,o.price)&&(f.cmp(g,r,v.price)?o={index:E,time:k,price:g}:(v=f.cloneDeep(i),i={index:E,time:k,price:g},o=f.cloneDeep(i),r=!r))}return{A:v,B:i,C:o}}function A(l){const r={};return Object.entries(l).forEach(([v,i])=>{const{index:o,...h}=i;r[v]=h}),r}return(l,r)=>(H(),J("div",{ref_key:"scanToolRef",ref:x,class:"context command",title:l.$t("trading.derivative.scanTool"),onClick:S,onContextmenu:N},[M("i",{class:ae(["far",{[`fa-angles-${$.value}`]:!0}])},null,2),Te(ee(Ht,{class:"contextmenu",modelValue:$.value,"onUpdate:modelValue":r[0]||(r[0]=v=>$.value=v)},null,8,["modelValue"]),[[be,T.value]])],40,Jt))}},jt=["title"],qt=M("i",{class:"far fa-heart-rate"},null,-1),Ut=[qt],Qt={__name:"PatternTool",props:["prices","priceSeries","timeMarkSeries","pickTimeToolRef","timeToIndex","indexToTime"],emits:["setProgress","hideContext"],setup(P,{expose:I,emit:C}){const f=me(),e=fe("mf"),s=P,x=C,T=F(null),$=ce(()=>f.state.tradingDerivative.tools.pattern);let d={},m={};I({isSelected:S,draw:Z,load:W,refresh:l,remove:k,drag:a}),ve($,p=>{p&&W(p,{isCheck:!0})});function S(){return T.value.classList.contains("selected")}function N(p){x("hideContext");const t=p.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(y=>y.classList.remove("selected")),t||(p.target.classList.add("selected"),s.pickTimeToolRef.remove())}function B(p){p.target.classList.remove("selected"),k()}function Z({time:p,price:t}){let u={lineType:"pattern",price:t,lineWidth:1,lineStyle:1,draggable:!0};if(e.isSet(m.A))if(e.isSet(m.B)){let _,w;if(e.isSet(m.C)){let L,b;d.A={time:p,price:t};const{progress:R,timeMark:V,info:{rEpr1:X,rEpr2:U,rEpr3:se,entry:te,pStatus:ie,x:ne,X:j,y:Q,Y}}=r();w=R,_=V,L="A",b={price:t,title:`A ${X}`},m[L].applyOptions(b),L="B",b={title:`B ${U}`},m[L].applyOptions(b),L="C",b={title:`C ${se}`},m[L].applyOptions(b),L="D",b={price:te,title:"Entry "+ie},m[L].applyOptions(b),L="X",b={price:e.fmtNum(ne),title:`X ${e.fmtNum(j)}`},m[L].applyOptions(b),L="Y",b={price:e.fmtNum(Q),title:`Y ${e.fmtNum(Y)}`},m[L].applyOptions(b)}else{d.C={price:t};const{progress:L,timeMark:b,info:{rEpr1:R,rEpr2:V,rEpr3:X,entry:U,pStatus:se,x:te,X:ie,y:ne,Y:j}}=r();w=L,_=b;let Q="A";m[Q].applyOptions({title:`A ${R}`}),Q="B",m[Q].applyOptions({title:`B ${V}`}),u.point="C",u.title=`C ${X}`,u.color="#FFEB3B",m[u.point]=s.priceSeries.createPriceLine(u),u.point="D",u.price=U,u.title="Entry "+se,u.color="#9C27B0",u.draggable=!1,m[u.point]=s.priceSeries.createPriceLine(u),u.point="Y",u.price=e.fmtNum(ne),u.title=`Y ${e.fmtNum(j)}`,u.color="#E91E63",u.draggable=!1,m[u.point]=s.priceSeries.createPriceLine(u),u.point="X",u.price=e.fmtNum(te),u.title=`X ${e.fmtNum(ie)}`,u.color="#2196F3",u.draggable=!1,m[u.point]=s.priceSeries.createPriceLine(u)}g(),x("setProgress",w),n(_),T.value.classList.remove("selected")}else u.point="B",u.title="B 0",u.color="#4CAF50",m[u.point]=s.priceSeries.createPriceLine(u),d.B={price:t};else u.point="A",u.title="A 0",u.color="#F44336",m[u.point]=s.priceSeries.createPriceLine(u),d={A:{time:p,price:t}}}function W(p,{isSave:t=!1,isCheck:y=!1}){d=e.cloneDeep(p),t&&g(),(y?i(d):!0)&&(E(),A())}function A(){let t={lineType:"pattern",lineWidth:1,lineStyle:1,draggable:!0};const{A:y,B:u,C:_}=d,{progress:w,timeMark:L,info:{rEpr1:b,rEpr2:R,rEpr3:V,entry:X,pStatus:U,x:se,X:te,y:ie,Y:ne}}=r();x("setProgress",w),n(L),t.point="A",t.title=`A ${b}`,t.color="#F44336",t.price=y.price,m[t.point]=s.priceSeries.createPriceLine(t),t.point="B",t.title=`B ${R}`,t.color="#4CAF50",t.price=u.price,m[t.point]=s.priceSeries.createPriceLine(t),t.point="C",t.price=_.price,t.title=`C ${V}`,t.color="#FFEB3B",m[t.point]=s.priceSeries.createPriceLine(t),t.point="D",t.price=X,t.title="Entry "+U,t.color="#9C27B0",t.draggable=!1,m[t.point]=s.priceSeries.createPriceLine(t),t.point="Y",t.price=e.fmtNum(ie),t.title=`Y ${e.fmtNum(ne)}`,t.color="#E91E63",t.draggable=!1,m[t.point]=s.priceSeries.createPriceLine(t),t.point="X",t.price=e.fmtNum(se),t.title=`X ${e.fmtNum(te)}`,t.color="#2196F3",t.draggable=!1,m[t.point]=s.priceSeries.createPriceLine(t)}function l(p=!1){e.isSet(m.C)&&(p&&h(),E(),A())}function r(){const{A:p,B:t,C:y}=d,u=t.price-y.price,_=u>0,w=v({phase:1,start:p,end:t,retracementPrice:y.price});let L=v({phase:2,start:w.R,end:y});const b=v({phase:3,start:L.R,end:{price:t.price+(_?1:-1)*w.rEp},breakPrices:[L.S1.price,t.price]});w.xBox.tr>=L.tr&&(L.tr=w.xBox.tr),console.log("calculatePattern",[w,L,b]);const R=e.fmtNum(u,1,!0)>=w.pr,V=e.fmtNum(y.price-b.xBox.R.price,1,!0)>=L.pr,X=e.fmtNum(b.xBox.pr)>=b.pr,U=!e.cmp(y.price,!_,w.S1.price),se=!e.cmp(b.xBox.R.price,_,L.S1.price),te=!e.cmp(b.xBox.S.price,!_,b.S1.price),ie=w.R.index+w.tr,ne=w.R.index+5*w.tr,j=L.R.index+L.tr,Q=b.xBox.R.index+b.tr,Y=b.xBox.R.index+5*b.tr,oe=b.xBox.R.index+L.tr,Pe=[ie,ne,j,Q,Y,oe],le=b.xBox.S.index;let he,q={};const Ce=[L.R.index>ie,w.rEpr<3,L.rEpr<w.rEpr];q.steps=[[R||w.rEt<w.tr&&w.rEp>=w.sEp,U,!b.breakIndexs[1]||ie<b.breakIndexs[1],le>ie,le<ne],[...Ce,j>ie,le<Y,le<j],[L.R.index-w.R.index>.5*w.tr,V,!b.breakIndexs[1]||j<b.breakIndexs[1],le>j],[X,te,le>Q,Ce.every(Boolean)||le>oe]],q.step=1,q.result=q.steps[0].every(Boolean),he=w.R1.price,q.result&&(le<=j?(q.step=2,q.result=q.steps[1].every(Boolean),he=L.S1.price):(q.step=3,q.result=q.steps[2].every(Boolean),he=b.R1.price,q.result&&(q.step=4,q.result=q.steps[3].every(Boolean),q.result&&(he=b.xBox.R.price))));const $e=`${U?R?1:0:2}${se?V?1:0:2}${te?X?1:0:2}`,ge=w.rEp,Ie=o(t.price,ge,_),Ae=b.breakIndexs[1]??le,we=parseInt((Ae-w.R.index)/w.tr),De=we>1?ge*we:ge,Ne=o(t.price,De,_);return{progress:q,timeMark:Pe,info:{rEpr1:w.rEpr,rEpr2:L.rEpr,rEpr3:b.rEpr,entry:he,pStatus:$e,x:Ie,X:ge,y:Ne,Y:De}}}function v({phase:p,start:t,end:y,breakPrices:u,retracementPrice:_}){let w=e.cloneDeep(t),L=e.cloneDeep(y);const b=L.price>w.price;let R={},V={},X={},U=[null,null],se,te,ie;const ne=s.pickTimeToolRef.get();return s.prices.filter(j=>{let Q=j.time>=w.time;return ne&&(Q&=j.time<=ne),Q}).every((j,Q)=>{const Y=j.value,oe=s.timeToIndex(j.time);return oe===-1?!1:(Q===0&&(R={R:{index:oe,price:Y},S:{index:oe,price:Y},pr:0,tr:0},V=e.cloneDeep(R),X=e.cloneDeep(R)),e.cmp(Y,b,R.R.price)?(R.pr>0&&(R.pr>=V.pr&&(V.pr=R.pr,V.R=e.cloneDeep(R.R),V.S=e.cloneDeep(R.S)),R.tr>V.tr&&(V.tr=R.tr),p===1&&_&&!e.cmp(R.S.price,!b,_)&&R.tr>=X.tr&&R.pr>=X.pr&&(X=e.cloneDeep(R))),R={R:{index:oe,price:Y},S:{index:oe,price:Y},pr:0,tr:0},p===3&&u&&(!U[0]&&e.cmp(Y,b,u[0])&&(U[0]=oe),!U[1]&&e.cmp(Y,b,u[1])&&(U[1]=oe))):(R.S.index=oe,R.tr=R.S.index-R.R.index,e.cmp(Y,!b,R.S.price)&&(R.S.price=Y,R.pr=e.fmtNum(R.S.price-R.R.price,1,!0))),e.cmp(Y,!b,w.price)?(R.S.price=w.price,!1):!!e.cmp(Y,!b,L.price))}),e.isSet(R)&&(w.index=s.timeToIndex(w.time),L.index=R.S.index,L.time=s.indexToTime(R.S.index),se=e.fmtNum(L.price-V.R.price,1,!0),te=e.fmtNum(w.price-V.S.price,1,!0),ie=L.index-V.S.index,p===3&&(X=R)),{tr:V.tr,pr:V.pr,rEp:se,sEp:te,rEpr:V.pr?e.fmtNum(se/V.pr):0,rEt:ie,S1:V.S,R1:V.R,xBox:X,S:w,R:L,breakIndexs:U}}function i({A:{time:p}}){return p>=s.prices[0].time&&p<s.prices.at(-1).time}function o(p,t,y){const u=p+(y?1:-1)*t;let _=e.fmtNum(u%1);if(y){if(_>=.1&&_<=.2)return Math.floor(u);if(_>=.6&&_<=.7)return Math.floor(u)+.5}else{if(_>=.8&&_<=.9)return Math.ceil(u);if(_>=.3&&_<=.4)return Math.floor(u)+.5}return u}function h(){if(s.pickTimeToolRef.get())return!1;const t=d.B.price-d.A.price>0,y=s.prices.at(-1).value;if(e.cmp(y,!t,d.C.price)){let u=y;for(let _=s.prices.length-1;_>=0;_--){const w=s.prices[_].value;if(w===d.B.price)break;u=t?Math.min(u,w):Math.max(u,w)}d.C.price=u,g()}}function g(p=!1){let t={isRemove:p,name:"pattern",points:[],data:[]};p?d={}:Object.entries(d).forEach(([y,u])=>{t.points.push(y),t.data.push(u)}),f.dispatch("tradingDerivative/drawTools",t)}function k(){g(!0),s.pickTimeToolRef.remove(),E(),x("setProgress",{})}function E(){e.isSet(m.A)&&(s.priceSeries.removePriceLine(m.A),e.isSet(m.B)&&(s.priceSeries.removePriceLine(m.B),e.isSet(m.C)&&(s.priceSeries.removePriceLine(m.C),s.priceSeries.removePriceLine(m.D),s.priceSeries.removePriceLine(m.X),s.priceSeries.removePriceLine(m.Y)))),m={},n([])}function n(p){const t=["#F44336","#F44336","#4CAF50","#FFEB3B","#FFEB3B","#2196F3"];let y=[];for(let u=0;u<p.length;u++){let _=s.indexToTime(p[u]);_&&(p.indexOf(p[u])!==p.lastIndexOf(p[u])&&(_+=u),y.push({time:_,value:1,color:t[u]}))}y.length&&y.sort((u,_)=>u.time-_.time),s.timeMarkSeries.setData(y)}function a({lineOptions:p}){if(e.isSet(m.C)){let t,y;d={A:{time:d.A.time,price:+m.A.options().price},B:{price:+m.B.options().price},C:{price:+m.C.options().price}},g();const{progress:u,timeMark:_,info:{rEpr1:w,rEpr2:L,rEpr3:b,entry:R,pStatus:V,x:X,X:U,y:se,Y:te}}=r();x("setProgress",u),n(_),t="A",y={title:`A ${w}`},m[t].applyOptions(y),t="B",y={title:`B ${L}`},m[t].applyOptions(y),t="C",y={title:`C ${b}`},m[t].applyOptions(y),t="D",y={price:R,title:"Entry "+V},p.point===t&&delete y.price,m[t].applyOptions(y),t="X",y={price:e.fmtNum(X),title:`X ${e.fmtNum(U)}`},m[t].applyOptions(y),t="Y",y={price:e.fmtNum(se),title:`Y ${e.fmtNum(te)}`},m[t].applyOptions(y)}}return(p,t)=>(H(),J("div",{ref_key:"patternToolRef",ref:T,class:"command",title:p.$t("trading.derivative.patternTool"),onClick:N,onContextmenu:B},Ut,40,jt))}},Gt=["title"],Kt=M("i",{class:"far fa-pipe"},null,-1),ei=[Kt],ti={__name:"PickTimeTool",props:["pickTimeSeries"],emits:["refreshPattern","hideContext"],setup(P,{expose:I,emit:C}){const f=me(),e=P,s=C,x=F(null),T=ce(()=>f.state.tradingDerivative.tools.pickTime);let $=null;I({isSelected:d,draw:B,remove:W,get:m}),ve(T,A=>{A&&Z(A[0])});function d(){return x.value.classList.contains("selected")}function m(){return $}function S(A){s("hideContext");const l=A.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(r=>r.classList.remove("selected")),l||A.target.classList.add("selected")}function N(A){A.target.classList.remove("selected"),W(),s("refreshPattern")}function B({time:A}){f.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"pickTime",points:[0],data:[A]}),Z(A),s("refreshPattern"),x.value.classList.remove("selected")}function Z(A){$=A,e.pickTimeSeries.setData([{time:A,value:1,color:"#9C27B0"}])}function W(A=!0){A&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"pickTime"}),e.pickTimeSeries.setData([]),$=null}return(A,l)=>(H(),J("div",{ref_key:"pickTimeToolRef",ref:x,class:"command",title:A.$t("trading.derivative.pickTimeTool"),onClick:S,onContextmenu:N},ei,40,Gt))}};const ii=M("div",{class:"triangle-shadow"},null,-1),ni=M("div",{class:"triangle"},null,-1),si={class:"input"},ri={class:"color"},oi=["onClick"],ai={__name:"LineContext",props:["enable","title","color"],emits:["update:title","update:color"],setup(P,{emit:I}){const C=P,f=I,e=F(null),s=F(["#F44336","#FF9800","#FFEB3B","#4CAF50","#009688","#00BCD4","#2196F3","#673AB7","#9C27B0","#E91E63"]);ve(()=>C.enable,m=>{m&&gt().then(()=>e.value.instance.focus())});function x({value:m}){f("update:title",m)}function T(m){f("update:color",m)}function $(){f("deleteAllLine")}function d(m){m.stopPropagation()}return(m,S)=>{const N=tt("DxButton");return H(),J("div",{class:"line-context",onClick:d},[ii,ni,M("div",si,[ee(nt(kt),{ref_key:"titleRef",ref:e,value:C.title,"show-clear-button":!0,"input-attr":{style:`color:${C.color}`},onValueChanged:x},null,8,["value","input-attr"]),ee(N,{icon:"trash",type:"danger",onClick:S[0]||(S[0]=B=>$())})]),M("div",ri,[(H(!0),J(We,null,Ze(s.value,(B,Z)=>(H(),J("div",{class:"color-swatch",style:St({background:B,boxShadow:`0 0 4px ${B}`}),key:Z,onClick:W=>T(B)},null,12,oi))),128))])])}}},ci=["title"],li=M("i",{class:"far fa-horizontal-rule"},null,-1),pi={__name:"LineTool",props:["priceSeries"],emits:["hideContext"],setup(P,{expose:I,emit:C}){const f=me(),e=P,s=C,x=F(null),T=F(!1),$=ce(()=>f.state.tradingDerivative.tools.line),d=F(""),m=F("#F44336");let S=[];I({isSelected:N,hide:B,draw:A,drag:i}),ve($,o=>{o&&l(o)});function N(){return x.value.classList.contains("selected")}function B(o){T.value=o}function Z(o){s("hideContext");const h=o.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(g=>g.classList.remove("selected")),h||o.target.classList.add("selected")}function W(o){const h=T.value;s("hideContext"),T.value=!h}function A({price:o}){const h="line",g=S.length;if(S=S.filter(k=>{const E=k.options(),n=E.type=o===+E.price;return n&&(e.priceSeries.removePriceLine(k),f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:h,point:o})),!n}),S.length===g){const k=m.value,E=d.value,n={lineType:h,price:o,color:k,title:E,lineWidth:1,lineStyle:1,draggable:!0};S.push(e.priceSeries.createPriceLine(n)),f.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:h,points:[o],data:[{color:k,title:E}]})}x.value.classList.remove("selected")}function l(o){v(!1),r(o)}function r(o){const g={lineType:"line",lineWidth:1,lineStyle:1,draggable:!0};Object.entries(o).forEach(([k,{color:E,title:n}])=>{g.price=+k,g.color=E,g.title=n,S.push(e.priceSeries.createPriceLine(g))})}function v(o=!0){S.length>0&&(o&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line"}),S.forEach(h=>e.priceSeries.removePriceLine(h)),S=[])}function i({lineOptions:o,oldPrice:h,newPrice:g}){f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line",point:h});const k=o.color,E=o.title;f.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"line",points:[g],data:[{color:k,title:E}]}),x.value.classList.remove("selected")}return(o,h)=>(H(),J("div",{ref_key:"lineToolRef",ref:x,class:"context command",title:o.$t("trading.derivative.lineTool"),onClick:Z,onContextmenu:W},[li,Te(ee(ai,{class:"contextmenu",enable:T.value,title:d.value,"onUpdate:title":h[0]||(h[0]=g=>d.value=g),color:m.value,"onUpdate:color":h[1]||(h[1]=g=>m.value=g),onDeleteAllLine:v},null,8,["enable","title","color"]),[[be,T.value]])],40,ci))}},di=["title"],ui=M("i",{class:"far fa-grip-lines-vertical"},null,-1),fi=[ui],mi={__name:"TimeRangeTool",props:["timeRangeSeries","timeToIndex","indexToTime"],emits:["hideContext"],setup(P,{expose:I,emit:C}){const f=me(),e=fe("mf"),s=P,x=C,T=F(null),$=ce(()=>f.state.tradingDerivative.tools.timeRange);let d=[];I({isSelected:m,draw:B}),ve($,l=>{l&&Z(l)});function m(){return T.value.classList.contains("selected")}function S(l){x("hideContext");const r=l.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(v=>v.classList.remove("selected")),r||l.target.classList.add("selected")}function N(l){A(),l.target.classList.remove("selected")}function B({time:l}){let r={isRemove:!1,name:"timeRange",points:[],data:[]},v={time:l,value:1};switch(d.length){case 0:v.color="OrangeRed",d[0]=v,r.points.push(0),r.data.push(l);break;case 1:v.color="lime",d[1]=v,r.points.push(1),r.data.push(l),T.value.classList.remove("selected");break;default:const i=s.timeToIndex(d[0].time),o=s.timeToIndex(d[1].time),g=s.timeToIndex(l)+(o-i),k=s.indexToTime(g);v.color="OrangeRed",d[0]=e.cloneDeep(v),r.points.push(0),r.data.push(l),v.time=k,v.color="lime",d[1]=v,r.points.push(1),r.data.push(k),T.value.classList.remove("selected");break}s.timeRangeSeries.setData(d),f.dispatch("tradingDerivative/drawTools",r)}function Z(l){A(!1),W(l)}function W(l){let r,v;if(l.length===2)r=l[0],v=l[1];else if(l.length===3){const o=s.timeToIndex(l[0]),h=s.timeToIndex(l[1]),k=s.timeToIndex(l[2])+(h-o);r=l[2],v=s.indexToTime(k)}else return!1;let i=[{time:r,value:1,color:"OrangeRed"},{time:v,value:1,color:"lime"}];d=i,s.timeRangeSeries.setData(i)}function A(l=!0){l&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"timeRange"}),s.timeRangeSeries.setData([]),d=[]}return(l,r)=>(H(),J("div",{ref_key:"timeRangeToolRef",ref:T,class:"command",title:l.$t("trading.derivative.timeRangeTool"),onClick:S,onContextmenu:N},fi,40,di))}},vi=["title"],hi=M("i",{class:"far fa-line-height"},null,-1),gi=[hi],Si={__name:"TargetTool",props:["priceSeries"],emits:["hideContext"],setup(P,{expose:I,emit:C}){const f=me(),e=fe("mf"),s=P,x=C,T=F(null),$=ce(()=>f.state.tradingDerivative.tools.target);let d={};I({isSelected:m,draw:B,drag:l}),ve($,r=>{r&&Z(r)});function m(){return T.value.classList.contains("selected")}function S(r){x("hideContext");const v=r.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),v||(r.target.classList.add("selected"),A())}function N(r){A(),r.target.classList.remove("selected")}function B({price:r}){const v="target";let i={lineType:v,price:r,lineWidth:1,lineStyle:1,draggable:!0},o={isRemove:!1,name:v,points:[],data:[r]};if(e.isSet(d.A)){const h=+d.A.options().price,g=r-h;i.point="B",i.title=e.fmtNum(g),i.color="#F44336",d[i.point]=s.priceSeries.createPriceLine(i),o.points.push(i.point),i.point="X",i.price=e.fmtNum(h-.5*g),i.title=e.fmtNum(-.5*g),i.color="#2196F3",d[i.point]=s.priceSeries.createPriceLine(i),i.point="Y",i.price=e.fmtNum(h-g),i.title=e.fmtNum(-g),i.color="#673AB7",d[i.point]=s.priceSeries.createPriceLine(i),i.point="Z",i.price=e.fmtNum(h-2*g),i.title=e.fmtNum(-2*g),i.color="#9C27B0",d[i.point]=s.priceSeries.createPriceLine(i),i.point="W",i.price=e.fmtNum(h-4*g),i.title=e.fmtNum(-4*g),i.color="#E91E63",d[i.point]=s.priceSeries.createPriceLine(i),T.value.classList.remove("selected")}else i.point="A",i.title="0",i.color="#FF9800",d[i.point]=s.priceSeries.createPriceLine(i),o.points.push(i.point);f.dispatch("tradingDerivative/drawTools",o)}function Z(r){A(!1),W(r)}function W(r){let i={lineType:"target",lineWidth:1,lineStyle:1,draggable:!0};const o=r.A,h=r.B,g=h-o;i.point="A",i.price=o,i.title="0",i.color="#FF9800",d[i.point]=s.priceSeries.createPriceLine(i),i.point="B",i.price=h,i.title=e.fmtNum(g),i.color="#F44336",d[i.point]=s.priceSeries.createPriceLine(i),i.point="X",i.price=e.fmtNum(o-.5*g),i.title=e.fmtNum(-.5*g),i.color="#2196F3",d[i.point]=s.priceSeries.createPriceLine(i),i.point="Y",i.price=e.fmtNum(o-g),i.title=e.fmtNum(-g),i.color="#673AB7",d[i.point]=s.priceSeries.createPriceLine(i),i.point="Z",i.price=e.fmtNum(o-2*g),i.title=e.fmtNum(-2*g),i.color="#9C27B0",d[i.point]=s.priceSeries.createPriceLine(i),i.point="W",i.price=e.fmtNum(o-4*g),i.title=e.fmtNum(-4*g),i.color="#E91E63",d[i.point]=s.priceSeries.createPriceLine(i)}function A(r=!0){r&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"target"}),e.isSet(d.A)&&(s.priceSeries.removePriceLine(d.A),e.isSet(d.B)&&(s.priceSeries.removePriceLine(d.B),s.priceSeries.removePriceLine(d.X),s.priceSeries.removePriceLine(d.Y),s.priceSeries.removePriceLine(d.Z),s.priceSeries.removePriceLine(d.W))),d={}}function l({lineOptions:r,newPrice:v}){if(e.isSet(d.B)){let i={isRemove:!1,name:"target",points:[],data:[]},o,h,g=+d.A.options().price,k=+d.B.options().price,E=k-g;if(o="A",r.point==="A")E=+d.B.options().title,k=g+E;else if(r.point!=="B"){let n=0;switch(r.point){case"X":n=1.5;break;case"Y":n=2;break;case"Z":n=3;break;case"W":n=5;break}E=e.fmtNum((k-v)/n),g=k-E,h={price:g},d[o].applyOptions(h)}i.points.push(o),i.data.push(g),o="B",h={price:k,title:e.fmtNum(E)},r.point===o&&delete h.price,d[o].applyOptions(h),i.points.push(o),i.data.push(k),o="X",h={price:e.fmtNum(g-.5*E),title:e.fmtNum(-.5*E)},r.point===o&&delete h.price,d[o].applyOptions(h),o="Y",h={price:e.fmtNum(g-E),title:e.fmtNum(-E)},r.point===o&&delete h.price,d[o].applyOptions(h),o="Z",h={price:e.fmtNum(g-2*E),title:e.fmtNum(-2*E)},r.point===o&&delete h.price,d[o].applyOptions(h),o="W",h={price:e.fmtNum(g-4*E),title:e.fmtNum(-4*E)},r.point===o&&delete h.price,d[o].applyOptions(h),f.dispatch("tradingDerivative/drawTools",i)}}return(r,v)=>(H(),J("div",{ref_key:"targetToolRef",ref:T,class:"command",title:r.$t("trading.derivative.targetTool"),onClick:S,onContextmenu:N},gi,40,vi))}},yi=["title"],Ge=3,Ke=2,Ti={__name:"OrderTool",props:["position","prices","priceSeries","inSession","TIME"],emits:["getTools","showEntry","showTpSl","orderChanged","hideContext"],setup(P,{expose:I,emit:C}){const f=me(),{t:e}=Oe(),s=fe("mf"),x=P,T=C,$=F(null),d=F(!1),m=ce(()=>f.state.tradingDerivative.tools.order);let S={side:0,entry:null,tp:null,sl:null},N={entry:{},tp:{},sl:{}},B=!1;I({show:W,entry:A,tpsl:l,cancel:r,cancelWithoutClose:v,scan:i,drag:E}),ve(m,a=>{a&&h(a)});function Z(){return s.isSet(N.entry)||s.isSet(N.tp)}function W({price:a}){if(a&&x.inSession()){const p=G(_e(new Date,7));if(s.isSet(N.entry))!s.isSet(N.tp)&&x.position&&p>x.TIME.ATO&&p<x.TIME.ATC&&T("showTpSl",{side:x.position});else{let t=null,y=0;x.position?(p<x.TIME.ATO?t="ATO":p>x.TIME.ATC&&(t="ATC"),t&&(S.entry=t,y=-x.position)):p>x.TIME.ATO&&p<x.TIME.ATC&&(t=a,y=t>=x.prices.at(-1).value?1:-1,S.side=y,S.entry=t),y&&T("showEntry",{side:y,price:t})}}}function A(){if(x.inSession()){const a=G(_e(new Date,7));a<x.TIME.ATO?Qe(e("trading.derivative.atoOrder"),e("titles.confirm")).then(t=>{t&&f.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(y=>{y.isOk?re.success(e("trading.derivative.atoOrderSuccess")):n(y.message)})}):a>x.TIME.ATC?Qe(e("trading.derivative.atcOrder"),e("titles.confirm")).then(t=>{t&&f.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(y=>{y.isOk?re.success(e("trading.derivative.atcOrderSuccess")):n(y.message)})}):f.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"new",side:S.side,price:S.entry}}).then(p=>{p.isOk?(o(["entry"]),re.success(e("trading.derivative.newEntrySuccess"))):n(p.message)})}}function l(){S.tp=S.entry+S.side*Ge,S.sl=S.entry-S.side*Ke,f.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:S.tp},slData:{cmd:"new",price:S.sl}}).then(a=>{a.isOk?(N.entry.applyOptions({draggable:!1}),o(["entry","tp","sl"]),re.success(e("trading.derivative.newTpSlSuccess"))):n(a.message)})}function r(){s.isSet(N.entry)?s.isSet(N.tp)?f.dispatch("tradingDerivative/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(a=>{a.isOk?(k(["entry","tp","sl"]),re.success(e("trading.derivative.exitSuccess"))):n(a.message)}):f.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"delete"}}).then(a=>{a.isOk?(k(["entry"]),re.success(e("trading.derivative.deleteEntrySuccess"))):n(a.message)}):T("getTools")}function v(){if(x.inSession()&&x.position){const a=G(_e(new Date,7));a>x.TIME.ATC-5*60&&(d.value=!0,a>x.TIME.ATC-15&&s.isSet(N.tp)&&f.dispatch("tradingDerivative/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(p=>{p.isOk?(k(["entry","tp","sl"]),re.success(e("trading.derivative.autoCancelTpSlSuccess"))):n(p.message)}))}}function i(a){if(s.isSet(N.entry)){const p=S.side>0;s.isSet(N.tp)?(s.cmp(a,p,S.tp,!0)&&(B||(B=!0,f.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"delete"}}).then(t=>{t.isOk?(k(["entry","tp","sl"]),re.success(e("trading.derivative.deleteTpSuccess"))):n(t.message),B=!1}))),s.cmp(a,!p,S.sl,!0)&&(B||(B=!0,f.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"cancel"}}).then(t=>{t.isOk?(k(["entry","tp","sl"]),re.success(e("trading.derivative.deleteSlSuccess"))):n(t.message),B=!1})))):s.cmp(a,p,S.entry,!0)&&(B||(B=!0,setTimeout(()=>{S.tp=S.entry+S.side*Ge,S.sl=S.entry-S.side*Ke,f.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:S.tp},slData:{cmd:"new",price:S.sl}}).then(t=>{t.isOk?(N.entry.applyOptions({draggable:!1}),o(["entry","tp","sl"]),re.success(e("trading.derivative.autoNewTpSlSuccess"))):n(t.message),B=!1})},1e3)))}}function o(a){const p="order";let t={isRemove:!1,name:p,points:[],data:[]},y,u;a.forEach(_=>{const w=S.entry,L=S.tp,b=S.sl;switch(_){case"entry":y="yellow",u=S.side>0?"LONG":"SHORT";break;case"tp":y="lime",u=s.fmtNum(L-w,1,!0);break;case"sl":y="red",u=s.fmtNum(b-w,1,!0);break}if(t.points.push(_),s.isSet(N[_]))N[_].applyOptions({price:S[_],title:u}),t.data.push(N[_].options());else{const R={lineType:p,kind:_,side:S.side,price:S[_],color:y,lineWidth:1,lineStyle:0,title:u,draggable:!0};N[_]=x.priceSeries.createPriceLine(R),t.data.push(R)}}),f.dispatch("tradingDerivative/drawTools",t),T("orderChanged",Z())}function h(a){k(["entry","tp","sl"],!1),g(a),T("orderChanged",Z())}function g(a){Object.entries(a).forEach(([p,t])=>{p==="entry"&&(S.side=t.side),S[p]=t.price,N[p]=x.priceSeries.createPriceLine(t)})}function k(a,p=!0){p&&f.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"order"}),a.forEach(t=>{s.isSet(N[t])&&(x.priceSeries.removePriceLine(N[t]),delete N[t])}),T("orderChanged",Z())}function E({line:a,lineOptions:p,oldPrice:t,newPrice:y}){if(y!==t){let u=!1;p.kind==="entry"?x.position||(u=!0,S[p.kind]=y,f.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"change",price:S.entry}}).then(_=>{_.isOk?(o([p.kind]),re.success(e("trading.derivative.changeEntrySuccess"))):(a.applyOptions({price:t}),n(_.message))})):(u=!0,S[p.kind]=y,p.kind==="tp"?f.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"change",price:S.tp}}).then(_=>{_.isOk?(o([p.kind]),re.success(e("trading.derivative.changeTpSuccess"))):(a.applyOptions({price:t}),n(_.message))}):f.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"change",price:S.sl}}).then(_=>{_.isOk?(o([p.kind]),re.success(e("trading.derivative.changeSlSuccess"))):(a.applyOptions({price:t}),n(_.message))})),u||(a.applyOptions({price:t}),re.show(e("trading.derivative.noChangeOrderLine")))}}function n(a){a||(a="unknown"),re.error(e(`trading.derivative.${a}`))}return(a,p)=>(H(),J("div",{ref_key:"orderToolRef",ref:$,class:"cancel-order command",title:a.$t("trading.derivative.orderTool"),onClick:r},[M("i",{class:ae(["far fa-trash-alt",{blink:d.value}])},null,2)],8,yi))}};const xi=["title"],Ci=["title"],ki=["title"],_i=["title"],bi="wss://tradestation.fireant.vn/quote?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",wi="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",Oi={__name:"Chart",setup(P,{expose:I}){const C=me(),f=xt(),{t:e}=Oe(),s=fe("devices"),x=fe("mf"),T=fe("filters"),$=F(null),d=F(null),m=F(null),S=F(null),N=F(null),B=F(null),Z=F(null),W=F(null),A=F(null),l=F(null),r=F(null),v=F(null),i=F(null),o=F(null),h=F(null),g={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.25,bottom:.25}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:1e3,minBarSpacing:.01,barSpacing:.05}},k=Le(new Date,"yyyy-MM-dd"),E={START:G(new Date(`${k}T08:45:00Z`)),ATO:G(new Date(`${k}T09:00:00Z`)),ATC:G(new Date(`${k}T14:30:00Z`)),END:G(new Date(`${k}T14:45:00Z`))};let n={chart:{},whitespaces:[],crosshair:{},interval:null,interval10At:Ve(new Date,11),interval30At:Ve(new Date,31),websocket:null,socketStop:!1,vpsUpdatedAt:Ve(new Date,61)};const a=yt({prices:[],series:{},chartDate:f.query.date??k,clock:Le(new Date,"HH:mm:ss"),isSocketWarning:!1,hasOrderLine:!1,TIME:E}),p=ce(()=>C.state.tradingDerivative.status),t=ce(()=>C.state.tradingDerivative.config),y=ce(()=>C.state.tradingDerivative.isLoading),u=ce(()=>p.value.position||p.value.pending||a.hasOrderLine);n.interval=setInterval(()=>{i.value&&i.value.cancelWithoutClose(),a.clock=Le(new Date,"HH:mm:ss"),Me(new Date,new Date(n.interval10At))>10&&(ke()&&t.value.autoRefresh&&W.value.refresh(!0),n.interval10At=new Date),Me(new Date,new Date(n.interval30At))>30&&(ke()&&Xe(),n.interval30At=new Date)},1e3),ct(),Ye(()=>{_(),new ResizeObserver(se).observe($.value),document.addEventListener("keydown",te)}),et(()=>{w(),document.removeEventListener("keydown",te),clearInterval(n.interval),oe(),n.socketStop=!0}),ve(()=>C.state.tradingDerivative.chartData,ie),I({connectSocket:Y});function _(){n.chart=_t(d.value,g),n.chart.subscribeCrosshairMove(X),n.chart.subscribeCustomPriceLineDragged(U),a.series.whitespace=n.chart.addHistogramSeries({priceScaleId:"whitespace",scaleMargins:{top:0,bottom:0},color:"#808080",lastValueVisible:!1,priceLineVisible:!1}),a.series.timeRange=n.chart.addHistogramSeries({priceScaleId:"timeRange",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),a.series.pickTime=n.chart.addHistogramSeries({priceScaleId:"pickTime",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),a.series.timeMark=n.chart.addHistogramSeries({priceScaleId:"timeMark",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),a.series.price=n.chart.addLineSeries({color:"#F5F5F5",priceFormat:{minMove:.1}})}function w(){n.chart&&(n.chart.remove(),n.chart=null)}function L(c){ue(),ge(!1),Z.value.isSelected()?Z.value.draw({time:n.crosshair.time}):W.value.isSelected()?W.value.draw({time:n.crosshair.time,price:Ee(n.crosshair.y)}):A.value.isSelected()?A.value.draw({time:n.crosshair.time}):l.value.isSelected()?l.value.draw({price:Ee(n.crosshair.y)}):r.value.isSelected()?r.value.draw({time:n.crosshair.time}):v.value.isSelected()&&v.value.draw({price:Ee(n.crosshair.y)})}function b(c){ge(!0),c.preventDefault()}function R(c){c.stopPropagation()}function V(c){c.preventDefault(),c.stopPropagation()}function X(c){if(c.time){let O=c.seriesPrices.get(a.series.price);n.crosshair.time=c.time,n.crosshair.price=O}else s.phone||(n.crosshair.time=null,n.crosshair.price=null);c.point!==void 0&&(n.crosshair.x=c.point.x,n.crosshair.y=c.point.y)}function U(c){let O=c.customPriceLine,D=O.options();D.price=x.fmtNum(D.price);const z=+c.fromPriceString,K=D.price;switch(D.lineType){case"order":i.value.drag({line:O,lineOptions:D,oldPrice:z,newPrice:K});break;case"line":l.value.drag({lineOptions:D,oldPrice:z,newPrice:K});break;case"target":v.value.drag({lineOptions:D,newPrice:K});break;case"pattern":W.value.drag({lineOptions:D});break}}function se(){$.value&&(n.chart.resize($.value.offsetWidth,$.value.offsetHeight),$.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function te(c){if(c.ctrlKey)switch(c.keyCode){case 219:n.chart.timeScale().applyOptions({barSpacing:n.chart.options().timeScale.barSpacing-.01});break;case 221:n.chart.timeScale().applyOptions({barSpacing:n.chart.options().timeScale.barSpacing+.01});break}if(c.altKey)switch(c.keyCode){case 219:n.chart.timeScale().scrollToPosition(n.chart.timeScale().scrollPosition()-50);break;case 221:n.chart.timeScale().scrollToPosition(n.chart.timeScale().scrollPosition()+50);break}}function ie(c){a.chartDate===k&&ke()||(c.price.length>0&&(n.whitespaces=Q(n.whitespaces,j(a.chartDate))),a.series.whitespace.setData(n.whitespaces),a.prices=Q(a.prices,c.price),a.series.price.setData(a.prices))}function ne(c,O=null){const D=O??t.value.source;let z=[];c.forEach(K=>{let pe,de;D==="FireAnt"?(pe=G(_e(new Date(K.date),7)),de=K.price):(pe=G(new Date(`${k}T${K.time}Z`)),de=K.lastPrice),z.push({time:pe,value:de})}),z.length>1?(a.prices=Q(a.prices,z),a.series.price.setData(a.prices)):(a.prices.push(z[0]),a.series.price.update(z[0]))}function j(c){const O=G(new Date(`${c}T09:00:00Z`)),D=G(new Date(`${c}T11:30:00Z`)),z=G(new Date(`${c}T13:00:00Z`)),K=G(new Date(`${c}T14:30:00Z`)),pe=G(new Date(`${c}T14:00:00Z`));let de=[];for(let Se=O;Se<=K;Se++){if(Se>D&&Se<z)continue;let qe={time:Se};(Se===pe||Se===K)&&(qe.value=1),de.push(qe)}return de}function Q(c,O){return Array.from(new Map([...c,...O].sort((D,z)=>D.time-z.time).map(D=>[D.time,D])).values())}async function Y(){if(ke()){await oe();const c=t.value.source==="FireAnt",O=c?bi:wi;n.websocket=new WebSocket(O),n.websocket.onclose=D=>{n.socketStop||(a.isSocketWarning=!0,Y())},c?Pe():(q(),he())}}async function oe(){n.websocket&&n.websocket.readyState===WebSocket.OPEN&&(n.websocket.close(),await new Promise(c=>{const O=setInterval(()=>{(!n.websocket||n.websocket.readyState===WebSocket.CLOSED)&&(n.websocket=null,clearInterval(O),c())},100)}))}function Pe(){C.dispatch("tradingDerivative/setLoading",!0),n.websocket.onopen=c=>{if(n.websocket.readyState===WebSocket.OPEN){let O='{"protocol":"json","version":1}';n.websocket.send(O),O='{"arguments":["VN30F1M"],"invocationId":"0","target":"SubscribeTrades","type":1}',n.websocket.send(O)}},n.websocket.onmessage=c=>{a.isSocketWarning=!1,le(c.data).forEach(D=>{if(!D)return!1;D.type===3?(D.result[0].date.slice(0,10)===k&&(Re(),n.whitespaces=Q(n.whitespaces,j(k)),a.series.whitespace.setData(n.whitespaces),ne(D.result)),C.dispatch("tradingDerivative/setLoading",!1)):D.type===1&&D.target==="UpdateTrades"&&D.arguments[0]==="VN30F1M"&&(console.log("FireAnt",D.arguments[1]),i.value.scan(D.arguments[1].at(-1).price),ne(D.arguments[1]))})}}function le(c){let O=[];return c.split("").forEach(D=>{const z=D.indexOf("{"),K=D.lastIndexOf("}");let pe=null;if(z!==-1&&K!==-1&&K>z){const de=D.substring(z,K+1);de!=="{}"&&(pe=JSON.parse(de))}O.push(pe)}),O}function he(){n.websocket.onopen=c=>{if(n.websocket.readyState===WebSocket.OPEN){const O={action:"join",list:t.value.vn30f1m},D=`42${JSON.stringify(["regs",JSON.stringify(O)])}`;n.websocket.send(D)}},n.websocket.onmessage=c=>{if(a.isSocketWarning=!1,c.data.substr(0,1)==="4"&&c.data.substr(1,1)==="2"){const O=JSON.parse(c.data.substr(2));if(O[0]==="stockps"){const D=O[1].data;D.id===3220&&(console.log("VPS",D),i.value.scan(D.lastPrice),ne([D]))}}}}function q(){Me(new Date,new Date(n.vpsUpdatedAt))>60&&(fetch("https://bddatafeed.vps.com.vn/getpschartintraday/VN30F1M").then(c=>c.json()).then(c=>{console.log(c),ne(c,"VPS")}),n.vpsUpdatedAt=new Date)}function Ce(){W.value.refresh()}function He(c){W.value.load(c,{isSave:!0})}function ue(){B.value.hide(),Z.value.hide(),l.value.hide()}function Je(c){B.value.set(c)}function $e(c){a.hasOrderLine=c}function ge(c){c?i.value.show({price:Ee(n.crosshair.y)}):(o.value.style.display="none",h.value.style.display="none")}function Ie({side:c,price:O}){o.value.style.left=+(n.crosshair.x+(n.crosshair.x>innerWidth-71?-71:1))+"px",o.value.style.top=+(n.crosshair.y+(n.crosshair.y>innerHeight-61?-61:1))+"px",o.value.style.background=c>0?"green":"red",o.value.innerText=`${c>0?"LONG":"SHORT"} ${O}`,o.value.style.display="block"}function Ae({side:c}){h.value.style.left=+(n.crosshair.x+(n.crosshair.x>innerWidth-61?-61:1))+"px",h.value.style.top=+(n.crosshair.y+(n.crosshair.y>innerHeight-51?-51:1))+"px",h.value.style.background=c>0?"green":"red",h.value.style.display="block"}function we(){i.value.entry()}function De(){i.value.tpsl()}function Ne(){n.chart.timeScale().scrollToRealTime()}function ke(){const c=G(_e(new Date,7));return t.value.openingMarket&&c>=E.START&&c<=E.END}function ot(){if(!a.chartDate)return!1;Be()}function at(){n.whitespaces=[],a.prices=[],Y(),Be()}function ct(){C.dispatch("tradingDerivative/initChart").then(()=>{Y(),!f.query.date&&t.value.lastOpeningDate&&(a.chartDate=t.value.lastOpeningDate),Be()})}function Be(){C.dispatch("tradingDerivative/getChartData",a.chartDate).then(c=>{c&&Re()})}function Xe(){C.dispatch("tradingDerivative/getStatus")}function Re(){C.dispatch("tradingDerivative/getTools")}function lt(){C.dispatch("tradingDerivative/getAccountInfo").then(c=>{let O="";O+='<div style="width: 200px;">',O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.nav")}</div><div>: ${T.currency(c.nav)}</div></div>`,O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.maxVol")}</div><div>: ${T.numberVnFormat(c.maxVol)}</div></div>`,O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.vm")}</div><div>: ${T.currency(c.vm)}</div></div>`,O+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${e("trading.derivative.fee")}</div><div>: ${T.currency(c.fee)}</div></div>`,O+="</div>",Ct(O,e("trading.derivative.accountInfo"))})}function Ee(c){return x.fmtNum(a.series.price.coordinateToPrice(c))}function Fe(c){let O=n.whitespaces.findIndex(D=>D.time===c);if(O===-1){const D=Le(new Date(c*1e3),"yyyy-MM-dd"),z=G(new Date(`${D}T11:30:00Z`)),K=G(new Date(`${D}T13:00:00Z`)),pe=G(new Date(`${D}T14:30:00Z`));c>z&&c<K?c=z:c>pe&&(c=pe),O=n.whitespaces.findIndex(de=>de.time===c)}return O}function je(c){return c<n.whitespaces.length?n.whitespaces[c].time:!1}return(c,O)=>(H(),J("div",{class:"derivative-chart",ref_key:"chartContainerRef",ref:$,onClick:L,onContextmenu:b},[M("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:d},[M("div",{class:"area data-area",onClick:R,onContextmenu:V},[M("div",{ref_key:"connectionRef",ref:m,class:ae(["command",{yellow:p.value.pending,red:t.value.volInvalid}]),title:c.$t("trading.derivative.connection"),onClick:Xe},[M("i",{class:ae(["far",{"fa-link-simple":p.value.connection,"fa-link-simple-slash":!p.value.connection,blink:a.isSocketWarning}])},null,2)],10,xi),M("div",{class:ae(["command status",{green:p.value.position>0,red:p.value.position<0}]),title:c.$t("trading.derivative.position"),onClick:lt},ye(p.value.position),11,Ci),M("div",{class:"command clock",onClick:Y},ye(a.clock),1),Te(M("input",{type:"date",class:"chart-date command",title:c.$t("trading.derivative.date"),"onUpdate:modelValue":O[0]||(O[0]=D=>a.chartDate=D),onChange:ot},null,40,ki),[[Tt,a.chartDate]]),M("div",{ref_key:"reloadToolRef",ref:S,class:"command",title:c.$t("trading.derivative.reload"),onClick:at,onContextmenu:Re},[M("i",{class:ae(["far fa-sync-alt",{"fa-spin":y.value}])},null,2)],40,_i)],32),M("div",{class:"area tool-area",onClick:R,onContextmenu:V},[ee(Dt,{chartContainerRef:$.value},null,8,["chartContainerRef"]),ee(Lt,{ref_key:"tradingviewToolRef",ref:N,vpsUser:t.value.vpsUser,vpsSession:t.value.vpsSession,chartContainerRef:$.value},null,8,["vpsUser","vpsSession","chartContainerRef"]),ee(Nt,{ref_key:"progressToolRef",ref:B,onRefreshPattern:Ce,onHideContext:ue},null,512),ee(Xt,{ref_key:"scanToolRef",ref:Z,prices:a.prices,timeToIndex:Fe,onScaned:He,onRemovePattern:O[1]||(O[1]=()=>W.value.remove()),onHideContext:ue},null,8,["prices"]),ee(Qt,{ref_key:"patternToolRef",ref:W,prices:a.prices,priceSeries:a.series.price,timeMarkSeries:a.series.timeMark,pickTimeToolRef:A.value,timeToIndex:Fe,indexToTime:je,onSetProgress:Je,onHideContext:ue},null,8,["prices","priceSeries","timeMarkSeries","pickTimeToolRef"]),ee(ti,{ref_key:"pickTimeToolRef",ref:A,pickTimeSeries:a.series.pickTime,onRefreshPattern:Ce,onHideContext:ue},null,8,["pickTimeSeries"]),ee(pi,{ref_key:"lineToolRef",ref:l,priceSeries:a.series.price,onHideContext:ue},null,8,["priceSeries"]),ee(mi,{ref_key:"timeRangeToolRef",ref:r,timeRangeSeries:a.series.timeRange,timeToIndex:Fe,indexToTime:je,onHideContext:ue},null,8,["timeRangeSeries"]),ee(Si,{ref_key:"targetToolRef",ref:v,priceSeries:a.series.price,onHideContext:ue},null,8,["priceSeries"]),Te(ee(Ti,{ref_key:"orderToolRef",ref:i,position:p.value.position,prices:a.prices,priceSeries:a.series.price,inSession:ke,TIME:a.TIME,onGetTools:Re,onShowEntry:Ie,onShowTpSl:Ae,onOrderChanged:$e,onHideContext:ue},null,8,["position","prices","priceSeries","TIME"]),[[be,u.value]])],32),M("div",null,[M("div",{ref_key:"entryOrderRef",ref:o,class:"order-button entry",onClick:we}," Entry ",512),M("div",{ref_key:"tpslOrderRef",ref:h,class:"order-button tpsl",onClick:De}," TP/SL ",512),M("div",{class:"chart-top command far fa-angle-double-right",onClick:Ne})])],512)],544))}};export{Oi as default};
