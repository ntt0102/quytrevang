import{bW as A,u as T,r as q,a as L,y as G,x as N,b as v,e as a,P as z,f as i,g as n,q as O,d as l,v as K,h as V,j as W,i as X,k as R,bX as j,m as U,o as _,t as p,O as F,z as u,D as B,s as w}from"./app-Bw8pdpy0.js";const J={class:"login-form"},H={key:0,class:"user"},Q={style:{display:"flex","align-items":"center"}},Y=["alt","src"],Z={style:{"font-size":"16px",padding:"5px"}},ee={class:"fingerprint"},te={class:"link"},se={class:"create-account"},re={__name:"Login",setup(ae){const b=V(),x=W(),y=X(),{cookies:g}=A(),{t:c}=T(),h=R("mc"),k=R("mt"),C=j().appContext.config.globalProperties.$screen.getScreenSizeInfo,m=q(null),e=L({loggedinUsers:[],formData:{username:null,password:null,rememberMe:!1,avatar:null,name:null},validationRules:{username:[{type:"required",message:c("models.user.username")+k.validations.required}],password:[{type:"required",message:c("models.user.password")+k.validations.required}]}});let f=!0;e.loggedinUsers=I(),e.loggedinUsers.length>0&&(e.loggedinUsers.reverse(),e.formData={...e.formData,...e.loggedinUsers[0]}),G(()=>{C.isXSmall&&e.formData.webauthn?D():setTimeout(()=>m.value.instance.getEditor(e.formData.name?"password":"username").focus(),500)});function M(){b.dispatch("auth/login",e.formData).then(({isOk:t,isMaintenance:s,user:o})=>E(t,s,o))}function D(){e.formData.username?b.dispatch("auth/loginWebAuthn",e.formData.username).then(({isOk:t,isMaintenance:s,user:o})=>E(t,s,o)).catch(()=>N.show(c("messages.warning.unregisteredFingerPrint"))):N.show(c("messages.warning.fingerUsernameEmpty"))}function E(t,s,o){if(t)if(P(o),s)y.push({name:"setting-command"});else{let r=x.query;const d=r.redirect?r.redirect:"overview";delete r.redirect,y.push({name:d,query:r,hash:x.hash})}}function S(){m.value.instance.itemOption("password",{editorOptions:{mode:f?"text":"password",buttons:[{options:{icon:f?"far fa-eye-slash":"far fa-eye",onClick:S},name:"btPw",location:"after"}]}}),f=!f}function I(){return g.isKey(h.LOGGEDIN_USERS_COOKIE_NAME)?JSON.parse(g.get(h.LOGGEDIN_USERS_COOKIE_NAME)):[]}function P(t){let s=I();s=s.filter(o=>o.username!=t.username),s.push(t),s=s.slice(-5),g.set(h.LOGGEDIN_USERS_COOKIE_NAME,JSON.stringify(s),"1y")}function $(t){t.itemData.username?(e.formData={...e.formData,...t.itemData},C.isXSmall&&t.itemData.webauthn?D():setTimeout(()=>m.value.instance.getEditor("password").focus(),500)):(e.formData.username=null,e.formData.name=null,e.formData.avatar=null,setTimeout(()=>m.value.instance.getEditor("username").focus(),500))}return(t,s)=>{const o=U("DxButton"),r=U("RouterLink");return _(),v("div",J,[e.formData.name?(_(),v("div",H,[a(z,{images:[e.formData.avatar]},null,8,["images"]),a(n(F),{"split-button":!0,"use-select-mode":!1,items:[...e.loggedinUsers,{name:t.$t("auth.login.anotherAccount")}],text:e.formData.name,"display-expr":"name","key-expr":"username",itemTemplate:"itemTemplate",dropDownOptions:{minWidth:260,wrapperAttr:{class:"login-users-popup"}},onItemClick:$},{itemTemplate:i(({data:d})=>[l("div",Q,[d.avatar?(_(),v("img",{key:0,alt:t.$appName,src:d.avatar,style:{width:"30px","border-radius":"50%","margin-right":"5px"}},null,8,Y)):O("",!0),l("span",Z,p(d.name),1)])]),_:1},8,["items","text"])])):O("",!0),l("form",{onSubmit:K(M,["prevent"])},[a(n(B),{ref_key:"formRef",ref:m,"form-data":e.formData,labelMode:"floating"},{default:i(()=>[a(n(u.DxItem),{visible:!e.formData.name,"data-field":"username","editor-type":"dxTextBox","validation-rules":e.validationRules.username,label:{text:t.$t("models.user.username")}},null,8,["visible","validation-rules","label"]),a(n(u.DxItem),{name:"password","data-field":"password","editor-type":"dxTextBox","editor-options":{mode:"password",buttons:[{options:{icon:"far fa-eye",onClick:S},name:"btPw",location:"after"}]},"validation-rules":e.validationRules.password,label:{text:t.$t("models.user.password")}},null,8,["editor-options","validation-rules","label"]),a(n(u.DxItem),{"data-field":"rememberMe","editor-type":"dxCheckBox","editor-options":{text:t.$t("auth.login.rememberMe"),elementAttr:{class:"form-text"}},label:{visible:!1}},null,8,["editor-options"]),a(n(u.DxItem),{"item-type":"button","button-options":{width:"100%",type:"default",text:t.$t("auth.login.submit"),useSubmitBehavior:!0}},null,8,["button-options"])]),_:1},8,["form-data"])],32),l("div",ee,[a(o,{icon:"../../../images/fingerprint.png",onClick:D})]),a(n(B),null,{default:i(()=>[a(n(u.DxItem),null,{default:i(()=>[l("div",te,[a(r,{to:{name:"reset-password"}},{default:i(()=>[w(p(t.$t("auth.login.forgotPassword")),1)]),_:1})])]),_:1}),a(n(u.DxItem),null,{default:i(()=>[l("div",se,[w(p(t.$t("auth.login.haveNotAccount"))+" ",1),a(r,{to:{name:"register"}},{default:i(()=>[w(p(t.$t("auth.login.createAccount")),1)]),_:1})])]),_:1})]),_:1})])}}};export{re as default};
