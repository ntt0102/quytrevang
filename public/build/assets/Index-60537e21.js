import{y as At,u as _t,b as Et,c as Rt,i as ie,r as y,d as Dt,e as be,x as $t,z as Bt,w as Se,v as k,f as Mt,g as qt,h as m,j as oe,A as ue,t as Te,B as j,C as Nt,E as Vt,G as U,F as It,H as Le,I as Yt,o as jt}from"./app-305cb4f5.js";import Wt from"./CopyistStatusPopup-cf1f0e5d.js";import{c as Xt,_ as Ht}from"./DailyCashFlowPopup-066feba5.js";import zt from"./ColorPicker-5b315e5c.js";const Ut="/build/assets/spinner-4da4a8c6.gif";class Kt{constructor(){this.create()}create(){return new Promise((O,C)=>{const g=indexedDB.open("orderChart",1);g.onupgradeneeded=a=>{this.store=a.target.result,this.store.createObjectStore("order",{keyPath:"kind"}),this.store.createObjectStore("line",{keyPath:"price"}),this.store.createObjectStore("box",{keyPath:"point"}),this.store.createObjectStore("ruler",{keyPath:"point"}),this.store.createObjectStore("pattern1",{keyPath:"point"}),this.store.createObjectStore("pattern2",{keyPath:"point"}),this.store.createObjectStore("volprofile",{keyPath:"time"}),this.store.createObjectStore("alert",{keyPath:"price"}),this.store.createObjectStore("target",{keyPath:"price"}),O()},g.onsuccess=a=>{this.store=a.target.result,O()},g.onerror=()=>{location.reload(),C()}})}get(O){var C=this.store;return new Promise(function(a,$){var u=C.transaction(O,"readonly");if(Array.isArray(O)){var I=O.map(A=>u.objectStore(A)),v=I.map(g);Promise.all(v).then(A=>a(A))}else{var K=u.objectStore(O);g(K).then(A=>a(A))}});function g(a){return new Promise(function($,u){const I=a.getAll();I.onsuccess=v=>$(v.target.result),I.onerror=()=>u()})}}set(O,C){const g=this.store.transaction(O,"readwrite").objectStore(O);Array.isArray(C)?C.length>0&&C.forEach(a=>g.put(a)):g.put(C)}clear(O){var C=this.store;return new Promise(function(g,a){const $=C.transaction(O,"readwrite").objectStore(O).clear();$.onsuccess=()=>{g()},$.onerror=u=>{console.error(`Error to empty Object Store: ${O}`),a()}})}}const o=new Kt,Gt="/build/assets/alert-4d705e53.mp3";const Jt={class:"content-block dx-card responsive-paddings"},Zt={class:"area data-area"},Qt=["title"],er=["title"],tr=["title"],rr={class:"area tool-area"},ir=["title"],or=["title"],sr=["title"],ar=["title"],nr=["title"],lr=["title"],cr=["title"],dr=["title"],pr=["title"],ur=["title"],fr=["title"],hr=["title"],mr=["src"],we=3,Fe=2,gr="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",vr=120,yr={__name:"Index",setup(Ae){const O={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.05,bottom:.4}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:20,minBarSpacing:.01}},C=moment().format("YYYY-MM-DD"),g={START:moment(C+" 08:45:00").unix(),ATO:moment(C+" 09:00:00").unix(),ATC:moment(C+" 14:30:00").unix(),END:moment(C+" 14:45:00").unix()},a=_t(),$=Et(),{t:u}=Rt(),I=ie("devices"),v=ie("mf"),K=ie("bus"),A=ie("filters"),w=y(null),fe=y(null),W=y(null),he=y(null),me=y(null),ge=y(null),ve=y(null),_e=y(null),X=y(null),G=y(null),se=y(null),ae=y(null),ne=y(null),J=y(null),H=y(null),B=y(null),z=y(null),Ee=y(null);let e={chart:{},series:{},data:{whitespace:[],original:[],price:[],cash:[]},order:{side:0,entry:{},tp:{},sl:{}},lines:[],ruler:{l0:{},ln1:{},l1:{},l2:{},l3:{},l4:{},pointCount:0},target:{A:{},B:{},C:{},D:{}},pattern1:{A:{},B:{},C:{},X1:{},X2:{},Y1:{},Y2:{}},pattern2:{O:{}},volprofile:{v1:{},v2:{},poc:{},pointCount:0},box:[],alerts:[],crosshair:{},shark:null,loadWhitespace:!0,interval:null,interval60:null,websocket:null,isAutoOrdering:!1,socketStop:!1,volumeMax:0,socketRefreshTime:moment()};const f=Dt({chartDate:$.query.date??C,clock:moment().format("HH:mm:ss"),isFullscreen:!1,color:"#F44336",showColorPicker:!1,showTradingView:!1}),b=be(()=>a.state.tradingOrder.status),Re=be(()=>`https://chart.vps.com.vn/tv/?loadLastChart=true&symbol=VN30F1M&u=${a.state.tradingOrder.config.vpsCode}&s=${a.state.tradingOrder.config.vpsSession}&resolution=1`);a.dispatch("tradingOrder/getConfig").then(()=>{ce()}),a.dispatch("tradingOrder/getStatus"),e.interval=setInterval(He,1e3),e.interval60=setInterval(()=>a.dispatch("tradingOrder/getStatus"),6e4),o.create(),$t(()=>{e.chart=Xt(fe.value,O),w.value.addEventListener("click",$e),w.value.addEventListener("contextmenu",De),e.chart.subscribeCrosshairMove(Be),e.chart.subscribeCustomPriceLineDragged(Me),e.series.whitespace=e.chart.addLineSeries({priceScaleId:"whitespace",visible:!1}),e.series.cash=e.chart.addLineSeries({priceScaleId:"cash",scaleMargins:{top:.61,bottom:.01},color:"yellow",lastValueVisible:!1}),e.series.price=e.chart.addLineSeries({color:"#CCCCCC",priceFormat:{minMove:.1}}),new ResizeObserver(qe).observe(w.value),document.addEventListener("keydown",Ne),document.addEventListener("fullscreenchange",Ve),a.dispatch("tradingOrder/getChartData",f.chartDate).then(()=>{Ye()})}),Bt(()=>{clearInterval(e.interval),clearInterval(e.interval60),e.socketStop=!0,e.websocket.close(),e.websocket=null}),Se(()=>a.state.tradingOrder.chartData,je),Se(()=>a.state.tradingOrder.isChartLoading,r=>{he.value.style.display=r?"block":"none"});function De(r){ze(),r.preventDefault()}function $e(){de(),X.value.classList.contains("selected")?Y():G.value.classList.contains("selected")?it():se.value.classList.contains("selected")?at():ae.value.classList.contains("selected")?ct():ne.value.classList.contains("selected")?ke():J.value.classList.contains("selected")&&mt()}function Be(r){if(r.time){let t=r.seriesPrices.get(e.series.price);e.crosshair.time=r.time,e.crosshair.price=t}else I.phone||(e.crosshair.time=null,e.crosshair.price=null);r.point!=null&&(e.crosshair.x=r.point.x,e.crosshair.y=r.point.y)}function Me(r){let t=r.customPriceLine,i=t.options();i.price=Q(i.price);const s=+r.fromPriceString,c=i.price;switch(i.lineType){case"order":if(c!=s){let d=!1;i.kind=="entry"?b.value.position||(d=!0,e.order[i.kind].price=c,a.dispatch("tradingOrder/executeOrder",{action:"entry",data:{cmd:"change",price:e.order.entry.price}}).then(n=>{n.isOk?(_(i.kind),k.success(u("trading.orderChart.changeEntrySuccess"))):(t.applyOptions({price:s}),T(n.message))})):(d=!0,e.order[i.kind].price=c,i.kind=="tp"?a.dispatch("tradingOrder/executeOrder",{action:"tp",data:{cmd:"change",price:e.order.tp.price}}).then(n=>{n.isOk?(_(i.kind),k.success(u("trading.orderChart.changeTpSuccess"))):(t.applyOptions({price:s}),T(n.message))}):a.dispatch("tradingOrder/executeOrder",{action:"sl",data:{cmd:"change",price:e.order.sl.price}}).then(n=>{n.isOk?(_(i.kind),k.success(u("trading.orderChart.changeSlSuccess"))):(t.applyOptions({price:s}),T(n.message))})),d||(t.applyOptions({price:s}),k.show(u("trading.orderChart.noChangeOrderLine")))}break;case"line":o.set("line",{price:s,removed:!0}),o.set("line",i),X.value.classList.remove("selected");break;case"ruler":switch(i.point){case"l0":if(o.set("ruler",i),e.ruler.pointCount==2){const F=+e.ruler.l1.options().title,V=+(c-F).toFixed(1);e.ruler.ln1.applyOptions({price:V}),o.set("ruler",e.ruler.ln1.options());const te=+(c+F).toFixed(1);e.ruler.l1.applyOptions({price:te}),o.set("ruler",e.ruler.l1.options());const re=+(c+F*2).toFixed(1);e.ruler.l2.applyOptions({price:re}),o.set("ruler",e.ruler.l2.options());const wt=+(c+F*3).toFixed(1);e.ruler.l3.applyOptions({price:wt}),o.set("ruler",e.ruler.l3.options());const Ft=+(c+F*4).toFixed(1);e.ruler.l4.applyOptions({price:Ft}),o.set("ruler",e.ruler.l4.options())}break;case"ln1":const d=+e.ruler.l0.options().price,n=c-d;t.applyOptions({title:n.toFixed(1)}),o.set("ruler",t.options()),e.ruler.l1.applyOptions({title:(-n).toFixed(1),price:+(d-n).toFixed(1)}),o.set("ruler",e.ruler.l1.options()),e.ruler.l2.applyOptions({title:(-n*2).toFixed(1),price:+(d-n*2).toFixed(1)}),o.set("ruler",e.ruler.l2.options()),e.ruler.l3.applyOptions({title:(-n*3).toFixed(1),price:+(d-n*3).toFixed(1)}),o.set("ruler",e.ruler.l3.options()),e.ruler.l4.applyOptions({title:(-n*4).toFixed(1),price:+(d-n*4).toFixed(1)}),o.set("ruler",e.ruler.l4.options());break;case"l1":const h=+e.ruler.l0.options().price,L=c-h;t.applyOptions({title:L.toFixed(1)}),o.set("ruler",t.options()),e.ruler.ln1.applyOptions({title:(-L).toFixed(1),price:+(h-L).toFixed(1)}),o.set("ruler",e.ruler.ln1.options()),e.ruler.l2.applyOptions({title:(L*2).toFixed(1),price:+(h+L*2).toFixed(1)}),o.set("ruler",e.ruler.l2.options()),e.ruler.l3.applyOptions({title:(L*3).toFixed(1),price:+(h+L*3).toFixed(1)}),o.set("ruler",e.ruler.l3.options()),e.ruler.l4.applyOptions({title:(L*4).toFixed(1),price:+(h+L*4).toFixed(1)}),o.set("ruler",e.ruler.l4.options());break;case"l2":const R=+e.ruler.l0.options().price,P=c-R;t.applyOptions({title:P.toFixed(1)}),o.set("ruler",t.options()),e.ruler.ln1.applyOptions({title:(-P*.5).toFixed(1),price:+(R-P*.5).toFixed(1)}),o.set("ruler",e.ruler.ln1.options()),e.ruler.l1.applyOptions({title:(P*.5).toFixed(1),price:+(R+P*.5).toFixed(1)}),o.set("ruler",e.ruler.l1.options()),e.ruler.l3.applyOptions({title:(P*1.5).toFixed(1),price:+(R+P*1.5).toFixed(1)}),o.set("ruler",e.ruler.l3.options()),e.ruler.l4.applyOptions({title:(P*2).toFixed(1),price:+(R+P*2).toFixed(1)}),o.set("ruler",e.ruler.l4.options());break;case"l3":const q=+e.ruler.l0.options().price,D=c-q;t.applyOptions({title:D.toFixed(1)}),o.set("ruler",t.options()),e.ruler.ln1.applyOptions({title:(-D/3).toFixed(1),price:+(q-D/3).toFixed(1)}),o.set("ruler",e.ruler.ln1.options()),e.ruler.l1.applyOptions({title:(D/3).toFixed(1),price:+(q+D/3).toFixed(1)}),o.set("ruler",e.ruler.l1.options()),e.ruler.l2.applyOptions({title:(D*2/3).toFixed(1),price:+(q+D*2/3).toFixed(1)}),o.set("ruler",e.ruler.l2.options());break;case"l4":const N=+e.ruler.l0.options().price,x=c-N;t.applyOptions({title:x.toFixed(1)}),o.set("ruler",t.options()),e.ruler.ln1.applyOptions({title:(-x/4).toFixed(1),price:+(N-x/4).toFixed(1)}),o.set("ruler",e.ruler.ln1.options()),e.ruler.l1.applyOptions({title:(x/4).toFixed(1),price:+(N+x/4).toFixed(1)}),o.set("ruler",e.ruler.l1.options()),e.ruler.l2.applyOptions({title:(x/2).toFixed(1),price:+(N+x/2).toFixed(1)}),o.set("ruler",e.ruler.l2.options()),e.ruler.l3.applyOptions({title:(x*3/4).toFixed(1),price:+(N+x*3/4).toFixed(1)}),o.set("ruler",e.ruler.l3.options());break}break;case"pattern1":if(v.isSet(e.pattern1.C)){const d=+e.pattern1.A.options().price,h=+e.pattern1.B.options().price-d;e.pattern1.B.applyOptions({title:h.toFixed(1)}),o.set("pattern1",e.pattern1.B.options()),e.pattern1.C.applyOptions({price:+(d+.5*h).toFixed(1),title:(.5*h).toFixed(1)}),o.set("pattern1",e.pattern1.C.options()),e.pattern1.X1.applyOptions({price:+(d-.375*h).toFixed(1),title:(-.375*h).toFixed(1)}),o.set("pattern1",e.pattern1.X1.options()),e.pattern1.X2.applyOptions({price:+(d-.5*h).toFixed(1),title:(-.5*h).toFixed(1)}),o.set("pattern1",e.pattern1.X2.options()),e.pattern1.Y1.applyOptions({price:+(d-h).toFixed(1),title:-h.toFixed(1)}),o.set("pattern1",e.pattern1.Y1.options()),e.pattern1.Y2.applyOptions({price:+(d-2*h).toFixed(1),title:(-2*h).toFixed(1)}),o.set("pattern1",e.pattern1.Y2.options())}break;case"pattern2":if(v.isSet(e.pattern2.T)){const d=e.pattern2.E.options(),n=+d.price1,h=+d.price2,L=+d.price3,R=+d.price4,P=+d.price,q=L-h,D=n-R,N=L-R,x=P-R;let F,V;i.point=="S"?(V=+e.pattern2.S.options().price,F=P-V):(F=Math.abs(q)>Math.abs(x/2)?q:x/2,V=P-F,e.pattern2.S.applyOptions({price:+V.toFixed(1)}));const te=V+(Math.abs(x)>Math.abs(N)?Math.abs(x)>Math.abs(D)?1:1.5:2)*x,re=te-P;e.pattern2.S.applyOptions({title:`SL=${(-F).toFixed(1)}`}),o.set("pattern2",e.pattern2.S.options()),e.pattern2.E.applyOptions({title:`RR=${(re/F).toFixed(1)}`}),o.set("pattern2",e.pattern2.E.options()),e.pattern2.T.applyOptions({price:+te.toFixed(1),title:`TP=${re.toFixed(1)}`}),o.set("pattern2",e.pattern2.T.options())}break;case"alert":o.set("alert",{price:s,removed:!0});const l=e.data.price.slice(-1)[0].value;let p=c>=l?">":"<";t.applyOptions({title:p}),o.set("alert",t.options()),J.value.classList.remove("selected");break}}function qe(){w.value&&(e.chart.resize(w.value.offsetWidth,w.value.offsetHeight),w.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function Ne(r){if(r.ctrlKey||r.metaKey)switch(r.keyCode){case 38:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing+.05});break;case 40:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing-.05});break;case 37:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()-10);break;case 39:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()+10);break;case 96:G.value.click();break;case 97:X.value.click();break;case 98:ge.value.click();break;case 99:me.value.click();case 100:ve.value.click();break}}function Ve(){w.value&&(document.fullscreenElement?(f.isFullscreen=!0,w.value.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(f.isFullscreen=!1,w.value.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}function Ie(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function Ye(){return new Promise(async r=>{b.value.pending&&((await o.get("order")).map(h=>{e.order.side=h.side,e.order[h.kind].price=h.price,_(h.kind),E(!0)}),e.order.tp.hasOwnProperty("line")&&e.order.entry.line.applyOptions({draggable:!1})),(await o.get("line")).forEach(n=>{n.removed||e.lines.push(e.series.price.createPriceLine(n))});const i=await o.get("box");i.length==2&&(e.box=i,e.series.box.setData([i[0].x,i[1].x]),e.box[0].y=e.series.price.createPriceLine(i[0].y),e.box[1].y=e.series.price.createPriceLine(i[1].y));const s=await o.get("ruler");s.length>0&&(e.ruler.pointCount=s.length>1?2:1,s.forEach(n=>{e.ruler[n.point]=e.series.price.createPriceLine(n)}));const c=await o.get("target");c.length>0&&c.forEach(n=>{e.target[n.point]=e.series.cash.createPriceLine(n)});const l=await o.get("pattern1");l.length>0&&l.forEach(n=>{e.pattern1[n.point]=e.series.price.createPriceLine(n)});const p=await o.get("pattern2");p.length>0&&p.forEach(n=>{e.pattern2[n.point]=e.series.price.createPriceLine(n)}),(await o.get("alert")).forEach(n=>{n.removed||e.alerts.push(e.series.price.createPriceLine(n))}),r()})}function je(){e.loadWhitespace&&(a.state.tradingOrder.chartData.length>0&&(e.data.whitespace=le(e.data.whitespace,Xe())),e.series.whitespace.setData(e.data.whitespace),e.loadWhitespace=!1),e.data.original=le(a.state.tradingOrder.chartData,e.data.original);let r=e.data.original.reduce((t,i)=>{let s=i.price,c=0;t.price.length>0&&(s=t.price.slice(-1)[0].value,c=t.cash.slice(-1)[0].value);const l=i.price-s,p=l>0?1:l<0?-1:0;return t.price.push({time:i.time,value:i.price}),t.cash.push({time:i.time,value:c+p*i.volume}),t},{price:[],cash:[]});e.data.price=r.price,e.series.price.setData(r.price),e.data.cash=r.cash,e.series.cash.setData(r.cash)}function We(r){const t=e.data.original.length;if(e.data.original=le(e.data.original,[r]),e.data.original.length>t){const i=e.data.price.slice(-1)[0].value,s=e.data.cash.slice(-1)[0].value,c=r.price-i,l=c>0?1:c<0?-1:0;e.data.price.push({time:r.time,value:r.price}),e.series.price.setData(e.data.price),e.data.cash.push({time:r.time,value:s+l*r.volume}),e.series.cash.setData(e.data.cash)}}function Xe(){const r=f.chartDate,t=moment(`${r} 09:00:00`).unix(),i=moment(`${r} 11:30:00`).unix(),s=moment(`${r} 13:00:00`).unix(),c=moment(`${r} 14:30:00`).unix();let l=[],p;for(p=t;p<=i;p++)l.push({time:p+7*60*60});for(p=s;p<=c;p++)l.push({time:p+7*60*60});return l}function le(r,t){return Array.from(new Map([...r,...t].sort((i,s)=>i.time-s.time).map(i=>[i.time,i])).values())}function ce(){e.websocket=new WebSocket(gr),e.websocket.onopen=r=>{let t={action:"join",list:a.state.tradingOrder.config.symbol};e.websocket.send(`42${JSON.stringify(["regs",JSON.stringify(t)])}`)},e.websocket.onclose=r=>{if(e.socketStop)return!1;Z()&&(ye(!0),ce(),moment().diff(e.socketRefreshTime,"seconds")>vr&&pe())},e.websocket.onmessage=r=>{if(ye(!1),r.data.substr(0,1)==4&&r.data.substr(1,1)==2){const t=JSON.parse(r.data.substr(2));if(t[0]=="stockps"){const i=t[1].data;i.id==3220&&(e.data.original.length>0&&We({time:moment(`${C} ${i.time}`).unix()+7*60*60,price:i.lastPrice,volume:i.lastVol}),xt(),Ot())}}}}function He(){const r=moment().unix();Z(r)&&(b.value.position&&r>g.ATC-5*60&&(Ue(),r>g.ATC-15&&e.order.tp.hasOwnProperty("line")&&a.dispatch("tradingOrder/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(t=>{t.isOk?(S("entry"),S("tp"),S("sl"),E(!1),o.clear("order"),k.success(u("trading.orderChart.autoCancelTpSlSuccess")),ee()):T(t.message)})),r==g.START&&ce()),f.clock=moment().format("HH:mm:ss")}function ze(){if(a.state.tradingOrder.config.openingMarket){const r=moment().unix();if(Z(r)&&(e.order.tp.hasOwnProperty("line")||b.value.position&&r>g.ATO&&r<g.ATC&&(e.order.entry.price=e.data.price.slice(-1)[0].value,e.order.side=b.value.position,z.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-61?-61:1))+"px",z.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-51?-51:1))+"px",z.value.style.display="block"),!e.order.entry.hasOwnProperty("line"))){let t=null,i=0;b.value.position?(r<g.ATO?t="ATO":r>g.ATC&&(t="ATC"),t&&(e.order.entry.price=t,i=-b.value.position)):r>g.ATO&&r<g.ATC&&(t=M(e.crosshair.y),i=t>=e.data.price.slice(-1)[0].value?1:-1,e.order.side=i,e.order.entry.price=t),i&&(B.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-71?-71:1))+"px",B.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-61?-61:1))+"px",B.value.style.background=i>0?"green":"red",B.value.innerText=`${i>0?"LONG":"SHORT"} ${t}`,B.value.style.display="block")}}}function de(){B.value.style.display="none",z.value.style.display="none"}function E(r){H.value.style.display=r?"block":"none"}function Ue(){H.value.classList.contains("blink")||H.value.classList.add("blink")}function ye(r){r?W.value.classList.contains("blink")||W.value.classList.add("blink"):W.value.classList.contains("blink")&&W.value.classList.remove("blink")}function _(r){let t,i;switch(r){case"entry":t="yellow",i=e.order.side>0?"LONG":"SHORT";break;case"tp":t="lime",i=Math.abs(e.order.tp.price-e.order.entry.price).toFixed(1);break;case"sl":t="red",i=Math.abs(e.order.sl.price-e.order.entry.price).toFixed(1);break}e.order[r].hasOwnProperty("line")?e.order[r].line.applyOptions({price:e.order[r].price,title:i}):e.order[r].line=e.series.price.createPriceLine({lineType:"order",kind:r,price:e.order[r].price,color:t,lineWidth:1,lineStyle:0,title:i,draggable:!0}),o.set("order",{kind:r,price:+e.order[r].price,side:e.order.side})}function S(r){e.order[r].hasOwnProperty("line")&&(e.series.price.removePriceLine(e.order[r].line),delete e.order[r].line)}function Ke(r){f.showTradingView=!f.showTradingView,r.stopPropagation()}function Ge(r){f.showColorPicker=!f.showColorPicker,r.stopPropagation()}function Je(r){v.isSet(e.pattern1.X)&&(Y(+e.pattern1.X.options().price),Y(+e.pattern1.Y.options().price),Y(+e.pattern1.Z.options().price),Y(+e.pattern1.T.options().price)),r.preventDefault(),r.stopPropagation()}function Ze(r){f.showColorPicker=!1;const t=r.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),t||r.target.classList.add("selected"),r.stopPropagation()}function Qe(r){et(),r.target.classList.remove("selected"),r.preventDefault(),r.stopPropagation()}function Y(r=null,t=!1,i=!1){const s="line";r||(r=Q(M(e.crosshair.y)));const c=e.lines.length;if(e.lines=e.lines.filter(l=>{const p=l.options(),d=p.type=r==+p.price;return d&&(e.series.price.removePriceLine(l),o.set("line",{price:r,removed:!0})),!d}),e.lines.length==c&&!i||t){const l={lineType:s,price:r,color:f.color,lineWidth:1,lineStyle:1,draggable:!0};e.lines.push(e.series.price.createPriceLine(l)),o.set("line",l)}X.value.classList.remove("selected")}function et(){e.lines.forEach(r=>e.series.price.removePriceLine(r)),e.lines=[],o.clear("line")}function tt(r){f.showColorPicker=!1;const t=r.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),t||(r.target.classList.add("selected"),Ce()),r.stopPropagation()}function rt(r){Ce(),r.target.classList.remove("selected"),r.preventDefault(),r.stopPropagation()}function it(){const r=M(e.crosshair.y);let t={lineType:"ruler",price:r,lineWidth:1,lineStyle:1,draggable:!0};if(e.ruler.pointCount==0)t.point="l0",t.color="#F44336",t.title="0",e.ruler[t.point]=e.series.price.createPriceLine(t),e.ruler.pointCount++,o.set("ruler",t);else{const i=+e.ruler.l0.options().price,s=r-i;t.point="l1",t.color="#FF9800",t.title=s.toFixed(1),e.ruler[t.point]=e.series.price.createPriceLine(t),o.set("ruler",t);const c=-s;t.point="ln1",t.color="#FF9800",t.title=c.toFixed(1),t.price=+(i+c).toFixed(1),e.ruler[t.point]=e.series.price.createPriceLine(t),o.set("ruler",t);const l=2*s;t.point="l2",t.color="#FFEB3B",t.title=l.toFixed(1),t.price=+(i+l).toFixed(1),e.ruler[t.point]=e.series.price.createPriceLine(t),o.set("ruler",t);const p=3*s;t.point="l3",t.color="#4CAF50",t.title=p.toFixed(1),t.price=+(i+p).toFixed(1),e.ruler[t.point]=e.series.price.createPriceLine(t),o.set("ruler",t);const d=4*s;t.point="l4",t.color="#009688",t.title=d.toFixed(1),t.price=+(i+d).toFixed(1),e.ruler[t.point]=e.series.price.createPriceLine(t),o.set("ruler",t),e.ruler.pointCount++,G.value.classList.remove("selected")}}function Ce(){e.ruler.pointCount>0&&(e.series.price.removePriceLine(e.ruler.l0),e.ruler.pointCount>1&&(e.series.price.removePriceLine(e.ruler.ln1),e.series.price.removePriceLine(e.ruler.l1),e.series.price.removePriceLine(e.ruler.l2),e.series.price.removePriceLine(e.ruler.l3),e.series.price.removePriceLine(e.ruler.l4)),e.ruler={l0:{},ln1:{},l1:{},l2:{},l3:{},l4:{},pointCount:0},o.clear("ruler"))}function ot(r){f.showColorPicker=!1;const t=r.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),t||(r.target.classList.add("selected"),Oe()),r.stopPropagation()}function st(r){Oe(),r.target.classList.remove("selected"),r.preventDefault(),r.stopPropagation()}function at(){let t={lineType:"target",price:M(e.crosshair.y,"cash"),lineWidth:1,lineStyle:0,draggable:!1,axisLabelVisible:!1};if(v.isSet(e.target.A)?v.isSet(e.target.B)?(t.point="C",t.title="C",t.color="#9C27B0"):(t.point="B",t.title="B",t.color="#E91E63"):(t.point="A",t.title="A",t.color="#E91E63"),e.target[t.point]=e.series.cash.createPriceLine(t),o.set("target",t),t.point=="C"){const i=+e.target.A.options().price,s=+e.target.B.options().price,c=+e.target.C.options().price;t.point="D",t.price=+(c+s-i).toFixed(1),t.title="D",t.color="#9C27B0",e.target[t.point]=e.series.cash.createPriceLine(t),o.set("target",t),se.value.classList.remove("selected")}}function Oe(){v.isSet(e.target.A)&&(e.series.cash.removePriceLine(e.target.A),v.isSet(e.target.B)&&(e.series.cash.removePriceLine(e.target.B),v.isSet(e.target.C)&&(e.series.cash.removePriceLine(e.target.C),e.series.cash.removePriceLine(e.target.D))),e.target={A:{},B:{},C:{},D:{}},o.clear("target"))}function nt(r){f.showColorPicker=!1;const t=r.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),t||(r.target.classList.add("selected"),xe()),r.stopPropagation()}function lt(r){xe(),r.target.classList.remove("selected"),r.preventDefault(),r.stopPropagation()}function ct(){const r=M(e.crosshair.y);let t={lineType:"pattern1",price:r,lineWidth:1,lineStyle:1,draggable:!0};if(v.isSet(e.pattern1.A)){const i=+e.pattern1.A.options().price,s=r-i;t.point="B",t.title=s.toFixed(1),t.color="#009688",e.pattern1[t.point]=e.series.price.createPriceLine(t),o.set("pattern1",t),t.point="C",t.price=+(i+.5*s).toFixed(1),t.title=(.5*s).toFixed(1),t.color="#009688",t.draggable=!1,e.pattern1[t.point]=e.series.price.createPriceLine(t),o.set("pattern1",t),t.point="X1",t.price=+(i-.375*s).toFixed(1),t.title=(-.375*s).toFixed(1),t.color="#2196F3",e.pattern1[t.point]=e.series.price.createPriceLine(t),o.set("pattern1",t),t.point="X2",t.price=+(i-.5*s).toFixed(1),t.title=(-.5*s).toFixed(1),t.color="#2196F3",e.pattern1[t.point]=e.series.price.createPriceLine(t),o.set("pattern1",t),t.point="Y1",t.price=+(i-s).toFixed(1),t.title=-s.toFixed(1),t.color="#673AB7",e.pattern1[t.point]=e.series.price.createPriceLine(t),o.set("pattern1",t),t.point="Y2",t.price=+(i-2*s).toFixed(1),t.title=(-2*s).toFixed(1),t.color="#673AB7",e.pattern1[t.point]=e.series.price.createPriceLine(t),o.set("pattern1",t),ae.value.classList.remove("selected")}else t.point="A",t.title="0",t.color="#009688",e.pattern1[t.point]=e.series.price.createPriceLine(t),o.set("pattern1",t)}function xe(){v.isSet(e.pattern1.A)&&(e.series.price.removePriceLine(e.pattern1.A),v.isSet(e.pattern1.B)&&(e.series.price.removePriceLine(e.pattern1.B),e.series.price.removePriceLine(e.pattern1.C),e.series.price.removePriceLine(e.pattern1.X1),e.series.price.removePriceLine(e.pattern1.X2),e.series.price.removePriceLine(e.pattern1.Y1),e.series.price.removePriceLine(e.pattern1.Y2)),e.pattern1={A:{},B:{},C:{},X1:{},X2:{},Y1:{},Y2:{}},o.clear("pattern1"))}function dt(r){f.showColorPicker=!1;const t=r.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),t||(r.target.classList.add("selected"),ke(!0)),r.stopPropagation()}function pt(r){Pe(),r.target.classList.remove("selected"),r.preventDefault(),r.stopPropagation()}function ke(r=!1){let t={};if(v.isSet(e.pattern2.O)){const d=e.pattern2.O.options();t={time:d.time0,value:d.price0},Pe()}else{if(r)return!1;t={time:e.crosshair.time,value:M(e.crosshair.y)}}const{price2:i,price3:s,price4:c,isAcc:l}=ut(t);console.log("price2",i),console.log("price3",s),console.log("price4",c);let p={lineType:"pattern2",lineWidth:1,lineStyle:1};console.log("isAcc",l),Y(t.value,!l,l),p.time0=t.time,p.price0=t.value,p.point="O",p.price=c,p.title="O",p.color="#2196F3",p.draggable=!1,e.pattern2[p.point]=e.series.price.createPriceLine(p),o.set("pattern2",p),ne.value.classList.remove("selected")}function ut(r){let t=r.value,i=r.value,s=r.value,c=!1;for(let l of e.data.price)if(l.time>=r.time){l.value<r.value?(t<=r.value&&l.value<t&&(t=l.value),i<=r.value&&t>r.value&&l.value<i&&(i=l.value)):l.value>r.value&&(t>=r.value&&l.value>t&&(t=l.value),i>=r.value&&t<r.value&&l.value>i&&(i=l.value));const p=l.value-i,d=r.value-i,n=t-i,h=Math.abs(d*2)>Math.abs(n/2)?d*2:n/2;if(s=+(i+h).toFixed(1),t!=r.value&&i!=r.value){if(Math.abs(p)>Math.abs(h)){c=!0;break}if(Math.abs(p)>Math.abs(d)*3)break}}return{price2:t,price3:i,price4:s,isAcc:c}}function Pe(){v.isSet(e.pattern2.O)&&(e.series.price.removePriceLine(e.pattern2.O),e.pattern2={O:{}},o.clear("pattern2"))}function ft(r){f.showColorPicker=!1;const t=r.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),t||r.target.classList.add("selected"),r.stopPropagation()}function ht(r){gt(),r.target.classList.remove("selected"),r.preventDefault(),r.stopPropagation()}function mt(){const r="alert",t=Q(M(e.crosshair.y)),i=e.alerts.length;if(e.alerts=e.alerts.filter(s=>{const c=s.options(),l=c.type=t==+c.price;return l&&(e.series.price.removePriceLine(s),o.set("alert",{price:t,removed:!0})),!l}),e.alerts.length==i){const s={lineType:r,price:t,title:t>=e.data.price.slice(-1)[0].value?">":"<",color:"red",lineWidth:1,lineStyle:1,draggable:!0};e.alerts.push(e.series.price.createPriceLine(s)),o.set("alert",s)}J.value.classList.remove("selected")}function gt(){e.alerts.forEach(r=>e.series.price.removePriceLine(r)),e.alerts=[],o.clear("alert")}async function vt(){e.order.entry.hasOwnProperty("line")&&(e.order.tp.hasOwnProperty("line")?a.dispatch("tradingOrder/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(r=>{r.isOk?(S("entry"),S("tp"),S("sl"),E(!1),o.clear("order"),k.success(u("trading.orderChart.exitSuccess"))):(E(!0),T(r.message))}):a.dispatch("tradingOrder/executeOrder",{action:"entry",data:{cmd:"delete"}}).then(r=>{r.isOk?(S("entry"),E(!1),o.clear("order"),k.success(u("trading.orderChart.deleteEntrySuccess"))):(E(!0),T(r.message))}))}function yt(){const r=moment().unix();Z(r)&&(r<g.ATO?Le(u("trading.orderChart.atoOrder"),u("titles.confirm")).then(i=>{i&&a.dispatch("tradingOrder/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(s=>{s.isOk?k.success(u("trading.orderChart.atoOrderSuccess")):T(s.message)})}):r<g.ATC?a.dispatch("tradingOrder/executeOrder",{action:"entry",data:{cmd:"new",side:e.order.side,price:e.order.entry.price}}).then(t=>{t.isOk?(_("entry"),E(!0),k.success(u("trading.orderChart.newEntrySuccess"))):T(t.message)}):Le(u("trading.orderChart.atcOrder"),u("titles.confirm")).then(i=>{i&&a.dispatch("tradingOrder/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(s=>{s.isOk?k.success(u("trading.orderChart.atcOrderSuccess")):T(s.message)})}))}function Ct(){e.order.tp.price=e.order.entry.price+e.order.side*we,e.order.sl.price=e.order.entry.price-e.order.side*Fe,a.dispatch("tradingOrder/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.order.tp.price},slData:{cmd:"new",price:e.order.sl.price}}).then(r=>{r.isOk?(_("entry"),_("tp"),_("sl"),e.order.entry.line.applyOptions({draggable:!1}),k.success(u("trading.orderChart.newTpSlSuccess"))):T(r.message)})}function Ot(){if(e.order.entry.hasOwnProperty("line")){const r=e.data.price.slice(-1)[0].value;e.order.tp.hasOwnProperty("line")?((e.order.side>0&&r>=e.order.tp.price||e.order.side<0&&r<=e.order.tp.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,a.dispatch("tradingOrder/executeOrder",{action:"sl",data:{cmd:"delete"}}).then(t=>{t.isOk?(S("entry"),S("tp"),S("sl"),E(!1),o.clear("order"),k.success(u("trading.orderChart.deleteTpSuccess")),de(),ee()):T(t.message),e.isAutoOrdering=!1}))),(e.order.side>0&&r<=e.order.sl.price||e.order.side<0&&r>=e.order.sl.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,a.dispatch("tradingOrder/executeOrder",{action:"tp",data:{cmd:"cancel"}}).then(t=>{t.isOk?(S("entry"),S("tp"),S("sl"),E(!1),o.clear("order"),k.success(u("trading.orderChart.deleteSlSuccess")),de(),ee()):T(t.message),e.isAutoOrdering=!1})))):(e.order.side>0&&r>=e.order.entry.price||e.order.side<0&&r<=e.order.entry.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,setTimeout(()=>{e.order.tp.price=e.order.entry.price+e.order.side*we,e.order.sl.price=e.order.entry.price-e.order.side*Fe,a.dispatch("tradingOrder/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.order.tp.price},slData:{cmd:"new",price:e.order.sl.price}}).then(t=>{t.isOk?(_("tp"),_("sl"),e.order.entry.line.applyOptions({draggable:!1}),k.success(u("trading.orderChart.autoNewTpSlSuccess")),ee()):T(t.message),e.isAutoOrdering=!1})},1e3)))}}function xt(){if(b.value.position&&v.isSet(e.target.X)){const r=e.data.cash.slice(-1)[0].value,t=+e.target.B.options().price,i=+e.target.X.options().price,s=i-t;(s>0&&r>=i||s<0&&r<=i)&&H.value.click()}}function kt(){e.chart.timeScale().scrollToRealTime()}function Z(r=null){return r||(r=moment().unix()),r>=g.START&&r<=g.END}function M(r,t="price"){return Q(e.series[t].coordinateToPrice(r))}function Q(r){return r?+ +r.toFixed(1):0}function T(r){r||(r="unknown"),k.error(u(`trading.orderChart.${r}`))}function Pt(){e.loadWhitespace=!0,a.dispatch("tradingOrder/getChartData",f.chartDate)}function pe(){e.socketRefreshTime=moment(),e.loadWhitespace=!0,a.dispatch("tradingOrder/getChartData",f.chartDate)}function bt(){e.data.original=[],e.data.price=[],e.data.cash=[],e.data.whitespace=[],pe()}function ee(){let r=new Audio(Gt);r.crossOrigin="anonymous",r.addEventListener("canplaythrough",function(){r.play()})}function St(){a.dispatch("tradingOrder/getAccountInfo").then(r=>{let t="";t+='<div style="width: 200px;">',t+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${u("trading.orderChart.nav")}</div><div>: ${A.currency(r.nav)}</div></div>`,t+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${u("trading.orderChart.maxVol")}</div><div>: ${A.numberVnFormat(r.maxVol)}</div></div>`,t+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${u("trading.orderChart.vm")}</div><div>: ${A.currency(r.vm)}</div></div>`,t+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${u("trading.orderChart.fee")}</div><div>: ${A.currency(r.fee)}</div></div>`,t+="</div>",Yt(t,u("trading.orderChart.accountInfo"))})}function Tt(){K.emit("checkPin",()=>a.dispatch("tradingOrder/report"))}function Lt(){K.emit("checkPin",()=>a.dispatch("tradingOrder/export"))}return(r,t)=>{const i=Mt("DxToolbar");return jt(),qt(It,null,[m("div",Jt,[oe(i,{items:[{location:"before",widget:"dxButton",options:{icon:"far fa-flag-checkered small",hint:r.$t("trading.orderChart.buttons.report"),onClick:Tt}},{location:"before",widget:"dxButton",options:{icon:"far fa-file-export small",hint:r.$t("trading.orderChart.buttons.export"),onClick:Lt}},{location:"before",widget:"dxButton",options:{icon:"far fa-chart-line small",hint:r.$t("trading.orderChart.buttons.cashflow"),onClick:()=>r.$refs.dailyCashFlowPopupRef.show()}}]},null,8,["items"]),m("div",{class:"order-chart-container",ref_key:"chartContainerRef",ref:w},[m("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:fe},[m("div",Zt,[m("div",{ref_key:"connectionRef",ref:W,class:ue(`command far fa-${b.value.connection?"link":"unlink"}`),title:r.$t("trading.orderChart.connection"),onClick:t[0]||(t[0]=()=>r.$store.dispatch("tradingOrder/getStatus"))},null,10,Qt),m("div",{class:ue(["command status",{green:b.value.position>0,red:b.value.position<0,pending:b.value.pending}]),title:r.$t("trading.orderChart.position"),onClick:St},Te(b.value.position),11,er),m("div",{class:"command clock",onClick:pe},Te(f.clock),1),j(m("input",{type:"date",class:"chart-date command",title:r.$t("trading.orderChart.date"),"onUpdate:modelValue":t[1]||(t[1]=s=>f.chartDate=s),onChange:Pt},null,40,tr),[[Nt,f.chartDate]]),m("img",{ref_key:"spinnerRef",ref:he,class:"command spinner",src:Ut},null,512)]),m("div",rr,[m("div",{ref_key:"fullscreenToolRef",ref:me,class:ue(`command far fa-${f.isFullscreen?"compress":"expand"}`),title:r.$t("trading.orderChart.fullscreen"),onClick:Ie},null,10,ir),m("div",{ref_key:"reloadToolRef",ref:ge,class:"command far fa-sync-alt",title:r.$t("trading.orderChart.reload"),onClick:bt},null,8,or),m("div",{ref_key:"tradingviewRef",ref:ve,class:"command far fa-chart-bar",title:r.$t("trading.orderChart.tradingview"),onClick:Ke},null,8,sr),m("div",{ref_key:"colorToolRef",ref:_e,class:"color command far fa-palette",style:Vt({color:f.color}),title:r.$t("trading.orderChart.colorTool"),onClick:Ge,onContextmenu:Je},[j(oe(zt,{class:"color-picker",modelValue:f.color,"onUpdate:modelValue":t[2]||(t[2]=s=>f.color=s)},null,8,["modelValue"]),[[U,f.showColorPicker]])],44,ar),m("div",{ref_key:"lineToolRef",ref:X,class:"command far fa-horizontal-rule",title:r.$t("trading.orderChart.lineTool"),onClick:Ze,onContextmenu:Qe},null,40,nr),m("div",{ref_key:"pattern1ToolRef",ref:ae,class:"command far fa-dot-circle",title:r.$t("trading.orderChart.pattern1Tool"),onClick:nt,onContextmenu:lt},null,40,lr),j(m("div",{ref_key:"pattern2ToolRef",ref:ne,class:"command far fa-heart",title:r.$t("trading.orderChart.pattern2Tool"),onClick:dt,onContextmenu:pt},null,40,cr),[[U,!1]]),m("div",{ref_key:"rulerToolRef",ref:G,class:"command far fa-line-height",title:r.$t("trading.orderChart.rulerTool"),onClick:tt,onContextmenu:rt},null,40,dr),m("div",{ref_key:"targetToolRef",ref:se,class:"command far fa-grip-lines",title:r.$t("trading.orderChart.targetTool"),onClick:ot,onContextmenu:st},null,40,pr),j(m("div",{ref_key:"alertToolRef",ref:J,class:"command far fa-alarm-exclamation",title:r.$t("trading.orderChart.alertTool"),onClick:ft,onContextmenu:ht},null,40,ur),[[U,!1]]),j(m("div",{class:"command far fa-info-circle",title:r.$t("trading.orderChart.copyistStatusPopup.title"),onClick:t[3]||(t[3]=()=>r.$refs.copyistStatusPopupRef.show())},null,8,fr),[[U,!1]]),m("div",{ref_key:"cancelOrderRef",ref:H,class:"cancel-order command far fa-trash-alt",title:r.$t("trading.orderChart.cancelTool"),onClick:vt},null,8,hr)]),m("div",null,[m("div",{ref_key:"entryOrderRef",ref:B,class:"order-button entry",onClick:yt}," Entry ",512),m("div",{ref_key:"tpslOrderRef",ref:z,class:"order-button tpsl",onClick:Ct}," TP/SL ",512),m("div",{class:"chart-top command far fa-angle-double-right",onClick:kt})]),j(m("iframe",{ref_key:"tradingviewChartRef",ref:Ee,class:"tradingview-chart",src:Re.value},null,8,mr),[[U,f.showTradingView]])],512)],512)]),oe(Wt,{ref:"copyistStatusPopupRef"},null,512),oe(Ht,{ref:"dailyCashFlowPopupRef"},null,512)],64)}}},Pr=At(yr,[["__scopeId","data-v-872a232e"]]);export{Pr as default};
