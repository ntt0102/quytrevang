import{y as bt,u as Pt,c as St,i as re,r as O,d as Tt,e as Oe,x as Lt,z as wt,w as ke,v as T,f as Ft,g as Et,h as m,j as ie,A as pe,t as be,B as j,C as Rt,E as _t,G as X,F as At,H as Pe,I as Dt,o as $t}from"./app-2d1ffb8d.js";import Mt from"./CopyistStatusPopup-8d165b3a.js";import{c as Bt,_ as qt}from"./DailyCashFlowPopup-7b68c8f9.js";import It from"./ColorPicker-d6eb8b3d.js";const Vt="/build/assets/spinner-4da4a8c6.gif";class Nt{constructor(){this.create()}create(){return new Promise((k,y)=>{const v=indexedDB.open("orderChart",1);v.onupgradeneeded=c=>{this.store=c.target.result,this.store.createObjectStore("order",{keyPath:"kind"}),this.store.createObjectStore("line",{keyPath:"price"}),this.store.createObjectStore("box",{keyPath:"point"}),this.store.createObjectStore("ruler",{keyPath:"point"}),this.store.createObjectStore("pattern1",{keyPath:"point"}),this.store.createObjectStore("pattern2",{keyPath:"point"}),this.store.createObjectStore("volprofile",{keyPath:"time"}),this.store.createObjectStore("alert",{keyPath:"price"}),k()},v.onsuccess=c=>{this.store=c.target.result,k()},v.onerror=()=>{location.reload(),y()}})}get(k){var y=this.store;return new Promise(function(c,f){var $=y.transaction(k,"readonly");if(Array.isArray(k)){var b=k.map(C=>$.objectStore(C)),I=b.map(v);Promise.all(I).then(C=>c(C))}else{var V=$.objectStore(k);v(V).then(C=>c(C))}});function v(c){return new Promise(function(f,$){const b=c.getAll();b.onsuccess=I=>f(I.target.result),b.onerror=()=>$()})}}set(k,y){const v=this.store.transaction(k,"readwrite").objectStore(k);Array.isArray(y)?y.length>0&&y.forEach(c=>v.put(c)):v.put(y)}clear(k){var y=this.store;return new Promise(function(v,c){const f=y.transaction(k,"readwrite").objectStore(k).clear();f.onsuccess=()=>{v()},f.onerror=$=>{console.error(`Error to empty Object Store: ${k}`),c()}})}}const o=new Nt,jt="/build/assets/alert-4d705e53.mp3";const Wt={class:"content-block dx-card responsive-paddings"},Ht={class:"area data-area"},Yt=["title"],zt=["title"],Ut=["title"],Xt={class:"area tool-area"},Zt=["title"],Kt=["title"],Gt=["title"],Jt=["title"],Qt=["title"],er=["title"],tr=["title"],rr=["title"],ir=["title"],or=["title"],sr=["title"],nr=["src"],Se=3,Te=2,ar="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",lr=120,cr={__name:"Index",setup(Le){const k={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.05,bottom:.4}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:20,minBarSpacing:.01}},y=moment().format("YYYY-MM-DD"),v={START:moment(y+" 08:45:00").unix(),ATO:moment(y+" 09:00:00").unix(),ATC:moment(y+" 14:30:00").unix(),END:moment(y+" 14:45:00").unix()},c=Pt(),{t:f}=St(),$=re("devices"),b=re("mf"),I=re("bus"),V=re("filters"),C=O(null),de=O(null),W=O(null),ue=O(null),fe=O(null),he=O(null),me=O(null),we=O(null),H=O(null),Z=O(null),oe=O(null),se=O(null),K=O(null),G=O(null),M=O(null),Y=O(null),Fe=O(null);let e={chart:{},series:{},data:{whitespace:[],original:[],price:[],cash:[]},order:{side:0,entry:{},tp:{},sl:{}},lines:[],ruler:{l0:{},l1:{},l2:{},l3:{},l4:{},l5:{},pointCount:0},pattern1:{A:{},B:{},C:{},X:{},Y:{},Z:{},T:{}},pattern2:{E:{},S:{},T:{}},volprofile:{v1:{},v2:{},poc:{},pointCount:0},box:[],alerts:[],crosshair:{},shark:null,loadWhitespace:!0,interval:null,interval60:null,websocket:null,isAutoOrdering:!1,socketStop:!1,volumeMax:0,socketRefreshTime:moment()};const h=Tt({chartDate:y,clock:moment().format("HH:mm:ss"),isFullscreen:!1,color:"#F44336",showColorPicker:!1,showTradingView:!1}),E=Oe(()=>c.state.tradingOrder.status),Ee=Oe(()=>`https://chart.vps.com.vn/tv/?loadLastChart=true&symbol=VN30F1M&u=${c.state.tradingOrder.config.vpsCode}&s=${c.state.tradingOrder.config.vpsSession}&resolution=1`);c.dispatch("tradingOrder/getConfig").then(()=>{ae()}),c.dispatch("tradingOrder/getStatus"),e.interval=setInterval(We,1e3),e.interval60=setInterval(()=>c.dispatch("tradingOrder/getStatus"),6e4),o.create(),Lt(()=>{e.chart=Bt(de.value,k),C.value.addEventListener("click",_e),C.value.addEventListener("contextmenu",Re),e.chart.subscribeCrosshairMove(Ae),e.chart.subscribeCustomPriceLineDragged(De),e.series.whitespace=e.chart.addLineSeries({priceScaleId:"whitespace",visible:!1}),e.series.cash=e.chart.addLineSeries({priceScaleId:"cash",scaleMargins:{top:.61,bottom:.01},color:"yellow",lastValueVisible:!1}),e.series.price=e.chart.addLineSeries({color:"#CCCCCC",priceFormat:{minMove:.1}}),new ResizeObserver($e).observe(C.value),document.addEventListener("keydown",Me),document.addEventListener("fullscreenchange",Be),c.dispatch("tradingOrder/getChartData",h.chartDate).then(()=>{Ie()})}),wt(()=>{clearInterval(e.interval),clearInterval(e.interval60),e.socketStop=!0,e.websocket.close(),e.websocket=null}),ke(()=>c.state.tradingOrder.chartData,Ve),ke(()=>c.state.tradingOrder.isChartLoading,t=>{ue.value.style.display=t?"block":"none"});function Re(t){He(),t.preventDefault()}function _e(){le(),H.value.classList.contains("selected")?z():Z.value.classList.contains("selected")?et():oe.value.classList.contains("selected")?it():se.value.classList.contains("selected")?Ce():K.value.classList.contains("selected")&&ct()}function Ae(t){if(t.time){let r=t.seriesPrices.get(e.series.price);e.crosshair.time=t.time,e.crosshair.price=r}else $.phone||(e.crosshair.time=null,e.crosshair.price=null);t.point!=null&&(e.crosshair.x=t.point.x,e.crosshair.y=t.point.y)}function De(t){let r=t.customPriceLine,i=r.options();i.price=Q(i.price);const s=+t.fromPriceString,l=i.price;switch(i.lineType){case"order":if(l!=s){let n=!1;i.kind=="entry"?E.value.position||(n=!0,e.order[i.kind].price=l,c.dispatch("tradingOrder/executeOrder",{action:"entry",data:{cmd:"change",price:e.order.entry.price}}).then(u=>{u.isOk?(A(i.kind),T.success(f("trading.orderChart.changeEntrySuccess"))):(r.applyOptions({price:s}),F(u.message))})):(n=!0,e.order[i.kind].price=l,i.kind=="tp"?c.dispatch("tradingOrder/executeOrder",{action:"tp",data:{cmd:"change",price:e.order.tp.price}}).then(u=>{u.isOk?(A(i.kind),T.success(f("trading.orderChart.changeTpSuccess"))):(r.applyOptions({price:s}),F(u.message))}):c.dispatch("tradingOrder/executeOrder",{action:"sl",data:{cmd:"change",price:e.order.sl.price}}).then(u=>{u.isOk?(A(i.kind),T.success(f("trading.orderChart.changeSlSuccess"))):(r.applyOptions({price:s}),F(u.message))})),n||(r.applyOptions({price:s}),T.show(f("trading.orderChart.noChangeOrderLine")))}break;case"line":o.set("line",{price:s,removed:!0}),o.set("line",i),H.value.classList.remove("selected");break;case"ruler":switch(i.point){case"l0":if(o.set("ruler",i),e.ruler.pointCount==2){const _=+e.ruler.l1.options().title,q=+(l+_).toFixed(1);e.ruler.l1.applyOptions({price:q}),o.set("ruler",e.ruler.l1.options());const ee=+(l+_*2).toFixed(1);e.ruler.l2.applyOptions({price:ee}),o.set("ruler",e.ruler.l2.options());const te=+(l+_*3).toFixed(1);e.ruler.l3.applyOptions({price:te}),o.set("ruler",e.ruler.l3.options());const Ot=+(l+_*4).toFixed(1);e.ruler.l4.applyOptions({price:Ot}),o.set("ruler",e.ruler.l4.options());const kt=+(l+_*5).toFixed(1);e.ruler.l5.applyOptions({price:kt}),o.set("ruler",e.ruler.l5.options())}break;case"l1":const n=+e.ruler.l0.options().price,u=l-n;r.applyOptions({title:u.toFixed(1)}),o.set("ruler",r.options()),e.ruler.l2.applyOptions({title:(u*2).toFixed(1),price:+(n+u*2).toFixed(1)}),o.set("ruler",e.ruler.l2.options()),e.ruler.l3.applyOptions({title:(u*3).toFixed(1),price:+(n+u*3).toFixed(1)}),o.set("ruler",e.ruler.l3.options()),e.ruler.l4.applyOptions({title:(u*4).toFixed(1),price:+(n+u*4).toFixed(1)}),o.set("ruler",e.ruler.l4.options()),e.ruler.l5.applyOptions({title:(u*5).toFixed(1),price:+(n+u*5).toFixed(1)}),o.set("ruler",e.ruler.l5.options());break;case"l2":const P=+e.ruler.l0.options().price,g=l-P;r.applyOptions({title:g.toFixed(1)}),o.set("ruler",r.options()),e.ruler.l1.applyOptions({title:(g*.5).toFixed(1),price:+(P+g*.5).toFixed(1)}),o.set("ruler",e.ruler.l1.options()),e.ruler.l3.applyOptions({title:(g*1.5).toFixed(1),price:+(P+g*1.5).toFixed(1)}),o.set("ruler",e.ruler.l3.options()),e.ruler.l4.applyOptions({title:(g*2).toFixed(1),price:+(P+g*2).toFixed(1)}),o.set("ruler",e.ruler.l4.options()),e.ruler.l5.applyOptions({title:(g*2.5).toFixed(1),price:+(P+g*2.5).toFixed(1)}),o.set("ruler",e.ruler.l5.options());break;case"l3":const R=+e.ruler.l0.options().price,x=l-R;r.applyOptions({title:x.toFixed(1)}),o.set("ruler",r.options()),e.ruler.l1.applyOptions({title:(x/3).toFixed(1),price:+(R+x/3).toFixed(1)}),o.set("ruler",e.ruler.l1.options()),e.ruler.l2.applyOptions({title:(x*2/3).toFixed(1),price:+(R+x*2/3).toFixed(1)}),o.set("ruler",e.ruler.l2.options()),e.ruler.l4.applyOptions({title:(x*4/3).toFixed(1),price:+(R+x*4/3).toFixed(1)}),o.set("ruler",e.ruler.l4.options()),e.ruler.l5.applyOptions({title:(x*5/3).toFixed(1),price:+(R+x*5/3).toFixed(1)}),o.set("ruler",e.ruler.l5.options());break;case"l4":const p=+e.ruler.l0.options().price,L=l-p;r.applyOptions({title:L.toFixed(1)}),o.set("ruler",r.options()),e.ruler.l1.applyOptions({title:(L/4).toFixed(1),price:+(p+L/4).toFixed(1)}),o.set("ruler",e.ruler.l1.options()),e.ruler.l2.applyOptions({title:(L/2).toFixed(1),price:+(p+L/2).toFixed(1)}),o.set("ruler",e.ruler.l2.options()),e.ruler.l3.applyOptions({title:(L*3/4).toFixed(1),price:+(p+L*3/4).toFixed(1)}),o.set("ruler",e.ruler.l3.options()),e.ruler.l5.applyOptions({title:(L*5/4).toFixed(1),price:+(p+L*5/4).toFixed(1)}),o.set("ruler",e.ruler.l5.options());break;case"l5":const B=+e.ruler.l0.options().price,S=l-B;r.applyOptions({title:S.toFixed(1)}),o.set("ruler",r.options()),e.ruler.l1.applyOptions({title:(S/5).toFixed(1),price:+(B+S/5).toFixed(1)}),o.set("ruler",e.ruler.l1.options()),e.ruler.l2.applyOptions({title:(S*2/5).toFixed(1),price:+(B+S*2/5).toFixed(1)}),o.set("ruler",e.ruler.l2.options()),e.ruler.l3.applyOptions({title:(S*3/5).toFixed(1),price:+(B+S*3/5).toFixed(1)}),o.set("ruler",e.ruler.l3.options()),e.ruler.l4.applyOptions({title:(S*4/5).toFixed(1),price:+(B+S*4/5).toFixed(1)}),o.set("ruler",e.ruler.l4.options());break}break;case"pattern1":if(b.isSet(e.pattern1.X)){const n=+e.pattern1.A.options().price,u=+e.pattern1.B.options().price,P=+e.pattern1.C.options().price,g=u-n;e.pattern1.X.applyOptions({price:+(P+g).toFixed(1),title:g.toFixed(1)}),o.set("pattern1",e.pattern1.X.options()),e.pattern1.Y.applyOptions({price:+(P+1.272*g).toFixed(1),title:(1.272*g).toFixed(1)}),o.set("pattern1",e.pattern1.Y.options()),e.pattern1.Z.applyOptions({price:+(P+1.618*g).toFixed(1),title:(1.618*g).toFixed(1)}),o.set("pattern1",e.pattern1.Z.options()),e.pattern1.T.applyOptions({price:+(P+2.618*g).toFixed(1),title:(2.618*g).toFixed(1)}),o.set("pattern1",e.pattern1.T.options())}break;case"pattern2":if(b.isSet(e.pattern2.T)){const n=e.pattern2.E.options(),u=+n.price1,P=+n.price2,g=+n.price3,R=+n.price4,x=+n.price,p=g-P,L=u-R,B=g-R,S=x-R;let _,q;i.point=="S"?(q=+e.pattern2.S.options().price,_=x-q):(_=Math.abs(p)>Math.abs(S/2)?p:S/2,q=x-_,e.pattern2.S.applyOptions({price:+q.toFixed(1)}));const ee=q+(Math.abs(S)>Math.abs(B)?Math.abs(S)>Math.abs(L)?1:1.5:2)*S,te=ee-x;e.pattern2.S.applyOptions({title:`SL=${(-_).toFixed(1)}`}),o.set("pattern2",e.pattern2.S.options()),e.pattern2.E.applyOptions({title:`RR=${(te/_).toFixed(1)}`}),o.set("pattern2",e.pattern2.E.options()),e.pattern2.T.applyOptions({price:+ee.toFixed(1),title:`TP=${te.toFixed(1)}`}),o.set("pattern2",e.pattern2.T.options())}break;case"alert":o.set("alert",{price:s,removed:!0});const a=e.data.price.slice(-1)[0].value;let d=l>=a?">":"<";r.applyOptions({title:d}),o.set("alert",r.options()),K.value.classList.remove("selected");break}}function $e(){C.value&&(e.chart.resize(C.value.offsetWidth,C.value.offsetHeight),C.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function Me(t){if(t.ctrlKey||t.metaKey)switch(t.keyCode){case 38:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing+.05});break;case 40:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing-.05});break;case 37:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()-10);break;case 39:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()+10);break;case 96:Z.value.click();break;case 97:H.value.click();break;case 98:he.value.click();break;case 99:fe.value.click();case 100:me.value.click();break}}function Be(){C.value&&(document.fullscreenElement?(h.isFullscreen=!0,C.value.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(h.isFullscreen=!1,C.value.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}function qe(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function Ie(){return new Promise(async t=>{E.value.pending&&((await o.get("order")).map(u=>{e.order.side=u.side,e.order[u.kind].price=u.price,A(u.kind),D(!0)}),e.order.tp.hasOwnProperty("line")&&e.order.entry.line.applyOptions({draggable:!1})),(await o.get("line")).forEach(n=>{n.removed||e.lines.push(e.series.price.createPriceLine(n))});const i=await o.get("box");i.length==2&&(e.box=i,e.series.box.setData([i[0].x,i[1].x]),e.box[0].y=e.series.price.createPriceLine(i[0].y),e.box[1].y=e.series.price.createPriceLine(i[1].y));const s=await o.get("ruler");s.length>0&&(e.ruler.pointCount=s.length>1?2:1,s.forEach(n=>{e.ruler[n.point]=e.series.price.createPriceLine(n)}));const l=await o.get("pattern1");l.length>0&&l.forEach(n=>{e.pattern1[n.point]=e.series.price.createPriceLine(n)});const a=await o.get("pattern2");a.length>0&&a.forEach(n=>{e.pattern2[n.point]=e.series.price.createPriceLine(n)}),(await o.get("alert")).forEach(n=>{n.removed||e.alerts.push(e.series.price.createPriceLine(n))}),t()})}function Ve(){e.loadWhitespace&&(c.state.tradingOrder.chartData.length>0&&(e.data.whitespace=ne(e.data.whitespace,je())),e.series.whitespace.setData(e.data.whitespace),e.loadWhitespace=!1),e.data.original=ne(c.state.tradingOrder.chartData,e.data.original);let t=e.data.original.reduce((r,i)=>{let s=i.price,l=0;return r.price.length>0&&(s=r.price.slice(-1)[0].value,l=r.cash.slice(-1)[0].value),r.price.push({time:i.time,value:i.price}),r.cash.push({time:i.time,value:l+(i.price-s)*i.volume}),r},{price:[],cash:[]});e.data.price=t.price,e.series.price.setData(t.price),e.data.cash=t.cash,e.series.cash.setData(t.cash)}function Ne(t){const r=e.data.original.length;if(e.data.original=ne(e.data.original,[t]),e.data.original.length>r){const i=e.data.price.slice(-1)[0].value,s=e.data.cash.slice(-1)[0].value;e.data.price.push({time:t.time,value:t.price}),e.series.price.setData(e.data.price),e.data.cash.push({time:t.time,value:s+(t.price-i)*t.volume}),e.series.cash.setData(e.data.cash)}}function je(){const t=h.chartDate,r=moment(`${t} 09:00:00`).unix(),i=moment(`${t} 11:30:00`).unix(),s=moment(`${t} 13:00:00`).unix(),l=moment(`${t} 14:30:00`).unix();let a=[],d;for(d=r;d<=i;d++)a.push({time:d+7*60*60});for(d=s;d<=l;d++)a.push({time:d+7*60*60});return a}function ne(t,r){return Array.from(new Map([...t,...r].sort((i,s)=>i.time-s.time).map(i=>[i.time,i])).values())}function ae(){e.websocket=new WebSocket(ar),e.websocket.onopen=t=>{let r={action:"join",list:c.state.tradingOrder.config.symbol};e.websocket.send(`42${JSON.stringify(["regs",JSON.stringify(r)])}`)},e.websocket.onclose=t=>{if(e.socketStop)return!1;J()&&(ve(!0),ae(),moment().diff(e.socketRefreshTime,"seconds")>lr&&ce())},e.websocket.onmessage=t=>{if(ve(!1),t.data.substr(0,1)==4&&t.data.substr(1,1)==2){const r=JSON.parse(t.data.substr(2));if(r[0]=="stockps"){const i=r[1].data;i.id==3220&&(e.data.original.length>0&&Ne({time:moment(`${y} ${i.time}`).unix()+7*60*60,price:i.lastPrice,volume:i.lastVol}),ht())}}}}function We(){const t=moment().unix();J(t)&&(E.value.position&&t>v.ATC-5*60&&(Ye(),t>v.ATC-15&&e.order.tp.hasOwnProperty("line")&&c.dispatch("tradingOrder/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(r=>{r.isOk?(w("entry"),w("tp"),w("sl"),D(!1),o.clear("order"),T.success(f("trading.orderChart.autoCancelTpSlSuccess")),U()):F(r.message)})),t==v.START&&ae(),e.alerts.forEach(r=>{const i=r.options();if(!i.removed&&e.data.price.length){const s=e.data.price.slice(-1)[0].value;(i.title==">"&&s>=i.price||i.title=="<"&&s<=i.price)&&U()}})),h.clock=moment().format("HH:mm:ss")}function He(){if(c.state.tradingOrder.config.openingMarket){const t=moment().unix();if(J(t)&&(e.order.tp.hasOwnProperty("line")||E.value.position&&t>v.ATO&&t<v.ATC&&(e.order.entry.price=e.data.price.slice(-1)[0].value,e.order.side=E.value.position,Y.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-61?-61:1))+"px",Y.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-51?-51:1))+"px",Y.value.style.display="block"),!e.order.entry.hasOwnProperty("line"))){let r=null,i=0;E.value.position?(t<v.ATO?r="ATO":t>v.ATC&&(r="ATC"),r&&(e.order.entry.price=r,i=-E.value.position)):t>v.ATO&&t<v.ATC&&(r=N(e.crosshair.y),i=r>=e.data.price.slice(-1)[0].value?1:-1,e.order.side=i,e.order.entry.price=r),i&&(M.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-71?-71:1))+"px",M.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-61?-61:1))+"px",M.value.style.background=i>0?"green":"red",M.value.innerText=`${i>0?"LONG":"SHORT"} ${r}`,M.value.style.display="block")}}}function le(){M.value.style.display="none",Y.value.style.display="none"}function D(t){G.value.style.display=t?"block":"none"}function Ye(){G.value.classList.contains("blink")||G.value.classList.add("blink")}function ve(t){t?W.value.classList.contains("blink")||W.value.classList.add("blink"):W.value.classList.contains("blink")&&W.value.classList.remove("blink")}function A(t){let r,i;switch(t){case"entry":r="yellow",i=e.order.side>0?"LONG":"SHORT";break;case"tp":r="lime",i=Math.abs(e.order.tp.price-e.order.entry.price).toFixed(1);break;case"sl":r="red",i=Math.abs(e.order.sl.price-e.order.entry.price).toFixed(1);break}e.order[t].hasOwnProperty("line")?e.order[t].line.applyOptions({price:e.order[t].price,title:i}):e.order[t].line=e.series.price.createPriceLine({lineType:"order",kind:t,price:e.order[t].price,color:r,lineWidth:1,lineStyle:0,title:i,draggable:!0}),o.set("order",{kind:t,price:+e.order[t].price,side:e.order.side})}function w(t){e.order[t].hasOwnProperty("line")&&(e.series.price.removePriceLine(e.order[t].line),delete e.order[t].line)}function ze(t){h.showTradingView=!h.showTradingView,t.stopPropagation()}function Ue(t){h.showColorPicker=!h.showColorPicker,t.stopPropagation()}function Xe(t){b.isSet(e.pattern1.X)&&(z(+e.pattern1.X.options().price),z(+e.pattern1.Y.options().price),z(+e.pattern1.Z.options().price),z(+e.pattern1.T.options().price)),t.preventDefault(),t.stopPropagation()}function Ze(t){h.showColorPicker=!1;const r=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),r||t.target.classList.add("selected"),t.stopPropagation()}function Ke(t){Ge(),t.target.classList.remove("selected"),t.preventDefault(),t.stopPropagation()}function z(t=null,r=null,i=null){const s="line";t||(t=Q(N(e.crosshair.y))),r||(r=h.color);const l=e.lines.length;if(e.lines=e.lines.filter(a=>{const d=a.options(),n=d.type=t==+d.price;return n&&(e.series.price.removePriceLine(a),o.set("line",{price:t,removed:!0})),!n}),e.lines.length==l){const a={lineType:s,price:t,color:r,title:i,lineWidth:1,lineStyle:1,draggable:!0};e.lines.push(e.series.price.createPriceLine(a)),o.set("line",a)}H.value.classList.remove("selected")}function Ge(){e.lines.forEach(t=>e.series.price.removePriceLine(t)),e.lines=[],o.clear("line")}function Je(t){h.showColorPicker=!1;const r=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),r||(t.target.classList.add("selected"),ge()),t.stopPropagation()}function Qe(t){ge(),t.target.classList.remove("selected"),t.preventDefault(),t.stopPropagation()}function et(){const t=N(e.crosshair.y);let r={lineType:"ruler",price:t,lineWidth:1,lineStyle:1,draggable:!0};if(e.ruler.pointCount==0)r.point="l0",r.color="#F44336",r.title="0",e.ruler[r.point]=e.series.price.createPriceLine(r),e.ruler.pointCount++,o.set("ruler",r);else{const i=+e.ruler.l0.options().price,s=t-i;r.point="l1",r.color="#FF9800",r.title=s.toFixed(1),e.ruler[r.point]=e.series.price.createPriceLine(r),o.set("ruler",r);const l=2*s;r.point="l2",r.color="#FFEB3B",r.title=l.toFixed(1),r.price=+(i+l).toFixed(1),e.ruler[r.point]=e.series.price.createPriceLine(r),o.set("ruler",r);const a=3*s;r.point="l3",r.color="#4CAF50",r.title=a.toFixed(1),r.price=+(i+a).toFixed(1),e.ruler[r.point]=e.series.price.createPriceLine(r),o.set("ruler",r);const d=4*s;r.point="l4",r.color="#009688",r.title=d.toFixed(1),r.price=+(i+d).toFixed(1),e.ruler[r.point]=e.series.price.createPriceLine(r),o.set("ruler",r);const n=5*s;r.point="l5",r.color="#00BCD4",r.title=n.toFixed(1),r.price=+(i+n).toFixed(1),e.ruler[r.point]=e.series.price.createPriceLine(r),o.set("ruler",r),e.ruler.pointCount++,Z.value.classList.remove("selected")}}function ge(){e.ruler.pointCount>0&&(e.series.price.removePriceLine(e.ruler.l0),e.ruler.pointCount>1&&(e.series.price.removePriceLine(e.ruler.l1),e.series.price.removePriceLine(e.ruler.l2),e.series.price.removePriceLine(e.ruler.l3),e.series.price.removePriceLine(e.ruler.l4),e.series.price.removePriceLine(e.ruler.l5)),e.ruler={l0:{},l1:{},l2:{},l3:{},l4:{},l5:{},pointCount:0},o.clear("ruler"))}function tt(t){h.showColorPicker=!1;const r=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),r||(t.target.classList.add("selected"),ye()),t.stopPropagation()}function rt(t){ye(),t.target.classList.remove("selected"),t.preventDefault(),t.stopPropagation()}function it(){let r={lineType:"pattern1",price:N(e.crosshair.y),lineWidth:1,lineStyle:1,draggable:!0};if(b.isSet(e.pattern1.A)?b.isSet(e.pattern1.B)?b.isSet(e.pattern1.C)||(r.point="C",r.title="C",r.color="#E91E63"):(r.point="B",r.title="B",r.color="#009688"):(r.point="A",r.title="A",r.color="#009688"),e.pattern1[r.point]=e.series.price.createPriceLine(r),o.set("pattern1",r),r.point=="C"){const i=+e.pattern1.A.options().price,s=+e.pattern1.B.options().price,l=+e.pattern1.C.options().price,a=s-i;r.point="X",r.price=+(l+a).toFixed(1),r.title=a.toFixed(1),r.color="#9C27B0",r.draggable=!1,e.pattern1[r.point]=e.series.price.createPriceLine(r),o.set("pattern1",r),r.point="Y",r.price=+(l+1.272*a).toFixed(1),r.title=(1.272*a).toFixed(1),r.color="#673AB7",e.pattern1[r.point]=e.series.price.createPriceLine(r),o.set("pattern1",r),r.point="Z",r.price=+(l+1.618*a).toFixed(1),r.title=(1.618*a).toFixed(1),r.color="#2196F3",e.pattern1[r.point]=e.series.price.createPriceLine(r),o.set("pattern1",r),r.point="T",r.price=+(l+2.618*a).toFixed(1),r.title=(2.618*a).toFixed(1),r.color="#00BCD4",e.pattern1[r.point]=e.series.price.createPriceLine(r),o.set("pattern1",r),oe.value.classList.remove("selected")}}function ye(){b.isSet(e.pattern1.A)&&(e.series.price.removePriceLine(e.pattern1.A),b.isSet(e.pattern1.B)&&(e.series.price.removePriceLine(e.pattern1.B),b.isSet(e.pattern1.C)&&(e.series.price.removePriceLine(e.pattern1.C),e.series.price.removePriceLine(e.pattern1.X),e.series.price.removePriceLine(e.pattern1.Y),e.series.price.removePriceLine(e.pattern1.Z),e.series.price.removePriceLine(e.pattern1.T))),e.pattern1={A:{},B:{},C:{},X:{},Y:{},Z:{},T:{}},o.clear("pattern1"))}function ot(t){h.showColorPicker=!1;const r=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),r||(t.target.classList.add("selected"),Ce(!0)),t.stopPropagation()}function st(t){xe(),t.target.classList.remove("selected"),t.preventDefault(),t.stopPropagation()}function Ce(t=!1){let r={};if(b.isSet(e.pattern2.E)){const L=e.pattern2.E.options();r={time:L.time1,value:L.price1},xe()}else{if(t)return!1;r={time:e.crosshair.time,value:N(e.crosshair.y)}}const{point2:i,point3:s,point4:l,point5:a}=nt(r);if(i.value==r.value)return!1;const d=s.value-i.value,n=s.value-l.value,u=a.value-l.value,P=Math.abs(d)>Math.abs(u/2)?d:u/2,g=a.value-P,R=g+(Math.abs(u)>Math.abs(n)?1.5:2)*u,x=R-a.value;let p={lineType:"pattern2",lineWidth:1,lineStyle:1};p.price=a.value,p.time1=r.time,p.price1=r.value,p.price2=i.value,p.price3=s.value,p.price4=l.value,p.point="E",p.title=`RR=${(x/P).toFixed(1)}`,p.color="#FF9800",p.draggable=!0,e.pattern2[p.point]=e.series.price.createPriceLine(p),o.set("pattern2",p),p.price=+g.toFixed(1),p.point="S",p.title=`SL=${(-P).toFixed(1)}`,p.color="#E91E63",p.draggable=!0,e.pattern2[p.point]=e.series.price.createPriceLine(p),o.set("pattern2",p),p.point="T",p.price=+R.toFixed(1),p.title=`TP=${x.toFixed(1)}`,p.color="#2196F3",p.draggable=!1,e.pattern2[p.point]=e.series.price.createPriceLine(p),o.set("pattern2",p),se.value.classList.remove("selected")}function nt(t){let r=0,i=0,s=t,l=t,a=t,d=t;for(let n of e.data.price)if(n.time>=t.time){if(n.value<t.value){if(s.value>l.value)break;if(n.value<a.value)r>i&&(s=a,l=d,i=r),a=n,d=n,r=0;else if(n.value>a.value){if(n.value>t.value)break;n.value>d.value&&(d=n,r=+Math.abs(d.value-a.value).toFixed(1))}}else if(n.value>t.value){if(s.value<l.value)break;if(n.value>a.value)r>i&&(s=a,l=d,i=r),a=n,d=n,r=0;else if(n.value<a.value){if(n.value<t.value)break;n.value<d.value&&(d=n,r=+Math.abs(d.value-a.value).toFixed(1))}}}return{point2:s,point3:l,point4:a,point5:d}}function xe(){b.isSet(e.pattern2.T)&&(e.series.price.removePriceLine(e.pattern2.E),e.series.price.removePriceLine(e.pattern2.S),e.series.price.removePriceLine(e.pattern2.T),e.pattern2={E:{},S:{},T:{}},o.clear("pattern2"))}function at(t){h.showColorPicker=!1;const r=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),r||t.target.classList.add("selected"),t.stopPropagation()}function lt(t){pt(),t.target.classList.remove("selected"),t.preventDefault(),t.stopPropagation()}function ct(){const t="alert",r=Q(N(e.crosshair.y)),i=e.alerts.length;if(e.alerts=e.alerts.filter(s=>{const l=s.options(),a=l.type=r==+l.price;return a&&(e.series.price.removePriceLine(s),o.set("alert",{price:r,removed:!0})),!a}),e.alerts.length==i){const s={lineType:t,price:r,title:r>=e.data.price.slice(-1)[0].value?">":"<",color:"red",lineWidth:1,lineStyle:1,draggable:!0};e.alerts.push(e.series.price.createPriceLine(s)),o.set("alert",s)}K.value.classList.remove("selected")}function pt(){e.alerts.forEach(t=>e.series.price.removePriceLine(t)),e.alerts=[],o.clear("alert")}async function dt(){e.order.entry.hasOwnProperty("line")&&(e.order.tp.hasOwnProperty("line")?c.dispatch("tradingOrder/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(t=>{t.isOk?(w("entry"),w("tp"),w("sl"),D(!1),o.clear("order"),T.success(f("trading.orderChart.exitSuccess"))):(D(!0),F(t.message))}):c.dispatch("tradingOrder/executeOrder",{action:"entry",data:{cmd:"delete"}}).then(t=>{t.isOk?(w("entry"),D(!1),o.clear("order"),T.success(f("trading.orderChart.deleteEntrySuccess"))):(D(!0),F(t.message))}))}function ut(){const t=moment().unix();J(t)&&(t<v.ATO?Pe(f("trading.orderChart.atoOrder"),f("titles.confirm")).then(i=>{i&&c.dispatch("tradingOrder/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(s=>{s.isOk?T.success(f("trading.orderChart.atoOrderSuccess")):F(s.message)})}):t<v.ATC?c.dispatch("tradingOrder/executeOrder",{action:"entry",data:{cmd:"new",side:e.order.side,price:e.order.entry.price}}).then(r=>{r.isOk?(A("entry"),D(!0),T.success(f("trading.orderChart.newEntrySuccess"))):F(r.message)}):Pe(f("trading.orderChart.atcOrder"),f("titles.confirm")).then(i=>{i&&c.dispatch("tradingOrder/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(s=>{s.isOk?T.success(f("trading.orderChart.atcOrderSuccess")):F(s.message)})}))}function ft(){e.order.tp.price=e.order.entry.price+e.order.side*Se,e.order.sl.price=e.order.entry.price-e.order.side*Te,c.dispatch("tradingOrder/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.order.tp.price},slData:{cmd:"new",price:e.order.sl.price}}).then(t=>{t.isOk?(A("entry"),A("tp"),A("sl"),e.order.entry.line.applyOptions({draggable:!1}),T.success(f("trading.orderChart.newTpSlSuccess"))):F(t.message)})}function ht(){if(e.order.entry.hasOwnProperty("line")){const t=e.data.price.slice(-1)[0].value;e.order.tp.hasOwnProperty("line")?((e.order.side>0&&t>=e.order.tp.price||e.order.side<0&&t<=e.order.tp.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,c.dispatch("tradingOrder/executeOrder",{action:"sl",data:{cmd:"delete"}}).then(r=>{r.isOk?(w("entry"),w("tp"),w("sl"),D(!1),o.clear("order"),T.success(f("trading.orderChart.deleteTpSuccess")),le(),U()):F(r.message),e.isAutoOrdering=!1}))),(e.order.side>0&&t<=e.order.sl.price||e.order.side<0&&t>=e.order.sl.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,c.dispatch("tradingOrder/executeOrder",{action:"tp",data:{cmd:"cancel"}}).then(r=>{r.isOk?(w("entry"),w("tp"),w("sl"),D(!1),o.clear("order"),T.success(f("trading.orderChart.deleteSlSuccess")),le(),U()):F(r.message),e.isAutoOrdering=!1})))):(e.order.side>0&&t>=e.order.entry.price||e.order.side<0&&t<=e.order.entry.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,setTimeout(()=>{e.order.tp.price=e.order.entry.price+e.order.side*Se,e.order.sl.price=e.order.entry.price-e.order.side*Te,c.dispatch("tradingOrder/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.order.tp.price},slData:{cmd:"new",price:e.order.sl.price}}).then(r=>{r.isOk?(A("tp"),A("sl"),e.order.entry.line.applyOptions({draggable:!1}),T.success(f("trading.orderChart.autoNewTpSlSuccess")),U()):F(r.message),e.isAutoOrdering=!1})},1e3)))}}function mt(){e.chart.timeScale().scrollToRealTime()}function J(t=null){return t||(t=moment().unix()),t>=v.START&&t<=v.END}function N(t){return Q(e.series.price.coordinateToPrice(t))}function Q(t){return t?+ +t.toFixed(1):0}function F(t){t||(t="unknown"),T.error(f(`trading.orderChart.${t}`))}function vt(){e.loadWhitespace=!0,c.dispatch("tradingOrder/getChartData",h.chartDate)}function ce(){e.socketRefreshTime=moment(),e.loadWhitespace=!0,c.dispatch("tradingOrder/getChartData",h.chartDate)}function gt(){e.data.original=[],e.data.price=[],e.data.cash=[],e.data.whitespace=[],ce()}function U(){let t=new Audio(jt);t.crossOrigin="anonymous",t.addEventListener("canplaythrough",function(){t.play()})}function yt(){c.dispatch("tradingOrder/getAccountInfo").then(t=>{let r="";r+='<div style="width: 200px;">',r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${f("trading.orderChart.nav")}</div><div>: ${V.currency(t.nav)}</div></div>`,r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${f("trading.orderChart.maxVol")}</div><div>: ${V.numberVnFormat(t.maxVol)}</div></div>`,r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${f("trading.orderChart.vm")}</div><div>: ${V.currency(t.vm)}</div></div>`,r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${f("trading.orderChart.fee")}</div><div>: ${V.currency(t.fee)}</div></div>`,r+="</div>",Dt(r,f("trading.orderChart.accountInfo"))})}function Ct(){I.emit("checkPin",()=>c.dispatch("tradingOrder/report"))}function xt(){I.emit("checkPin",()=>c.dispatch("tradingOrder/export"))}return(t,r)=>{const i=Ft("DxToolbar");return $t(),Et(At,null,[m("div",Wt,[ie(i,{items:[{location:"before",widget:"dxButton",options:{icon:"far fa-flag-checkered small",hint:t.$t("trading.orderChart.buttons.report"),onClick:Ct}},{location:"before",widget:"dxButton",options:{icon:"far fa-file-export small",hint:t.$t("trading.orderChart.buttons.export"),onClick:xt}},{location:"before",widget:"dxButton",options:{icon:"far fa-chart-line small",hint:t.$t("trading.orderChart.buttons.cashflow"),onClick:()=>t.$refs.dailyCashFlowPopupRef.show()}}]},null,8,["items"]),m("div",{class:"order-chart-container",ref_key:"chartContainerRef",ref:C},[m("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:de},[m("div",Ht,[m("div",{ref_key:"connectionRef",ref:W,class:pe(`command far fa-${E.value.connection?"link":"unlink"}`),title:t.$t("trading.orderChart.connection"),onClick:r[0]||(r[0]=()=>t.$store.dispatch("tradingOrder/getStatus"))},null,10,Yt),m("div",{class:pe(["command status",{green:E.value.position>0,red:E.value.position<0,pending:E.value.pending}]),title:t.$t("trading.orderChart.position"),onClick:yt},be(E.value.position),11,zt),m("div",{class:"command clock",onClick:ce},be(h.clock),1),j(m("input",{type:"date",class:"chart-date command",title:t.$t("trading.orderChart.date"),"onUpdate:modelValue":r[1]||(r[1]=s=>h.chartDate=s),onChange:vt},null,40,Ut),[[Rt,h.chartDate]]),m("img",{ref_key:"spinnerRef",ref:ue,class:"command spinner",src:Vt},null,512)]),m("div",Xt,[m("div",{ref_key:"fullscreenToolRef",ref:fe,class:pe(`command far fa-${h.isFullscreen?"compress":"expand"}`),title:t.$t("trading.orderChart.fullscreen"),onClick:qe},null,10,Zt),m("div",{ref_key:"reloadToolRef",ref:he,class:"command far fa-sync-alt",title:t.$t("trading.orderChart.reload"),onClick:gt},null,8,Kt),m("div",{ref_key:"tradingviewRef",ref:me,class:"command far fa-chart-bar",title:t.$t("trading.orderChart.tradingview"),onClick:ze},null,8,Gt),m("div",{ref_key:"colorToolRef",ref:we,class:"color command far fa-palette",style:_t({color:h.color}),title:t.$t("trading.orderChart.colorTool"),onClick:Ue,onContextmenu:Xe},[j(ie(It,{class:"color-picker",modelValue:h.color,"onUpdate:modelValue":r[2]||(r[2]=s=>h.color=s)},null,8,["modelValue"]),[[X,h.showColorPicker]])],44,Jt),m("div",{ref_key:"lineToolRef",ref:H,class:"command far fa-horizontal-rule",title:t.$t("trading.orderChart.lineTool"),onClick:Ze,onContextmenu:Ke},null,40,Qt),m("div",{ref_key:"pattern1ToolRef",ref:oe,class:"command far fa-star",title:t.$t("trading.orderChart.pattern1Tool"),onClick:tt,onContextmenu:rt},null,40,er),j(m("div",{ref_key:"pattern2ToolRef",ref:se,class:"command far fa-heart",title:t.$t("trading.orderChart.pattern2Tool"),onClick:ot,onContextmenu:st},null,40,tr),[[X,!1]]),m("div",{ref_key:"rulerToolRef",ref:Z,class:"command far fa-line-height",title:t.$t("trading.orderChart.rulerTool"),onClick:Je,onContextmenu:Qe},null,40,rr),j(m("div",{ref_key:"alertToolRef",ref:K,class:"command far fa-alarm-exclamation",title:t.$t("trading.orderChart.alertTool"),onClick:at,onContextmenu:lt},null,40,ir),[[X,!1]]),j(m("div",{class:"command far fa-info-circle",title:t.$t("trading.orderChart.copyistStatusPopup.title"),onClick:r[3]||(r[3]=()=>t.$refs.copyistStatusPopupRef.show())},null,8,or),[[X,!1]]),m("div",{ref_key:"cancelOrderRef",ref:G,class:"cancel-order command far fa-trash-alt",title:t.$t("trading.orderChart.cancelTool"),onClick:dt},null,8,sr)]),m("div",null,[m("div",{ref_key:"entryOrderRef",ref:M,class:"order-button entry",onClick:ut}," Entry ",512),m("div",{ref_key:"tpslOrderRef",ref:Y,class:"order-button tpsl",onClick:ft}," TP/SL ",512),m("div",{class:"chart-top command far fa-angle-double-right",onClick:mt})]),j(m("iframe",{ref_key:"tradingviewChartRef",ref:Fe,class:"tradingview-chart",src:Ee.value},null,8,nr),[[X,h.showTradingView]])],512)],512)]),ie(Mt,{ref:"copyistStatusPopupRef"},null,512),ie(qt,{ref:"dailyCashFlowPopupRef"},null,512)],64)}}},hr=bt(cr,[["__scopeId","data-v-525a474a"]]);export{hr as default};
