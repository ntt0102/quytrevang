import{u as ut,r as g,a as ft,c as ae,x as ht,E as mt,w as gt,v,b as vt,e as ne,d as f,G as I,t as le,B as z,C as yt,H as ce,h as Ot,j as Ct,k as N,A as de,I as Tt,l as wt,o as kt}from"./app-9d0ed483.js";import xt from"./LineContextMenu-d36a6e9c.js";import{c as St}from"./lightweight-charts.esm.development-03366bac.js";import"./text-box-afe14e26.js";const bt="/build/assets/alert-4d705e53.mp3";const Lt={class:"content-block dx-card responsive-paddings"},Pt=["title"],Rt=["title"],Dt=["title"],Et=["title"],$t=["title"],At=["title"],Ft=["title"],_t=["title"],Mt=["title"],Bt=["title"],It=["title"],Nt=["title"],qt=["src"],pe=3,ue=2,Vt="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",Wt=120,zt={__name:"Index",setup(Ut){const fe={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.05,bottom:.4}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:20,minBarSpacing:.01}},b=moment().format("YYYY-MM-DD"),O={START:moment(b+" 08:45:00").unix(),ATO:moment(b+" 09:00:00").unix(),ATC:moment(b+" 14:30:00").unix(),END:moment(b+" 14:45:00").unix()},l=Ot(),he=Ct(),{t:u}=ut(),me=N("devices"),p=N("mf"),X=N("bus"),F=N("filters"),w=g(null),K=g(null),R=g(null),G=g(null),J=g(null),Q=g(null),D=g(null),ge=g(null),q=g(null),V=g(null),W=g(null),U=g(null),E=g(null),S=g(null),$=g(null),ve=g(null);let e={chart:{},series:{},data:{whitespace:[],price:[],vn30:[],foreign:[],active:[],original:[],cash:[]},tools:{order:{side:0,entry:{},tp:{},sl:{}},lines:[],target:{A:{},B:{},X:{},Y:{},Z:{}},uplps:{P1:{},P2:{}},downlps:{P1:{},P2:{}},rr:{EP:{},SL:{},TP:{}}},order:{side:0,entry:{},tp:{},sl:{}},crosshair:{},shark:null,loadWhitespace:!0,interval:null,interval60:null,websocket:null,isAutoOrdering:!1,socketStop:!1,volumeMax:0,socketRefreshTime:moment()};const d=ft({chartDate:he.query.date??b,clock:moment().format("HH:mm:ss"),isFullscreen:!1,color:"#F44336",lineTitle:"",lineColor:"#F44336",showLineContext:!1,showTradingView:!1}),C=ae(()=>l.state.tradingOrder.status),ye=ae(()=>`https://chart.vps.com.vn/tv/?loadLastChart=true&symbol=VN30F1M&u=${l.state.tradingOrder.config.vpsUser}&s=${l.state.tradingOrder.config.vpsSession}&resolution=1`);l.dispatch("tradingOrder/initChart").then(H),l.dispatch("tradingOrder/getStatus"),e.interval=setInterval($e,1e3),e.interval60=setInterval(()=>l.dispatch("tradingOrder/getStatus"),6e4),ht(()=>{e.chart=St(K.value,fe),e.chart.subscribeCrosshairMove(we),e.chart.subscribeCustomPriceLineDragged(ke),e.series.whitespace=e.chart.addLineSeries({priceScaleId:"whitespace",visible:!1}),e.series.active=e.chart.addLineSeries({priceScaleId:"volume",scaleMargins:{top:.61,bottom:.01},color:"blue",lastValueVisible:!1}),e.series.foreign=e.chart.addLineSeries({priceScaleId:"volume",scaleMargins:{top:.61,bottom:.01},color:"yellow",lastValueVisible:!1}),e.series.vn30=e.chart.addLineSeries({color:"red",priceFormat:{minMove:.1}}),e.series.price=e.chart.addLineSeries({color:"white",priceFormat:{minMove:.1}}),new ResizeObserver(xe).observe(w.value),document.addEventListener("keydown",Se),document.addEventListener("fullscreenchange",be),l.dispatch("tradingOrder/getChartData",d.chartDate).then(()=>{Pe()})}),mt(()=>{clearInterval(e.interval),clearInterval(e.interval60),e.socketStop=!0,e.websocket.close(),e.websocket=null}),gt(()=>l.state.tradingOrder.chartData,Re);function Oe(t){d.showLineContext=!1,Y(),D.value.classList.contains("selected")?Ie():q.value.classList.contains("selected")?Ke():W.value.classList.contains("selected")?We():U.value.classList.contains("selected")?je():V.value.classList.contains("selected")&&Qe()}function Ce(t){Ae(),t.preventDefault()}function ee(t){t.stopPropagation()}function Te(t){t.preventDefault(),t.stopPropagation()}function we(t){if(t.time){let i=t.seriesPrices.get(e.series.price);e.crosshair.time=t.time,e.crosshair.price=i}else me.phone||(e.crosshair.time=null,e.crosshair.price=null);t.point!=null&&(e.crosshair.x=t.point.x,e.crosshair.y=t.point.y)}function ke(t){let i=t.customPriceLine,r=i.options();r.price=j(r.price);const o=+t.fromPriceString,n=r.price;switch(r.lineType){case"order":if(n!=o){let a=!1;r.kind=="entry"?C.value.position||(a=!0,e.order[r.kind].price=n,l.dispatch("tradingOrder/executeOrder",{action:"entry",data:{cmd:"change",price:e.order.entry.price}}).then(s=>{s.isOk?(P([r.kind]),v.success(u("trading.orderChart.changeEntrySuccess"))):(i.applyOptions({price:o}),T(s.message))})):(a=!0,e.order[r.kind].price=n,r.kind=="tp"?l.dispatch("tradingOrder/executeOrder",{action:"tp",data:{cmd:"change",price:e.order.tp.price}}).then(s=>{s.isOk?(P([r.kind]),v.success(u("trading.orderChart.changeTpSuccess"))):(i.applyOptions({price:o}),T(s.message))}):l.dispatch("tradingOrder/executeOrder",{action:"sl",data:{cmd:"change",price:e.order.sl.price}}).then(s=>{s.isOk?(P([r.kind]),v.success(u("trading.orderChart.changeSlSuccess"))):(i.applyOptions({price:o}),T(s.message))})),a||(i.applyOptions({price:o}),v.show(u("trading.orderChart.noChangeOrderLine")))}break;case"line":l.dispatch("tradingOrder/drawTools",{isRemove:!1,name:r.lineType,points:[o],data:[r]}),D.value.classList.remove("selected");break;case"target":if(p.isSet(e.tools.target.B)){let a={isRemove:!1,name:"target",points:[],data:[]},s;const c=+e.tools.target.A.options().price,m=+e.tools.target.B.options().price-c;r.point=="A"&&(s="A",a.points.push(s),a.data.push(e.tools.target[s].options())),s="B",e.tools.target[s].applyOptions({title:m.toFixed(1)}),a.points.push(s),a.data.push(e.tools.target[s].options()),s="X",e.tools.target[s].applyOptions({price:+(c-.5*m).toFixed(1),title:(-.5*m).toFixed(1)}),a.points.push(s),a.data.push(e.tools.target[s].options()),s="Y",e.tools.target[s].applyOptions({price:+(c-m).toFixed(1),title:(-m).toFixed(1)}),a.points.push(s),a.data.push(e.tools.target[s].options()),s="Z",e.tools.target[s].applyOptions({price:+(c-2*m).toFixed(1),title:(-2*m).toFixed(1)}),a.points.push(s),a.data.push(e.tools.target[s].options()),l.dispatch("tradingOrder/drawTools",a)}break;case"rr":if(p.isSet(e.tools.rr.TP)){let a={isRemove:!1,symbol:d.symbol,name:"rr",points:[],data:[]},s;const c=+e.tools.rr.EP.options().price,y=+e.tools.rr.SL.options().price,m=+e.tools.rr.TP.options().price,h=y-c,x=m-c;if(x/h>0)return i.applyOptions({price:o}),!1;const pt=Math.abs(x)/Math.abs(h);s="EP",e.tools.rr[s].applyOptions({title:`RR=${pt.toFixed(1)}`}),a.points.push(s),a.data.push(e.tools.rr[s].options()),s="SL",e.tools.rr[s].applyOptions({title:`SL=${h.toFixed(1)}`}),a.points.push(s),a.data.push(e.tools.rr[s].options()),s="TP",e.tools.rr[s].applyOptions({title:`TP=${x.toFixed(1)}`}),a.points.push(s),a.data.push(e.tools.rr[s].options()),l.dispatch("tradingOrder/drawTools",a)}break}}function xe(){w.value&&(e.chart.resize(w.value.offsetWidth,w.value.offsetHeight),w.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function Se(t){if(t.ctrlKey||t.metaKey)switch(t.keyCode){case 38:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing+.05});break;case 40:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing-.05});break;case 37:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()-10);break;case 39:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()+10);break;case 96:ge.value.click();break;case 97:D.value.click();break;case 98:J.value.click();break;case 99:G.value.click();case 100:Q.value.click();break}}function be(){w.value&&(document.fullscreenElement?(d.isFullscreen=!0,w.value.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(d.isFullscreen=!1,w.value.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}function Le(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function Pe(){const t=l.state.tradingOrder.tools;for(const[i,r]of Object.entries(t))switch(i){case"order":C.value.pending&&Object.entries(r).forEach(([o,n])=>{e.order.side=n.side,e.order[o].price=n.price,e.order[o].line=e.series.price.createPriceLine(n),k(!0)});break;case"line":Object.values(r).forEach(o=>e.tools.lines.push(e.series.price.createPriceLine(o)));break;case"target":Object.entries(r).forEach(([o,n])=>e.tools.target[o]=e.series.price.createPriceLine(n));break;case"rr":Object.entries(r).forEach(([o,n])=>e.tools.rr[o]=e.series.price.createPriceLine(n));break;default:i.includes("uplps")?Object.entries(r).forEach(([o,n])=>e.tools.uplps[o]=e.series.price.createPriceLine(n)):i.includes("downlps")&&Object.entries(r).forEach(([o,n])=>e.tools.downlps[o]=e.series.price.createPriceLine(n));break}}function Re(){e.loadWhitespace&&(l.state.tradingOrder.chartData.price.length>0&&(e.data.whitespace=L(e.data.whitespace,Ee())),e.series.whitespace.setData(e.data.whitespace),e.loadWhitespace=!1),e.data.price=L(l.state.tradingOrder.chartData.price,e.data.price),e.data.vn30=L(l.state.tradingOrder.chartData.vn30,e.data.vn30),e.data.foreign=L(l.state.tradingOrder.chartData.foreign,e.data.foreign),e.data.active=L(l.state.tradingOrder.chartData.active,e.data.active),e.series.price.setData(e.data.price),e.series.vn30.setData(e.data.vn30),e.series.foreign.setData(e.data.foreign),e.series.active.setData(e.data.active)}function De(t){const i=e.data.original.length;if(e.data.original=L(e.data.original,[t]),e.data.original.length>i){const r=e.data.price.slice(-1)[0].value,o=e.data.cash.slice(-1)[0].value,n=t.price-r,a=n>0?1:n<0?-1:0,s={time:t.time,value:t.price},c={time:t.time,value:o+a*t.volume};e.data.price.push(s),e.series.price.update(s),e.data.cash.push(c),e.series.cash.update(c)}}function Ee(){const t=d.chartDate,i=moment(`${t}T09:00:00Z`).unix(),r=moment(`${t}T11:30:00Z`).unix(),o=moment(`${t}T13:00:00Z`).unix(),n=moment(`${t}T14:30:00Z`).unix();let a=[];for(let s=i;s<=n;s++)s>r&&s<o||a.push({time:s});return a}function L(t,i){return Array.from(new Map([...t,...i].sort((r,o)=>r.time-o.time).map(r=>[r.time,r])).values())}function H(){e.websocket=new WebSocket(Vt),e.websocket.onopen=t=>{let i={action:"join",list:l.state.tradingOrder.config.vn30f1m};e.websocket.send(`42${JSON.stringify(["regs",JSON.stringify(i)])}`)},e.websocket.onclose=t=>{if(e.socketStop)return!1;_()&&(te(!0),H(),moment().diff(e.socketRefreshTime,"seconds")>Wt&&Z())},e.websocket.onmessage=t=>{if(te(!1),t.data.substr(0,1)==4&&t.data.substr(1,1)==2){const i=JSON.parse(t.data.substr(2));if(i[0]=="stockps"){const r=i[1].data;r.id==3220&&(e.data.original.length>0&&De({time:moment(`${b} ${r.time}`).unix()+7*60*60,price:r.lastPrice,volume:r.lastVol}),st(),it())}}}}function $e(){const t=moment().unix();_(t)&&(C.value.position&&t>O.ATC-5*60&&(Fe(),t>O.ATC-15&&e.order.tp.hasOwnProperty("line")&&l.dispatch("tradingOrder/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(i=>{i.isOk?(A(["entry","tp","sl"]),k(!1),v.success(u("trading.orderChart.autoCancelTpSlSuccess")),B()):T(i.message)})),t==O.START&&H()),d.clock=moment().format("HH:mm:ss")}function Ae(){if(l.state.tradingOrder.config.openingMarket){const t=moment().unix();if(_(t)&&(e.order.tp.hasOwnProperty("line")||C.value.position&&t>O.ATO&&t<O.ATC&&(e.order.entry.price=e.data.price.slice(-1)[0].value,e.order.side=C.value.position,$.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-61?-61:1))+"px",$.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-51?-51:1))+"px",$.value.style.display="block"),!e.order.entry.hasOwnProperty("line"))){let i=null,r=0;C.value.position?(t<O.ATO?i="ATO":t>O.ATC&&(i="ATC"),i&&(e.order.entry.price=i,r=-C.value.position)):t>O.ATO&&t<O.ATC&&(i=M(e.crosshair.y),r=i>=e.data.price.slice(-1)[0].value?1:-1,e.order.side=r,e.order.entry.price=i),r&&(S.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-71?-71:1))+"px",S.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-61?-61:1))+"px",S.value.style.background=r>0?"green":"red",S.value.innerText=`${r>0?"LONG":"SHORT"} ${i}`,S.value.style.display="block")}}}function Y(){S.value.style.display="none",$.value.style.display="none"}function k(t){E.value.style.display=t?"block":"none"}function Fe(){E.value.classList.contains("blink")||E.value.classList.add("blink")}function te(t){t?R.value.classList.contains("blink")||R.value.classList.add("blink"):R.value.classList.contains("blink")&&R.value.classList.remove("blink")}function P(t){const i="order";let r={isRemove:!1,name:i,points:[],data:[]},o,n;t.forEach(a=>{switch(a){case"entry":o="yellow",n=e.order.side>0?"LONG":"SHORT";break;case"tp":o="lime",n=Math.abs(e.order.tp.price-e.order.entry.price).toFixed(1);break;case"sl":o="red",n=Math.abs(e.order.sl.price-e.order.entry.price).toFixed(1);break}if(r.points.push(a),e.order[a].hasOwnProperty("line"))e.order[a].line.applyOptions({price:e.order[a].price,title:n}),r.data.push(e.order[a].line.options());else{const s={lineType:i,kind:a,side:e.order.side,price:e.order[a].price,color:o,lineWidth:1,lineStyle:0,title:n,draggable:!0};e.order[a].line=e.series.price.createPriceLine(s),r.data.push(s)}}),l.dispatch("tradingOrder/drawTools",r)}function A(t){t.forEach(i=>{e.order[i].hasOwnProperty("line")&&(e.series.price.removePriceLine(e.order[i].line),delete e.order[i].line),l.dispatch("tradingOrder/drawTools",{isRemove:!0,name:"order"})})}function _e(t){d.showTradingView=!d.showTradingView,t.stopPropagation()}function Me(t){d.showLineContext=!1;const i=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(r=>r.classList.remove("selected")),i||t.target.classList.add("selected")}function Be(t){d.showLineContext=!d.showLineContext}function Ie(t=null,i=!1,r=!1){const o="line";t||(t=j(M(e.crosshair.y)));const n=e.tools.lines.length;if(e.tools.lines=e.tools.lines.filter(a=>{const s=a.options(),c=s.type=t==+s.price;return c&&(e.series.price.removePriceLine(a),l.dispatch("tradingOrder/drawTools",{isRemove:!0,name:o,point:t})),!c}),e.tools.lines.length==n&&!r||i){const a={lineType:o,price:t,color:d.lineColor,title:d.lineTitle,lineWidth:1,lineStyle:1,draggable:!0};e.tools.lines.push(e.series.price.createPriceLine(a)),l.dispatch("tradingOrder/drawTools",{isRemove:!1,name:o,points:[t],data:[a]})}D.value.classList.remove("selected")}function Ne(){e.tools.lines.length>0&&(e.tools.lines.forEach(t=>e.series.price.removePriceLine(t)),e.tools.lines=[],l.dispatch("tradingOrder/drawTools",{isRemove:!0,name:"line"}))}function qe(t){d.showLineContext=!1;const i=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(r=>r.classList.remove("selected")),i||t.target.classList.add("selected")}function Ve(t){re(),t.target.classList.remove("selected")}function We(){let t,i;const r="price",o="P";p.isSet(e.tools.uplps[`${o}1`])?(t=+e.tools.uplps[`${o}1`].options().startTime,i=e.crosshair.time,re()):t=e.crosshair.time;const{value1:n,value2:a}=Ue(t,i);let s={lineWidth:1,lineStyle:1,color:"#009688",draggable:!1},c={isRemove:!1,name:`${r}uplps`,points:[],data:[]};s.startTime=t,s.price=n,s.title=`${o}1`,e.tools.uplps[s.title]=e.series[r].createPriceLine(s),c.points.push(s.title),c.data.push(p.cloneDeep(s)),s.price=a,s.title=`${o}2`,e.tools.uplps[s.title]=e.series[r].createPriceLine(s),c.points.push(s.title),c.data.push(p.cloneDeep(s)),l.dispatch("tradingOrder/drawTools",c),W.value.classList.remove("selected")}function Ue(t,i){let r,o,n,a=0,s=0;const c=e.data.price;for(let y=0;y<c.length;y++){const m=c[y].time;if(m<t)continue;if(i&&m>i)break;const h=c[y].value;if(r==null&&(r=h,o=h,n=h),h>n)a>s&&(o=n,s=a),n=h,a=0;else if(h<n){const x=+(n-h).toFixed(2);x>a&&(a=x)}if(h<r&&s>0)break}return{value1:+(o-s).toFixed(2),value2:+(n-s).toFixed(2)}}function re(){const t="price",i="P",r=`${i}1`,o=`${i}2`;p.isSet(e.tools.uplps[r])&&(e.series[t].removePriceLine(e.tools.uplps[r]),e.series[t].removePriceLine(e.tools.uplps[o])),e.tools.uplps[r]={},e.tools.uplps[o]={},l.dispatch("tradingOrder/drawTools",{isRemove:!0,name:`${t}uplps`})}function He(t){d.showLineContext=!1;const i=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(r=>r.classList.remove("selected")),i||t.target.classList.add("selected")}function Ye(t){ie(),t.target.classList.remove("selected")}function je(){let t,i;const r="price",o="P";p.isSet(e.tools.downlps[`${o}1`])?(t=+e.tools.downlps[`${o}1`].options().startTime,i=e.crosshair.time,ie()):t=e.crosshair.time;const{value1:n,value2:a}=Ze(t,i);let s={lineWidth:1,lineStyle:1,color:"#E91E63",draggable:!1},c={isRemove:!1,name:`${r}downlps`,points:[],data:[]};s.startTime=t,s.price=n,s.title=`${o}1`,e.tools.downlps[s.title]=e.series[r].createPriceLine(s),c.points.push(s.title),c.data.push(p.cloneDeep(s)),s.price=a,s.title=`${o}2`,e.tools.downlps[s.title]=e.series[r].createPriceLine(s),c.points.push(s.title),c.data.push(p.cloneDeep(s)),l.dispatch("tradingOrder/drawTools",c),U.value.classList.remove("selected")}function Ze(t,i){let r,o,n,a=0,s=0;const c=e.data.price;for(let y=0;y<c.length;y++){const m=c[y].time;if(m<t)continue;if(i&&m>i)break;const h=c[y].value;if(r==null&&(r=h,o=h,n=h),h<n)a<s&&(o=n,s=a),n=h,a=0;else if(h>n){const x=+(n-h).toFixed(2);x<a&&(a=x)}if(h>r&&s<0)break}return{value1:+(o-s).toFixed(2),value2:+(n-s).toFixed(2)}}function ie(){const t="price",i="P",r=`${i}1`,o=`${i}2`;p.isSet(e.tools.downlps[r])&&(e.series[t].removePriceLine(e.tools.downlps[r]),e.series[t].removePriceLine(e.tools.downlps[o])),e.tools.downlps[r]={},e.tools.downlps[o]={},l.dispatch("tradingOrder/drawTools",{isRemove:!0,name:`${t}downlps`})}function ze(t){d.showLineContext=!1;const i=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(r=>r.classList.remove("selected")),i||(t.target.classList.add("selected"),se())}function Xe(t){se(),t.target.classList.remove("selected")}function Ke(){const t="target",i=M(e.crosshair.y);let r={lineType:t,price:i,lineWidth:1,lineStyle:1,draggable:!0},o={isRemove:!1,name:t,points:[],data:[]};if(p.isSet(e.tools.target.A)){const n=+e.tools.target.A.options().price,a=i-n;r.point="B",r.title=a.toFixed(1),r.color="#FF9800",e.tools.target[r.point]=e.series.price.createPriceLine(r),o.points.push(r.point),o.data.push(p.cloneDeep(r)),r.point="X",r.price=+(n-.5*a).toFixed(1),r.title=(-.5*a).toFixed(1),r.color="#2196F3",e.tools.target[r.point]=e.series.price.createPriceLine(r),o.points.push(r.point),o.data.push(p.cloneDeep(r)),r.point="Y",r.price=+(n-a).toFixed(1),r.title=(-a).toFixed(1),r.color="#673AB7",e.tools.target[r.point]=e.series.price.createPriceLine(r),o.points.push(r.point),o.data.push(p.cloneDeep(r)),r.point="Z",r.price=+(n-2*a).toFixed(1),r.title=(-2*a).toFixed(1),r.color="#673AB7",e.tools.target[r.point]=e.series.price.createPriceLine(r),o.points.push(r.point),o.data.push(p.cloneDeep(r)),q.value.classList.remove("selected")}else r.point="A",r.title="0",r.color="#FF9800",e.tools.target[r.point]=e.series.price.createPriceLine(r),o.points.push(r.point),o.data.push(p.cloneDeep(r));l.dispatch("tradingOrder/drawTools",o)}function se(){p.isSet(e.tools.target.A)&&(e.series.price.removePriceLine(e.tools.target.A),p.isSet(e.tools.target.B)&&(e.series.price.removePriceLine(e.tools.target.B),e.series.price.removePriceLine(e.tools.target.X),e.series.price.removePriceLine(e.tools.target.Y),e.series.price.removePriceLine(e.tools.target.Z)),e.tools.target={A:{},B:{},X:{},Y:{},Z:{}}),l.dispatch("tradingOrder/drawTools",{isRemove:!0,name:"target"})}function Ge(t){d.showLineContext=!1;const i=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(r=>r.classList.remove("selected")),i||(t.target.classList.add("selected"),oe())}function Je(t){oe(),t.target.classList.remove("selected")}function Qe(){const t="rr",i=M(e.crosshair.y);let r={lineType:t,price:i,lineWidth:1,lineStyle:1,draggable:!0},o={isRemove:!1,name:t,points:[],data:[]};if(p.isSet(e.tools.rr.EP)){const n=+e.tools.rr.EP.options().price;if(p.isSet(e.tools.rr.SL)){const s=+e.tools.rr.SL.options().price-n,c=i-n;if(c/s>0)return!1;r.point="TP",r.title=`TP=${c.toFixed(1)}`,r.color="lime",e.tools.rr[r.point]=e.series.price.createPriceLine(r),o.points.push(r.point),o.data.push(p.cloneDeep(r));const y=Math.abs(c)/Math.abs(s),m="EP";e.tools.rr[m].applyOptions({title:`RR=${y.toFixed(1)}`}),o.points.push(m),o.data.push(e.tools.rr[m].options()),V.value.classList.remove("selected")}else{const a=i-n;r.point="SL",r.title=`SL=${a.toFixed(1)}`,r.color="red",e.tools.rr[r.point]=e.series.price.createPriceLine(r),o.points.push(r.point),o.data.push(p.cloneDeep(r))}}else r.point="EP",r.title="RR=",r.color="yellow",e.tools.rr[r.point]=e.series.price.createPriceLine(r),o.points.push(r.point),o.data.push(p.cloneDeep(r));l.dispatch("tradingOrder/drawTools",o)}function oe(){p.isSet(e.tools.rr.EP)&&(e.series.price.removePriceLine(e.tools.rr.EP),p.isSet(e.tools.rr.SL)&&(e.series.price.removePriceLine(e.tools.rr.SL),p.isSet(e.tools.rr.TP)&&e.series.price.removePriceLine(e.tools.rr.TP))),e.tools.rr={EP:{},SL:{},TP:{}},l.dispatch("tradingOrder/drawTools",{isRemove:!0,name:"rr"})}async function et(){e.order.entry.hasOwnProperty("line")&&(e.order.tp.hasOwnProperty("line")?l.dispatch("tradingOrder/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(t=>{t.isOk?(A(["entry","tp","sl"]),k(!1),v.success(u("trading.orderChart.exitSuccess"))):(k(!0),T(t.message))}):l.dispatch("tradingOrder/executeOrder",{action:"entry",data:{cmd:"delete"}}).then(t=>{t.isOk?(A(["entry"]),k(!1),v.success(u("trading.orderChart.deleteEntrySuccess"))):(k(!0),T(t.message))}))}function tt(){const t=moment().unix();_(t)&&(t<O.ATO?de(u("trading.orderChart.atoOrder"),u("titles.confirm")).then(r=>{r&&l.dispatch("tradingOrder/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(o=>{o.isOk?v.success(u("trading.orderChart.atoOrderSuccess")):T(o.message)})}):t<O.ATC?l.dispatch("tradingOrder/executeOrder",{action:"entry",data:{cmd:"new",side:e.order.side,price:e.order.entry.price}}).then(i=>{i.isOk?(P(["entry"]),k(!0),v.success(u("trading.orderChart.newEntrySuccess"))):T(i.message)}):de(u("trading.orderChart.atcOrder"),u("titles.confirm")).then(r=>{r&&l.dispatch("tradingOrder/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(o=>{o.isOk?v.success(u("trading.orderChart.atcOrderSuccess")):T(o.message)})}))}function rt(){e.order.tp.price=e.order.entry.price+e.order.side*pe,e.order.sl.price=e.order.entry.price-e.order.side*ue,l.dispatch("tradingOrder/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.order.tp.price},slData:{cmd:"new",price:e.order.sl.price}}).then(t=>{t.isOk?(e.order.entry.line.applyOptions({draggable:!1}),P(["entry","tp","sl"]),v.success(u("trading.orderChart.newTpSlSuccess"))):T(t.message)})}function it(){if(e.order.entry.hasOwnProperty("line")){const t=e.data.price.slice(-1)[0].value;e.order.tp.hasOwnProperty("line")?((e.order.side>0&&t>=e.order.tp.price||e.order.side<0&&t<=e.order.tp.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,l.dispatch("tradingOrder/executeOrder",{action:"sl",data:{cmd:"delete"}}).then(i=>{i.isOk?(A(["entry","tp","sl"]),k(!1),v.success(u("trading.orderChart.deleteTpSuccess")),Y(),B()):T(i.message),e.isAutoOrdering=!1}))),(e.order.side>0&&t<=e.order.sl.price||e.order.side<0&&t>=e.order.sl.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,l.dispatch("tradingOrder/executeOrder",{action:"tp",data:{cmd:"cancel"}}).then(i=>{i.isOk?(A(["entry","tp","sl"]),k(!1),v.success(u("trading.orderChart.deleteSlSuccess")),Y(),B()):T(i.message),e.isAutoOrdering=!1})))):(e.order.side>0&&t>=e.order.entry.price||e.order.side<0&&t<=e.order.entry.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,setTimeout(()=>{e.order.tp.price=e.order.entry.price+e.order.side*pe,e.order.sl.price=e.order.entry.price-e.order.side*ue,l.dispatch("tradingOrder/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.order.tp.price},slData:{cmd:"new",price:e.order.sl.price}}).then(i=>{i.isOk?(e.order.entry.line.applyOptions({draggable:!1}),P(["entry","tp","sl"]),v.success(u("trading.orderChart.autoNewTpSlSuccess")),B()):T(i.message),e.isAutoOrdering=!1})},1e3)))}}function st(){if(C.value.position&&p.isSet(e.target.X)){const t=e.data.cash.slice(-1)[0].value,i=+e.target.B.options().price,r=+e.target.X.options().price,o=r-i;(o>0&&t>=r||o<0&&t<=r)&&E.value.click()}}function ot(){e.chart.timeScale().scrollToRealTime()}function _(t=null){return t||(t=moment().unix()),t>=O.START&&t<=O.END}function M(t,i="price"){return j(e.series[i].coordinateToPrice(t))}function j(t){return t?+ +t.toFixed(1):0}function T(t){t||(t="unknown"),v.error(u(`trading.orderChart.${t}`))}function at(){e.loadWhitespace=!0,l.dispatch("tradingOrder/getChartData",d.chartDate)}function Z(){e.socketRefreshTime=moment(),e.loadWhitespace=!0,l.dispatch("tradingOrder/getChartData",d.chartDate)}function nt(){e.data.original=[],e.data.price=[],e.data.cash=[],e.data.whitespace=[],Z()}function B(){let t=new Audio(bt);t.crossOrigin="anonymous",t.addEventListener("canplaythrough",function(){t.play()})}function lt(){l.dispatch("tradingOrder/getAccountInfo").then(t=>{let i="";i+='<div style="width: 200px;">',i+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${u("trading.orderChart.nav")}</div><div>: ${F.currency(t.nav)}</div></div>`,i+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${u("trading.orderChart.maxVol")}</div><div>: ${F.numberVnFormat(t.maxVol)}</div></div>`,i+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${u("trading.orderChart.vm")}</div><div>: ${F.currency(t.vm)}</div></div>`,i+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${u("trading.orderChart.fee")}</div><div>: ${F.currency(t.fee)}</div></div>`,i+="</div>",Tt(i,u("trading.orderChart.accountInfo"))})}function ct(){X.emit("checkPin",()=>l.dispatch("tradingOrder/report"))}function dt(){X.emit("checkPin",()=>l.dispatch("tradingOrder/export"))}return(t,i)=>{const r=wt("DxToolbar");return kt(),vt("div",Lt,[ne(r,{items:[{location:"before",widget:"dxButton",options:{icon:"far fa-poll small",hint:t.$t("trading.orderChart.buttons.report"),onClick:ct}},{location:"before",widget:"dxButton",options:{icon:"far fa-file-export small",hint:t.$t("trading.orderChart.buttons.export"),onClick:dt}}]},null,8,["items"]),f("div",{class:"order-chart-container",ref_key:"chartContainerRef",ref:w,onClick:Oe,onContextmenu:Ce},[f("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:K},[f("div",{class:"area data-area",onClick:ee},[f("div",{ref_key:"connectionRef",ref:R,class:I(`command far fa-${C.value.connection?"link":"unlink"}`),title:t.$t("trading.orderChart.connection"),onClick:i[0]||(i[0]=()=>t.$store.dispatch("tradingOrder/getStatus"))},null,10,Pt),f("div",{class:I(["command status",{green:C.value.position>0,red:C.value.position<0,pending:C.value.pending}]),title:t.$t("trading.orderChart.position"),onClick:lt},le(C.value.position),11,Rt),f("div",{class:"command clock",onClick:Z},le(d.clock),1),z(f("input",{type:"date",class:"chart-date command",title:t.$t("trading.orderChart.date"),"onUpdate:modelValue":i[1]||(i[1]=o=>d.chartDate=o),onChange:at},null,40,Dt),[[yt,d.chartDate]]),f("div",{ref_key:"reloadToolRef",ref:J,class:"command",title:t.$t("trading.orderChart.reload"),onClick:nt},[f("i",{class:I(`far fa-sync-alt ${t.$store.state.tradingOrder.isChartLoading?"fa-spin":""}`)},null,2)],8,Et)]),f("div",{class:"area tool-area",onClick:ee,onContextmenu:Te},[f("div",{ref_key:"fullscreenToolRef",ref:G,class:I(`command far fa-${d.isFullscreen?"compress":"expand"}`),title:t.$t("trading.orderChart.fullscreen"),onClick:Le},null,10,$t),f("div",{ref_key:"tradingviewRef",ref:Q,class:"command far fa-chart-bar",title:t.$t("trading.orderChart.tradingview"),onClick:_e},null,8,At),f("div",{ref_key:"lineToolRef",ref:D,class:"line command far fa-horizontal-rule",title:t.$t("trading.orderChart.lineTool"),onClick:Me,onContextmenu:Be},[z(ne(xt,{class:"line-contextmenu",enable:d.showLineContext,title:d.lineTitle,"onUpdate:title":i[2]||(i[2]=o=>d.lineTitle=o),color:d.lineColor,"onUpdate:color":i[3]||(i[3]=o=>d.lineColor=o),onDeleteAllLine:Ne},null,8,["enable","title","color"]),[[ce,d.showLineContext]])],40,Ft),f("div",{ref_key:"uplpsToolRef",ref:W,class:"command far fa-arrow-up",title:t.$t("trading.orderChart.uplpsTool"),onClick:qe,onContextmenu:Ve},null,40,_t),f("div",{ref_key:"downlpsToolRef",ref:U,class:"command far fa-arrow-down",title:t.$t("trading.orderChart.downlpsTool"),onClick:He,onContextmenu:Ye},null,40,Mt),f("div",{ref_key:"targetToolRef",ref:q,class:"command far fa-flag-checkered",title:t.$t("trading.orderChart.targetTool"),onClick:ze,onContextmenu:Xe},null,40,Bt),f("div",{ref_key:"rrToolRef",ref:V,class:"command far fa-line-height",title:t.$t("trading.orderChart.rrTool"),onClick:Ge,onContextmenu:Je},null,40,It),f("div",{ref_key:"cancelOrderRef",ref:E,class:"cancel-order command far fa-trash-alt",title:t.$t("trading.orderChart.cancelTool"),onClick:et},null,8,Nt)],32),f("div",null,[f("div",{ref_key:"entryOrderRef",ref:S,class:"order-button entry",onClick:tt}," Entry ",512),f("div",{ref_key:"tpslOrderRef",ref:$,class:"order-button tpsl",onClick:rt}," TP/SL ",512),f("div",{class:"chart-top command far fa-angle-double-right",onClick:ot})]),z(f("iframe",{ref_key:"tradingviewChartRef",ref:ve,class:"tradingview-chart",src:ye.value},null,8,qt),[[ce,d.showTradingView]])],512)],544)])}}};export{zt as default};
