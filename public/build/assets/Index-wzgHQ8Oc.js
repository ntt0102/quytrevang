import{u as j,r as T,a as Y,c as y,w as J,b as Q,d as E,e as o,f as g,g as l,F as W,h as Z,i as ee,j as ae,k as h,x as F,m as te,o as b,n,p as B,q as I}from"./app-C-_8oFgh.js";import{_ as q}from"./ListTagBox-B41RRbbC.js";import oe from"./DeletedUsersPopup-DchnIR72.js";import ie from"./ConfirmUserPopup-BjssuWfx.js";import{_ as le}from"./UserDetailPopup-BcPq6c2s.js";import{i as M,s as ne}from"./subDays-DE25FDAt.js";import{s as se}from"./subYears-D9qYi9FD.js";import"./accordion-DdQ-OazR.js";import"./Index-DJeKkVcw.js";const re={class:"users-page content-block dx-card responsive-paddings"},de=["src"],we={__name:"Index",setup(ue){const u=Z(),w=ee(),p=ae(),{t}=j(),C=h("bus"),U=h("filters"),d=h("mt"),m=h("mf"),k=h("routeHistoryState"),s=T(null),$=T(null),r=Y({gridData:null,banks:[],rolesCalculateFilterExpression:function(e,i,c){return c==="search"&&typeof e=="string"?["roles","contains",e]:function(a){return(a.roles||[]).indexOf(e)!==-1}},permissionsCalculateFilterExpression:function(e,i,c){return c==="search"&&typeof e=="string"?["permissions","contains",e]:function(a){return(a.permissions||[]).indexOf(e)!==-1}},validationRules:{name:[{type:"required",message:t("models.user.name")+d.validations.required},{type:"stringLength",max:50,message:t("models.user.validations.name")}],sex:[{type:"required",message:t("models.user.sex")+d.validations.required}],role:[{type:"required",message:t("models.user.roles")+d.validations.required}],birthday:[{type:"required",message:t("models.user.birthday")+d.validations.required},{type:"custom",validationCallback:_,message:t("models.user.validations.birthday")}],idNumber:[{type:"required",message:t("models.user.idNumber")+d.validations.required},{type:"async",validationCallback:e=>u.dispatch("adminUser/validateDuplicateIdNumber",e),message:t("models.user.idNumber")+d.validations.duplicate}],idIssuedOn:[{type:"required",message:t("models.user.idIssuedOn")+d.validations.required},{type:"custom",validationCallback:z,message:t("models.user.validations.idIssuedOn")}],phone:[{type:"required",message:t("models.user.phone")+d.validations.required},{type:"async",validationCallback:e=>u.dispatch("adminUser/validateDuplicatePhone",e),message:t("models.user.phone")+d.validations.duplicate}],email:[{type:"required",message:t("models.user.email")+d.validations.required},{type:"email",message:t("models.user.email")+d.validations.email},{type:"async",validationCallback:e=>u.dispatch("adminUser/validateDuplicateEmail",e),message:t("models.user.email")+d.validations.duplicate}],address:[{type:"required",message:t("models.user.address")+d.validations.required},{type:"stringLength",max:100,message:t("models.user.validations.address")}]}}),f=y(()=>u.state.auth.user.permissions),N=y(()=>u.state.auth.user.code),S=y(()=>u.state.adminUser.allRolesName),D=y(()=>u.state.adminUser.allPermissionsName);u.dispatch("adminUser/getUsers").then(()=>m.getBanks()).then(e=>r.banks=e),J(()=>u.state.adminUser.users,e=>L(e));function P(e){e.changes.length&&C.emit("checkPin",()=>{e.isDeleted=!1,u.dispatch("adminUser/save",e)})}function O(e){e.toolbarOptions.items.unshift({visible:m.isSet(p.query),location:"before",widget:"dxButton",options:{icon:"far fa-arrow-left small",hint:t("buttons.back"),onClick:()=>{w.go(-1)}}},{locateInMenu:"auto",showText:"inMenu",location:"before",widget:"dxButton",options:{icon:"far fa-share-square small",hint:t("admin.users.buttons.sendNotification"),text:t("admin.users.buttons.sendNotification"),onClick:()=>{s.value.instance.getSelectedRowKeys().length>0?w.push({name:"setting-notification",query:{codes:s.value.instance.getSelectedRowKeys().join(",")}}):F.show(t("messages.info.noSelectedRow"))}}},{locateInMenu:"auto",showText:"inMenu",location:"before",widget:"dxButton",options:{icon:"far fa-trash small",hint:t("admin.users.buttons.selectedDelete"),text:t("admin.users.buttons.selectedDelete"),onClick:()=>{let i=s.value.instance.getSelectedRowKeys();i.length>0?(C.emit("checkPin",()=>{s.value.instance.option("editing.mode","batch"),i.forEach(c=>{s.value.instance.deleteRow(s.value.instance.getRowIndexByKey(c))}),s.value.instance.saveEditData()}),s.value.instance.option("editing.mode","popup")):F.show(t("messages.info.noSelectedRow"))}}},{locateInMenu:"auto",showText:"inMenu",location:"before",widget:"dxButton",options:{icon:"far fa-user-times small",hint:t("admin.users.deletedUsers"),text:t("admin.users.deletedUsers"),onClick:()=>$.value.show()}})}function x(e,i){var c="Â ",a=(i.value||[]).map(v=>i.column.lookup.calculateCellValue(v)).join(", ");e.textContent=a||c,e.title=a}function R(e,i){i.setValue(e),i.component.updateDimensions()}function _(e){return M(new Date(e.value),se(new Date,18))}function z(e){return M(new Date(e.value),ne(new Date,1))}function A(e){e.data.roles=["user"],e.data.bank_account={},s.value.instance.option("editing.popup.title",t("models.user.popup.create"))}function H(e){s.value.instance.option("editing.popup.title",`${t("models.user.popup.edit")} #${e.data.code}`)}function L(e){r.gridData=m.cloneDeep(e),p.query.code&&s.value.instance.columnOption("code","filterValues",[+p.query.code]),p.query.selected&&setTimeout(()=>s.value.instance.selectRows(p.query.selected.split(","),!0),0)}function K(e){m.pushPopupToHistoryState(k,()=>s.value.instance.cancelEditData())}function V(){m.popRouteHistoryState(k)}function G(e){if(e.rowType==="data"){if(e.column.dataField==="level"){let i;e.value<4?i="#adadad":e.value==4?i="#edc578":i="#86c285",e.cellElement.style.color=i}e.column.dataField==="phone"&&(e.cellElement.innerHTML=U.phone(e.value))}}function X(e){e.rowType=="data"&&e.columnIndex==5&&m.openLink(`https://zalo.me/${e.data.phone}`)}return(e,i)=>{const c=te("DxToolbar");return b(),Q(W,null,[E("div",re,[o(l(n.DxDataGrid),{ref_key:"dataGridRef",ref:s,"data-source":r.gridData,"key-expr":"code","show-borders":!0,"column-auto-width":!0,"allow-column-reordering":!0,"allow-column-resizing":!0,"column-resizing-mode":"widget","column-chooser":{enabled:!0,mode:"select",allowSearch:!0},paging:{pageSize:10},headerFilter:{visible:!0},loadPanel:{enabled:!0},selection:{mode:"multiple",showCheckBoxesMode:"always"},editing:{allowAdding:!0,allowUpdating:!0,allowDeleting:!0,confirmDelete:!1,mode:"popup",popup:{showTitle:!0,onShown:K,onHidden:V},form:{colCount:2,labelLocation:e.$screen.getScreenSizeInfo.isXSmall?"top":"left",items:[{itemType:"group",caption:e.$t("models.user.groups.personalInfo"),items:[{dataField:"name"},{dataField:"sex"},{dataField:"birthday"}]},{itemType:"group",caption:e.$t("models.user.groups.idInfo"),items:[{dataField:"identity.number"},{dataField:"identity.issued_on"},{dataField:"",editorOptions:{value:e.$mt.idIssuedAtValue,readOnly:!0},label:{text:e.$t("models.user.idIssuedAt")}}]},{colCount:2,colSpan:2,itemType:"group",caption:e.$t("models.user.groups.contactInfo"),items:[{dataField:"phone"},{dataField:"email"},{dataField:"address",colSpan:2}]},{colCount:2,colSpan:2,itemType:"group",caption:e.$t("models.user.groups.bankInfo"),items:[{dataField:"bank_account.bank_name"},{dataField:"bank_account.account_name"},{dataField:"bank_account.account_number"}]},{visible:f.value.includes("admin:control_system"),colCount:2,colSpan:2,itemType:"group",caption:e.$t("models.user.groups.permission"),items:[{dataField:"roles",colSpan:2},{dataField:"permissions",colSpan:2}]}]}},onCellPrepared:G,onContentReady:i[0]||(i[0]=a=>e.$mf.dataGridPreload(r.gridData,s.value.instance)),onToolbarPreparing:O,onInitNewRow:A,onEditingStart:H,onCellDblClick:X,onSaved:P},{avatarCellTemplate:g(({data:a})=>[E("img",{src:a.value,width:40,style:{borderRadius:"50%"}},null,8,de)]),roleTagBoxEditor:g(({data:a})=>[o(q,{value:a.value,"on-value-changed":v=>R(v,a),"data-source":S.value,"data-grid-component":a.component},null,8,["value","on-value-changed","data-source","data-grid-component"])]),permissionTagBoxEditor:g(({data:a})=>[o(q,{value:a.value,"on-value-changed":v=>R(v,a),"data-source":D.value,"data-grid-component":a.component},null,8,["value","on-value-changed","data-source","data-grid-component"])]),commandCellTemplate:g(({data:a})=>[o(c,{items:[{visible:[4,5].includes(a.data.level)||f.value.includes("admin:control_system")&&a.data.level>5,locateInMenu:"auto",showText:"inMenu",location:"center",widget:"dxButton",options:{type:"default",icon:`far fa-${a.data.level==4?"check":"file-check"} small`,hint:e.$t(`components.confirmUser.${a.data.level==4?"title":"confirmedTitle"}`),text:e.$t(`components.confirmUser.${a.data.level==4?"title":"confirmedTitle"}`),onClick:()=>e.$refs.confirmUserPopupRef.show({user:a.data})}},{visible:a.data.level>=6,locateInMenu:"auto",showText:"inMenu",location:"center",widget:"dxButton",options:{type:"default",icon:"far fa-usd-circle small",hint:e.$t("admin.users.buttons.viewContract"),text:e.$t("admin.users.buttons.viewContract"),onClick:()=>e.$router.push({name:"admin-contract",query:{userCode:a.data.code}})}},{visible:!a.data.permissions.includes("admin:control_system")||f.value.includes("admin:control_system"),locateInMenu:"auto",showText:"inMenu",location:"center",widget:"dxButton",options:{type:"default",icon:"edit",hint:e.$t("buttons.edit"),text:e.$t("buttons.edit"),onClick:()=>s.value.instance.editRow(a.rowIndex)}},{visible:a.data.level<=6&&a.data.code!=N.value&&!a.data.permissions.includes("admin:control_system"),locateInMenu:"auto",showText:"inMenu",location:"center",widget:"dxButton",options:{type:"default",icon:"trash",hint:e.$t("buttons.delete"),text:e.$t("buttons.delete"),onClick:()=>e.$bus.emit("checkPin",()=>s.value.instance.deleteRow(a.rowIndex))}},{locateInMenu:"auto",showText:"inMenu",location:"center",widget:"dxButton",options:{type:"default",icon:"info",hint:e.$t("admin.users.detailUser"),text:e.$t("admin.users.detailUser"),onClick:()=>e.$refs.userDetailPopupRef.show(a.data)}}]},null,8,["items"])]),default:g(()=>[o(l(n.DxColumn),{fixed:!0,width:e.$screen.getScreenSizeInfo.isXSmall?35:125,type:"buttons",cssClass:"dx-datagrid-command-column","cell-template":"commandCellTemplate",caption:e.$t(`titles.commandHeaderTitle${e.$screen.getScreenSizeInfo.isXSmall?"Short":""}`)},null,8,["width","caption"]),o(l(n.DxColumn),{width:60,"allow-sorting":!1,allowFiltering:!1,"data-field":"url_avatar","cell-template":"avatarCellTemplate",cssClass:"avatar-column",caption:e.$t("models.user.avatar")},null,8,["caption"]),o(l(n.DxColumn),{"allow-editing":!1,"data-field":"code","data-type":"string","header-filter":{allowSearch:!0},name:"code",caption:e.$t("models.user.codeShort")},null,8,["caption"]),o(l(n.DxColumn),{"allow-editing":!1,"data-field":"level",dataType:"number",caption:e.$t("models.user.status"),lookup:{dataSource:e.$mf.getUserLevelList(),displayExpr:"name",valueExpr:"value"}},null,8,["caption","lookup"]),o(l(n.DxColumn),{"data-field":"name","data-type":"string","header-filter":{allowSearch:!0},caption:e.$t("models.user.name"),"validation-rules":r.validationRules.name},null,8,["caption","validation-rules"]),o(l(n.DxColumn),{visible:!1,"data-field":"sex","data-type":"number",caption:e.$t("models.user.sex"),"validation-rules":r.validationRules.sex,lookup:{dataSource:e.$mf.getSexList(),displayExpr:"name",valueExpr:"value"}},null,8,["caption","validation-rules","lookup"]),o(l(n.DxColumn),{visible:!1,"data-field":"birthday","data-type":"date","editor-options":{dateSerializationFormat:e.$mc.DX_SERVER_DATE_FORMAT,showClearButton:"true",useMaskBehavior:"true"},caption:e.$t("models.user.birthday"),"validation-rules":r.validationRules.birthday},null,8,["editor-options","caption","validation-rules"]),o(l(n.DxColumn),{visible:!1,"data-field":"identity.number","data-type":"string","editor-options":{mask:"000000000000"},"header-filter":{allowSearch:!0},caption:e.$t("models.user.idNumber"),"validation-rules":r.validationRules.idNumber},null,8,["caption","validation-rules"]),o(l(n.DxColumn),{visible:!1,"data-field":"identity.issued_on","data-type":"date","editor-options":{dateSerializationFormat:e.$mc.DX_SERVER_DATE_FORMAT,showClearButton:"true",useMaskBehavior:"true"},caption:e.$t("models.user.idIssuedOn"),"validation-rules":r.validationRules.idIssuedOn},null,8,["editor-options","caption","validation-rules"]),o(l(n.DxColumn),{"data-field":"phone","data-type":"string","editor-options":{mask:"0000.000.000"},"header-filter":{allowSearch:!0},caption:e.$t("models.user.phone"),"validation-rules":r.validationRules.phone},null,8,["caption","validation-rules"]),o(l(n.DxColumn),{visible:!1,"data-field":"email","data-type":"string",name:"email","header-filter":{allowSearch:!0},caption:e.$t("models.user.email"),"validation-rules":r.validationRules.email},null,8,["caption","validation-rules"]),o(l(n.DxColumn),{visible:!1,"data-field":"address","data-type":"string","header-filter":{allowSearch:!0},caption:e.$t("models.user.address"),"validation-rules":r.validationRules.address},null,8,["caption","validation-rules"]),o(l(n.DxColumn),{visible:!1,"data-field":"bank_account.bank_name","data-type":"string",lookup:{dataSource:r.banks,displayExpr:"short_name",valueExpr:"short_name",allowClearing:!0},"header-filter":{allowSearch:!0},caption:e.$t("models.user.bankName")},null,8,["lookup","caption"]),o(l(n.DxColumn),{visible:!1,"data-field":"bank_account.account_name","data-type":"string","header-filter":{allowSearch:!0},caption:e.$t("models.user.accountName")},null,8,["caption"]),o(l(n.DxColumn),{visible:!1,"data-field":"bank_account.account_number","data-type":"string","header-filter":{allowSearch:!0},caption:e.$t("models.user.accountNumber")},null,8,["caption"]),f.value.includes("admin:control_system")?(b(),B(l(n.DxColumn),{key:0,visible:!1,"allow-sorting":!1,"data-field":"roles","data-type":"string","cell-template":x,"calculate-filter-expression":r.rolesCalculateFilterExpression,caption:e.$t("models.user.roles"),"edit-cell-template":"roleTagBoxEditor","validation-rules":r.validationRules.role,lookup:{dataSource:S.value}},null,8,["calculate-filter-expression","caption","validation-rules","lookup"])):I("",!0),f.value.includes("admin:control_system")?(b(),B(l(n.DxColumn),{key:1,visible:!1,"allow-sorting":!1,"data-field":"permissions","data-type":"string","cell-template":x,"calculate-filter-expression":r.permissionsCalculateFilterExpression,caption:e.$t("models.user.permissions"),"edit-cell-template":"permissionTagBoxEditor",lookup:{dataSource:D.value}},null,8,["calculate-filter-expression","caption","lookup"])):I("",!0)]),_:1},8,["data-source","editing"])]),o(oe,{ref_key:"deletedUsersPopupRef",ref:$},null,512),o(ie,{ref:"confirmUserPopupRef"},null,512),o(le,{ref:"userDetailPopupRef"},null,512)],64)}}};export{we as default};
