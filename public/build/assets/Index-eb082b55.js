import{A as ci,B as di,C as pi,E as at,r as b,w as de,y as lt,o as I,b as z,m as Ne,d as h,t as ae,e as G,f as it,F as Be,G as ot,g as Le,c as ne,a as ct,q as he,H,p as be,I as ui,J as fi,l as ke,u as vi,K as mi,x as $,L as ee,M as hi,N as se,h as gi,j as yi,k as De,z as rt,O as Si}from"./app-fdea46f1.js";import Ti from"./LineContextMenu-e372bcb6.js";import{_ as xi,g as V}from"./select-box-5378ea6a.js";import Ci from"./VpsOtpPopup-598eeb9c.js";import{c as wi}from"./lightweight-charts.esm.development-03366bac.js";import"./text-box-58705558.js";function ki(L,E,S){return ci((S==null?void 0:S.in)||L,+di(L)+E)}function Ze(L,E,S){return ki(L,E*pi,S)}const Di=[{price:[[0,100],[50,30],[120,90],[170,50],[200,70],[300,0]],volume:[[0,180],[50,160],[120,200],[170,140],[200,170],[300,100]],et:[[217,50],[237,50]],sl:[[190,70],[210,70]],tp1:[[160,50],[180,50],2],time:170},{price:[[0,100],[50,30],[90,60],[110,40],[140,90],[170,60],[200,80],[300,0]],volume:[[0,200],[50,140],[90,180],[110,160],[140,190],[170,150],[200,170],[300,100]],et:[[215,60],[235,60]],sl:[[190,80],[210,80]],tp1:[[160,60],[180,60],2],time:170},{price:[[0,100],[50,30],[90,90],[130,40],[170,80],[200,50],[230,70],[300,0]],volume:[[0,200],[50,140],[90,180],[130,160],[170,190],[200,150],[230,170],[300,100]],et:[[240,50],[260,50]],sl:[[220,70],[240,70]],tp1:[[120,40],[140,40],2],time:200},{price:[[0,100],[70,20],[110,90],[170,35],[185,70],[200,50],[215,80],[230,40],[245,60],[300,0]],volume:[[0,140],[40,180],[70,120],[110,190],[170,150],[215,170],[300,100]],et:[[255,40],[275,40]],sl:[[235,60],[255,60]],tp1:[[160,35],[180,35],1],time:70},{price:[[0,100],[40,40],[70,60],[110,20],[150,70],[200,50],[240,80],[300,0]],volume:[[0,200],[40,130],[70,160],[110,140],[150,170],[200,150],[240,180],[300,100]]},{price:[[0,100],[40,40],[70,60],[110,20],[150,80],[180,40],[200,60],[220,50],[250,70],[300,0]],volume:[[0,200],[40,130],[70,160],[110,140],[150,170],[180,150],[250,180],[300,100]]},{price:[[0,100],[40,70],[70,80],[110,20],[150,70],[160,40],[180,60],[200,30],[250,80],[300,0]],volume:[[0,200],[40,130],[70,160],[110,140],[150,170],[200,150],[240,180],[300,100]]},{price:[[0,100],[40,60],[70,85],[110,45],[150,65],[200,30],[240,45],[300,0]],volume:[[0,200],[40,130],[70,160],[110,140],[150,170],[200,150],[240,180],[300,100]]}],bi=[{price:[[0,30],[50,0],[100,100],[130,60],[150,75],[170,60],[190,80],[220,40],[250,60],[300,0]],volume:[[0,190],[50,170],[100,200],[130,130],[190,160],[220,120],[250,140],[300,100]],et:[[257,40],[277,40]],sl:[[240,60],[260,60]],tp1:[[210,40],[230,40],2],time:130},{price:[[0,40],[50,10],[100,90],[120,60],[140,80],[170,40],[200,100],[230,60],[250,90],[300,0]],volume:[[0,190],[50,170],[100,200],[170,130],[200,160],[230,140],[250,150],[300,100]],et:[[257,60],[277,60]],sl:[[240,90],[260,90]],tp1:[[160,40],[180,40],.5],tp2:[[40,10],[60,10]],time:170},{price:[[0,80],[40,20],[70,60],[110,0],[140,50],[180,10],[210,40],[250,20],[300,100]],volume:[[0,180],[40,100],[70,130],[110,110],[140,145],[180,125],[210,160],[250,140],[300,200]]},{price:[[0,80],[40,0],[70,60],[110,10],[140,50],[180,20],[210,40],[250,30],[300,100]],volume:[[0,180],[40,100],[70,130],[110,110],[140,145],[180,125],[210,160],[250,140],[300,200]]},{price:[[0,80],[40,20],[70,60],[110,10],[140,60],[180,0],[210,70],[250,50],[300,100]],volume:[[0,180],[40,100],[70,130],[110,110],[140,145],[180,125],[210,160],[250,140],[300,200]]}],Me={continueData:Di,reversalData:bi};const Li={__name:"Pattern",props:["pattern"],setup(L){const E=L,S=b(null),x=b(E.pattern);de(()=>E.pattern,_=>{x.value=_,p(!0)}),lt(()=>setTimeout(()=>{p()},0));function p(_=!1){if(!x.value)return!1;const c=S.value,m=c.getContext("2d");_&&m.clearRect(0,0,c.width,c.height);const v=x.value.price,B=x.value.volume,T=x.value.et,D=x.value.sl,P=x.value.tp1,N=x.value.tp2,pe=x.value.time;m.beginPath(),m.strokeStyle="white",m.lineWidth=2,m.setLineDash([1,0]),m.moveTo(v[0][0],v[0][1]);for(let Y=1;Y<v.length;Y++)m.lineTo(v[Y][0],v[Y][1]);m.stroke(),m.beginPath(),m.strokeStyle="orange",m.moveTo(B[0][0],B[0][1]);for(let Y=1;Y<B.length;Y++)m.lineTo(B[Y][0],B[Y][1]);m.stroke(),T&&(m.beginPath(),m.strokeStyle="yellow",m.moveTo(T[0][0],T[0][1]),m.lineTo(T[1][0],T[1][1]),m.stroke()),D&&(m.beginPath(),m.strokeStyle="red",m.moveTo(D[0][0],D[0][1]),m.lineTo(D[1][0],D[1][1]),m.stroke()),P&&(m.beginPath(),m.strokeStyle="lime",m.moveTo(P[0][0],P[0][1]),m.lineTo(P[1][0],P[1][1]),m.stroke(),m.font="15px Arial",m.fillStyle="lime",m.fillText(P[2],P[1][0]+5,P[1][1]+5)),N&&(m.beginPath(),m.strokeStyle="lime",m.moveTo(N[0][0],N[0][1]),m.lineTo(N[1][0],N[1][1]),m.stroke()),pe&&(m.beginPath(),m.strokeStyle="red",m.setLineDash([5,10]),m.moveTo(pe,0),m.lineTo(pe,200),m.stroke())}return(_,c)=>(I(),z("canvas",{ref_key:"canvasRef",ref:S,width:"300",height:"200"},null,512))}},We=at(Li,[["__scopeId","data-v-251fbed0"]]);const Oi=h("div",{class:"triangle-shadow"},null,-1),Ri=h("div",{class:"triangle"},null,-1),_i={class:"container"},Fi={class:"continue"},Pi={class:"title"},Ai={class:"name"},$i={class:"reversal"},Vi={class:"title"},Ii={class:"name"},Ei={__name:"Index",setup(L){function E(S){S.stopPropagation()}return(S,x)=>{const p=Ne("DxScrollView");return I(),z("div",{class:"pattern-popup",onClick:E,title:""},[Oi,Ri,h("div",_i,[h("div",Fi,[h("div",Pi,ae(S.$t("trading.derivative.patternContextMenu.continue")),1),G(p,{class:"items"},{default:it(()=>[(I(!0),z(Be,null,ot(Le(Me).continueData,(_,c)=>(I(),z("div",{key:c},[h("div",Ai,ae(c+1)+".",1),G(We,{pattern:_},null,8,["pattern"])]))),128))]),_:1})]),h("div",$i,[h("div",Vi,ae(S.$t("trading.derivative.patternContextMenu.reversal")),1),G(p,{class:"items"},{default:it(()=>[(I(!0),z(Be,null,ot(Le(Me).reversalData,(_,c)=>(I(),z("div",{key:c},[h("div",Ii,ae(c+1)+".",1),G(We,{pattern:_},null,8,["pattern"])]))),128))]),_:1})])])])}}};const Zi={key:0,class:"tree-node"},Bi={key:0,class:"text"},Mi={key:2},Wi=["innerHTML"],Ni={__name:"TreeNode",props:["node","index","modelValue"],emits:["update:modelValue"],setup(L,{emit:E}){const S=L,x=E,p=ne(()=>Array.isArray(S.node.items)),_=ne(()=>Array.isArray(S.node.items)&&S.node.items.length>1),c=ct({selectedChild:S.node.items[S.modelValue[S.index]],childValue:S.modelValue,hasChild:!1});c.hasChild=!!c.selectedChild;let m=!1;de(()=>S.modelValue,T=>{m=!0,c.selectedChild=S.node.items[T[S.index]],c.childValue=T,c.hasChild=!!c.selectedChild,setTimeout(()=>m=!1,1e3)}),de(()=>S.node,T=>{m=!0,c.selectedChild=T.items[c.childValue[S.index]],c.hasChild=!!c.selectedChild,setTimeout(()=>m=!1,1e3)});function v(){if(m)return!1;c.hasChild=!1,setTimeout(()=>{c.selectedChild&&(c.hasChild=!0)},0);const T=S.node.items.findIndex(D=>D===c.selectedChild);T==-1?c.childValue=c.childValue.slice(0,S.index):(c.childValue=c.childValue.slice(0,S.index+1),c.childValue[S.index]=T),x("update:modelValue",c.childValue)}function B(T){x("update:modelValue",T)}return(T,D)=>{const P=Ne("TreeNode",!0);return L.node.items?(I(),z("div",Zi,[L.index==0?(I(),z("div",Bi,ae(T.$t("trading.derivative.progressContextMenu.start")),1)):he("",!0),h("i",{class:H(`arrow far fa-chevron-${_.value?"double-":""}down`)},null,2),p.value?(I(),be(Le(xi),{key:1,items:L.node.items,modelValue:c.selectedChild,"onUpdate:modelValue":D[0]||(D[0]=N=>c.selectedChild=N),displayExpr:"name",stylingMode:"outlined","show-clear-button":!0,showDropDownButton:!1,placeholder:T.$t("titles.dxSelectPlacehoder"),onValueChanged:v},null,8,["items","modelValue","placeholder"])):(I(),z("div",Mi,[h("span",{class:"text",innerHTML:L.node.items},null,8,Wi),L.node.pattern?(I(),be(We,{key:0,pattern:Le(Me)[L.node.pattern[0]][L.node.pattern[1]-1]},null,8,["pattern"])):he("",!0)])),c.hasChild?(I(),be(P,{key:3,node:c.selectedChild,index:L.index+1,modelValue:c.childValue,"onUpdate:modelValue":[D[1]||(D[1]=N=>c.childValue=N),B]},null,8,["node","index","modelValue"])):he("",!0)])):he("",!0)}}},Yi=at(Ni,[["__scopeId","data-v-d485f979"]]);const Ji=h("div",{class:"triangle-shadow"},null,-1),zi=h("div",{class:"triangle"},null,-1),Xi={__name:"Index",props:["modelValue"],emits:["update:modelValue","change"],setup(L,{emit:E}){const S=L,x=E,p=b(null),_=b(!1),c=b({});ui(Object.assign({"../../../../lang/vi/derivative.js":()=>fi(()=>import("./derivative-60bb42b4.js"),[])}),`../../../../lang/${window.lang}/derivative.js`).then(T=>{c.value=T.default,_.value=!0});const m=b(S.modelValue);de(()=>S.modelValue,T=>m.value=T);function v(T){x("update:modelValue",T),x("change",T),setTimeout(()=>{p.value.scrollTop=p.value.scrollHeight},0)}function B(T){T.stopPropagation()}return(T,D)=>(I(),z("div",{class:"progress-popup",onClick:B,title:""},[Ji,zi,h("div",{ref_key:"scrollContainer",ref:p,class:"container"},[_.value?(I(),be(Yi,{key:0,node:c.value,index:0,modelValue:m.value,"onUpdate:modelValue":[D[0]||(D[0]=P=>m.value=P),v]},null,8,["node","modelValue"])):he("",!0)],512)]))}};const ji={class:"content-block dx-card responsive-paddings"},Hi=["title"],qi=["title"],Qi=["title"],Ui=["title"],Gi=["title"],Ki=["title"],eo=["title"],to=["title"],io=["title"],oo=h("i",{class:"far fa-heart-rate"},null,-1),ro=[oo],so=["title"],no=h("i",{class:"far fa-grip-lines-vertical"},null,-1),ao=[no],lo=["title"],co=h("i",{class:"far fa-horizontal-rule"},null,-1),po=["title"],uo=h("i",{class:"far fa-line-height"},null,-1),fo=[uo],vo=["title"],mo=h("i",{class:"far fa-percent"},null,-1),ho=[mo],go=["title"],yo=h("i",{class:"far fa-heart-rate"},null,-1),So=["title"],To=["src"],st=3,nt=2,xo="wss://tradestation.fireant.vn/quote?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",Oo={__name:"Index",setup(L){const E={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.25,bottom:.25}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:1e3,minBarSpacing:.01,barSpacing:.05}},S=ke(new Date,"yyyy-MM-dd"),x={START:V(new Date(`${S}T08:45:00Z`)),ATO:V(new Date(`${S}T09:00:00Z`)),ATC:V(new Date(`${S}T14:30:00Z`)),END:V(new Date(`${S}T14:45:00Z`))},p=gi(),_=yi(),{t:c}=vi(),m=De("devices"),v=De("mf"),B=De("bus"),T=De("filters"),D=b(null),P=b(null),N=b(null),pe=b(null),Y=b(null),dt=b(null),pt=b(null),ge=b(null),Oe=b(null),Re=b(null),_e=b(null),ye=b(null),Fe=b(null),ut=b(null),te=b(null),ue=b(null),Ye=b(null);let e={chart:{},series:{},data:{whitespace:[],price:[]},tools:{},crosshair:{},interval:null,interval60:null,websocket:null,isAutoOrdering:!1,socketStop:!1,socketSendData:null,currentSeconds:V(Ze(new Date,7))};ie();const d=ct({chartDate:_.query.date??S,clock:ke(new Date,"HH:mm:ss"),isFullscreen:!1,isSocketWarning:!1,isOrderWarning:!1,isAutoScan:!1,lineColor:"#F44336",lineTitle:"",progress:[],showLineContext:!1,showSampleContext:!1,showProgressContext:!1,showTradingView:!1}),M=ne(()=>p.state.tradingDerivative.status),q=ne(()=>p.state.tradingDerivative.config),Je=ne(()=>p.state.tradingDerivative.tools),ft=ne(()=>M.value.position!=0||!!M.value.pending||!!Je.value.order),vt=ne(()=>`https://chart.vps.com.vn/tv/?u=${q.value.vpsUser}&s=${q.value.vpsSession}&symbol=VN30F1M&resolution=1&lang=vi`);p.dispatch("tradingDerivative/initChart").then(()=>{console.log("inSession()",Q()),Q()&&Pe(),!_.query.date&&q.value.lastOpeningDate&&(d.chartDate=q.value.lastOpeningDate),p.dispatch("tradingDerivative/getChartData",{date:d.chartDate}).then(t=>{t&&p.dispatch("tradingDerivative/getTools")})}),e.interval=setInterval(kt,1e3),e.interval60=setInterval(()=>{Q()?(p.dispatch("tradingDerivative/getStatus"),q.value.autoScan&&Ee()):clearInterval(e.interval60)},6e4),lt(()=>{e.chart=wi(P.value,E),e.chart.subscribeCrosshairMove(gt),e.chart.subscribeCustomPriceLineDragged(yt),e.series.whitespace=e.chart.addHistogramSeries({priceScaleId:"whitespace",scaleMargins:{top:0,bottom:0},color:"#808080",lastValueVisible:!1,priceLineVisible:!1}),e.series.timeRange=e.chart.addHistogramSeries({priceScaleId:"range",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),e.series.price=e.chart.addLineSeries({color:"#F5F5F5",priceFormat:{minMove:.1}}),new ResizeObserver(St).observe(D.value),document.addEventListener("keydown",je),document.addEventListener("fullscreenchange",He)}),mi(()=>{document.removeEventListener("keydown",je),document.removeEventListener("fullscreenchange",He),clearInterval(e.interval),clearInterval(e.interval60),e.websocket&&(e.websocket.close(),e.websocket=null),e.socketStop=!0}),de(()=>p.state.tradingDerivative.chartData,Ct),de(()=>Je.value,xt);function mt(t){d.showLineContext=!1,d.showSampleContext=!1,we(!1),ge.value.classList.contains("selected")?Ot():_e.value.classList.contains("selected")?Xt():ye.value.classList.contains("selected")?Nt():Fe.value.classList.contains("selected")?Ft():Oe.value.classList.contains("selected")?qt():Re.value.classList.contains("selected")&&Zt()}function ht(t){we(!0),t.preventDefault()}function ze(t){t.stopPropagation()}function Xe(t){t.preventDefault(),t.stopPropagation()}function gt(t){if(t.time){let o=t.seriesPrices.get(e.series.price);e.crosshair.time=t.time,e.crosshair.price=o}else m.phone||(e.crosshair.time=null,e.crosshair.price=null);t.point!=null&&(e.crosshair.x=t.point.x,e.crosshair.y=t.point.y)}function yt(t){let o=t.customPriceLine,i=o.options();i.price=parseFloat(i.price.toFixed(1));const r=+t.fromPriceString,a=i.price;switch(i.lineType){case"order":if(a!=r){let n=!1;i.kind=="entry"?M.value.position||(n=!0,e.tools.order[i.kind].price=a,p.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"change",price:e.tools.order.entry.price}}).then(s=>{s.isOk?(le([i.kind]),$.success(c("trading.derivative.changeEntrySuccess"))):(o.applyOptions({price:r}),W(s.message))})):(n=!0,e.tools.order[i.kind].price=a,i.kind=="tp"?p.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"change",price:e.tools.order.tp.price}}).then(s=>{s.isOk?(le([i.kind]),$.success(c("trading.derivative.changeTpSuccess"))):(o.applyOptions({price:r}),W(s.message))}):p.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"change",price:e.tools.order.sl.price}}).then(s=>{s.isOk?(le([i.kind]),$.success(c("trading.derivative.changeSlSuccess"))):(o.applyOptions({price:r}),W(s.message))})),n||(o.applyOptions({price:r}),$.show(c("trading.derivative.noChangeOrderLine")))}break;case"line":p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line",point:r}),p.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"line",points:[a],data:[i]}),ge.value.classList.remove("selected");break;case"target":if(v.isSet(e.tools.target.B)){let n={isRemove:!1,name:"target",points:[],data:[]},s,l,g=+e.tools.target.A.options().price,y=+e.tools.target.B.options().price,u=y-g;if(s="A",i.point=="A")u=+e.tools.target.B.options().title,y=g+u;else if(i.point!="B"){let w=0;switch(i.point){case"X":w=1.5;break;case"Y":w=2;break;case"Z":w=3;break}u=parseFloat(((y-a)/w).toFixed(1)),g=y-u,l={price:g},e.tools.target[s].applyOptions(l)}n.points.push(s),n.data.push(e.tools.target[s].options()),s="B",l={price:y,title:u.toFixed(1)},i.point==s&&delete l.price,e.tools.target[s].applyOptions(l),n.points.push(s),n.data.push(e.tools.target[s].options()),s="X",l={price:parseFloat((g-.5*u).toFixed(1)),title:(-.5*u).toFixed(1)},i.point==s&&delete l.price,e.tools.target[s].applyOptions(l),n.points.push(s),n.data.push(e.tools.target[s].options()),s="Y",l={price:parseFloat((g-u).toFixed(1)),title:(-u).toFixed(1)},i.point==s&&delete l.price,e.tools.target[s].applyOptions(l),n.points.push(s),n.data.push(e.tools.target[s].options()),s="Z",l={price:parseFloat((g-2*u).toFixed(1)),title:(-2*u).toFixed(1)},i.point==s&&delete l.price,e.tools.target[s].applyOptions(l),n.points.push(s),n.data.push(e.tools.target[s].options()),p.dispatch("tradingDerivative/drawTools",n)}break;case"rr":if(v.isSet(e.tools.rr.TP)){let n={isRemove:!1,symbol:d.symbol,name:"rr",points:[],data:[]},s;const l=+e.tools.rr.EP.options().price,g=+e.tools.rr.SL.options().price,y=+e.tools.rr.TP.options().price;if(i.point=="EP")s="SL",e.tools.rr[s].applyOptions({price:l+g-r}),n.points.push(s),n.data.push(e.tools.rr[s].options()),s="TP",e.tools.rr[s].applyOptions({price:l+y-r}),n.points.push(s),n.data.push(e.tools.rr[s].options());else{const u=g-l,w=y-l;if(w/u>0)return o.applyOptions({price:r}),!1;const k=Math.abs(w)/Math.abs(u);s="EP",e.tools.rr[s].applyOptions({title:`RR=${k.toFixed(1)}`}),n.points.push(s),n.data.push(e.tools.rr[s].options()),s="SL",e.tools.rr[s].applyOptions({title:`SL=${u.toFixed(1)}`}),n.points.push(s),n.data.push(e.tools.rr[s].options()),s="TP",e.tools.rr[s].applyOptions({title:`TP=${w.toFixed(1)}`}),n.points.push(s),n.data.push(e.tools.rr[s].options())}p.dispatch("tradingDerivative/drawTools",n)}break;case"pattern":if(v.isSet(e.tools.pattern.B)){let n,s;const l=e.tools.pattern.A.options(),g=e.tools.pattern.B.options(),y=e.tools.pattern.C.options(),u={A:{time:+l.time,price:+l.price},B:{price:+g.price},C:{price:+y.price}},w=i.point=="D"?+e.tools.pattern.D.options().price:null,{pattern:k,timeRS1:C,info:{tr1:O,tr2:f,tr3:Z,pr1:X,pr2:j,pr3:A,fibo:K,sp:F,X:J,Y:re,Z:U}}=fe(u,w);ve(C,!0),Ce([k]),Ae(u),n="A",s={title:`A ${O} ${X}`},e.tools.pattern[n].applyOptions(s),n="B",s={title:`B ${f} ${j}`},e.tools.pattern[n].applyOptions(s),n="C",s={title:`C ${Z} ${A}`},e.tools.pattern[n].applyOptions(s),n="D",s={price:F,title:"F "+K},i.point==n&&delete s.price,e.tools.pattern[n].applyOptions(s),n="X",s={price:parseFloat((F+J).toFixed(1)),title:"T "+parseFloat(J.toFixed(1))},e.tools.pattern[n].applyOptions(s),n="Y",s={price:parseFloat((F+re).toFixed(1)),title:"T "+parseFloat(re.toFixed(1))},e.tools.pattern[n].applyOptions(s),n="Z",s={price:parseFloat((F+U).toFixed(1)),title:"T "+parseFloat(U.toFixed(1))},e.tools.pattern[n].applyOptions(s)}break}}function St(){D.value&&(e.chart.resize(D.value.offsetWidth,D.value.offsetHeight),D.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function je(t){if(t.ctrlKey)switch(t.keyCode){case 219:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing-.01});break;case 221:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing+.01});break}if(t.altKey)switch(t.keyCode){case 219:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()-50);break;case 221:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()+50);break}}function He(){D.value&&(document.fullscreenElement?(d.isFullscreen=!0,D.value.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(d.isFullscreen=!1,D.value.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}function Tt(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function xt(t){Ut(),Object.entries(t).forEach(([o,i])=>{switch(o){case"order":Object.entries(i).forEach(([r,a])=>{e.tools.order.side=a.side,e.tools.order[r].price=a.price,e.tools.order[r].line=e.series.price.createPriceLine(a)});break;case"line":Object.values(i).forEach(r=>e.tools.lines.push(e.series.price.createPriceLine(r)));break;case"tr":ve(Object.values(i));break;case"target":Object.entries(i).forEach(([r,a])=>e.tools[o][r]=e.series.price.createPriceLine(a));break;case"auto":Pt(t.auto,!("tr"in t));break}})}function Ct(t){d.chartDate==S&&Q()||(!t.isDay&&t.price.length>0&&(e.data.whitespace=Se(e.data.whitespace,Qe(d.chartDate))),e.series.whitespace.setData(e.data.whitespace),e.data.price=Se(e.data.price,t.price),e.series.price.setData(e.data.price))}function qe(t,o){let i=[];t.forEach(r=>{const a=V(Ze(new Date(r.date),7));i.push({time:a,value:r.price})}),i.length>1?(e.data.price=Se(e.data.price,i),e.series.price.setData(e.data.price)):(e.data.price.push(i[0]),e.series.price.update(i[0]))}function Qe(t){const o=V(new Date(`${t}T09:00:00Z`)),i=V(new Date(`${t}T11:30:00Z`)),r=V(new Date(`${t}T13:00:00Z`)),a=V(new Date(`${t}T14:30:00Z`)),n=V(new Date(`${t}T14:00:00Z`));let s=[];for(let l=o;l<=a;l++){if(l>i&&l<r)continue;let g={time:l};(l==n||l==a)&&(g.value=1),s.push(g)}return s}function Se(t,o){return Array.from(new Map([...t,...o].sort((i,r)=>i.time-r.time).map(i=>[i.time,i])).values())}function Pe(){p.dispatch("tradingDerivative/setChartLoading",!0),e.websocket=new WebSocket(xo),e.websocket.onopen=t=>{let o='{"protocol":"json","version":1}';e.websocket.send(o),o='{"arguments":["VN30F1M"],"invocationId":"0","target":"SubscribeTrades","type":1}',e.websocket.send(o),e.socketSendData=o},e.websocket.onclose=t=>{!e.socketStop&&Q()&&(d.isSocketWarning=!0,Pe())},e.websocket.onmessage=t=>{d.isSocketWarning=!1,wt(t.data).forEach(i=>{if(!i)return!1;i.type==3?(p.dispatch("tradingDerivative/getTools"),e.data.whitespace=Se(e.data.whitespace,Qe(S)),e.series.whitespace.setData(e.data.whitespace),qe(i.result),p.dispatch("tradingDerivative/setChartLoading",!1)):i.type==1&&i.target=="UpdateTrades"&&i.arguments[0]=="VN30F1M"&&(ti(i.arguments[1].at(-1).price),qe(i.arguments[1]))})}}function wt(t){let o=[];return t.split("").forEach(i=>{const r=i.indexOf("{"),a=i.lastIndexOf("}");let n=null;if(r!==-1&&a!==-1&&a>r){const s=i.substring(r,a+1);s!="{}"&&(n=JSON.parse(s))}o.push(n)}),o}function kt(){e.currentSeconds=V(Ze(new Date,7)),Q()&&(M.value.position&&e.currentSeconds>x.ATC-5*60&&(d.isOrderWarning=!0,e.currentSeconds>x.ATC-15&&v.isSet(e.tools.order.tp.line)&&p.dispatch("tradingDerivative/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(t=>{t.isOk?(ce(["entry","tp","sl"]),$.success(c("trading.derivative.autoCancelTpSlSuccess"))):W(t.message)})),q.value.openingMarket&&e.currentSeconds==x.START&&Pe()),d.clock=ke(new Date,"HH:mm:ss")}function le(t){const o="order";let i={isRemove:!1,name:o,points:[],data:[]},r,a;t.forEach(n=>{switch(n){case"entry":r="yellow",a=e.tools.order.side>0?"LONG":"SHORT";break;case"tp":r="lime",a=parseFloat(Math.abs(e.tools.order.tp.price-e.tools.order.entry.price).toFixed(1));break;case"sl":r="red",a=parseFloat(Math.abs(e.tools.order.sl.price-e.tools.order.entry.price).toFixed(1));break}if(i.points.push(n),v.isSet(e.tools.order[n].line))e.tools.order[n].line.applyOptions({price:e.tools.order[n].price,title:a}),i.data.push(e.tools.order[n].line.options());else{const s={lineType:o,kind:n,side:e.tools.order.side,price:e.tools.order[n].price,color:r,lineWidth:1,lineStyle:0,title:a,draggable:!0};e.tools.order[n].line=e.series.price.createPriceLine(s),i.data.push(s)}}),p.dispatch("tradingDerivative/drawTools",i)}function ce(t,o=!0){o&&p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"order"}),t.forEach(i=>{v.isSet(e.tools.order[i].line)&&(e.series.price.removePriceLine(e.tools.order[i].line),delete e.tools.order[i].line)})}function Dt(t){d.showTradingView=!d.showTradingView,t.stopPropagation()}function bt(t){d.showLineContext=!1;const o=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),o||t.target.classList.add("selected")}function Lt(t){d.showLineContext=!d.showLineContext,d.showSampleContext=!1,d.showProgressContext=!1}function Ot(){const t="line",o=me(e.crosshair.y),i=e.tools.lines.length;if(e.tools.lines=e.tools.lines.filter(r=>{const a=r.options(),n=a.type=o==+a.price;return n&&(e.series.price.removePriceLine(r),p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:t,point:o})),!n}),e.tools.lines.length==i){const r={lineType:t,price:o,color:d.lineColor,title:d.lineTitle,lineWidth:1,lineStyle:1,draggable:!0};e.tools.lines.push(e.series.price.createPriceLine(r)),p.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:t,points:[o],data:[r]})}ge.value.classList.remove("selected")}function Ue(t=!0){e.tools.lines.length>0&&(t&&p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line"}),e.tools.lines.forEach(o=>e.series.price.removePriceLine(o)),ie(["lines"]))}function Rt(t){d.showLineContext=!1;const o=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),o||(Vt(),Te(),xe(!1),Ve(),t.target.classList.add("selected"))}function _t(t){p.dispatch("tradingDerivative/setAutoScan",!q.value.autoScan),t.target.classList.remove("selected")}function Ft(){Fe.value.classList.remove("selected");const t=e.crosshair.time?e.data.price.filter(n=>n.time<=e.crosshair.time):e.data.price,o=At(t);if(!v.isSet(o))return!1;const{pattern:i,timeRS1:r,info:a}=fe(o);Te(),Ge(o,a),ve(r,!0),Ce([i]),Ae(o)}function Ae(t){let o={isRemove:!1,name:"pattern",points:[],data:[]};e.tools.auto=t,Object.entries(t).forEach(([i,r])=>{o.points.push(i),o.data.push(r)}),p.dispatch("tradingDerivative/drawTools",o)}function Pt(t,o=!0){const i=v.cloneDeep(t);e.tools.auto=i;const{pattern:r,timeRS1:a,info:n}=fe(i);if(!v.isSet(i))return!1;Ge(i,n),Ce([r]),o&&ve(a,!0)}function At(t){let o,[i,r,a,n,s]=Array(5).fill({});for(let l=t.length-1;l>=0;l--){const g=t[l].value,y=t[l].time,u=oe(y);if(u==-1)break;if(l==t.length-1&&(n={index:u,time:y,price:g},[a,r,i,s]=Array(4).fill(null).map(()=>v.cloneDeep(n))),o==null){if(g==n.price)continue;o=n.price>g}if(!R(r.price,o,n.price)&&R(g,!o,a.price)&&(a={index:u,time:y,price:g}),R(g,o,r.price)&&(R(i.price,!o,a.price)?([n,a,r]=[a,r,i].map(w=>v.cloneDeep(w)),i={index:u,time:y,price:g},s=v.cloneDeep(i),o=!o):n.index-a.index<=20?(n=v.cloneDeep(a),r=v.cloneDeep(a),a={index:u,time:y,price:g},o=!o):r={index:u,time:y,price:g}),R(g,!o,i.price)?(i={index:u,time:y,price:g},s=v.cloneDeep(i)):s.index=u,R(g,o,s.price)&&(s={index:u,time:y,price:g}),a.index>i.index){const w=Math.abs(r.price-a.price);if(w>=1.5&&(i.index-s.index>a.index-r.index||Math.abs(i.price-s.price)>w))break}}return $t({A:i,B:r,C:a,D:n})}function $t(t){const o={};return Object.entries(t).forEach(([i,r])=>{const{index:a,...n}=r;o[i]=n}),o}function Vt(t=!0){t&&p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"pattern"}),ie(["auto"])}function It(t){d.showLineContext=!1;const o=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),o||t.target.classList.add("selected")}function Et(t){t.target.classList.remove("selected"),Te(),xe(!0),Ve()}function Zt(){const t="pattern",o=me(e.crosshair.y),i=e.crosshair.time;let r={lineType:t,price:o,lineWidth:1,lineStyle:1,draggable:!0};if(v.isSet(e.tools.pattern.A)){const a=e.tools.pattern.A.options();if(v.isSet(e.tools.pattern.B)){const n=e.tools.pattern.B.options();let s,l,g;if(v.isSet(e.tools.pattern.C)){let y,u;const w=e.tools.pattern.C.options();s={A:{time:i,price:o},B:{price:+n.price},C:{price:+w.price}};const{pattern:k,timeRS1:C,info:{tr1:O,tr2:f,tr3:Z,pr1:X,pr2:j,pr3:A,fibo:K,sp:F,X:J,Y:re,Z:U}}=fe(s);l=C,g=k,y="A",u={price:o,time:i,title:`A ${O} ${X}`},e.tools.pattern[y].applyOptions(u),y="B",u={title:`B ${f} ${j}`},e.tools.pattern[y].applyOptions(u),y="C",u={title:`C ${Z} ${A}`},e.tools.pattern[y].applyOptions(u),y="D",u={price:F,title:"F "+K},e.tools.pattern[y].applyOptions(u),y="X",u={price:parseFloat((F+J).toFixed(1)),title:"T "+parseFloat(J.toFixed(1))},e.tools.pattern[y].applyOptions(u),y="Y",u={price:parseFloat((F+re).toFixed(1)),title:"T "+parseFloat(re.toFixed(1))},e.tools.pattern[y].applyOptions(u),y="Z",u={price:parseFloat((F+U).toFixed(1)),title:"T "+parseFloat(U.toFixed(1))},e.tools.pattern[y].applyOptions(u)}else{s={A:{time:+a.time,price:+a.price},B:{price:+n.price},C:{price:o}};const{pattern:y,timeRS1:u,info:{tr1:w,tr2:k,tr3:C,pr1:O,pr2:f,pr3:Z,fibo:X,sp:j,X:A,Y:K,Z:F}}=fe(s);l=u,g=y;let J="A";e.tools.pattern[J].applyOptions({title:`A ${w} ${O}`}),J="B",e.tools.pattern[J].applyOptions({title:`B ${k} ${f}`}),r.point="C",r.title=`C ${C} ${Z}`,r.color="#FF9800",e.tools.pattern[r.point]=e.series.price.createPriceLine(r),r.point="D",r.price=j,r.title="F "+X,r.color="#4CAF50",e.tools.pattern[r.point]=e.series.price.createPriceLine(r),r.point="X",r.price=parseFloat((j+A).toFixed(1)),r.title="T "+parseFloat(A.toFixed(1)),r.color="#2196F3",r.draggable=!1,e.tools.pattern[r.point]=e.series.price.createPriceLine(r),r.point="Y",r.price=parseFloat((j+K).toFixed(1)),r.title="T "+parseFloat(K.toFixed(1)),r.color="#673AB7",r.draggable=!1,e.tools.pattern[r.point]=e.series.price.createPriceLine(r),r.point="Z",r.price=parseFloat((j+F).toFixed(1)),r.title="T "+parseFloat(F.toFixed(1)),r.color="#9C27B0",r.draggable=!1,e.tools.pattern[r.point]=e.series.price.createPriceLine(r)}ve(l,!0),Ce([g]),Ae(s),Re.value.classList.remove("selected")}else r.point="B",r.title="B 0 0",r.color="#009688",e.tools.pattern[r.point]=e.series.price.createPriceLine(r)}else r.point="A",r.title="A 0 0",r.color="#F44336",r.time=i,e.tools.pattern[r.point]=e.series.price.createPriceLine(r)}function Ge({A:t,B:o,C:i},{tr1:r,tr2:a,tr3:n,pr1:s,pr2:l,pr3:g,fibo:y,sp:u,X:w,Y:k,Z:C}){if(!e.data.price.length)return!1;let f={lineType:"pattern",lineWidth:1,lineStyle:1,draggable:!0};f.point="A",f.title=`A ${r} ${s}`,f.color="#F44336",f.price=t.price,f.time=t.time,e.tools.pattern[f.point]=e.series.price.createPriceLine(f),f.point="B",f.title=`B ${a} ${l}`,f.color="#009688",f.price=o.price,e.tools.pattern[f.point]=e.series.price.createPriceLine(f),f.point="C",f.price=i.price,f.title=`C ${n} ${g}`,f.color="#FF9800",e.tools.pattern[f.point]=e.series.price.createPriceLine(f),f.point="D",f.price=u,f.title="F "+y,f.color="#4CAF50",e.tools.pattern[f.point]=e.series.price.createPriceLine(f),f.point="X",f.price=parseFloat((u+w).toFixed(1)),f.title="T "+parseFloat(w.toFixed(1)),f.color="#2196F3",f.draggable=!1,e.tools.pattern[f.point]=e.series.price.createPriceLine(f),f.point="Y",f.price=parseFloat((u+k).toFixed(1)),f.title="T "+parseFloat(k.toFixed(1)),f.color="#673AB7",f.draggable=!1,e.tools.pattern[f.point]=e.series.price.createPriceLine(f),f.point="Z",f.price=parseFloat((u+C).toFixed(1)),f.title="T "+parseFloat(C.toFixed(1)),f.color="#9C27B0",f.draggable=!1,e.tools.pattern[f.point]=e.series.price.createPriceLine(f)}function fe(t,o=null){const i=$e(t.A,t.B),r=$e(i.R,t.C,i.tr),a=$e(r.R,r.S,i.tr),n=[i.R1.time,i.S1.time],s=t.C.price-t.B.price,l=t.A.price-t.B.price,g=s>0,y=i.S1.price-i.R1.price,u=r.R1.price-r.S1.price,w=a.S1.price-a.R1.price;let[k,C,O,f,Z,X]=Array(6).fill(0);f=parseInt(y/l*100),R(i.R1.price,g,t.B.price)&&R(i.S1.price,!g,t.C.price)&&(k=1),Math.abs(s)>1.5&&R(s,g,y)&&(Z=parseInt(u/s*100),Z>50&&(r.count==1?C=1:s/l<.5&&(r.count>1||r.over)?C=2:k==1&&R(r.S1.price,!g,i.R1.price)&&R(r.R1.price,g,i.S1.price)&&(C=3)),X=parseInt(w/s*100),X>40&&(a.count==1?O=1:s/l<.5&&(a.count>1||a.over)&&(O=2)),C==0&&Z>50&&O==0&&X>50&&r.tr>.5*i.tr&&r.pr>.5*i.pr&&a.R.index-a.S.index>=i.tr&&(R(a.R1.price,!g,r.S1.price)?C=4:C=5));const j=Bt(C,O);let A=o;if(!A){let U=0;A=t.B.price,C>0&&R(u,g,U)&&(U=u,A=C<5?r.S1.price:a.S1.price),O>0&&R(w,g,U)&&(A=a.R1.price)}const K=parseInt((C<5?(t.C.price-A)/s:(A-a.R1.price)/(t.C.price-a.R1.price))*100),F=A-(C<5?t.C.price:a.R1.price),J=.5*F,re=2*F;return{pattern:j,timeRS1:n,info:{tr1:k,tr2:C,tr3:O,pr1:f,pr2:Z,pr3:X,fibo:K,sp:A,X:J,Y:F,Z:re}}}function $e(t,o,i=0){let r=v.cloneDeep(t),a=v.cloneDeep(o);const n=a.price>r.price;let s={},l={};e.data.price.filter(u=>u.time>=r.time).every((u,w)=>{const k=u.value,C=u.time,O=oe(C);if(O==-1)return!1;if((w==0||k==r.price)&&(s={R:{index:O,time:C,price:k},S:{index:O,time:C,price:k}},l={R:s.R,S:s.S,pr:0,tr:0,count:0,over:!1}),R(k,n,s.R.price)){const f=s.S.index-s.R.index,Z=Math.abs(s.S.price-s.R.price);f>=l.tr&&Z>=.5*l.pr&&(l.tr=f,l.pr=Z,l.R=s.R,l.S=s.S,i>0&&f>=i&&(l.count++,f>=3*i&&(l.over=!0))),f>=.5*l.tr&&!R(s.S.price,!n,l.S.price)&&Math.abs(s.R.price-l.R.price)<=.2&&(l.S.index=s.S.index,l.S.time=s.S.time,l.tr=s.S.index-l.R.index),s={R:{index:O,time:C,price:k},S:{index:O,time:C,price:k}},Z>=2*l.pr&&(l={R:s.R,S:s.S,pr:0,tr:0,count:0,over:!1})}else s.S.index=O,s.S.time=C,R(k,!n,s.S.price)&&(s.S.price=k);return R(k,!n,r.price)?(s.S.price=r.price,!1):!!R(k,!n,a.price)});const g=s.S.index-s.R.index,y=Math.abs(s.S.price-s.R.price);return g>=l.tr&&y>=.5*l.pr&&(l.tr=g,l.pr=y,l.R=s.R,l.S=s.S,i>0&&g>=i&&(l.count++,g>=3*i&&(l.over=!0))),a.time=s.S.time,r.index=oe(r.time),a.index=oe(a.time),{tr:l.tr,pr:l.pr,count:l.count,over:l.over,S1:l.S,R1:l.R,S:r,R:a}}function Bt(t,o){return o>0?o:t>0?t+2:0}function Te(){v.isSet(e.tools.pattern.A)&&(e.series.price.removePriceLine(e.tools.pattern.A),v.isSet(e.tools.pattern.B)&&(e.series.price.removePriceLine(e.tools.pattern.B),v.isSet(e.tools.pattern.C)&&(e.series.price.removePriceLine(e.tools.pattern.C),e.series.price.removePriceLine(e.tools.pattern.D),e.series.price.removePriceLine(e.tools.pattern.X),e.series.price.removePriceLine(e.tools.pattern.Y),e.series.price.removePriceLine(e.tools.pattern.Z)))),ie(["pattern"])}function Mt(t){d.showLineContext=!1;const o=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),o||t.target.classList.add("selected")}function Wt(t){xe(),t.target.classList.remove("selected")}function Nt(){let t={isRemove:!1,name:"tr",points:[],data:[]},o={time:e.crosshair.time,value:1};switch(e.tools.timeRange.length){case 0:o.color="OrangeRed",e.tools.timeRange[0]=o,t.points.push(0),t.data.push(o);break;case 1:o.color="lime",e.tools.timeRange[1]=o,t.points.push(1),t.data.push(o),ye.value.classList.remove("selected");break;default:const i=oe(e.tools.timeRange[0].time),r=oe(e.tools.timeRange[1].time),n=oe(o.time)+(r-i);o.color="OrangeRed",e.tools.timeRange[0]=v.cloneDeep(o),t.points.push(0),t.data.push(v.cloneDeep(o)),o.time=e.data.whitespace[n].time,o.color="lime",e.tools.timeRange[1]=o,t.points.push(1),t.data.push(o),ye.value.classList.remove("selected");break}e.series.timeRange.setData(e.tools.timeRange),p.dispatch("tradingDerivative/drawTools",t)}function ve(t,o=!1,i=!1){o&&(t=[{time:t[0],value:1,color:"OrangeRed"},{time:t[1],value:1,color:"lime"}]),e.tools.timeRange=t,e.series.timeRange.setData(t),i&&p.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"tr",points:[0,1],data:t})}function xe(t=!0,o=!1){t&&p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"tr"}),o||(e.series.timeRange.setData([]),ie(["tr"]))}function Yt(){d.showProgressContext=!d.showProgressContext,d.showSampleContext=!1,d.showLineContext=!1}function Ce(t){d.progress=t}function Ve(){d.progress=[]}function Jt(t){d.showLineContext=!1;const o=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),o||(t.target.classList.add("selected"),Ie())}function zt(t){Ie(),t.target.classList.remove("selected")}function Xt(){const t="target",o=me(e.crosshair.y);let i={lineType:t,price:o,lineWidth:1,lineStyle:1,draggable:!0},r={isRemove:!1,name:t,points:[],data:[]};if(v.isSet(e.tools.target.A)){const a=+e.tools.target.A.options().price,n=o-a;i.point="B",i.title=parseFloat(n.toFixed(1)),i.color="#F44336",e.tools.target[i.point]=e.series.price.createPriceLine(i),r.points.push(i.point),r.data.push(v.cloneDeep(i)),i.point="X",i.price=parseFloat((a-.5*n).toFixed(1)),i.title=parseFloat((-.5*n).toFixed(1)),i.color="#2196F3",e.tools.target[i.point]=e.series.price.createPriceLine(i),r.points.push(i.point),r.data.push(v.cloneDeep(i)),i.point="Y",i.price=parseFloat((a-n).toFixed(1)),i.title=parseFloat(-n.toFixed(1)),i.color="#673AB7",e.tools.target[i.point]=e.series.price.createPriceLine(i),r.points.push(i.point),r.data.push(v.cloneDeep(i)),i.point="Z",i.price=parseFloat((a-2*n).toFixed(1)),i.title=parseFloat((-2*n).toFixed(1)),i.color="#9C27B0",e.tools.target[i.point]=e.series.price.createPriceLine(i),r.points.push(i.point),r.data.push(v.cloneDeep(i)),_e.value.classList.remove("selected")}else i.point="A",i.title="0",i.color="#FF9800",e.tools.target[i.point]=e.series.price.createPriceLine(i),r.points.push(i.point),r.data.push(v.cloneDeep(i));p.dispatch("tradingDerivative/drawTools",r)}function Ie(t=!0){t&&p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"target"}),v.isSet(e.tools.target.A)&&(e.series.price.removePriceLine(e.tools.target.A),v.isSet(e.tools.target.B)&&(e.series.price.removePriceLine(e.tools.target.B),e.series.price.removePriceLine(e.tools.target.X),e.series.price.removePriceLine(e.tools.target.Y),e.series.price.removePriceLine(e.tools.target.Z))),ie(["target"])}function jt(t){d.showLineContext=!1;const o=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),o||(t.target.classList.add("selected"),Ke())}function Ht(t){Ke(),t.target.classList.remove("selected")}function qt(){const t="rr",o=me(e.crosshair.y);let i={lineType:t,price:o,lineWidth:1,lineStyle:1,draggable:!0},r={isRemove:!1,name:t,points:[],data:[]};if(v.isSet(e.tools.rr.EP)){const a=+e.tools.rr.EP.options().price;if(v.isSet(e.tools.rr.SL)){const n=+e.tools.rr.SL.options().price,s=n-a;let l=o-a;if(l/s>0){const u=a-(n-a);i.price=u,l=u-a}i.point="TP",i.title=`TP=${l.toFixed(1)}`,i.color="lime",e.tools.rr[i.point]=e.series.price.createPriceLine(i),r.points.push(i.point),r.data.push(v.cloneDeep(i));const g=Math.abs(l)/Math.abs(s),y="EP";e.tools.rr[y].applyOptions({title:`RR=${g.toFixed(1)}`}),r.points.push(y),r.data.push(e.tools.rr[y].options()),Oe.value.classList.remove("selected")}else{const n=o-a;i.point="SL",i.title=`SL=${n.toFixed(1)}`,i.color="red",e.tools.rr[i.point]=e.series.price.createPriceLine(i),r.points.push(i.point),r.data.push(v.cloneDeep(i))}}else i.point="EP",i.title="RR=",i.color="yellow",e.tools.rr[i.point]=e.series.price.createPriceLine(i),r.points.push(i.point),r.data.push(v.cloneDeep(i));p.dispatch("tradingDerivative/drawTools",r)}function Ke(t=!0){t&&p.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"rr"}),v.isSet(e.tools.rr.EP)&&(e.series.price.removePriceLine(e.tools.rr.EP),v.isSet(e.tools.rr.SL)&&(e.series.price.removePriceLine(e.tools.rr.SL),v.isSet(e.tools.rr.TP)&&e.series.price.removePriceLine(e.tools.rr.TP))),ie(["rr"])}function Qt(){d.showSampleContext=!d.showSampleContext,d.showProgressContext=!1,d.showLineContext=!1}function Ut(){ce(["entry","tp","sl"],!1),Ue(!1),Ie(!1),xe(!1),Ve(),Te()}function we(t){if(t){if(Q()&&(v.isSet(e.tools.order.tp.line)||M.value.position&&e.currentSeconds>x.ATO&&e.currentSeconds<x.ATC&&(ue.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-61?-61:1))+"px",ue.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-51?-51:1))+"px",ue.value.style.display="block"),!v.isSet(e.tools.order.entry.line))){let o=null,i=0;M.value.position?(e.currentSeconds<x.ATO?o="ATO":e.currentSeconds>x.ATC&&(o="ATC"),o&&(e.tools.order.entry.price=o,i=-M.value.position)):e.currentSeconds>x.ATO&&e.currentSeconds<x.ATC&&(o=me(e.crosshair.y),i=o>=e.data.price.at(-1).value?1:-1,e.tools.order.side=i,e.tools.order.entry.price=o),i&&(te.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-71?-71:1))+"px",te.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-61?-61:1))+"px",te.value.style.background=i>0?"green":"red",te.value.innerText=`${i>0?"LONG":"SHORT"} ${o}`,te.value.style.display="block")}}else te.value.style.display="none",ue.value.style.display="none"}function Gt(){Q()&&(e.currentSeconds<x.ATO?rt(c("trading.derivative.atoOrder"),c("titles.confirm")).then(o=>{o&&p.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(i=>{i.isOk?$.success(c("trading.derivative.atoOrderSuccess")):W(i.message)})}):e.currentSeconds<x.ATC?p.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"new",side:e.tools.order.side,price:e.tools.order.entry.price}}).then(t=>{t.isOk?(le(["entry"]),$.success(c("trading.derivative.newEntrySuccess"))):W(t.message)}):rt(c("trading.derivative.atcOrder"),c("titles.confirm")).then(o=>{o&&p.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(i=>{i.isOk?$.success(c("trading.derivative.atcOrderSuccess")):W(i.message)})}))}function Kt(){e.tools.order.tp.price=e.tools.order.entry.price+e.tools.order.side*st,e.tools.order.sl.price=e.tools.order.entry.price-e.tools.order.side*nt,p.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.tools.order.tp.price},slData:{cmd:"new",price:e.tools.order.sl.price}}).then(t=>{t.isOk?(e.tools.order.entry.line.applyOptions({draggable:!1}),le(["entry","tp","sl"]),$.success(c("trading.derivative.newTpSlSuccess"))):W(t.message)})}function ei(){v.isSet(e.tools.order.entry.line)?v.isSet(e.tools.order.tp.line)?p.dispatch("tradingDerivative/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(t=>{t.isOk?(ce(["entry","tp","sl"]),$.success(c("trading.derivative.exitSuccess"))):W(t.message)}):p.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"delete"}}).then(t=>{t.isOk?(ce(["entry"]),$.success(c("trading.derivative.deleteEntrySuccess"))):W(t.message)}):Ee()}function ti(t){v.isSet(e.tools.order.entry.line)&&(v.isSet(e.tools.order.tp.line)?((e.tools.order.side>0&&t>=e.tools.order.tp.price||e.tools.order.side<0&&t<=e.tools.order.tp.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,p.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"delete"}}).then(o=>{o.isOk?(ce(["entry","tp","sl"]),$.success(c("trading.derivative.deleteTpSuccess")),we(!1)):W(o.message),e.isAutoOrdering=!1}))),(e.tools.order.side>0&&t<=e.tools.order.sl.price||e.tools.order.side<0&&t>=e.tools.order.sl.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,p.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"cancel"}}).then(o=>{o.isOk?(ce(["entry","tp","sl"]),$.success(c("trading.derivative.deleteSlSuccess")),we(!1)):W(o.message),e.isAutoOrdering=!1})))):(e.tools.order.side>0&&t>=e.tools.order.entry.price||e.tools.order.side<0&&t<=e.tools.order.entry.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,setTimeout(()=>{e.tools.order.tp.price=e.tools.order.entry.price+e.tools.order.side*st,e.tools.order.sl.price=e.tools.order.entry.price-e.tools.order.side*nt,p.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.tools.order.tp.price},slData:{cmd:"new",price:e.tools.order.sl.price}}).then(o=>{o.isOk?(e.tools.order.entry.line.applyOptions({draggable:!1}),le(["entry","tp","sl"]),$.success(c("trading.derivative.autoNewTpSlSuccess"))):W(o.message),e.isAutoOrdering=!1})},1e3))))}function ii(){e.chart.timeScale().scrollToRealTime()}function Q(){return q.value.openingMarket&&e.currentSeconds>=x.START&&e.currentSeconds<=x.END}function me(t){return parseFloat(e.series.price.coordinateToPrice(t).toFixed(1))}function W(t){t||(t="unknown"),$.error(c(`trading.derivative.${t}`))}function oi(){if(!d.chartDate)return!1;p.dispatch("tradingDerivative/getChartData",{date:d.chartDate})}function et(){Q()&&e.websocket.send(e.socketSendData)}function tt(t){e.data.whitespace=[],e.data.price=[],et(),p.dispatch("tradingDerivative/getChartData",{date:d.chartDate,isDay:t})}function Ee(){p.dispatch("tradingDerivative/getTools")}function ie(t){t==null&&(t=["order","lines","rr","target","tr","pattern","auto"]),t.includes("order")&&(e.tools.order={side:0,entry:{},tp:{},sl:{}}),t.includes("lines")&&(e.tools.lines=[]),t.includes("rr")&&(e.tools.rr={EP:{},SL:{},TP:{}}),t.includes("target")&&(e.tools.target={A:{},B:{},X:{},Y:{},Z:{}}),t.includes("tr")&&(e.tools.timeRange=[]),t.includes("pattern")&&(e.tools.pattern={A:{},B:{},C:{},D:{},X:{},Y:{},Z:{}}),t.includes("auto")&&(e.tools.auto={})}function ri(){p.dispatch("tradingDerivative/getAccountInfo").then(t=>{let o="";o+='<div style="width: 200px;">',o+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${c("trading.derivative.nav")}</div><div>: ${T.currency(t.nav)}</div></div>`,o+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${c("trading.derivative.maxVol")}</div><div>: ${T.numberVnFormat(t.maxVol)}</div></div>`,o+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${c("trading.derivative.vm")}</div><div>: ${T.currency(t.vm)}</div></div>`,o+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${c("trading.derivative.fee")}</div><div>: ${T.currency(t.fee)}</div></div>`,o+="</div>",Si(o,c("trading.derivative.accountInfo"))})}function si(){B.emit("checkPin",()=>p.dispatch("tradingDerivative/report"))}function ni(){B.emit("checkPin",()=>p.dispatch("tradingDerivative/export",d.chartDate))}function ai(){Ye.value.show()}function li(){B.emit("checkPin",()=>p.dispatch("tradingDerivative/loginDnse"))}function R(t,o,i,r=!1){return o?r?t>=i:t>i:r?t<=i:t<i}function oe(t){let o=e.data.whitespace.findIndex(i=>i.time==t);if(o==-1){const i=ke(new Date(t*1e3),"yyyy-MM-dd"),r=V(new Date(`${i}T11:30:00Z`)),a=V(new Date(`${i}T13:00:00Z`)),n=V(new Date(`${i}T14:30:00Z`));t>r&&t<a?t=r:t>n&&(t=n),o=e.data.whitespace.findIndex(s=>s.time==t)}return o}return(t,o)=>{const i=Ne("DxToolbar");return I(),z(Be,null,[h("div",ji,[G(i,{items:[{location:"before",widget:"dxButton",options:{icon:"far fa-file-chart-pie small",hint:t.$t("trading.derivative.buttons.report"),onClick:si}},{location:"before",widget:"dxButton",options:{icon:"far fa-cloud-arrow-down small",hint:t.$t("trading.derivative.buttons.export"),onClick:ni}},{location:"before",widget:"dxButton",options:{icon:"far fa-arrow-right-to-arc small",hint:t.$t("trading.derivative.buttons.loginVps"),onClick:ai}},{visible:!1,location:"before",widget:"dxButton",options:{icon:"far fa-sign-in-alt small",hint:t.$t("trading.derivative.buttons.loginDnse"),onClick:li}}]},null,8,["items"]),h("div",{class:"order-chart-container",ref_key:"chartContainerRef",ref:D,onClick:mt,onContextmenu:ht},[h("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:P},[h("div",{class:"area data-area",onClick:ze,onContextmenu:Xe},[h("div",{ref_key:"connectionRef",ref:N,class:H(["command",{yellow:M.value.pending}]),title:t.$t("trading.derivative.connection"),onClick:o[0]||(o[0]=()=>t.$store.dispatch("tradingDerivative/getStatus"))},[h("i",{class:H(["far",{"fa-link-simple":M.value.connection,"fa-link-simple-slash":!M.value.connection,blink:d.isSocketWarning}])},null,2)],10,Hi),h("div",{class:H(["command status",{green:M.value.position>0,red:M.value.position<0}]),title:t.$t("trading.derivative.position"),onClick:ri},ae(M.value.position),11,qi),h("div",{class:"command clock",onClick:et},ae(d.clock),1),ee(h("input",{type:"date",class:"chart-date command",title:t.$t("trading.derivative.date"),"onUpdate:modelValue":o[1]||(o[1]=r=>d.chartDate=r),onChange:oi},null,40,Qi),[[hi,d.chartDate]]),h("div",{ref_key:"reloadToolRef",ref:dt,class:"command",title:t.$t("trading.derivative.reload"),onClick:o[2]||(o[2]=()=>tt(!1)),onContextmenu:o[3]||(o[3]=()=>tt(!0))},[h("i",{class:H(["far fa-sync-alt",{"fa-spin":t.$store.state.tradingDerivative.isChartLoading}])},null,2)],40,Ui)],32),h("div",{class:"area tool-area",onClick:ze,onContextmenu:Xe},[h("div",{ref_key:"fullscreenToolRef",ref:pe,class:"command",title:t.$t("trading.derivative.fullscreen"),onClick:Tt},[h("i",{class:H(["far",{"fa-compress":d.isFullscreen,"fa-expand":!d.isFullscreen}])},null,2)],8,Gi),h("div",{ref_key:"tradingviewRef",ref:pt,class:"command far fa-chart-candlestick",title:t.$t("trading.derivative.tradingview"),onClick:Dt,onContextmenu:Ee},null,40,Ki),h("div",{class:H(["popup command",{green:d.progress[0]>0,red:d.progress[0]==0}]),title:t.$t("trading.derivative.progressTool"),onClick:Yt},[h("i",{class:H(["far",{"fa-badge-check":!d.progress[0],[`fa-circle-${d.progress[0]}`]:d.progress[0]}])},null,2),ee(G(Xi,{class:"contextmenu",modelValue:d.progress,"onUpdate:modelValue":o[4]||(o[4]=r=>d.progress=r)},null,8,["modelValue"]),[[se,d.showProgressContext]])],10,eo),h("div",{ref_key:"autoScanToolRef",ref:Fe,class:"command",title:t.$t("trading.derivative.autoScanTool"),onClick:Rt,onContextmenu:_t},[h("i",{class:H(["far fa-bolt-auto",{blink:q.value.autoScan}])},null,2)],40,to),h("div",{ref_key:"patternToolRef",ref:Re,class:"command",title:t.$t("trading.derivative.patternTool"),onClick:It,onContextmenu:Et},ro,40,io),h("div",{ref_key:"timeRangeToolRef",ref:ye,class:"command",title:t.$t("trading.derivative.timeRangeTool"),onClick:Mt,onContextmenu:Wt},ao,40,so),h("div",{ref_key:"lineToolRef",ref:ge,class:"popup command",title:t.$t("trading.derivative.lineTool"),onClick:bt,onContextmenu:Lt},[co,ee(G(Ti,{class:"contextmenu",enable:d.showLineContext,title:d.lineTitle,"onUpdate:title":o[5]||(o[5]=r=>d.lineTitle=r),color:d.lineColor,"onUpdate:color":o[6]||(o[6]=r=>d.lineColor=r),onDeleteAllLine:Ue},null,8,["enable","title","color"]),[[se,d.showLineContext]])],40,lo),h("div",{ref_key:"targetToolRef",ref:_e,class:"command",title:t.$t("trading.derivative.targetTool"),onClick:Jt,onContextmenu:zt},fo,40,po),ee(h("div",{ref_key:"rrToolRef",ref:Oe,class:"command",title:t.$t("trading.derivative.rrTool"),onClick:jt,onContextmenu:Ht},ho,40,vo),[[se,!1]]),ee(h("div",{class:"popup command",title:t.$t("trading.derivative.sampleTool"),onClick:Qt},[yo,ee(G(Ei,{class:"contextmenu"},null,512),[[se,d.showSampleContext]])],8,go),[[se,!1]]),ee(h("div",{ref_key:"cancelOrderRef",ref:ut,class:"cancel-order command",title:t.$t("trading.derivative.cancelTool"),onClick:ei},[h("i",{class:H(["far fa-trash-alt",{blink:d.isOrderWarning}])},null,2)],8,So),[[se,ft.value]])],32),h("div",null,[h("div",{ref_key:"entryOrderRef",ref:te,class:"order-button entry",onClick:Gt}," Entry ",512),h("div",{ref_key:"tpslOrderRef",ref:ue,class:"order-button tpsl",onClick:Kt}," TP/SL ",512),h("div",{class:"chart-top command far fa-angle-double-right",onClick:ii})]),ee(h("iframe",{ref_key:"tradingviewChartRef",ref:Y,class:"tradingview-chart",src:vt.value},null,8,To),[[se,d.showTradingView]])],512)],544)]),G(Ci,{ref_key:"vpsOtpPopupRef",ref:Ye},null,512)],64)}}};export{Oo as default};
