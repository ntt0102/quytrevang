import{u as F,a as A,b as O,c as V,i as u,r as z,d as H,e as y,w as N,f as X,g as x,h as G,j as o,k as C,l,F as L,o as j,D as r,m as U}from"./app-fe6d386a.js";import W from"./PaidContractPopup-022aea75.js";import J from"./WithdrawnContractPopup-31127208.js";import{_ as K}from"./ContractDetailPopup-256ba0f6.js";import"./accordion-92dfa6d5.js";import"./Index-250b6f82.js";import"./load-indicator-39314c0f.js";const Q={class:"content-block dx-card responsive-paddings"},lt={__name:"Index",setup(Y){const d=F(),w=A(),c=O(),{t:i}=V();u("bus");const v=u("filters"),$=u("mc"),m=u("mt"),p=u("mf"),h=u("routeHistoryState"),a=z(null),n=H({gridData:null,validationRules:{}}),S=y(()=>d.state.adminContract.users),s=y(()=>d.state.auth.user.permissions);let f=!1;d.dispatch("adminContract/getContracts").then(()=>k()),N(()=>d.state.adminContract.contracts,t=>_(t));function b(t){d.dispatch("adminContract/save",{changes:t.changes})}function R(t){t.toolbarOptions.items.unshift({visible:p.isSet(c.query),location:"before",widget:"dxButton",options:{icon:"far fa-arrow-left small",hint:i("buttons.back"),onClick:()=>{w.go(-1)}}},{location:"before",widget:"dxButton",options:{icon:"far fa-history small",type:f?"default":"normal",hint:i("models.contract.includeWithdrawn"),onClick:()=>{f=!f,a.value.instance.beginCustomLoading(),d.dispatch("adminContract/getContracts",f)}}})}function k(){n.validationRules={user:[{type:"required",message:i("models.contract.user")+m.validations.required}],principal:[{type:"required",message:i("models.contract.principal")+m.validations.required},{type:"custom",validationCallback:E,message:i("models.contract.validations.principal").replace("{amount}",v.currency(n.principalMin))}],advance:[{type:"custom",validationCallback:M,message:i("models.contract.validations.advance").replace("{advance}",v.currency(.1*n.principalMin)).replace("{surplus}",v.currency(n.principalMin))}],interestRate:[{type:"required",message:i("models.contract.interestRate")+m.validations.required}],paidAt:[{type:"required",message:i("models.contract.paidAt")+m.validations.required}]}}function T(t){t.data.interest_rate=n.interestRate,t.data.paid_at=moment().format($.SERVER_DATE_FORMAT),a.value.instance.columnOption("interest_rate","allowEditing",s.value.includes("system@control")),a.value.instance.option("editing.popup.title",i("models.contract.popup.create"))}function D(t){a.value.instance.columnOption("user_code","allowEditing",t.data.status==1||s.value.includes("system@control")),a.value.instance.columnOption("principal","allowEditing",t.data.status==1||s.value.includes("system@control")),a.value.instance.columnOption("interest_rate","allowEditing",s.value.includes("system@control")),a.value.instance.columnOption("paid_at","allowEditing",t.data.status==1||s.value.includes("system@control")),a.value.instance.columnOption("withdrawn_at","allowEditing",[2,3].includes(t.data.status)),a.value.instance.option("editing.popup.title",`${i("models.contract.popup.edit")} #${t.data.code}`)}function E(t){return t.value>=n.principalMin}function M(t){return t.value?t.value>=.1*n.principalMin&&t.data.total-t.value>=n.principalMin:!0}function _(t){n.gridData=p.cloneDeep(t),c.query.code&&a.value.instance.columnOption("code","filterValues",[+c.query.code]),c.query.userCode&&a.value.instance.columnOption("userCode","filterValues",[+c.query.userCode])}function I(t){p.checkPinDataGrid(t,a.value.instance),p.pushPopupToHistoryState(h,()=>a.value.instance.cancelEditData())}function q(){p.popRouteHistoryState(h)}function B(t){t.rowType=="data"&&t.columnIndex==2&&w.push({name:"admin-user",query:{code:t.data.user_code}})}return(t,g)=>{const P=X("DxToolbar");return j(),x(L,null,[G("div",Q,[o(l(U),{ref_key:"dataGridRef",ref:a,"data-source":n.gridData,"key-expr":"code","show-borders":!0,"column-auto-width":!0,"allow-column-reordering":!0,"allow-column-resizing":!0,"column-resizing-mode":"widget",paging:{pageSize:10},headerFilter:{visible:!0},loadPanel:{enabled:!0},selection:{mode:"single"},editing:{allowAdding:!0,allowUpdating:!0,allowDeleting:!0,confirmDelete:!1,mode:"popup",popup:{fullScreen:!!t.$screen.getScreenSizeInfo.isXSmall,showTitle:!0,onShown:I,onHiding:q},form:{labelLocation:t.$screen.getScreenSizeInfo.isXSmall?"top":"left",items:[{dataField:"user_code"},{dataField:"principal"},{dataField:"interest_rate"},{dataField:"paid_at"},{dataField:"advance"},{dataField:"withdrawn_at"}]}},onCellPrepared:t.$mf.setContractStatusColor,onContentReady:g[0]||(g[0]=e=>t.$mf.dataGridPreload(n.gridData,a.value.instance)),onInitNewRow:T,onEditingStart:D,onToolbarPreparing:R,onCellDblClick:B,onSaved:b},{commandCellTemplate:C(({data:e})=>[o(P,{items:[{visible:e.data.status==2&&s.value.includes("system@control")||[0,1].includes(e.data.status),locateInMenu:"auto",showText:"inMenu",location:"center",widget:"dxButton",options:{type:"default",icon:`far fa-${e.data.status==2?"file-":""}check small`,hint:t.$t(`components.paidContract.${e.data.status==2?"confirmTitle":"title"}`),text:t.$t(`components.paidContract.${e.data.status==2?"confirmTitle":"title"}`),onClick:()=>t.$refs.paidContractPopupRef.show(e.data)}},{visible:e.data.status==3||e.data.status==4&&s.value.includes("system@control"),locateInMenu:"auto",showText:"inMenu",location:"center",widget:"dxButton",options:{type:"default",icon:`far fa-${e.data.status<=1?"check":e.data.status==3?"check-double":"file-check"} small`,hint:t.$t(`components.withdrawnContract.${e.data.status==4?"withdrawnTitle":"title"}`),text:t.$t(`components.withdrawnContract.${e.data.status==4?"withdrawnTitle":"title"}`),onClick:()=>t.$refs.withdrawnContractPopupRef.show(e.data)}},{visible:e.data.status<=3||s.value.includes("system@control"),locateInMenu:"auto",showText:"inMenu",location:"center",widget:"dxButton",options:{type:"default",icon:"edit",hint:t.$t("buttons.edit"),text:t.$t("buttons.edit"),onClick:()=>a.value.instance.editRow(e.rowIndex)}},{visible:e.data.status==0||s.value.includes("system@control"),locateInMenu:"auto",showText:"inMenu",location:"center",widget:"dxButton",options:{type:"default",icon:"trash",hint:t.$t("buttons.delete"),text:t.$t("buttons.delete"),onClick:()=>t.$bus.emit("checkPin",()=>a.value.instance.deleteRow(e.rowIndex))}},{visible:!isNaN(e.key),locateInMenu:"auto",showText:"inMenu",location:"center",widget:"dxButton",options:{type:"default",icon:"info",hint:t.$t("models.contract.popup.detail"),text:t.$t("models.contract.popup.detail"),onClick:()=>t.$refs.contractDetailPopupRef.show(e.data)}}]},null,8,["items"])]),default:C(()=>[o(l(r),{fixed:!0,width:t.$screen.getScreenSizeInfo.isXSmall?35:70,alignment:"center",type:"buttons",cssClass:"dx-datagrid-command-column","cell-template":"commandCellTemplate",caption:t.$t(`titles.commandHeaderTitle${t.$screen.getScreenSizeInfo.isXSmall?"Short":""}`)},null,8,["width","caption"]),o(l(r),{"allow-editing":!1,"data-field":"code",dataType:"string","header-filter":{allowSearch:!0},caption:t.$t("models.contract.codeShort")},null,8,["caption"]),o(l(r),{"allow-editing":!1,"data-field":"status",dataType:"number",caption:t.$t("models.contract.status"),lookup:{dataSource:t.$mf.getContractStatusList(),displayExpr:"name",valueExpr:"value"}},null,8,["caption","lookup"]),o(l(r),{"data-field":"user_code",dataType:"number",name:"userCode","header-filter":{allowSearch:!0},caption:t.$t("models.contract.user"),"validation-rules":n.validationRules.user,lookup:{dataSource:S.value,displayExpr:"name",valueExpr:"code",searchEnabled:!0,searchExpr:["code","name"]}},null,8,["caption","validation-rules","lookup"]),o(l(r),{"data-field":"principal","data-type":"number",format:"#,##0 ₫","editor-options":{step:"1000000",format:"#,##0 ₫"},"header-filter":{allowSearch:!0},caption:t.$t("models.contract.principal"),"validation-rules":n.validationRules.principal},null,8,["caption","validation-rules"]),o(l(r),{"data-field":"interest_rate","data-type":"number",format:"#0.## %/"+t.$t("models.contract.frequency"),"editor-options":{step:"0.0001",format:"#0.## %/"+t.$t("models.contract.frequency")},caption:t.$t("models.contract.interestRate"),"validation-rules":n.validationRules.interestRate},null,8,["format","editor-options","caption","validation-rules"]),o(l(r),{"data-field":"paid_at","data-type":"date","editor-options":{dateSerializationFormat:t.$mc.DX_SERVER_DATE_FORMAT,showClearButton:"true",useMaskBehavior:"true",applyValueMode:"useButtons"},caption:t.$t("models.contract.paidAt"),"validation-rules":n.validationRules.paidAt},null,8,["editor-options","caption","validation-rules"]),o(l(r),{"data-field":"advance","data-type":"number",format:"#,##0 ₫","editor-options":{step:"1000000",format:"#,##0 ₫"},"header-filter":{allowSearch:!0},caption:t.$t("models.contract.advance"),"validation-rules":n.validationRules.advance},null,8,["caption","validation-rules"]),o(l(r),{"data-field":"withdrawn_at","data-type":"date","editor-options":{dateSerializationFormat:t.$mc.DX_SERVER_DATE_FORMAT,showClearButton:"true",useMaskBehavior:"true",applyValueMode:"useButtons"},caption:t.$t("models.contract.withdrawnAt")},null,8,["editor-options","caption"])]),_:1},8,["data-source","editing","onCellPrepared"])]),o(W,{ref:"paidContractPopupRef"},null,512),o(J,{ref:"withdrawnContractPopupRef"},null,512),o(K,{ref:"contractDetailPopupRef"},null,512)],64)}}};export{lt as default};
