import{A as vt,B as ht,C as gt,r as E,y as We,E as Qe,o as Q,b as U,d as L,G as le,H as St,I as yt,F as Ve,J as Fe,t as Te,h as ge,c as ve,K as xe,L as Ce,e as ae,u as Ue,g as Ge,k as he,w as ke,M as Tt,m as xt,N as Ke,l as Le,a as kt,x as ne,O as Ct,j as _t,Q as wt,z as ze,R as bt}from"./app-6d28c666.js";import{_ as Dt}from"./button-group-aec70de3.js";import{_ as Rt}from"./text-box-38b84595.js";import{c as Ot}from"./lightweight-charts.esm.development-03366bac.js";import{g as ie}from"./getUnixTime-0079b019.js";function et(A,P,T){return vt((T==null?void 0:T.in)||A,+ht(A)+P)}function Be(A,P,T){return et(A,P*gt,T)}function Lt(A,P,T){return et(A,P*1e3,T)}function Pt(A,P,T){return Lt(A,-P,T)}const Et=["title"],At={__name:"FullscreenTool",props:["chartContainerRef"],setup(A){const P=A,T=E(!1);We(()=>{document.addEventListener("fullscreenchange",i)}),Qe(()=>{document.removeEventListener("fullscreenchange",i)});function h(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function i(){P.chartContainerRef&&(document.fullscreenElement?(T.value=!0,P.chartContainerRef.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(T.value=!1,P.chartContainerRef.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}return(a,g)=>(Q(),U("div",{class:"command",title:a.$t("trading.derivative.fullscreen"),onClick:h},[L("i",{class:le(["far",{"fa-compress":T.value,"fa-expand":!T.value}])},null,2)],8,Et))}};const $t=L("div",{class:"triangle-shadow"},null,-1),Nt=L("div",{class:"triangle"},null,-1),It={class:"container"},Bt={class:"conditions"},Vt={__name:"ProgressContext",props:["progress"],setup(A){const P=E([]);We(()=>{T()});function T(){St(Object.assign({"../../../../../lang/vi/derivative.js":()=>yt(()=>import("./derivative-abc38cb4.js"),[])}),`../../../../../lang/${window.lang}/derivative.js`).then(i=>{P.value=i.default||[]})}function h(i){i.stopPropagation()}return(i,a)=>(Q(),U("div",{class:"pattern-context",onClick:h},[$t,Nt,L("div",It,[(Q(!0),U(Ve,null,Fe(P.value,(g,b)=>(Q(),U("div",{key:b,class:le(["step"])},[L("div",{class:le(["step-header",[A.progress.steps?A.progress.steps[b].every(Boolean)?"success":"fail":""]])},Te(b+1)+". "+Te(g.name),3),L("div",Bt,[(Q(!0),U(Ve,null,Fe(g.conds,(n,m)=>(Q(),U("div",{key:m,class:le(["condition",[A.progress.steps?A.progress.steps[b][m]?"success":"fail":""]])},Te(m+1)+". "+Te(n),3))),128))])]))),128))])]))}},Ft=["title"],Wt={__name:"ProgressTool",emits:["refreshPattern","hideContext"],setup(A,{expose:P,emit:T}){const h=ge(),i=T,a=E({}),g=E(!1),b=ve(()=>h.state.tradingDerivative.config.autoRefresh);P({hide:m,set:O});function n(){const V=g.value;i("hideContext"),g.value=!V,g.value&&i("refreshPattern")}function m(V){g.value=V}function O(V){a.value=V}function J(V){const M=V??!M.value;h.dispatch("tradingDerivative/setAutoRefresh",M)}return(V,M)=>(Q(),U("div",{class:le(["context command",{green:a.value.result===!0,red:a.value.result===!1}]),title:V.$t("trading.derivative.progressTool"),onClick:n,onContextmenu:J},[L("i",{class:le(["far",{"fa-badge-check":!a.value.step,[`fa-circle-${a.value.step}`]:a.value.step,blink:b.value}])},null,2),xe(ae(Vt,{class:"contextmenu",progress:a.value},null,8,["progress"]),[[Ce,g.value]])],42,Ft))}};const Mt=L("div",{class:"triangle-shadow"},null,-1),Zt=L("div",{class:"triangle"},null,-1),Yt={__name:"ScanContext",props:["modelValue"],emits:["update:modelValue"],setup(A,{emit:P}){const{t:T}=Ue(),h=[{icon:"chevrondoubleleft",side:"left",text:T("trading.derivative.scanContext.leftScan")},{icon:"chevrondoubleright",side:"right",text:T("trading.derivative.scanContext.rightScan")}],i=A,a=P;function g({itemData:{side:n}}){a("update:modelValue",n)}function b(n){n.stopPropagation()}return(n,m)=>(Q(),U("div",{class:"scan-context",onClick:b},[Mt,Zt,ae(Ge(Dt),{items:h,"selected-item-keys":[i.modelValue],"key-expr":"side","styling-mode":"outlined",onItemClick:g},null,8,["selected-item-keys"])]))}},Jt=["title"],Xt={__name:"ScanTool",props:["prices","timeToIndex"],emits:["scaned","removePattern","hideContext"],setup(A,{expose:P,emit:T}){const h=he("mf"),i=A,a=T,g=E(null),b=E(!1),n=E("left");P({isSelected:m,hide:O,draw:M});function m(){return g.value.classList.contains("selected")}function O(p){b.value=p}function J(p){a("hideContext");const v=p.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(s=>s.classList.remove("selected")),v||(p.target.classList.add("selected"),a("removePattern"))}function V(){const p=b.value;a("hideContext"),b.value=!p}function M({time:p}){const v=n.value==="left",s=p?i.prices.filter(u=>!h.cmp(u.time,v,p)):i.prices;let l=v?K(s):N(s);h.isSet(l)&&a("scaned",D(l)),g.value.classList.remove("selected")}function K(p){let v,[s,l,u,f]=Array(4).fill({});for(let C=p.length-1;C>=0;C--){const y=p[C].value,$=p[C].time,e=i.timeToIndex($);if(e===-1)break;if(C===p.length-1&&(u={index:e,time:$,price:y},[l,s,f]=Array(3).fill(null).map(()=>h.cloneDeep(u))),v===void 0){if(y===u.price)continue;v=y>u.price}if(h.cmp(y,v,l.price)&&(h.cmp(s.price,!v,u.price)?([u,l]=[l,s].map(r=>h.cloneDeep(r)),s={index:e,time:$,price:y},f=h.cloneDeep(s),v=!v):l={index:e,time:$,price:y}),h.cmp(y,!v,s.price)?(s={index:e,time:$,price:y},f=h.cloneDeep(s)):f.index=e,h.cmp(y,v,f.price)&&(f={index:e,time:$,price:y}),u.index>s.index){const r=h.fmtNum(l.price-u.price,1,!0);if(r>=1.5&&(s.index-f.index>u.index-l.index||h.fmtNum(s.price-f.price,1,!0)>r))break}}return{A:s,B:l,C:u}}function N(p){let v,[s,l,u]=Array(3).fill({});for(let f=0;f<p.length;f++){const C=p[f].value,y=p[f].time,$=i.timeToIndex(y);if($===-1)break;if(f===0&&(s={index:$,time:y,price:C},l=h.cloneDeep(s),u=h.cloneDeep(s)),v===void 0){if(C===s.price)continue;v=C>s.price}h.cmp(C,v,l.price)&&(l={index:$,time:y,price:C},u=h.cloneDeep(l)),h.cmp(l.price,v,s.price)&&h.cmp(C,!v,u.price)&&(h.cmp(C,v,s.price)?u={index:$,time:y,price:C}:(s=h.cloneDeep(l),l={index:$,time:y,price:C},u=h.cloneDeep(l),v=!v))}return{A:s,B:l,C:u}}function D(p){const v={};return Object.entries(p).forEach(([s,l])=>{const{index:u,...f}=l;v[s]=f}),v}return(p,v)=>(Q(),U("div",{ref_key:"scanToolRef",ref:g,class:"context command",title:p.$t("trading.derivative.scanTool"),onClick:J,onContextmenu:V},[L("i",{class:le(["far",{[`fa-angles-${n.value}`]:!0}])},null,2),xe(ae(Yt,{class:"contextmenu",modelValue:n.value,"onUpdate:modelValue":v[0]||(v[0]=s=>n.value=s)},null,8,["modelValue"]),[[Ce,b.value]])],40,Jt))}},Ht=["title"],zt=L("i",{class:"far fa-heart-rate"},null,-1),jt=[zt],qt={__name:"PatternTool",props:["prices","priceSeries","timeMarkSeries","pickTimeToolRef","timeToIndex","indexToTime"],emits:["setProgress","hideContext"],setup(A,{expose:P,emit:T}){const h=ge(),i=he("mf"),a=A,g=T,b=E(null);let n={},m={};P({isSelected:O,draw:M,load:K,refresh:D,remove:f,drag:$});function O(){return b.value.classList.contains("selected")}function J(e){g("hideContext");const r=e.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(S=>S.classList.remove("selected")),r||(e.target.classList.add("selected"),a.pickTimeToolRef.remove())}function V(e){e.target.classList.remove("selected"),f()}function M({time:e,price:r}){let d={lineType:"pattern",price:r,lineWidth:1,lineStyle:1,draggable:!0};if(i.isSet(m.A))if(i.isSet(m.B)){let R,w;if(i.isSet(m.C)){let k,x;n.A={time:e,price:r};const{progress:_,timeMark:I,info:{rEpr1:Y,rEpr2:X,rEpr3:re,entry:se,pStatus:ee,x:G,X:oe,y:q,Y:H}}=p();w=_,R=I,k="A",x={price:r,title:`A ${Y}`},m[k].applyOptions(x),k="B",x={title:`B ${X}`},m[k].applyOptions(x),k="C",x={title:`C ${re}`},m[k].applyOptions(x),k="D",x={price:se,title:"Entry "+ee},m[k].applyOptions(x),k="X",x={price:i.fmtNum(G),title:`X ${i.fmtNum(oe)}`},m[k].applyOptions(x),k="Y",x={price:i.fmtNum(q),title:`Y ${i.fmtNum(H)}`},m[k].applyOptions(x)}else{n.C={price:r};const{progress:k,timeMark:x,info:{rEpr1:_,rEpr2:I,rEpr3:Y,entry:X,pStatus:re,x:se,X:ee,y:G,Y:oe}}=p();w=k,R=x;let q="A";m[q].applyOptions({title:`A ${_}`}),q="B",m[q].applyOptions({title:`B ${I}`}),d.point="C",d.title=`C ${Y}`,d.color="#FFEB3B",m[d.point]=a.priceSeries.createPriceLine(d),d.point="D",d.price=X,d.title="Entry "+re,d.color="#9C27B0",d.draggable=!1,m[d.point]=a.priceSeries.createPriceLine(d),d.point="Y",d.price=i.fmtNum(G),d.title=`Y ${i.fmtNum(oe)}`,d.color="#E91E63",d.draggable=!1,m[d.point]=a.priceSeries.createPriceLine(d),d.point="X",d.price=i.fmtNum(se),d.title=`X ${i.fmtNum(ee)}`,d.color="#2196F3",d.draggable=!1,m[d.point]=a.priceSeries.createPriceLine(d)}g("setProgress",w),y(R),b.value.classList.remove("selected")}else d.point="B",d.title="B 0",d.color="#4CAF50",m[d.point]=a.priceSeries.createPriceLine(d),n.B={price:r};else d.point="A",d.title="A 0",d.color="#F44336",m[d.point]=a.priceSeries.createPriceLine(d),n={A:{time:e,price:r}};u()}function K(e,r=!1){n=e,r&&u(),C(),N()}function N(){let r={lineType:"pattern",lineWidth:1,lineStyle:1,draggable:!0};const{A:S,B:d,C:R}=n,{progress:w,timeMark:k,info:{rEpr1:x,rEpr2:_,rEpr3:I,entry:Y,pStatus:X,x:re,X:se,y:ee,Y:G}}=p();g("setProgress",w),y(k),r.point="A",r.title=`A ${x}`,r.color="#F44336",r.price=S.price,m[r.point]=a.priceSeries.createPriceLine(r),r.point="B",r.title=`B ${_}`,r.color="#4CAF50",r.price=d.price,m[r.point]=a.priceSeries.createPriceLine(r),r.point="C",r.price=R.price,r.title=`C ${I}`,r.color="#FFEB3B",m[r.point]=a.priceSeries.createPriceLine(r),r.point="D",r.price=Y,r.title="Entry "+X,r.color="#9C27B0",r.draggable=!1,m[r.point]=a.priceSeries.createPriceLine(r),r.point="Y",r.price=i.fmtNum(ee),r.title=`Y ${i.fmtNum(G)}`,r.color="#E91E63",r.draggable=!1,m[r.point]=a.priceSeries.createPriceLine(r),r.point="X",r.price=i.fmtNum(re),r.title=`X ${i.fmtNum(se)}`,r.color="#2196F3",r.draggable=!1,m[r.point]=a.priceSeries.createPriceLine(r)}function D(e=!1){i.isSet(m.C)&&(e&&l(),C(),N())}function p(){const{A:e,B:r,C:S}=n,d=r.price-S.price,R=d>0,w=v({phase:1,start:e,end:r,retracementPrice:S.price});let k=v({phase:2,start:w.R,end:S});const x=v({phase:3,start:k.R,end:{price:r.price+(R?1:-1)*w.rEp},breakPrices:[k.S1.price,r.price]});w.xBox.tr>=k.tr&&(k.tr=w.xBox.tr),console.log("calculatePattern",[w,k,x]);const _=i.fmtNum(d,1,!0)>=w.pr,I=i.fmtNum(S.price-x.xBox.R.price,1,!0)>=k.pr,Y=i.fmtNum(x.xBox.pr)>=x.pr,X=!i.cmp(S.price,!R,w.S1.price),re=!i.cmp(x.xBox.R.price,R,k.S1.price),se=!i.cmp(x.xBox.S.price,!R,x.S1.price),ee=w.R.index+w.tr,G=k.R.index+k.tr,oe=x.xBox.R.index+x.tr,q=x.xBox.R.index+k.tr,H=[ee,G,oe,q],z=x.xBox.S.index;let te,j={};const _e=[k.R.index>ee,w.rEpr<3,k.rEpr<w.rEpr];j.steps=[[_||w.rEt<w.tr&&w.rEp>=w.sEp,X,!x.breakIndexs[1]||ee<x.breakIndexs[1],z>ee],[..._e,G>ee,z<G],[k.R.index-w.R.index>.5*w.tr,I,z>G],[Y,se,z>oe,_e.every(Boolean)||z>q]],j.step=1,j.result=j.steps[0].every(Boolean),te=w.R1.price,j.result&&(z<=G?(j.step=2,j.result=j.steps[1].every(Boolean),te=k.S1.price):(j.step=3,j.result=j.steps[2].every(Boolean),te=x.R1.price,j.result&&(j.step=4,j.result=j.steps[3].every(Boolean),j.result&&(te=x.xBox.R.price))));const Ee=`${X?_?1:0:2}${re?I?1:0:2}${se?Y?1:0:2}`,Se=w.rEp,Ae=s(r.price,Se,R),$e=x.breakIndexs[1]??z,de=parseInt(($e-w.R.index)/w.tr),we=de>1?Se*de:Se,ue=s(r.price,we,R);return{progress:j,timeMark:H,info:{rEpr1:w.rEpr,rEpr2:k.rEpr,rEpr3:x.rEpr,entry:te,pStatus:Ee,x:Ae,X:Se,y:ue,Y:we}}}function v({phase:e,start:r,end:S,breakPrices:d,retracementPrice:R}){let w=i.cloneDeep(r),k=i.cloneDeep(S);const x=k.price>w.price;let _={},I={},Y={},X=[null,null],re,se,ee;const G=a.pickTimeToolRef.get();return a.prices.filter(oe=>{let q=oe.time>=w.time;return G&&(q&=oe.time<=G),q}).every((oe,q)=>{const H=oe.value,z=oe.time,te=a.timeToIndex(z);return te===-1?!1:((q===0||H===w.price)&&(_={R:{index:te,time:z,price:H},S:{index:te,time:z,price:H},pr:0,tr:0},I=i.cloneDeep(_),Y=i.cloneDeep(_)),i.cmp(H,x,_.R.price)?(_.pr>I.pr&&(I.pr=_.pr),_.tr>=I.tr&&(I.tr=_.tr,I.R=i.cloneDeep(_.R),I.S=i.cloneDeep(_.S)),e===1&&R&&!i.cmp(_.S.price,!x,R)&&_.tr>=Y.tr&&_.pr>=Y.pr&&(Y=i.cloneDeep(_)),_={R:{index:te,time:z,price:H},S:{index:te,time:z,price:H},pr:0,tr:0},e===3&&d&&(!X[0]&&i.cmp(H,x,d[0])&&(X[0]=te),!X[1]&&i.cmp(H,x,d[1])&&(X[1]=te))):(_.S.index=te,_.tr=_.S.index-_.R.index,i.cmp(H,!x,_.S.price)&&(_.S.time=z,_.S.price=H,_.pr=i.fmtNum(_.S.price-_.R.price,1,!0))),i.cmp(H,!x,w.price)?(_.S.price=w.price,!1):!!i.cmp(H,!x,k.price))}),i.isSet(_)&&(w.index=a.timeToIndex(w.time),k.index=_.S.index,k.time=a.indexToTime(_.S.index),re=i.fmtNum(k.price-I.R.price,1,!0),se=i.fmtNum(w.price-I.S.price,1,!0),ee=k.index-I.S.index,e===3&&(Y=_)),{tr:I.tr,pr:I.pr,rEp:re,sEp:se,rEpr:I.pr?i.fmtNum(re/I.pr):0,rEt:ee,S1:I.S,R1:I.R,xBox:Y,S:w,R:k,breakIndexs:X}}function s(e,r,S){const d=e+(S?1:-1)*r;let R=i.fmtNum(d%1);if(S){if(R>=.1&&R<=.2)return Math.floor(d);if(R>=.6&&R<=.7)return Math.floor(d)+.5}else{if(R>=.8&&R<=.9)return Math.ceil(d);if(R>=.3&&R<=.4)return Math.floor(d)+.5}return d}function l(){if(!a.pickTime)return!1;const e=n.B.price-n.A.price>0,r=a.prices.at(-1).value;if(i.cmp(r,!e,n.C.price)){let S=r;for(let d=a.prices.length-1;d>=0;d--){const R=a.prices[d].value;if(R===n.B.price)break;S=e?Math.min(S,R):Math.max(S,R)}n.C.price=S,u()}}function u(e=!1){let r={isRemove:e,name:"pattern",points:[],data:[]};e?n={}:Object.entries(n).forEach(([S,d])=>{r.points.push(S),r.data.push(d)}),h.dispatch("tradingDerivative/drawTools",r)}function f(){u(!0),a.pickTimeToolRef.remove(),C()}function C(){i.isSet(m.A)&&(a.priceSeries.removePriceLine(m.A),i.isSet(m.B)&&(a.priceSeries.removePriceLine(m.B),i.isSet(m.C)&&(a.priceSeries.removePriceLine(m.C),a.priceSeries.removePriceLine(m.D),a.priceSeries.removePriceLine(m.X),a.priceSeries.removePriceLine(m.Y)))),m={},g("setProgress",{}),y([])}function y(e){const r=["#F44336","#4CAF50","#FFEB3B","#2196F3"];let S=[];for(let d=0;d<e.length;d++){let R=a.indexToTime(e[d]);R&&(e.indexOf(e[d])!==e.lastIndexOf(e[d])&&(R+=d),S.push({time:R,value:1,color:r[d]}))}S.length&&S.sort((d,R)=>d.time-R.time),a.timeMarkSeries.setData(S)}function $({lineOptions:e}){if(i.isSet(m.C)){let r,S;n={A:{time:n.A.time,price:+m.A.options().price},B:{price:+m.B.options().price},C:{price:+m.C.options().price}},u();const{progress:d,timeMark:R,info:{rEpr1:w,rEpr2:k,rEpr3:x,entry:_,pStatus:I,x:Y,X,y:re,Y:se}}=p();g("setProgress",d),y(R),r="A",S={title:`A ${w}`},m[r].applyOptions(S),r="B",S={title:`B ${k}`},m[r].applyOptions(S),r="C",S={title:`C ${x}`},m[r].applyOptions(S),r="D",S={price:_,title:"Entry "+I},e.point===r&&delete S.price,m[r].applyOptions(S),r="X",S={price:i.fmtNum(Y),title:`X ${i.fmtNum(X)}`},m[r].applyOptions(S),r="Y",S={price:i.fmtNum(re),title:`Y ${i.fmtNum(se)}`},m[r].applyOptions(S)}}return(e,r)=>(Q(),U("div",{ref_key:"patternToolRef",ref:b,class:"command",title:e.$t("trading.derivative.patternTool"),onClick:J,onContextmenu:V},jt,40,Ht))}},Qt=["title"],Ut=L("i",{class:"far fa-pipe"},null,-1),Gt=[Ut],Kt={__name:"PickTimeTool",props:["pickTimeSeries"],emits:["refreshPattern","hideContext"],setup(A,{expose:P,emit:T}){const h=ge(),i=A,a=T,g=E(null);let b=null;P({isSelected:n,draw:V,load:M,remove:K,get:m});function n(){return g.value.classList.contains("selected")}function m(){return b}function O(N){a("hideContext");const D=N.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(p=>p.classList.remove("selected")),D||N.target.classList.add("selected")}function J(N){N.target.classList.remove("selected"),K(),a("refreshPattern")}function V({time:N}){h.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"0_pt",points:[0],data:[N]}),M(N),a("refreshPattern"),g.value.classList.remove("selected")}function M(N){b=N,i.pickTimeSeries.setData([{time:N,value:1,color:"#9C27B0"}])}function K(N=!0){N&&h.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"0_pt"}),i.pickTimeSeries.setData([]),b=null}return(N,D)=>(Q(),U("div",{ref_key:"pickTimeToolRef",ref:g,class:"command",title:N.$t("trading.derivative.pickTimeTool"),onClick:O,onContextmenu:J},Gt,40,Qt))}};const ei=L("div",{class:"triangle-shadow"},null,-1),ti=L("div",{class:"triangle"},null,-1),ii={class:"input"},ri={class:"color"},si=["onClick"],ni={__name:"LineContext",props:["enable","title","color"],emits:["update:title","update:color"],setup(A,{emit:P}){const T=A,h=P,i=E(null),a=E(["#F44336","#FF9800","#FFEB3B","#4CAF50","#009688","#00BCD4","#2196F3","#673AB7","#9C27B0","#E91E63"]);ke(()=>T.enable,O=>{O&&Tt().then(()=>i.value.instance.focus())});function g({value:O}){h("update:title",O)}function b(O){h("update:color",O)}function n(){h("deleteAllLine")}function m(O){O.stopPropagation()}return(O,J)=>{const V=xt("DxButton");return Q(),U("div",{class:"line-context",onClick:m},[ei,ti,L("div",ii,[ae(Ge(Rt),{ref_key:"titleRef",ref:i,value:T.title,"show-clear-button":!0,"input-attr":{style:`color:${T.color}`},onValueChanged:g},null,8,["value","input-attr"]),ae(V,{icon:"trash",type:"danger",onClick:J[0]||(J[0]=M=>n())})]),L("div",ri,[(Q(!0),U(Ve,null,Fe(a.value,(M,K)=>(Q(),U("div",{class:"color-swatch",style:Ke({background:M,boxShadow:`0 0 4px ${M}`}),key:K,onClick:N=>b(M)},null,12,si))),128))])])}}},oi=["title"],ai=L("i",{class:"far fa-horizontal-rule"},null,-1),ci={__name:"LineTool",props:["priceSeries"],emits:["hideContext"],setup(A,{expose:P,emit:T}){const h=ge(),i=A,a=T,g=E(null),b=E(!1),n=E(""),m=E("#F44336");let O=[];P({isSelected:J,hide:V,draw:N,load:D,drag:s});function J(){return g.value.classList.contains("selected")}function V(l){b.value=l}function M(l){a("hideContext");const u=l.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(f=>f.classList.remove("selected")),u||l.target.classList.add("selected")}function K(l){const u=b.value;a("hideContext"),b.value=!u}function N({price:l}){const u="line",f=O.length;if(O=O.filter(C=>{const y=C.options(),$=y.type=l===+y.price;return $&&(i.priceSeries.removePriceLine(C),h.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:u,point:l})),!$}),O.length===f){const C=m.value,y=n.value,$={lineType:u,price:l,color:C,title:y,lineWidth:1,lineStyle:1,draggable:!0};O.push(i.priceSeries.createPriceLine($)),h.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:u,points:[l],data:[{color:C,title:y}]})}g.value.classList.remove("selected")}function D(l){v(!1),p(l)}function p(l){const f={lineType:"line",lineWidth:1,lineStyle:1,draggable:!0};Object.entries(l).forEach(([C,{color:y,title:$}])=>{f.price=+C,f.color=y,f.title=$,O.push(i.priceSeries.createPriceLine(f))})}function v(l=!0){O.length>0&&(l&&h.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line"}),O.forEach(u=>i.priceSeries.removePriceLine(u)),O=[])}function s({lineOptions:l,oldPrice:u,newPrice:f}){h.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line",point:u});const C=l.color,y=l.title;h.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"line",points:[f],data:[{color:C,title:y}]}),g.value.classList.remove("selected")}return(l,u)=>(Q(),U("div",{ref_key:"lineToolRef",ref:g,class:"context command",title:l.$t("trading.derivative.lineTool"),onClick:M,onContextmenu:K},[ai,xe(ae(ni,{class:"contextmenu",enable:b.value,title:n.value,"onUpdate:title":u[0]||(u[0]=f=>n.value=f),color:m.value,"onUpdate:color":u[1]||(u[1]=f=>m.value=f),onDeleteAllLine:v},null,8,["enable","title","color"]),[[Ce,b.value]])],40,oi))}},li=["title"],di=L("i",{class:"far fa-grip-lines-vertical"},null,-1),pi=[di],ui={__name:"TimeRangeTool",props:["timeRangeSeries","timeToIndex","indexToTime"],emits:["hideContext"],setup(A,{expose:P,emit:T}){const h=ge(),i=he("mf"),a=A,g=T,b=E(null);let n=[];P({isSelected:m,draw:V,load:M});function m(){return b.value.classList.contains("selected")}function O(D){g("hideContext");const p=D.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(v=>v.classList.remove("selected")),p||D.target.classList.add("selected")}function J(D){N(),D.target.classList.remove("selected")}function V({time:D}){let p={isRemove:!1,name:"tr",points:[],data:[]},v={time:D,value:1};switch(n.length){case 0:v.color="OrangeRed",n[0]=v,p.points.push(0),p.data.push(D);break;case 1:v.color="lime",n[1]=v,p.points.push(1),p.data.push(D),b.value.classList.remove("selected");break;default:const s=a.timeToIndex(n[0].time),l=a.timeToIndex(n[1].time),f=a.timeToIndex(D)+(l-s),C=a.indexToTime(f);v.color="OrangeRed",n[0]=i.cloneDeep(v),p.points.push(0),p.data.push(D),v.time=C,v.color="lime",n[1]=v,p.points.push(1),p.data.push(C),b.value.classList.remove("selected");break}a.timeRangeSeries.setData(n),h.dispatch("tradingDerivative/drawTools",p)}function M(D){N(!1),K(D)}function K(D){let p,v;if(D.length===2)p=D[0],v=D[1];else if(D.length===3){const l=a.timeToIndex(D[0]),u=a.timeToIndex(D[1]),C=a.timeToIndex(D[2])+(u-l);p=D[2],v=a.indexToTime(C)}else return!1;let s=[{time:p,value:1,color:"OrangeRed"},{time:v,value:1,color:"lime"}];n=s,a.timeRangeSeries.setData(s)}function N(D=!0){D&&h.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"tr"}),a.timeRangeSeries.setData([]),n=[]}return(D,p)=>(Q(),U("div",{ref_key:"timeRangeToolRef",ref:b,class:"command",title:D.$t("trading.derivative.timeRangeTool"),onClick:O,onContextmenu:J},pi,40,li))}},fi=["title"],mi=L("i",{class:"far fa-line-height"},null,-1),vi=[mi],hi={__name:"TargetTool",props:["priceSeries"],emits:["hideContext"],setup(A,{expose:P,emit:T}){const h=ge(),i=he("mf"),a=A,g=T,b=E(null);let n={};P({isSelected:m,draw:V,load:M,drag:D});function m(){return b.value.classList.contains("selected")}function O(p){g("hideContext");const v=p.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(s=>s.classList.remove("selected")),v||(p.target.classList.add("selected"),N())}function J(p){N(),p.target.classList.remove("selected")}function V({price:p}){const v="target";let s={lineType:v,price:p,lineWidth:1,lineStyle:1,draggable:!0},l={isRemove:!1,name:v,points:[],data:[p]};if(i.isSet(n.A)){const u=+n.A.options().price,f=p-u;s.point="B",s.title=i.fmtNum(f),s.color="#F44336",n[s.point]=a.priceSeries.createPriceLine(s),l.points.push(s.point),s.point="X",s.price=i.fmtNum(u-.5*f),s.title=i.fmtNum(-.5*f),s.color="#2196F3",n[s.point]=a.priceSeries.createPriceLine(s),s.point="Y",s.price=i.fmtNum(u-f),s.title=i.fmtNum(-f),s.color="#673AB7",n[s.point]=a.priceSeries.createPriceLine(s),s.point="Z",s.price=i.fmtNum(u-2*f),s.title=i.fmtNum(-2*f),s.color="#9C27B0",n[s.point]=a.priceSeries.createPriceLine(s),s.point="W",s.price=i.fmtNum(u-4*f),s.title=i.fmtNum(-4*f),s.color="#E91E63",n[s.point]=a.priceSeries.createPriceLine(s),b.value.classList.remove("selected")}else s.point="A",s.title="0",s.color="#FF9800",n[s.point]=a.priceSeries.createPriceLine(s),l.points.push(s.point);h.dispatch("tradingDerivative/drawTools",l)}function M(p){N(!1),K(p)}function K(p){let s={lineType:"target",lineWidth:1,lineStyle:1,draggable:!0};const l=p.A,u=p.B,f=u-l;s.point="A",s.price=l,s.title="0",s.color="#FF9800",n[s.point]=a.priceSeries.createPriceLine(s),s.point="B",s.price=u,s.title=i.fmtNum(f),s.color="#F44336",n[s.point]=a.priceSeries.createPriceLine(s),s.point="X",s.price=i.fmtNum(l-.5*f),s.title=i.fmtNum(-.5*f),s.color="#2196F3",n[s.point]=a.priceSeries.createPriceLine(s),s.point="Y",s.price=i.fmtNum(l-f),s.title=i.fmtNum(-f),s.color="#673AB7",n[s.point]=a.priceSeries.createPriceLine(s),s.point="Z",s.price=i.fmtNum(l-2*f),s.title=i.fmtNum(-2*f),s.color="#9C27B0",n[s.point]=a.priceSeries.createPriceLine(s),s.point="W",s.price=i.fmtNum(l-4*f),s.title=i.fmtNum(-4*f),s.color="#E91E63",n[s.point]=a.priceSeries.createPriceLine(s)}function N(p=!0){p&&h.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"target"}),i.isSet(n.A)&&(a.priceSeries.removePriceLine(n.A),i.isSet(n.B)&&(a.priceSeries.removePriceLine(n.B),a.priceSeries.removePriceLine(n.X),a.priceSeries.removePriceLine(n.Y),a.priceSeries.removePriceLine(n.Z),a.priceSeries.removePriceLine(n.W))),n={}}function D({lineOptions:p,newPrice:v}){if(i.isSet(n.B)){let s={isRemove:!1,name:"target",points:[],data:[]},l,u,f=+n.A.options().price,C=+n.B.options().price,y=C-f;if(l="A",p.point==="A")y=+n.B.options().title,C=f+y;else if(p.point!=="B"){let $=0;switch(p.point){case"X":$=1.5;break;case"Y":$=2;break;case"Z":$=3;break;case"W":$=5;break}y=i.fmtNum((C-v)/$),f=C-y,u={price:f},n[l].applyOptions(u)}s.points.push(l),s.data.push(f),l="B",u={price:C,title:i.fmtNum(y)},p.point===l&&delete u.price,n[l].applyOptions(u),s.points.push(l),s.data.push(C),l="X",u={price:i.fmtNum(f-.5*y),title:i.fmtNum(-.5*y)},p.point===l&&delete u.price,n[l].applyOptions(u),l="Y",u={price:i.fmtNum(f-y),title:i.fmtNum(-y)},p.point===l&&delete u.price,n[l].applyOptions(u),l="Z",u={price:i.fmtNum(f-2*y),title:i.fmtNum(-2*y)},p.point===l&&delete u.price,n[l].applyOptions(u),l="W",u={price:i.fmtNum(f-4*y),title:i.fmtNum(-4*y)},p.point===l&&delete u.price,n[l].applyOptions(u),h.dispatch("tradingDerivative/drawTools",s)}}return(p,v)=>(Q(),U("div",{ref_key:"targetToolRef",ref:b,class:"command",title:p.$t("trading.derivative.targetTool"),onClick:O,onContextmenu:J},vi,40,fi))}};const gi=["title"],Si=["title"],yi=["title"],Ti=["title"],xi=["title"],ki=["title"],Ci=["src"],je=3,qe=2,_i="wss://tradestation.fireant.vn/quote?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",wi="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",Pi={__name:"Chart",setup(A){const P={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.25,bottom:.25}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:1e3,minBarSpacing:.01,barSpacing:.05}},T=Le(new Date,"yyyy-MM-dd"),h={START:ie(new Date(`${T}T08:45:00Z`)),ATO:ie(new Date(`${T}T09:00:00Z`)),ATC:ie(new Date(`${T}T14:30:00Z`)),END:ie(new Date(`${T}T14:45:00Z`))},i=ge(),a=_t(),{t:g}=Ue(),b=he("devices"),n=he("mf"),m=he("filters"),O=E(null),J=E(null),V=E(null);E(null);const M=E(null),K=E(null),N=E(null),D=E(null),p=E(null),v=E(null),s=E(null),l=E(null),u=E(null),f=E(null),C=E(null),y=E(null),$=E(null);let e={chart:{},series:{},data:{whitespace:[],price:[]},tools:{pattern:{}},crosshair:{},interval:null,interval60:null,websocket:null,socketStop:!1,vpsUpdatedAt:Pt(new Date,61),isAutoOrdering:!1,currentSeconds:ie(Be(new Date,7))};ft();const r=kt({data:{whitespace:[],price:[]},series:{},chartDate:a.query.date??T,clock:Le(new Date,"HH:mm:ss"),isFullscreen:!1,isSocketWarning:!1,isOrderWarning:!1,lineColor:"#F44336",lineTitle:"",progress:{},scanSide:"left",showProgressContext:!1,showScanContext:!1,showLineContext:!1,showTradingView:!1,tradingViewStyle:{left:"32px"}}),S=ve(()=>i.state.tradingDerivative.status),d=ve(()=>i.state.tradingDerivative.config),R=ve(()=>i.state.tradingDerivative.tools),w=ve(()=>i.state.tradingDerivative.isLoading),k=ve(()=>S.value.position!==0||!!S.value.pending||!!R.value.order),x=ve(()=>`https://chart.vps.com.vn/tv/?u=${d.value.vpsUser}&s=${d.value.vpsSession}&symbol=VN30F1M&resolution=1&lang=vi`);ut(),e.interval=setInterval($e,1e3),e.interval60=setInterval(()=>{ye()?(Je(),d.value.autoRefresh&&refreshPatternTool(!0)):clearInterval(e.interval60)},6e4),We(()=>{e.chart=Ot(J.value,P),e.chart.subscribeCrosshairMove(re),e.chart.subscribeCustomPriceLineDragged(se),e.series.whitespace=e.chart.addHistogramSeries({priceScaleId:"whitespace",scaleMargins:{top:0,bottom:0},color:"#808080",lastValueVisible:!1,priceLineVisible:!1}),r.series.timeRange=e.chart.addHistogramSeries({priceScaleId:"timeRange",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),r.series.pickTime=e.chart.addHistogramSeries({priceScaleId:"pickTime",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),r.series.timeMark=e.chart.addHistogramSeries({priceScaleId:"timeMark",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),r.series.price=e.chart.addLineSeries({color:"#F5F5F5",priceFormat:{minMove:.1}}),new ResizeObserver(ee).observe(O.value),document.addEventListener("keydown",G)}),Qe(()=>{e.chart&&(e.chart.remove(),e.chart=null),document.removeEventListener("keydown",G),clearInterval(e.interval),clearInterval(e.interval60),Pe(),e.socketStop=!0}),ke(()=>i.state.tradingDerivative.chartData,oe),ke(R,te),ke(()=>r.progress,j),ke(()=>d.value.source,(t,c)=>c?me():null);function _(t){fe(),be(!1),f.value.isSelected()?f.value.draw({time:e.crosshair.time}):v.value.isSelected()?v.value.draw({time:e.crosshair.time,price:Re(e.crosshair.y)}):s.value.isSelected()?s.value.draw({time:e.crosshair.time}):p.value.isSelected()?p.value.draw({price:Re(e.crosshair.y)}):u.value.isSelected()?u.value.draw({time:e.crosshair.time}):l.value.isSelected()&&l.value.draw({price:Re(e.crosshair.y)})}function I(t){be(!0),t.preventDefault()}function Y(t){t.stopPropagation()}function X(t){t.preventDefault(),t.stopPropagation()}function re(t){if(t.time){let c=t.seriesPrices.get(r.series.price);e.crosshair.time=t.time,e.crosshair.price=c}else b.phone||(e.crosshair.time=null,e.crosshair.price=null);t.point!==void 0&&(e.crosshair.x=t.point.x,e.crosshair.y=t.point.y)}function se(t){let c=t.customPriceLine,o=c.options();o.price=n.fmtNum(o.price);const B=+t.fromPriceString,F=o.price;switch(o.lineType){case"order":if(F!==B){let W=!1;o.kind==="entry"?S.value.position||(W=!0,e.tools.order[o.kind].price=F,i.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"change",price:e.tools.order.entry.price}}).then(Z=>{Z.isOk?(de([o.kind]),ne.success(g("trading.derivative.changeEntrySuccess"))):(c.applyOptions({price:B}),ce(Z.message))})):(W=!0,e.tools.order[o.kind].price=F,o.kind==="tp"?i.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"change",price:e.tools.order.tp.price}}).then(Z=>{Z.isOk?(de([o.kind]),ne.success(g("trading.derivative.changeTpSuccess"))):(c.applyOptions({price:B}),ce(Z.message))}):i.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"change",price:e.tools.order.sl.price}}).then(Z=>{Z.isOk?(de([o.kind]),ne.success(g("trading.derivative.changeSlSuccess"))):(c.applyOptions({price:B}),ce(Z.message))})),W||(c.applyOptions({price:B}),ne.show(g("trading.derivative.noChangeOrderLine")))}break;case"line":p.value.drag({lineOptions:o,oldPrice:B,newPrice:F});break;case"target":l.value.drag({lineOptions:o,newPrice:F});break;case"pattern":v.value.drag({lineOptions:o});break}}function ee(){O.value&&(e.chart.resize(O.value.offsetWidth,O.value.offsetHeight),O.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function G(t){if(t.ctrlKey)switch(t.keyCode){case 219:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing-.01});break;case 221:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing+.01});break}if(t.altKey)switch(t.keyCode){case 219:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()-50);break;case 221:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()+50);break}}function oe(t){r.chartDate===T&&ye()||(t.price.length>0&&(e.data.whitespace=z(e.data.whitespace,H(r.chartDate)),r.data.whitespace=e.data.whitespace),e.series.whitespace.setData(e.data.whitespace),e.data.price=z(e.data.price,t.price),r.data.price=e.data.price,r.series.price.setData(e.data.price))}function q(t,c=null){const o=c??d.value.source;let B=[];t.forEach(F=>{let W,Z;o==="FireAnt"?(W=ie(Be(new Date(F.date),7)),Z=F.price):(W=ie(new Date(`${T}T${F.time}Z`)),Z=F.lastPrice),B.push({time:W,value:Z})}),B.length>1?(e.data.price=z(e.data.price,B),r.data.price=e.data.price,r.series.price.setData(e.data.price)):(e.data.price.push(B[0]),r.data.price=e.data.price,r.series.price.update(B[0]))}function H(t){const c=ie(new Date(`${t}T09:00:00Z`)),o=ie(new Date(`${t}T11:30:00Z`)),B=ie(new Date(`${t}T13:00:00Z`)),F=ie(new Date(`${t}T14:30:00Z`)),W=ie(new Date(`${t}T14:00:00Z`));let Z=[];for(let pe=c;pe<=F;pe++){if(pe>o&&pe<B)continue;let Oe={time:pe};(pe===W||pe===F)&&(Oe.value=1),Z.push(Oe)}return Z}function z(t,c){return Array.from(new Map([...t,...c].sort((o,B)=>o.time-B.time).map(o=>[o.time,o])).values())}function te(t){nt(),Object.entries(t).forEach(([c,o])=>{switch(c){case"order":we(o);break;case"pattern":rt(o)&&v.value.load(n.cloneDeep(o));break;case"tr":u.value.load(o);break;case"0_pt":s.value.load(o[0]);break;case"line":p.value.load(o);break;case"target":l.value.load(o);break}})}function j(t,c){if(d.value.autoRefresh&&(t.step>c.step||t.step===c.step&&t.result>c.result)){let o="";t.result?[2,4,5].includes(t.step)?o=g("trading.derivative.progressOrder",t):o=g("trading.derivative.progressSuccess",t):o=g("trading.derivative.progressFail",t),_e(o)}}function _e(t){const c=new SpeechSynthesisUtterance(t);c.lang="vi-VN",speechSynthesis.speak(c)}async function me(){if(ye()){await Pe();const t=d.value.source==="FireAnt",c=t?_i:wi;e.websocket=new WebSocket(c),e.websocket.onclose=o=>{e.socketStop||(r.isSocketWarning=!0,me())},t?Me():(Ae(),Se())}}async function Pe(){e.websocket&&e.websocket.readyState===WebSocket.OPEN&&(e.websocket.close(),await new Promise(t=>{const c=setInterval(()=>{(!e.websocket||e.websocket.readyState===WebSocket.CLOSED)&&(e.websocket=null,clearInterval(c),t())},100)}))}function Me(){i.dispatch("tradingDerivative/setLoading",!0),e.websocket.onopen=t=>{if(e.websocket.readyState===WebSocket.OPEN){let c='{"protocol":"json","version":1}';e.websocket.send(c),c='{"arguments":["VN30F1M"],"invocationId":"0","target":"SubscribeTrades","type":1}',e.websocket.send(c)}},e.websocket.onmessage=t=>{r.isSocketWarning=!1,Ee(t.data).forEach(o=>{if(!o)return!1;o.type===3?(o.result[0].date.slice(0,10)===T&&(De(),e.data.whitespace=z(e.data.whitespace,H(T)),r.data.whitespace=e.data.whitespace,e.series.whitespace.setData(e.data.whitespace),q(o.result)),i.dispatch("tradingDerivative/setLoading",!1)):o.type===1&&o.target==="UpdateTrades"&&o.arguments[0]==="VN30F1M"&&(console.log("FireAnt",o.arguments[1]),Ye(o.arguments[1].at(-1).price),q(o.arguments[1]))})}}function Ee(t){let c=[];return t.split("").forEach(o=>{const B=o.indexOf("{"),F=o.lastIndexOf("}");let W=null;if(B!==-1&&F!==-1&&F>B){const Z=o.substring(B,F+1);Z!=="{}"&&(W=JSON.parse(Z))}c.push(W)}),c}function Se(){e.websocket.onopen=t=>{if(e.websocket.readyState===WebSocket.OPEN){const c={action:"join",list:d.value.vn30f1m},o=`42${JSON.stringify(["regs",JSON.stringify(c)])}`;e.websocket.send(o)}},e.websocket.onmessage=t=>{if(r.isSocketWarning=!1,t.data.substr(0,1)==="4"&&t.data.substr(1,1)==="2"){const c=JSON.parse(t.data.substr(2));if(c[0]==="stockps"){const o=c[1].data;o.id===3220&&(console.log("VPS",o),Ye(o.lastPrice),q([o]))}}}}function Ae(){wt(new Date,new Date(e.vpsUpdatedAt))>60&&(fetch("https://bddatafeed.vps.com.vn/getpschartintraday/VN30F1M").then(t=>t.json()).then(t=>{console.log(t),q(t,"VPS")}),e.vpsUpdatedAt=new Date)}function $e(){e.currentSeconds=ie(Be(new Date,7)),ye()&&(S.value.position&&e.currentSeconds>h.ATC-5*60&&(r.isOrderWarning=!0,e.currentSeconds>h.ATC-15&&n.isSet(e.tools.order.tp.line)&&i.dispatch("tradingDerivative/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(t=>{t.isOk?(ue(["entry","tp","sl"]),ne.success(g("trading.derivative.autoCancelTpSlSuccess"))):ce(t.message)})),d.value.openingMarket&&e.currentSeconds===h.START&&me()),r.clock=Le(new Date,"HH:mm:ss")}function de(t){const c="order";let o={isRemove:!1,name:c,points:[],data:[]},B,F;t.forEach(W=>{const Z=e.tools.order.entry.price,pe=e.tools.order.tp.price,Oe=e.tools.order.sl.price;switch(W){case"entry":B="yellow",F=e.tools.order.side>0?"LONG":"SHORT";break;case"tp":B="lime",F=n.fmtNum(pe-Z,1,!0);break;case"sl":B="red",F=n.fmtNum(Oe-Z,1,!0);break}if(o.points.push(W),n.isSet(e.tools.order[W].line))e.tools.order[W].line.applyOptions({price:e.tools.order[W].price,title:F}),o.data.push(e.tools.order[W].line.options());else{const He={lineType:c,kind:W,side:e.tools.order.side,price:e.tools.order[W].price,color:B,lineWidth:1,lineStyle:0,title:F,draggable:!0};e.tools.order[W].line=r.series.price.createPriceLine(He),o.data.push(He)}}),i.dispatch("tradingDerivative/drawTools",o)}function we(t){Object.entries(t).forEach(([c,o])=>{e.tools.order.side=o.side,e.tools.order[c].price=o.price,e.tools.order[c].line=r.series.price.createPriceLine(o)})}function ue(t,c=!0){c&&i.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"order"}),t.forEach(o=>{n.isSet(e.tools.order[o].line)&&(r.series.price.removePriceLine(e.tools.order[o].line),delete e.tools.order[o].line)})}function tt(t){r.showTradingView=!r.showTradingView,t.stopPropagation()}function Ze(){v.value.refresh()}function it(t){console.log("scaned",t),v.value.load(t,!0)}function fe(){D.value.hide(),f.value.hide(),p.value.hide()}function rt({A:{time:t}}){return e.data.whitespace.some(c=>c.time===t)}function st(t){D.value.set(t)}function nt(){ue(["entry","tp","sl"],!1)}function be(t){if(t){if(ye()&&(n.isSet(e.tools.order.tp.line)||S.value.position&&e.currentSeconds>h.ATO&&e.currentSeconds<h.ATC&&($.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-61?-61:1))+"px",$.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-51?-51:1))+"px",$.value.style.display="block"),!n.isSet(e.tools.order.entry.line))){let c=null,o=0;S.value.position?(e.currentSeconds<h.ATO?c="ATO":e.currentSeconds>h.ATC&&(c="ATC"),c&&(e.tools.order.entry.price=c,o=-S.value.position)):e.currentSeconds>h.ATO&&e.currentSeconds<h.ATC&&(c=Re(e.crosshair.y),o=c>=e.data.price.at(-1).value?1:-1,e.tools.order.side=o,e.tools.order.entry.price=c),o&&(y.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-71?-71:1))+"px",y.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-61?-61:1))+"px",y.value.style.background=o>0?"green":"red",y.value.innerText=`${o>0?"LONG":"SHORT"} ${c}`,y.value.style.display="block")}}else y.value.style.display="none",$.value.style.display="none"}function ot(){ye()&&(e.currentSeconds<h.ATO?ze(g("trading.derivative.atoOrder"),g("titles.confirm")).then(c=>{c&&i.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(o=>{o.isOk?ne.success(g("trading.derivative.atoOrderSuccess")):ce(o.message)})}):e.currentSeconds<h.ATC?i.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"new",side:e.tools.order.side,price:e.tools.order.entry.price}}).then(t=>{t.isOk?(de(["entry"]),ne.success(g("trading.derivative.newEntrySuccess"))):ce(t.message)}):ze(g("trading.derivative.atcOrder"),g("titles.confirm")).then(c=>{c&&i.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(o=>{o.isOk?ne.success(g("trading.derivative.atcOrderSuccess")):ce(o.message)})}))}function at(){e.tools.order.tp.price=e.tools.order.entry.price+e.tools.order.side*je,e.tools.order.sl.price=e.tools.order.entry.price-e.tools.order.side*qe,i.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.tools.order.tp.price},slData:{cmd:"new",price:e.tools.order.sl.price}}).then(t=>{t.isOk?(e.tools.order.entry.line.applyOptions({draggable:!1}),de(["entry","tp","sl"]),ne.success(g("trading.derivative.newTpSlSuccess"))):ce(t.message)})}function ct(){n.isSet(e.tools.order.entry.line)?n.isSet(e.tools.order.tp.line)?i.dispatch("tradingDerivative/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(t=>{t.isOk?(ue(["entry","tp","sl"]),ne.success(g("trading.derivative.exitSuccess"))):ce(t.message)}):i.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"delete"}}).then(t=>{t.isOk?(ue(["entry"]),ne.success(g("trading.derivative.deleteEntrySuccess"))):ce(t.message)}):De()}function Ye(t){n.isSet(e.tools.order.entry.line)&&(n.isSet(e.tools.order.tp.line)?((e.tools.order.side>0&&t>=e.tools.order.tp.price||e.tools.order.side<0&&t<=e.tools.order.tp.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,i.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"delete"}}).then(c=>{c.isOk?(ue(["entry","tp","sl"]),ne.success(g("trading.derivative.deleteTpSuccess")),be(!1)):ce(c.message),e.isAutoOrdering=!1}))),(e.tools.order.side>0&&t<=e.tools.order.sl.price||e.tools.order.side<0&&t>=e.tools.order.sl.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,i.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"cancel"}}).then(c=>{c.isOk?(ue(["entry","tp","sl"]),ne.success(g("trading.derivative.deleteSlSuccess")),be(!1)):ce(c.message),e.isAutoOrdering=!1})))):(e.tools.order.side>0&&t>=e.tools.order.entry.price||e.tools.order.side<0&&t<=e.tools.order.entry.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,setTimeout(()=>{e.tools.order.tp.price=e.tools.order.entry.price+e.tools.order.side*je,e.tools.order.sl.price=e.tools.order.entry.price-e.tools.order.side*qe,i.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.tools.order.tp.price},slData:{cmd:"new",price:e.tools.order.sl.price}}).then(c=>{c.isOk?(e.tools.order.entry.line.applyOptions({draggable:!1}),de(["entry","tp","sl"]),ne.success(g("trading.derivative.autoNewTpSlSuccess"))):ce(c.message),e.isAutoOrdering=!1})},1e3))))}function lt(){e.chart.timeScale().scrollToRealTime()}function ye(){return d.value.openingMarket&&e.currentSeconds>=h.START&&e.currentSeconds<=h.END}function dt(){if(!r.chartDate)return!1;Ne()}function pt(){e.data.whitespace=[],e.data.price=[],r.data.whitespace=e.data.whitespace,r.data.price=e.data.price,me(),Ne()}function ut(){i.dispatch("tradingDerivative/initChart").then(()=>{me(),!a.query.date&&d.value.lastOpeningDate&&(r.chartDate=d.value.lastOpeningDate),Ne()})}function Ne(){i.dispatch("tradingDerivative/getChartData",r.chartDate).then(t=>{t&&De()})}function Je(){i.dispatch("tradingDerivative/getStatus")}function De(){i.dispatch("tradingDerivative/getTools")}function ft(t){t||(t=["order","lines","tr","pattern","target","pt"]),t.includes("order")&&(e.tools.order={side:0,entry:{},tp:{},sl:{}}),t.includes("lines")&&(e.tools.lines=[]),t.includes("target")&&(e.tools.target={}),t.includes("tr")&&(e.tools.timeRange=[]),t.includes("pattern")&&(e.tools.pattern.lines={}),t.includes("pt")&&(e.tools.pickTime=null)}function mt(){i.dispatch("tradingDerivative/getAccountInfo").then(t=>{let c="";c+='<div style="width: 200px;">',c+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${g("trading.derivative.nav")}</div><div>: ${m.currency(t.nav)}</div></div>`,c+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${g("trading.derivative.maxVol")}</div><div>: ${m.numberVnFormat(t.maxVol)}</div></div>`,c+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${g("trading.derivative.vm")}</div><div>: ${m.currency(t.vm)}</div></div>`,c+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${g("trading.derivative.fee")}</div><div>: ${m.currency(t.fee)}</div></div>`,c+="</div>",bt(c,g("trading.derivative.accountInfo"))})}function Re(t){return n.fmtNum(r.series.price.coordinateToPrice(t))}function ce(t){t||(t="unknown"),ne.error(g(`trading.derivative.${t}`))}function Ie(t){let c=e.data.whitespace.findIndex(o=>o.time===t);if(c===-1){const o=Le(new Date(t*1e3),"yyyy-MM-dd"),B=ie(new Date(`${o}T11:30:00Z`)),F=ie(new Date(`${o}T13:00:00Z`)),W=ie(new Date(`${o}T14:30:00Z`));t>B&&t<F?t=B:t>W&&(t=W),c=e.data.whitespace.findIndex(Z=>Z.time===t)}return c}function Xe(t){return t<e.data.whitespace.length?e.data.whitespace[t].time:!1}return(t,c)=>(Q(),U("div",{class:"derivative-chart",ref_key:"chartContainerRef",ref:O,onClick:_,onContextmenu:I},[L("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:J},[L("div",{class:"area data-area",onClick:Y,onContextmenu:X},[L("div",{ref_key:"connectionRef",ref:V,class:le(["command",{yellow:S.value.pending,red:d.value.volInValid}]),title:t.$t("trading.derivative.connection"),onClick:Je},[L("i",{class:le(["far",{"fa-link-simple":S.value.connection,"fa-link-simple-slash":!S.value.connection,blink:r.isSocketWarning}])},null,2)],10,gi),L("div",{class:le(["command status",{green:S.value.position>0,red:S.value.position<0}]),title:t.$t("trading.derivative.position"),onClick:mt},Te(S.value.position),11,Si),L("div",{class:"command clock",onClick:me},Te(r.clock),1),xe(L("input",{type:"date",class:"chart-date command",title:t.$t("trading.derivative.date"),"onUpdate:modelValue":c[0]||(c[0]=o=>r.chartDate=o),onChange:dt},null,40,yi),[[Ct,r.chartDate]]),L("div",{ref_key:"reloadToolRef",ref:K,class:"command",title:t.$t("trading.derivative.reload"),onClick:pt,onContextmenu:De},[L("i",{class:le(["far fa-sync-alt",{"fa-spin":w.value}])},null,2)],40,Ti)],32),L("div",{class:"area tool-area",onClick:Y,onContextmenu:X},[ae(At,{chartContainerRef:O.value},null,8,["chartContainerRef"]),L("div",{ref_key:"tradingviewRef",ref:N,class:"command far fa-chart-candlestick",title:t.$t("trading.derivative.tradingview"),onClick:tt},null,8,xi),ae(Wt,{ref_key:"progressToolRef",ref:D,onRefreshPattern:Ze,onHideContext:fe},null,512),ae(Xt,{ref_key:"scanToolRef",ref:f,prices:r.data.price,timeToIndex:Ie,onScaned:it,onRemovePattern:c[1]||(c[1]=()=>v.value.remove()),onHideContext:fe},null,8,["prices"]),ae(qt,{ref_key:"patternToolRef",ref:v,prices:r.data.price,priceSeries:r.series.price,timeMarkSeries:r.series.timeMark,pickTimeToolRef:s.value,timeToIndex:Ie,indexToTime:Xe,onSetProgress:st,onHideContext:fe},null,8,["prices","priceSeries","timeMarkSeries","pickTimeToolRef"]),ae(Kt,{ref_key:"pickTimeToolRef",ref:s,pickTimeSeries:r.series.pickTime,onRefreshPattern:Ze,onHideContext:fe},null,8,["pickTimeSeries"]),ae(ci,{ref_key:"lineToolRef",ref:p,priceSeries:r.series.price,onHideContext:fe},null,8,["priceSeries"]),ae(ui,{ref_key:"timeRangeToolRef",ref:u,timeRangeSeries:r.series.timeRange,timeToIndex:Ie,indexToTime:Xe,onHideContext:fe},null,8,["timeRangeSeries"]),ae(hi,{ref_key:"targetToolRef",ref:l,priceSeries:r.series.price,onHideContext:fe},null,8,["priceSeries"]),xe(L("div",{ref_key:"cancelOrderRef",ref:C,class:"cancel-order command",title:t.$t("trading.derivative.cancelTool"),onClick:ct},[L("i",{class:le(["far fa-trash-alt",{blink:r.isOrderWarning}])},null,2)],8,ki),[[Ce,k.value]])],32),L("div",null,[L("div",{ref_key:"entryOrderRef",ref:y,class:"order-button entry",onClick:ot}," Entry ",512),L("div",{ref_key:"tpslOrderRef",ref:$,class:"order-button tpsl",onClick:at}," TP/SL ",512),L("div",{class:"chart-top command far fa-angle-double-right",onClick:lt})]),xe(L("iframe",{ref_key:"tradingviewChartRef",ref:M,class:"tradingview-chart",style:Ke(r.tradingViewStyle),src:x.value},null,12,Ci),[[Ce,r.showTradingView]])],512)],544))}};export{Pi as default};
