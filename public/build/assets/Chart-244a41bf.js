import{z as pt,A as dt,B as ut,r as N,y as Ye,C as et,o as H,b as J,d as B,E as ae,c as ce,G as Te,H as be,I as ft,J as mt,m as tt,e as ee,F as We,K as Ze,t as ye,h as me,u as Oe,k as fe,L as vt,M as ht,N as Ue,O as it,g as nt,w as ve,Q as gt,R as St,S as Qe,x as se,l as Le,a as yt,T as Me,U as Tt,j as xt,V as Ct}from"./app-75e467ca.js";import{_ as kt}from"./text-box-5db9d2a8.js";import{g as G}from"./getUnixTime-15530c67.js";import{c as _t}from"./lightweight-charts.esm.development-03366bac.js";function rt(L,I,x){return pt((x==null?void 0:x.in)||L,+dt(L)+I)}function _e(L,I,x){return rt(L,I*ut,x)}function bt(L,I,x){return rt(L,I*1e3,x)}function Ve(L,I,x){return bt(L,-I,x)}const wt=["title"],Dt={__name:"FullscreenTool",props:["chartContainerRef"],setup(L){const I=L,x=N(!1);Ye(()=>{document.addEventListener("fullscreenchange",t)}),et(()=>{document.removeEventListener("fullscreenchange",t)});function m(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function t(){I.chartContainerRef&&(document.fullscreenElement?(x.value=!0,I.chartContainerRef.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(x.value=!1,I.chartContainerRef.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}return(r,T)=>(H(),J("div",{class:"command",title:r.$t("trading.derivative.fullscreen"),onClick:m},[B("i",{class:ae(["far",{"fa-compress":x.value,"fa-expand":!x.value}])},null,2)],8,wt))}},Rt=["title"],Et=["src"],Lt={__name:"TradingviewTool",props:["vpsUser","vpsSession","chartContainerRef"],setup(L){const I=L,x=N(null),m=N(!1),t=ce(()=>`https://chart.vps.com.vn/tv/?u=${I.vpsUser}&s=${I.vpsSession}&symbol=VN30F1M&resolution=1&lang=vi`);function r(y){m.value=!m.value,T(),y.stopPropagation()}function T(){if(I.chartContainerRef&&x.value){const{offsetWidth:y,offsetHeight:O}=I.chartContainerRef,{top:f,left:h}=x.value.getBoundingClientRect();x.value.style.top=`${f-2}px`,x.value.style.left=`${h+32}px`,x.value.style.width=`${y-34}px`,x.value.style.height=`${O}px`}}return(y,O)=>(H(),J("div",{class:"tradingview command far fa-chart-candlestick",title:y.$t("trading.derivative.tradingview"),onClick:r},[Te(B("iframe",{ref_key:"tradingviewRef",ref:x,class:"chart",src:t.value},null,8,Et),[[be,m.value]])],8,Rt))}};const Ot=B("div",{class:"triangle-shadow"},null,-1),Pt=B("div",{class:"triangle"},null,-1),$t={class:"container"},It={__name:"ProgressContext",props:["progress"],emits:["refreshPattern"],setup(L,{emit:I}){const x=I,m=N([]);Ye(()=>{t()});function t(){ft(Object.assign({"../../../../../lang/vi/derivative.js":()=>mt(()=>import("./derivative-0a1a41d1.js"),[])}),`../../../../../lang/${window.lang}/derivative.js`).then(y=>{m.value=y.default||[]})}function r(){x("refreshPattern")}function T(y){y.stopPropagation()}return(y,O)=>{const f=tt("DxButton");return H(),J("div",{class:"pattern-context",onClick:T},[Ot,Pt,B("div",null,[ee(f,{icon:"refresh",type:"success",text:y.$t("trading.derivative.progressContext.refreshPattern"),onClick:r},null,8,["text"])]),B("div",$t,[(H(!0),J(We,null,Ze(m.value,(h,d)=>(H(),J("div",{key:d,class:ae(["step",[L.progress.step&&L.progress.step===d+1?L.progress.result?"success":"fail":""]])},[B("div",{class:ae(["name",[L.progress.steps?L.progress.steps[d].every(Boolean)?"success":"fail":""]])},ye(d+1)+". "+ye(h.name),3),B("div",null,[(H(!0),J(We,null,Ze(h.conds,(V,F)=>(H(),J("div",{key:F,class:ae(["condition",[L.progress.steps?L.progress.steps[d][F]?"success":"fail":""]])},ye(F+1)+". "+ye(V),3))),128))])],2))),128))])])}}},At=["title"],Nt={__name:"ProgressTool",props:[],emits:["refreshPattern","hideContext"],setup(L,{expose:I,emit:x}){const m=me(),{t}=Oe(),r=fe("mf"),T=x,y=N({}),O=N(!1),f=ce(()=>m.state.tradingDerivative.config.autoRefresh);I({hide:d,set:V});function h(){const p=O.value;T("hideContext"),O.value=!p,O.value&&F()}function d(p){O.value=p}function V(p){f.value&&W(p,y.value),y.value=p}function F(){T("refreshPattern")}function Z(p){const s=p??!s.value;m.dispatch("tradingDerivative/setAutoRefresh",s)}function W(p,s){if(r.isSet(p)&&(p.step!==s.step||p.step===s.step&&p.result!==s.result)){let g="";p.result?[2,4].includes(p.step)?g=t("trading.derivative.progressOrder",p):g=t("trading.derivative.progressSuccess",p):g=t("trading.derivative.progressFail",p),A(g)}}function A(p){const s=new SpeechSynthesisUtterance(p);s.lang="vi-VN",speechSynthesis.speak(s)}return(p,s)=>(H(),J("div",{class:ae(["context command",{green:y.value.result===!0,red:y.value.result===!1}]),title:p.$t("trading.derivative.progressTool"),onClick:h,onContextmenu:Z},[B("i",{class:ae(["far",{"fa-badge-check":!y.value.step,[`fa-circle-${y.value.step}`]:y.value.step,blink:f.value}])},null,2),Te(ee(It,{class:"contextmenu",progress:y.value,onRefreshPattern:F},null,8,["progress"]),[[be,O.value]])],42,At))}};var xe={};const Bt=vt(ht);/*!
 * devextreme-vue
 * Version: 22.2.12
 * Build date: Mon Apr 29 2024
 *
 * Copyright (c) 2012 - 2024 Developer Express Inc. ALL RIGHTS RESERVED
 *
 * This software may be modified and distributed under the terms
 * of the MIT license. See the LICENSE file in the root of the project for details.
 *
 * https://github.com/DevExpress/devextreme-vue
 */var Ft=Ue&&Ue.__importDefault||function(L){return L&&L.__esModule?L:{default:L}};Object.defineProperty(xe,"__esModule",{value:!0});xe.DxItem=xe.DxButtonGroup=void 0;var Mt=Ft(Bt),Vt=it,Wt=it,st=Vt.createComponent({props:{accessKey:String,activeStateEnabled:Boolean,buttonTemplate:{},disabled:Boolean,elementAttr:Object,focusStateEnabled:Boolean,height:[Function,Number,String],hint:String,hoverStateEnabled:Boolean,items:Array,keyExpr:[Function,String],onContentReady:Function,onDisposing:Function,onInitialized:Function,onItemClick:Function,onOptionChanged:Function,onSelectionChanged:Function,rtlEnabled:Boolean,selectedItemKeys:Array,selectedItems:Array,selectionMode:String,stylingMode:String,tabIndex:Number,visible:Boolean,width:[Function,Number,String]},emits:{"update:isActive":null,"update:hoveredElement":null,"update:accessKey":null,"update:activeStateEnabled":null,"update:buttonTemplate":null,"update:disabled":null,"update:elementAttr":null,"update:focusStateEnabled":null,"update:height":null,"update:hint":null,"update:hoverStateEnabled":null,"update:items":null,"update:keyExpr":null,"update:onContentReady":null,"update:onDisposing":null,"update:onInitialized":null,"update:onItemClick":null,"update:onOptionChanged":null,"update:onSelectionChanged":null,"update:rtlEnabled":null,"update:selectedItemKeys":null,"update:selectedItems":null,"update:selectionMode":null,"update:stylingMode":null,"update:tabIndex":null,"update:visible":null,"update:width":null},computed:{instance:function(){return this.$_instance}},beforeCreate:function(){this.$_WidgetClass=Mt.default,this.$_hasAsyncTemplate=!0,this.$_expectedChildren={item:{isCollectionItem:!0,optionName:"items"}}}});xe.DxButtonGroup=st;var ze=Wt.createConfigurationComponent({emits:{"update:isActive":null,"update:hoveredElement":null,"update:disabled":null,"update:elementAttr":null,"update:hint":null,"update:html":null,"update:icon":null,"update:template":null,"update:text":null,"update:type":null,"update:visible":null},props:{disabled:Boolean,elementAttr:Object,hint:String,html:String,icon:String,template:{},text:String,type:String,visible:Boolean}});xe.DxItem=ze;ze.$_optionName="items";ze.$_isCollectionItem=!0;var Zt=xe.default=st;const Yt=B("div",{class:"triangle-shadow"},null,-1),zt=B("div",{class:"triangle"},null,-1),Ht={__name:"ScanContext",props:["modelValue"],emits:["update:modelValue"],setup(L,{emit:I}){const{t:x}=Oe(),m=[{icon:"chevrondoubleleft",side:"left",text:x("trading.derivative.scanContext.leftScan")},{icon:"chevrondoubleright",side:"right",text:x("trading.derivative.scanContext.rightScan")}],t=L,r=I;function T({itemData:{side:O}}){r("update:modelValue",O)}function y(O){O.stopPropagation()}return(O,f)=>(H(),J("div",{class:"scan-context",onClick:y},[Yt,zt,ee(nt(Zt),{items:m,"selected-item-keys":[t.modelValue],"key-expr":"side","styling-mode":"outlined",onItemClick:T},null,8,["selected-item-keys"])]))}},Jt=["title"],Xt={__name:"ScanTool",props:["prices","timeToIndex"],emits:["scaned","removePattern","hideContext"],setup(L,{expose:I,emit:x}){const m=fe("mf"),t=L,r=x,T=N(null),y=N(!1),O=N("left");I({isSelected:f,hide:h,draw:F});function f(){return T.value.classList.contains("selected")}function h(p){y.value=p}function d(p){r("hideContext");const s=p.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(g=>g.classList.remove("selected")),s||(p.target.classList.add("selected"),r("removePattern"))}function V(){const p=y.value;r("hideContext"),y.value=!p}function F({time:p}){const s=O.value==="left",g=p?t.prices.filter(a=>!m.cmp(a.time,s,p)):t.prices;let i=s?Z(g):W(g);m.isSet(i)&&r("scaned",A(i)),T.value.classList.remove("selected")}function Z(p){let s,[g,i,a,S]=Array(4).fill({});for(let v=p.length-1;v>=0;v--){const k=p[v].value,C=p[v].time,e=t.timeToIndex(C);if(e===-1)break;if(v===p.length-1&&(a={index:e,time:C,price:k},[i,g,S]=Array(3).fill(null).map(()=>m.cloneDeep(a))),s===void 0){if(k===a.price)continue;s=k>a.price}if(m.cmp(k,s,i.price)&&(m.cmp(g.price,!s,a.price)?([a,i]=[i,g].map(u=>m.cloneDeep(u)),g={index:e,time:C,price:k},S=m.cloneDeep(g),s=!s):i={index:e,time:C,price:k}),m.cmp(k,!s,g.price)?(g={index:e,time:C,price:k},S=m.cloneDeep(g)):S.index=e,m.cmp(k,s,S.price)&&(S={index:e,time:C,price:k}),a.index>g.index){const u=m.fmtNum(i.price-a.price,1,!0);if(u>=1&&(g.index-S.index>a.index-i.index||m.fmtNum(g.price-S.price,1,!0)>u))break}}return{A:g,B:i,C:a}}function W(p){let s,[g,i,a]=Array(3).fill({});for(let S=0;S<p.length;S++){const v=p[S].value,k=p[S].time,C=t.timeToIndex(k);if(C===-1)break;if(S===0&&(g={index:C,time:k,price:v},i=m.cloneDeep(g),a=m.cloneDeep(g)),s===void 0){if(v===g.price)continue;s=v>g.price}m.cmp(v,s,i.price)&&(i={index:C,time:k,price:v},a=m.cloneDeep(i)),m.cmp(i.price,s,g.price)&&m.cmp(v,!s,a.price)&&(m.cmp(v,s,g.price)?a={index:C,time:k,price:v}:(g=m.cloneDeep(i),i={index:C,time:k,price:v},a=m.cloneDeep(i),s=!s))}return{A:g,B:i,C:a}}function A(p){const s={};return Object.entries(p).forEach(([g,i])=>{const{index:a,...S}=i;s[g]=S}),s}return(p,s)=>(H(),J("div",{ref_key:"scanToolRef",ref:T,class:"context command",title:p.$t("trading.derivative.scanTool"),onClick:d,onContextmenu:V},[B("i",{class:ae(["far",{[`fa-angles-${O.value}`]:!0}])},null,2),Te(ee(Ht,{class:"contextmenu",modelValue:O.value,"onUpdate:modelValue":s[0]||(s[0]=g=>O.value=g)},null,8,["modelValue"]),[[be,y.value]])],40,Jt))}},jt=["title"],qt=B("i",{class:"far fa-heart-rate"},null,-1),Ut=[qt],Qt={__name:"PatternTool",props:["prices","priceSeries","timeMarkSeries","pickTimeToolRef","timeToIndex","indexToTime"],emits:["setProgress","hideContext"],setup(L,{expose:I,emit:x}){const m=me(),t=fe("mf"),r=L,T=x,y=N(null),O=ce(()=>m.state.tradingDerivative.tools.pattern);let f={},h={};I({isSelected:d,draw:Z,load:W,refresh:p,remove:k,drag:u}),ve(O,c=>{c&&W(c,{isCheck:!0})});function d(){return y.value.classList.contains("selected")}function V(c){T("hideContext");const n=c.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(_=>_.classList.remove("selected")),n||(c.target.classList.add("selected"),r.pickTimeToolRef.remove())}function F(c){c.target.classList.remove("selected"),k()}function Z({time:c,price:n}){let l={lineType:"pattern",price:n,lineWidth:1,lineStyle:1,draggable:!0};if(t.isSet(h.A))if(t.isSet(h.B)){let $,w;if(t.isSet(h.C)){let R,b;f.A={time:c,price:n};const{progress:P,timeMark:M,info:{rEpr1:X,rEpr2:U,rEpr3:re,entry:te,pStatus:ie,x:ne,X:j,y:Q,Y}}=s();w=P,$=M,R="A",b={price:n,title:`A ${X}`},h[R].applyOptions(b),R="B",b={title:`B ${U}`},h[R].applyOptions(b),R="C",b={title:`C ${re}`},h[R].applyOptions(b),R="D",b={price:te,title:"Entry "+ie},h[R].applyOptions(b),R="X",b={price:t.fmtNum(ne),title:`X ${t.fmtNum(j)}`},h[R].applyOptions(b),R="Y",b={price:t.fmtNum(Q),title:`Y ${t.fmtNum(Y)}`},h[R].applyOptions(b)}else{f.C={price:n};const{progress:R,timeMark:b,info:{rEpr1:P,rEpr2:M,rEpr3:X,entry:U,pStatus:re,x:te,X:ie,y:ne,Y:j}}=s();w=R,$=b;let Q="A";h[Q].applyOptions({title:`A ${P}`}),Q="B",h[Q].applyOptions({title:`B ${M}`}),l.point="C",l.title=`C ${X}`,l.color="#FFEB3B",h[l.point]=r.priceSeries.createPriceLine(l),l.point="D",l.price=U,l.title="Entry "+re,l.color="#9C27B0",l.draggable=!1,h[l.point]=r.priceSeries.createPriceLine(l),l.point="Y",l.price=t.fmtNum(ne),l.title=`Y ${t.fmtNum(j)}`,l.color="#E91E63",l.draggable=!1,h[l.point]=r.priceSeries.createPriceLine(l),l.point="X",l.price=t.fmtNum(te),l.title=`X ${t.fmtNum(ie)}`,l.color="#2196F3",l.draggable=!1,h[l.point]=r.priceSeries.createPriceLine(l)}v(),T("setProgress",w),e($),y.value.classList.remove("selected")}else l.point="B",l.title="B 0",l.color="#4CAF50",h[l.point]=r.priceSeries.createPriceLine(l),f.B={price:n};else l.point="A",l.title="A 0",l.color="#F44336",h[l.point]=r.priceSeries.createPriceLine(l),f={A:{time:c,price:n}}}function W(c,{isSave:n=!1,isCheck:_=!1}){f=t.cloneDeep(c),n&&v(),(_?i(f):!0)&&(C(),A())}function A(){let n={lineType:"pattern",lineWidth:1,lineStyle:1,draggable:!0};const{A:_,B:l,C:$}=f,{progress:w,timeMark:R,info:{rEpr1:b,rEpr2:P,rEpr3:M,entry:X,pStatus:U,x:re,X:te,y:ie,Y:ne}}=s();T("setProgress",w),e(R),n.point="A",n.title=`A ${b}`,n.color="#F44336",n.price=_.price,h[n.point]=r.priceSeries.createPriceLine(n),n.point="B",n.title=`B ${P}`,n.color="#4CAF50",n.price=l.price,h[n.point]=r.priceSeries.createPriceLine(n),n.point="C",n.price=$.price,n.title=`C ${M}`,n.color="#FFEB3B",h[n.point]=r.priceSeries.createPriceLine(n),n.point="D",n.price=X,n.title="Entry "+U,n.color="#9C27B0",n.draggable=!1,h[n.point]=r.priceSeries.createPriceLine(n),n.point="Y",n.price=t.fmtNum(ie),n.title=`Y ${t.fmtNum(ne)}`,n.color="#E91E63",n.draggable=!1,h[n.point]=r.priceSeries.createPriceLine(n),n.point="X",n.price=t.fmtNum(re),n.title=`X ${t.fmtNum(te)}`,n.color="#2196F3",n.draggable=!1,h[n.point]=r.priceSeries.createPriceLine(n)}function p(c=!1){t.isSet(h.C)&&(c&&S(),C(),A())}function s(){const{A:c,B:n,C:_}=f,l=n.price-_.price,$=l>0,w=g({phase:1,start:c,end:n,retracementPrice:_.price});let R=g({phase:2,start:w.R,end:_});const b=g({phase:3,start:R.R,end:{price:n.price+($?1:-1)*w.rEp},breakPrices:[R.S1.price,n.price]});w.xBox.tr>=R.tr&&(R.tr=w.xBox.tr),console.log("calculatePattern",[w,R,b]);const P=t.fmtNum(l,1,!0)>=w.pr,M=t.fmtNum(_.price-b.xBox.R.price,1,!0)>=R.pr,X=t.fmtNum(b.xBox.pr)>=b.pr,U=!t.cmp(_.price,!$,w.S1.price),re=!t.cmp(b.xBox.R.price,$,R.S1.price),te=!t.cmp(b.xBox.S.price,!$,b.S1.price),ie=w.R.index+w.tr,ne=w.R.index+5*w.tr,j=R.R.index+R.tr,Q=b.xBox.R.index+b.tr,Y=b.xBox.R.index+5*b.tr,oe=b.xBox.R.index+R.tr,Pe=[ie,ne,j,Q,Y,oe],le=b.xBox.S.index;let he,q={};const Ce=[R.R.index>ie,w.rEpr<3,R.rEpr<w.rEpr];q.steps=[[P||w.rEt<w.tr&&w.rEp>=w.sEp,U,!b.breakIndexs[1]||ie<b.breakIndexs[1],le>ie,le<ne],[...Ce,j>ie,le<Y,le<j],[R.R.index-w.R.index>.5*w.tr,M,!b.breakIndexs[1]||j<b.breakIndexs[1],le>j],[X,te,le>Q,Ce.every(Boolean)||le>oe]],q.step=1,q.result=q.steps[0].every(Boolean),he=w.R1.price,q.result&&(le<=j?(q.step=2,q.result=q.steps[1].every(Boolean),he=R.S1.price):(q.step=3,q.result=q.steps[2].every(Boolean),he=b.R1.price,q.result&&(q.step=4,q.result=q.steps[3].every(Boolean),q.result&&(he=b.xBox.R.price))));const $e=`${U?P?1:0:2}${re?M?1:0:2}${te?X?1:0:2}`,ge=w.rEp,Ie=a(n.price,ge,$),Ae=b.breakIndexs[1]??le,we=parseInt((Ae-w.R.index)/w.tr),De=we>1?ge*we:ge,Ne=a(n.price,De,$);return{progress:q,timeMark:Pe,info:{rEpr1:w.rEpr,rEpr2:R.rEpr,rEpr3:b.rEpr,entry:he,pStatus:$e,x:Ie,X:ge,y:Ne,Y:De}}}function g({phase:c,start:n,end:_,breakPrices:l,retracementPrice:$}){let w=t.cloneDeep(n),R=t.cloneDeep(_);const b=R.price>w.price;let P={},M={},X={},U=[null,null],re,te,ie;const ne=r.pickTimeToolRef.get();return r.prices.filter(j=>{let Q=j.time>=w.time;return ne&&(Q&=j.time<=ne),Q}).every((j,Q)=>{const Y=j.value,oe=r.timeToIndex(j.time);return oe===-1?!1:(Q===0&&(P={R:{index:oe,price:Y},S:{index:oe,price:Y},pr:0,tr:0},M=t.cloneDeep(P),X=t.cloneDeep(P)),t.cmp(Y,b,P.R.price)?(P.pr>0&&(P.pr>=M.pr&&(M.pr=P.pr,M.R=t.cloneDeep(P.R),M.S=t.cloneDeep(P.S)),P.tr>M.tr&&(M.tr=P.tr),c===1&&$&&!t.cmp(P.S.price,!b,$)&&P.tr>=X.tr&&P.pr>=X.pr&&(X=t.cloneDeep(P))),P={R:{index:oe,price:Y},S:{index:oe,price:Y},pr:0,tr:0},c===3&&l&&(!U[0]&&t.cmp(Y,b,l[0])&&(U[0]=oe),!U[1]&&t.cmp(Y,b,l[1])&&(U[1]=oe))):(P.S.index=oe,P.tr=P.S.index-P.R.index,t.cmp(Y,!b,P.S.price)&&(P.S.price=Y,P.pr=t.fmtNum(P.S.price-P.R.price,1,!0))),t.cmp(Y,!b,w.price)?(P.S.price=w.price,!1):!!t.cmp(Y,!b,R.price))}),t.isSet(P)&&(w.index=r.timeToIndex(w.time),R.index=P.S.index,R.time=r.indexToTime(P.S.index),re=t.fmtNum(R.price-M.R.price,1,!0),te=t.fmtNum(w.price-M.S.price,1,!0),ie=R.index-M.S.index,c===3&&(X=P)),{tr:M.tr,pr:M.pr,rEp:re,sEp:te,rEpr:M.pr?t.fmtNum(re/M.pr):0,rEt:ie,S1:M.S,R1:M.R,xBox:X,S:w,R,breakIndexs:U}}function i({A:{time:c}}){return c>=r.prices[0].time&&c<r.prices.at(-1).time}function a(c,n,_){const l=c+(_?1:-1)*n;let $=t.fmtNum(l%1);if(_){if($>=.1&&$<=.2)return Math.floor(l);if($>=.6&&$<=.7)return Math.floor(l)+.5}else{if($>=.8&&$<=.9)return Math.ceil(l);if($>=.3&&$<=.4)return Math.floor(l)+.5}return l}function S(){if(r.pickTimeToolRef.get())return!1;const n=f.B.price-f.A.price>0,_=r.prices.at(-1).value;if(t.cmp(_,!n,f.C.price)){let l=_;for(let $=r.prices.length-1;$>=0;$--){const w=r.prices[$].value;if(w===f.B.price)break;l=n?Math.min(l,w):Math.max(l,w)}f.C.price=l,v()}}function v(c=!1){let n={isRemove:c,name:"pattern",points:[],data:[]};c?f={}:Object.entries(f).forEach(([_,l])=>{n.points.push(_),n.data.push(l)}),m.dispatch("tradingDerivative/drawTools",n)}function k(){v(!0),r.pickTimeToolRef.remove(),C(),T("setProgress",{})}function C(){t.isSet(h.A)&&(r.priceSeries.removePriceLine(h.A),t.isSet(h.B)&&(r.priceSeries.removePriceLine(h.B),t.isSet(h.C)&&(r.priceSeries.removePriceLine(h.C),r.priceSeries.removePriceLine(h.D),r.priceSeries.removePriceLine(h.X),r.priceSeries.removePriceLine(h.Y)))),h={},e([])}function e(c){const n=["#F44336","#F44336","#4CAF50","#FFEB3B","#FFEB3B","#2196F3"];let _=[];for(let l=0;l<c.length;l++){let $=r.indexToTime(c[l]);$&&(c.indexOf(c[l])!==c.lastIndexOf(c[l])&&($+=l),_.push({time:$,value:1,color:n[l]}))}_.length&&_.sort((l,$)=>l.time-$.time),r.timeMarkSeries.setData(_)}function u({lineOptions:c}){if(t.isSet(h.C)){let n,_;f={A:{time:f.A.time,price:+h.A.options().price},B:{price:+h.B.options().price},C:{price:+h.C.options().price}},v();const{progress:l,timeMark:$,info:{rEpr1:w,rEpr2:R,rEpr3:b,entry:P,pStatus:M,x:X,X:U,y:re,Y:te}}=s();T("setProgress",l),e($),n="A",_={title:`A ${w}`},h[n].applyOptions(_),n="B",_={title:`B ${R}`},h[n].applyOptions(_),n="C",_={title:`C ${b}`},h[n].applyOptions(_),n="D",_={price:P,title:"Entry "+M},c.point===n&&delete _.price,h[n].applyOptions(_),n="X",_={price:t.fmtNum(X),title:`X ${t.fmtNum(U)}`},h[n].applyOptions(_),n="Y",_={price:t.fmtNum(re),title:`Y ${t.fmtNum(te)}`},h[n].applyOptions(_)}}return(c,n)=>(H(),J("div",{ref_key:"patternToolRef",ref:y,class:"command",title:c.$t("trading.derivative.patternTool"),onClick:V,onContextmenu:F},Ut,40,jt))}},Gt=["title"],Kt=B("i",{class:"far fa-pipe"},null,-1),ei=[Kt],ti={__name:"PickTimeTool",props:["pickTimeSeries"],emits:["refreshPattern","hideContext"],setup(L,{expose:I,emit:x}){const m=me(),t=L,r=x,T=N(null),y=ce(()=>m.state.tradingDerivative.tools.pickTime);let O=null;I({isSelected:f,draw:F,remove:W,get:h}),ve(y,A=>{A&&Z(A[0])});function f(){return T.value.classList.contains("selected")}function h(){return O}function d(A){r("hideContext");const p=A.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(s=>s.classList.remove("selected")),p||A.target.classList.add("selected")}function V(A){A.target.classList.remove("selected"),W(),r("refreshPattern")}function F({time:A}){m.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"pickTime",points:[0],data:[A]}),Z(A),r("refreshPattern"),T.value.classList.remove("selected")}function Z(A){O=A,t.pickTimeSeries.setData([{time:A,value:1,color:"#9C27B0"}])}function W(A=!0){A&&m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"pickTime"}),t.pickTimeSeries.setData([]),O=null}return(A,p)=>(H(),J("div",{ref_key:"pickTimeToolRef",ref:T,class:"command",title:A.$t("trading.derivative.pickTimeTool"),onClick:d,onContextmenu:V},ei,40,Gt))}};const ii=B("div",{class:"triangle-shadow"},null,-1),ni=B("div",{class:"triangle"},null,-1),ri={class:"input"},si={class:"color"},oi=["onClick"],ai={__name:"LineContext",props:["enable","title","color"],emits:["update:title","update:color"],setup(L,{emit:I}){const x=L,m=I,t=N(null),r=N(["#F44336","#FF9800","#FFEB3B","#4CAF50","#009688","#00BCD4","#2196F3","#673AB7","#9C27B0","#E91E63"]);ve(()=>x.enable,h=>{h&&gt().then(()=>t.value.instance.focus())});function T({value:h}){m("update:title",h)}function y(h){m("update:color",h)}function O(){m("deleteAllLine")}function f(h){h.stopPropagation()}return(h,d)=>{const V=tt("DxButton");return H(),J("div",{class:"line-context",onClick:f},[ii,ni,B("div",ri,[ee(nt(kt),{ref_key:"titleRef",ref:t,value:x.title,"show-clear-button":!0,"input-attr":{style:`color:${x.color}`},onValueChanged:T},null,8,["value","input-attr"]),ee(V,{icon:"trash",type:"danger",onClick:d[0]||(d[0]=F=>O())})]),B("div",si,[(H(!0),J(We,null,Ze(r.value,(F,Z)=>(H(),J("div",{class:"color-swatch",style:St({background:F,boxShadow:`0 0 4px ${F}`}),key:Z,onClick:W=>y(F)},null,12,oi))),128))])])}}},ci=["title"],li=B("i",{class:"far fa-horizontal-rule"},null,-1),pi={__name:"LineTool",props:["priceSeries"],emits:["hideContext"],setup(L,{expose:I,emit:x}){const m=me(),t=L,r=x,T=N(null),y=N(!1),O=ce(()=>m.state.tradingDerivative.tools.line),f=N(""),h=N("#F44336");let d=[];I({isSelected:V,hide:F,draw:A,drag:i}),ve(O,a=>{a&&p(a)});function V(){return T.value.classList.contains("selected")}function F(a){y.value=a}function Z(a){r("hideContext");const S=a.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(v=>v.classList.remove("selected")),S||a.target.classList.add("selected")}function W(a){const S=y.value;r("hideContext"),y.value=!S}function A({price:a}){const S="line",v=d.length;if(d=d.filter(k=>{const C=k.options(),e=C.type=a===+C.price;return e&&(t.priceSeries.removePriceLine(k),m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:S,point:a})),!e}),d.length===v){const k=h.value,C=f.value,e={lineType:S,price:a,color:k,title:C,lineWidth:1,lineStyle:1,draggable:!0};d.push(t.priceSeries.createPriceLine(e)),m.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:S,points:[a],data:[{color:k,title:C}]})}T.value.classList.remove("selected")}function p(a){g(!1),s(a)}function s(a){const v={lineType:"line",lineWidth:1,lineStyle:1,draggable:!0};Object.entries(a).forEach(([k,{color:C,title:e}])=>{v.price=+k,v.color=C,v.title=e,d.push(t.priceSeries.createPriceLine(v))})}function g(a=!0){d.length>0&&(a&&m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line"}),d.forEach(S=>t.priceSeries.removePriceLine(S)),d=[])}function i({lineOptions:a,oldPrice:S,newPrice:v}){m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"line",point:S});const k=a.color,C=a.title;m.dispatch("tradingDerivative/drawTools",{isRemove:!1,name:"line",points:[v],data:[{color:k,title:C}]}),T.value.classList.remove("selected")}return(a,S)=>(H(),J("div",{ref_key:"lineToolRef",ref:T,class:"context command",title:a.$t("trading.derivative.lineTool"),onClick:Z,onContextmenu:W},[li,Te(ee(ai,{class:"contextmenu",enable:y.value,title:f.value,"onUpdate:title":S[0]||(S[0]=v=>f.value=v),color:h.value,"onUpdate:color":S[1]||(S[1]=v=>h.value=v),onDeleteAllLine:g},null,8,["enable","title","color"]),[[be,y.value]])],40,ci))}},di=["title"],ui=B("i",{class:"far fa-grip-lines-vertical"},null,-1),fi=[ui],mi={__name:"TimeRangeTool",props:["timeRangeSeries","timeToIndex","indexToTime"],emits:["hideContext"],setup(L,{expose:I,emit:x}){const m=me(),t=fe("mf"),r=L,T=x,y=N(null),O=ce(()=>m.state.tradingDerivative.tools.timeRange);let f=[];I({isSelected:h,draw:F}),ve(O,p=>{p&&Z(p)});function h(){return y.value.classList.contains("selected")}function d(p){T("hideContext");const s=p.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(g=>g.classList.remove("selected")),s||p.target.classList.add("selected")}function V(p){A(),p.target.classList.remove("selected")}function F({time:p}){let s={isRemove:!1,name:"timeRange",points:[],data:[]},g={time:p,value:1};switch(f.length){case 0:g.color="OrangeRed",f[0]=g,s.points.push(0),s.data.push(p);break;case 1:g.color="lime",f[1]=g,s.points.push(1),s.data.push(p),y.value.classList.remove("selected");break;default:const i=r.timeToIndex(f[0].time),a=r.timeToIndex(f[1].time),v=r.timeToIndex(p)+(a-i),k=r.indexToTime(v);g.color="OrangeRed",f[0]=t.cloneDeep(g),s.points.push(0),s.data.push(p),g.time=k,g.color="lime",f[1]=g,s.points.push(1),s.data.push(k),y.value.classList.remove("selected");break}r.timeRangeSeries.setData(f),m.dispatch("tradingDerivative/drawTools",s)}function Z(p){A(!1),W(p)}function W(p){let s,g;if(p.length===2)s=p[0],g=p[1];else if(p.length===3){const a=r.timeToIndex(p[0]),S=r.timeToIndex(p[1]),k=r.timeToIndex(p[2])+(S-a);s=p[2],g=r.indexToTime(k)}else return!1;let i=[{time:s,value:1,color:"OrangeRed"},{time:g,value:1,color:"lime"}];f=i,r.timeRangeSeries.setData(i)}function A(p=!0){p&&m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"timeRange"}),r.timeRangeSeries.setData([]),f=[]}return(p,s)=>(H(),J("div",{ref_key:"timeRangeToolRef",ref:y,class:"command",title:p.$t("trading.derivative.timeRangeTool"),onClick:d,onContextmenu:V},fi,40,di))}},vi=["title"],hi=B("i",{class:"far fa-line-height"},null,-1),gi=[hi],Si={__name:"TargetTool",props:["priceSeries"],emits:["hideContext"],setup(L,{expose:I,emit:x}){const m=me(),t=fe("mf"),r=L,T=x,y=N(null),O=ce(()=>m.state.tradingDerivative.tools.target);let f={};I({isSelected:h,draw:F,drag:p}),ve(O,s=>{s&&Z(s)});function h(){return y.value.classList.contains("selected")}function d(s){T("hideContext");const g=s.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(i=>i.classList.remove("selected")),g||(s.target.classList.add("selected"),A())}function V(s){A(),s.target.classList.remove("selected")}function F({price:s}){const g="target";let i={lineType:g,price:s,lineWidth:1,lineStyle:1,draggable:!0},a={isRemove:!1,name:g,points:[],data:[s]};if(t.isSet(f.A)){const S=+f.A.options().price,v=s-S;i.point="B",i.title=t.fmtNum(v),i.color="#F44336",f[i.point]=r.priceSeries.createPriceLine(i),a.points.push(i.point),i.point="X",i.price=t.fmtNum(S-.5*v),i.title=t.fmtNum(-.5*v),i.color="#2196F3",f[i.point]=r.priceSeries.createPriceLine(i),i.point="Y",i.price=t.fmtNum(S-v),i.title=t.fmtNum(-v),i.color="#673AB7",f[i.point]=r.priceSeries.createPriceLine(i),i.point="Z",i.price=t.fmtNum(S-2*v),i.title=t.fmtNum(-2*v),i.color="#9C27B0",f[i.point]=r.priceSeries.createPriceLine(i),i.point="W",i.price=t.fmtNum(S-4*v),i.title=t.fmtNum(-4*v),i.color="#E91E63",f[i.point]=r.priceSeries.createPriceLine(i),y.value.classList.remove("selected")}else i.point="A",i.title="0",i.color="#FF9800",f[i.point]=r.priceSeries.createPriceLine(i),a.points.push(i.point);m.dispatch("tradingDerivative/drawTools",a)}function Z(s){A(!1),W(s)}function W(s){let i={lineType:"target",lineWidth:1,lineStyle:1,draggable:!0};const a=s.A,S=s.B,v=S-a;i.point="A",i.price=a,i.title="0",i.color="#FF9800",f[i.point]=r.priceSeries.createPriceLine(i),i.point="B",i.price=S,i.title=t.fmtNum(v),i.color="#F44336",f[i.point]=r.priceSeries.createPriceLine(i),i.point="X",i.price=t.fmtNum(a-.5*v),i.title=t.fmtNum(-.5*v),i.color="#2196F3",f[i.point]=r.priceSeries.createPriceLine(i),i.point="Y",i.price=t.fmtNum(a-v),i.title=t.fmtNum(-v),i.color="#673AB7",f[i.point]=r.priceSeries.createPriceLine(i),i.point="Z",i.price=t.fmtNum(a-2*v),i.title=t.fmtNum(-2*v),i.color="#9C27B0",f[i.point]=r.priceSeries.createPriceLine(i),i.point="W",i.price=t.fmtNum(a-4*v),i.title=t.fmtNum(-4*v),i.color="#E91E63",f[i.point]=r.priceSeries.createPriceLine(i)}function A(s=!0){s&&m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"target"}),t.isSet(f.A)&&(r.priceSeries.removePriceLine(f.A),t.isSet(f.B)&&(r.priceSeries.removePriceLine(f.B),r.priceSeries.removePriceLine(f.X),r.priceSeries.removePriceLine(f.Y),r.priceSeries.removePriceLine(f.Z),r.priceSeries.removePriceLine(f.W))),f={}}function p({lineOptions:s,newPrice:g}){if(t.isSet(f.B)){let i={isRemove:!1,name:"target",points:[],data:[]},a,S,v=+f.A.options().price,k=+f.B.options().price,C=k-v;if(a="A",s.point==="A")C=+f.B.options().title,k=v+C;else if(s.point!=="B"){let e=0;switch(s.point){case"X":e=1.5;break;case"Y":e=2;break;case"Z":e=3;break;case"W":e=5;break}C=t.fmtNum((k-g)/e),v=k-C,S={price:v},f[a].applyOptions(S)}i.points.push(a),i.data.push(v),a="B",S={price:k,title:t.fmtNum(C)},s.point===a&&delete S.price,f[a].applyOptions(S),i.points.push(a),i.data.push(k),a="X",S={price:t.fmtNum(v-.5*C),title:t.fmtNum(-.5*C)},s.point===a&&delete S.price,f[a].applyOptions(S),a="Y",S={price:t.fmtNum(v-C),title:t.fmtNum(-C)},s.point===a&&delete S.price,f[a].applyOptions(S),a="Z",S={price:t.fmtNum(v-2*C),title:t.fmtNum(-2*C)},s.point===a&&delete S.price,f[a].applyOptions(S),a="W",S={price:t.fmtNum(v-4*C),title:t.fmtNum(-4*C)},s.point===a&&delete S.price,f[a].applyOptions(S),m.dispatch("tradingDerivative/drawTools",i)}}return(s,g)=>(H(),J("div",{ref_key:"targetToolRef",ref:y,class:"command",title:s.$t("trading.derivative.targetTool"),onClick:d,onContextmenu:V},gi,40,vi))}},yi=["title"],Ge=3,Ke=2,Ti={__name:"OrderTool",props:["position","prices","priceSeries","inSession","TIME"],emits:["getTools","showEntry","showTpSl","orderChanged","hideContext"],setup(L,{expose:I,emit:x}){const m=me(),{t}=Oe(),r=fe("mf"),T=L,y=x,O=N(null),f=N(!1),h=ce(()=>m.state.tradingDerivative.tools.order);let d={side:0,entry:{},tp:{},sl:{}},V=!1;I({show:Z,entry:W,tpsl:A,cancel:p,cancelWithoutClose:s,scan:g,drag:k}),ve(h,e=>{e&&a(e)});function F(){return r.isSet(d.entry.line)||r.isSet(d.tp.line)}function Z({price:e}){if(e&&T.inSession()){const u=G(_e(new Date,7));if(r.isSet(d.entry.line))!r.isSet(d.tp.line)&&T.position&&u>T.TIME.ATO&&u<T.TIME.ATC&&y("showTpSl",{side:T.position});else{let c=null,n=0;T.position?(u<T.TIME.ATO?c="ATO":u>T.TIME.ATC&&(c="ATC"),c&&(d.entry.price=c,n=-T.position)):u>T.TIME.ATO&&u<T.TIME.ATC&&(c=e,n=c>=T.prices.at(-1).value?1:-1,d.side=n,d.entry.price=c),n&&y("showEntry",{side:n,price:c})}}}function W(){if(T.inSession()){const e=G(_e(new Date,7));e<T.TIME.ATO?Qe(t("trading.derivative.atoOrder"),t("titles.confirm")).then(c=>{c&&m.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(n=>{n.isOk?se.success(t("trading.derivative.atoOrderSuccess")):C(n.message)})}):e>T.TIME.ATC?Qe(t("trading.derivative.atcOrder"),t("titles.confirm")).then(c=>{c&&m.dispatch("tradingDerivative/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(n=>{n.isOk?se.success(t("trading.derivative.atcOrderSuccess")):C(n.message)})}):m.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"new",side:d.side,price:d.entry.price}}).then(u=>{u.isOk?(i(["entry"]),se.success(t("trading.derivative.newEntrySuccess"))):C(u.message)})}}function A(){d.tp.price=d.entry.price+d.side*Ge,d.sl.price=d.entry.price-d.side*Ke,m.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:d.tp.price},slData:{cmd:"new",price:d.sl.price}}).then(e=>{e.isOk?(d.entry.line.applyOptions({draggable:!1}),i(["entry","tp","sl"]),se.success(t("trading.derivative.newTpSlSuccess"))):C(e.message)})}function p(){r.isSet(d.entry.line)?r.isSet(d.tp.line)?m.dispatch("tradingDerivative/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(e=>{e.isOk?(v(["entry","tp","sl"]),se.success(t("trading.derivative.exitSuccess"))):C(e.message)}):m.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"delete"}}).then(e=>{e.isOk?(v(["entry"]),se.success(t("trading.derivative.deleteEntrySuccess"))):C(e.message)}):y("getTools")}function s(){if(T.inSession()&&T.position){const e=G(_e(new Date,7));e>T.TIME.ATC-5*60&&(f.value=!0,e>T.TIME.ATC-15&&r.isSet(d.tp.line)&&m.dispatch("tradingDerivative/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(u=>{u.isOk?(v(["entry","tp","sl"]),se.success(t("trading.derivative.autoCancelTpSlSuccess"))):C(u.message)}))}}function g(e){if(r.isSet(d.entry.line)){const u=d.side>0;r.isSet(d.tp.line)?(r.cmp(e,u,d.tp.price,!0)&&(V||(V=!0,m.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"delete"}}).then(c=>{c.isOk?(v(["entry","tp","sl"]),se.success(t("trading.derivative.deleteTpSuccess"))):C(c.message),V=!1}))),r.cmp(e,!u,d.sl.price,!0)&&(V||(V=!0,m.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"cancel"}}).then(c=>{c.isOk?(v(["entry","tp","sl"]),se.success(t("trading.derivative.deleteSlSuccess"))):C(c.message),V=!1})))):r.cmp(e,u,d.entry.price,!0)&&(V||(V=!0,setTimeout(()=>{d.tp.price=d.entry.price+d.side*Ge,d.sl.price=d.entry.price-d.side*Ke,m.dispatch("tradingDerivative/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:d.tp.price},slData:{cmd:"new",price:d.sl.price}}).then(c=>{c.isOk?(d.entry.line.applyOptions({draggable:!1}),i(["entry","tp","sl"]),se.success(t("trading.derivative.autoNewTpSlSuccess"))):C(c.message),V=!1})},1e3)))}}function i(e){const u="order";let c={isRemove:!1,name:u,points:[],data:[]},n,_;e.forEach(l=>{const $=d.entry.price,w=d.tp.price,R=d.sl.price;switch(l){case"entry":n="yellow",_=d.side>0?"LONG":"SHORT";break;case"tp":n="lime",_=r.fmtNum(w-$,1,!0);break;case"sl":n="red",_=r.fmtNum(R-$,1,!0);break}if(c.points.push(l),r.isSet(d[l].line))d[l].line.applyOptions({price:d[l].price,title:_}),c.data.push(d[l].line.options());else{const b={lineType:u,kind:l,side:d.side,price:d[l].price,color:n,lineWidth:1,lineStyle:0,title:_,draggable:!0};d[l].line=T.priceSeries.createPriceLine(b),c.data.push(b)}}),m.dispatch("tradingDerivative/drawTools",c),y("orderChanged",F())}function a(e){v(["entry","tp","sl"],!1),S(e),y("orderChanged",F())}function S(e){Object.entries(e).forEach(([u,c])=>{u==="entry"&&(d.side=c.side),d[u].price=c.price,d[u].line=T.priceSeries.createPriceLine(c)})}function v(e,u=!0){u&&m.dispatch("tradingDerivative/drawTools",{isRemove:!0,name:"order"}),e.forEach(c=>{r.isSet(d[c].line)&&(T.priceSeries.removePriceLine(d[c].line),delete d[c].line)}),y("orderChanged",F())}function k({line:e,lineOptions:u,oldPrice:c,newPrice:n}){if(n!==c){let _=!1;u.kind==="entry"?T.position||(_=!0,d[u.kind].price=n,m.dispatch("tradingDerivative/executeOrder",{action:"entry",etData:{cmd:"change",price:d.entry.price}}).then(l=>{l.isOk?(i([u.kind]),se.success(t("trading.derivative.changeEntrySuccess"))):(e.applyOptions({price:c}),C(l.message))})):(_=!0,d[u.kind].price=n,u.kind==="tp"?m.dispatch("tradingDerivative/executeOrder",{action:"tp",tpData:{cmd:"change",price:d.tp.price}}).then(l=>{l.isOk?(i([u.kind]),se.success(t("trading.derivative.changeTpSuccess"))):(e.applyOptions({price:c}),C(l.message))}):m.dispatch("tradingDerivative/executeOrder",{action:"sl",slData:{cmd:"change",price:d.sl.price}}).then(l=>{l.isOk?(i([u.kind]),se.success(t("trading.derivative.changeSlSuccess"))):(e.applyOptions({price:c}),C(l.message))})),_||(e.applyOptions({price:c}),se.show(t("trading.derivative.noChangeOrderLine")))}}function C(e){e||(e="unknown"),se.error(t(`trading.derivative.${e}`))}return(e,u)=>(H(),J("div",{ref_key:"orderToolRef",ref:O,class:"cancel-order command",title:e.$t("trading.derivative.orderTool"),onClick:p},[B("i",{class:ae(["far fa-trash-alt",{blink:f.value}])},null,2)],8,yi))}};const xi=["title"],Ci=["title"],ki=["title"],_i=["title"],bi="wss://tradestation.fireant.vn/quote?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSIsImtpZCI6IkdYdExONzViZlZQakdvNERWdjV4QkRITHpnSSJ9.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4iLCJhdWQiOiJodHRwczovL2FjY291bnRzLmZpcmVhbnQudm4vcmVzb3VyY2VzIiwiZXhwIjoxODg5NjIyNTMwLCJuYmYiOjE1ODk2MjI1MzAsImNsaWVudF9pZCI6ImZpcmVhbnQudHJhZGVzdGF0aW9uIiwic2NvcGUiOlsiYWNhZGVteS1yZWFkIiwiYWNhZGVteS13cml0ZSIsImFjY291bnRzLXJlYWQiLCJhY2NvdW50cy13cml0ZSIsImJsb2ctcmVhZCIsImNvbXBhbmllcy1yZWFkIiwiZmluYW5jZS1yZWFkIiwiaW5kaXZpZHVhbHMtcmVhZCIsImludmVzdG9wZWRpYS1yZWFkIiwib3JkZXJzLXJlYWQiLCJvcmRlcnMtd3JpdGUiLCJwb3N0cy1yZWFkIiwicG9zdHMtd3JpdGUiLCJzZWFyY2giLCJzeW1ib2xzLXJlYWQiLCJ1c2VyLWRhdGEtcmVhZCIsInVzZXItZGF0YS13cml0ZSIsInVzZXJzLXJlYWQiXSwianRpIjoiMjYxYTZhYWQ2MTQ5Njk1ZmJiYzcwODM5MjM0Njc1NWQifQ.dA5-HVzWv-BRfEiAd24uNBiBxASO-PAyWeWESovZm_hj4aXMAZA1-bWNZeXt88dqogo18AwpDQ-h6gefLPdZSFrG5umC1dVWaeYvUnGm62g4XS29fj6p01dhKNNqrsu5KrhnhdnKYVv9VdmbmqDfWR8wDgglk5cJFqalzq6dJWJInFQEPmUs9BW_Zs8tQDn-i5r4tYq2U8vCdqptXoM7YgPllXaPVDeccC9QNu2Xlp9WUvoROzoQXg25lFub1IYkTrM66gJ6t9fJRZToewCt495WNEOQFa_rwLCZ1QwzvL0iYkONHS_jZ0BOhBCdW9dWSawD6iF1SIQaFROvMDH1rg",wi="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",Oi={__name:"Chart",setup(L,{expose:I}){const x=me(),m=xt(),{t}=Oe(),r=fe("devices"),T=fe("mf"),y=fe("filters"),O=N(null),f=N(null),h=N(null),d=N(null),V=N(null),F=N(null),Z=N(null),W=N(null),A=N(null),p=N(null),s=N(null),g=N(null),i=N(null),a=N(null),S=N(null),v={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.25,bottom:.25}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:1e3,minBarSpacing:.01,barSpacing:.05}},k=Le(new Date,"yyyy-MM-dd"),C={START:G(new Date(`${k}T08:45:00Z`)),ATO:G(new Date(`${k}T09:00:00Z`)),ATC:G(new Date(`${k}T14:30:00Z`)),END:G(new Date(`${k}T14:45:00Z`))};let e={chart:{},whitespaces:[],crosshair:{},interval:null,interval10At:Ve(new Date,11),interval30At:Ve(new Date,31),websocket:null,socketStop:!1,vpsUpdatedAt:Ve(new Date,61)};const u=yt({prices:[],series:{},chartDate:m.query.date??k,clock:Le(new Date,"HH:mm:ss"),isSocketWarning:!1,hasOrderLine:!1,TIME:C}),c=ce(()=>x.state.tradingDerivative.status),n=ce(()=>x.state.tradingDerivative.config),_=ce(()=>x.state.tradingDerivative.isLoading),l=ce(()=>c.value.position||c.value.pending||u.hasOrderLine);e.interval=setInterval(()=>{i.value&&i.value.cancelWithoutClose(),u.clock=Le(new Date,"HH:mm:ss"),Me(new Date,new Date(e.interval10At))>10&&(ke()&&n.value.autoRefresh&&W.value.refresh(!0),e.interval10At=new Date),Me(new Date,new Date(e.interval30At))>30&&(ke()&&Xe(),e.interval30At=new Date)},1e3),ct(),Ye(()=>{$(),new ResizeObserver(re).observe(O.value),document.addEventListener("keydown",te)}),et(()=>{w(),document.removeEventListener("keydown",te),clearInterval(e.interval),oe(),e.socketStop=!0}),ve(()=>x.state.tradingDerivative.chartData,ie),I({connectSocket:Y});function $(){e.chart=_t(f.value,v),e.chart.subscribeCrosshairMove(X),e.chart.subscribeCustomPriceLineDragged(U),u.series.whitespace=e.chart.addHistogramSeries({priceScaleId:"whitespace",scaleMargins:{top:0,bottom:0},color:"#808080",lastValueVisible:!1,priceLineVisible:!1}),u.series.timeRange=e.chart.addHistogramSeries({priceScaleId:"timeRange",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),u.series.pickTime=e.chart.addHistogramSeries({priceScaleId:"pickTime",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),u.series.timeMark=e.chart.addHistogramSeries({priceScaleId:"timeMark",scaleMargins:{top:0,bottom:0},lastValueVisible:!1,priceLineVisible:!1}),u.series.price=e.chart.addLineSeries({color:"#F5F5F5",priceFormat:{minMove:.1}})}function w(){e.chart&&(e.chart.remove(),e.chart=null)}function R(o){ue(),ge(!1),Z.value.isSelected()?Z.value.draw({time:e.crosshair.time}):W.value.isSelected()?W.value.draw({time:e.crosshair.time,price:Ee(e.crosshair.y)}):A.value.isSelected()?A.value.draw({time:e.crosshair.time}):p.value.isSelected()?p.value.draw({price:Ee(e.crosshair.y)}):s.value.isSelected()?s.value.draw({time:e.crosshair.time}):g.value.isSelected()&&g.value.draw({price:Ee(e.crosshair.y)})}function b(o){ge(!0),o.preventDefault()}function P(o){o.stopPropagation()}function M(o){o.preventDefault(),o.stopPropagation()}function X(o){if(o.time){let E=o.seriesPrices.get(u.series.price);e.crosshair.time=o.time,e.crosshair.price=E}else r.phone||(e.crosshair.time=null,e.crosshair.price=null);o.point!==void 0&&(e.crosshair.x=o.point.x,e.crosshair.y=o.point.y)}function U(o){let E=o.customPriceLine,D=E.options();D.price=T.fmtNum(D.price);const z=+o.fromPriceString,K=D.price;switch(D.lineType){case"order":i.value.drag({line:E,lineOptions:D,oldPrice:z,newPrice:K});break;case"line":p.value.drag({lineOptions:D,oldPrice:z,newPrice:K});break;case"target":g.value.drag({lineOptions:D,newPrice:K});break;case"pattern":W.value.drag({lineOptions:D});break}}function re(){O.value&&(e.chart.resize(O.value.offsetWidth,O.value.offsetHeight),O.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function te(o){if(o.ctrlKey)switch(o.keyCode){case 219:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing-.01});break;case 221:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing+.01});break}if(o.altKey)switch(o.keyCode){case 219:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()-50);break;case 221:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()+50);break}}function ie(o){u.chartDate===k&&ke()||(o.price.length>0&&(e.whitespaces=Q(e.whitespaces,j(u.chartDate))),u.series.whitespace.setData(e.whitespaces),u.prices=Q(u.prices,o.price),u.series.price.setData(u.prices))}function ne(o,E=null){const D=E??n.value.source;let z=[];o.forEach(K=>{let pe,de;D==="FireAnt"?(pe=G(_e(new Date(K.date),7)),de=K.price):(pe=G(new Date(`${k}T${K.time}Z`)),de=K.lastPrice),z.push({time:pe,value:de})}),z.length>1?(u.prices=Q(u.prices,z),u.series.price.setData(u.prices)):(u.prices.push(z[0]),u.series.price.update(z[0]))}function j(o){const E=G(new Date(`${o}T09:00:00Z`)),D=G(new Date(`${o}T11:30:00Z`)),z=G(new Date(`${o}T13:00:00Z`)),K=G(new Date(`${o}T14:30:00Z`)),pe=G(new Date(`${o}T14:00:00Z`));let de=[];for(let Se=E;Se<=K;Se++){if(Se>D&&Se<z)continue;let qe={time:Se};(Se===pe||Se===K)&&(qe.value=1),de.push(qe)}return de}function Q(o,E){return Array.from(new Map([...o,...E].sort((D,z)=>D.time-z.time).map(D=>[D.time,D])).values())}async function Y(){if(ke()){await oe();const o=n.value.source==="FireAnt",E=o?bi:wi;e.websocket=new WebSocket(E),e.websocket.onclose=D=>{e.socketStop||(u.isSocketWarning=!0,Y())},o?Pe():(q(),he())}}async function oe(){e.websocket&&e.websocket.readyState===WebSocket.OPEN&&(e.websocket.close(),await new Promise(o=>{const E=setInterval(()=>{(!e.websocket||e.websocket.readyState===WebSocket.CLOSED)&&(e.websocket=null,clearInterval(E),o())},100)}))}function Pe(){x.dispatch("tradingDerivative/setLoading",!0),e.websocket.onopen=o=>{if(e.websocket.readyState===WebSocket.OPEN){let E='{"protocol":"json","version":1}';e.websocket.send(E),E='{"arguments":["VN30F1M"],"invocationId":"0","target":"SubscribeTrades","type":1}',e.websocket.send(E)}},e.websocket.onmessage=o=>{u.isSocketWarning=!1,le(o.data).forEach(D=>{if(!D)return!1;D.type===3?(D.result[0].date.slice(0,10)===k&&(Re(),e.whitespaces=Q(e.whitespaces,j(k)),u.series.whitespace.setData(e.whitespaces),ne(D.result)),x.dispatch("tradingDerivative/setLoading",!1)):D.type===1&&D.target==="UpdateTrades"&&D.arguments[0]==="VN30F1M"&&(console.log("FireAnt",D.arguments[1]),i.value.scan(D.arguments[1].at(-1).price),ne(D.arguments[1]))})}}function le(o){let E=[];return o.split("").forEach(D=>{const z=D.indexOf("{"),K=D.lastIndexOf("}");let pe=null;if(z!==-1&&K!==-1&&K>z){const de=D.substring(z,K+1);de!=="{}"&&(pe=JSON.parse(de))}E.push(pe)}),E}function he(){e.websocket.onopen=o=>{if(e.websocket.readyState===WebSocket.OPEN){const E={action:"join",list:n.value.vn30f1m},D=`42${JSON.stringify(["regs",JSON.stringify(E)])}`;e.websocket.send(D)}},e.websocket.onmessage=o=>{if(u.isSocketWarning=!1,o.data.substr(0,1)==="4"&&o.data.substr(1,1)==="2"){const E=JSON.parse(o.data.substr(2));if(E[0]==="stockps"){const D=E[1].data;D.id===3220&&(console.log("VPS",D),i.value.scan(D.lastPrice),ne([D]))}}}}function q(){Me(new Date,new Date(e.vpsUpdatedAt))>60&&(fetch("https://bddatafeed.vps.com.vn/getpschartintraday/VN30F1M").then(o=>o.json()).then(o=>{console.log(o),ne(o,"VPS")}),e.vpsUpdatedAt=new Date)}function Ce(){W.value.refresh()}function He(o){W.value.load(o,{isSave:!0})}function ue(){F.value.hide(),Z.value.hide(),p.value.hide()}function Je(o){F.value.set(o)}function $e(o){u.hasOrderLine=o}function ge(o){o?i.value.show({price:Ee(e.crosshair.y)}):(a.value.style.display="none",S.value.style.display="none")}function Ie({side:o,price:E}){a.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-71?-71:1))+"px",a.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-61?-61:1))+"px",a.value.style.background=o>0?"green":"red",a.value.innerText=`${o>0?"LONG":"SHORT"} ${E}`,a.value.style.display="block"}function Ae({side:o}){S.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-61?-61:1))+"px",S.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-51?-51:1))+"px",S.value.style.background=o>0?"green":"red",S.value.style.display="block"}function we(){i.value.entry()}function De(){i.value.tpsl()}function Ne(){e.chart.timeScale().scrollToRealTime()}function ke(){const o=G(_e(new Date,7));return n.value.openingMarket&&o>=C.START&&o<=C.END}function ot(){if(!u.chartDate)return!1;Be()}function at(){e.whitespaces=[],u.prices=[],Y(),Be()}function ct(){x.dispatch("tradingDerivative/initChart").then(()=>{Y(),!m.query.date&&n.value.lastOpeningDate&&(u.chartDate=n.value.lastOpeningDate),Be()})}function Be(){x.dispatch("tradingDerivative/getChartData",u.chartDate).then(o=>{o&&Re()})}function Xe(){x.dispatch("tradingDerivative/getStatus")}function Re(){x.dispatch("tradingDerivative/getTools")}function lt(){x.dispatch("tradingDerivative/getAccountInfo").then(o=>{let E="";E+='<div style="width: 200px;">',E+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.nav")}</div><div>: ${y.currency(o.nav)}</div></div>`,E+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.maxVol")}</div><div>: ${y.numberVnFormat(o.maxVol)}</div></div>`,E+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.vm")}</div><div>: ${y.currency(o.vm)}</div></div>`,E+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${t("trading.derivative.fee")}</div><div>: ${y.currency(o.fee)}</div></div>`,E+="</div>",Ct(E,t("trading.derivative.accountInfo"))})}function Ee(o){return T.fmtNum(u.series.price.coordinateToPrice(o))}function Fe(o){let E=e.whitespaces.findIndex(D=>D.time===o);if(E===-1){const D=Le(new Date(o*1e3),"yyyy-MM-dd"),z=G(new Date(`${D}T11:30:00Z`)),K=G(new Date(`${D}T13:00:00Z`)),pe=G(new Date(`${D}T14:30:00Z`));o>z&&o<K?o=z:o>pe&&(o=pe),E=e.whitespaces.findIndex(de=>de.time===o)}return E}function je(o){return o<e.whitespaces.length?e.whitespaces[o].time:!1}return(o,E)=>(H(),J("div",{class:"derivative-chart",ref_key:"chartContainerRef",ref:O,onClick:R,onContextmenu:b},[B("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:f},[B("div",{class:"area data-area",onClick:P,onContextmenu:M},[B("div",{ref_key:"connectionRef",ref:h,class:ae(["command",{yellow:c.value.pending,red:n.value.volInvalid}]),title:o.$t("trading.derivative.connection"),onClick:Xe},[B("i",{class:ae(["far",{"fa-link-simple":c.value.connection,"fa-link-simple-slash":!c.value.connection,blink:u.isSocketWarning}])},null,2)],10,xi),B("div",{class:ae(["command status",{green:c.value.position>0,red:c.value.position<0}]),title:o.$t("trading.derivative.position"),onClick:lt},ye(c.value.position),11,Ci),B("div",{class:"command clock",onClick:Y},ye(u.clock),1),Te(B("input",{type:"date",class:"chart-date command",title:o.$t("trading.derivative.date"),"onUpdate:modelValue":E[0]||(E[0]=D=>u.chartDate=D),onChange:ot},null,40,ki),[[Tt,u.chartDate]]),B("div",{ref_key:"reloadToolRef",ref:d,class:"command",title:o.$t("trading.derivative.reload"),onClick:at,onContextmenu:Re},[B("i",{class:ae(["far fa-sync-alt",{"fa-spin":_.value}])},null,2)],40,_i)],32),B("div",{class:"area tool-area",onClick:P,onContextmenu:M},[ee(Dt,{chartContainerRef:O.value},null,8,["chartContainerRef"]),ee(Lt,{ref_key:"tradingviewToolRef",ref:V,vpsUser:n.value.vpsUser,vpsSession:n.value.vpsSession,chartContainerRef:O.value},null,8,["vpsUser","vpsSession","chartContainerRef"]),ee(Nt,{ref_key:"progressToolRef",ref:F,onRefreshPattern:Ce,onHideContext:ue},null,512),ee(Xt,{ref_key:"scanToolRef",ref:Z,prices:u.prices,timeToIndex:Fe,onScaned:He,onRemovePattern:E[1]||(E[1]=()=>W.value.remove()),onHideContext:ue},null,8,["prices"]),ee(Qt,{ref_key:"patternToolRef",ref:W,prices:u.prices,priceSeries:u.series.price,timeMarkSeries:u.series.timeMark,pickTimeToolRef:A.value,timeToIndex:Fe,indexToTime:je,onSetProgress:Je,onHideContext:ue},null,8,["prices","priceSeries","timeMarkSeries","pickTimeToolRef"]),ee(ti,{ref_key:"pickTimeToolRef",ref:A,pickTimeSeries:u.series.pickTime,onRefreshPattern:Ce,onHideContext:ue},null,8,["pickTimeSeries"]),ee(pi,{ref_key:"lineToolRef",ref:p,priceSeries:u.series.price,onHideContext:ue},null,8,["priceSeries"]),ee(mi,{ref_key:"timeRangeToolRef",ref:s,timeRangeSeries:u.series.timeRange,timeToIndex:Fe,indexToTime:je,onHideContext:ue},null,8,["timeRangeSeries"]),ee(Si,{ref_key:"targetToolRef",ref:g,priceSeries:u.series.price,onHideContext:ue},null,8,["priceSeries"]),Te(ee(Ti,{ref_key:"orderToolRef",ref:i,position:c.value.position,prices:u.prices,priceSeries:u.series.price,inSession:ke,TIME:u.TIME,onGetTools:Re,onShowEntry:Ie,onShowTpSl:Ae,onOrderChanged:$e,onHideContext:ue},null,8,["position","prices","priceSeries","TIME"]),[[be,l.value]])],32),B("div",null,[B("div",{ref_key:"entryOrderRef",ref:a,class:"order-button entry",onClick:we}," Entry ",512),B("div",{ref_key:"tpslOrderRef",ref:S,class:"order-button tpsl",onClick:De}," TP/SL ",512),B("div",{class:"chart-top command far fa-angle-double-right",onClick:Ne})])],512)],544))}};export{Oi as default};
