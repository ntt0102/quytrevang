import{u as ut,r as O,a as ft,c as ue,x as ht,E as mt,w as gt,v as C,b as vt,e as fe,d as m,G as H,t as he,B as ee,C as yt,H as me,h as Ot,j as Ct,k as U,A as ge,I as wt,l as kt,o as Tt}from"./app-dea70793.js";import bt from"./LineContextMenu-a99fb4e1.js";import{c as St}from"./lightweight-charts.esm.development-03366bac.js";import"./text-box-ecf5d1f8.js";class xt{constructor(){this.create()}create(){return new Promise((y,v)=>{const f=indexedDB.open("orderChart",1);f.onupgradeneeded=n=>{this.store=n.target.result,this.store.createObjectStore("order",{keyPath:"kind"}),this.store.createObjectStore("line",{keyPath:"price"}),this.store.createObjectStore("box",{keyPath:"point"}),this.store.createObjectStore("ruler",{keyPath:"point"}),this.store.createObjectStore("pattern1",{keyPath:"point"}),this.store.createObjectStore("pattern2",{keyPath:"point"}),this.store.createObjectStore("uplps",{keyPath:"title"}),this.store.createObjectStore("downlps",{keyPath:"title"}),this.store.createObjectStore("volprofile",{keyPath:"time"}),this.store.createObjectStore("alert",{keyPath:"price"}),this.store.createObjectStore("target",{keyPath:"price"}),y()},f.onsuccess=n=>{this.store=n.target.result,y()},f.onerror=()=>{location.reload(),v()}})}get(y){var v=this.store;return new Promise(function(n,D){var u=v.transaction(y,"readonly");if(Array.isArray(y)){var A=y.map(S=>u.objectStore(S)),p=A.map(f);Promise.all(p).then(S=>n(S))}else{var q=u.objectStore(y);f(q).then(S=>n(S))}});function f(n){return new Promise(function(D,u){const A=n.getAll();A.onsuccess=p=>D(p.target.result),A.onerror=()=>u()})}}set(y,v){const f=this.store.transaction(y,"readwrite").objectStore(y);Array.isArray(v)?v.length>0&&v.forEach(n=>f.put(n)):f.put(v)}clear(y){var v=this.store;return new Promise(function(f,n){const D=v.transaction(y,"readwrite").objectStore(y).clear();D.onsuccess=()=>{f()},D.onerror=u=>{console.error(`Error to empty Object Store: ${y}`),n()}})}}const R=new xt,Lt="/build/assets/alert-4d705e53.mp3";const Pt={class:"content-block dx-card responsive-paddings"},Rt=["title"],Dt=["title"],Et=["title"],At=["title"],$t=["title"],Ft=["title"],_t=["title"],Mt=["title"],Bt=["title"],jt=["title"],qt=["title"],It=["title"],Nt=["src"],ve=3,ye=2,Vt="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",Wt=120,zt={__name:"Index",setup(Oe){const y={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.05,bottom:.4}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:20,minBarSpacing:.01}},v=moment().format("YYYY-MM-DD"),f={START:moment(v+" 08:45:00").unix(),ATO:moment(v+" 09:00:00").unix(),ATC:moment(v+" 14:30:00").unix(),END:moment(v+" 14:45:00").unix()},n=Ot(),D=Ct(),{t:u}=ut(),A=U("devices"),p=U("mf"),q=U("bus"),S=U("filters"),x=O(null),te=O(null),F=O(null),re=O(null),ie=O(null),se=O(null),_=O(null),Ce=O(null),Y=O(null),X=O(null),z=O(null),Z=O(null),M=O(null),E=O(null),B=O(null),we=O(null);let e={chart:{},series:{},data:{whitespace:[],price:[],vn30:[],foreign:[],active:[],original:[],cash:[]},tools:{order:{side:0,entry:{},tp:{},sl:{}},lines:[],target:{A:{},B:{},X:{},Y:{},Z:{}},uplps:{P1:{},P2:{}},downlps:{P1:{},P2:{}},rr:{EP:{},SL:{},TP:{}}},order:{side:0,entry:{},tp:{},sl:{}},crosshair:{},shark:null,loadWhitespace:!0,interval:null,interval60:null,websocket:null,isAutoOrdering:!1,socketStop:!1,volumeMax:0,socketRefreshTime:moment()};const d=ft({chartDate:D.query.date??v,clock:moment().format("HH:mm:ss"),isFullscreen:!1,color:"#F44336",lineTitle:"",lineColor:"#F44336",showLineContextMenu:!1,showTradingView:!1}),b=ue(()=>n.state.tradingOrder.status),ke=ue(()=>`https://chart.vps.com.vn/tv/?loadLastChart=true&symbol=VN30F1M&u=${n.state.tradingOrder.config.vpsCode}&s=${n.state.tradingOrder.config.vpsSession}&resolution=1`);n.dispatch("tradingOrder/initChart").then(K),n.dispatch("tradingOrder/getStatus"),e.interval=setInterval(_e,1e3),e.interval60=setInterval(()=>n.dispatch("tradingOrder/getStatus"),6e4),R.create(),ht(()=>{e.chart=St(te.value,y),e.chart.subscribeCrosshairMove(Se),e.chart.subscribeCustomPriceLineDragged(xe),e.series.whitespace=e.chart.addLineSeries({priceScaleId:"whitespace",visible:!1}),e.series.active=e.chart.addLineSeries({priceScaleId:"volume",scaleMargins:{top:.61,bottom:.01},color:"blue",lastValueVisible:!1}),e.series.foreign=e.chart.addLineSeries({priceScaleId:"volume",scaleMargins:{top:.61,bottom:.01},color:"yellow",lastValueVisible:!1}),e.series.vn30=e.chart.addLineSeries({color:"red",priceFormat:{minMove:.1}}),e.series.price=e.chart.addLineSeries({color:"white",priceFormat:{minMove:.1}}),new ResizeObserver(Le).observe(x.value),document.addEventListener("keydown",Pe),document.addEventListener("fullscreenchange",Re),n.dispatch("tradingOrder/getChartData",d.chartDate).then(()=>{Ee()})}),mt(()=>{clearInterval(e.interval),clearInterval(e.interval60),e.socketStop=!0,e.websocket.close(),e.websocket=null}),gt(()=>n.state.tradingOrder.chartData,Ae);function Te(t){Me(),I(t)}function I(t){t.preventDefault(),t.stopPropagation()}function be(t){d.showLineContextMenu=!1,G(),_.value.classList.contains("selected")?Ne():Y.value.classList.contains("selected")?Ue():z.value.classList.contains("selected")?ne():Z.value.classList.contains("selected")?ce():X.value.classList.contains("selected")&&et(),I(t)}function Se(t){if(t.time){let i=t.seriesPrices.get(e.series.price);e.crosshair.time=t.time,e.crosshair.price=i}else A.phone||(e.crosshair.time=null,e.crosshair.price=null);t.point!=null&&(e.crosshair.x=t.point.x,e.crosshair.y=t.point.y)}function xe(t){let i=t.customPriceLine,r=i.options();r.price=J(r.price);const o=+t.fromPriceString,l=r.price;switch(r.lineType){case"order":if(l!=o){let a=!1;r.kind=="entry"?b.value.position||(a=!0,e.order[r.kind].price=l,n.dispatch("tradingOrder/executeOrder",{action:"entry",data:{cmd:"change",price:e.order.entry.price}}).then(s=>{s.isOk?(L(r.kind),C.success(u("trading.orderChart.changeEntrySuccess"))):(i.applyOptions({price:o}),k(s.message))})):(a=!0,e.order[r.kind].price=l,r.kind=="tp"?n.dispatch("tradingOrder/executeOrder",{action:"tp",data:{cmd:"change",price:e.order.tp.price}}).then(s=>{s.isOk?(L(r.kind),C.success(u("trading.orderChart.changeTpSuccess"))):(i.applyOptions({price:o}),k(s.message))}):n.dispatch("tradingOrder/executeOrder",{action:"sl",data:{cmd:"change",price:e.order.sl.price}}).then(s=>{s.isOk?(L(r.kind),C.success(u("trading.orderChart.changeSlSuccess"))):(i.applyOptions({price:o}),k(s.message))})),a||(i.applyOptions({price:o}),C.show(u("trading.orderChart.noChangeOrderLine")))}break;case"line":n.dispatch("tradingOrder/drawTools",{isRemove:!1,name:r.lineType,points:[o],data:[r]}),_.value.classList.remove("selected");break;case"target":if(p.isSet(e.tools.target.B)){let a={isRemove:!1,symbol:d.symbol,name:"target",points:[],data:[]},s;const c=+e.tools.target.A.options().price,h=+e.tools.target.B.options().price-c;r.point=="A"&&(s="A",a.points.push(s),a.data.push(e.tools.target[s].options())),s="B",e.tools.target[s].applyOptions({title:(100*h/c).toFixed(1)+"%"}),a.points.push(s),a.data.push(e.tools.target[s].options()),s="X",e.tools.target[s].applyOptions({price:+(c-.5*h).toFixed(2),title:(100*-.5*h/c).toFixed(1)+"%"}),a.points.push(s),a.data.push(e.tools.target[s].options()),s="Y",e.tools.target[s].applyOptions({price:+(c-h).toFixed(2),title:(100*-h/c).toFixed(1)+"%"}),a.points.push(s),a.data.push(e.tools.target[s].options()),s="Z",e.tools.target[s].applyOptions({price:+(c-2*h).toFixed(2),title:(100*-2*h/c).toFixed(1)+"%"}),a.points.push(s),a.data.push(e.tools.target[s].options()),n.dispatch("tradingOrder/drawTools",a)}break;case"rr":if(p.isSet(e.tools.target.B)){let a={isRemove:!1,symbol:d.symbol,name:"target",points:[],data:[]},s;const c=+e.tools.target.A.options().price,h=+e.tools.target.B.options().price-c;r.point=="A"&&(s="A",a.points.push(s),a.data.push(e.tools.target[s].options()),R.set("target",e.tools.target[s].options())),s="B",e.tools.target[s].applyOptions({title:(100*h/c).toFixed(1)+"%"}),a.points.push(s),a.data.push(e.tools.target[s].options()),s="X",e.tools.target[s].applyOptions({price:+(c-.5*h).toFixed(2),title:(100*-.5*h/c).toFixed(1)+"%"}),a.points.push(s),a.data.push(e.tools.target[s].options()),s="Y",e.tools.target[s].applyOptions({price:+(c-h).toFixed(2),title:(100*-h/c).toFixed(1)+"%"}),a.points.push(s),a.data.push(e.tools.target[s].options()),s="Z",e.tools.target[s].applyOptions({price:+(c-2*h).toFixed(2),title:(100*-2*h/c).toFixed(1)+"%"}),a.points.push(s),a.data.push(e.tools.target[s].options()),n.dispatch("tradingOrder/drawTools",a)}break}}function Le(){x.value&&(e.chart.resize(x.value.offsetWidth,x.value.offsetHeight),x.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function Pe(t){if(t.ctrlKey||t.metaKey)switch(t.keyCode){case 38:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing+.05});break;case 40:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing-.05});break;case 37:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()-10);break;case 39:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()+10);break;case 96:Ce.value.click();break;case 97:_.value.click();break;case 98:ie.value.click();break;case 99:re.value.click();case 100:se.value.click();break}}function Re(){x.value&&(document.fullscreenElement?(d.isFullscreen=!0,x.value.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(d.isFullscreen=!1,x.value.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}function De(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function Ee(){const t=n.state.tradingOrder.tools;for(const[i,r]of Object.entries(t))switch(i){case"line":Object.values(r).forEach(o=>e.tools.lines.push(e.series.price.createPriceLine(o)));break;case"target":Object.entries(r).forEach(([o,l])=>e.tools.target[o]=e.series.price.createPriceLine(l));break;case"rr":Object.entries(r).forEach(([o,l])=>e.tools.rr[o]=e.series.price.createPriceLine(l));break;default:i.includes("uplps")?Object.entries(r).forEach(([o,l])=>e.tools.uplps[o]=e.series.price.createPriceLine(l)):i.includes("downlps")&&Object.entries(r).forEach(([o,l])=>e.tools.downlps[o]=e.series.price.createPriceLine(l));break}}function Ae(){e.loadWhitespace&&(n.state.tradingOrder.chartData.price.length>0&&(e.data.whitespace=$(e.data.whitespace,Fe())),e.series.whitespace.setData(e.data.whitespace),e.loadWhitespace=!1),e.data.price=$(n.state.tradingOrder.chartData.price,e.data.price),e.data.vn30=$(n.state.tradingOrder.chartData.vn30,e.data.vn30),e.data.foreign=$(n.state.tradingOrder.chartData.foreign,e.data.foreign),e.data.active=$(n.state.tradingOrder.chartData.active,e.data.active),e.series.price.setData(e.data.price),e.series.vn30.setData(e.data.vn30),e.series.foreign.setData(e.data.foreign),e.series.active.setData(e.data.active)}function $e(t){const i=e.data.original.length;if(e.data.original=$(e.data.original,[t]),e.data.original.length>i){const r=e.data.price.slice(-1)[0].value,o=e.data.cash.slice(-1)[0].value,l=t.price-r,a=l>0?1:l<0?-1:0,s={time:t.time,value:t.price},c={time:t.time,value:o+a*t.volume};e.data.price.push(s),e.series.price.update(s),e.data.cash.push(c),e.series.cash.update(c)}}function Fe(){const t=d.chartDate,i=moment(`${t} 09:00:00`).unix(),r=moment(`${t} 11:30:00`).unix(),o=moment(`${t} 13:00:00`).unix(),l=moment(`${t} 14:30:00`).unix();let a=[],s;for(s=i;s<=r;s++)a.push({time:s+7*60*60});for(s=o;s<=l;s++)a.push({time:s+7*60*60});return a}function $(t,i){return Array.from(new Map([...t,...i].sort((r,o)=>r.time-o.time).map(r=>[r.time,r])).values())}function K(){e.websocket=new WebSocket(Vt),e.websocket.onopen=t=>{let i={action:"join",list:n.state.tradingOrder.config.symbol};e.websocket.send(`42${JSON.stringify(["regs",JSON.stringify(i)])}`)},e.websocket.onclose=t=>{if(e.socketStop)return!1;N()&&(oe(!0),K(),moment().diff(e.socketRefreshTime,"seconds")>Wt&&Q())},e.websocket.onmessage=t=>{if(oe(!1),t.data.substr(0,1)==4&&t.data.substr(1,1)==2){const i=JSON.parse(t.data.substr(2));if(i[0]=="stockps"){const r=i[1].data;r.id==3220&&(e.data.original.length>0&&$e({time:moment(`${v} ${r.time}`).unix()+7*60*60,price:r.lastPrice,volume:r.lastVol}),ot(),st())}}}}function _e(){const t=moment().unix();N(t)&&(b.value.position&&t>f.ATC-5*60&&(Be(),t>f.ATC-15&&e.order.tp.hasOwnProperty("line")&&n.dispatch("tradingOrder/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(i=>{i.isOk?(w("entry"),w("tp"),w("sl"),P(!1),R.clear("order"),C.success(u("trading.orderChart.autoCancelTpSlSuccess")),W()):k(i.message)})),t==f.START&&K()),d.clock=moment().format("HH:mm:ss")}function Me(){if(n.state.tradingOrder.config.openingMarket){const t=moment().unix();if(N(t)&&(e.order.tp.hasOwnProperty("line")||b.value.position&&t>f.ATO&&t<f.ATC&&(e.order.entry.price=e.data.price.slice(-1)[0].value,e.order.side=b.value.position,B.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-61?-61:1))+"px",B.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-51?-51:1))+"px",B.value.style.display="block"),!e.order.entry.hasOwnProperty("line"))){let i=null,r=0;b.value.position?(t<f.ATO?i="ATO":t>f.ATC&&(i="ATC"),i&&(e.order.entry.price=i,r=-b.value.position)):t>f.ATO&&t<f.ATC&&(i=V(e.crosshair.y),r=i>=e.data.price.slice(-1)[0].value?1:-1,e.order.side=r,e.order.entry.price=i),r&&(E.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-71?-71:1))+"px",E.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-61?-61:1))+"px",E.value.style.background=r>0?"green":"red",E.value.innerText=`${r>0?"LONG":"SHORT"} ${i}`,E.value.style.display="block")}}}function G(){E.value.style.display="none",B.value.style.display="none"}function P(t){M.value.style.display=t?"block":"none"}function Be(){M.value.classList.contains("blink")||M.value.classList.add("blink")}function oe(t){t?F.value.classList.contains("blink")||F.value.classList.add("blink"):F.value.classList.contains("blink")&&F.value.classList.remove("blink")}function L(t){let i,r;switch(t){case"entry":i="yellow",r=e.order.side>0?"LONG":"SHORT";break;case"tp":i="lime",r=Math.abs(e.order.tp.price-e.order.entry.price).toFixed(1);break;case"sl":i="red",r=Math.abs(e.order.sl.price-e.order.entry.price).toFixed(1);break}e.order[t].hasOwnProperty("line")?e.order[t].line.applyOptions({price:e.order[t].price,title:r}):e.order[t].line=e.series.price.createPriceLine({lineType:"order",kind:t,price:e.order[t].price,color:i,lineWidth:1,lineStyle:0,title:r,draggable:!0}),R.set("order",{kind:t,price:+e.order[t].price,side:e.order.side})}function w(t){e.order[t].hasOwnProperty("line")&&(e.series.price.removePriceLine(e.order[t].line),delete e.order[t].line)}function je(t){d.showTradingView=!d.showTradingView,t.stopPropagation()}function qe(t){d.showLineContextMenu=!1;const i=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(r=>r.classList.remove("selected")),i||t.target.classList.add("selected")}function Ie(t){d.showLineContextMenu=!d.showLineContextMenu}function Ne(t=null,i=!1,r=!1){const o="line";t||(t=J(V(e.crosshair.y)));const l=e.tools.lines.length;if(e.tools.lines=e.tools.lines.filter(a=>{const s=a.options(),c=s.type=t==+s.price;return c&&(e.series.price.removePriceLine(a),n.dispatch("tradingOrder/drawTools",{isRemove:!0,name:o,point:t})),!c}),e.tools.lines.length==l&&!r||i){const a={lineType:o,price:t,color:d.lineColor,title:d.lineTitle,lineWidth:1,lineStyle:1,draggable:!0};e.tools.lines.push(e.series.price.createPriceLine(a)),n.dispatch("tradingOrder/drawTools",{isRemove:!1,name:o,points:[t],data:[a]})}_.value.classList.remove("selected")}function Ve(t=!0){e.tools.lines.length>0&&(e.tools.lines.forEach(i=>e.series.price.removePriceLine(i)),e.tools.lines=[],t&&n.dispatch("tradingOrder/drawTools",{isRemove:!0,name:"line",point:null}))}function We(t){d.showLineContextMenu=!1;const i=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(r=>r.classList.remove("selected")),i||(t.target.classList.add("selected"),ae())}function He(t){ae(),t.target.classList.remove("selected")}function Ue(){const t="target",i=V(e.crosshair.y);let r={lineType:t,price:i,lineWidth:1,lineStyle:1,draggable:!0},o={isRemove:!1,name:t,points:[],data:[]};if(p.isSet(e.tools.target.A)){const l=+e.tools.target.A.options().price,a=i-l;r.point="B",r.title=(100*a/l).toFixed(1)+"%",r.color="#FF9800",e.tools.target[r.point]=e.series.price.createPriceLine(r),o.points.push(r.point),o.data.push(p.cloneDeep(r)),r.point="X",r.price=+(l-.5*a).toFixed(2),r.title=(100*-.5*a/l).toFixed(1)+"%",r.color="#2196F3",e.tools.target[r.point]=e.series.price.createPriceLine(r),o.points.push(r.point),o.data.push(p.cloneDeep(r)),r.point="Y",r.price=+(l-a).toFixed(2),r.title=(100*-a/l).toFixed(1)+"%",r.color="#673AB7",e.tools.target[r.point]=e.series.price.createPriceLine(r),o.points.push(r.point),o.data.push(p.cloneDeep(r)),r.point="Z",r.price=+(l-2*a).toFixed(2),r.title=(100*-2*a/l).toFixed(1)+"%",r.color="#673AB7",e.tools.target[r.point]=e.series.price.createPriceLine(r),o.points.push(r.point),o.data.push(p.cloneDeep(r)),Y.value.classList.remove("selected")}else r.point="A",r.title="0",r.color="#FF9800",e.tools.target[r.point]=e.series.price.createPriceLine(r),o.points.push(r.point),o.data.push(p.cloneDeep(r));n.dispatch("tradingOrder/drawTools",o)}function ae(t=!0){p.isSet(e.tools.target.A)&&(e.series.price.removePriceLine(e.tools.target.A),p.isSet(e.tools.target.B)&&(e.series.price.removePriceLine(e.tools.target.B),e.series.price.removePriceLine(e.tools.target.X),e.series.price.removePriceLine(e.tools.target.Y),e.series.price.removePriceLine(e.tools.target.Z)),e.tools.target={A:{},B:{},X:{},Y:{},Z:{}}),t&&n.dispatch("tradingOrder/drawTools",{isRemove:!0,name:"target"})}function Ye(t){d.showLineContextMenu=!1;const i=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(r=>r.classList.remove("selected")),i?ne():t.target.classList.add("selected")}function Xe(t){le(),t.target.classList.remove("selected")}function ne(){let t,i;const r="price",o="P";p.isSet(e.tools.uplps[`${o}1`])?(t=+e.tools.uplps[`${o}1`].options().startTime,i=e.crosshair.time,le(!1)):t=e.crosshair.time;const{value1:l,value2:a}=ze(t,i);let s={lineWidth:1,lineStyle:1,color:"#009688",draggable:!1},c={isRemove:!1,name:`${r}uplps`,points:[],data:[]};s.startTime=t,s.price=l,s.title=`${o}1`,e.tools.uplps[s.title]=e.series[r].createPriceLine(s),c.points.push(s.title),c.data.push(p.cloneDeep(s)),s.price=a,s.title=`${o}2`,e.tools.uplps[s.title]=e.series[r].createPriceLine(s),c.points.push(s.title),c.data.push(p.cloneDeep(s)),n.dispatch("tradingOrder/drawTools",c),z.value.classList.remove("selected")}function ze(t,i){let r,o,l,a=0,s=0;const c=e.data.price;for(let T=0;T<c.length;T++){const h=c[T].time;if(h<t)continue;if(i&&h>i)break;const g=c[T].value;if(r==null&&(r=g,o=g,l=g),g>l)a>s&&(o=l,s=a),l=g,a=0;else if(g<l){const j=+(l-g).toFixed(2);j>a&&(a=j)}if(g<r&&s>0)break}return{value1:+(o-s).toFixed(2),value2:+(l-s).toFixed(2)}}function le(t=!0){const i="price",r="P",o=`${r}1`,l=`${r}2`;p.isSet(e.tools.uplps[o])&&(e.series[i].removePriceLine(e.tools.uplps[o]),e.series[i].removePriceLine(e.tools.uplps[l])),e.tools.uplps[o]={},e.tools.uplps[l]={},t&&n.dispatch("tradingOrder/drawTools",{isRemove:!0,name:`${i}uplps`})}function Ze(t){d.showLineContextMenu=!1;const i=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(r=>r.classList.remove("selected")),i?ce():t.target.classList.add("selected")}function Ke(t){de(),t.target.classList.remove("selected")}function ce(){let t,i;const r="price",o="P";p.isSet(e.tools.downlps[`${o}1`])?(t=+e.tools.downlps[`${o}1`].options().startTime,i=e.crosshair.time,de()):t=e.crosshair.time;const{value1:l,value2:a}=Ge(t,i);let s={lineWidth:1,lineStyle:1,color:"#E91E63",draggable:!1},c={isRemove:!1,name:`${r}downlps`,points:[],data:[]};s.startTime=t,s.price=l,s.title=`${o}1`,e.tools.downlps[s.title]=e.series[r].createPriceLine(s),c.points.push(s.title),c.data.push(p.cloneDeep(s)),s.price=a,s.title=`${o}2`,e.tools.downlps[s.title]=e.series[r].createPriceLine(s),c.points.push(s.title),c.data.push(p.cloneDeep(s)),n.dispatch("tradingOrder/drawTools",c),Z.value.classList.remove("selected")}function Ge(t,i){let r,o,l,a=0,s=0;const c=e.data.price;for(let T=0;T<c.length;T++){const h=c[T].time;if(h<t)continue;if(i&&h>i)break;const g=c[T].value;if(r==null&&(r=g,o=g,l=g),g<l)a<s&&(o=l,s=a),l=g,a=0;else if(g>l){const j=+(l-g).toFixed(2);j<a&&(a=j)}if(g>r&&s<0)break}return{value1:+(o-s).toFixed(2),value2:+(l-s).toFixed(2)}}function de(t=!0){const i="price",r="P",o=`${r}1`,l=`${r}2`;p.isSet(e.tools.downlps[o])&&(e.series[i].removePriceLine(e.tools.downlps[o]),e.series[i].removePriceLine(e.tools.downlps[l])),e.tools.downlps[o]={},e.tools.downlps[l]={},t&&n.dispatch("tradingOrder/drawTools",{isRemove:!0,name:`${i}downlps`})}function Je(t){d.showLineContextMenu=!1;const i=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command:not(.drawless)").forEach(r=>r.classList.remove("selected")),i||(t.target.classList.add("selected"),pe())}function Qe(t){pe(),t.target.classList.remove("selected")}function et(){const t="rr",i=V(e.crosshair.y);let r={lineType:t,price:i,lineWidth:1,lineStyle:1,draggable:!0},o={isRemove:!1,name:t,points:[],data:[]};if(p.isSet(e.tools.rr.EP)){const l=+e.tools.rr.EP.options().price;if(p.isSet(e.tools.rr.SL)){const s=+e.tools.rr.SL.options().price-l,c=i-l;if(c/s>0)return!1;const T=c/l*100;r.point="TP",r.title=`TP=${T.toFixed(1)}%`,r.color="lime",e.tools.rr[r.point]=e.series.price.createPriceLine(r),o.points.push(r.point),o.data.push(p.cloneDeep(r));const h=Math.abs(c)/Math.abs(s),g="EP";e.tools.rr[g].applyOptions({title:`RR=${h.toFixed(1)}`}),o.points.push(g),o.data.push(e.tools.rr[g].options()),X.value.classList.remove("selected")}else{const a=(i-l)/l*100;r.point="SL",r.title=`SL=${a.toFixed(1)}%`,r.color="red",e.tools.rr[r.point]=e.series.price.createPriceLine(r),o.points.push(r.point),o.data.push(p.cloneDeep(r))}}else r.point="EP",r.title="RR=",r.color="yellow",e.tools.rr[r.point]=e.series.price.createPriceLine(r),o.points.push(r.point),o.data.push(p.cloneDeep(r));n.dispatch("tradingOrder/drawTools",o)}function pe(t=!0){p.isSet(e.tools.rr.EP)&&(e.series.price.removePriceLine(e.tools.rr.EP),p.isSet(e.tools.rr.SL)&&(e.series.price.removePriceLine(e.tools.rr.SL),p.isSet(e.tools.rr.TP)&&e.series.price.removePriceLine(e.tools.rr.TP))),e.tools.rr={EP:{},SL:{},TP:{}},t&&n.dispatch("tradingOrder/drawTools",{isRemove:!0,name:"rr"})}async function tt(){e.order.entry.hasOwnProperty("line")&&(e.order.tp.hasOwnProperty("line")?n.dispatch("tradingOrder/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(t=>{t.isOk?(w("entry"),w("tp"),w("sl"),P(!1),R.clear("order"),C.success(u("trading.orderChart.exitSuccess"))):(P(!0),k(t.message))}):n.dispatch("tradingOrder/executeOrder",{action:"entry",data:{cmd:"delete"}}).then(t=>{t.isOk?(w("entry"),P(!1),R.clear("order"),C.success(u("trading.orderChart.deleteEntrySuccess"))):(P(!0),k(t.message))}))}function rt(){const t=moment().unix();N(t)&&(t<f.ATO?ge(u("trading.orderChart.atoOrder"),u("titles.confirm")).then(r=>{r&&n.dispatch("tradingOrder/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(o=>{o.isOk?C.success(u("trading.orderChart.atoOrderSuccess")):k(o.message)})}):t<f.ATC?n.dispatch("tradingOrder/executeOrder",{action:"entry",data:{cmd:"new",side:e.order.side,price:e.order.entry.price}}).then(i=>{i.isOk?(L("entry"),P(!0),C.success(u("trading.orderChart.newEntrySuccess"))):k(i.message)}):ge(u("trading.orderChart.atcOrder"),u("titles.confirm")).then(r=>{r&&n.dispatch("tradingOrder/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(o=>{o.isOk?C.success(u("trading.orderChart.atcOrderSuccess")):k(o.message)})}))}function it(){e.order.tp.price=e.order.entry.price+e.order.side*ve,e.order.sl.price=e.order.entry.price-e.order.side*ye,n.dispatch("tradingOrder/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.order.tp.price},slData:{cmd:"new",price:e.order.sl.price}}).then(t=>{t.isOk?(L("entry"),L("tp"),L("sl"),e.order.entry.line.applyOptions({draggable:!1}),C.success(u("trading.orderChart.newTpSlSuccess"))):k(t.message)})}function st(){if(e.order.entry.hasOwnProperty("line")){const t=e.data.price.slice(-1)[0].value;e.order.tp.hasOwnProperty("line")?((e.order.side>0&&t>=e.order.tp.price||e.order.side<0&&t<=e.order.tp.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,n.dispatch("tradingOrder/executeOrder",{action:"sl",data:{cmd:"delete"}}).then(i=>{i.isOk?(w("entry"),w("tp"),w("sl"),P(!1),R.clear("order"),C.success(u("trading.orderChart.deleteTpSuccess")),G(),W()):k(i.message),e.isAutoOrdering=!1}))),(e.order.side>0&&t<=e.order.sl.price||e.order.side<0&&t>=e.order.sl.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,n.dispatch("tradingOrder/executeOrder",{action:"tp",data:{cmd:"cancel"}}).then(i=>{i.isOk?(w("entry"),w("tp"),w("sl"),P(!1),R.clear("order"),C.success(u("trading.orderChart.deleteSlSuccess")),G(),W()):k(i.message),e.isAutoOrdering=!1})))):(e.order.side>0&&t>=e.order.entry.price||e.order.side<0&&t<=e.order.entry.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,setTimeout(()=>{e.order.tp.price=e.order.entry.price+e.order.side*ve,e.order.sl.price=e.order.entry.price-e.order.side*ye,n.dispatch("tradingOrder/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.order.tp.price},slData:{cmd:"new",price:e.order.sl.price}}).then(i=>{i.isOk?(L("tp"),L("sl"),e.order.entry.line.applyOptions({draggable:!1}),C.success(u("trading.orderChart.autoNewTpSlSuccess")),W()):k(i.message),e.isAutoOrdering=!1})},1e3)))}}function ot(){if(b.value.position&&p.isSet(e.target.X)){const t=e.data.cash.slice(-1)[0].value,i=+e.target.B.options().price,r=+e.target.X.options().price,o=r-i;(o>0&&t>=r||o<0&&t<=r)&&M.value.click()}}function at(){e.chart.timeScale().scrollToRealTime()}function N(t=null){return t||(t=moment().unix()),t>=f.START&&t<=f.END}function V(t,i="price"){return J(e.series[i].coordinateToPrice(t))}function J(t){return t?+ +t.toFixed(1):0}function k(t){t||(t="unknown"),C.error(u(`trading.orderChart.${t}`))}function nt(){e.loadWhitespace=!0,n.dispatch("tradingOrder/getChartData",d.chartDate)}function Q(){e.socketRefreshTime=moment(),e.loadWhitespace=!0,n.dispatch("tradingOrder/getChartData",d.chartDate)}function lt(){e.data.original=[],e.data.price=[],e.data.cash=[],e.data.whitespace=[],Q()}function W(){let t=new Audio(Lt);t.crossOrigin="anonymous",t.addEventListener("canplaythrough",function(){t.play()})}function ct(){n.dispatch("tradingOrder/getAccountInfo").then(t=>{let i="";i+='<div style="width: 200px;">',i+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${u("trading.orderChart.nav")}</div><div>: ${S.currency(t.nav)}</div></div>`,i+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${u("trading.orderChart.maxVol")}</div><div>: ${S.numberVnFormat(t.maxVol)}</div></div>`,i+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${u("trading.orderChart.vm")}</div><div>: ${S.currency(t.vm)}</div></div>`,i+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${u("trading.orderChart.fee")}</div><div>: ${S.currency(t.fee)}</div></div>`,i+="</div>",wt(i,u("trading.orderChart.accountInfo"))})}function dt(){q.emit("checkPin",()=>n.dispatch("tradingOrder/report"))}function pt(){q.emit("checkPin",()=>n.dispatch("tradingOrder/export"))}return(t,i)=>{const r=kt("DxToolbar");return Tt(),vt("div",Pt,[fe(r,{items:[{location:"before",widget:"dxButton",options:{icon:"far fa-flag-checkered small",hint:t.$t("trading.orderChart.buttons.report"),onClick:dt}},{location:"before",widget:"dxButton",options:{icon:"far fa-file-export small",hint:t.$t("trading.orderChart.buttons.export"),onClick:pt}}]},null,8,["items"]),m("div",{class:"order-chart-container",ref_key:"chartContainerRef",ref:x,onClick:be,onContextmenu:Te},[m("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:te},[m("div",{class:"area data-area",onClick:I},[m("div",{ref_key:"connectionRef",ref:F,class:H(`command far fa-${b.value.connection?"link":"unlink"}`),title:t.$t("trading.orderChart.connection"),onClick:i[0]||(i[0]=()=>t.$store.dispatch("tradingOrder/getStatus"))},null,10,Rt),m("div",{class:H(["command status",{green:b.value.position>0,red:b.value.position<0,pending:b.value.pending}]),title:t.$t("trading.orderChart.position"),onClick:ct},he(b.value.position),11,Dt),m("div",{class:"command clock",onClick:Q},he(d.clock),1),ee(m("input",{type:"date",class:"chart-date command",title:t.$t("trading.orderChart.date"),"onUpdate:modelValue":i[1]||(i[1]=o=>d.chartDate=o),onChange:nt},null,40,Et),[[yt,d.chartDate]]),m("div",{ref_key:"reloadToolRef",ref:ie,class:"command",title:t.$t("trading.orderChart.reload"),onClick:lt},[m("i",{class:H(`far fa-sync-alt ${t.$store.state.tradingOrder.isChartLoading?"fa-spin":""}`)},null,2)],8,At)]),m("div",{class:"area tool-area",onClick:I},[m("div",{ref_key:"fullscreenToolRef",ref:re,class:H(`command far fa-${d.isFullscreen?"compress":"expand"}`),title:t.$t("trading.orderChart.fullscreen"),onClick:De},null,10,$t),m("div",{ref_key:"tradingviewRef",ref:se,class:"command far fa-chart-bar",title:t.$t("trading.orderChart.tradingview"),onClick:je},null,8,Ft),m("div",{ref_key:"lineToolRef",ref:_,class:"line command far fa-horizontal-rule",title:t.$t("trading.orderChart.lineTool"),onClick:qe,onContextmenu:Ie},[ee(fe(bt,{class:"line-contextmenu",enable:d.showLineContextMenu,title:d.lineTitle,"onUpdate:title":i[2]||(i[2]=o=>d.lineTitle=o),color:d.lineColor,"onUpdate:color":i[3]||(i[3]=o=>d.lineColor=o),onDeleteAllLine:Ve},null,8,["enable","title","color"]),[[me,d.showLineContextMenu]])],40,_t),m("div",{ref_key:"uplpsToolRef",ref:z,class:"command far fa-arrow-up",title:t.$t("trading.orderChart.uplpsTool"),onClick:Ye,onContextmenu:Xe},null,40,Mt),m("div",{ref_key:"downlpsToolRef",ref:Z,class:"command far fa-arrow-down",title:t.$t("trading.orderChart.downlpsTool"),onClick:Ze,onContextmenu:Ke},null,40,Bt),m("div",{ref_key:"targetToolRef",ref:Y,class:"command far fa-grip-lines",title:t.$t("trading.orderChart.targetTool"),onClick:We,onContextmenu:He},null,40,jt),m("div",{ref_key:"rrToolRef",ref:X,class:"command far fa-line-height",title:t.$t("trading.orderChart.rrTool"),onClick:Je,onContextmenu:Qe},null,40,qt),m("div",{ref_key:"cancelOrderRef",ref:M,class:"cancel-order command far fa-trash-alt",title:t.$t("trading.orderChart.cancelTool"),onClick:tt},null,8,It)]),m("div",null,[m("div",{ref_key:"entryOrderRef",ref:E,class:"order-button entry",onClick:rt}," Entry ",512),m("div",{ref_key:"tpslOrderRef",ref:B,class:"order-button tpsl",onClick:it}," TP/SL ",512),m("div",{class:"chart-top command far fa-angle-double-right",onClick:at})]),ee(m("iframe",{ref_key:"tradingviewChartRef",ref:we,class:"tradingview-chart",src:ke.value},null,8,Nt),[[me,d.showTradingView]])],512)],544)])}}};export{zt as default};
