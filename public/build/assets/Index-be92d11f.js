import{y as Lt,u as Ft,b as At,c as _t,i as re,r as v,d as Rt,e as Pe,x as Et,z as Dt,w as Se,v as k,f as $t,g as Bt,h,j as ie,A as pe,t as Te,B as W,C as Mt,E as qt,G as Y,F as Nt,H as we,I as Vt,o as It}from"./app-5a153ec8.js";import jt from"./CopyistStatusPopup-bee52b01.js";import{c as Wt,_ as Ht}from"./DailyCashFlowPopup-440a90ef.js";import Xt from"./ColorPicker-ddd03e9b.js";const zt="/build/assets/spinner-4da4a8c6.gif";class Ut{constructor(){this.create()}create(){return new Promise((C,y)=>{const m=indexedDB.open("orderChart",1);m.onupgradeneeded=n=>{this.store=n.target.result,this.store.createObjectStore("order",{keyPath:"kind"}),this.store.createObjectStore("line",{keyPath:"price"}),this.store.createObjectStore("box",{keyPath:"point"}),this.store.createObjectStore("ruler",{keyPath:"point"}),this.store.createObjectStore("pattern1",{keyPath:"point"}),this.store.createObjectStore("pattern2",{keyPath:"point"}),this.store.createObjectStore("volprofile",{keyPath:"time"}),this.store.createObjectStore("alert",{keyPath:"price"}),this.store.createObjectStore("target",{keyPath:"price"}),C()},m.onsuccess=n=>{this.store=n.target.result,C()},m.onerror=()=>{location.reload(),y()}})}get(C){var y=this.store;return new Promise(function(n,E){var p=y.transaction(C,"readonly");if(Array.isArray(C)){var V=C.map(L=>p.objectStore(L)),g=V.map(m);Promise.all(g).then(L=>n(L))}else{var K=p.objectStore(C);m(K).then(L=>n(L))}});function m(n){return new Promise(function(E,p){const V=n.getAll();V.onsuccess=g=>E(g.target.result),V.onerror=()=>p()})}}set(C,y){const m=this.store.transaction(C,"readwrite").objectStore(C);Array.isArray(y)?y.length>0&&y.forEach(n=>m.put(n)):m.put(y)}clear(C){var y=this.store;return new Promise(function(m,n){const E=y.transaction(C,"readwrite").objectStore(C).clear();E.onsuccess=()=>{m()},E.onerror=p=>{console.error(`Error to empty Object Store: ${C}`),n()}})}}const o=new Ut,Yt="/build/assets/alert-4d705e53.mp3";const Kt={class:"content-block dx-card responsive-paddings"},Gt={class:"area data-area"},Jt=["title"],Zt=["title"],Qt=["title"],er={class:"area tool-area"},tr=["title"],rr=["title"],ir=["title"],or=["title"],sr=["title"],ar=["title"],nr=["title"],lr=["title"],cr=["title"],dr=["title"],pr=["title"],ur=["title"],fr=["src"],Le=3,Fe=2,hr="wss://datafeed.vps.com.vn/socket.io/?EIO=3&transport=websocket",mr=120,gr={__name:"Index",setup(Ae){const C={localization:{dateFormat:"dd/MM/yyyy",locale:"vi-VN"},rightPriceScale:{visible:!0,scaleMargins:{top:.05,bottom:.4}},leftPriceScale:{visible:!1},layout:{backgroundColor:"#000000",textColor:"#CCCCCC"},grid:{vertLines:{color:"#1B1E27",style:2},horzLines:{color:"#1B1E27",style:2}},crosshair:{mode:0},timeScale:{timeVisible:!0,rightOffset:20,minBarSpacing:.01}},y=moment().format("YYYY-MM-DD"),m={START:moment(y+" 08:45:00").unix(),ATO:moment(y+" 09:00:00").unix(),ATC:moment(y+" 14:30:00").unix(),END:moment(y+" 14:45:00").unix()},n=Ft(),E=At(),{t:p}=_t(),V=re("devices"),g=re("mf"),K=re("bus"),L=re("filters"),w=v(null),ue=v(null),H=v(null),fe=v(null),he=v(null),me=v(null),ge=v(null),_e=v(null),X=v(null),G=v(null),oe=v(null),se=v(null),ae=v(null),J=v(null),z=v(null),D=v(null),U=v(null),Re=v(null);let e={chart:{},series:{},data:{whitespace:[],original:[],price:[],cash:[]},order:{side:0,entry:{},tp:{},sl:{}},lines:[],ruler:{l0:{},ln1:{},l1:{},l2:{},l3:{},pointCount:0},target:{A:{},B:{},C:{},D:{}},pattern1:{A:{},B:{},C:{},X:{}},pattern2:{O:{}},volprofile:{v1:{},v2:{},poc:{},pointCount:0},box:[],alerts:[],crosshair:{},shark:null,loadWhitespace:!0,interval:null,interval60:null,websocket:null,isAutoOrdering:!1,socketStop:!1,volumeMax:0,socketRefreshTime:moment()};const u=Rt({chartDate:E.query.date??y,clock:moment().format("HH:mm:ss"),isFullscreen:!1,color:"#F44336",showColorPicker:!1,showTradingView:!1}),b=Pe(()=>n.state.tradingOrder.status),Ee=Pe(()=>`https://chart.vps.com.vn/tv/?loadLastChart=true&symbol=VN30F1M&u=${n.state.tradingOrder.config.vpsCode}&s=${n.state.tradingOrder.config.vpsSession}&resolution=1`);n.dispatch("tradingOrder/getConfig").then(()=>{le()}),n.dispatch("tradingOrder/getStatus"),e.interval=setInterval(ze,1e3),e.interval60=setInterval(()=>n.dispatch("tradingOrder/getStatus"),6e4),o.create(),Et(()=>{e.chart=Wt(ue.value,C),w.value.addEventListener("click",$e),w.value.addEventListener("contextmenu",De),e.chart.subscribeCrosshairMove(Be),e.chart.subscribeCustomPriceLineDragged(Me),e.series.whitespace=e.chart.addLineSeries({priceScaleId:"whitespace",visible:!1}),e.series.cash=e.chart.addLineSeries({priceScaleId:"cash",scaleMargins:{top:.61,bottom:.01},color:"yellow",lastValueVisible:!1}),e.series.price=e.chart.addLineSeries({color:"#CCCCCC",priceFormat:{minMove:.1}}),new ResizeObserver(qe).observe(w.value),document.addEventListener("keydown",Ne),document.addEventListener("fullscreenchange",Ve),n.dispatch("tradingOrder/getChartData",u.chartDate).then(()=>{je()})}),Dt(()=>{clearInterval(e.interval),clearInterval(e.interval60),e.socketStop=!0,e.websocket.close(),e.websocket=null}),Se(()=>n.state.tradingOrder.chartData,We),Se(()=>n.state.tradingOrder.isChartLoading,t=>{fe.value.style.display=t?"block":"none"});function De(t){Ue(),t.preventDefault()}function $e(){ce(),X.value.classList.contains("selected")?I():G.value.classList.contains("selected")?it():oe.value.classList.contains("selected")?at():se.value.classList.contains("selected")?ct():ae.value.classList.contains("selected")?ke():J.value.classList.contains("selected")&&mt()}function Be(t){if(t.time){let r=t.seriesPrices.get(e.series.price);e.crosshair.time=t.time,e.crosshair.price=r}else V.phone||(e.crosshair.time=null,e.crosshair.price=null);t.point!=null&&(e.crosshair.x=t.point.x,e.crosshair.y=t.point.y)}function Me(t){let r=t.customPriceLine,i=r.options();i.price=Q(i.price);const s=+t.fromPriceString,c=i.price;switch(i.lineType){case"order":if(c!=s){let f=!1;i.kind=="entry"?b.value.position||(f=!0,e.order[i.kind].price=c,n.dispatch("tradingOrder/executeOrder",{action:"entry",data:{cmd:"change",price:e.order.entry.price}}).then(l=>{l.isOk?(F(i.kind),k.success(p("trading.orderChart.changeEntrySuccess"))):(r.applyOptions({price:s}),S(l.message))})):(f=!0,e.order[i.kind].price=c,i.kind=="tp"?n.dispatch("tradingOrder/executeOrder",{action:"tp",data:{cmd:"change",price:e.order.tp.price}}).then(l=>{l.isOk?(F(i.kind),k.success(p("trading.orderChart.changeTpSuccess"))):(r.applyOptions({price:s}),S(l.message))}):n.dispatch("tradingOrder/executeOrder",{action:"sl",data:{cmd:"change",price:e.order.sl.price}}).then(l=>{l.isOk?(F(i.kind),k.success(p("trading.orderChart.changeSlSuccess"))):(r.applyOptions({price:s}),S(l.message))})),f||(r.applyOptions({price:s}),k.show(p("trading.orderChart.noChangeOrderLine")))}break;case"line":o.set("line",{price:s,removed:!0}),o.set("line",i),X.value.classList.remove("selected");break;case"ruler":switch(i.point){case"l0":if(o.set("ruler",i),e.ruler.pointCount==2){const j=+e.ruler.l1.options().title,M=+(c-j).toFixed(1);e.ruler.ln1.applyOptions({price:M}),o.set("ruler",e.ruler.ln1.options());const q=+(c+j).toFixed(1);e.ruler.l1.applyOptions({price:q}),o.set("ruler",e.ruler.l1.options());const N=+(c+j*2).toFixed(1);e.ruler.l2.applyOptions({price:N}),o.set("ruler",e.ruler.l2.options());const te=+(c+j*3).toFixed(1);e.ruler.l3.applyOptions({price:te}),o.set("ruler",e.ruler.l3.options())}break;case"ln1":const f=+e.ruler.l0.options().price,l=c-f;r.applyOptions({title:l.toFixed(1)}),o.set("ruler",r.options()),e.ruler.l1.applyOptions({title:(-l).toFixed(1),price:+(f-l).toFixed(1)}),o.set("ruler",e.ruler.l1.options()),e.ruler.l2.applyOptions({title:(-l*2).toFixed(1),price:+(f-l*2).toFixed(1)}),o.set("ruler",e.ruler.l2.options()),e.ruler.l3.applyOptions({title:(-l*3).toFixed(1),price:+(f-l*3).toFixed(1)}),o.set("ruler",e.ruler.l3.options());break;case"l1":const O=+e.ruler.l0.options().price,x=c-O;r.applyOptions({title:x.toFixed(1)}),o.set("ruler",r.options()),e.ruler.ln1.applyOptions({title:(-x).toFixed(1),price:+(O-x).toFixed(1)}),o.set("ruler",e.ruler.ln1.options()),e.ruler.l2.applyOptions({title:(x*2).toFixed(1),price:+(O+x*2).toFixed(1)}),o.set("ruler",e.ruler.l2.options()),e.ruler.l3.applyOptions({title:(x*3).toFixed(1),price:+(O+x*3).toFixed(1)}),o.set("ruler",e.ruler.l3.options());break;case"l2":const R=+e.ruler.l0.options().price,T=c-R;r.applyOptions({title:T.toFixed(1)}),o.set("ruler",r.options()),e.ruler.ln1.applyOptions({title:(-T*.5).toFixed(1),price:+(R-T*.5).toFixed(1)}),o.set("ruler",e.ruler.ln1.options()),e.ruler.l1.applyOptions({title:(T*.5).toFixed(1),price:+(R+T*.5).toFixed(1)}),o.set("ruler",e.ruler.l1.options()),e.ruler.l3.applyOptions({title:(T*1.5).toFixed(1),price:+(R+T*1.5).toFixed(1)}),o.set("ruler",e.ruler.l3.options());break;case"l3":const B=+e.ruler.l0.options().price,_=c-B;r.applyOptions({title:_.toFixed(1)}),o.set("ruler",r.options()),e.ruler.ln1.applyOptions({title:(-_/3).toFixed(1),price:+(B-_/3).toFixed(1)}),o.set("ruler",e.ruler.ln1.options()),e.ruler.l1.applyOptions({title:(_/3).toFixed(1),price:+(B+_/3).toFixed(1)}),o.set("ruler",e.ruler.l1.options()),e.ruler.l2.applyOptions({title:(_*2/3).toFixed(1),price:+(B+_*2/3).toFixed(1)}),o.set("ruler",e.ruler.l2.options());break}break;case"pattern1":if(g.isSet(e.pattern1.X)){const f=+e.pattern1.A.options().price,l=+e.pattern1.B.options().price,O=+e.pattern1.C.options().price,x=l-f;e.pattern1.X.applyOptions({price:+(O+1.5*x).toFixed(1),title:(1.5*x).toFixed(1)}),o.set("pattern1",e.pattern1.X.options()),["A","B"].includes(i.point)&&(e.pattern1.B.applyOptions({title:x.toFixed(1)}),o.set("pattern1",e.pattern1.B.options()))}break;case"pattern2":if(g.isSet(e.pattern2.T)){const f=e.pattern2.E.options(),l=+f.price1,O=+f.price2,x=+f.price3,R=+f.price4,T=+f.price,B=x-O,_=l-R,j=x-R,M=T-R;let q,N;i.point=="S"?(N=+e.pattern2.S.options().price,q=T-N):(q=Math.abs(B)>Math.abs(M/2)?B:M/2,N=T-q,e.pattern2.S.applyOptions({price:+N.toFixed(1)}));const te=N+(Math.abs(M)>Math.abs(j)?Math.abs(M)>Math.abs(_)?1:1.5:2)*M,be=te-T;e.pattern2.S.applyOptions({title:`SL=${(-q).toFixed(1)}`}),o.set("pattern2",e.pattern2.S.options()),e.pattern2.E.applyOptions({title:`RR=${(be/q).toFixed(1)}`}),o.set("pattern2",e.pattern2.E.options()),e.pattern2.T.applyOptions({price:+te.toFixed(1),title:`TP=${be.toFixed(1)}`}),o.set("pattern2",e.pattern2.T.options())}break;case"alert":o.set("alert",{price:s,removed:!0});const a=e.data.price.slice(-1)[0].value;let d=c>=a?">":"<";r.applyOptions({title:d}),o.set("alert",r.options()),J.value.classList.remove("selected");break}}function qe(){w.value&&(e.chart.resize(w.value.offsetWidth,w.value.offsetHeight),w.value.classList.contains("fullscreen")&&(document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"))}function Ne(t){if(t.ctrlKey||t.metaKey)switch(t.keyCode){case 38:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing+.05});break;case 40:e.chart.timeScale().applyOptions({barSpacing:e.chart.options().timeScale.barSpacing-.05});break;case 37:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()-10);break;case 39:e.chart.timeScale().scrollToPosition(e.chart.timeScale().scrollPosition()+10);break;case 96:G.value.click();break;case 97:X.value.click();break;case 98:me.value.click();break;case 99:he.value.click();case 100:ge.value.click();break}}function Ve(){w.value&&(document.fullscreenElement?(u.isFullscreen=!0,w.value.classList.add("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="hidden",document.querySelector(".header-component").style.visibility="hidden",document.querySelector(".sc-launcher").style.visibility="hidden",document.querySelector(".dx-drawer-content").style.transform="unset"):(u.isFullscreen=!1,w.value.classList.remove("fullscreen"),document.querySelector(".dx-drawer-panel-content").style.visibility="unset",document.querySelector(".header-component").style.visibility="unset",document.querySelector(".sc-launcher").style.visibility="unset",document.querySelector(".dx-drawer-content").style.transform="translate(0px, 0px)"))}function Ie(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function je(){return new Promise(async t=>{b.value.pending&&((await o.get("order")).map(O=>{e.order.side=O.side,e.order[O.kind].price=O.price,F(O.kind),A(!0)}),e.order.tp.hasOwnProperty("line")&&e.order.entry.line.applyOptions({draggable:!1})),(await o.get("line")).forEach(l=>{l.removed||e.lines.push(e.series.price.createPriceLine(l))});const i=await o.get("box");i.length==2&&(e.box=i,e.series.box.setData([i[0].x,i[1].x]),e.box[0].y=e.series.price.createPriceLine(i[0].y),e.box[1].y=e.series.price.createPriceLine(i[1].y));const s=await o.get("ruler");s.length>0&&(e.ruler.pointCount=s.length>1?2:1,s.forEach(l=>{e.ruler[l.point]=e.series.price.createPriceLine(l)}));const c=await o.get("target");c.length>0&&c.forEach(l=>{e.target[l.point]=e.series.cash.createPriceLine(l)});const a=await o.get("pattern1");a.length>0&&a.forEach(l=>{e.pattern1[l.point]=e.series.price.createPriceLine(l)});const d=await o.get("pattern2");d.length>0&&d.forEach(l=>{e.pattern2[l.point]=e.series.price.createPriceLine(l)}),(await o.get("alert")).forEach(l=>{l.removed||e.alerts.push(e.series.price.createPriceLine(l))}),t()})}function We(){e.loadWhitespace&&(n.state.tradingOrder.chartData.length>0&&(e.data.whitespace=ne(e.data.whitespace,Xe())),e.series.whitespace.setData(e.data.whitespace),e.loadWhitespace=!1),e.data.original=ne(n.state.tradingOrder.chartData,e.data.original);let t=e.data.original.reduce((r,i)=>{let s=i.price,c=0;r.price.length>0&&(s=r.price.slice(-1)[0].value,c=r.cash.slice(-1)[0].value);const a=i.price-s,d=a>0?1:a<0?-1:0;return r.price.push({time:i.time,value:i.price}),r.cash.push({time:i.time,value:c+d*i.volume}),r},{price:[],cash:[]});e.data.price=t.price,e.series.price.setData(t.price),e.data.cash=t.cash,e.series.cash.setData(t.cash)}function He(t){const r=e.data.original.length;if(e.data.original=ne(e.data.original,[t]),e.data.original.length>r){const i=e.data.price.slice(-1)[0].value,s=e.data.cash.slice(-1)[0].value,c=t.price-i,a=c>0?1:c<0?-1:0;e.data.price.push({time:t.time,value:t.price}),e.series.price.setData(e.data.price),e.data.cash.push({time:t.time,value:s+a*t.volume}),e.series.cash.setData(e.data.cash)}}function Xe(){const t=u.chartDate,r=moment(`${t} 09:00:00`).unix(),i=moment(`${t} 11:30:00`).unix(),s=moment(`${t} 13:00:00`).unix(),c=moment(`${t} 14:30:00`).unix();let a=[],d;for(d=r;d<=i;d++)a.push({time:d+7*60*60});for(d=s;d<=c;d++)a.push({time:d+7*60*60});return a}function ne(t,r){return Array.from(new Map([...t,...r].sort((i,s)=>i.time-s.time).map(i=>[i.time,i])).values())}function le(){e.websocket=new WebSocket(hr),e.websocket.onopen=t=>{let r={action:"join",list:n.state.tradingOrder.config.symbol};e.websocket.send(`42${JSON.stringify(["regs",JSON.stringify(r)])}`)},e.websocket.onclose=t=>{if(e.socketStop)return!1;Z()&&(ve(!0),le(),moment().diff(e.socketRefreshTime,"seconds")>mr&&de())},e.websocket.onmessage=t=>{if(ve(!1),t.data.substr(0,1)==4&&t.data.substr(1,1)==2){const r=JSON.parse(t.data.substr(2));if(r[0]=="stockps"){const i=r[1].data;i.id==3220&&(e.data.original.length>0&&He({time:moment(`${y} ${i.time}`).unix()+7*60*60,price:i.lastPrice,volume:i.lastVol}),kt(),Ot())}}}}function ze(){const t=moment().unix();Z(t)&&(b.value.position&&t>m.ATC-5*60&&(Ye(),t>m.ATC-15&&e.order.tp.hasOwnProperty("line")&&n.dispatch("tradingOrder/executeOrder",{action:"cancel",tpData:{cmd:"cancel"},slData:{cmd:"delete"}}).then(r=>{r.isOk?(P("entry"),P("tp"),P("sl"),A(!1),o.clear("order"),k.success(p("trading.orderChart.autoCancelTpSlSuccess")),ee()):S(r.message)})),t==m.START&&le()),u.clock=moment().format("HH:mm:ss")}function Ue(){if(n.state.tradingOrder.config.openingMarket){const t=moment().unix();if(Z(t)&&(e.order.tp.hasOwnProperty("line")||b.value.position&&t>m.ATO&&t<m.ATC&&(e.order.entry.price=e.data.price.slice(-1)[0].value,e.order.side=b.value.position,U.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-61?-61:1))+"px",U.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-51?-51:1))+"px",U.value.style.display="block"),!e.order.entry.hasOwnProperty("line"))){let r=null,i=0;b.value.position?(t<m.ATO?r="ATO":t>m.ATC&&(r="ATC"),r&&(e.order.entry.price=r,i=-b.value.position)):t>m.ATO&&t<m.ATC&&(r=$(e.crosshair.y),i=r>=e.data.price.slice(-1)[0].value?1:-1,e.order.side=i,e.order.entry.price=r),i&&(D.value.style.left=+(e.crosshair.x+(e.crosshair.x>innerWidth-71?-71:1))+"px",D.value.style.top=+(e.crosshair.y+(e.crosshair.y>innerHeight-61?-61:1))+"px",D.value.style.background=i>0?"green":"red",D.value.innerText=`${i>0?"LONG":"SHORT"} ${r}`,D.value.style.display="block")}}}function ce(){D.value.style.display="none",U.value.style.display="none"}function A(t){z.value.style.display=t?"block":"none"}function Ye(){z.value.classList.contains("blink")||z.value.classList.add("blink")}function ve(t){t?H.value.classList.contains("blink")||H.value.classList.add("blink"):H.value.classList.contains("blink")&&H.value.classList.remove("blink")}function F(t){let r,i;switch(t){case"entry":r="yellow",i=e.order.side>0?"LONG":"SHORT";break;case"tp":r="lime",i=Math.abs(e.order.tp.price-e.order.entry.price).toFixed(1);break;case"sl":r="red",i=Math.abs(e.order.sl.price-e.order.entry.price).toFixed(1);break}e.order[t].hasOwnProperty("line")?e.order[t].line.applyOptions({price:e.order[t].price,title:i}):e.order[t].line=e.series.price.createPriceLine({lineType:"order",kind:t,price:e.order[t].price,color:r,lineWidth:1,lineStyle:0,title:i,draggable:!0}),o.set("order",{kind:t,price:+e.order[t].price,side:e.order.side})}function P(t){e.order[t].hasOwnProperty("line")&&(e.series.price.removePriceLine(e.order[t].line),delete e.order[t].line)}function Ke(t){u.showTradingView=!u.showTradingView,t.stopPropagation()}function Ge(t){u.showColorPicker=!u.showColorPicker,t.stopPropagation()}function Je(t){g.isSet(e.pattern1.X)&&(I(+e.pattern1.X.options().price),I(+e.pattern1.Y.options().price),I(+e.pattern1.Z.options().price),I(+e.pattern1.T.options().price)),t.preventDefault(),t.stopPropagation()}function Ze(t){u.showColorPicker=!1;const r=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),r||t.target.classList.add("selected"),t.stopPropagation()}function Qe(t){et(),t.target.classList.remove("selected"),t.preventDefault(),t.stopPropagation()}function I(t=null,r=!1,i=!1){const s="line";t||(t=Q($(e.crosshair.y)));const c=e.lines.length;if(e.lines=e.lines.filter(a=>{const d=a.options(),f=d.type=t==+d.price;return f&&(e.series.price.removePriceLine(a),o.set("line",{price:t,removed:!0})),!f}),e.lines.length==c&&!i||r){const a={lineType:s,price:t,color:u.color,lineWidth:1,lineStyle:1,draggable:!0};e.lines.push(e.series.price.createPriceLine(a)),o.set("line",a)}X.value.classList.remove("selected")}function et(){e.lines.forEach(t=>e.series.price.removePriceLine(t)),e.lines=[],o.clear("line")}function tt(t){u.showColorPicker=!1;const r=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),r||(t.target.classList.add("selected"),ye()),t.stopPropagation()}function rt(t){ye(),t.target.classList.remove("selected"),t.preventDefault(),t.stopPropagation()}function it(){const t=$(e.crosshair.y);let r={lineType:"ruler",price:t,lineWidth:1,lineStyle:1,draggable:!0};if(e.ruler.pointCount==0)r.point="l0",r.color="#F44336",r.title="0",e.ruler[r.point]=e.series.price.createPriceLine(r),e.ruler.pointCount++,o.set("ruler",r);else{const i=+e.ruler.l0.options().price,s=t-i;r.point="l1",r.color="#FF9800",r.title=s.toFixed(1),e.ruler[r.point]=e.series.price.createPriceLine(r),o.set("ruler",r);const c=-s;r.point="ln1",r.color="#FF9800",r.title=c.toFixed(1),r.price=+(i+c).toFixed(1),e.ruler[r.point]=e.series.price.createPriceLine(r),o.set("ruler",r);const a=2*s;r.point="l2",r.color="#FFEB3B",r.title=a.toFixed(1),r.price=+(i+a).toFixed(1),e.ruler[r.point]=e.series.price.createPriceLine(r),o.set("ruler",r);const d=3*s;r.point="l3",r.color="#4CAF50",r.title=d.toFixed(1),r.price=+(i+d).toFixed(1),e.ruler[r.point]=e.series.price.createPriceLine(r),o.set("ruler",r),e.ruler.pointCount++,G.value.classList.remove("selected")}}function ye(){e.ruler.pointCount>0&&(e.series.price.removePriceLine(e.ruler.l0),e.ruler.pointCount>1&&(e.series.price.removePriceLine(e.ruler.ln1),e.series.price.removePriceLine(e.ruler.l1),e.series.price.removePriceLine(e.ruler.l2),e.series.price.removePriceLine(e.ruler.l3)),e.ruler={l0:{},ln1:{},l1:{},l2:{},l3:{},pointCount:0},o.clear("ruler"))}function ot(t){u.showColorPicker=!1;const r=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),r||(t.target.classList.add("selected"),Ce()),t.stopPropagation()}function st(t){Ce(),t.target.classList.remove("selected"),t.preventDefault(),t.stopPropagation()}function at(){let r={lineType:"target",price:$(e.crosshair.y,"cash"),lineWidth:1,lineStyle:0,draggable:!1,axisLabelVisible:!1};if(g.isSet(e.target.A)?g.isSet(e.target.B)?(r.point="C",r.title="C",r.color="#9C27B0"):(r.point="B",r.title="B",r.color="#009688"):(r.point="A",r.title="A",r.color="#009688"),e.target[r.point]=e.series.cash.createPriceLine(r),o.set("target",r),r.point=="C"){const i=+e.target.A.options().price,s=+e.target.B.options().price,c=+e.target.C.options().price;r.point="D",r.price=+(c+s-i).toFixed(1),r.title="D",r.color="#9C27B0",e.target[r.point]=e.series.cash.createPriceLine(r),o.set("target",r),oe.value.classList.remove("selected")}}function Ce(){g.isSet(e.target.A)&&(e.series.cash.removePriceLine(e.target.A),g.isSet(e.target.B)&&(e.series.cash.removePriceLine(e.target.B),g.isSet(e.target.C)&&(e.series.cash.removePriceLine(e.target.C),e.series.cash.removePriceLine(e.target.D))),e.target={A:{},B:{},C:{},D:{}},o.clear("target"))}function nt(t){u.showColorPicker=!1;const r=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),r||(t.target.classList.add("selected"),Oe()),t.stopPropagation()}function lt(t){Oe(),t.target.classList.remove("selected"),t.preventDefault(),t.stopPropagation()}function ct(){const t=$(e.crosshair.y);let r={lineType:"pattern1",price:t,lineWidth:1,lineStyle:1,draggable:!0};if(g.isSet(e.pattern1.A))if(g.isSet(e.pattern1.B))g.isSet(e.pattern1.C)||(r.point="C",r.title="C",r.color="#E91E63");else{const i=+e.pattern1.A.options().price;r.point="B",r.title=(t-i).toFixed(1),r.color="#009688"}else r.point="A",r.title="A",r.color="#009688";if(e.pattern1[r.point]=e.series.price.createPriceLine(r),o.set("pattern1",r),r.point=="C"){const i=+e.pattern1.A.options().price,s=+e.pattern1.B.options().price,c=+e.pattern1.C.options().price,a=s-i;r.point="X",r.price=+(c+1.5*a).toFixed(1),r.title=(1.5*a).toFixed(1),r.color="#673AB7",e.pattern1[r.point]=e.series.price.createPriceLine(r),o.set("pattern1",r),se.value.classList.remove("selected")}}function Oe(){g.isSet(e.pattern1.A)&&(e.series.price.removePriceLine(e.pattern1.A),g.isSet(e.pattern1.B)&&(e.series.price.removePriceLine(e.pattern1.B),g.isSet(e.pattern1.C)&&(e.series.price.removePriceLine(e.pattern1.C),e.series.price.removePriceLine(e.pattern1.X))),e.pattern1={A:{},B:{},C:{},X:{}},o.clear("pattern1"))}function dt(t){u.showColorPicker=!1;const r=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),r||(t.target.classList.add("selected"),ke(!0)),t.stopPropagation()}function pt(t){xe(),t.target.classList.remove("selected"),t.preventDefault(),t.stopPropagation()}function ke(t=!1){let r={};if(g.isSet(e.pattern2.O)){const f=e.pattern2.O.options();r={time:f.time0,value:f.price0},xe()}else{if(t)return!1;r={time:e.crosshair.time,value:$(e.crosshair.y)}}const{price2:i,price3:s,price4:c,isAcc:a}=ut(r);console.log("price2",i),console.log("price3",s),console.log("price4",c);let d={lineType:"pattern2",lineWidth:1,lineStyle:1};console.log("isAcc",a),I(r.value,!a,a),d.time0=r.time,d.price0=r.value,d.point="O",d.price=c,d.title="O",d.color="#2196F3",d.draggable=!1,e.pattern2[d.point]=e.series.price.createPriceLine(d),o.set("pattern2",d),ae.value.classList.remove("selected")}function ut(t){let r=t.value,i=t.value,s=t.value,c=!1;for(let a of e.data.price)if(a.time>=t.time){a.value<t.value?(r<=t.value&&a.value<r&&(r=a.value),i<=t.value&&r>t.value&&a.value<i&&(i=a.value)):a.value>t.value&&(r>=t.value&&a.value>r&&(r=a.value),i>=t.value&&r<t.value&&a.value>i&&(i=a.value));const d=a.value-i,f=t.value-i,l=r-i,O=Math.abs(f*2)>Math.abs(l/2)?f*2:l/2;if(s=+(i+O).toFixed(1),r!=t.value&&i!=t.value){if(Math.abs(d)>Math.abs(O)){c=!0;break}if(Math.abs(d)>Math.abs(f)*3)break}}return{price2:r,price3:i,price4:s,isAcc:c}}function xe(){g.isSet(e.pattern2.O)&&(e.series.price.removePriceLine(e.pattern2.O),e.pattern2={O:{}},o.clear("pattern2"))}function ft(t){u.showColorPicker=!1;const r=t.target.classList.contains("selected");document.querySelectorAll(".tool-area > .command").forEach(i=>i.classList.remove("selected")),r||t.target.classList.add("selected"),t.stopPropagation()}function ht(t){gt(),t.target.classList.remove("selected"),t.preventDefault(),t.stopPropagation()}function mt(){const t="alert",r=Q($(e.crosshair.y)),i=e.alerts.length;if(e.alerts=e.alerts.filter(s=>{const c=s.options(),a=c.type=r==+c.price;return a&&(e.series.price.removePriceLine(s),o.set("alert",{price:r,removed:!0})),!a}),e.alerts.length==i){const s={lineType:t,price:r,title:r>=e.data.price.slice(-1)[0].value?">":"<",color:"red",lineWidth:1,lineStyle:1,draggable:!0};e.alerts.push(e.series.price.createPriceLine(s)),o.set("alert",s)}J.value.classList.remove("selected")}function gt(){e.alerts.forEach(t=>e.series.price.removePriceLine(t)),e.alerts=[],o.clear("alert")}async function vt(){e.order.entry.hasOwnProperty("line")&&(e.order.tp.hasOwnProperty("line")?n.dispatch("tradingOrder/executeOrder",{action:"exit",tpData:{cmd:"cancel"},slData:{cmd:"delete"},exitData:{cmd:"new",price:"MTL"}}).then(t=>{t.isOk?(P("entry"),P("tp"),P("sl"),A(!1),o.clear("order"),k.success(p("trading.orderChart.exitSuccess"))):(A(!0),S(t.message))}):n.dispatch("tradingOrder/executeOrder",{action:"entry",data:{cmd:"delete"}}).then(t=>{t.isOk?(P("entry"),A(!1),o.clear("order"),k.success(p("trading.orderChart.deleteEntrySuccess"))):(A(!0),S(t.message))}))}function yt(){const t=moment().unix();Z(t)&&(t<m.ATO?we(p("trading.orderChart.atoOrder"),p("titles.confirm")).then(i=>{i&&n.dispatch("tradingOrder/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATO"}}).then(s=>{s.isOk?k.success(p("trading.orderChart.atoOrderSuccess")):S(s.message)})}):t<m.ATC?n.dispatch("tradingOrder/executeOrder",{action:"entry",data:{cmd:"new",side:e.order.side,price:e.order.entry.price}}).then(r=>{r.isOk?(F("entry"),A(!0),k.success(p("trading.orderChart.newEntrySuccess"))):S(r.message)}):we(p("trading.orderChart.atcOrder"),p("titles.confirm")).then(i=>{i&&n.dispatch("tradingOrder/executeOrder",{action:"exit",exitData:{cmd:"new",price:"ATC"}}).then(s=>{s.isOk?k.success(p("trading.orderChart.atcOrderSuccess")):S(s.message)})}))}function Ct(){e.order.tp.price=e.order.entry.price+e.order.side*Le,e.order.sl.price=e.order.entry.price-e.order.side*Fe,n.dispatch("tradingOrder/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.order.tp.price},slData:{cmd:"new",price:e.order.sl.price}}).then(t=>{t.isOk?(F("entry"),F("tp"),F("sl"),e.order.entry.line.applyOptions({draggable:!1}),k.success(p("trading.orderChart.newTpSlSuccess"))):S(t.message)})}function Ot(){if(e.order.entry.hasOwnProperty("line")){const t=e.data.price.slice(-1)[0].value;e.order.tp.hasOwnProperty("line")?((e.order.side>0&&t>=e.order.tp.price||e.order.side<0&&t<=e.order.tp.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,n.dispatch("tradingOrder/executeOrder",{action:"sl",data:{cmd:"delete"}}).then(r=>{r.isOk?(P("entry"),P("tp"),P("sl"),A(!1),o.clear("order"),k.success(p("trading.orderChart.deleteTpSuccess")),ce(),ee()):S(r.message),e.isAutoOrdering=!1}))),(e.order.side>0&&t<=e.order.sl.price||e.order.side<0&&t>=e.order.sl.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,n.dispatch("tradingOrder/executeOrder",{action:"tp",data:{cmd:"cancel"}}).then(r=>{r.isOk?(P("entry"),P("tp"),P("sl"),A(!1),o.clear("order"),k.success(p("trading.orderChart.deleteSlSuccess")),ce(),ee()):S(r.message),e.isAutoOrdering=!1})))):(e.order.side>0&&t>=e.order.entry.price||e.order.side<0&&t<=e.order.entry.price)&&(e.isAutoOrdering||(e.isAutoOrdering=!0,setTimeout(()=>{e.order.tp.price=e.order.entry.price+e.order.side*Le,e.order.sl.price=e.order.entry.price-e.order.side*Fe,n.dispatch("tradingOrder/executeOrder",{action:"tpsl",tpData:{cmd:"new",price:e.order.tp.price},slData:{cmd:"new",price:e.order.sl.price}}).then(r=>{r.isOk?(F("tp"),F("sl"),e.order.entry.line.applyOptions({draggable:!1}),k.success(p("trading.orderChart.autoNewTpSlSuccess")),ee()):S(r.message),e.isAutoOrdering=!1})},1e3)))}}function kt(){if(b.value.position&&g.isSet(e.target.X)){const t=e.data.cash.slice(-1)[0].value,r=+e.target.B.options().price,i=+e.target.X.options().price,s=i-r;(s>0&&t>=i||s<0&&t<=i)&&z.value.click()}}function xt(){e.chart.timeScale().scrollToRealTime()}function Z(t=null){return t||(t=moment().unix()),t>=m.START&&t<=m.END}function $(t,r="price"){return Q(e.series[r].coordinateToPrice(t))}function Q(t){return t?+ +t.toFixed(1):0}function S(t){t||(t="unknown"),k.error(p(`trading.orderChart.${t}`))}function bt(){e.loadWhitespace=!0,n.dispatch("tradingOrder/getChartData",u.chartDate)}function de(){e.socketRefreshTime=moment(),e.loadWhitespace=!0,n.dispatch("tradingOrder/getChartData",u.chartDate)}function Pt(){e.data.original=[],e.data.price=[],e.data.cash=[],e.data.whitespace=[],de()}function ee(){let t=new Audio(Yt);t.crossOrigin="anonymous",t.addEventListener("canplaythrough",function(){t.play()})}function St(){n.dispatch("tradingOrder/getAccountInfo").then(t=>{let r="";r+='<div style="width: 200px;">',r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${p("trading.orderChart.nav")}</div><div>: ${L.currency(t.nav)}</div></div>`,r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${p("trading.orderChart.maxVol")}</div><div>: ${L.numberVnFormat(t.maxVol)}</div></div>`,r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${p("trading.orderChart.vm")}</div><div>: ${L.currency(t.vm)}</div></div>`,r+=`<div style="display: flex;"><div style="flex: 0 0 75px;">${p("trading.orderChart.fee")}</div><div>: ${L.currency(t.fee)}</div></div>`,r+="</div>",Vt(r,p("trading.orderChart.accountInfo"))})}function Tt(){K.emit("checkPin",()=>n.dispatch("tradingOrder/report"))}function wt(){K.emit("checkPin",()=>n.dispatch("tradingOrder/export"))}return(t,r)=>{const i=$t("DxToolbar");return It(),Bt(Nt,null,[h("div",Kt,[ie(i,{items:[{location:"before",widget:"dxButton",options:{icon:"far fa-flag-checkered small",hint:t.$t("trading.orderChart.buttons.report"),onClick:Tt}},{location:"before",widget:"dxButton",options:{icon:"far fa-file-export small",hint:t.$t("trading.orderChart.buttons.export"),onClick:wt}},{location:"before",widget:"dxButton",options:{icon:"far fa-chart-line small",hint:t.$t("trading.orderChart.buttons.cashflow"),onClick:()=>t.$refs.dailyCashFlowPopupRef.show()}}]},null,8,["items"]),h("div",{class:"order-chart-container",ref_key:"chartContainerRef",ref:w},[h("div",{class:"chart-wrapper",ref_key:"orderChartRef",ref:ue},[h("div",Gt,[h("div",{ref_key:"connectionRef",ref:H,class:pe(`command far fa-${b.value.connection?"link":"unlink"}`),title:t.$t("trading.orderChart.connection"),onClick:r[0]||(r[0]=()=>t.$store.dispatch("tradingOrder/getStatus"))},null,10,Jt),h("div",{class:pe(["command status",{green:b.value.position>0,red:b.value.position<0,pending:b.value.pending}]),title:t.$t("trading.orderChart.position"),onClick:St},Te(b.value.position),11,Zt),h("div",{class:"command clock",onClick:de},Te(u.clock),1),W(h("input",{type:"date",class:"chart-date command",title:t.$t("trading.orderChart.date"),"onUpdate:modelValue":r[1]||(r[1]=s=>u.chartDate=s),onChange:bt},null,40,Qt),[[Mt,u.chartDate]]),h("img",{ref_key:"spinnerRef",ref:fe,class:"command spinner",src:zt},null,512)]),h("div",er,[h("div",{ref_key:"fullscreenToolRef",ref:he,class:pe(`command far fa-${u.isFullscreen?"compress":"expand"}`),title:t.$t("trading.orderChart.fullscreen"),onClick:Ie},null,10,tr),h("div",{ref_key:"reloadToolRef",ref:me,class:"command far fa-sync-alt",title:t.$t("trading.orderChart.reload"),onClick:Pt},null,8,rr),h("div",{ref_key:"tradingviewRef",ref:ge,class:"command far fa-chart-bar",title:t.$t("trading.orderChart.tradingview"),onClick:Ke},null,8,ir),h("div",{ref_key:"colorToolRef",ref:_e,class:"color command far fa-palette",style:qt({color:u.color}),title:t.$t("trading.orderChart.colorTool"),onClick:Ge,onContextmenu:Je},[W(ie(Xt,{class:"color-picker",modelValue:u.color,"onUpdate:modelValue":r[2]||(r[2]=s=>u.color=s)},null,8,["modelValue"]),[[Y,u.showColorPicker]])],44,or),h("div",{ref_key:"lineToolRef",ref:X,class:"command far fa-horizontal-rule",title:t.$t("trading.orderChart.lineTool"),onClick:Ze,onContextmenu:Qe},null,40,sr),h("div",{ref_key:"pattern1ToolRef",ref:se,class:"command far fa-star",title:t.$t("trading.orderChart.pattern1Tool"),onClick:nt,onContextmenu:lt},null,40,ar),W(h("div",{ref_key:"pattern2ToolRef",ref:ae,class:"command far fa-heart",title:t.$t("trading.orderChart.pattern2Tool"),onClick:dt,onContextmenu:pt},null,40,nr),[[Y,!1]]),h("div",{ref_key:"rulerToolRef",ref:G,class:"command far fa-line-height",title:t.$t("trading.orderChart.rulerTool"),onClick:tt,onContextmenu:rt},null,40,lr),h("div",{ref_key:"targetToolRef",ref:oe,class:"command far fa-dot-circle",title:t.$t("trading.orderChart.targetTool"),onClick:ot,onContextmenu:st},null,40,cr),W(h("div",{ref_key:"alertToolRef",ref:J,class:"command far fa-alarm-exclamation",title:t.$t("trading.orderChart.alertTool"),onClick:ft,onContextmenu:ht},null,40,dr),[[Y,!1]]),W(h("div",{class:"command far fa-info-circle",title:t.$t("trading.orderChart.copyistStatusPopup.title"),onClick:r[3]||(r[3]=()=>t.$refs.copyistStatusPopupRef.show())},null,8,pr),[[Y,!1]]),h("div",{ref_key:"cancelOrderRef",ref:z,class:"cancel-order command far fa-trash-alt",title:t.$t("trading.orderChart.cancelTool"),onClick:vt},null,8,ur)]),h("div",null,[h("div",{ref_key:"entryOrderRef",ref:D,class:"order-button entry",onClick:yt}," Entry ",512),h("div",{ref_key:"tpslOrderRef",ref:U,class:"order-button tpsl",onClick:Ct}," TP/SL ",512),h("div",{class:"chart-top command far fa-angle-double-right",onClick:xt})]),W(h("iframe",{ref_key:"tradingviewChartRef",ref:Re,class:"tradingview-chart",src:Ee.value},null,8,fr),[[Y,u.showTradingView]])],512)],512)]),ie(jt,{ref:"copyistStatusPopupRef"},null,512),ie(Ht,{ref:"dailyCashFlowPopupRef"},null,512)],64)}}},kr=Lt(gr,[["__scopeId","data-v-36b472cd"]]);export{kr as default};
